# Codex AI â€” finanzas-app Quick Reference

> **Optimized for GitHub Codex / OpenAI GPT-4 models**
> This document provides immediate context for code generation, debugging, and refactoring tasks.

## ğŸ¯ TL;DR

```bash
Stack:       React + Vite + TypeScript (frontend) | Node + Express + Prisma + PostgreSQL (backend)
Development: npm run dev:full (frontend + backend simultÃ¡neo)
Build:       npm run build && npm run build:server
Verify:      npm run type-check && npm run lint
Deploy:      git push (Railway auto-deploy)
```

**3 Critical Rules:**

1. **NEVER use `bg-white`** â†’ usar `bg-base-100` (DaisyUI)
2. **NEVER create mock data** â†’ usar APIs reales existentes
3. **ALWAYS verify** con `npm run type-check` antes de commit

---

## ğŸ“Š Tech Stack

| Layer    | Technology                                | Notes                            |
| -------- | ----------------------------------------- | -------------------------------- |
| Frontend | React 18 + TypeScript + Vite              | Entry: `src/main.tsx`            |
| Styling  | Tailwind CSS + DaisyUI                    | Themes en `tailwind.config.cjs`  |
| State    | TanStack Query + Zustand                  | Hooks en `src/features/*/hooks/` |
| Backend  | Node + Express + TypeScript               | Entry: `server/index.ts`         |
| Database | **PostgreSQL** (via Prisma)               | Schema: `prisma/schema.prisma`   |
| Auth     | Passkey (WebAuthn) + email/password + MFA | Session: 24h                     |
| Deploy   | Railway (auto-deploy on push)             | Dockerfile con node:current-slim |

âš ï¸ **CRITICAL**: Database es **PostgreSQL**, NO MySQL. Usar sintaxis PostgreSQL en raw queries (`TO_CHAR`, `EXTRACT`, no `DATE_FORMAT`).

---

## ğŸš€ Essential Commands

```bash
# Development
npm run dev          # Frontend solo (Vite)
npm run server       # Backend solo
npm run dev:full     # Frontend + Backend simultÃ¡neo â­

# Build & Verification
npm run build        # Build frontend (producciÃ³n)
npm run build:server # Build backend
npm run type-check   # TypeScript check (OBLIGATORIO antes de commit)
npm run lint         # ESLint

# Testing
npm run test:withdrawals  # Test integraciÃ³n (requiere RUN_WITHDRAWALS_IT=1)

# Database
npx prisma generate       # Regenerar cliente despuÃ©s de cambios en schema
npx prisma migrate dev    # Crear nueva migraciÃ³n
npx prisma migrate status # Verificar estado de migraciones
```

---

## ğŸ“ Project Structure

```
finanzas-app/
â”œâ”€â”€ src/                    # Frontend React
â”‚   â”œâ”€â”€ main.tsx           # Entry point + rutas
â”‚   â”œâ”€â”€ features/          # MÃ³dulos por dominio (calendar, auth, finance...)
â”‚   â”‚   â””â”€â”€ */api.ts       # API calls centralizados
â”‚   â”‚   â””â”€â”€ */hooks/       # Custom hooks
â”‚   â”‚   â””â”€â”€ */types.ts     # TypeScript types
â”‚   â”œâ”€â”€ components/        # Componentes compartidos
â”‚   â”‚   â””â”€â”€ ui/            # Primitivos (Button, Input, etc.)
â”‚   â””â”€â”€ pages/             # PÃ¡ginas de rutas
â”œâ”€â”€ server/                 # Backend Express
â”‚   â”œâ”€â”€ index.ts           # Entry point
â”‚   â”œâ”€â”€ routes/            # Endpoints API
â”‚   â”œâ”€â”€ services/          # LÃ³gica de negocio
â”‚   â”œâ”€â”€ lib/               # Utilidades
â”‚   â””â”€â”€ config.ts          # ConfiguraciÃ³n (sesiones, JWT, calendar)
â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ schema.prisma      # Schema de BD (PostgreSQL)
â””â”€â”€ generated/             # Cliente Prisma (NO EDITAR)
```

---

## ğŸ”´ Recent Critical Changes (December 2024)

### PostgreSQL (NOT MySQL)

- **ALL** raw queries use PostgreSQL syntax
- `TO_CHAR()` instead of `DATE_FORMAT()`
- `EXTRACT()` for date parts
- Tables use `@@map` names: `events` (not `google_calendar_events`), `people` (not `person`)
- **NEW**: `amountExpected` field limited to Int32 max (2,147,483,647) with 100M CLP reasonable max

### Sync Timeout = 15 Minutes

- `server/services/calendar.ts` uses 15min timeout for marking syncs as "stale"
- Changed from 5min (large syncs were marked as error prematurely)

### Calendar Exclusion Patterns

- Defined in `server/config.ts` â†’ `parseExcludePatterns()`
- Auto-excludes: "cumpleaÃ±os", empty events, date-only events
- Add more via `GOOGLE_CALENDAR_EXCLUDE_SUMMARIES` env var

### Navbar Tabs

- ALL tabs in layouts must have `end: true` for correct active route highlighting
- Files: `CalendarLayout.tsx`, `HRLayout.tsx`, `ServicesLayout.tsx`, `OperationsLayout.tsx`

### Auth: passwordHash Nullable

- `prisma/schema.prisma`: `passwordHash String?` (nullable)
- Passkey-only users have `passwordHash = null`
- `server/routes/auth.ts` handles null safely

---

## ğŸ’¡ Coding Conventions

### Frontend

```tsx
// âœ… CORRECT - use DaisyUI tokens
<div className="bg-base-100 text-base-content card shadow">

// âŒ INCORRECT - hardcoded colors
<div className="bg-white text-gray-900">

// âœ… CORRECT - use Button component
import Button from "@/components/ui/Button";
<Button variant="primary" size="md">Guardar</Button>

// âŒ INCORRECT - ad-hoc classes
<button className="btn btn-primary">Guardar</button>
```

### Backend

```typescript
// âœ… CORRECT - PostgreSQL syntax in raw queries
await prisma.$queryRaw`
  SELECT TO_CHAR(created_at, 'YYYY-MM-DD') as date
  FROM events
  WHERE EXTRACT(YEAR FROM created_at) = 2025
`;

// âŒ INCORRECT - MySQL syntax
await prisma.$queryRaw`
  SELECT DATE_FORMAT(created_at, '%Y-%m-%d') as date
  FROM google_calendar_events  -- wrong table name
`;

// âœ… CORRECT - table names per @@map
// prisma/schema.prisma: model CalendarEvent { @@map("events") }
// In SQL: events (not calendar_events or google_calendar_events)
```

### Error Handling

```typescript
// âœ… CORRECT - try-catch with detailed logging
try {
  await externalApi.call(data);
} catch (error) {
  console.error("[service:method] Error:", { input: data, error });
  throw error;
}
```

### Amount Validation (NEW)

```typescript
// âœ… CORRECT - validate amounts before DB insert
const MAX_INT32 = 2147483647;
const MAX_REASONABLE_AMOUNT = 100_000_000; // 100M CLP

if (amount > MAX_INT32 || amount > MAX_REASONABLE_AMOUNT) {
  console.warn(`Amount ${amount} exceeds limits, skipping`);
  return null;
}
```

---

## âŒ Common Errors & Solutions

| Error                                     | Solution                                        |
| ----------------------------------------- | ----------------------------------------------- |
| `DATE_FORMAT is not a function`           | Use `TO_CHAR()` (PostgreSQL, not MySQL)         |
| Tab not marked as active                  | Add `end: true` to TabItem                      |
| Sync marked as error too fast             | Timeout is 15min, not 5min                      |
| `bg-white` not working in dark mode       | Use `bg-base-100` (DaisyUI)                     |
| Commit fails due to lint                  | Run `npm run lint --fix` first                  |
| `Cannot find module` in server            | Run `npm run build:server`                      |
| Table not found in raw query              | Check `@@map` in schema.prisma                  |
| **Value out of range for amountExpected** | **Validate amounts: max 2,147,483,647 (Int32)** |

---

## ğŸ“š Key Files by Feature

### Calendar

- `src/features/calendar/api.ts` â€” Centralized API calls
- `src/features/calendar/hooks/useCalendarEvents.ts` â€” State + sync management
- `server/routes/calendar-events.ts` â€” Backend endpoints
- `server/lib/google-calendar-queries.ts` â€” Raw SQL (PostgreSQL)
- `server/services/calendar.ts` â€” Sync lock (15min timeout)
- `server/config.ts` â€” Exclusion patterns
- `server/modules/calendar/parsers.ts` â€” **NEW**: Amount validation (Int32 + 100M CLP max)

### Auth

- `server/routes/auth.ts` â€” Login, passkey, MFA
- `server/routes/user-management.ts` â€” CRUD usuarios
- `src/features/auth/pages/LoginPage.tsx` â€” Login UI

### Finance

- `server/routes/transactions.ts` â€” Preview/import
- `server/db.ts` â€” upsertWithdrawals
- `src/features/transactions/` â€” UI

### Config

- `server/config.ts` â€” Session (24h), JWT, calendar config
- `tailwind.config.cjs` â€” DaisyUI themes
- `vite.config.ts` â€” PWA, build config

---

## ğŸ›¡ï¸ Safety Rules (DO NOT BREAK)

1. **NO eliminar** `/api/transactions/withdrawals/upload` sin verificar callers externos
2. **NO cambiar** session duration (24h) sin aprobaciÃ³n
3. **NO crear** `public/manifest.json` manual (VitePWA lo genera)
4. **NO modificar** migraciones ya deployadas
5. **NO usar** `--no-verify` en commits de producciÃ³n
6. **PRESERVAR** respuesta de upserts: `{ inserted, updated, skipped, total }`
7. **VALIDAR** amounts antes de DB insert: max Int32 (2,147,483,647)

---

## ğŸ”§ MCP Tools Available

### Sequential Thinking

Para problemas complejos que requieren razonamiento paso a paso:

```
Use cuando: Debugging complejo, diseÃ±o de arquitectura, anÃ¡lisis multi-paso
```

### Context7 (Updated Library Docs)

Para obtener documentaciÃ³n actualizada de librerÃ­as:

```
LibrerÃ­as frecuentes:
- Prisma: /prisma/prisma
- React Query: /tanstack/query
- DaisyUI: /saadeghi/daisyui
- Vite: /vitejs/vite
- Express: /expressjs/express
```

### GitHub MCP

Para operaciones con GitHub (PRs, issues, branches)

---

## âœ… Pre-Commit Checklist

```bash
npm run type-check  # âœ“ Sin errores de tipos
npm run lint        # âœ“ Sin errores de lint
npm run build       # âœ“ Build exitoso
# Solo entonces:
git add -A && git commit -m "feat: descripciÃ³n clara"
```

---

## ğŸ“– Additional Documentation

- `AGENTS.md` â€” Universal AI agent instructions
- `.github/copilot-instructions.md` â€” GitHub Copilot specific
- `CLAUDE.md` â€” Claude AI specific
- `.cursorrules` â€” Cursor AI specific

---

_This document is optimized for GitHub Codex. For other AI assistants, see respective instruction files._
