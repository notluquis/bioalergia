[{"filePath":"/Users/notluquis/finanzas-app/apps/web/.eslintrc.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/shared/cashback.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/shared/csv.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/shared/currency.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/shared/format.ts","messages":[],"suppressedMessages":[{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":22,"column":54,"nodeType":"MemberExpression","endLine":22,"endColumn":70,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/shared/mercadopago.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/shared/retention.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/shared/time.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/App.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/backup/GoogleDriveConnect.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":68,"column":11,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":68,"endColumn":33,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":68,"column":11,"nodeType":"MemberExpression","endLine":68,"endColumn":32,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/data-table/DataTable.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/data-table/DataTableFacetedFilter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/data-table/DataTablePagination.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/data-table/DataTableToolbar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/data-table/DataTableViewOptions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/features/Clock.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/features/PerformanceIndicator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/features/SettingsForm.tsx","messages":[],"suppressedMessages":[{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":211,"column":24,"nodeType":"MemberExpression","endLine":211,"endColumn":33,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":245,"column":30,"nodeType":"MemberExpression","endLine":245,"endColumn":39,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/features/UpdateNotification.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/layouts/CalendarLayout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/layouts/CollapsibleNavSection.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/layouts/Header.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/layouts/MobileNav.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/layouts/SettingsLayout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/layouts/Sidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/mercadopago/GenerateReportModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/ui/Alert.tsx","messages":[],"suppressedMessages":[{"ruleId":"security/detect-object-injection","severity":1,"message":"Function Call Object Injection Sink","line":29,"column":55,"nodeType":"MemberExpression","endLine":29,"endColumn":74,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/ui/Backdrop.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/ui/Badge.tsx","messages":[],"suppressedMessages":[{"ruleId":"security/detect-object-injection","severity":1,"message":"Variable Assigned to Object Injection Sink","line":39,"column":21,"nodeType":"MemberExpression","endLine":39,"endColumn":40,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Variable Assigned to Object Injection Sink","line":41,"column":20,"nodeType":"MemberExpression","endLine":41,"endColumn":33,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":54,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":54,"endColumn":30,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/ui/Button.tsx","messages":[],"suppressedMessages":[{"ruleId":"security/detect-object-injection","severity":1,"message":"Function Call Object Injection Sink","line":68,"column":7,"nodeType":"MemberExpression","endLine":68,"endColumn":30,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Function Call Object Injection Sink","line":70,"column":7,"nodeType":"MemberExpression","endLine":70,"endColumn":24,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":81,"column":35,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":81,"endColumn":37,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2789,2791],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":83,"column":48,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":83,"endColumn":50,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2933,2935],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":99,"column":28,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":99,"endColumn":30,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[3482,3484],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/ui/Card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/ui/Checkbox.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/ui/ChunkErrorBoundary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/ui/DropdownMenu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/ui/FileInput.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/ui/GlobalError.tsx","messages":[],"suppressedMessages":[{"ruleId":"turbo/no-undeclared-env-vars","severity":2,"message":"DEV is not listed as a dependency in turbo.json","line":164,"column":11,"nodeType":"MemberExpression","endLine":164,"endColumn":30,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/ui/Input.tsx","messages":[],"suppressedMessages":[{"ruleId":"security/detect-object-injection","severity":1,"message":"Function Call Object Injection Sink","line":72,"column":5,"nodeType":"MemberExpression","endLine":72,"endColumn":23,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Function Call Object Injection Sink","line":91,"column":5,"nodeType":"MemberExpression","endLine":91,"endColumn":30,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":172,"column":16,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":172,"endColumn":18,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[5543,5545],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":176,"column":20,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":176,"endColumn":22,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[5771,5773],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/ui/Modal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/ui/MoneyInput.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/ui/PageLoader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/ui/Skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/ui/SmoothCollapse.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/ui/StatCard.tsx","messages":[],"suppressedMessages":[{"ruleId":"security/detect-object-injection","severity":1,"message":"Variable Assigned to Object Injection Sink","line":68,"column":17,"nodeType":"MemberExpression","endLine":68,"endColumn":34,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Function Call Object Injection Sink","line":82,"column":32,"nodeType":"MemberExpression","endLine":82,"endColumn":49,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/ui/Table.tsx","messages":[],"suppressedMessages":[{"ruleId":"security/detect-object-injection","severity":1,"message":"Function Call Object Injection Sink","line":63,"column":31,"nodeType":"MemberExpression","endLine":63,"endColumn":54,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/ui/ThemeToggle.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/ui/TimeInput.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/components/ui/Tooltip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/config/app.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/context/AuthContext.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Move your React context(s) to a separate file.","line":41,"column":14,"nodeType":"Identifier","messageId":"reactContext","endLine":41,"endColumn":25,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":247,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":247,"endColumn":24,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/context/SettingsContext.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":34,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":34,"endColumn":30,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":43,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":43,"endColumn":43,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Move your React context(s) to a separate file.","line":58,"column":14,"nodeType":"Identifier","messageId":"reactContext","endLine":58,"endColumn":29,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":159,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":159,"endColumn":28,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/context/ToastContext.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":69,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":69,"endColumn":25,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/auth/api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/auth/pages/LoginPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/backup/api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/backup/queries.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/backup/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/calendar/api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/calendar/components/CalendarFilterPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/calendar/components/CalendarSkeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/calendar/components/ClassificationRow.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":9,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":12,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[664,667],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[664,667],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":2,"message":"Unsafe argument of type `any` assigned to a parameter of type `Store<unknown, any>`.","line":42,"column":5,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":42,"endColumn":15,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .store on an `any` value.","line":42,"column":10,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":42,"endColumn":15,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":43,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1404,1407],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1404,1407],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":43,"column":21,"nodeType":"MemberExpression","endLine":43,"endColumn":76,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/calendar/components/ClassificationTotals.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":9,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":12,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[460,463],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[460,463],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":2,"message":"Unsafe argument of type `any` assigned to a parameter of type `Store<unknown, any>`.","line":20,"column":35,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":20,"endColumn":45,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .store on an `any` value.","line":20,"column":40,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":20,"endColumn":45,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":20,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[827,830],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[827,830],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Variable Assigned to Object Injection Sink","line":29,"column":23,"nodeType":"MemberExpression","endLine":29,"endColumn":36,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/calendar/components/DailyEventCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/calendar/components/DailyStatsCards.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/calendar/components/DayNavigation.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/calendar/components/FormattedEventDescription.tsx","messages":[],"suppressedMessages":[{"ruleId":"security/detect-non-literal-regexp","severity":1,"message":"Found non-literal argument to RegExp Constructor","line":27,"column":21,"nodeType":"NewExpression","endLine":27,"endColumn":67,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/calendar/components/HeatmapMonth.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/calendar/components/MultiSelectFilter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/calendar/components/ScheduleCalendar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/calendar/components/SyncDetailModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/calendar/components/SyncProgressPanel.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":88,"column":50,"nodeType":"Identifier","messageId":"neverNullish","endLine":88,"endColumn":57,"suppressions":[{"kind":"directive","justification":"details can be null/undefined"}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":90,"column":21,"nodeType":"MemberExpression","endLine":90,"endColumn":38,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/calendar/components/WeekGrid.tsx","messages":[],"suppressedMessages":[{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":76,"column":5,"nodeType":"MemberExpression","endLine":76,"endColumn":15,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":83,"column":22,"nodeType":"MemberExpression","endLine":83,"endColumn":37,"suppressions":[{"kind":"directive","justification":"eventDate is YYYY-MM-DD format, safe access"}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":84,"column":7,"nodeType":"MemberExpression","endLine":84,"endColumn":22,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"sonarjs/cognitive-complexity","severity":2,"message":"Refactor this function to reduce its Cognitive Complexity from 24 to the 15 allowed.","line":110,"column":38,"nodeType":null,"messageId":"refactorFunction","endLine":110,"endColumn":40,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"sonarjs/cognitive-complexity","severity":2,"message":"Refactor this function to reduce its Cognitive Complexity from 18 to the 15 allowed.","line":345,"column":10,"nodeType":null,"messageId":"refactorFunction","endLine":345,"endColumn":30,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":426,"column":9,"nodeType":"MemberExpression","endLine":426,"endColumn":29,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/calendar/constants.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/calendar/hooks/use-calendar-events.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/calendar/queries.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/calendar/schemas.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/calendar/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/calendar/utils/classification.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/calendar/utils/filters.ts","messages":[],"suppressedMessages":[{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":10,"column":21,"nodeType":"MemberExpression","endLine":10,"endColumn":25,"suppressions":[{"kind":"directive","justification":"safe array iteration"}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/counterparts/api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/counterparts/components/AssociatedAccounts.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":2,"message":"Refactor this function to reduce its Cognitive Complexity from 16 to the 15 allowed.","line":230,"column":31,"nodeType":null,"messageId":"refactorFunction","endLine":230,"endColumn":33},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":258,"column":18,"nodeType":"MemberExpression","messageId":"neverNullish","endLine":258,"endColumn":31},{"ruleId":"no-unsafe-optional-chaining","severity":2,"message":"Unsafe usage of optional chaining. If it short-circuits with 'undefined' the evaluation will throw TypeError.","line":270,"column":23,"nodeType":"ChainExpression","messageId":"unsafeOptionalChain","endLine":270,"endColumn":41},{"ruleId":"@typescript-eslint/no-unnecessary-type-parameters","severity":2,"message":"Type parameter K is used only once in the function signature.","line":281,"column":6,"nodeType":"TSTypeParameter","messageId":"sole","endLine":281,"endColumn":33,"suggestions":[{"messageId":"replaceUsagesWithConstraint","fix":{"range":[9583,9619],"text":"(key: keyof AccountForm"},"desc":"Replace all usages of type parameter with its constraint."}]},{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":325,"column":24,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":325,"endColumn":39,"suggestions":[{"messageId":"suggestOptionalChain","fix":{"range":[10984,10985],"text":"?"},"desc":"Consider using the optional chain operator `?.` instead. This operator includes runtime checks, so it is safer than the compile-only non-null assertion operator."}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":359,"column":16,"nodeType":"Identifier","messageId":"neverNullish","endLine":359,"endColumn":29}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport dayjs from \"dayjs\";\nimport type { ChangeEvent } from \"react\";\nimport { useEffect, useState } from \"react\";\n\nimport type { Transaction } from \"@/features/finance/types\";\n\nimport { DataTable } from \"@/components/data-table/DataTable\";\nimport Alert from \"@/components/ui/Alert\";\nimport Button from \"@/components/ui/Button\";\nimport Input from \"@/components/ui/Input\";\nimport Modal from \"@/components/ui/Modal\";\nimport { useToast } from \"@/context/ToastContext\";\nimport { fetchTransactions } from \"@/features/finance/api\";\nimport { today } from \"@/lib/dates\";\nimport { fmtCLP } from \"@/lib/format\";\nimport { formatRut } from \"@/lib/rut\";\n\nimport type { Counterpart, CounterpartAccount, CounterpartAccountSuggestion, CounterpartSummary } from \"../types\";\n\nimport { addCounterpartAccount, attachCounterpartRut, fetchAccountSuggestions, updateCounterpartAccount } from \"../api\";\nimport {\n  ACCOUNT_FORM_DEFAULT,\n  accountFilterKey,\n  AccountForm,\n  AccountGroup,\n  AccountTransactionFilter,\n  buildAccountTransactionFilter,\n  DateRange,\n} from \"./associated-accounts.helpers\";\nimport { getAccountGroupColumns, getQuickViewColumns } from \"./AssociatedAccountsColumns\";\n\ninterface AssociatedAccountsProps {\n  detail: null | { accounts: CounterpartAccount[]; counterpart: Counterpart };\n  onSummaryRangeChange: (update: Partial<DateRange>) => void;\n  selectedId: null | number;\n  summary: CounterpartSummary | null;\n  summaryRange: { from: string; to: string };\n}\n\nexport default function AssociatedAccounts({\n  detail,\n  onSummaryRangeChange,\n  selectedId,\n  summary,\n  summaryRange,\n}: Readonly<AssociatedAccountsProps>) {\n  const [accountForm, setAccountForm] = useState<AccountForm>(ACCOUNT_FORM_DEFAULT);\n  const [suggestionQuery, setSuggestionQuery] = useState(\"\");\n  const [quickViewGroup, setQuickViewGroup] = useState<AccountGroup | null>(null);\n  const [isAddAccountModalOpen, setIsAddAccountModalOpen] = useState(false);\n  const [error, setError] = useState<null | string>(null);\n  const { error: toastError, success: toastSuccess } = useToast();\n  const fallbackRange: DateRange = {\n    from: dayjs().startOf(\"year\").format(\"YYYY-MM-DD\"),\n    to: today(),\n  };\n\n  // Suggestions Query\n  const [debouncedQuery, setDebouncedQuery] = useState(\"\");\n  useEffect(() => {\n    const handler = setTimeout(() => {\n      setDebouncedQuery(suggestionQuery);\n    }, 300);\n    return () => {\n      clearTimeout(handler);\n    };\n  }, [suggestionQuery]);\n\n  const { data: suggestions = [] } = useQuery({\n    enabled: !!debouncedQuery.trim(),\n    queryFn: () => fetchAccountSuggestions(debouncedQuery),\n    queryKey: [\"account-suggestions\", debouncedQuery],\n    staleTime: 1000 * 60,\n  });\n\n  const accountSuggestions = suggestions;\n  // Suspense handles loading, no need for manual loading state\n\n  const queryClient = useQueryClient();\n\n  const addAccountMutation = useMutation({\n    mutationFn: (payload: { data: Parameters<typeof addCounterpartAccount>[1]; id: number }) =>\n      addCounterpartAccount(payload.id, payload.data),\n    onError: (err: Error) => {\n      setError(err.message);\n      toastError(err.message);\n    },\n    onSuccess: (_data, variables) => {\n      void queryClient.invalidateQueries({\n        queryKey: [\"counterpart-detail\", variables.id],\n      });\n      void queryClient.invalidateQueries({\n        queryKey: [\"counterpart-summary\", variables.id],\n      });\n      setAccountForm(ACCOUNT_FORM_DEFAULT);\n      setSuggestionQuery(\"\");\n      setIsAddAccountModalOpen(false);\n      toastSuccess(\"Cuenta asociada agregada\");\n    },\n  });\n\n  function handleAddAccount() {\n    if (!selectedId) {\n      setError(\"Guarda la contraparte antes de agregar cuentas\");\n      toastError(\"Guarda la contraparte antes de agregar cuentas\");\n      return;\n    }\n    if (!accountForm.accountIdentifier.trim()) {\n      setError(\"Ingresa un identificador de cuenta\");\n      toastError(\"Ingresa un identificador de cuenta\");\n      return;\n    }\n    setError(null);\n\n    addAccountMutation.mutate({\n      data: {\n        accountIdentifier: accountForm.accountIdentifier.trim(),\n        accountType: accountForm.accountType.trim() || null,\n        bankName: accountForm.bankName.trim() || null,\n        concept: accountForm.concept.trim() || null,\n        holder: accountForm.holder.trim() || null,\n        metadata: {\n          bankAccountNumber: accountForm.bankAccountNumber.trim() || null,\n          withdrawId: accountForm.accountIdentifier.trim(),\n        },\n      },\n      id: selectedId,\n    });\n  }\n\n  const updateAccountMutation = useMutation({\n    mutationFn: ({ id, payload }: { id: number; payload: Parameters<typeof updateCounterpartAccount>[1] }) =>\n      updateCounterpartAccount(id, payload),\n    onError: (err: Error) => {\n      setError(err.message);\n      toastError(err.message);\n    },\n    onSuccess: () => {\n      if (selectedId) {\n        void queryClient.invalidateQueries({\n          queryKey: [\"counterpart-detail\", selectedId],\n        });\n        void queryClient.invalidateQueries({\n          queryKey: [\"counterpart-summary\", selectedId],\n        });\n      }\n      toastSuccess(\"Concepto actualizado\");\n    },\n  });\n\n  const { mutateAsync: updateAccount } = updateAccountMutation;\n\n  const handleGroupConceptChange = async (group: AccountGroup, concept: string) => {\n    const trimmed = concept.trim();\n    const nextConcept = trimmed || null;\n    setError(null);\n\n    try {\n      await Promise.all(\n        group.accounts.map((account) =>\n          updateAccount({\n            id: account.id,\n            payload: { concept: nextConcept },\n          })\n        )\n      );\n    } catch {\n      // Error handled by mutation onError\n    }\n  };\n\n  function handleSuggestionClick(suggestion: CounterpartAccountSuggestion) {\n    setAccountForm({\n      accountIdentifier: suggestion.accountIdentifier,\n      accountType: suggestion.accountType ?? \"\",\n      bankAccountNumber: suggestion.bankAccountNumber ?? \"\",\n      bankName: suggestion.bankName ?? \"\",\n      concept: suggestion.assignedCounterpartId ? \"\" : (suggestion.holder ?? \"\"),\n      holder: suggestion.holder ?? \"\",\n    });\n    setSuggestionQuery(suggestion.accountIdentifier);\n  }\n\n  function handleSuggestionCreate(suggestion: CounterpartAccountSuggestion) {\n    setAccountForm({\n      accountIdentifier: suggestion.accountIdentifier,\n      accountType: suggestion.accountType ?? \"\",\n      bankAccountNumber: suggestion.bankAccountNumber ?? \"\",\n      bankName: suggestion.bankName ?? \"\",\n      concept: \"\",\n      holder: suggestion.holder ?? \"\",\n    });\n    setSuggestionQuery(suggestion.accountIdentifier);\n  }\n\n  const attachRutMutation = useMutation({\n    mutationFn: ({ id, rut }: { id: number; rut: string }) => attachCounterpartRut(id, rut),\n    onError: (error: Error) => {\n      setError(error.message);\n      toastError(error.message);\n    },\n    onSuccess: (_, variables) => {\n      void queryClient.invalidateQueries({\n        queryKey: [\"counterpart-detail\", variables.id],\n      });\n      void queryClient.invalidateQueries({\n        queryKey: [\"counterpart-summary\", variables.id],\n      });\n      setSuggestionQuery(\"\");\n      toastSuccess(\"RUT vinculado correctamente\");\n    },\n  });\n\n  function handleAttachRut(rut: null | string | undefined) {\n    if (!selectedId) {\n      setError(\"Selecciona una contraparte para vincular\");\n      toastError(\"Selecciona una contraparte antes de vincular un RUT\");\n      return;\n    }\n    if (!rut) {\n      setError(\"La sugerencia no contiene un RUT válido\");\n      toastError(\"La sugerencia no contiene un RUT válido\");\n      return;\n    }\n    setError(null);\n    attachRutMutation.mutate({ id: selectedId, rut });\n  }\n\n  const accountGrouping = (() => {\n    const groups = new Map<string, AccountGroup>();\n    const identifierToKey = new Map<string, string>();\n\n    for (const account of detail?.accounts ?? []) {\n      const label = account.metadata?.bankAccountNumber?.trim() ?? account.account_identifier;\n      identifierToKey.set(account.account_identifier, label);\n      const existing = groups.get(label);\n      if (existing) {\n        existing.accounts.push(account);\n        if (!existing.bankName && account.bank_name) existing.bankName = account.bank_name;\n        if (!existing.holder && account.holder) existing.holder = account.holder;\n        if (!existing.concept && account.concept) existing.concept = account.concept;\n      } else {\n        groups.set(label, {\n          accounts: [account],\n          bankName: account.bank_name ?? null,\n          concept: account.concept ?? \"\",\n          holder: account.holder ?? null,\n          key: label,\n          label,\n        });\n      }\n    }\n\n    const accountGroups = [...groups.values()]\n      .map((group) => ({\n        ...group,\n        concept: group.concept ?? \"\",\n      }))\n      .toSorted((a, b) => a.label.localeCompare(b.label, \"es\", { sensitivity: \"base\" }));\n\n    return { accountGroups, identifierToKey };\n  })();\n\n  const accountGroups = accountGrouping.accountGroups;\n  const identifierToGroupKey = accountGrouping.identifierToKey;\n\n  const summaryByGroup = (() => {\n    const map = new Map<string, { count: number; total: number }>();\n    for (const row of summary?.byAccount) {\n      const key = identifierToGroupKey.get(row.account_identifier) ?? row.account_identifier;\n      const entry = map.get(key) ?? { count: 0, total: 0 };\n      entry.total += row.total;\n      entry.count += row.count;\n      map.set(key, entry);\n    }\n    return map;\n  })();\n\n  const updateAccountForm =\n    <K extends keyof AccountForm>(key: K) =>\n    (event: ChangeEvent<HTMLInputElement>) => {\n      const value = event.target.value;\n      setAccountForm((prev) => ({ ...prev, [key]: value }));\n    };\n\n  const handleAccountIdentifierChange = (event: ChangeEvent<HTMLInputElement>) => {\n    const value = event.target.value;\n    setAccountForm((prev) => ({ ...prev, accountIdentifier: value }));\n    setSuggestionQuery(value);\n  };\n\n  // --- Data Fetching with React Query ---\n\n  const fetchTransactionsForFilter = async (filter: AccountTransactionFilter, range: DateRange) => {\n    if (!filter.sourceId && !filter.bankAccountNumber) return [];\n\n    const payload = await fetchTransactions({\n      filters: {\n        bankAccountNumber: filter.bankAccountNumber ?? \"\",\n        description: \"\",\n        destination: \"\",\n        direction: \"OUT\",\n        externalReference: \"\",\n        from: range.from || \"\",\n        includeAmounts: true,\n        origin: \"\",\n        sourceId: filter.sourceId ?? \"\",\n        status: \"\",\n        to: range.to || \"\",\n        transactionType: \"\",\n      },\n      page: 1,\n      pageSize: 200,\n    });\n    return payload.data;\n  };\n\n  const activeRange = summaryRange;\n\n  const { data: quickViewRows = [] } = useQuery({\n    enabled: !!quickViewGroup,\n    queryFn: async () => {\n      // safe to assert quickViewGroup is present due to enabled\n      const accounts = quickViewGroup!.accounts;\n      const filters = accounts.map((account) => buildAccountTransactionFilter(account));\n      const normalized: Record<string, AccountTransactionFilter> = {};\n      for (const filter of filters) {\n        if (filter.sourceId || filter.bankAccountNumber) {\n          normalized[accountFilterKey(filter)] = filter;\n        }\n      }\n      const uniqueFilters = Object.values(normalized);\n\n      const results = await Promise.all(uniqueFilters.map((filter) => fetchTransactionsForFilter(filter, activeRange)));\n      const merged = results.flat();\n\n      const dedup = new Map<number, Transaction>();\n      for (const movement of merged) {\n        if (!dedup.has(movement.id)) {\n          dedup.set(movement.id, movement);\n        }\n      }\n\n      const sorted = [...dedup.values()].toSorted(\n        (a, b) => dayjs(b.transactionDate).valueOf() - dayjs(a.transactionDate).valueOf()\n      );\n\n      return sorted;\n    },\n    queryKey: [\"associated-accounts-transactions\", quickViewGroup, activeRange.from, activeRange.to],\n    staleTime: 1000 * 60 * 5, // 5 minutes\n  });\n\n  const handleQuickView = (group: AccountGroup) => {\n    setQuickViewGroup(group);\n  };\n\n  const rows = quickViewRows ?? [];\n  const quickStats = {\n    count: rows.length,\n    total: rows.reduce((sum: number, row: Transaction) => sum + (row.transactionAmount ?? 0), 0),\n  };\n\n  const accountGroupColumns = getAccountGroupColumns(summaryByGroup, handleGroupConceptChange, handleQuickView);\n\n  const quickViewColumns = getQuickViewColumns();\n\n  const renderQuickViewContent = () => {\n    return (\n      <div className=\"border-base-200 overflow-hidden rounded-lg border\">\n        <DataTable\n          columns={quickViewColumns}\n          data={rows}\n          enableToolbar={false}\n          enableVirtualization={false}\n          noDataMessage=\"Sin movimientos dentro del rango seleccionado.\"\n          pagination={{ pageIndex: 0, pageSize: 50 }}\n        />\n      </div>\n    );\n  };\n\n  const renderSuggestions = () => {\n    if (accountSuggestions.length === 0) {\n      return <span className=\"text-base-content/60 text-xs\">No hay sugerencias para este identificador.</span>;\n    }\n    return (\n      <div className=\"border-base-300 bg-base-100 max-h-48 overflow-y-auto rounded-xl border\">\n        {accountSuggestions.map((suggestion) => (\n          <div\n            className=\"border-base-300 flex flex-col gap-1 border-b px-3 py-2 text-xs last:border-b-0\"\n            key={suggestion.accountIdentifier}\n          >\n            <span className=\"text-base-content font-semibold\">{suggestion.accountIdentifier}</span>\n            <span className=\"text-base-content/90\">{suggestion.holder ?? \"(sin titular)\"}</span>\n            {suggestion.bankAccountNumber && (\n              <span className=\"text-base-content/90 text-xs\">Cuenta {suggestion.bankAccountNumber}</span>\n            )}\n            {suggestion.rut && <span className=\"text-base-content/90 text-xs\">RUT {formatRut(suggestion.rut)}</span>}\n            <span className=\"text-base-content/90 text-xs\">\n              {suggestion.movements} mov. · {fmtCLP(suggestion.totalAmount)}\n            </span>\n            <div className=\"flex flex-wrap gap-2 pt-1\">\n              <Button\n                onClick={() => {\n                  handleSuggestionClick(suggestion);\n                }}\n                size=\"xs\"\n                variant=\"primary\"\n              >\n                Autrellenar\n              </Button>\n              {selectedId && suggestion.rut && (\n                <Button\n                  disabled={attachRutMutation.isPending}\n                  onClick={() => {\n                    handleAttachRut(suggestion.rut);\n                  }}\n                  size=\"xs\"\n                  variant=\"secondary\"\n                >\n                  {attachRutMutation.isPending ? \"Vinculando...\" : \"Vincular por RUT\"}\n                </Button>\n              )}\n              {!selectedId && (\n                <Button\n                  onClick={() => {\n                    handleSuggestionCreate(suggestion);\n                  }}\n                  size=\"xs\"\n                  variant=\"secondary\"\n                >\n                  Copiar datos\n                </Button>\n              )}\n            </div>\n          </div>\n        ))}\n      </div>\n    );\n  };\n\n  return (\n    <section className=\"surface-recessed relative space-y-5 p-6\">\n      <header className=\"flex flex-wrap items-center justify-between gap-3\">\n        <div className=\"space-y-1\">\n          <h2 className=\"text-primary text-lg font-semibold drop-shadow-sm\">Cuentas asociadas</h2>\n          <p className=\"text-base-content/90 text-xs\">\n            Identificadores detectados en los movimientos y asignados a esta contraparte.\n          </p>\n        </div>\n        <Button\n          onClick={() => {\n            setIsAddAccountModalOpen(true);\n          }}\n          size=\"sm\"\n          variant=\"secondary\"\n        >\n          + Agregar cuenta\n        </Button>\n      </header>\n      {error && <Alert variant=\"error\">{error}</Alert>}\n\n      <div className=\"border-base-200 bg-base-100 overflow-hidden rounded-lg border\">\n        <DataTable\n          columns={accountGroupColumns}\n          data={accountGroups}\n          enableToolbar={false}\n          enableVirtualization={false}\n          noDataMessage=\"Sin cuentas asociadas.\"\n          pagination={{ pageIndex: 0, pageSize: 50 }}\n        />\n      </div>\n\n      <div className=\"space-y-4\">\n        {quickViewGroup ? (\n          <div className=\"space-y-4\">\n            <div className=\"flex flex-wrap items-center justify-between gap-3\">\n              <div>\n                <p className=\"text-base-content/60 text-xs tracking-[0.3em] uppercase\">Resumen mensual</p>\n                <h3 className=\"text-base-content text-lg font-semibold\">Transferencias</h3>\n                <p className=\"text-base-content/60 text-xs\">{quickViewGroup.label}</p>\n                <p className=\"text-base-content/50 text-xs\">\n                  {activeRange.from} – {activeRange.to}\n                </p>\n              </div>\n              <div className=\"flex gap-4\">\n                <div className=\"border-base-300/60 bg-base-100/60 text-base-content/70 rounded-2xl border px-4 py-2 text-xs font-semibold tracking-[0.2em] uppercase\">\n                  Movimientos {quickStats.count}\n                </div>\n                <div className=\"border-base-300/60 bg-base-100/60 text-base-content/70 rounded-2xl border px-4 py-2 text-xs font-semibold tracking-[0.2em] uppercase\">\n                  Total {fmtCLP(quickStats.total)}\n                </div>\n              </div>\n            </div>\n            <div className=\"text-base-content/70 flex flex-wrap items-end gap-3 text-xs\">\n              <Input\n                className=\"w-36\"\n                label=\"Desde\"\n                onChange={(event: ChangeEvent<HTMLInputElement>) => {\n                  onSummaryRangeChange({ from: event.target.value });\n                }}\n                type=\"date\"\n                value={summaryRange.from}\n              />\n              <Input\n                className=\"w-36\"\n                label=\"Hasta\"\n                onChange={(event: ChangeEvent<HTMLInputElement>) => {\n                  onSummaryRangeChange({ to: event.target.value });\n                }}\n                type=\"date\"\n                value={summaryRange.to}\n              />\n              <Button\n                onClick={() => {\n                  onSummaryRangeChange({\n                    from: fallbackRange.from,\n                    to: fallbackRange.to,\n                  });\n                }}\n                size=\"xs\"\n                variant=\"ghost\"\n              >\n                Año en curso\n              </Button>\n            </div>\n            <div className=\"surface-recessed border-base-300/70 border p-4\">{renderQuickViewContent()}</div>\n          </div>\n        ) : (\n          <div className=\"border-base-300/70 bg-base-100/40 text-base-content/60 rounded-[28px] border border-dashed p-8 text-center text-sm\">\n            Selecciona una cuenta en la tabla superior para ver su resumen y movimientos históricos.\n          </div>\n        )}\n      </div>\n\n      <Modal\n        isOpen={isAddAccountModalOpen}\n        onClose={() => {\n          setIsAddAccountModalOpen(false);\n        }}\n        title=\"Agregar cuenta\"\n      >\n        <div className=\"space-y-4 text-sm\">\n          <Input\n            label=\"Identificador / Cuenta\"\n            onChange={handleAccountIdentifierChange}\n            placeholder=\"Ej. 124282432930\"\n            type=\"text\"\n            value={accountForm.accountIdentifier}\n          />\n          {renderSuggestions()}\n          <div className=\"grid gap-3 md:grid-cols-2\">\n            <Input\n              label=\"Banco\"\n              onChange={updateAccountForm(\"bankName\")}\n              placeholder=\"Banco\"\n              type=\"text\"\n              value={accountForm.bankName}\n            />\n            <Input\n              label=\"Número de cuenta\"\n              onChange={updateAccountForm(\"bankAccountNumber\")}\n              placeholder=\"Ej. 00123456789\"\n              type=\"text\"\n              value={accountForm.bankAccountNumber}\n            />\n            <Input\n              label=\"Titular\"\n              onChange={updateAccountForm(\"holder\")}\n              placeholder=\"Titular de la cuenta\"\n              type=\"text\"\n              value={accountForm.holder}\n            />\n            <Input\n              label=\"Concepto\"\n              onChange={updateAccountForm(\"concept\")}\n              placeholder=\"Ej. Pago proveedor\"\n              type=\"text\"\n              value={accountForm.concept}\n            />\n            <Input\n              label=\"Tipo de cuenta\"\n              onChange={updateAccountForm(\"accountType\")}\n              placeholder=\"Cuenta corriente\"\n              type=\"text\"\n              value={accountForm.accountType}\n            />\n          </div>\n          <div className=\"flex justify-end gap-2\">\n            <Button\n              onClick={() => {\n                setIsAddAccountModalOpen(false);\n              }}\n              variant=\"ghost\"\n            >\n              Cancelar\n            </Button>\n            <Button\n              disabled={addAccountMutation.isPending}\n              onClick={() => {\n                handleAddAccount();\n              }}\n            >\n              {addAccountMutation.isPending ? \"Guardando...\" : \"Agregar cuenta\"}\n            </Button>\n          </div>\n        </div>\n      </Modal>\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/counterparts/components/AssociatedAccountsColumns.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/counterparts/components/CounterpartDetailSection.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":12,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[490,493],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[490,493],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always falsy.","line":27,"column":7,"nodeType":"UnaryExpression","messageId":"alwaysFalsy","endLine":27,"endColumn":14},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":54,"column":55,"nodeType":"MemberExpression","messageId":"neverNullish","endLine":54,"endColumn":82}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useSuspenseQuery } from \"@tanstack/react-query\";\nimport { Lock } from \"lucide-react\";\n\nimport Button from \"@/components/ui/Button\";\nimport AssociatedAccounts from \"@/features/counterparts/components/AssociatedAccounts\";\nimport { counterpartKeys } from \"@/features/counterparts/queries\";\nimport { ServicesSurface } from \"@/features/services/components/ServicesShell\";\n\ninterface CounterpartDetailSectionProps {\n  canUpdate: boolean;\n  counterpartId: number;\n  onEdit: (counterpart: any) => void;\n  onSummaryRangeChange: (update: Partial<{ from: string; to: string }>) => void;\n  summaryRange: { from: string; to: string };\n}\n\nexport default function CounterpartDetailSection({\n  canUpdate,\n  counterpartId,\n  onEdit,\n  onSummaryRangeChange,\n  summaryRange,\n}: Readonly<CounterpartDetailSectionProps>) {\n  const { data: detail } = useSuspenseQuery(counterpartKeys.detail(counterpartId));\n  const { data: summary } = useSuspenseQuery(counterpartKeys.summary(counterpartId, summaryRange));\n\n  if (!detail) return null; // Should not happen with suspense if data exists\n\n  return (\n    <div className=\"space-y-6\">\n      <ServicesSurface className=\"space-y-4\">\n        <div className=\"flex flex-wrap items-center justify-between gap-3\">\n          <div>\n            <p className=\"text-base-content/60 text-xs tracking-[0.3em] uppercase\">Contraparte activa</p>\n            <h3 className=\"text-base-content text-lg font-semibold\">{detail.counterpart.name}</h3>\n            {detail.counterpart.rut && <p className=\"text-base-content/70 text-xs\">RUT {detail.counterpart.rut}</p>}\n          </div>\n          <Button\n            disabled={!canUpdate}\n            onClick={() => {\n              onEdit(detail.counterpart);\n            }}\n            size=\"sm\"\n            title={canUpdate ? undefined : \"No tienes permisos para editar\"}\n            variant=\"ghost\"\n          >\n            {!canUpdate && <Lock className=\"mr-2 h-3 w-3\" />}\n            Editar contraparte\n          </Button>\n        </div>\n        <div className=\"text-base-content/70 grid gap-3 text-xs sm:grid-cols-2\">\n          <div>\n            <p className=\"text-base-content/60 font-semibold\">Clasificación</p>\n            <p className=\"text-base-content text-sm\">{detail.counterpart.category ?? \"—\"}</p>\n          </div>\n          <div>\n            <p className=\"text-base-content/60 font-semibold\">Tipo de persona</p>\n            <p className=\"text-base-content text-sm\">{detail.counterpart.personType}</p>\n          </div>\n          {detail.counterpart.email && (\n            <div className=\"sm:col-span-2\">\n              <p className=\"text-base-content/60 font-semibold\">Correo electrónico</p>\n              <p className=\"text-base-content text-sm\">{detail.counterpart.email}</p>\n            </div>\n          )}\n        </div>\n      </ServicesSurface>\n\n      <AssociatedAccounts\n        detail={detail}\n        onSummaryRangeChange={onSummaryRangeChange}\n        selectedId={counterpartId}\n        summary={summary}\n        summaryRange={summaryRange}\n      />\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/counterparts/components/CounterpartForm.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/counterparts/components/CounterpartList.tsx","messages":[{"ruleId":"unicorn/no-array-reduce","severity":2,"message":"`Array#reduce()` is not allowed. Prefer other types of loop for readability.","line":22,"column":42,"nodeType":"Identifier","messageId":"reduce","endLine":22,"endColumn":48},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":27,"column":41,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":32,"endColumn":24,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[920,940],"text":"Readonly<CounterpartListProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Button from \"@/components/ui/Button\";\nimport { formatRut } from \"@/lib/rut\";\n\nimport type { Counterpart, CounterpartCategory } from \"../types\";\n\ninterface CounterpartListProps {\n  className?: string;\n  counterparts: Counterpart[];\n  onSelectCounterpart: (id: null | number) => void;\n  selectedId: null | number;\n}\n\nconst CATEGORY_OPTIONS: { label: string; value: CounterpartCategory }[] = [\n  { label: \"Proveedor\", value: \"SUPPLIER\" },\n  { label: \"Paciente\", value: \"PATIENT\" },\n  { label: \"Empleado\", value: \"EMPLOYEE\" },\n  { label: \"Socio\", value: \"PARTNER\" },\n  { label: \"Relacionado a socio\", value: \"RELATED\" },\n  { label: \"Otro\", value: \"OTHER\" },\n];\n\nconst CATEGORY_LABELS = CATEGORY_OPTIONS.reduce<Record<string, string>>((acc, item) => {\n  acc[item.value] = item.label;\n  return acc;\n}, {});\n\nexport default function CounterpartList({\n  className,\n  counterparts,\n  onSelectCounterpart,\n  selectedId,\n}: CounterpartListProps) {\n  return (\n    <aside\n      className={`surface-recessed text-base-content flex h-full min-h-0 flex-col gap-4 overflow-hidden p-5 text-sm ${className ?? \"\"}`}\n    >\n      <header className=\"flex items-center justify-between gap-3\">\n        <h2 className=\"typ-caption text-base-content/80\">Contrapartes</h2>\n        <Button\n          onClick={() => {\n            onSelectCounterpart(null);\n          }}\n          size=\"xs\"\n        >\n          Nueva\n        </Button>\n      </header>\n      <ul className=\"muted-scrollbar flex-1 space-y-2 overflow-y-auto pr-1\">\n        {counterparts.map((item) => {\n          const isActive = selectedId === item.id;\n          return (\n            <li key={item.id}>\n              <button\n                className={`group w-full cursor-pointer rounded-2xl border px-3 py-2 text-left transition-all ${\n                  isActive\n                    ? \"border-primary/40 bg-primary/10 text-primary shadow-sm\"\n                    : \"bg-base-200/60 text-base-content hover:border-base-300 hover:bg-base-200 border-transparent\"\n                }`}\n                onClick={() => {\n                  onSelectCounterpart(item.id);\n                }}\n                type=\"button\"\n              >\n                <span className=\"flex items-center justify-between gap-2\">\n                  <span className=\"block font-medium tracking-tight\">{item.name}</span>\n                  <span\n                    className={`rounded-full px-2 py-0.5 text-xs font-semibold tracking-wide uppercase ${\n                      isActive ? \"bg-primary/15 text-primary\" : \"bg-base-300/60 text-base-content/60\"\n                    }`}\n                  >\n                    {CATEGORY_LABELS[item.category] ?? item.category}\n                  </span>\n                </span>\n                {item.rut && <span className=\"text-base-content/90 mt-1 block text-xs\">RUT {formatRut(item.rut)}</span>}\n              </button>\n            </li>\n          );\n        })}\n        {counterparts.length === 0 && (\n          <li className=\"border-base-300 bg-base-200 text-base-content/60 rounded-xl border px-3 py-2 text-xs\">\n            No hay registros aún.\n          </li>\n        )}\n      </ul>\n    </aside>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/counterparts/components/associated-accounts.helpers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/counterparts/constants.ts","messages":[{"ruleId":"unicorn/no-array-reduce","severity":2,"message":"`Array#reduce()` is not allowed. Prefer other types of loop for readability.","line":33,"column":49,"nodeType":"Identifier","messageId":"reduce","endLine":33,"endColumn":55}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { CounterpartCategory, CounterpartPersonType } from \"./types\";\n\nexport const EMPTY_FORM = {\n  category: \"SUPPLIER\" as CounterpartCategory,\n  email: \"\",\n  name: \"\",\n  notes: \"\",\n  personType: \"COMPANY\" as CounterpartPersonType,\n  rut: \"\",\n};\n\nexport const ACCOUNT_FORM_DEFAULT = {\n  accountIdentifier: \"\",\n  accountType: \"\",\n  bankAccountNumber: \"\",\n  bankName: \"\",\n  concept: \"\",\n  holder: \"\",\n};\n\nexport const CATEGORY_OPTIONS: { label: string; value: CounterpartCategory }[] = [\n  { label: \"Proveedor\", value: \"SUPPLIER\" },\n  { label: \"Paciente\", value: \"PATIENT\" },\n  { label: \"Empleado\", value: \"EMPLOYEE\" },\n  { label: \"Socio\", value: \"PARTNER\" },\n  { label: \"Relacionado a socio\", value: \"RELATED\" },\n  { label: \"Cliente\", value: \"CLIENT\" },\n  { label: \"Prestamista\", value: \"LENDER\" },\n  { label: \"Ocasional\", value: \"OCCASIONAL\" },\n  { label: \"Otro\", value: \"OTHER\" },\n];\n\nexport const CATEGORY_LABELS = CATEGORY_OPTIONS.reduce<Record<string, string>>((acc, item) => {\n  acc[item.value] = item.label;\n  return acc;\n}, {});\n\nexport const SUMMARY_RANGE_MONTHS = 6;\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/counterparts/pages/CounterpartsPage.tsx","messages":[{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":95,"column":30,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":95,"endColumn":32,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[3941,3943],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useFindManyCounterpart } from \"@finanzas/db/hooks\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport dayjs from \"dayjs\";\nimport { Suspense, useState } from \"react\";\n\nimport type { Counterpart, CounterpartCategory, CounterpartPersonType } from \"@/features/counterparts/types\";\n\nimport Button from \"@/components/ui/Button\";\nimport Modal from \"@/components/ui/Modal\";\nimport Skeleton from \"@/components/ui/Skeleton\";\nimport { useAuth } from \"@/context/AuthContext\";\nimport { useToast } from \"@/context/ToastContext\";\nimport {\n  attachCounterpartRut,\n  type CounterpartUpsertPayload,\n  createCounterpart,\n  updateCounterpart,\n} from \"@/features/counterparts/api\";\nimport CounterpartForm from \"@/features/counterparts/components/CounterpartForm\";\nimport CounterpartList from \"@/features/counterparts/components/CounterpartList\";\nimport { SUMMARY_RANGE_MONTHS } from \"@/features/counterparts/constants\";\nimport { counterpartKeys } from \"@/features/counterparts/queries\";\nimport { ServicesGrid, ServicesHero, ServicesSurface } from \"@/features/services/components/ServicesShell\";\nimport { getPersonFullName } from \"@/lib/person\";\nimport { normalizeRut } from \"@/lib/rut\";\n\nimport CounterpartDetailSection from \"../components/CounterpartDetailSection\";\n\nexport default function CounterpartsPage() {\n  const { can } = useAuth();\n  const queryClient = useQueryClient();\n  const [selectedId, setSelectedId] = useState<null | number>(null);\n\n  const canCreate = can(\"create\", \"Counterpart\");\n  const canUpdate = can(\"update\", \"Counterpart\");\n  const [error, setError] = useState<null | string>(null);\n\n  const [summaryRange, setSummaryRange] = useState<{ from: string; to: string }>(() => ({\n    from: dayjs().subtract(SUMMARY_RANGE_MONTHS, \"month\").startOf(\"month\").format(\"YYYY-MM-DD\"),\n    to: dayjs().endOf(\"month\").format(\"YYYY-MM-DD\"),\n  }));\n  const { error: toastError, info: toastInfo, success: toastSuccess } = useToast();\n  const [personTypeFilter, setPersonTypeFilter] = useState<\"ALL\" | CounterpartPersonType>(\"ALL\");\n  const [categoryFilter, setCategoryFilter] = useState<\"ALL\" | CounterpartCategory>(\"ALL\");\n  const [isFormModalOpen, setIsFormModalOpen] = useState(false);\n  const [formCounterpart, setFormCounterpart] = useState<Counterpart | null>(null);\n\n  const openFormModal = (target: Counterpart | null = null) => {\n    setFormCounterpart(target);\n    setIsFormModalOpen(true);\n  };\n\n  const closeFormModal = () => {\n    setIsFormModalOpen(false);\n    setFormCounterpart(null);\n  };\n\n  // ZenStack hook for list query\n  const { data: counterpartsData, error: listError } = useFindManyCounterpart({\n    include: { person: true },\n  });\n\n  // Transform ZenStack data to match frontend Counterpart type\n  type ZenStackCounterpart = NonNullable<typeof counterpartsData>[number];\n  const counterparts: Counterpart[] = (counterpartsData ?? []).map((row: ZenStackCounterpart) => {\n    const person = (\n      row as {\n        person?: {\n          email?: null | string;\n          fatherName?: null | string;\n          motherName?: null | string;\n          names?: string;\n          personType?: string;\n          rut?: string;\n        };\n      }\n    ).person;\n    return {\n      category: row.category as Counterpart[\"category\"],\n      created_at: (row as { createdAt?: Date }).createdAt?.toISOString() ?? new Date().toISOString(),\n      email: person?.email ?? null,\n      employeeId: null,\n      id: row.id,\n      name: person\n        ? getPersonFullName(person as { fatherName?: null | string; motherName?: null | string; names: string })\n        : \"Sin nombre\",\n      notes: row.notes ?? null,\n      personType: (person?.personType ?? \"NATURAL\") as Counterpart[\"personType\"],\n      rut: person?.rut ?? null,\n      updated_at: (row as { updatedAt?: Date }).updatedAt?.toISOString() ?? new Date().toISOString(),\n    };\n  });\n\n  // Derived error state (combine/prioritize)\n  const displayError = error || (listError instanceof Error ? listError.message : null);\n\n  // Use REST API mutations (they handle Person+Counterpart relationship correctly)\n  const createMutation = useMutation({\n    mutationFn: createCounterpart,\n    onSuccess: () => {\n      void queryClient.invalidateQueries({ queryKey: [\"Counterpart\"] });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: ({ id, payload }: { id: number; payload: Partial<CounterpartUpsertPayload> }) =>\n      updateCounterpart(id, payload),\n    onSuccess: () => {\n      void queryClient.invalidateQueries({ queryKey: [\"Counterpart\"] });\n      // Detail invalidation handled by key factory invalidation if needed, or exact key match\n      if (selectedId) {\n        void queryClient.invalidateQueries({ queryKey: counterpartKeys.detail(selectedId).queryKey });\n      }\n    },\n  });\n\n  async function handleSaveCounterpart(payload: CounterpartUpsertPayload) {\n    setError(null);\n    const normalizedRut = normalizeRut(payload.rut ?? null);\n\n    try {\n      if (!payload.name) throw new Error(\"El nombre es obligatorio\");\n\n      let savedId = selectedId;\n      let isNew = false;\n\n      if (selectedId) {\n        await updateMutation.mutateAsync({ id: selectedId, payload });\n        toastSuccess(\"Contraparte actualizada correctamente\");\n      } else {\n        const result = await createMutation.mutateAsync(payload);\n        savedId = result.counterpart.id;\n        isNew = true;\n        toastSuccess(\"Contraparte creada correctamente\");\n      }\n\n      setSelectedId(savedId);\n      setIsFormModalOpen(false);\n\n      // Handle RUT attachment auto-logic\n      if (savedId && normalizedRut && isNew) {\n        try {\n          await attachCounterpartRut(savedId, normalizedRut);\n          void queryClient.invalidateQueries({ queryKey: [\"counterpart\"] });\n          toastInfo(\"Cuentas detectadas vinculadas automáticamente\");\n        } catch (attachError) {\n          console.warn(\"Auto-attach failed\", attachError);\n        }\n      }\n    } catch (error_) {\n      const message = error_ instanceof Error ? error_.message : \"Error al guardar contraparte\";\n      setError(message);\n      toastError(message);\n    }\n  }\n\n  const handleSelectCounterpart = (id: null | number) => {\n    setSelectedId(id);\n  };\n\n  const handleSummaryRangeChange = (update: Partial<{ from: string; to: string }>) => {\n    setSummaryRange((prev) => ({ ...prev, ...update }));\n  };\n\n  const PERSON_FILTERS: { label: string; value: \"ALL\" | CounterpartPersonType }[] = [\n    { label: \"Todas las personas\", value: \"ALL\" },\n    { label: \"Persona natural\", value: \"NATURAL\" },\n    { label: \"Empresa\", value: \"JURIDICAL\" },\n  ];\n  const CATEGORY_FILTERS: { label: string; value: \"ALL\" | CounterpartCategory }[] = [\n    { label: \"Todos los tipos\", value: \"ALL\" },\n    { label: \"Proveedores\", value: \"SUPPLIER\" },\n    { label: \"Prestamistas\", value: \"LENDER\" },\n    { label: \"Clientes\", value: \"CLIENT\" },\n    { label: \"Empleados\", value: \"EMPLOYEE\" },\n    { label: \"Ocasionales\", value: \"OCCASIONAL\" },\n  ];\n\n  const deduplicatedCounterparts = (() => {\n    const map = new Map<string, Counterpart>();\n    for (const item of counterparts) {\n      const rutKey = item.rut ? normalizeRut(item.rut) : null;\n      const nameKey = item.name.trim().toLowerCase();\n      const key = (rutKey ?? nameKey) || item.id.toString();\n      if (!map.has(key)) {\n        map.set(key, item);\n      }\n    }\n    return [...map.values()];\n  })();\n\n  const visibleCounterparts = deduplicatedCounterparts.filter((item) => {\n    const matchesPersonType = personTypeFilter === \"ALL\" || item.personType === personTypeFilter;\n    const matchesCategory = categoryFilter === \"ALL\" || item.category === categoryFilter;\n    return matchesPersonType && matchesCategory;\n  });\n\n  return (\n    <section className=\"space-y-8\">\n      <ServicesHero\n        actions={\n          canCreate ? (\n            <Button\n              onClick={() => {\n                openFormModal(null);\n              }}\n            >\n              + Nueva contraparte\n            </Button>\n          ) : null\n        }\n        description=\"Gestiona proveedores, prestamistas y clientes con sus cuentas asociadas y movimientos históricos.\"\n        title=\"Contrapartes\"\n      />\n      <ServicesSurface>\n        <div className=\"space-y-4\">\n          <div className=\"flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between\">\n            <div>\n              <p className=\"text-base-content/60 text-xs font-semibold tracking-[0.4em] uppercase\">Filtros rápidos</p>\n              <p className=\"text-base-content/70 text-sm\">Acota la lista por tipo de persona y clasificación.</p>\n            </div>\n            <Button\n              onClick={() => {\n                setPersonTypeFilter(\"ALL\");\n                setCategoryFilter(\"ALL\");\n              }}\n              size=\"sm\"\n              variant=\"ghost\"\n            >\n              Reset filtros\n            </Button>\n          </div>\n          <div className=\"grid gap-4 lg:grid-cols-2\">\n            <div className=\"space-y-2\">\n              <p className=\"text-base-content/60 text-xs font-semibold tracking-[0.3em] uppercase\">Tipo de persona</p>\n              <div className=\"flex flex-wrap gap-2\">\n                {PERSON_FILTERS.map((filter) => (\n                  <Button\n                    key={filter.value}\n                    onClick={() => {\n                      setPersonTypeFilter(filter.value);\n                    }}\n                    size=\"sm\"\n                    variant={personTypeFilter === filter.value ? \"primary\" : \"ghost\"}\n                  >\n                    {filter.label}\n                  </Button>\n                ))}\n              </div>\n            </div>\n            <div className=\"space-y-2\">\n              <p className=\"text-base-content/60 text-xs font-semibold tracking-[0.3em] uppercase\">Clasificación</p>\n              <div className=\"flex flex-wrap gap-2\">\n                {CATEGORY_FILTERS.map((filter) => (\n                  <Button\n                    key={filter.value}\n                    onClick={() => {\n                      setCategoryFilter(filter.value);\n                    }}\n                    size=\"sm\"\n                    variant={categoryFilter === filter.value ? \"primary\" : \"ghost\"}\n                  >\n                    {filter.label}\n                  </Button>\n                ))}\n              </div>\n            </div>\n          </div>\n        </div>\n      </ServicesSurface>\n\n      <ServicesGrid>\n        <ServicesSurface className=\"h-full\">\n          <CounterpartList\n            className=\"max-h-[calc(100vh-220px)]\"\n            counterparts={visibleCounterparts}\n            onSelectCounterpart={handleSelectCounterpart}\n            selectedId={selectedId}\n          />\n        </ServicesSurface>\n\n        <div className=\"h-full\">\n          {!selectedId && (\n            <ServicesSurface className=\"h-full\">\n              <div className=\"flex flex-col items-center justify-center p-8 text-center\">\n                <p className=\"text-base-content/60 text-sm\">Selecciona una contraparte para ver los detalles</p>\n              </div>\n            </ServicesSurface>\n          )}\n\n          {selectedId && (\n            <Suspense\n              fallback={\n                <ServicesSurface className=\"space-y-4\">\n                  <Skeleton className=\"h-8 w-1/2\" />\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <Skeleton className=\"h-12 w-full\" />\n                    <Skeleton className=\"h-12 w-full\" />\n                  </div>\n                </ServicesSurface>\n              }\n            >\n              <CounterpartDetailSection\n                canUpdate={canUpdate}\n                counterpartId={selectedId}\n                onEdit={openFormModal}\n                onSummaryRangeChange={handleSummaryRangeChange}\n                summaryRange={summaryRange}\n              />\n            </Suspense>\n          )}\n        </div>\n      </ServicesGrid>\n      <Modal\n        isOpen={isFormModalOpen}\n        onClose={closeFormModal}\n        title={formCounterpart ? \"Editar contraparte\" : \"Nueva contraparte\"}\n      >\n        <CounterpartForm\n          counterpart={formCounterpart}\n          error={error ?? displayError}\n          onSave={handleSaveCounterpart}\n          saving={createMutation.isPending || updateMutation.isPending}\n        />\n      </Modal>\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/counterparts/queries.ts","messages":[{"ruleId":"@typescript-eslint/require-await","severity":2,"message":"Async method 'queryFn' has no 'await' expression.","line":27,"column":7,"nodeType":"ArrowFunctionExpression","messageId":"missingAwait","endLine":27,"endColumn":22,"suggestions":[{"messageId":"removeAsync","fix":{"range":[842,848],"text":""},"desc":"Remove 'async'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { queryOptions } from \"@tanstack/react-query\";\n\nimport { fetchCounterpart, fetchCounterpartSummary } from \"./api\";\n\nexport const counterpartKeys = {\n  all: [\"counterpart\"] as const,\n  detail: (id: number) =>\n    queryOptions({\n      enabled: !!id,\n      queryFn: () => fetchCounterpart(id),\n      queryKey: [\"counterpart-detail\", id],\n    }),\n  lists: () => [...counterpartKeys.all, \"list\"] as const,\n  summary: (id: number, range: { from: string; to: string }) =>\n    queryOptions({\n      enabled: !!id,\n      queryFn: () => fetchCounterpartSummary(id, range),\n      queryKey: [\"counterpart-summary\", id, range],\n    }),\n};\n\n// Note: Counterparts page uses ZenStack useFindManyCounterpart hook directly\n// For loader, we'll use the DB query approach\nexport const counterpartQueries = {\n  list: () =>\n    queryOptions({\n      queryFn: async () => {\n        // This will be handled by ZenStack in the component\n        // For now, return empty array to avoid breaking loader\n        return [];\n      },\n      queryKey: counterpartKeys.lists(),\n    }),\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/counterparts/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/dashboard/api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/dashboard/components/DashboardChart.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":5,"column":40,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":11,"endColumn":2,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[115,205],"text":"Readonly<{\n  data: { in: number; month: string; net: number; out: number }[];\n  loading: boolean;\n}>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import dayjs from \"dayjs\";\n\nconst RANGE_DAYS = 30;\n\nexport default function DashboardChart({\n  data,\n  loading,\n}: {\n  data: { in: number; month: string; net: number; out: number }[];\n  loading: boolean;\n}) {\n  if (loading) {\n    return <div className=\"surface-recessed text-base-content p-6 text-sm\">Cargando actividad...</div>;\n  }\n\n  if (data.length === 0) {\n    return <div className=\"surface-recessed text-base-content p-6 text-sm\">No se registran movimientos recientes.</div>;\n  }\n\n  const maxValue = Math.max(...data.map((row) => Math.max(row.in, row.out)));\n\n  return (\n    <article className=\"surface-recessed space-y-4 p-6\">\n      <div className=\"flex flex-wrap items-center justify-between gap-2\">\n        <h2 className=\"typ-subtitle text-base-content\">Actividad de los últimos {RANGE_DAYS} días</h2>\n        <span className=\"typ-caption border-base-300 bg-base-200 text-base-content/70 rounded-full border px-3 py-1\">\n          Ingresos vs egresos\n        </span>\n      </div>\n      <div className=\"muted-scrollbar flex items-end gap-4 overflow-x-auto pb-2\">\n        {data.map((row) => {\n          const inHeight = maxValue ? Math.max((row.in / maxValue) * 140, 4) : 4;\n          const outHeight = maxValue ? Math.max((row.out / maxValue) * 140, 4) : 4;\n          return (\n            <div className=\"flex min-w-20 flex-col items-center gap-2\" key={row.month}>\n              <div className=\"border-base-300 bg-base-200 flex h-40 w-full items-end gap-2 rounded-xl border p-2\">\n                <div className=\"bg-success/80 flex-1 rounded-full shadow-sm\" style={{ height: `${inHeight}px` }} />\n                <div className=\"bg-error/80 flex-1 rounded-full shadow-sm\" style={{ height: `${outHeight}px` }} />\n              </div>\n              <span className=\"text-base-content text-xs font-medium\">{dayjs(row.month).format(\"MMM YY\")}</span>\n            </div>\n          );\n        })}\n      </div>\n    </article>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/dashboard/components/DashboardParticipantsSection.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":16,"column":54,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":16,"endColumn":71,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[396,401],"text":"Readonly<Props>"},"desc":"Mark the props as read-only"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":18,"column":27,"nodeType":"MemberExpression","messageId":"alwaysTruthy","endLine":18,"endColumn":55}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useSuspenseQuery } from \"@tanstack/react-query\";\n\nimport { participantQueries } from \"@/features/participants/queries\";\n\nimport TopParticipantsWidget from \"./TopParticipantsWidget\";\n\ninterface Props {\n  params: {\n    from: string;\n    limit: number;\n    mode: \"combined\" | \"incoming\" | \"outgoing\";\n    to: string;\n  };\n}\n\nexport default function DashboardParticipantsSection({ params }: Props) {\n  const { data: leaderboardData } = useSuspenseQuery(participantQueries.leaderboard(params));\n  const topParticipants = leaderboardData.participants || [];\n\n  return <TopParticipantsWidget data={topParticipants} error={null} loading={false} />;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/dashboard/components/DashboardPersonalLiabilities.tsx","messages":[{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":21,"column":34,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":21,"endColumn":52},{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":21,"column":75,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":21,"endColumn":93}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useSuspenseQuery } from \"@tanstack/react-query\";\nimport { Link } from \"@tanstack/react-router\";\nimport { CreditCard, TrendingDown } from \"lucide-react\";\n\nimport { personalFinanceQueries } from \"@/features/personal-finance/queries\";\nimport { formatCurrency } from \"@/lib/format\";\n\nexport function DashboardPersonalLiabilities() {\n  const { data: credits } = useSuspenseQuery(personalFinanceQueries.list());\n\n  // Calculate totals\n  const activeCredits = credits.filter((c) => (c.remainingAmount ?? 0) > 0);\n  const totalDebt = activeCredits.reduce((sum, c) => sum + (c.remainingAmount ?? 0), 0);\n\n  // Find next payment (earliest due date from active credits nextInstallmentDate)\n  // Assuming 'nextPaymentDate' or similar is on the credit object,\n  // or we need to look at installments. For summary, total debt is key.\n\n  const upcomingPayments = [...activeCredits]\n    .filter((c) => c.nextPaymentDate && new Date(c.nextPaymentDate) >= new Date())\n    .toSorted((a, b) => new Date(a.nextPaymentDate!).getTime() - new Date(b.nextPaymentDate!).getTime());\n\n  const nextPayment = upcomingPayments[0];\n\n  if (activeCredits.length === 0) return null;\n\n  return (\n    <div className=\"card card-compact bg-base-100 shadow-sm\">\n      <div className=\"card-body\">\n        <div className=\"flex items-center justify-between\">\n          <h3 className=\"text-base-content text-sm font-semibold\">Pasivos Personales</h3>\n          <Link className=\"text-primary text-xs hover:underline\" to=\"/finanzas/loans\">\n            Ver todos\n          </Link>\n        </div>\n\n        <div className=\"mt-2 grid grid-cols-2 gap-4\">\n          <div className=\"bg-error/10 rounded-lg p-3\">\n            <div className=\"mb-1 flex items-center gap-2\">\n              <div className=\"bg-error/20 text-error rounded-md p-1.5\">\n                <CreditCard className=\"h-4 w-4\" />\n              </div>\n              <span className=\"text-base-content/70 text-xs font-medium\">Deuda Total</span>\n            </div>\n            <p className=\"text-error text-lg font-bold\">{formatCurrency(totalDebt)}</p>\n            <p className=\"text-base-content/60 text-xs\">{activeCredits.length} créditos activos</p>\n          </div>\n\n          {nextPayment ? (\n            <div className=\"bg-base-200/50 rounded-lg p-3\">\n              <div className=\"mb-1 flex items-center gap-2\">\n                <div className=\"bg-base-300 text-base-content/70 rounded-md p-1.5\">\n                  <TrendingDown className=\"h-4 w-4\" />\n                </div>\n                <span className=\"text-base-content/70 text-xs font-medium\">Próximo Pago</span>\n              </div>\n              <div className=\"flex flex-col\">\n                <span className=\"text-sm font-semibold\">{formatCurrency(nextPayment.nextPaymentAmount ?? 0)}</span>\n                <span className=\"text-base-content/60 truncate text-xs\">{nextPayment.institution}</span>\n              </div>\n            </div>\n          ) : (\n            <div className=\"bg-success/10 flex flex-col justify-center rounded-lg p-3\">\n              <span className=\"text-success text-sm font-medium\">Al día 🎉</span>\n              <span className=\"text-base-content/60 text-xs\">Sin pagos pendientes</span>\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/dashboard/components/DashboardTransactionsSection.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":12,"column":54,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":12,"endColumn":76,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[387,392],"text":"Readonly<Props>"},"desc":"Mark the props as read-only"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":16,"column":18,"nodeType":"MemberExpression","messageId":"alwaysTruthy","endLine":16,"endColumn":30},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":34,"column":33,"nodeType":"MemberExpression","messageId":"neverNullish","endLine":34,"endColumn":46}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useSuspenseQuery } from \"@tanstack/react-query\";\n\nimport { dashboardKeys } from \"../queries\";\nimport DashboardChart from \"./DashboardChart\";\nimport MetricCard from \"./MetricCard\";\nimport RecentMovementsWidget from \"./RecentMovementsWidget\";\n\ninterface Props {\n  statsParams: { from: string; to: string };\n}\n\nexport default function DashboardTransactionsSection({ statsParams }: Props) {\n  const { data: stats } = useSuspenseQuery(dashboardKeys.stats(statsParams));\n  const { data: recentMovements } = useSuspenseQuery(dashboardKeys.recentMovements());\n\n  const totals = stats.totals\n    ? {\n        in: stats.totals.IN ?? 0,\n        net: (stats.totals.IN ?? 0) - (stats.totals.OUT ?? 0),\n        out: stats.totals.OUT ?? 0,\n      }\n    : { in: 0, net: 0, out: 0 };\n\n  return (\n    <>\n      <section className=\"grid grid-cols-[repeat(auto-fit,minmax(180px,1fr))] gap-3\">\n        <MetricCard accent=\"emerald\" loading={false} title=\"Ingresos\" value={totals.in} />\n        <MetricCard accent=\"rose\" loading={false} title=\"Egresos\" value={totals.out} />\n        <MetricCard accent={totals.net >= 0 ? \"emerald\" : \"rose\"} loading={false} title=\"Neto\" value={totals.net} />\n      </section>\n\n      <div className=\"grid gap-4 lg:grid-cols-[1.5fr_1fr]\">\n        <div className=\"space-y-4\">\n          <DashboardChart data={stats.monthly ?? []} loading={false} />\n          {/* QuickLinks injected from parent? No, Home renders it. */}\n        </div>\n        <aside className=\"space-y-4\">\n          <RecentMovementsWidget rows={recentMovements} />\n        </aside>\n      </div>\n    </>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/dashboard/components/MetricCard.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":48,"column":36,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":58,"endColumn":2,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[1207,1282],"text":"Readonly<{\n  accent: Accent;\n  loading: boolean;\n  title: string;\n  value: number;\n}>"},"desc":"Mark the props as read-only"}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Variable Assigned to Object Injection Sink","line":59,"column":17,"nodeType":"MemberExpression","endLine":59,"endColumn":37}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { type LucideIcon, TrendingDown, TrendingUp, Wallet } from \"lucide-react\";\n\nimport { fmtCLP } from \"@/lib/format\";\n\ntype Accent = \"emerald\" | \"primary\" | \"rose\";\n\nconst ACCENT_THEME: Record<\n  Accent,\n  {\n    badge: string;\n    badgeLabel: string;\n    gradient: string;\n    icon: LucideIcon;\n    iconColor: string;\n    ring: string;\n    value: string;\n  }\n> = {\n  emerald: {\n    badge: \"bg-success/10 text-success\",\n    badgeLabel: \"Ingresos\",\n    gradient: \"from-success/20 via-success/5 to-transparent\",\n    icon: TrendingUp,\n    iconColor: \"text-success\",\n    ring: \"ring-success/20\",\n    value: \"text-success\",\n  },\n  primary: {\n    badge: \"bg-primary/10 text-primary\",\n    badgeLabel: \"Resultado\",\n    gradient: \"from-primary/20 via-primary/5 to-transparent\",\n    icon: Wallet,\n    iconColor: \"text-primary\",\n    ring: \"ring-primary/20\",\n    value: \"text-primary\",\n  },\n  rose: {\n    badge: \"bg-error/10 text-error\",\n    badgeLabel: \"Egresos\",\n    gradient: \"from-error/20 via-error/5 to-transparent\",\n    icon: TrendingDown,\n    iconColor: \"text-error\",\n    ring: \"ring-error/20\",\n    value: \"text-error\",\n  },\n};\n\nexport default function MetricCard({\n  accent,\n  loading,\n  title,\n  value,\n}: {\n  accent: Accent;\n  loading: boolean;\n  title: string;\n  value: number;\n}) {\n  const theme = ACCENT_THEME[accent];\n  const Icon = theme.icon;\n\n  return (\n    <article\n      className={`relative overflow-hidden rounded-4xl bg-linear-to-br ${theme.gradient} p-6 shadow-lg ring-1 transition-all duration-300 ring-inset hover:-translate-y-1 hover:shadow-xl ${theme.ring}`}\n    >\n      <div\n        aria-hidden=\"true\"\n        className={`pointer-events-none absolute inset-0 rounded-3xl bg-linear-to-br ${theme.gradient}`}\n      />\n      <div className=\"relative flex flex-col gap-3\">\n        <div className=\"flex items-start justify-between gap-3\">\n          <div className=\"flex items-center gap-2\">\n            <div\n              className={`bg-base-100/50 flex h-8 w-8 items-center justify-center rounded-full ring-1 backdrop-blur-sm ring-inset ${theme.ring}`}\n            >\n              <Icon className={`h-4 w-4 ${theme.iconColor}`} />\n            </div>\n            <h2 className=\"typ-caption text-base-content/70\">{title}</h2>\n          </div>\n          <span\n            className={`hidden rounded-full px-3 py-1 text-[11px] font-semibold tracking-wide uppercase lg:inline-flex ${theme.badge}`}\n          >\n            {theme.badgeLabel}\n          </span>\n        </div>\n        <p className={`typ-subtitle ${theme.value} pl-1`}>{loading ? \"—\" : fmtCLP(value)}</p>\n      </div>\n    </article>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/dashboard/components/RecentMovementsWidget.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":8,"column":47,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":8,"endColumn":80,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[233,256],"text":"Readonly<{ rows: Transaction[] }>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Link } from \"@tanstack/react-router\";\nimport dayjs from \"dayjs\";\n\nimport type { Transaction } from \"@/features/finance/types\";\n\nimport { fmtCLP } from \"@/lib/format\";\n\nexport default function RecentMovementsWidget({ rows }: { rows: Transaction[] }) {\n  return (\n    <article className=\"surface-recessed space-y-4 p-6\">\n      <div className=\"flex items-center justify-between\">\n        <h3 className=\"text-base-content text-base font-semibold drop-shadow-sm\">Últimos movimientos</h3>\n        <Link\n          className=\"border-primary/45 bg-primary/15 text-primary inline-flex items-center rounded-full border px-3 py-1 text-xs font-semibold tracking-wide uppercase\"\n          to=\"/finanzas/statistics\"\n        >\n          Ver más\n        </Link>\n      </div>\n      {rows.length > 0 ? (\n        <ul className=\"text-base-content space-y-3 text-xs\">\n          {rows.map((row) => (\n            <li\n              className=\"border-base-300 bg-base-200 flex items-start justify-between gap-3 rounded-2xl border px-4 py-3 shadow-sm\"\n              key={row.id}\n            >\n              <div>\n                <p className=\"text-base-content font-medium\">\n                  {row.description ?? row.sourceId ?? \"(sin descripción)\"}\n                </p>\n                <p className=\"text-base-content/50 text-xs tracking-wide uppercase\">\n                  {dayjs(row.transactionDate).format(\"DD MMM YYYY HH:mm\")}\n                </p>\n              </div>\n              <span\n                className={`text-xs font-semibold ${(row.transactionAmount ?? 0) >= 0 ? \"text-success\" : \"text-error\"}`}\n              >\n                {fmtCLP(row.transactionAmount ?? 0)}\n              </span>\n            </li>\n          ))}\n        </ul>\n      ) : (\n        <p className=\"text-base-content text-xs\">Sin movimientos cargados aún.</p>\n      )}\n    </article>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/dashboard/components/ShortcutCard.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":5,"column":38,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":15,"endColumn":2,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[183,275],"text":"Readonly<{\n  accent: \"primary\" | \"secondary\";\n  description: string;\n  title: string;\n  to: string;\n}>"},"desc":"Mark the props as read-only"}]},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":29,"column":25,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":29,"endColumn":47,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[712,726],"text":"Readonly<{ to: string }>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useNavigate } from \"@tanstack/react-router\";\n\nimport Button from \"@/components/ui/Button\";\n\nexport default function ShortcutCard({\n  accent,\n  description,\n  title,\n  to,\n}: {\n  accent: \"primary\" | \"secondary\";\n  description: string;\n  title: string;\n  to: string;\n}) {\n  const accentClass = accent === \"primary\" ? \"text-primary\" : \"text-secondary\";\n\n  return (\n    <article className=\"surface-recessed flex flex-col justify-between p-6\">\n      <div>\n        <h2 className={`text-lg font-semibold ${accentClass}`}>{title}</h2>\n        <p className=\"text-base-content/90 mt-2 text-sm\">{description}</p>\n      </div>\n      <ShortcutButton to={to} />\n    </article>\n  );\n}\n\nfunction ShortcutButton({ to }: { to: string }) {\n  const navigate = useNavigate();\n  return (\n    <Button className=\"mt-5\" onClick={() => navigate({ to: to })} type=\"button\" variant=\"primary\">\n      Abrir\n    </Button>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/dashboard/components/TopParticipantsWidget.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":8,"column":47,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":16,"endColumn":2,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[278,358],"text":"Readonly<{\n  data: ParticipantSummaryRow[];\n  error: null | string;\n  loading: boolean;\n}>"},"desc":"Mark the props as read-only"}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":33,"column":56,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":33,"endColumn":58,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1179,1221],"text":"(item.bankAccountHolder ?? item.displayName)"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":39,"column":52,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":39,"endColumn":54,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1528,1569],"text":"(item.bankAccountNumber ?? item.withdrawId)"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":39,"column":71,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":39,"endColumn":73,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1570,1572],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Link } from \"@tanstack/react-router\";\n\nimport { fmtCLP } from \"@/lib/format\";\nimport { formatRut } from \"@/lib/rut\";\n\nimport type { ParticipantSummaryRow } from \"../../participants/types\";\n\nexport default function TopParticipantsWidget({\n  data,\n  error,\n  loading,\n}: {\n  data: ParticipantSummaryRow[];\n  error: null | string;\n  loading: boolean;\n}) {\n  return (\n    <article className=\"surface-recessed space-y-4 p-6\">\n      <div className=\"flex items-center justify-between\">\n        <h3 className=\"text-secondary text-base font-semibold drop-shadow-sm\">Retiros destacados</h3>\n        <Link\n          className=\"border-secondary/40 bg-secondary/15 text-secondary inline-flex items-center rounded-full border px-3 py-1 text-xs font-semibold tracking-wide uppercase\"\n          to=\"/finanzas/participants\"\n        >\n          Ver todos\n        </Link>\n      </div>\n      {error && <p className=\"text-error text-xs\">{error}</p>}\n      {loading && <p className=\"text-base-content text-xs\">Cargando...</p>}\n      {!loading && data.length > 0 && (\n        <ul className=\"text-base-content space-y-3 text-sm\">\n          {data.map((item) => {\n            const displayName = item.bankAccountHolder || item.displayName || item.participant || \"Sin información\";\n            const rutValue =\n              item.identificationNumber && typeof item.identificationNumber === \"string\"\n                ? formatRut(item.identificationNumber)\n                : \"\";\n            const rut = rutValue || \"-\";\n            const account = item.bankAccountNumber || item.withdrawId || \"-\";\n            return (\n              <li\n                className=\"border-base-300 bg-base-200 flex items-center justify-between gap-3 rounded-2xl border px-4 py-3 shadow-sm\"\n                key={`${item.participant}-${item.withdrawId ?? \"\"}`}\n              >\n                <div>\n                  <p className=\"text-base-content font-medium\">{displayName}</p>\n                  <p className=\"text-base-content/90 text-xs\">\n                    RUT {rut} · Cuenta {account}\n                  </p>\n                  <p className=\"text-base-content/80 text-xs tracking-wide uppercase\">{item.outgoingCount} retiros</p>\n                </div>\n                <span className=\"text-base-content/70 text-xs font-semibold\">{fmtCLP(item.outgoingAmount)}</span>\n              </li>\n            );\n          })}\n        </ul>\n      )}\n      {!loading && data.length === 0 && <p className=\"text-base-content text-xs\">Aún no hay retiros registrados.</p>}\n    </article>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/dashboard/hooks.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/dashboard/queries.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/data-import/api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/doctoralia/api.ts","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, comparison is always false, since `\"ok\" !== \"ok\"` is false.","line":42,"column":7,"nodeType":"BinaryExpression","messageId":"comparisonBetweenLiteralTypes","endLine":42,"endColumn":31},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, comparison is always false, since `\"ok\" !== \"ok\"` is false.","line":79,"column":7,"nodeType":"BinaryExpression","messageId":"comparisonBetweenLiteralTypes","endLine":79,"endColumn":31},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, comparison is always false, since `\"ok\" !== \"ok\"` is false.","line":96,"column":7,"nodeType":"BinaryExpression","messageId":"comparisonBetweenLiteralTypes","endLine":96,"endColumn":31},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, comparison is always false, since `\"ok\" !== \"ok\"` is false.","line":110,"column":7,"nodeType":"BinaryExpression","messageId":"comparisonBetweenLiteralTypes","endLine":110,"endColumn":31},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, comparison is always false, since `\"ok\" !== \"ok\"` is false.","line":124,"column":7,"nodeType":"BinaryExpression","messageId":"comparisonBetweenLiteralTypes","endLine":124,"endColumn":31},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, comparison is always false, since `\"ok\" !== \"ok\"` is false.","line":137,"column":7,"nodeType":"BinaryExpression","messageId":"comparisonBetweenLiteralTypes","endLine":137,"endColumn":31},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, comparison is always false, since `\"ok\" !== \"ok\"` is false.","line":154,"column":7,"nodeType":"BinaryExpression","messageId":"comparisonBetweenLiteralTypes","endLine":154,"endColumn":31},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, comparison is always false, since `\"accepted\" !== \"accepted\"` is false.","line":168,"column":7,"nodeType":"BinaryExpression","messageId":"comparisonBetweenLiteralTypes","endLine":168,"endColumn":37}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Doctoralia API Client\n *\n * Frontend API functions for Doctoralia integration.\n */\n\nimport { apiClient } from \"@/lib/api-client\";\n\nimport type {\n  BookSlotPayload,\n  DoctoraliaBooking,\n  DoctoraliaBookingQuery,\n  DoctoraliaBookingsResponse,\n  DoctoraliaDoctor,\n  DoctoraliaDoctorsResponse,\n  DoctoraliaFacilitiesResponse,\n  DoctoraliaFacility,\n  DoctoraliaSlot,\n  DoctoraliaSlotQuery,\n  DoctoraliaSlotsResponse,\n  DoctoraliaStatusResponse,\n  DoctoraliaSyncLog,\n  DoctoraliaSyncLogsResponse,\n} from \"./types\";\n\n// ============================================================\n// STATUS\n// ============================================================\n\nexport async function bookDoctoraliaSlot(\n  facilityId: string,\n  doctorId: string,\n  addressId: string,\n  slotStart: string,\n  payload: BookSlotPayload\n): Promise<DoctoraliaBooking> {\n  const response = await apiClient.post<{ booking: DoctoraliaBooking; status: \"ok\" }>(\n    `/api/doctoralia/facilities/${facilityId}/doctors/${doctorId}/addresses/${addressId}/slots/${encodeURIComponent(slotStart)}/book`,\n    { json: payload }\n  );\n\n  if (response.status !== \"ok\") {\n    throw new Error(\"No se pudo crear la reserva\");\n  }\n\n  return response.booking;\n}\n\n// ============================================================\n// FACILITIES\n// ============================================================\n\nexport async function cancelDoctoraliaBooking(\n  facilityId: string,\n  doctorId: string,\n  addressId: string,\n  bookingId: string,\n  reason?: string\n): Promise<void> {\n  const baseUrl = `/api/doctoralia/facilities/${facilityId}/doctors/${doctorId}/addresses/${addressId}/bookings/${bookingId}`;\n  const url = reason ? `${baseUrl}?reason=${encodeURIComponent(reason)}` : baseUrl;\n  await apiClient.delete(url);\n}\n\n// ============================================================\n// DOCTORS\n// ============================================================\n\nexport async function fetchDoctoraliaBookings(query: DoctoraliaBookingQuery): Promise<{\n  bookings: DoctoraliaBooking[];\n  pagination: { limit: number; page: number; pages: number; total: number };\n}> {\n  const { addressId, doctorId, end, facilityId, start } = query;\n  const response = await apiClient.get<DoctoraliaBookingsResponse>(\n    `/api/doctoralia/facilities/${facilityId}/doctors/${doctorId}/addresses/${addressId}/bookings`,\n    { query: { end, start } }\n  );\n\n  if (response.status !== \"ok\") {\n    throw new Error(\"No se pudo obtener las reservas\");\n  }\n\n  return {\n    bookings: response.bookings,\n    pagination: response.pagination,\n  };\n}\n\n// ============================================================\n// SLOTS\n// ============================================================\n\nexport async function fetchDoctoraliaDoctors(facilityId: number): Promise<DoctoraliaDoctor[]> {\n  const response = await apiClient.get<DoctoraliaDoctorsResponse>(`/api/doctoralia/facilities/${facilityId}/doctors`);\n\n  if (response.status !== \"ok\") {\n    throw new Error(\"No se pudo obtener los doctores\");\n  }\n\n  return response.doctors;\n}\n\n// ============================================================\n// BOOKINGS\n// ============================================================\n\nexport async function fetchDoctoraliaFacilities(): Promise<DoctoraliaFacility[]> {\n  const response = await apiClient.get<DoctoraliaFacilitiesResponse>(\"/api/doctoralia/facilities\");\n\n  if (response.status !== \"ok\") {\n    throw new Error(\"No se pudo obtener las instalaciones\");\n  }\n\n  return response.facilities;\n}\n\nexport async function fetchDoctoraliaSlots(query: DoctoraliaSlotQuery): Promise<DoctoraliaSlot[]> {\n  const { addressId, doctorId, end, facilityId, start } = query;\n  const response = await apiClient.get<DoctoraliaSlotsResponse>(\n    `/api/doctoralia/facilities/${facilityId}/doctors/${doctorId}/addresses/${addressId}/slots`,\n    { query: { end, start } }\n  );\n\n  if (response.status !== \"ok\") {\n    throw new Error(\"No se pudo obtener los slots disponibles\");\n  }\n\n  return response.slots;\n}\n\nexport async function fetchDoctoraliaStatus(): Promise<{\n  configured: boolean;\n  domain: string;\n}> {\n  const response = await apiClient.get<DoctoraliaStatusResponse>(\"/api/doctoralia/status\");\n\n  if (response.status !== \"ok\") {\n    throw new Error(\"No se pudo obtener el estado de Doctoralia\");\n  }\n\n  return {\n    configured: response.configured,\n    domain: response.domain,\n  };\n}\n\n// ============================================================\n// SYNC\n// ============================================================\n\nexport async function fetchDoctoraliaSyncLogs(): Promise<DoctoraliaSyncLog[]> {\n  const response = await apiClient.get<DoctoraliaSyncLogsResponse>(\"/api/doctoralia/sync/logs\");\n\n  if (response.status !== \"ok\") {\n    throw new Error(\"No se pudo obtener los logs de sincronización\");\n  }\n\n  return response.logs;\n}\n\nexport async function triggerDoctoraliaSync(): Promise<{ logId: number }> {\n  const response = await apiClient.post<{\n    logId: number;\n    message: string;\n    status: \"accepted\";\n  }>(\"/api/doctoralia/sync\", {});\n\n  if (response.status !== \"accepted\") {\n    throw new Error(\"No se pudo iniciar la sincronización\");\n  }\n\n  return { logId: response.logId };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/doctoralia/hooks/use-doctoralia.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/doctoralia/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/doctoralia/types.ts","messages":[{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"An interface declaring no members is equivalent to its supertype.","line":153,"column":18,"nodeType":"Identifier","messageId":"noEmptyInterfaceWithSuper","endLine":153,"endColumn":40,"suggestions":[{"messageId":"replaceEmptyInterfaceWithSuper","fix":{"range":[3329,3392],"text":"type DoctoraliaBookingQuery = DoctoraliaSlotQuery"},"desc":"Replace empty interface with a type alias."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Doctoralia Frontend Types\n *\n * TypeScript interfaces for Doctoralia data (camelCase for frontend).\n */\n\nimport { z } from \"zod\";\n\n// ============================================================\n// ENTITIES\n// ============================================================\n\nexport interface DoctoraliaAddress {\n  bookingCount: number;\n  cityName: null | string;\n  externalId: string;\n  id: number;\n  name: null | string;\n  onlineOnly: boolean;\n  serviceCount: number;\n  street: null | string;\n}\n\nexport interface DoctoraliaBooking {\n  bookedAt: string;\n  bookedBy: string;\n  canceledAt?: string;\n  canceledBy?: string;\n  comment?: string;\n  duration: number;\n  endAt: string;\n  id: string;\n  patient?: DoctoraliaPatient;\n  startAt: string;\n  status: \"booked\" | \"canceled\";\n}\n\nexport interface DoctoraliaBookingsResponse {\n  bookings: DoctoraliaBooking[];\n  pagination: {\n    limit: number;\n    page: number;\n    pages: number;\n    total: number;\n  };\n  status: \"ok\";\n}\n\nexport interface DoctoraliaDoctor {\n  addresses: DoctoraliaAddress[];\n  externalId: string;\n  fullName: string;\n  id: number;\n  name: string;\n  profileUrl?: string;\n  surname: string;\n}\n\nexport interface DoctoraliaDoctorsResponse {\n  doctors: DoctoraliaDoctor[];\n  status: \"ok\";\n}\n\nexport interface DoctoraliaFacilitiesResponse {\n  facilities: DoctoraliaFacility[];\n  status: \"ok\";\n}\n\nexport interface DoctoraliaFacility {\n  createdAt: string;\n  doctorCount: number;\n  externalId: string;\n  id: number;\n  name: string;\n  updatedAt: string;\n}\n\n// ============================================================\n// API RESPONSE TYPES\n// ============================================================\n\nexport interface DoctoraliaPatient {\n  birthDate?: string;\n  email: string;\n  gender?: \"f\" | \"m\";\n  name: string;\n  nin?: string;\n  phone: string;\n  surname: string;\n}\n\nexport interface DoctoraliaSlot {\n  end?: string;\n  services?: { id: string; name: string }[];\n  start: string;\n}\n\nexport interface DoctoraliaSlotsResponse {\n  slots: DoctoraliaSlot[];\n  status: \"ok\";\n}\n\nexport interface DoctoraliaStatusResponse {\n  configured: boolean;\n  domain: string;\n  status: \"ok\";\n}\n\nexport interface DoctoraliaSyncLog {\n  bookingsSynced: number;\n  doctorsSynced: number;\n  endedAt: null | string;\n  errorMessage: null | string;\n  facilitiesSynced: number;\n  id: number;\n  slotsSynced: number;\n  startedAt: string;\n  status: string;\n  triggerSource: null | string;\n  triggerUserId: null | number;\n}\n\nexport interface DoctoraliaSyncLogsResponse {\n  logs: DoctoraliaSyncLog[];\n  status: \"ok\";\n}\n\n// ============================================================\n// BOOKING PAYLOAD\n// ============================================================\n\nexport const bookSlotSchema = z.object({\n  comment: z.string().optional(),\n  duration: z.number().min(5).max(480),\n  patient: z.object({\n    birthDate: z.string().optional(),\n    email: z.email(),\n    gender: z.enum([\"m\", \"f\"]).optional(),\n    name: z.string().min(1),\n    nin: z.string().optional(),\n    phone: z.string().min(8),\n    surname: z.string().min(1),\n  }),\n  serviceId: z.string().optional(),\n});\n\nexport type BookSlotPayload = z.infer<typeof bookSlotSchema>;\n\n// ============================================================\n// QUERY PARAMS\n// ============================================================\n\nexport interface DoctoraliaBookingQuery extends DoctoraliaSlotQuery {}\n\nexport interface DoctoraliaSlotQuery {\n  addressId: string;\n  doctorId: string;\n  end: string;\n  facilityId: string;\n  start: string;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/expenses/api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/expenses/components/MonthlyExpenseDetail.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":17,"column":46,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":24,"endColumn":29,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[578,603],"text":"Readonly<MonthlyExpenseDetailProps>"},"desc":"Mark the props as read-only"}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":39,"column":31,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":39,"endColumn":33,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1210,1212],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":110,"column":21,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":110,"endColumn":96,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[4217,4266],"text":"Readonly<{ helper?: string; title: string; value: string }>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import dayjs from \"dayjs\";\n\nimport Alert from \"@/components/ui/Alert\";\nimport Button from \"@/components/ui/Button\";\n\nimport type { MonthlyExpenseDetail as MonthlyExpenseDetailData } from \"../types\";\n\ninterface MonthlyExpenseDetailProps {\n  canManage: boolean;\n  expense: MonthlyExpenseDetailData | null;\n  loading: boolean;\n  onEdit?: () => void;\n  onLinkTransaction: () => void;\n  onUnlinkTransaction: (transactionId: number) => void;\n}\n\nexport default function MonthlyExpenseDetail({\n  canManage,\n  expense,\n  loading,\n  onEdit,\n  onLinkTransaction,\n  onUnlinkTransaction,\n}: MonthlyExpenseDetailProps) {\n  if (loading) {\n    return <p className=\"text-base-content/60 text-xs\">Cargando gasto…</p>;\n  }\n\n  if (!expense) {\n    return <Alert variant=\"warning\">Selecciona un gasto para ver el detalle.</Alert>;\n  }\n\n  return (\n    <section className=\"border-base-300 text-base-content bg-base-100 space-y-4 border p-4 text-sm\">\n      <header className=\"flex flex-col gap-2 lg:flex-row lg:items-center lg:justify-between\">\n        <div>\n          <h2 className=\"text-primary text-xl font-semibold break-all\">{expense.name}</h2>\n          <p className=\"text-base-content/50 text-xs\">\n            {expense.category || \"Sin categoría\"} · {dayjs(expense.expenseDate).format(\"DD MMM YYYY\")}\n          </p>\n        </div>\n        {canManage && (\n          <div className=\"flex gap-2\">\n            {onEdit && (\n              <Button onClick={onEdit} size=\"sm\" variant=\"secondary\">\n                Editar\n              </Button>\n            )}\n            <Button onClick={onLinkTransaction} size=\"sm\">\n              Vincular transacción\n            </Button>\n          </div>\n        )}\n      </header>\n\n      <div className=\"grid gap-4 sm:grid-cols-2\">\n        <DetailCard title=\"Monto esperado\" value={`$${expense.amountExpected.toLocaleString(\"es-CL\")}`} />\n        <DetailCard title=\"Monto aplicado\" value={`$${expense.amountApplied.toLocaleString(\"es-CL\")}`} />\n        <DetailCard title=\"Estado\" value={expense.status === \"OPEN\" ? \"Pendiente\" : \"Cerrado\"} />\n        <DetailCard\n          helper=\"Registros conciliados\"\n          title=\"Transacciones asociadas\"\n          value={`${expense.transactionCount}`}\n        />\n      </div>\n\n      {expense.notes && <p className=\"bg-base-100/60 text-base-content/60 rounded-xl p-3 text-xs\">{expense.notes}</p>}\n\n      <section className=\"space-y-2\">\n        <h3 className=\"text-base-content/60 text-xs font-semibold tracking-wide uppercase\">Transacciones</h3>\n        <div className=\"muted-scrollbar max-h-72 space-y-2 overflow-y-auto pr-1\">\n          {expense.transactions.map((tx) => (\n            <article className=\"border-base-300 bg-base-200 rounded-xl border p-3 shadow-inner\" key={tx.transactionId}>\n              <div className=\"flex flex-wrap items-center justify-between gap-3\">\n                <div>\n                  <p className=\"text-base-content text-sm font-semibold\">ID #{tx.transactionId}</p>\n                  <p className=\"text-base-content/50 text-xs\">{tx.description ?? \"(sin descripción)\"}</p>\n                </div>\n                <span className=\"text-base-content text-sm font-semibold\">${tx.amount.toLocaleString(\"es-CL\")}</span>\n              </div>\n              <div className=\"text-base-content/50 mt-1 text-xs\">\n                {dayjs(tx.timestamp).format(\"DD MMM YYYY HH:mm\")} · {tx.direction}\n              </div>\n              {canManage && (\n                <div className=\"mt-2 flex justify-end\">\n                  <Button\n                    onClick={() => {\n                      onUnlinkTransaction(tx.transactionId);\n                    }}\n                    size=\"xs\"\n                    variant=\"secondary\"\n                  >\n                    Desvincular\n                  </Button>\n                </div>\n              )}\n            </article>\n          ))}\n          {expense.transactions.length === 0 && (\n            <p className=\"border-base-300 bg-base-200 text-base-content/60 rounded-xl border border-dashed p-3 text-xs\">\n              Aún no se han vinculado transacciones a este gasto.\n            </p>\n          )}\n        </div>\n      </section>\n    </section>\n  );\n}\n\nfunction DetailCard({ helper, title, value }: { helper?: string; title: string; value: string }) {\n  return (\n    <article className=\"border-base-300 bg-base-200 rounded-xl border p-3 shadow-sm\">\n      <p className=\"text-base-content/60 text-xs font-semibold tracking-wide uppercase\">{title}</p>\n      <p className=\"text-base-content mt-1 text-lg font-semibold\">{value}</p>\n      {helper && <p className=\"text-base-content/50 text-xs\">{helper}</p>}\n    </article>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/expenses/components/MonthlyExpenseList.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":14,"column":44,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":19,"endColumn":27,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[398,421],"text":"Readonly<MonthlyExpenseListProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import dayjs from \"dayjs\";\n\nimport Button from \"@/components/ui/Button\";\n\nimport type { MonthlyExpense } from \"../types\";\n\ninterface MonthlyExpenseListProps {\n  expenses: MonthlyExpense[];\n  onCreateRequest?: () => void;\n  onSelect: (publicId: string) => void;\n  selectedId: null | string;\n}\n\nexport default function MonthlyExpenseList({\n  expenses,\n  onCreateRequest,\n  onSelect,\n  selectedId,\n}: MonthlyExpenseListProps) {\n  return (\n    <div className=\"muted-scrollbar h-full overflow-y-auto pr-2\">\n      <div className=\"flex items-center justify-between pb-3\">\n        <div>\n          <h2 className=\"text-base-content/60 text-sm font-semibold tracking-wide uppercase\">Gastos</h2>\n          <p className=\"text-base-content/50 text-xs\">Registros de gastos mensuales y puntuales.</p>\n        </div>\n        {onCreateRequest && (\n          <Button onClick={onCreateRequest} size=\"sm\" type=\"button\" variant=\"secondary\">\n            Nuevo\n          </Button>\n        )}\n      </div>\n      <div className=\"space-y-3\">\n        {expenses.map((expense) => {\n          const isActive = expense.publicId === selectedId;\n          return (\n            <button\n              className={`w-full rounded-2xl border px-4 py-3 text-left transition-all ${\n                isActive\n                  ? \"border-primary/40 bg-primary/15 text-primary shadow\"\n                  : \"bg-base-100/55 text-base-content hover:border-base-300 hover:bg-base-200 border-transparent\"\n              }`}\n              key={expense.publicId}\n              onClick={() => {\n                onSelect(expense.publicId);\n              }}\n              type=\"button\"\n            >\n              <div className=\"flex items-center justify-between gap-3\">\n                <div>\n                  <p className=\"text-base-content text-sm font-semibold\">{expense.name}</p>\n                  {expense.category && (\n                    <p className=\"text-base-content/50 text-xs tracking-wide uppercase\">{expense.category}</p>\n                  )}\n                </div>\n                <span className=\"text-base-content text-sm font-semibold\">\n                  ${expense.amountExpected.toLocaleString(\"es-CL\")}\n                </span>\n              </div>\n              <div className=\"text-base-content/50 mt-2 flex flex-wrap items-center gap-3 text-xs\">\n                <span>{dayjs(expense.expenseDate).format(\"DD MMM YYYY\")}</span>\n                <span>{expense.transactionCount} transacciones</span>\n                <span>{expense.status === \"OPEN\" ? \"Pendiente\" : \"Cerrado\"}</span>\n              </div>\n            </button>\n          );\n        })}\n        {expenses.length === 0 && (\n          <p className=\"border-base-300 bg-base-200 text-base-content/60 rounded-2xl border border-dashed p-4 text-xs\">\n            Aún no registras gastos. Crea el primero para llevar control mensual.\n          </p>\n        )}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/expenses/components/MonthlyExpenseStats.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/expenses/hooks/use-monthly-expenses.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/expenses/queries.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/expenses/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/balances/api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/balances/components/BalanceSummary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/balances/components/DailyBalancesColumns.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Move your component(s) to a separate file.","line":25,"column":7,"nodeType":"Identifier","messageId":"localComponents","endLine":25,"endColumn":26},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":25,"column":82,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":85,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[820,823],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[820,823],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .options on an `any` value.","line":26,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":26,"endColumn":29},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Move your component(s) to a separate file.","line":45,"column":7,"nodeType":"Identifier","messageId":"localComponents","endLine":45,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":45,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1360,1363],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1360,1363],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .options on an `any` value.","line":46,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":46,"endColumn":29},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Move your component(s) to a separate file.","line":65,"column":7,"nodeType":"Identifier","messageId":"localComponents","endLine":65,"endColumn":18},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":65,"column":74,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":77,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1908,1911],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1908,1911],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .options on an `any` value.","line":66,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":66,"endColumn":29}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ColumnDef, Row } from \"@tanstack/react-table\";\nimport dayjs from \"dayjs\";\n\nimport Button from \"@/components/ui/Button\";\nimport Input from \"@/components/ui/Input\";\nimport { fmtCLP } from \"@/lib/format\";\n\nimport type { BalanceDraft, DailyBalanceDay } from \"../types\";\n\nimport { formatBalanceInput } from \"../utils\";\n\nexport interface BalanceTableMeta {\n  drafts: Record<string, BalanceDraft>;\n  onDraftChange: (date: string, patch: Partial<BalanceDraft>) => void;\n  onSave: (date: string) => void;\n  saving: Record<string, boolean>;\n}\n\nconst formatDifference = (diff: null | number) => {\n  if (diff == null) return \"—\";\n  return diff >= 0 ? fmtCLP(diff) : `-${fmtCLP(Math.abs(diff))}`;\n};\n\n// Custom Cell for the \"Registrado\" Input\nconst RecordedBalanceCell = ({ row, table }: { row: Row<DailyBalanceDay>; table: any }) => {\n  const meta = table.options.meta as BalanceTableMeta;\n  const day = row.original;\n  const draft = meta.drafts[day.date] ?? { note: \"\", value: \"\" };\n\n  return (\n    <Input\n      className=\"input-xs w-28\"\n      inputMode=\"decimal\"\n      onChange={(event) => {\n        meta.onDraftChange(day.date, { value: event.target.value });\n      }}\n      placeholder=\"0\"\n      type=\"text\"\n      value={draft.value}\n    />\n  );\n};\n\n// Custom Cell for the \"Nota\" Textarea\nconst NoteCell = ({ row, table }: { row: Row<DailyBalanceDay>; table: any }) => {\n  const meta = table.options.meta as BalanceTableMeta;\n  const day = row.original;\n  const draft = meta.drafts[day.date] ?? { note: \"\", value: \"\" };\n\n  return (\n    <Input\n      as=\"textarea\"\n      className=\"textarea-xs w-32 text-xs\"\n      onChange={(event) => {\n        meta.onDraftChange(day.date, { note: event.target.value });\n      }}\n      placeholder=\"Nota\"\n      rows={1}\n      value={draft.note}\n    />\n  );\n};\n\n// Custom Cell for Actions (Save Button)\nconst ActionsCell = ({ row, table }: { row: Row<DailyBalanceDay>; table: any }) => {\n  const meta = table.options.meta as BalanceTableMeta;\n  const day = row.original;\n  const draft = meta.drafts[day.date] ?? { note: \"\", value: \"\" };\n  const defaultValue = day.recordedBalance == null ? \"\" : formatBalanceInput(day.recordedBalance);\n  const defaultNote = day.note ?? \"\";\n  const isSaving = Boolean(meta.saving[day.date]);\n  const isDirty = draft.value !== defaultValue || draft.note !== defaultNote;\n  const hasValue = draft.value.trim().length > 0 || defaultValue.trim().length > 0;\n  const canSave = isDirty && hasValue && !isSaving;\n\n  return (\n    <Button\n      disabled={!canSave}\n      onClick={() => {\n        meta.onSave(day.date);\n      }}\n      size=\"xs\"\n      type=\"button\"\n    >\n      {isSaving ? \"...\" : \"💾\"}\n    </Button>\n  );\n};\n\nexport const columns: ColumnDef<DailyBalanceDay>[] = [\n  {\n    accessorKey: \"date\",\n    cell: ({ row }) => (\n      <div className=\"flex flex-col gap-0.5\">\n        <span>{dayjs(row.original.date).format(\"DD/MM/YY\")}</span>\n        {row.original.hasCashback && <span className=\"badge badge-warning badge-xs\">CB</span>}\n      </div>\n    ),\n    header: \"Fecha\",\n  },\n  {\n    accessorKey: \"totalIn\",\n    cell: ({ row }) => <div className=\"text-success text-right text-xs\">{fmtCLP(Math.abs(row.original.totalIn))}</div>,\n    header: () => <div className=\"text-right\">Ingresos</div>,\n  },\n  {\n    accessorKey: \"totalOut\",\n    cell: ({ row }) => <div className=\"text-error text-right text-xs\">-{fmtCLP(Math.abs(row.original.totalOut))}</div>,\n    header: () => <div className=\"text-right\">Egresos</div>,\n  },\n  {\n    accessorKey: \"netChange\",\n    cell: ({ row }) => {\n      const val = row.original.netChange;\n      return (\n        <div className={`text-right text-xs font-semibold ${val >= 0 ? \"text-success\" : \"text-error\"}`}>\n          {val >= 0 ? fmtCLP(val) : `-${fmtCLP(Math.abs(val))}`}\n        </div>\n      );\n    },\n    header: () => <div className=\"text-right\">Neto</div>,\n  },\n  {\n    accessorKey: \"expectedBalance\",\n    cell: ({ row }) => (\n      <div className=\"text-right text-xs\">\n        {row.original.expectedBalance == null ? \"—\" : fmtCLP(row.original.expectedBalance)}\n      </div>\n    ),\n    header: () => <div className=\"text-right\">Esperado</div>,\n  },\n  {\n    cell: RecordedBalanceCell,\n    header: \"Registrado\",\n    id: \"recordedBalance\",\n  },\n  {\n    accessorKey: \"difference\",\n    cell: ({ row }) => {\n      const mismatch = row.original.difference != null && Math.abs(row.original.difference) > 1;\n      return (\n        <div className={`text-right text-xs font-semibold ${mismatch ? \"text-error\" : \"\"}`}>\n          {formatDifference(row.original.difference)}\n        </div>\n      );\n    },\n    header: () => <div className=\"text-right\">Dif.</div>,\n  },\n  {\n    cell: NoteCell,\n    header: \"Nota\",\n    id: \"note\",\n  },\n  {\n    cell: ActionsCell,\n    header: \"\",\n    id: \"actions\",\n  },\n];\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/balances/components/DailyBalancesPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/balances/hooks/use-daily-balance-management.ts","messages":[{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":27,"column":24,"nodeType":"MemberExpression","endLine":27,"endColumn":34},{"ruleId":"security/detect-object-injection","severity":1,"message":"Variable Assigned to Object Injection Sink","line":40,"column":19,"nodeType":"MemberExpression","endLine":40,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\n\nimport { useAuth } from \"@/context/AuthContext\";\nimport { useToast } from \"@/context/ToastContext\";\nimport { logger } from \"@/lib/logger\";\n\nimport type { BalanceDraft } from \"../types\";\n\nimport { saveBalance } from \"../api\";\nimport { parseBalanceInput } from \"../utils\";\n\ninterface UseDailyBalanceManagementProps {\n  loadBalances: () => Promise<void>;\n}\n\nexport function useDailyBalanceManagement({ loadBalances }: UseDailyBalanceManagementProps) {\n  const { can } = useAuth();\n  const { error: showError } = useToast();\n  const canEdit = can(\"update\", \"Transaction\");\n\n  const [drafts, setDrafts] = useState<Record<string, BalanceDraft>>({});\n  const [saving, setSaving] = useState<Record<string, boolean>>({});\n  const [error, setError] = useState<null | string>(null);\n\n  const handleDraftChange = (date: string, patch: Partial<BalanceDraft>) => {\n    setDrafts((prev) => {\n      const previous = prev[date] ?? { note: \"\", value: \"\" };\n      return {\n        ...prev,\n        [date]: {\n          note: patch.note ?? previous.note,\n          value: patch.value ?? previous.value,\n        },\n      };\n    });\n  };\n\n  const handleSave = async (date: string) => {\n    if (!canEdit) return;\n    const draft = drafts[date];\n    if (!draft) return;\n\n    const parsedValue = parseBalanceInput(draft.value);\n    if (parsedValue == null) {\n      setError(\"Ingresa un saldo válido antes de guardar\");\n      return;\n    }\n\n    setSaving((prev) => ({ ...prev, [date]: true }));\n    setError(null);\n    try {\n      await saveBalance(date, parsedValue, draft.note);\n      await loadBalances();\n      logger.info(\"[balances] save:success\", { balance: parsedValue, date });\n    } catch (error_) {\n      const message = error_ instanceof Error ? error_.message : \"No se pudo guardar el saldo diario\";\n      setError(message);\n      showError(message);\n      logger.error(\"[balances] save:error\", message);\n    } finally {\n      setSaving((prev) => ({ ...prev, [date]: false }));\n    }\n  };\n\n  return { drafts, error, handleDraftChange, handleSave, saving, setDrafts, setError };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/balances/hooks/use-quick-date-range.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/balances/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/balances/pages/DailyBalancesPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/balances/queries.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/balances/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/balances/utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/constants.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/loans/api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/loans/components/LoanDetail.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":30,"column":28,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":39,"endColumn":19,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[1002,1017],"text":"Readonly<LoanDetailProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import dayjs from \"dayjs\";\nimport type { ChangeEvent } from \"react\";\nimport { useState } from \"react\";\n\nimport Button from \"@/components/ui/Button\";\nimport Input from \"@/components/ui/Input\";\nimport Modal from \"@/components/ui/Modal\";\n\nimport type { LoanSchedule, LoanSummary, RegenerateSchedulePayload } from \"../types\";\n\nimport LoanScheduleTable from \"./LoanScheduleTable\";\n\ninterface LoanDetailProps {\n  canManage: boolean;\n  loading: boolean;\n  loan: LoanSummary | null;\n  onRegenerate: (payload: RegenerateSchedulePayload) => Promise<void>;\n  onRegisterPayment: (schedule: LoanSchedule) => void;\n  onUnlinkPayment: (schedule: LoanSchedule) => void;\n  schedules: LoanSchedule[];\n  summary: null | {\n    paid_installments: number;\n    pending_installments: number;\n    remaining_amount: number;\n    total_expected: number;\n    total_paid: number;\n  };\n}\n\nexport function LoanDetail({\n  canManage,\n  loading,\n  loan,\n  onRegenerate,\n  onRegisterPayment,\n  onUnlinkPayment,\n  schedules,\n  summary,\n}: LoanDetailProps) {\n  const [regenerateOpen, setRegenerateOpen] = useState(false);\n  const [regenerateForm, setRegenerateForm] = useState<RegenerateSchedulePayload>({});\n  const [regenerating, setRegenerating] = useState(false);\n  const [regenerateError, setRegenerateError] = useState<null | string>(null);\n\n  const statusBadge = (() => {\n    if (!loan) return { className: \"\", label: \"\" };\n    switch (loan.status) {\n      case \"COMPLETED\": {\n        return { className: \"bg-emerald-100 text-emerald-700\", label: \"Liquidado\" };\n      }\n      case \"DEFAULTED\": {\n        return { className: \"bg-rose-100 text-rose-700\", label: \"En mora\" };\n      }\n      default: {\n        return { className: \"bg-amber-100 text-amber-700\", label: \"Activo\" };\n      }\n    }\n  })();\n\n  const handleRegenerate = async (event: React.FormEvent<HTMLFormElement>) => {\n    event.preventDefault();\n    if (!loan) return;\n    setRegenerating(true);\n    setRegenerateError(null);\n    try {\n      await onRegenerate(regenerateForm);\n      setRegenerateOpen(false);\n      setRegenerateForm({});\n    } catch (error) {\n      const message = error instanceof Error ? error.message : \"No se pudo regenerar el cronograma\";\n      setRegenerateError(message);\n    } finally {\n      setRegenerating(false);\n    }\n  };\n\n  if (!loan) {\n    return (\n      <section className=\"text-base-content/60 bg-base-100 flex h-full flex-col items-center justify-center rounded-3xl p-10 text-sm\">\n        <p>Selecciona un préstamo para ver el detalle.</p>\n      </section>\n    );\n  }\n\n  return (\n    <section className=\"bg-base-100 relative flex h-full flex-col gap-6 rounded-3xl p-6\">\n      <header className=\"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between\">\n        <div className=\"space-y-1\">\n          <h1 className=\"text-primary text-2xl font-bold drop-shadow-sm\">{loan.title}</h1>\n          <p className=\"text-base-content/90 text-sm\">\n            {loan.borrower_name} · {loan.borrower_type === \"PERSON\" ? \"Persona natural\" : \"Empresa\"}\n          </p>\n          <div className=\"text-base-content/60 flex flex-wrap items-center gap-3 text-xs\">\n            <span>Inicio {dayjs(loan.start_date).format(\"DD MMM YYYY\")}</span>\n            <span>\n              {loan.total_installments} cuotas ·{\" \"}\n              {\n                {\n                  BIWEEKLY: \"quincenal\",\n                  MONTHLY: \"mensual\",\n                  WEEKLY: \"semanal\",\n                }[loan.frequency]\n              }\n            </span>\n            <span>Tasa {loan.interest_rate.toLocaleString(\"es-CL\")}%</span>\n          </div>\n        </div>\n        <div className=\"flex items-center gap-3\">\n          <span\n            className={`rounded-full px-3 py-1 text-xs font-semibold tracking-wide uppercase ${statusBadge.className}`}\n          >\n            {statusBadge.label}\n          </span>\n          {canManage && (\n            <Button\n              onClick={() => {\n                setRegenerateOpen(true);\n              }}\n              type=\"button\"\n              variant=\"secondary\"\n            >\n              Regenerar cronograma\n            </Button>\n          )}\n        </div>\n      </header>\n\n      <section className=\"border-base-300 bg-base-200 text-base-content grid gap-4 rounded-2xl border p-4 text-sm sm:grid-cols-4\">\n        <div>\n          <p className=\"text-base-content/50 text-xs tracking-wide uppercase\">Capital</p>\n          <p className=\"text-base-content text-lg font-semibold\">${loan.principal_amount.toLocaleString(\"es-CL\")}</p>\n        </div>\n        <div>\n          <p className=\"text-base-content/50 text-xs tracking-wide uppercase\">Total esperado</p>\n          <p className=\"text-base-content text-lg font-semibold\">\n            ${(summary?.total_expected ?? 0).toLocaleString(\"es-CL\")}\n          </p>\n        </div>\n        <div>\n          <p className=\"text-base-content/50 text-xs tracking-wide uppercase\">Pagado</p>\n          <p className=\"text-success text-lg font-semibold\">${(summary?.total_paid ?? 0).toLocaleString(\"es-CL\")}</p>\n        </div>\n        <div>\n          <p className=\"text-base-content/50 text-xs tracking-wide uppercase\">Saldo</p>\n          <p className=\"text-error text-lg font-semibold\">\n            ${(summary?.remaining_amount ?? 0).toLocaleString(\"es-CL\")}\n          </p>\n        </div>\n      </section>\n\n      <LoanScheduleTable\n        canManage={canManage}\n        onRegisterPayment={onRegisterPayment}\n        onUnlinkPayment={onUnlinkPayment}\n        schedules={schedules}\n      />\n\n      {loan.notes && (\n        <div className=\"border-base-300 bg-base-200 text-base-content rounded-2xl border p-4 text-sm\">\n          <p className=\"text-base-content/50 text-xs tracking-wide uppercase\">Notas</p>\n          <p>{loan.notes}</p>\n        </div>\n      )}\n\n      <Modal\n        isOpen={regenerateOpen}\n        onClose={() => {\n          setRegenerateOpen(false);\n        }}\n        title=\"Regenerar cronograma\"\n      >\n        <form className=\"space-y-4\" onSubmit={handleRegenerate}>\n          <Input\n            label=\"Nuevo total de cuotas\"\n            max={360}\n            min={1}\n            onChange={(event: ChangeEvent<HTMLInputElement>) => {\n              setRegenerateForm((prev) => ({ ...prev, totalInstallments: Number(event.target.value) }));\n            }}\n            type=\"number\"\n            value={regenerateForm.totalInstallments ?? loan.total_installments}\n          />\n          <Input\n            label=\"Nueva fecha de inicio\"\n            onChange={(event: ChangeEvent<HTMLInputElement>) => {\n              setRegenerateForm((prev) => ({ ...prev, startDate: event.target.value }));\n            }}\n            type=\"date\"\n            value={regenerateForm.startDate ?? loan.start_date}\n          />\n          <Input\n            label=\"Tasa de interés (%)\"\n            min={0}\n            onChange={(event: ChangeEvent<HTMLInputElement>) => {\n              setRegenerateForm((prev) => ({ ...prev, interestRate: Number(event.target.value) }));\n            }}\n            step=\"0.01\"\n            type=\"number\"\n            value={regenerateForm.interestRate ?? loan.interest_rate}\n          />\n          <Input\n            as=\"select\"\n            label=\"Frecuencia\"\n            onChange={(event: ChangeEvent<HTMLSelectElement>) => {\n              setRegenerateForm((prev) => ({\n                ...prev,\n                frequency: event.target.value as RegenerateSchedulePayload[\"frequency\"],\n              }));\n            }}\n            value={regenerateForm.frequency ?? loan.frequency}\n          >\n            <option value=\"WEEKLY\">Semanal</option>\n            <option value=\"BIWEEKLY\">Quincenal</option>\n            <option value=\"MONTHLY\">Mensual</option>\n          </Input>\n          {regenerateError && (\n            <p className=\"rounded-lg bg-rose-100 px-4 py-2 text-sm text-rose-700\">{regenerateError}</p>\n          )}\n          <div className=\"flex justify-end gap-3\">\n            <Button\n              disabled={regenerating}\n              onClick={() => {\n                setRegenerateOpen(false);\n              }}\n              type=\"button\"\n              variant=\"secondary\"\n            >\n              Cancelar\n            </Button>\n            <Button disabled={regenerating} type=\"submit\">\n              {regenerating ? \"Actualizando...\" : \"Regenerar\"}\n            </Button>\n          </div>\n        </form>\n      </Modal>\n\n      {loading && (\n        <div className=\"bg-base-100/40 absolute inset-0 z-30 flex items-center justify-center backdrop-blur-sm\">\n          <p className=\"bg-base-100 text-primary rounded-full px-4 py-2 text-sm font-semibold shadow\">\n            Cargando préstamo...\n          </p>\n        </div>\n      )}\n    </section>\n  );\n}\n\nexport default LoanDetail;\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/loans/components/LoanDetailSection.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":16,"column":43,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":22,"endColumn":26,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[675,697],"text":"Readonly<LoanDetailSectionProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useSuspenseQuery } from \"@tanstack/react-query\";\n\nimport type { LoanSchedule, RegenerateSchedulePayload } from \"@/features/finance/loans/types\";\n\nimport LoanDetail from \"@/features/finance/loans/components/LoanDetail\";\nimport { loanKeys } from \"@/features/finance/loans/queries\";\n\ninterface LoanDetailSectionProps {\n  canManage: boolean;\n  loanId: string;\n  onRegenerate: (overrides: RegenerateSchedulePayload) => Promise<void>;\n  onRegisterPayment: (schedule: LoanSchedule) => void;\n  onUnlinkPayment: (schedule: LoanSchedule) => void;\n}\n\nexport default function LoanDetailSection({\n  canManage,\n  loanId,\n  onRegenerate,\n  onRegisterPayment,\n  onUnlinkPayment,\n}: LoanDetailSectionProps) {\n  const { data } = useSuspenseQuery(loanKeys.detail(loanId));\n  const { loan, schedules, summary } = data;\n\n  return (\n    <LoanDetail\n      canManage={canManage}\n      loading={false}\n      loan={loan}\n      onRegenerate={onRegenerate}\n      onRegisterPayment={onRegisterPayment}\n      onUnlinkPayment={onUnlinkPayment}\n      schedules={schedules}\n      summary={summary}\n    />\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/loans/components/LoanForm.tsx","messages":[{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"Using `join()` for field.state.meta.errors may use Object's default stringification format ('[object Object]') when stringified.","line":86,"column":57,"nodeType":"MemberExpression","messageId":"baseArrayJoin","endLine":86,"endColumn":80},{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"Using `join()` for field.state.meta.errors may use Object's default stringification format ('[object Object]') when stringified.","line":105,"column":57,"nodeType":"MemberExpression","messageId":"baseArrayJoin","endLine":105,"endColumn":80},{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"Using `join()` for field.state.meta.errors may use Object's default stringification format ('[object Object]') when stringified.","line":127,"column":57,"nodeType":"MemberExpression","messageId":"baseArrayJoin","endLine":127,"endColumn":80},{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"Using `join()` for field.state.meta.errors may use Object's default stringification format ('[object Object]') when stringified.","line":149,"column":57,"nodeType":"MemberExpression","messageId":"baseArrayJoin","endLine":149,"endColumn":80},{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"Using `join()` for field.state.meta.errors may use Object's default stringification format ('[object Object]') when stringified.","line":171,"column":57,"nodeType":"MemberExpression","messageId":"baseArrayJoin","endLine":171,"endColumn":80},{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"Using `join()` for field.state.meta.errors may use Object's default stringification format ('[object Object]') when stringified.","line":193,"column":57,"nodeType":"MemberExpression","messageId":"baseArrayJoin","endLine":193,"endColumn":80},{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"Using `join()` for field.state.meta.errors may use Object's default stringification format ('[object Object]') when stringified.","line":216,"column":57,"nodeType":"MemberExpression","messageId":"baseArrayJoin","endLine":216,"endColumn":80},{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"Using `join()` for field.state.meta.errors may use Object's default stringification format ('[object Object]') when stringified.","line":238,"column":57,"nodeType":"MemberExpression","messageId":"baseArrayJoin","endLine":238,"endColumn":80},{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"Using `join()` for field.state.meta.errors may use Object's default stringification format ('[object Object]') when stringified.","line":258,"column":57,"nodeType":"MemberExpression","messageId":"baseArrayJoin","endLine":258,"endColumn":80},{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"Using `join()` for field.state.meta.errors may use Object's default stringification format ('[object Object]') when stringified.","line":275,"column":57,"nodeType":"MemberExpression","messageId":"baseArrayJoin","endLine":275,"endColumn":80},{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"Using `join()` for field.state.meta.errors may use Object's default stringification format ('[object Object]') when stringified.","line":296,"column":55,"nodeType":"MemberExpression","messageId":"baseArrayJoin","endLine":296,"endColumn":78}],"suppressedMessages":[],"errorCount":11,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useForm, useStore } from \"@tanstack/react-form\";\nimport { z } from \"zod\";\n\nimport Alert from \"@/components/ui/Alert\";\nimport Button from \"@/components/ui/Button\";\nimport Checkbox from \"@/components/ui/Checkbox\";\nimport Input from \"@/components/ui/Input\";\nimport { today } from \"@/lib/dates\";\nimport { GRID_2_COL_MD } from \"@/lib/styles\";\n\nimport type { CreateLoanPayload } from \"../types\";\n\nconst loanFormSchema = z.object({\n  borrowerName: z.string().trim().min(1, \"El beneficiario es requerido\"),\n  borrowerType: z.enum([\"PERSON\", \"COMPANY\"]),\n  frequency: z.enum([\"WEEKLY\", \"BIWEEKLY\", \"MONTHLY\"]),\n  generateSchedule: z.boolean(),\n  interestRate: z\n    .number()\n    .min(0, \"La tasa de interés debe ser mayor o igual a 0\")\n    .max(100, \"La tasa no puede ser mayor a 100%\"),\n  interestType: z.enum([\"SIMPLE\", \"COMPOUND\"]),\n  notes: z.string().optional(),\n  principalAmount: z.number().positive(\"El monto principal debe ser mayor a 0\"),\n  startDate: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/, \"Fecha inválida\"),\n  title: z.string().trim().min(1, \"El título es requerido\"),\n  totalInstallments: z.number().int().min(1, \"Debe tener al menos 1 cuota\"),\n});\n\ntype LoanFormData = z.infer<typeof loanFormSchema>;\n\ninterface LoanFormProps {\n  readonly onCancel: () => void;\n  readonly onSubmit: (payload: CreateLoanPayload) => Promise<void>;\n}\n\nexport function LoanForm({ onCancel, onSubmit }: LoanFormProps) {\n  const form = useForm({\n    defaultValues: {\n      borrowerName: \"\",\n      borrowerType: \"PERSON\" as const,\n      frequency: \"WEEKLY\" as const,\n      generateSchedule: true,\n      interestRate: 0,\n      interestType: \"SIMPLE\" as const,\n      notes: \"\",\n      principalAmount: 0,\n      startDate: today(),\n      title: \"\",\n      totalInstallments: 10,\n    } as LoanFormData,\n    onSubmit: async ({ value }) => {\n      await onSubmit(value as CreateLoanPayload);\n    },\n    validators: {\n      onBlur: loanFormSchema,\n    },\n  });\n\n  const hasErrors = useStore(form.store, (state) =>\n    Object.values(state.fieldMeta).some((meta) => meta.errors.length > 0)\n  );\n\n  return (\n    <form\n      className=\"space-y-4\"\n      onSubmit={(e) => {\n        e.preventDefault();\n        void form.handleSubmit();\n      }}\n    >\n      <div className={GRID_2_COL_MD}>\n        <form.Field name=\"title\">\n          {(field) => (\n            <div>\n              <Input\n                label=\"Título\"\n                onBlur={field.handleBlur}\n                onChange={(e) => {\n                  field.handleChange(e.target.value);\n                }}\n                required\n                value={field.state.value}\n              />\n              {field.state.meta.errors.length > 0 && (\n                <p className=\"text-error mt-1 text-xs\">{field.state.meta.errors.join(\", \")}</p>\n              )}\n            </div>\n          )}\n        </form.Field>\n\n        <form.Field name=\"borrowerName\">\n          {(field) => (\n            <div>\n              <Input\n                label=\"Beneficiario\"\n                onBlur={field.handleBlur}\n                onChange={(e) => {\n                  field.handleChange(e.target.value);\n                }}\n                required\n                value={field.state.value}\n              />\n              {field.state.meta.errors.length > 0 && (\n                <p className=\"text-error mt-1 text-xs\">{field.state.meta.errors.join(\", \")}</p>\n              )}\n            </div>\n          )}\n        </form.Field>\n\n        <form.Field name=\"borrowerType\">\n          {(field) => (\n            <div>\n              <Input\n                as=\"select\"\n                label=\"Tipo\"\n                onBlur={field.handleBlur}\n                onChange={(e) => {\n                  field.handleChange(e.target.value as \"COMPANY\" | \"PERSON\");\n                }}\n                value={field.state.value}\n              >\n                <option value=\"PERSON\">Persona natural</option>\n                <option value=\"COMPANY\">Empresa</option>\n              </Input>\n              {field.state.meta.errors.length > 0 && (\n                <p className=\"text-error mt-1 text-xs\">{field.state.meta.errors.join(\", \")}</p>\n              )}\n            </div>\n          )}\n        </form.Field>\n\n        <form.Field name=\"principalAmount\">\n          {(field) => (\n            <div>\n              <Input\n                label=\"Monto Principal\"\n                min={0}\n                onBlur={field.handleBlur}\n                onChange={(e) => {\n                  field.handleChange(Number.parseFloat(e.target.value) || 0);\n                }}\n                required\n                step=\"0.01\"\n                type=\"number\"\n                value={field.state.value}\n              />\n              {field.state.meta.errors.length > 0 && (\n                <p className=\"text-error mt-1 text-xs\">{field.state.meta.errors.join(\", \")}</p>\n              )}\n            </div>\n          )}\n        </form.Field>\n\n        <form.Field name=\"interestRate\">\n          {(field) => (\n            <div>\n              <Input\n                label=\"Tasa de Interés Anual (%)\"\n                min={0}\n                onBlur={field.handleBlur}\n                onChange={(e) => {\n                  field.handleChange(Number.parseFloat(e.target.value) || 0);\n                }}\n                required\n                step=\"0.01\"\n                type=\"number\"\n                value={field.state.value}\n              />\n              {field.state.meta.errors.length > 0 && (\n                <p className=\"text-error mt-1 text-xs\">{field.state.meta.errors.join(\", \")}</p>\n              )}\n            </div>\n          )}\n        </form.Field>\n\n        <form.Field name=\"interestType\">\n          {(field) => (\n            <div>\n              <Input\n                as=\"select\"\n                label=\"Tipo interés\"\n                onBlur={field.handleBlur}\n                onChange={(e) => {\n                  field.handleChange(e.target.value as \"COMPOUND\" | \"SIMPLE\");\n                }}\n                value={field.state.value}\n              >\n                <option value=\"SIMPLE\">Simple</option>\n                <option value=\"COMPOUND\">Compuesto</option>\n              </Input>\n              {field.state.meta.errors.length > 0 && (\n                <p className=\"text-error mt-1 text-xs\">{field.state.meta.errors.join(\", \")}</p>\n              )}\n            </div>\n          )}\n        </form.Field>\n\n        <form.Field name=\"frequency\">\n          {(field) => (\n            <div>\n              <Input\n                as=\"select\"\n                label=\"Frecuencia de Pago\"\n                onBlur={field.handleBlur}\n                onChange={(e) => {\n                  field.handleChange(e.target.value as \"BIWEEKLY\" | \"MONTHLY\" | \"WEEKLY\");\n                }}\n                value={field.state.value}\n              >\n                <option value=\"WEEKLY\">Semanal</option>\n                <option value=\"BIWEEKLY\">Quincenal</option>\n                <option value=\"MONTHLY\">Mensual</option>\n              </Input>\n              {field.state.meta.errors.length > 0 && (\n                <p className=\"text-error mt-1 text-xs\">{field.state.meta.errors.join(\", \")}</p>\n              )}\n            </div>\n          )}\n        </form.Field>\n\n        <form.Field name=\"totalInstallments\">\n          {(field) => (\n            <div>\n              <Input\n                label=\"Número de Términos\"\n                max={360}\n                min={1}\n                onBlur={field.handleBlur}\n                onChange={(e) => {\n                  field.handleChange(Number.parseInt(e.target.value, 10) || 1);\n                }}\n                required\n                type=\"number\"\n                value={field.state.value}\n              />\n              {field.state.meta.errors.length > 0 && (\n                <p className=\"text-error mt-1 text-xs\">{field.state.meta.errors.join(\", \")}</p>\n              )}\n            </div>\n          )}\n        </form.Field>\n\n        <form.Field name=\"startDate\">\n          {(field) => (\n            <div>\n              <Input\n                label=\"Fecha de Inicio\"\n                onBlur={field.handleBlur}\n                onChange={(e) => {\n                  field.handleChange(e.target.value);\n                }}\n                required\n                type=\"date\"\n                value={field.state.value}\n              />\n              {field.state.meta.errors.length > 0 && (\n                <p className=\"text-error mt-1 text-xs\">{field.state.meta.errors.join(\", \")}</p>\n              )}\n            </div>\n          )}\n        </form.Field>\n\n        <form.Field name=\"generateSchedule\">\n          {(field) => (\n            <div>\n              <Checkbox\n                checked={field.state.value}\n                label=\"Generar cronograma automáticamente\"\n                onChange={(e) => {\n                  field.handleChange(e.target.checked);\n                }}\n              />\n              {field.state.meta.errors.length > 0 && (\n                <p className=\"text-error mt-1 text-xs\">{field.state.meta.errors.join(\", \")}</p>\n              )}\n            </div>\n          )}\n        </form.Field>\n      </div>\n\n      <form.Field name=\"notes\">\n        {(field) => (\n          <div>\n            <Input\n              as=\"textarea\"\n              label=\"Descripción\"\n              onBlur={field.handleBlur}\n              onChange={(e) => {\n                field.handleChange(e.target.value);\n              }}\n              rows={3}\n              value={field.state.value ?? \"\"}\n            />\n            {field.state.meta.errors.length > 0 && (\n              <p className=\"text-error mt-1 text-xs\">{field.state.meta.errors.join(\", \")}</p>\n            )}\n          </div>\n        )}\n      </form.Field>\n\n      {hasErrors && <Alert variant=\"error\">Por favor corrige los errores en el formulario antes de continuar.</Alert>}\n\n      <div className=\"flex justify-end gap-3\">\n        <Button disabled={form.state.isSubmitting} onClick={onCancel} type=\"button\" variant=\"secondary\">\n          Cancelar\n        </Button>\n        <Button disabled={form.state.isSubmitting || !form.state.canSubmit} type=\"submit\">\n          {form.state.isSubmitting ? \"Creando...\" : \"Crear préstamo\"}\n        </Button>\n      </div>\n    </form>\n  );\n}\n\nexport default LoanForm;\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/loans/components/LoanList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/loans/components/LoanScheduleColumns.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/loans/components/LoanScheduleTable.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":16,"column":43,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":21,"endColumn":26,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[497,519],"text":"Readonly<LoanScheduleTableProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Imports cleaned up\n\nimport { DataTable } from \"@/components/data-table/DataTable\";\n\nimport type { LoanSchedule } from \"../types\";\n\nimport { getColumns } from \"./LoanScheduleColumns\";\n\ninterface LoanScheduleTableProps {\n  canManage: boolean;\n  onRegisterPayment: (schedule: LoanSchedule) => void;\n  onUnlinkPayment: (schedule: LoanSchedule) => void;\n  schedules: LoanSchedule[];\n}\n\nexport default function LoanScheduleTable({\n  canManage,\n  onRegisterPayment,\n  onUnlinkPayment,\n  schedules,\n}: LoanScheduleTableProps) {\n  const actions = {\n    onRegisterPayment,\n    onUnlinkPayment,\n  };\n\n  const columns = getColumns(actions, canManage);\n\n  return (\n    <div className=\"border-base-300 bg-base-100 overflow-hidden rounded-2xl border shadow-sm\">\n      <DataTable\n        columns={columns}\n        data={schedules}\n        enableToolbar={false}\n        noDataMessage=\"No hay cronograma disponible.\"\n        pagination={{ pageIndex: 0, pageSize: 100 }}\n      />\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/loans/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/loans/pages/LoansPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/loans/queries.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/loans/types.ts","messages":[{"ruleId":"sonarjs/use-type-alias","severity":2,"message":"Replace this union type with a type alias.","line":4,"column":14,"nodeType":null,"endLine":4,"endColumn":47}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export interface CreateLoanPayload {\n  borrowerName: string;\n  borrowerType: \"COMPANY\" | \"PERSON\";\n  frequency: \"BIWEEKLY\" | \"MONTHLY\" | \"WEEKLY\";\n  generateSchedule?: boolean;\n  interestRate: number;\n  interestType: \"COMPOUND\" | \"SIMPLE\";\n  notes?: null | string;\n  principalAmount: number;\n  startDate: string;\n  title: string;\n  totalInstallments: number;\n}\n\nexport interface LoanDetailResponse {\n  loan: LoanSummary;\n  schedules: LoanSchedule[];\n  status: \"error\" | \"ok\";\n  summary: {\n    paid_installments: number;\n    pending_installments: number;\n    remaining_amount: number;\n    total_expected: number;\n    total_paid: number;\n  };\n}\n\nexport interface LoanListResponse {\n  loans: LoanSummary[];\n  status: \"error\" | \"ok\";\n}\n\nexport interface LoanPaymentPayload {\n  paidAmount: number;\n  paidDate: string;\n  transactionId: number;\n}\n\nexport interface LoanSchedule {\n  created_at: string;\n  due_date: string;\n  expected_amount: number;\n  expected_interest: number;\n  expected_principal: number;\n  id: number;\n  installment_number: number;\n  loan_id: number;\n  paid_amount: null | number;\n  paid_date: null | string;\n  status: \"OVERDUE\" | \"PAID\" | \"PARTIAL\" | \"PENDING\";\n  transaction?: null | {\n    amount: null | number;\n    description: null | string;\n    id: number;\n    timestamp: string;\n  };\n  transaction_id: null | number;\n  updated_at: string;\n}\n\nexport interface LoanSummary {\n  borrower_name: string;\n  borrower_type: \"COMPANY\" | \"PERSON\";\n  created_at: string;\n  frequency: \"BIWEEKLY\" | \"MONTHLY\" | \"WEEKLY\";\n  id: number;\n  interest_rate: number;\n  interest_type: \"COMPOUND\" | \"SIMPLE\";\n  notes: null | string;\n  paid_installments: number;\n  pending_installments: number;\n  principal_amount: number;\n  public_id: string;\n  remaining_amount: number;\n  start_date: string;\n  status: \"ACTIVE\" | \"COMPLETED\" | \"DEFAULTED\";\n  title: string;\n  total_expected: number;\n  total_installments: number;\n  total_paid: number;\n  updated_at: string;\n}\n\nexport interface RegenerateSchedulePayload {\n  frequency?: \"BIWEEKLY\" | \"MONTHLY\" | \"WEEKLY\";\n  interestRate?: number;\n  startDate?: string;\n  totalInstallments?: number;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/mercadopago/components/MpReportColumns.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/mercadopago/components/ReleaseColumns.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/mercadopago/components/SettlementColumns.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":9,"column":74,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":9,"endColumn":77,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[350,353],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[350,353],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { SettlementTransaction } from \"@finanzas/db/models\";\nimport { type ColumnDef, createColumnHelper } from \"@tanstack/react-table\";\nimport dayjs from \"dayjs\";\n\nimport { fmtCLP } from \"@/lib/format\";\n\nconst columnHelper = createColumnHelper<SettlementTransaction>();\n\nexport const getSettlementColumns = (): ColumnDef<SettlementTransaction, any>[] => [\n  columnHelper.accessor(\"transactionDate\", {\n    cell: ({ getValue }) => (\n      <span className=\"text-base-content font-medium\">{dayjs(getValue() as Date | string).format(\"DD/MM/YYYY\")}</span>\n    ),\n    header: \"Fecha\",\n  }),\n  columnHelper.accessor(\"transactionType\", {\n    header: \"Tipo\",\n  }),\n  columnHelper.accessor(\"transactionAmount\", {\n    cell: ({ getValue }) => fmtCLP(getValue() as unknown as number),\n    header: \"Monto Transacción\",\n  }),\n  columnHelper.accessor(\"settlementNetAmount\", {\n    cell: ({ getValue }) => <span className=\"font-semibold\">{fmtCLP(getValue() as unknown as number)}</span>,\n    header: \"Monto Neto\",\n  }),\n  columnHelper.accessor(\"realAmount\", {\n    cell: ({ getValue }) => fmtCLP(getValue() as unknown as number),\n    header: \"Monto Real\",\n  }),\n  columnHelper.accessor(\"couponAmount\", {\n    cell: ({ getValue }) => fmtCLP(getValue() as unknown as number),\n    header: \"Cupón\",\n  }),\n  columnHelper.accessor(\"taxesAmount\", {\n    cell: ({ getValue }) => fmtCLP(getValue() as unknown as number),\n    header: \"Impuestos\",\n  }),\n  columnHelper.accessor(\"installments\", {\n    header: \"Cuotas\",\n  }),\n];\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/mercadopago/pages/ReleaseTransactionsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/mercadopago/pages/SettlementTransactionsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/mercadopago/queries.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/queries.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/releases/components/ReleaseColumns.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/releases/pages/ReleasesPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/releases/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/settlements/components/SettlementColumns.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/settlements/pages/SettlementsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/settlements/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/statistics/api.ts","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":26,"column":10,"nodeType":"MemberExpression","messageId":"neverNullish","endLine":26,"endColumn":23}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Statistics API\n */\n\nimport { apiClient } from \"@/lib/api-client\";\n\nimport type { StatsResponse, TopParticipantData } from \"./types\";\n\nexport async function fetchStats(from: string, to: string): Promise<StatsResponse> {\n  const params = new URLSearchParams();\n  if (from) params.set(\"from\", from);\n  if (to) params.set(\"to\", to);\n  return apiClient.get<StatsResponse>(`/api/transactions/stats?${params.toString()}`);\n}\n\nexport async function fetchTopParticipants(from: string, to: string, limit = 5): Promise<TopParticipantData[]> {\n  const params = new URLSearchParams();\n  if (from) params.set(\"from\", from);\n  if (to) params.set(\"to\", to);\n  params.set(\"limit\", String(limit));\n\n  const response = await apiClient.get<{ data: TopParticipantData[] }>(\n    `/api/transactions/participants?${params.toString()}`\n  );\n\n  return response.data ?? [];\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/statistics/components/MonthlyFlowChart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/statistics/components/MonthlyFlowChartInner.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":23,"column":47,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":23,"endColumn":83,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[592,618],"text":"Readonly<MonthlyFlowChartInnerProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Monthly Flow Chart Inner - Recharts Implementation\n * Separated for code splitting\n */\n\nimport dayjs from \"dayjs\";\nimport customParseFormat from \"dayjs/plugin/customParseFormat\";\nimport { Bar, BarChart, CartesianGrid, Legend, ResponsiveContainer, Tooltip, XAxis, YAxis } from \"recharts\";\n\nimport { fmtCLP } from \"@/lib/format\";\n\nimport type { MonthlyFlowData } from \"../types\";\n\nimport \"dayjs/locale/es\";\n\ndayjs.extend(customParseFormat);\ndayjs.locale(\"es\");\n\ninterface MonthlyFlowChartInnerProps {\n  data: MonthlyFlowData[];\n}\n\nexport default function MonthlyFlowChartInner({ data }: MonthlyFlowChartInnerProps) {\n  const chartData = data.map((item) => {\n    // item.month viene como \"YYYY-MM\" (e.g., \"2025-01\")\n    const monthDate = dayjs(item.month + \"-01\", \"YYYY-MM-DD\");\n    return {\n      Egresos: item.out,\n      Ingresos: item.in,\n      month: monthDate.isValid() ? monthDate.format(\"MMM YY\") : item.month,\n      Neto: item.net,\n    };\n  });\n\n  return (\n    <ResponsiveContainer height={320} width=\"100%\">\n      <BarChart data={chartData} margin={{ bottom: 10, left: 10, right: 10, top: 10 }}>\n        <CartesianGrid className=\"stroke-base-300\" strokeDasharray=\"3 3\" />\n        <XAxis className=\"text-base-content/70 text-xs\" dataKey=\"month\" tick={{ fontSize: 12 }} />\n        <YAxis\n          className=\"text-base-content/70 text-xs\"\n          tick={{ fontSize: 12 }}\n          tickFormatter={(value) => {\n            const num = typeof value === \"number\" ? value : 0;\n            if (num >= 1_000_000) return `$${Math.round(num / 1_000_000)}M`;\n            if (num >= 1000) return `$${Math.round(num / 1000)}K`;\n            return fmtCLP(num);\n          }}\n        />\n        <Tooltip\n          contentStyle={{\n            backgroundColor: \"hsl(var(--b1))\",\n            border: \"1px solid hsl(var(--bc) / 0.2)\",\n            borderRadius: \"0.5rem\",\n            fontSize: \"0.875rem\",\n          }}\n          formatter={(value) => {\n            const num = typeof value === \"number\" ? value : 0;\n            return fmtCLP(num);\n          }}\n        />\n        <Legend iconType=\"circle\" wrapperStyle={{ fontSize: \"0.875rem\" }} />\n        <Bar dataKey=\"Ingresos\" fill=\"hsl(var(--su))\" radius={[4, 4, 0, 0]} />\n        <Bar dataKey=\"Egresos\" fill=\"hsl(var(--er))\" radius={[4, 4, 0, 0]} />\n        <Bar dataKey=\"Neto\" fill=\"hsl(var(--p))\" radius={[4, 4, 0, 0]} />\n      </BarChart>\n    </ResponsiveContainer>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/statistics/components/MovementTypeList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/statistics/components/TopParticipantsPieChart.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":23,"column":49,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":23,"endColumn":87,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[543,571],"text":"Readonly<TopParticipantsPieChartProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Top Participants Pie Chart - Recharts Implementation\n */\n\nimport { Cell, Pie, PieChart, ResponsiveContainer, Tooltip } from \"recharts\";\n\nimport { fmtCLP } from \"@/lib/format\";\n\nimport type { TopParticipantData } from \"../types\";\n\ninterface TopParticipantsPieChartProps {\n  data: TopParticipantData[];\n}\n\nconst COLORS = [\n  \"hsl(var(--p))\", // primary\n  \"hsl(var(--s))\", // secondary\n  \"hsl(var(--a))\", // accent\n  \"hsl(var(--su))\", // success\n  \"hsl(var(--wa))\", // warning\n];\n\nexport default function TopParticipantsPieChart({ data }: TopParticipantsPieChartProps) {\n  const chartData = data.map((item) => ({\n    name: item.personName,\n    value: item.total,\n  }));\n\n  return (\n    <ResponsiveContainer height={280} width=\"100%\">\n      <PieChart>\n        <Pie\n          cx=\"50%\"\n          cy=\"50%\"\n          data={chartData}\n          dataKey=\"value\"\n          label={(entry) => entry.name}\n          labelLine={false}\n          outerRadius={80}\n        >\n          {chartData.map((_, index) => (\n            <Cell fill={COLORS[index % COLORS.length]} key={`cell-${index}`} />\n          ))}\n        </Pie>\n        <Tooltip\n          contentStyle={{\n            backgroundColor: \"hsl(var(--b1))\",\n            border: \"1px solid hsl(var(--bc) / 0.2)\",\n            borderRadius: \"0.5rem\",\n            fontSize: \"0.875rem\",\n          }}\n          formatter={(value) => fmtCLP(Number(value))}\n        />\n      </PieChart>\n    </ResponsiveContainer>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/statistics/components/TopParticipantsSection.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":21,"column":48,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":21,"endColumn":101,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[522,549],"text":"Readonly<TopParticipantsSectionProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Top Participants Section Component\n */\n\nimport { Users2 } from \"lucide-react\";\nimport { lazy, Suspense } from \"react\";\n\nimport Alert from \"@/components/ui/Alert\";\n\nimport type { TopParticipantData } from \"../types\";\n\n// Lazy load pie chart\nconst TopParticipantsPieChart = lazy(() => import(\"./TopParticipantsPieChart.js\"));\n\ninterface TopParticipantsSectionProps {\n  data: TopParticipantData[];\n  error: null | string;\n  loading: boolean;\n}\n\nexport default function TopParticipantsSection({ data, error, loading }: TopParticipantsSectionProps) {\n  return (\n    <div className=\"bg-base-100 border-base-200 rounded-2xl border p-6 shadow-sm\">\n      <h2 className=\"mb-4 flex items-center gap-2 text-lg font-bold\">\n        <Users2 className=\"text-secondary h-5 w-5\" />\n        Top Contrapartes (Egresos)\n      </h2>\n\n      {loading && (\n        <div className=\"flex h-60 items-center justify-center\">\n          <span className=\"loading loading-spinner loading-lg text-primary\" />\n        </div>\n      )}\n\n      {error && <Alert variant=\"error\">{error}</Alert>}\n\n      {!loading && !error && data.length === 0 && (\n        <div className=\"text-base-content/60 py-8 text-center text-sm\">No hay datos de contrapartes para mostrar</div>\n      )}\n\n      {!loading && !error && data.length > 0 && (\n        <div className=\"grid gap-6 lg:grid-cols-2\">\n          {/* Chart */}\n          <Suspense\n            fallback={\n              <div className=\"flex h-60 items-center justify-center\">\n                <span className=\"loading loading-spinner loading-md text-primary\" />\n              </div>\n            }\n          >\n            <TopParticipantsPieChart data={data.slice(0, 5)} />\n          </Suspense>\n\n          {/* List */}\n          <div className=\"space-y-2\">\n            {data.slice(0, 10).map((participant, index) => (\n              <div\n                className=\"hover:bg-base-200/50 flex items-center justify-between rounded-lg p-3 transition-colors\"\n                key={participant.personId}\n              >\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"bg-primary/10 text-primary flex h-8 w-8 shrink-0 items-center justify-center rounded-full text-sm font-bold\">\n                    {index + 1}\n                  </div>\n                  <div>\n                    <div className=\"font-medium\">{participant.personName}</div>\n                    <div className=\"text-base-content/60 text-xs\">\n                      {participant.count} {participant.count === 1 ? \"transacción\" : \"transacciones\"}\n                    </div>\n                  </div>\n                </div>\n                <div className=\"text-right\">\n                  <div className=\"font-mono text-sm font-semibold\">${participant.total.toLocaleString(\"es-CL\")}</div>\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/statistics/hooks/use-stats-data.ts","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always falsy.","line":58,"column":22,"nodeType":"MemberExpression","messageId":"alwaysFalsy","endLine":58,"endColumn":45},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":59,"column":21,"nodeType":"MemberExpression","messageId":"neverNullish","endLine":59,"endColumn":39},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":60,"column":11,"nodeType":"MemberExpression","messageId":"neverNullish","endLine":60,"endColumn":26},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always falsy.","line":63,"column":14,"nodeType":"MemberExpression","messageId":"alwaysFalsy","endLine":63,"endColumn":34},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always falsy.","line":65,"column":26,"nodeType":"MemberExpression","messageId":"alwaysFalsy","endLine":65,"endColumn":53},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":70,"column":22,"nodeType":"MemberExpression","messageId":"neverNullish","endLine":70,"endColumn":44}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Statistics Data Hook\n */\n\nimport { useSuspenseQuery } from \"@tanstack/react-query\";\nimport dayjs from \"dayjs\";\nimport { useState } from \"react\";\n\nimport type { BalancesApiResponse } from \"@/features/finance/balances/types\";\n\nimport { useAuth } from \"@/context/AuthContext\";\nimport { balanceKeys } from \"@/features/finance/balances/queries\";\n\nimport type { StatsResponse, TopParticipantData } from \"../types\";\n\nimport { statsKeys } from \"../queries\";\n\ninterface UseStatsDataResult {\n  balancesError: null | string;\n  balancesLoading: boolean;\n  balancesReport: BalancesApiResponse | null;\n  data: null | StatsResponse;\n  error: null | string;\n  from: string;\n  loading: boolean;\n  participantsError: null | string;\n  participantsLoading: boolean;\n  refetch: () => Promise<void>;\n  setFrom: (value: string) => void;\n  setTo: (value: string) => void;\n  to: string;\n  topParticipants: TopParticipantData[];\n}\n\nexport function useStatsData(): UseStatsDataResult {\n  const { can } = useAuth();\n  const [from, setFrom] = useState(dayjs().subtract(3, \"month\").startOf(\"month\").format(\"YYYY-MM-DD\"));\n  const [to, setTo] = useState(dayjs().format(\"YYYY-MM-DD\"));\n\n  const canView = can(\"read\", \"Transaction\");\n\n  // Stats query\n  const statsQuery = useSuspenseQuery(statsKeys.main(from, to));\n\n  // Balances query\n  const balancesQuery = useSuspenseQuery(balanceKeys.range(from, to));\n\n  // Top participants query\n  const participantsQuery = useSuspenseQuery(statsKeys.participants(from, to));\n\n  const refetch = async () => {\n    if (!canView) return;\n    await Promise.all([statsQuery.refetch(), balancesQuery.refetch(), participantsQuery.refetch()]);\n  };\n\n  return {\n    balancesError: balancesQuery.error?.message ?? null,\n    balancesLoading: balancesQuery.isPending || balancesQuery.isFetching,\n    balancesReport: balancesQuery.data ?? null,\n    data: statsQuery.data ?? null,\n    error: statsQuery.error?.message ?? null,\n    from,\n    loading: statsQuery.isPending || statsQuery.isFetching,\n    participantsError: participantsQuery.error?.message ?? null,\n    participantsLoading: participantsQuery.isPending || participantsQuery.isFetching,\n    refetch,\n    setFrom,\n    setTo,\n    to,\n    topParticipants: participantsQuery.data ?? [],\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/statistics/pages/FinanzasStatsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":105,"column":24,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":105,"endColumn":26,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[2806,2808],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":106,"column":26,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":106,"endColumn":28,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[2842,2844],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":106,"column":51,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":106,"endColumn":53,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[2867,2869],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":107,"column":25,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":107,"endColumn":27,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[2904,2906],"text":"."},"desc":"Remove unnecessary optional chain"}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Financial Statistics Page\n * Dashboard de estadísticas financieras con KPIs, gráficas y análisis temporal\n */\n\nimport dayjs from \"dayjs\";\nimport { ArrowDown, ArrowUp, BarChart3, Calendar, TrendingUp } from \"lucide-react\";\nimport { useState } from \"react\";\n\nimport Alert from \"@/components/ui/Alert\";\nimport Button from \"@/components/ui/Button\";\nimport Input from \"@/components/ui/Input\";\nimport StatCard from \"@/components/ui/StatCard\";\nimport { useAuth } from \"@/context/AuthContext\";\nimport { BalanceSummary } from \"@/features/finance/balances/components/BalanceSummary\";\nimport { PAGE_CONTAINER } from \"@/lib/styles\";\n\nimport MonthlyFlowChart from \"../components/MonthlyFlowChart\";\nimport MovementTypeList from \"../components/MovementTypeList\";\nimport TopParticipantsSection from \"../components/TopParticipantsSection\";\nimport { useStatsData } from \"../hooks/use-stats-data\";\n\nimport \"dayjs/locale/es\";\n\nconst DATE_FORMAT = \"YYYY-MM-DD\";\n\ndayjs.locale(\"es\");\n\n// Quick date ranges\nconst QUICK_MONTHS = [\n  {\n    from: dayjs().startOf(\"month\").format(DATE_FORMAT),\n    label: \"Este mes\",\n    to: dayjs().endOf(\"month\").format(DATE_FORMAT),\n    value: \"current\",\n  },\n  {\n    from: dayjs().subtract(1, \"month\").startOf(\"month\").format(DATE_FORMAT),\n    label: \"Mes pasado\",\n    to: dayjs().subtract(1, \"month\").endOf(\"month\").format(DATE_FORMAT),\n    value: \"previous\",\n  },\n  {\n    from: dayjs().subtract(3, \"month\").startOf(\"month\").format(DATE_FORMAT),\n    label: \"Últimos 3 meses\",\n    to: dayjs().endOf(\"month\").format(DATE_FORMAT),\n    value: \"3months\",\n  },\n  {\n    from: dayjs().subtract(6, \"month\").startOf(\"month\").format(DATE_FORMAT),\n    label: \"Últimos 6 meses\",\n    to: dayjs().endOf(\"month\").format(DATE_FORMAT),\n    value: \"6months\",\n  },\n  {\n    from: dayjs().startOf(\"year\").format(DATE_FORMAT),\n    label: \"Este año\",\n    to: dayjs().endOf(\"year\").format(DATE_FORMAT),\n    value: \"year\",\n  },\n];\n\nexport default function FinanzasStatsPage() {\n  const { can } = useAuth();\n  const {\n    balancesError,\n    balancesLoading,\n    balancesReport,\n    data,\n    error,\n    from,\n    loading,\n    participantsError,\n    participantsLoading,\n    refetch,\n    setFrom,\n    setTo,\n    to,\n    topParticipants,\n  } = useStatsData();\n\n  const [quickRange, setQuickRange] = useState(\"3months\");\n\n  const canView = can(\"read\", \"Transaction\");\n\n  const handleQuickRangeChange = (value: string) => {\n    setQuickRange(value);\n    if (value === \"custom\") return;\n\n    const match = QUICK_MONTHS.find((month) => month.value === value);\n    if (match) {\n      setFrom(match.from);\n      setTo(match.to);\n    }\n  };\n\n  const handleSubmit = (event: React.FormEvent) => {\n    event.preventDefault();\n    void refetch();\n  };\n\n  // Calculate totals\n  const totals = data\n    ? {\n        in: data.totals?.IN ?? 0,\n        net: (data.totals?.IN ?? 0) - (data.totals?.OUT ?? 0),\n        out: data.totals?.OUT ?? 0,\n      }\n    : { in: 0, net: 0, out: 0 };\n\n  if (!canView) {\n    return (\n      <section className={PAGE_CONTAINER}>\n        <Alert variant=\"error\">No tienes permisos para ver las estadísticas financieras.</Alert>\n      </section>\n    );\n  }\n\n  return (\n    <section className={PAGE_CONTAINER}>\n      {/* Date Range Filters */}\n      <form\n        className=\"bg-base-100 border-base-200 grid gap-4 rounded-2xl border p-6 shadow-sm sm:grid-cols-5\"\n        onSubmit={handleSubmit}\n      >\n        <div className=\"form-control\">\n          <label className=\"label text-xs font-medium\" htmlFor=\"from-date\">\n            Desde\n          </label>\n          <Input\n            className=\"input-sm\"\n            id=\"from-date\"\n            onChange={(e) => {\n              setFrom(e.target.value);\n              setQuickRange(\"custom\");\n            }}\n            type=\"date\"\n            value={from}\n          />\n        </div>\n\n        <div className=\"form-control\">\n          <label className=\"label text-xs font-medium\" htmlFor=\"to-date\">\n            Hasta\n          </label>\n          <Input\n            className=\"input-sm\"\n            id=\"to-date\"\n            onChange={(e) => {\n              setTo(e.target.value);\n              setQuickRange(\"custom\");\n            }}\n            type=\"date\"\n            value={to}\n          />\n        </div>\n\n        <div className=\"form-control\">\n          <label className=\"label text-xs font-medium\" htmlFor=\"quick-range\">\n            Intervalo rápido\n          </label>\n          <select\n            className=\"select select-bordered select-sm\"\n            id=\"quick-range\"\n            onChange={(e) => {\n              handleQuickRangeChange(e.target.value);\n            }}\n            value={quickRange}\n          >\n            <option value=\"custom\">Personalizado</option>\n            {QUICK_MONTHS.map((month) => (\n              <option key={month.value} value={month.value}>\n                {month.label}\n              </option>\n            ))}\n          </select>\n        </div>\n\n        <div className=\"flex items-end gap-2 sm:col-span-2\">\n          <Button className=\"w-full\" disabled={loading} size=\"sm\" type=\"submit\" variant=\"primary\">\n            {loading ? (\n              <>\n                <span className=\"loading loading-spinner loading-xs\" />\n                Calculando...\n              </>\n            ) : (\n              <>\n                <TrendingUp className=\"h-4 w-4\" />\n                Actualizar\n              </>\n            )}\n          </Button>\n        </div>\n      </form>\n\n      {/* Error Alert */}\n      {error && <Alert variant=\"error\">{error}</Alert>}\n\n      {/* Main Content */}\n      {data && (\n        <div className=\"space-y-6\">\n          {/* KPI Cards */}\n          <section className=\"grid gap-4 sm:grid-cols-3\">\n            <StatCard\n              className=\"text-success\"\n              icon={ArrowUp}\n              subtitle=\"Total periodo\"\n              title=\"INGRESOS\"\n              value={totals.in}\n            />\n            <StatCard\n              className=\"text-error\"\n              icon={ArrowDown}\n              subtitle=\"Total periodo\"\n              title=\"EGRESOS\"\n              value={totals.out}\n            />\n            <StatCard\n              className={totals.net >= 0 ? \"text-success\" : \"text-error\"}\n              icon={BarChart3}\n              subtitle=\"Ingresos - Egresos\"\n              title=\"RESULTADO\"\n              value={totals.net}\n            />\n          </section>\n\n          {/* Monthly Flow Chart */}\n          <MonthlyFlowChart data={data.monthly} />\n\n          {/* Daily Balances Summary */}\n          {balancesReport && <BalanceSummary error={balancesError} loading={balancesLoading} report={balancesReport} />}\n\n          {/* Two Column Grid: Movement Types + Top Participants */}\n          <div className=\"grid gap-6 lg:grid-cols-2\">\n            {/* Movement Types */}\n            <div className=\"bg-base-100 border-base-200 rounded-2xl border p-6 shadow-sm\">\n              <h2 className=\"mb-4 flex items-center gap-2 text-lg font-bold\">\n                <Calendar className=\"text-secondary h-5 w-5\" />\n                Por tipo de movimiento\n              </h2>\n              <MovementTypeList data={data.byType} />\n            </div>\n\n            {/* Top Participants Preview */}\n            <div className=\"bg-base-100 border-base-200 rounded-2xl border p-6 shadow-sm\">\n              <h2 className=\"mb-4 flex items-center gap-2 text-lg font-bold\">\n                <TrendingUp className=\"text-accent h-5 w-5\" />\n                Resumen rápido\n              </h2>\n              <div className=\"space-y-3 text-sm\">\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-base-content/70\">Meses analizados:</span>\n                  <span className=\"font-mono font-semibold\">{data.monthly.length}</span>\n                </div>\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-base-content/70\">Tipos de movimiento:</span>\n                  <span className=\"font-mono font-semibold\">{data.byType.length}</span>\n                </div>\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-base-content/70\">Top contrapartes:</span>\n                  <span className=\"font-mono font-semibold\">{topParticipants.length}</span>\n                </div>\n                <div className=\"divider my-2\" />\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-base-content/70\">Promedio mensual:</span>\n                  <span className=\"text-primary font-mono font-semibold\">\n                    $\n                    {data.monthly.length > 0 ? Math.round(totals.net / data.monthly.length).toLocaleString(\"es-CL\") : 0}\n                  </span>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          {/* Top Participants Section */}\n          <TopParticipantsSection data={topParticipants} error={participantsError} loading={participantsLoading} />\n        </div>\n      )}\n\n      {/* Empty State */}\n      {!loading && !error && data?.monthly.length === 0 && (\n        <Alert variant=\"warning\">No se encontraron movimientos en el rango seleccionado.</Alert>\n      )}\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/statistics/queries.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/statistics/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/finance/utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/employees/api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/employees/components/EmployeeForm.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":23,"column":38,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":23,"endColumn":87,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[800,817],"text":"Readonly<EmployeeFormProps>"},"desc":"Mark the props as read-only"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, the types have no overlap.","line":75,"column":22,"nodeType":"BinaryExpression","messageId":"noOverlapBooleanExpression","endLine":75,"endColumn":49},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":82,"column":21,"nodeType":"MemberExpression","messageId":"neverNullish","endLine":82,"endColumn":40},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":242,"column":27,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":242,"endColumn":29,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[8024,8026],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getRetentionRateForYear } from \"@shared/retention\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport React, { useEffect, useState } from \"react\";\n\nimport type { EmployeeSalaryType } from \"@/types/schema\";\n\nimport Button from \"@/components/ui/Button\";\nimport Input from \"@/components/ui/Input\";\nimport { useAuth } from \"@/context/AuthContext\";\nimport { useToast } from \"@/context/ToastContext\";\nimport { formatRut, normalizeRut, validateRut } from \"@/lib/rut\";\n\nimport type { Employee, EmployeePayload, EmployeeUpdatePayload } from \"../types\";\n\nimport { createEmployee, updateEmployee } from \"../api\";\n\ninterface EmployeeFormProps {\n  employee?: Employee | null;\n  onCancel: () => void;\n  onSave: () => void;\n}\n\nexport default function EmployeeForm({ employee, onCancel, onSave }: EmployeeFormProps) {\n  const { can } = useAuth();\n  const { error: toastError, success: toastSuccess } = useToast();\n\n  // Determine required permission based on mode\n  const isEditing = !!employee?.id;\n  const hasPermission = isEditing ? can(\"update\", \"Employee\") : can(\"create\", \"Employee\");\n\n  const [form, setForm] = useState<{\n    bankAccountNumber: string;\n    bankAccountType: string;\n    bankName: string;\n    email: string;\n    fixedSalary: string;\n    fullName: string;\n    hourlyRate: string;\n    overtimeRate: string;\n    retentionRate: string;\n    role: string;\n    rut: string;\n    salaryType: string;\n  }>({\n    bankAccountNumber: \"\",\n    bankAccountType: \"\",\n    bankName: \"\",\n    email: \"\",\n    fixedSalary: \"\",\n    fullName: \"\",\n    hourlyRate: \"0\",\n    overtimeRate: \"\",\n    retentionRate: \"14.5\",\n    role: \"\",\n    rut: \"\",\n    salaryType: \"HOURLY\",\n  });\n\n  const [rutError, setRutError] = useState<null | string>(null);\n\n  useEffect(() => {\n    if (employee) {\n      const employeeRate = getEmployeeRetentionRate(employee);\n      const currentYearRate = getRetentionRateForYear(new Date().getFullYear());\n\n      // If employee rate equals current year rate, show empty (auto mode)\n      // Otherwise show the custom rate\n      const rateToShow = Math.abs(employeeRate - currentYearRate) < 0.0001 ? \"\" : String(employeeRate * 100);\n\n      setForm({\n        bankAccountNumber: employee.bankAccountNumber ?? \"\",\n        bankAccountType: employee.bankAccountType ?? \"\",\n        bankName: employee.bankName ?? \"\",\n        email: employee.person?.email ?? \"\",\n        fixedSalary: employee.baseSalary == null ? \"\" : String(employee.baseSalary),\n        fullName: employee.full_name,\n        hourlyRate: String(employee.hourlyRate ?? \"0\"),\n        overtimeRate: \"\", // Not in schema?\n        retentionRate: rateToShow,\n        role: employee.position,\n        rut: employee.person?.rut ?? \"\",\n        salaryType: employee.salaryType ?? \"HOURLY\",\n      });\n    } else {\n      setForm({\n        bankAccountNumber: \"\",\n        bankAccountType: \"\",\n        bankName: \"\",\n        email: \"\",\n        fixedSalary: \"\",\n        fullName: \"\",\n        hourlyRate: \"0\",\n        overtimeRate: \"\",\n        retentionRate: \"\", // Start empty for new employees (auto mode)\n        role: \"\",\n        rut: \"\",\n        salaryType: \"HOURLY\",\n      });\n    }\n    // Clear RUT error on employee change\n    setRutError(null);\n  }, [employee]);\n\n  const handleRutChange = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const value = event.target.value;\n    setForm((prev) => ({ ...prev, rut: value }));\n    if (rutError) setRutError(null);\n  };\n\n  const handleRutBlur = () => {\n    const formatted = formatRut(normalizeRut(form.rut) ?? form.rut);\n    setForm((prev) => ({ ...prev, rut: formatted }));\n\n    if (formatted && !validateRut(formatted)) {\n      setRutError(\"RUT inválido\");\n    }\n  };\n\n  const handleMutationError = (err: unknown) => {\n    const errObj = err as { details?: unknown; message?: string };\n    const details = errObj.details;\n    let message = err instanceof Error ? err.message : \"No se pudo guardar el empleado\";\n\n    if (Array.isArray(details)) {\n      const issues = details\n        .map((i: { message: string; path: (number | string)[] }) => `${i.path.join(\".\")}: ${i.message}`)\n        .join(\"\\n\");\n      message = `Datos inválidos:\\n${issues}`;\n    }\n    toastError(message);\n  };\n\n  // Mutation for creating employee\n  const createMutation = useMutation({\n    mutationFn: createEmployee,\n    onError: (err) => {\n      handleMutationError(err);\n    },\n    onSuccess: () => {\n      toastSuccess(\"Empleado creado\");\n      onSave(); // Parent handles query invalidation via refetch (or we can invalidate here too)\n      onCancel();\n    },\n  });\n\n  // Mutation for updating employee\n  const updateMutation = useMutation({\n    mutationFn: (data: { id: number; payload: EmployeeUpdatePayload }) => updateEmployee(data.id, data.payload),\n    onError: (err) => {\n      handleMutationError(err);\n    },\n    onSuccess: () => {\n      toastSuccess(\"Empleado actualizado\");\n      onSave();\n      onCancel();\n    },\n  });\n\n  const isMutating = createMutation.isPending || updateMutation.isPending;\n\n  const handleSubmit = (event: React.FormEvent<HTMLFormElement>) => {\n    event.preventDefault();\n    if (!hasPermission) return;\n\n    // Validate RUT before submit if present\n    if (form.rut && !validateRut(form.rut)) {\n      setRutError(\"RUT inválido\");\n      return;\n    }\n\n    const payload: EmployeePayload = {\n      bank_account_number: form.bankAccountNumber.trim() || null,\n      bank_account_type: form.bankAccountType.trim() || null,\n      bank_name: form.bankName.trim() || null,\n      email: form.email.trim() || null,\n      fixed_salary: form.salaryType === \"FIXED\" && form.fixedSalary ? Number(form.fixedSalary) : undefined,\n      full_name: form.fullName.trim(),\n      hourly_rate: form.salaryType === \"HOURLY\" && form.hourlyRate ? Number(form.hourlyRate) : undefined,\n      overtime_rate: form.overtimeRate ? Number(form.overtimeRate) : null,\n      // Convert percentage (e.g., 14.5) to decimal (0.145)\n      // If empty/blank, use current year's default rate (auto mode)\n      // Handle comma as decimal separator for Chilean format\n      retention_rate: form.retentionRate.trim()\n        ? Number(form.retentionRate.replace(\",\", \".\")) / 100\n        : getRetentionRateForYear(new Date().getFullYear()),\n      role: form.role.trim(),\n      rut: form.rut.trim() || null,\n      salary_type: form.salaryType as EmployeeSalaryType,\n    };\n\n    if (employee?.id) {\n      updateMutation.mutate({ id: employee.id, payload });\n    } else {\n      createMutation.mutate(payload);\n    }\n  };\n\n  return (\n    <form className=\"space-y-4\" onSubmit={handleSubmit}>\n      <div className=\"grid gap-4 md:grid-cols-3\">\n        <div className=\"md:col-span-3\">\n          <Input\n            as=\"select\"\n            label=\"Tipo de salario\"\n            onChange={(event: React.ChangeEvent<HTMLSelectElement>) => {\n              setForm((prev) => ({ ...prev, salaryType: event.target.value }));\n            }}\n            value={form.salaryType}\n          >\n            <option value=\"HOURLY\">Por hora</option>\n            <option value=\"FIXED\">Sueldo fijo mensual</option>\n          </Input>\n        </div>\n        <Input\n          label=\"Nombre completo\"\n          onChange={(event: React.ChangeEvent<HTMLInputElement>) => {\n            setForm((prev) => ({ ...prev, fullName: event.target.value }));\n          }}\n          required\n          type=\"text\"\n          value={form.fullName}\n        />\n        <Input\n          label=\"Cargo\"\n          onChange={(event: React.ChangeEvent<HTMLInputElement>) => {\n            setForm((prev) => ({ ...prev, role: event.target.value }));\n          }}\n          required\n          type=\"text\"\n          value={form.role}\n        />\n        <Input\n          label=\"Correo\"\n          onChange={(event: React.ChangeEvent<HTMLInputElement>) => {\n            setForm((prev) => ({ ...prev, email: event.target.value }));\n          }}\n          placeholder=\"correo@bioalergia.cl\"\n          type=\"email\"\n          value={form.email}\n        />\n        <Input\n          error={rutError || undefined}\n          label=\"RUT\"\n          onBlur={handleRutBlur}\n          onChange={handleRutChange}\n          placeholder=\"12.345.678-9\"\n          type=\"text\"\n          value={form.rut}\n        />\n        <Input\n          label=\"Banco\"\n          onChange={(event: React.ChangeEvent<HTMLInputElement>) => {\n            setForm((prev) => ({ ...prev, bankName: event.target.value }));\n          }}\n          placeholder=\"BancoEstado\"\n          type=\"text\"\n          value={form.bankName}\n        />\n        {/* Account type with datalist to avoid UI toggling */}\n        <Input\n          label=\"Tipo de cuenta\"\n          list=\"bank-account-type-options\"\n          onChange={(event: React.ChangeEvent<HTMLInputElement>) => {\n            setForm((prev) => ({ ...prev, bankAccountType: event.target.value }));\n          }}\n          placeholder=\"RUT / VISTA / CORRIENTE / AHORRO\"\n          type=\"text\"\n          value={form.bankAccountType}\n        />\n        <datalist id=\"bank-account-type-options\">\n          <option value=\"RUT\" />\n          <option value=\"VISTA\" />\n          <option value=\"CORRIENTE\" />\n          <option value=\"AHORRO\" />\n        </datalist>\n        <Input\n          label=\"N° de cuenta\"\n          onChange={(event: React.ChangeEvent<HTMLInputElement>) => {\n            setForm((prev) => ({ ...prev, bankAccountNumber: event.target.value }));\n          }}\n          placeholder=\"12345678\"\n          type=\"text\"\n          value={form.bankAccountNumber}\n        />\n        <Input\n          disabled={form.salaryType !== \"HOURLY\"}\n          label=\"Valor hora (CLP)\"\n          min=\"0\"\n          onChange={(event: React.ChangeEvent<HTMLInputElement>) => {\n            setForm((prev) => ({ ...prev, hourlyRate: event.target.value }));\n          }}\n          placeholder=\"$ 0\"\n          required={form.salaryType === \"HOURLY\"}\n          type=\"number\"\n          value={form.hourlyRate}\n        />\n        {form.salaryType === \"FIXED\" && (\n          <Input\n            inputMode=\"numeric\"\n            label=\"Sueldo fijo mensual (CLP)\"\n            onChange={(event: React.ChangeEvent<HTMLInputElement>) => {\n              const rawValue = parseCLP(event.target.value);\n              setForm((prev) => ({ ...prev, fixedSalary: rawValue }));\n            }}\n            placeholder=\"$ 1.500.000\"\n            required\n            type=\"text\"\n            value={formatCLP(form.fixedSalary)}\n          />\n        )}\n        <Input\n          label=\"Valor hora extra (CLP)\"\n          min=\"0\"\n          onChange={(event: React.ChangeEvent<HTMLInputElement>) => {\n            setForm((prev) => ({ ...prev, overtimeRate: event.target.value }));\n          }}\n          placeholder=\"Opcional - dejar vacío si no aplica\"\n          type=\"number\"\n          value={form.overtimeRate}\n        />\n        <Input\n          helper=\"Dejar vacío para usar tasa por año: 2025=14,5% | 2026=15,25%. Si se ingresa un valor, este se aplica para TODOS los años.\"\n          inputMode=\"decimal\"\n          label=\"Retención (%) - Personalizada\"\n          onChange={(event: React.ChangeEvent<HTMLInputElement>) => {\n            // Allow digits, dots, and commas for decimal input\n            const value = event.target.value.replaceAll(/[^\\d.,]/g, \"\");\n            setForm((prev) => ({ ...prev, retentionRate: value }));\n          }}\n          placeholder=\"Ej: 14.5 (opcional - usa tasa por año si está vacío)\"\n          type=\"text\"\n          value={form.retentionRate}\n        />\n      </div>\n      <div className=\"flex items-center justify-end gap-3\">\n        <Button onClick={onCancel} type=\"button\" variant=\"secondary\">\n          Cancelar\n        </Button>\n        <Button disabled={isMutating} type=\"submit\">\n          {(() => {\n            if (isMutating) return \"Guardando...\";\n            return isEditing ? \"Actualizar empleado\" : \"Agregar empleado\";\n          })()}\n        </Button>\n      </div>\n    </form>\n  );\n}\n\n// CLP currency formatting helpers\nfunction formatCLP(value: number | string): string {\n  const num = typeof value === \"string\" ? Number.parseFloat(value.replaceAll(\".\", \"\").replaceAll(\",\", \"\")) : value;\n  if (Number.isNaN(num) || num === 0) return \"\";\n  return num.toLocaleString(\"es-CL\");\n}\n\n// Helper to safely extract retention rate from employee object\nfunction getEmployeeRetentionRate(employee: Employee): number {\n  // Try both property naming conventions due to ZenStack type inconsistencies\n  const emp = employee as unknown as Record<string, unknown>;\n  const rate = emp.retentionRate ?? emp.retention_rate;\n  return typeof rate === \"number\" ? rate : getRetentionRateForYear(new Date().getFullYear());\n}\n\nfunction parseCLP(formatted: string): string {\n  // Remove thousands separators (dots in Chilean format)\n  return formatted.replaceAll(\".\", \"\");\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/employees/components/columns.tsx","messages":[{"ruleId":"check-file/filename-naming-convention","severity":2,"message":"The filename \"columns.tsx\" does not match the \"PASCAL_CASE\" pattern","line":1,"column":1,"nodeType":"Program","messageId":"noMatch","endLine":144,"endColumn":1},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":2,"message":"Unsafe return of a value of type `any`.","line":93,"column":7,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":93,"endColumn":47},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":2,"message":"Unsafe call of an `any` typed value.","line":93,"column":14,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":93,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .includes on an `any` value.","line":93,"column":20,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":93,"endColumn":28}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getRetentionRateForYear } from \"@shared/retention\";\nimport { ColumnDef } from \"@tanstack/react-table\";\n\nimport Button from \"@/components/ui/Button\";\nimport { Employee } from \"@/features/hr/employees/types\";\n\nexport interface EmployeeTableMeta {\n  canEdit: boolean;\n  onActivate: (id: number) => void;\n  onDeactivate: (id: number) => void;\n  onEdit: (employee: Employee) => void;\n}\n\n// Helper to safely extract retention rate\nfunction getEmployeeRetentionRate(employee: Employee): number {\n  // Use 'any' cast if properties are missing in type definition but present in runtime object\n  // or if using legacy fields.\n  // The logic from EmployeeTable.tsx:\n  const emp = employee as unknown as Record<string, unknown>;\n  const rate = emp.retentionRate ?? emp.retention_rate;\n  return typeof rate === \"number\" ? rate : getRetentionRateForYear(new Date().getFullYear());\n}\n\nexport const columns: ColumnDef<Employee>[] = [\n  {\n    accessorKey: \"full_name\",\n    cell: ({ row }) => <span className=\"text-base-content font-medium\">{row.original.full_name}</span>,\n    header: \"Nombre\",\n  },\n  {\n    accessorKey: \"position\",\n    cell: ({ row }) => <span className=\"text-base-content\">{row.original.position}</span>,\n    header: \"Cargo\",\n  },\n  {\n    accessorKey: \"person.email\",\n    cell: ({ row }) => <span className=\"text-base-content/60\">{row.original.person?.email ?? \"—\"}</span>,\n    header: \"Correo\",\n  },\n  {\n    accessorKey: \"person.rut\",\n    cell: ({ row }) => <span className=\"text-base-content\">{row.original.person?.rut ?? \"—\"}</span>,\n    header: \"RUT\",\n  },\n  {\n    cell: ({ row }) => {\n      const e = row.original;\n      if (!e.bankName) return <span className=\"text-base-content/60\">—</span>;\n      return (\n        <span className=\"text-base-content whitespace-nowrap\">\n          {e.bankName}\n          {e.bankAccountType ? ` · ${e.bankAccountType}` : \"\"}\n          {e.bankAccountNumber ? ` · ${e.bankAccountNumber}` : \"\"}\n        </span>\n      );\n    },\n    header: \"Banco / Cuenta\",\n    id: \"bank\",\n  },\n  {\n    accessorFn: (row) => getEmployeeRetentionRate(row),\n    cell: ({ row }) => {\n      const rate = row.getValue<number>(\"retentionRate\") * 100;\n      const formatted = (() => {\n        if (rate % 1 === 0) return rate.toFixed(1);\n        if ((rate * 10) % 1 === 0) return rate.toFixed(1);\n        return rate.toFixed(2);\n      })();\n      const isAuto = getEmployeeRetentionRate(row.original) === getRetentionRateForYear(new Date().getFullYear());\n\n      return (\n        <div className=\"flex flex-col\">\n          <span className=\"text-base-content\">{formatted.replace(\".\", \",\")}%</span>\n          <span className=\"text-base-content/50 text-xs\">{isAuto ? \"Auto (por año)\" : \"Personalizada\"}</span>\n        </div>\n      );\n    },\n    header: \"Retención\",\n    id: \"retentionRate\",\n  },\n  {\n    accessorKey: \"status\",\n    cell: ({ row }) => (\n      <span\n        className={`rounded-full px-2 py-0.5 text-xs font-medium ${\n          row.original.status === \"ACTIVE\" ? \"bg-success/10 text-success\" : \"bg-base-content/10 text-base-content/60\"\n        }`}\n      >\n        {row.original.status === \"ACTIVE\" ? \"Activo\" : \"Inactivo\"}\n      </span>\n    ),\n    filterFn: (row, id, value) => {\n      return value.includes(row.getValue(id));\n    },\n    header: \"Estado\",\n  },\n  {\n    cell: ({ row, table }) => {\n      const meta = table.options.meta as EmployeeTableMeta;\n      const { canEdit, onActivate, onDeactivate, onEdit } = meta;\n      const employee = row.original;\n\n      if (!canEdit) return null;\n\n      return (\n        <div className=\"flex justify-end gap-2 px-4 py-3 whitespace-nowrap\">\n          <Button\n            onClick={() => {\n              onEdit(employee);\n            }}\n            size=\"sm\"\n            variant=\"primary\"\n          >\n            Editar\n          </Button>\n          {employee.status === \"ACTIVE\" ? (\n            <Button\n              onClick={() => {\n                onDeactivate(employee.id);\n              }}\n              size=\"sm\"\n              variant=\"outline\"\n            >\n              Desactivar\n            </Button>\n          ) : (\n            <Button\n              onClick={() => {\n                onActivate(employee.id);\n              }}\n              size=\"sm\"\n              variant=\"success\"\n            >\n              Activar\n            </Button>\n          )}\n        </div>\n      );\n    },\n    header: () => <div className=\"text-right\">Acciones</div>,\n    id: \"actions\",\n  },\n];\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/employees/pages/EmployeesPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always falsy.","line":168,"column":22,"nodeType":"Identifier","messageId":"alwaysFalsy","endLine":168,"endColumn":29}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useUpdateEmployee } from \"@finanzas/db/hooks\";\nimport { useQueryClient, useSuspenseQuery } from \"@tanstack/react-query\";\nimport type { PaginationState } from \"@tanstack/react-table\";\nimport { ChevronUp, Plus } from \"lucide-react\";\nimport type { ChangeEvent } from \"react\";\nimport { useState } from \"react\";\n\nimport type { Employee } from \"@/features/hr/employees/types\";\n\nimport { DataTable } from \"@/components/data-table/DataTable\";\nimport Alert from \"@/components/ui/Alert\";\nimport Button from \"@/components/ui/Button\";\nimport Checkbox from \"@/components/ui/Checkbox\";\nimport { useAuth } from \"@/context/AuthContext\";\nimport { columns } from \"@/features/hr/employees/components/columns\";\nimport EmployeeForm from \"@/features/hr/employees/components/EmployeeForm\";\nimport { employeeKeys } from \"@/features/hr/employees/queries\";\nimport { PAGE_CONTAINER, TITLE_LG } from \"@/lib/styles\";\n// ... existing imports\n\nexport default function EmployeesPage() {\n  const { can } = useAuth();\n  const canEdit = can(\"update\", \"Employee\");\n  const queryClient = useQueryClient();\n\n  const [includeInactive, setIncludeInactive] = useState(false);\n  const [editingEmployee, setEditingEmployee] = useState<Employee | null>(null);\n  const [showForm, setShowForm] = useState(false);\n\n  // Pagination State\n  const [pagination, setPagination] = useState<PaginationState>({\n    pageIndex: 0,\n    pageSize: 10,\n  });\n\n  // Query for employees\n  const { data: employees } = useSuspenseQuery(employeeKeys.list({ includeInactive }));\n\n  const loading = false; // Suspense handles loading\n\n  // Client-side pagination logic\n  const pageCount = Math.ceil(employees.length / pagination.pageSize);\n  const paginatedEmployees = employees.slice(\n    pagination.pageIndex * pagination.pageSize,\n    (pagination.pageIndex + 1) * pagination.pageSize\n  );\n\n  // ... rest of mutation logic ...\n  const updateStatusMutation = useUpdateEmployee();\n  const error = (() => {\n    if (updateStatusMutation.error instanceof Error) return updateStatusMutation.error.message;\n    return null;\n  })();\n  const isMutating = updateStatusMutation.isPending;\n\n  function handleDeactivate(id: number) {\n    if (!canEdit) return;\n    updateStatusMutation.mutate(\n      { data: { status: \"INACTIVE\" }, where: { id } },\n      {\n        onSuccess: () => {\n          void queryClient.invalidateQueries({ queryKey: employeeKeys.all });\n        },\n      }\n    );\n  }\n\n  function handleActivate(id: number) {\n    if (!canEdit) return;\n    updateStatusMutation.mutate(\n      { data: { status: \"ACTIVE\" }, where: { id } },\n      {\n        onSuccess: () => {\n          void queryClient.invalidateQueries({ queryKey: employeeKeys.all });\n        },\n      }\n    );\n  }\n\n  function handleEdit(employee: Employee) {\n    setEditingEmployee(employee);\n    setShowForm(true);\n  }\n\n  function handleCancel() {\n    setEditingEmployee(null);\n    setShowForm(false);\n  }\n\n  function handleSaveSuccess() {\n    void queryClient.invalidateQueries({ queryKey: employeeKeys.all });\n    handleCancel();\n  }\n\n  return (\n    <section className={PAGE_CONTAINER}>\n      {/* ... keeping the header part ... */}\n      <div className=\"flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between\">\n        <h1 className={TITLE_LG}>Equipo y tarifas</h1>\n        <div className=\"flex items-center gap-3\">\n          <Checkbox\n            checked={includeInactive}\n            label=\"Ver inactivos\"\n            onChange={(event: ChangeEvent<HTMLInputElement>) => {\n              setIncludeInactive(event.target.checked);\n            }}\n          />\n          {canEdit && (\n            <Button\n              onClick={() => {\n                if (showForm) {\n                  handleCancel();\n                } else {\n                  setShowForm(true);\n                }\n              }}\n              size=\"md\"\n              variant={showForm ? \"outline\" : \"primary\"}\n            >\n              {showForm ? (\n                <>\n                  <ChevronUp className=\"h-4 w-4\" />\n                  Ocultar formulario\n                </>\n              ) : (\n                <>\n                  <Plus className=\"h-4 w-4\" />\n                  {editingEmployee ? \"Editar empleado\" : \"Agregar empleado\"}\n                </>\n              )}\n            </Button>\n          )}\n        </div>\n      </div>\n\n      {error && <Alert variant=\"error\">{error}</Alert>}\n\n      {canEdit && showForm && (\n        <div className=\"border-base-300 bg-base-100 rounded-2xl border p-6 shadow-sm\">\n          <div className=\"mb-4 flex items-center justify-between\">\n            <h2 className=\"text-primary text-lg font-semibold\">\n              {editingEmployee ? \"Editar empleado\" : \"Agregar nuevo empleado\"}\n            </h2>\n            <Button onClick={handleCancel} size=\"sm\" variant=\"ghost\">\n              <ChevronUp className=\"h-4 w-4\" />\n              Cerrar\n            </Button>\n          </div>\n          <EmployeeForm employee={editingEmployee} onCancel={handleCancel} onSave={handleSaveSuccess} />\n        </div>\n      )}\n\n      <div className=\"border-base-300 bg-base-100 rounded-2xl border p-6 shadow-sm\">\n        <DataTable\n          columns={columns}\n          data={paginatedEmployees}\n          enableVirtualization\n          filters={[\n            {\n              columnId: \"status\",\n              options: [\n                { label: \"Activo\", value: \"ACTIVE\" },\n                { label: \"Inactivo\", value: \"INACTIVE\" },\n              ],\n              title: \"Estado\",\n            },\n          ]}\n          isLoading={loading || isMutating}\n          meta={{\n            canEdit,\n            onActivate: handleActivate,\n            onDeactivate: handleDeactivate,\n            onEdit: handleEdit,\n          }}\n          onPaginationChange={setPagination}\n          pageCount={pageCount}\n          pagination={pagination}\n        />\n      </div>\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/employees/queries.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/employees/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/reports/api.ts","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, comparison is always false, since `\"ok\" !== \"ok\"` is false.","line":19,"column":7,"nodeType":"BinaryExpression","messageId":"comparisonBetweenLiteralTypes","endLine":19,"endColumn":27},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":20,"column":34,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":20,"endColumn":36,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[521,523],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, comparison is always false, since `\"ok\" !== \"ok\"` is false.","line":38,"column":7,"nodeType":"BinaryExpression","messageId":"comparisonBetweenLiteralTypes","endLine":38,"endColumn":27},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":39,"column":34,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":39,"endColumn":36,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[938,940],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/restrict-template-expressions","severity":2,"message":"Invalid type \"never\" of template literal expression.","line":39,"column":82,"nodeType":"MemberExpression","messageId":"invalidType","endLine":39,"endColumn":93},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, comparison is always false, since `\"ok\" !== \"ok\"` is false.","line":58,"column":7,"nodeType":"BinaryExpression","messageId":"comparisonBetweenLiteralTypes","endLine":58,"endColumn":27},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":59,"column":34,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":59,"endColumn":36,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1498,1500],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { apiClient } from \"@/lib/api-client\";\n\nimport type { TimesheetEntry } from \"../timesheets/types\";\n\nexport async function fetchEmployeeTimesheets(employeeId: number, startDate: string, endDate: string) {\n  const data = await apiClient.get<{\n    entries: TimesheetEntry[];\n    from: string;\n    message?: string;\n    status: \"ok\";\n    to: string;\n  }>(`/api/timesheets/${employeeId}/range`, {\n    query: {\n      endDate,\n      startDate,\n    },\n  });\n\n  if (data.status !== \"ok\") {\n    throw new Error(data.message || \"Error fetching employee timesheets\");\n  }\n\n  return data;\n}\n\nexport async function fetchGlobalTimesheetRange(startDate: string, endDate: string) {\n  const data = await apiClient.get<{\n    entries: TimesheetEntry[];\n    message?: string;\n    status: \"ok\";\n  }>(\"/api/timesheets\", {\n    query: {\n      from: startDate,\n      to: endDate,\n    },\n  });\n\n  if (data.status !== \"ok\") {\n    throw new Error(data.message || `Error fetching global timesheets (Status: ${data.status})`);\n  }\n\n  return data.entries;\n}\n\nexport async function fetchMultiMonthTimesheets(employeeIds: number[], startMonth: string, endMonth: string) {\n  const data = await apiClient.get<{\n    data: Record<string, { entries: TimesheetEntry[]; month: string }>;\n    message?: string;\n    status: \"ok\";\n  }>(\"/api/timesheets/multi-month\", {\n    query: {\n      employeeIds: employeeIds.join(\",\"),\n      endMonth,\n      startMonth,\n    },\n  });\n\n  if (data.status !== \"ok\") {\n    throw new Error(data.message || \"Error fetching multi-month timesheets\");\n  }\n\n  return data;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/reports/components/HRReportsColumns.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/reports/components/ReportCharts.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":48,"column":35,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":48,"endColumn":73,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[1065,1087],"text":"Readonly<DistributionChartProps>"},"desc":"Mark the props as read-only"}]},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":89,"column":31,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":89,"endColumn":89,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[2488,2506],"text":"Readonly<TemporalChartProps>"},"desc":"Mark the props as read-only"}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":106,"column":20,"nodeType":"MemberExpression","endLine":106,"endColumn":39},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":106,"column":40,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":106,"endColumn":42,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[3150,3152],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Lazy-loaded Chart Components for Reports\n * These are separated to enable code-splitting of Recharts (~400KB)\n */\nimport { BarChart2, PieChart as PieChartIcon } from \"lucide-react\";\nimport {\n  Bar,\n  BarChart,\n  CartesianGrid,\n  Cell,\n  Legend,\n  Line,\n  LineChart,\n  Pie,\n  PieChart,\n  ResponsiveContainer,\n  Tooltip,\n  XAxis,\n  YAxis,\n} from \"recharts\";\n\nimport type { EmployeeWorkData, ReportGranularity } from \"../types\";\n\nimport { getChartColors } from \"../utils/chart-colors\";\n\n/** Chart data record with period key and dynamic employee name keys */\ntype ChartDataRecord = Record<string, number | string>;\n\ninterface TemporalChartProps {\n  chartData: ChartDataRecord[];\n  granularity: ReportGranularity;\n  reportData: EmployeeWorkData[];\n}\n\nconst tooltipStyle = {\n  border: \"none\",\n  borderRadius: \"12px\",\n  boxShadow: \"0 4px 6px -1px hsl(var(--b3) / 0.5)\",\n};\n\ninterface DistributionChartProps {\n  reportData: EmployeeWorkData[];\n}\n\n/**\n * Pie chart showing distribution of hours across employees\n */\nexport function DistributionChart({ reportData }: DistributionChartProps) {\n  const chartColors = getChartColors();\n\n  if (reportData.length <= 1) return null;\n\n  const pieData = reportData.map((emp) => ({\n    name: emp.fullName,\n    value: Number.parseFloat((emp.totalMinutes / 60).toFixed(1)),\n  }));\n\n  return (\n    <div className=\"bg-base-100 border-base-200 rounded-3xl border p-6 shadow-sm\">\n      <h3 className=\"mb-2 flex items-center gap-2 text-lg font-bold\">\n        <PieChartIcon className=\"text-secondary h-5 w-5\" />\n        Distribución Total\n      </h3>\n      <div className=\"h-80 w-full\">\n        <ResponsiveContainer height=\"100%\" width=\"100%\">\n          <PieChart>\n            <Pie cx=\"50%\" cy=\"45%\" data={pieData} dataKey=\"value\" innerRadius={70} outerRadius={90} paddingAngle={5}>\n              {reportData.map((_, idx) => (\n                <Cell\n                  fill={chartColors[idx % chartColors.length]}\n                  key={`cell-${idx}`}\n                  stroke=\"hsl(var(--b1))\"\n                  strokeWidth={2}\n                />\n              ))}\n            </Pie>\n            <Tooltip contentStyle={tooltipStyle} />\n            <Legend align=\"center\" height={70} iconType=\"circle\" verticalAlign=\"bottom\" />\n          </PieChart>\n        </ResponsiveContainer>\n      </div>\n    </div>\n  );\n}\n\n/**\n * Main temporal comparison chart (Bar or Line based on granularity)\n */\nexport function TemporalChart({ chartData, granularity, reportData }: TemporalChartProps) {\n  const chartColors = getChartColors();\n\n  return (\n    <div className=\"bg-base-100 border-base-200 rounded-3xl border p-6 shadow-sm\">\n      <div className=\"mb-6 flex items-center justify-between\">\n        <h3 className=\"flex items-center gap-2 text-lg font-bold\">\n          <BarChart2 className=\"text-primary h-5 w-5\" />\n          Comparativa Temporal\n        </h3>\n        <div className=\"badge badge-outline text-xs\">\n          {(() => {\n            const labels: Record<string, string> = {\n              day: \"Diario\",\n              month: \"Mensual\",\n              week: \"Semanal\",\n            };\n            return labels[granularity] || granularity;\n          })()}\n        </div>\n      </div>\n\n      <div className=\"w-full\" style={{ height: 350, minHeight: 350 }}>\n        <ResponsiveContainer height=\"100%\" width=\"100%\">\n          {granularity === \"month\" ? (\n            <BarChart data={chartData} margin={{ bottom: 0, left: 0, right: 10, top: 10 }}>\n              <CartesianGrid opacity={0.3} strokeDasharray=\"3 3\" vertical={false} />\n              <XAxis dataKey=\"period\" stroke=\"hsl(var(--bc) / 0.4)\" tick={{ fontSize: 12 }} />\n              <YAxis stroke=\"hsl(var(--bc) / 0.4)\" tick={{ fontSize: 12 }} />\n              <Tooltip contentStyle={tooltipStyle} cursor={{ fill: \"hsl(var(--bc) / 0.05)\" }} />\n              <Legend />\n              {reportData.map((emp, idx) => (\n                <Bar\n                  dataKey={emp.fullName}\n                  fill={chartColors[idx % chartColors.length]}\n                  key={emp.employeeId}\n                  maxBarSize={50}\n                  radius={[4, 4, 0, 0]}\n                />\n              ))}\n            </BarChart>\n          ) : (\n            <LineChart data={chartData} margin={{ bottom: 0, left: 0, right: 10, top: 10 }}>\n              <CartesianGrid opacity={0.3} strokeDasharray=\"3 3\" vertical={false} />\n              <XAxis dataKey=\"period\" stroke=\"hsl(var(--bc) / 0.4)\" tick={{ fontSize: 12 }} />\n              <YAxis stroke=\"hsl(var(--bc) / 0.4)\" tick={{ fontSize: 12 }} />\n              <Tooltip contentStyle={tooltipStyle} cursor={{ fill: \"hsl(var(--bc) / 0.05)\" }} />\n              <Legend iconType=\"circle\" />\n              {reportData.map((emp, idx) => (\n                <Line\n                  activeDot={{ r: 6 }}\n                  connectNulls\n                  dataKey={emp.fullName}\n                  dot={{ r: 4, strokeWidth: 2 }}\n                  key={emp.employeeId}\n                  stroke={chartColors[idx % chartColors.length]}\n                  strokeWidth={3}\n                  type=\"monotone\"\n                />\n              ))}\n            </LineChart>\n          )}\n        </ResponsiveContainer>\n      </div>\n    </div>\n  );\n}\n\n// Default export for lazy loading\nexport default { DistributionChart, TemporalChart };\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/reports/pages/ReportsPage.tsx","messages":[{"ruleId":"security/detect-object-injection","severity":1,"message":"Variable Assigned to Object Injection Sink","line":58,"column":28,"nodeType":"MemberExpression","endLine":58,"endColumn":82},{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":131,"column":55,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":131,"endColumn":66,"suggestions":[{"messageId":"suggestOptionalChain","fix":{"range":[4943,4944],"text":"?"},"desc":"Consider using the optional chain operator `?.` instead. This operator includes runtime checks, so it is safer than the compile-only non-null assertion operator."}]},{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":131,"column":74,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":131,"endColumn":85,"suggestions":[{"messageId":"suggestOptionalChain","fix":{"range":[4962,4963],"text":"?"},"desc":"Consider using the optional chain operator `?.` instead. This operator includes runtime checks, so it is safer than the compile-only non-null assertion operator."}]},{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":595,"column":18,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":595,"endColumn":45},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":602,"column":26,"nodeType":"MemberExpression","endLine":602,"endColumn":54},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":607,"column":27,"nodeType":"MemberExpression","endLine":607,"endColumn":56},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":612,"column":28,"nodeType":"MemberExpression","endLine":612,"endColumn":59}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useQuery, useSuspenseQuery } from \"@tanstack/react-query\";\nimport dayjs from \"dayjs\";\nimport isoWeek from \"dayjs/plugin/isoWeek\";\nimport { BarChart2, BarChart3, Calendar, Check, Clock, Filter, List, Search, TrendingUp, X } from \"lucide-react\";\nimport { lazy, Suspense, useEffect, useState } from \"react\";\n\nimport type { Employee } from \"@/features/hr/employees/types\";\n\nimport { DataTable } from \"@/components/data-table/DataTable\";\nimport Alert from \"@/components/ui/Alert\";\nimport Button from \"@/components/ui/Button\";\nimport Input from \"@/components/ui/Input\";\nimport StatCard from \"@/components/ui/StatCard\";\nimport { useAuth } from \"@/context/AuthContext\";\nimport { fetchEmployees } from \"@/features/hr/employees/api\";\nimport { useMonths } from \"@/features/hr/timesheets/hooks/use-months\";\nimport { LOADING_SPINNER_SM, PAGE_CONTAINER } from \"@/lib/styles\";\nimport { cn } from \"@/lib/utils\";\n\nimport type { EmployeeWorkData, ReportGranularity } from \"../types\";\n\nimport { fetchGlobalTimesheetRange } from \"../api\";\nimport { getHRReportsColumns, HRReportsTableMeta } from \"../components/HRReportsColumns\";\nimport { calculateStats, prepareComparisonData } from \"../utils\";\n\nimport \"dayjs/locale/es\";\n\n// Lazy-load chart components (Recharts ~400KB)\nconst TemporalChart = lazy(() => import(\"../components/ReportCharts\").then((m) => ({ default: m.TemporalChart })));\nconst DistributionChart = lazy(() =>\n  import(\"../components/ReportCharts\").then((m) => ({ default: m.DistributionChart }))\n);\n\ndayjs.extend(isoWeek);\ndayjs.locale(\"es\");\n\nconst DATE_FORMAT = \"YYYY-MM-DD\";\n\n// --- Helper Functions in Scope ---\ninterface RawTimesheetEntry {\n  employee_id: number;\n  overtime_minutes: number;\n  work_date: string;\n  worked_minutes: number;\n}\n\ntype ViewMode = \"all\" | \"month\" | \"range\";\n\nexport default function ReportsPage() {\n  const { can } = useAuth();\n  const canView = can(\"read\", \"Report\");\n\n  // Selection state\n  const [viewMode, setViewMode] = useState<ViewMode>(\"month\");\n  const [startDate, setStartDate] = useState<string>(() => dayjs().startOf(\"month\").format(DATE_FORMAT));\n  const [endDate, setEndDate] = useState<string>(() => dayjs().endOf(\"month\").format(DATE_FORMAT));\n  const [granularity, setGranularity] = useState<ReportGranularity>(\"month\");\n  const granularityLabel = { day: \"día\", month: \"mes\", week: \"sem\" }[granularity];\n\n  // We need to manage \"trigger\" state manually or rely on effective params\n  const [isReportEnabled, setIsReportEnabled] = useState(false);\n  const [timestamp, setTimestamp] = useState(0); // To force re-fetch on click\n\n  // UI State\n  const [showEmployeeDropdown, setShowEmployeeDropdown] = useState(false);\n  const [employeeSearch, setEmployeeSearch] = useState(\"\");\n  const [selectedEmployeeIds, setSelectedEmployeeIds] = useState<number[]>([]);\n\n  // 1. Load Months and Employees\n  const { months, monthsWithData } = useMonths();\n  const [selectedMonth, setSelectedMonth] = useState<string>(\"\");\n\n  useEffect(() => {\n    if (months.length > 0 && !selectedMonth) {\n      setSelectedMonth(months[0] ?? \"\");\n    }\n  }, [months, selectedMonth]);\n\n  useEffect(() => {\n    if (viewMode === \"month\") setGranularity(\"week\");\n    else if (viewMode === \"all\") setGranularity(\"month\");\n  }, [viewMode]);\n\n  const { data: employees } = useSuspenseQuery({\n    queryFn: () => fetchEmployees(false),\n    queryKey: [\"employees-list\"],\n    staleTime: 5 * 60 * 1000,\n  });\n\n  const activeEmployees = employees.filter((emp) => emp.status === \"ACTIVE\" && emp.salaryType !== \"FIXED\");\n\n  const filteredEmployees = (() => {\n    if (!employeeSearch.trim()) return activeEmployees;\n    const search = employeeSearch.toLowerCase();\n    return activeEmployees.filter((emp) => emp.full_name.toLowerCase().includes(search));\n  })();\n\n  // 2. Report Query\n  const dateParams = (() => {\n    let start = startDate;\n    let end = endDate;\n\n    if (viewMode === \"month\") {\n      if (!selectedMonth) return null;\n      start = dayjs(`${selectedMonth}-01`).startOf(\"month\").format(DATE_FORMAT);\n      end = dayjs(`${selectedMonth}-01`).endOf(\"month\").format(DATE_FORMAT);\n    } else if (viewMode === \"all\") {\n      const available = [...monthsWithData].toSorted((a, b) => a.localeCompare(b));\n      if (available.length > 0) {\n        start = dayjs(`${available[0]}-01`).startOf(\"month\").format(DATE_FORMAT);\n        end = dayjs(`${available.at(-1)}-01`)\n          .endOf(\"month\")\n          .format(DATE_FORMAT);\n      } else {\n        start = dayjs().subtract(1, \"year\").format(DATE_FORMAT);\n        end = dayjs().format(DATE_FORMAT);\n      }\n    }\n    return { end, start };\n  })();\n\n  const isQueryEnabled = isReportEnabled && selectedEmployeeIds.length > 0 && dateParams !== null;\n\n  const {\n    data: reportData = [],\n    error,\n    isLoading: loading,\n  } = useQuery<EmployeeWorkData[]>({\n    enabled: isQueryEnabled,\n    queryFn: async () => {\n      const entries = await fetchGlobalTimesheetRange(dateParams!.start, dateParams!.end);\n      return processRawEntries(entries as unknown as RawTimesheetEntry[], selectedEmployeeIds, employees);\n    },\n    queryKey: [\"reports-data\", dateParams, selectedEmployeeIds, timestamp, employees],\n  });\n\n  const handleGenerateReport = () => {\n    setIsReportEnabled(true);\n    setTimestamp(Date.now());\n  };\n\n  const handleEmployeeToggle = (employeeId: number) => {\n    setSelectedEmployeeIds((prev) => {\n      if (prev.includes(employeeId)) return prev.filter((id) => id !== employeeId);\n      return [...prev, employeeId];\n    });\n  };\n\n  const handleSelectAll = () => {\n    if (filteredEmployees.length === selectedEmployeeIds.length) {\n      setSelectedEmployeeIds([]);\n    } else {\n      setSelectedEmployeeIds(filteredEmployees.map((e) => e.id));\n    }\n  };\n\n  const chartData = reportData.length > 0 ? prepareComparisonData(reportData, granularity) : [];\n\n  const periodCount = (() => {\n    if (!dateParams) return 1;\n    const start = dayjs(dateParams.start);\n    const end = dayjs(dateParams.end);\n    let count = 1;\n    if (granularity === \"day\") {\n      count = end.diff(start, \"day\") + 1;\n    } else if (granularity === \"week\") {\n      count = end.diff(start, \"week\", true);\n    } else {\n      count = end.diff(start, \"month\", true);\n    }\n    return Math.max(1, Math.ceil(count));\n  })();\n\n  const stats = calculateStats(reportData, periodCount);\n\n  const columns = getHRReportsColumns();\n\n  const meta: HRReportsTableMeta = {\n    totals: {\n      totalDays: reportData.reduce((acc: number, e: EmployeeWorkData) => acc + e.totalDays, 0),\n      totalHours: stats?.totalHours ?? 0,\n    },\n  };\n\n  if (!canView) {\n    return <Alert variant=\"error\">No tienes permisos para ver reportería.</Alert>;\n  }\n\n  return (\n    <section className={PAGE_CONTAINER}>\n      {/* Main Controls */}\n      <div className=\"grid gap-6 lg:grid-cols-12\">\n        {/* Left Column: Filters */}\n        <div className=\"space-y-6 lg:col-span-4\">\n          <div className=\"bg-base-100 border-base-200 space-y-6 rounded-2xl border p-5 shadow-sm\">\n            <div className=\"border-base-200 flex items-center gap-2 border-b pb-2\">\n              <Filter className=\"text-primary h-5 w-5\" />\n              <h2 className=\"text-lg font-semibold\">Configuración</h2>\n            </div>\n\n            {/* View Mode Tabs */}\n            <div className=\"tabs tabs-boxed bg-base-200/50 p-1\" role=\"tablist\">\n              <button\n                className={cn(\n                  \"tab transition-all duration-200\",\n                  viewMode === \"month\" && \"tab-active bg-base-100 shadow-sm\"\n                )}\n                onClick={() => {\n                  setViewMode(\"month\");\n                }}\n                role=\"tab\"\n                type=\"button\"\n              >\n                Mensual\n              </button>\n              <button\n                className={cn(\n                  \"tab transition-all duration-200\",\n                  viewMode === \"range\" && \"tab-active bg-base-100 shadow-sm\"\n                )}\n                onClick={() => {\n                  setViewMode(\"range\");\n                }}\n                role=\"tab\"\n                type=\"button\"\n              >\n                Rango\n              </button>\n              <button\n                className={cn(\n                  \"tab transition-all duration-200\",\n                  viewMode === \"all\" && \"tab-active bg-base-100 shadow-sm\"\n                )}\n                onClick={() => {\n                  setViewMode(\"all\");\n                }}\n                role=\"tab\"\n                type=\"button\"\n              >\n                Todo\n              </button>\n            </div>\n\n            {/* Date Controls */}\n            <div className=\"space-y-4\">\n              {viewMode === \"month\" && (\n                <div className=\"form-control\">\n                  <label className=\"label text-sm font-medium\" htmlFor=\"month-select\">\n                    Seleccionar Mes\n                  </label>\n                  <select\n                    className=\"select select-bordered w-full\"\n                    id=\"month-select\"\n                    onChange={(e) => {\n                      setSelectedMonth(e.target.value);\n                    }}\n                    value={selectedMonth}\n                  >\n                    {months.map((month) => (\n                      <option key={month} value={month}>\n                        {dayjs(`${month}-01`).format(\"MMMM YYYY\")} {monthsWithData.has(month) ? \"✓\" : \"\"}\n                      </option>\n                    ))}\n                  </select>\n                </div>\n              )}\n\n              {viewMode === \"range\" && (\n                <div className=\"grid grid-cols-2 gap-3\">\n                  <div className=\"form-control\">\n                    <label className=\"label text-sm font-medium\" htmlFor=\"start-date\">\n                      Desde\n                    </label>\n                    <Input\n                      className=\"w-full\"\n                      id=\"start-date\"\n                      onChange={(e) => {\n                        setStartDate(e.target.value);\n                      }}\n                      type=\"date\"\n                      value={startDate}\n                    />\n                  </div>\n                  <div className=\"form-control\">\n                    <label className=\"label text-sm font-medium\" htmlFor=\"end-date\">\n                      Hasta\n                    </label>\n                    <Input\n                      className=\"w-full\"\n                      id=\"end-date\"\n                      onChange={(e) => {\n                        setEndDate(e.target.value);\n                      }}\n                      type=\"date\"\n                      value={endDate}\n                    />\n                  </div>\n                </div>\n              )}\n\n              {viewMode === \"all\" && (\n                <div className=\"alert bg-base-200/50 text-sm\">\n                  <Calendar className=\"text-primary h-4 w-4\" />\n                  <span>Se analizará todo el historial disponible en la base de datos.</span>\n                </div>\n              )}\n\n              <div className=\"form-control\">\n                <label className=\"label text-sm font-medium\" htmlFor=\"granularity-select\">\n                  Agrupación temporal\n                </label>\n                <select\n                  className=\"select select-bordered w-full\"\n                  id=\"granularity-select\"\n                  onChange={(e) => {\n                    setGranularity(e.target.value as ReportGranularity);\n                  }}\n                  value={granularity}\n                >\n                  <option value=\"day\">Diaria</option>\n                  <option value=\"week\">Semanal</option>\n                  <option value=\"month\">Mensual</option>\n                </select>\n              </div>\n            </div>\n\n            <div className=\"divider my-2\"></div>\n\n            {/* Employee Selector */}\n            <div className=\"space-y-3\">\n              <div className=\"flex items-center justify-between\">\n                <label className=\"text-sm font-medium\">Empleados ({selectedEmployeeIds.length})</label>\n                <button className=\"link link-primary text-xs no-underline hover:underline\" onClick={handleSelectAll}>\n                  {selectedEmployeeIds.length === filteredEmployees.length ? \"Ninguno\" : \"Todos\"}\n                </button>\n              </div>\n\n              {/* Selected Tags */}\n              {selectedEmployeeIds.length > 0 && (\n                <div className=\"custom-scrollbar flex max-h-32 flex-wrap gap-1.5 overflow-y-auto p-1\">\n                  {selectedEmployeeIds.slice(0, 10).map((id) => {\n                    const emp = activeEmployees.find((e) => e.id === id);\n                    if (!emp) return null;\n                    return (\n                      <div className=\"badge badge-primary badge-sm gap-1 py-3 text-xs\" key={id}>\n                        <span className=\"max-w-25 truncate\">{emp.person?.names.split(\" \")[0] ?? emp.full_name}</span>\n                        <button\n                          className=\"hover:text-white/80\"\n                          onClick={() => {\n                            handleEmployeeToggle(id);\n                          }}\n                        >\n                          <X className=\"h-3 w-3\" />\n                        </button>\n                      </div>\n                    );\n                  })}\n                  {selectedEmployeeIds.length > 10 && (\n                    <div className=\"badge badge-ghost badge-sm py-3 text-xs\">\n                      +{selectedEmployeeIds.length - 10} más\n                    </div>\n                  )}\n                </div>\n              )}\n\n              {/* Add Dropdown */}\n              <div className=\"relative\">\n                <button\n                  className=\"btn btn-outline btn-sm w-full justify-between font-normal\"\n                  onClick={() => {\n                    setShowEmployeeDropdown(!showEmployeeDropdown);\n                  }}\n                  type=\"button\"\n                >\n                  <span>Seleccionar empleados...</span>\n                  <Search className=\"h-3.5 w-3.5 opacity-50\" />\n                </button>\n\n                {showEmployeeDropdown && (\n                  <>\n                    <div\n                      aria-label=\"Cerrar búsqueda\"\n                      className=\"fixed inset-0 z-40\"\n                      onClick={() => {\n                        setShowEmployeeDropdown(false);\n                      }}\n                      onKeyDown={(e) => {\n                        if (e.key === \"Escape\") setShowEmployeeDropdown(false);\n                      }}\n                      role=\"button\"\n                      tabIndex={-1}\n                    />\n                    <div className=\"bg-base-100 border-base-200 absolute top-full right-0 left-0 z-50 mt-2 flex max-h-80 flex-col overflow-hidden rounded-xl border shadow-xl\">\n                      <div className=\"border-base-200 bg-base-50 border-b p-2\">\n                        <label className=\"input input-sm input-bordered flex items-center gap-2 bg-white\">\n                          <Search className=\"h-4 w-4 opacity-50\" />\n                          <input\n                            className=\"grow\"\n                            onChange={(e) => {\n                              setEmployeeSearch(e.target.value);\n                            }}\n                            placeholder=\"Buscar...\"\n                            type=\"text\"\n                            value={employeeSearch}\n                          />\n                        </label>\n                      </div>\n                      <div className=\"overflow-y-auto p-1\">\n                        {filteredEmployees.map((emp) => {\n                          const isSelected = selectedEmployeeIds.includes(emp.id);\n                          return (\n                            <button\n                              className={cn(\n                                \"flex w-full items-center justify-between rounded-lg px-3 py-2 text-left text-sm transition-colors\",\n                                isSelected\n                                  ? \"bg-primary/10 text-primary font-medium\"\n                                  : \"hover:bg-base-200 text-base-content\"\n                              )}\n                              key={emp.id}\n                              onClick={() => {\n                                handleEmployeeToggle(emp.id);\n                              }}\n                              type=\"button\"\n                            >\n                              <span className=\"truncate\">{emp.full_name}</span>\n                              {isSelected && <Check className=\"ml-2 h-4 w-4\" />}\n                            </button>\n                          );\n                        })}\n                        {filteredEmployees.length === 0 && (\n                          <div className=\"text-base-content/50 p-4 text-center text-sm\">No hay resultados</div>\n                        )}\n                      </div>\n                    </div>\n                  </>\n                )}\n              </div>\n            </div>\n\n            <Button\n              className=\"shadow-primary/20 mt-4 w-full shadow-md\"\n              disabled={selectedEmployeeIds.length === 0 || loading}\n              onClick={handleGenerateReport}\n              variant=\"primary\"\n            >\n              {loading ? (\n                <>\n                  <span className={LOADING_SPINNER_SM} />\n                  Analizando...\n                </>\n              ) : (\n                \"Generar Informe\"\n              )}\n            </Button>\n\n            {error && (\n              <Alert className=\"text-xs\" variant=\"error\">\n                {error instanceof Error ? error.message : String(error)}\n              </Alert>\n            )}\n          </div>\n        </div>\n\n        {/* Right Column: Results */}\n        <div className=\"space-y-6 lg:col-span-8\">\n          {reportData.length === 0 && !loading ? (\n            <div className=\"border-base-300 bg-base-50/50 flex h-full min-h-100 flex-col items-center justify-center rounded-3xl border-2 border-dashed p-8 text-center\">\n              <div className=\"bg-base-200 mb-6 flex h-20 w-20 items-center justify-center rounded-full\">\n                <BarChart2 className=\"text-base-content/30 h-10 w-10\" />\n              </div>\n              <h3 className=\"text-base-content text-xl font-bold\">Sin datos para mostrar</h3>\n              <p className=\"text-base-content/60 mt-2 max-w-sm\">\n                Selecciona el periodo y los empleados que deseas analizar para generar gráficas y estadísticas\n                detalladas.\n              </p>\n            </div>\n          ) : (\n            <>\n              {/* KPI Grid */}\n              <div className=\"grid grid-cols-2 gap-4 sm:grid-cols-4\">\n                <StatCard className=\"text-primary\" icon={Clock} title=\"TOTAL HORAS\" value={stats?.totalHours ?? 0} />\n                <StatCard\n                  className=\"text-secondary\"\n                  icon={BarChart3}\n                  subtitle={`Por ${granularityLabel}`}\n                  title=\"PROMEDIO\"\n                  value={stats?.averageHours ?? 0}\n                />\n                <StatCard\n                  className=\"text-accent\"\n                  icon={Calendar}\n                  subtitle=\"Total asistencias\"\n                  title=\"DÍAS TRAB.\"\n                  value={reportData.reduce((acc, e) => acc + e.totalDays, 0)}\n                />\n                <StatCard\n                  className=\"text-success\"\n                  icon={TrendingUp}\n                  subtitle=\"Horas/día asis.\"\n                  suffix=\"h\"\n                  title=\"PROM. DIARIO\"\n                  value={(() => {\n                    if (reportData.length === 0) return 0;\n                    const avg = reportData.reduce((acc, e) => acc + e.avgDailyMinutes, 0) / reportData.length / 60;\n                    return Number.parseFloat(avg.toFixed(1));\n                  })()}\n                />\n              </div>\n\n              {/* Charts Section - Lazy Loaded */}\n              <Suspense\n                fallback={\n                  <div className=\"bg-base-100 border-base-200 flex h-96 items-center justify-center rounded-3xl border shadow-sm\">\n                    <span className=\"loading loading-spinner loading-lg text-primary\" />\n                  </div>\n                }\n              >\n                <TemporalChart chartData={chartData} granularity={granularity} reportData={reportData} />\n              </Suspense>\n\n              {/* Secondary Details Grid */}\n              <div className=\"grid gap-6 lg:grid-cols-2\">\n                {/* Pie Chart - Lazy Loaded */}\n                <Suspense\n                  fallback={\n                    <div className=\"bg-base-100 border-base-200 flex h-80 items-center justify-center rounded-3xl border shadow-sm\">\n                      <span className=\"loading loading-spinner loading-md text-secondary\" />\n                    </div>\n                  }\n                >\n                  <DistributionChart reportData={reportData} />\n                </Suspense>\n\n                {/* Detailed Table */}\n                <div\n                  className={cn(\n                    \"bg-base-100 border-base-200 flex flex-col rounded-3xl border p-6 shadow-sm\",\n                    reportData.length <= 1 && \"lg:col-span-2\"\n                  )}\n                >\n                  <h3 className=\"mb-4 flex items-center gap-2 text-lg font-bold\">\n                    <List className=\"text-accent h-5 w-5\" />\n                    Detalle Numérico\n                  </h3>\n                  <div className=\"grow overflow-x-auto\">\n                    <DataTable\n                      columns={columns}\n                      data={reportData}\n                      enableToolbar={false}\n                      enableVirtualization={false}\n                      meta={meta}\n                      noDataMessage=\"No hay datos para mostrar.\"\n                    />\n                  </div>\n                </div>\n              </div>\n            </>\n          )}\n        </div>\n      </div>\n    </section>\n  );\n}\n// ---------------------------------\n\nfunction processRawEntries(\n  entries: RawTimesheetEntry[],\n  employeeIds: number[],\n  employees: Employee[]\n): EmployeeWorkData[] {\n  const map = new Map<number, EmployeeWorkData>();\n\n  // Init map\n  for (const id of employeeIds) {\n    const emp = employees.find((e) => e.id === id);\n    if (emp) {\n      map.set(id, {\n        avgDailyMinutes: 0,\n        dailyBreakdown: {},\n        employeeId: id,\n        fullName: emp.full_name,\n        monthlyBreakdown: {},\n        overtimePercentage: 0,\n        role: emp.position,\n        totalDays: 0,\n        totalMinutes: 0,\n        totalOvertimeMinutes: 0,\n        weeklyBreakdown: {},\n      });\n    }\n  }\n\n  for (const entry of entries) {\n    if (!map.has(entry.employee_id)) continue;\n    const data = map.get(entry.employee_id)!;\n\n    data.totalMinutes += entry.worked_minutes;\n    data.totalOvertimeMinutes += entry.overtime_minutes;\n\n    // Daily\n    const dateKey = entry.work_date;\n    const currentDaily = data.dailyBreakdown[dateKey] ?? 0;\n    Object.assign(data.dailyBreakdown, { [dateKey]: currentDaily + entry.worked_minutes });\n\n    // Weekly\n    const weekKey = dayjs(entry.work_date).startOf(\"isoWeek\").format(DATE_FORMAT);\n    const currentWeekly = data.weeklyBreakdown[weekKey] ?? 0;\n    Object.assign(data.weeklyBreakdown, { [weekKey]: currentWeekly + entry.worked_minutes });\n\n    // Monthly\n    const monthKey = dayjs(entry.work_date).format(\"YYYY-MM\");\n    const currentMonthly = data.monthlyBreakdown[monthKey] ?? 0;\n    Object.assign(data.monthlyBreakdown, { [monthKey]: currentMonthly + entry.worked_minutes });\n  }\n\n  // Stats\n  for (const data of map.values()) {\n    const uniqueDays = Object.keys(data.dailyBreakdown).length;\n    data.totalDays = uniqueDays;\n    data.avgDailyMinutes = uniqueDays > 0 ? Math.round(data.totalMinutes / uniqueDays) : 0;\n    data.overtimePercentage =\n      data.totalMinutes > 0 ? Number.parseFloat(((data.totalOvertimeMinutes / data.totalMinutes) * 100).toFixed(1)) : 0;\n  }\n\n  return [...map.values()];\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/reports/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/reports/utils.ts","messages":[{"ruleId":"unicorn/no-array-reduce","severity":2,"message":"`Array#reduce()` is not allowed. Prefer other types of loop for readability.","line":26,"column":28,"nodeType":"Identifier","messageId":"reduce","endLine":26,"endColumn":34},{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":26,"column":100,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":26,"endColumn":108},{"ruleId":"unicorn/no-array-reduce","severity":2,"message":"`Array#reduce()` is not allowed. Prefer other types of loop for readability.","line":27,"column":28,"nodeType":"Identifier","messageId":"reduce","endLine":27,"endColumn":34},{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":27,"column":100,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":27,"endColumn":108},{"ruleId":"security/detect-object-injection","severity":1,"message":"Variable Assigned to Object Injection Sink","line":97,"column":21,"nodeType":"MemberExpression","endLine":97,"endColumn":46},{"ruleId":"security/detect-object-injection","severity":1,"message":"Variable Assigned to Object Injection Sink","line":118,"column":21,"nodeType":"MemberExpression","endLine":118,"endColumn":49},{"ruleId":"security/detect-object-injection","severity":1,"message":"Function Call Object Injection Sink","line":123,"column":38,"nodeType":"MemberExpression","endLine":123,"endColumn":52},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":131,"column":23,"nodeType":"MemberExpression","endLine":131,"endColumn":45},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":131,"column":23,"nodeType":"MemberExpression","endLine":131,"endColumn":37},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":131,"column":46,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":131,"endColumn":48,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[4230,4232],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import dayjs from \"dayjs\";\nimport isoWeek from \"dayjs/plugin/isoWeek\";\n\nimport type { TimesheetEntry } from \"../timesheets/types\";\nimport type { EmployeeWorkData, ReportGranularity } from \"./types\";\n\ndayjs.extend(isoWeek);\n\n/**\n * Calcula estadísticas\n */\n/**\n * Calcula estadísticas\n * @param data Datos de los empleados\n * @param periodCount Cantidad de periodos (días, semanas, meses) en el rango\n */\nexport function calculateStats(data: EmployeeWorkData[], periodCount = 1) {\n  if (data.length === 0) return null;\n\n  const totalHours = data.reduce((sum, emp) => sum + emp.totalMinutes, 0) / 60;\n\n  // Promedio = Total Horas / (Cantidad de Empleados * Cantidad de Periodos)\n  // Ej: 1600 horas / (10 empleados * 1 mes) = 160h promedio/emp/mes\n  const averageHours = totalHours / (data.length * Math.max(periodCount, 1));\n\n  const maxEmployee = data.reduce((max, emp) => (emp.totalMinutes > max.totalMinutes ? emp : max), data[0]!);\n  const minEmployee = data.reduce((min, emp) => (emp.totalMinutes < min.totalMinutes ? emp : min), data[0]!);\n\n  return {\n    averageHours: Number.parseFloat(averageHours.toFixed(2)),\n    maxEmployee: { hours: Number.parseFloat((maxEmployee.totalMinutes / 60).toFixed(2)), name: maxEmployee.fullName },\n    minEmployee: { hours: Number.parseFloat((minEmployee.totalMinutes / 60).toFixed(2)), name: minEmployee.fullName },\n    totalHours: Number.parseFloat(totalHours.toFixed(2)),\n  };\n}\n\n/**\n * Agrupa entradas por día\n */\nexport function groupByDay(entries: TimesheetEntry[]): Record<string, number> {\n  const map = new Map<string, number>();\n  for (const entry of entries) {\n    const date = entry.work_date;\n    const current = map.get(date) ?? 0;\n    map.set(date, current + entry.worked_minutes);\n  }\n  return Object.fromEntries(map);\n}\n\n/**\n * Agrupa entradas por mes\n */\nexport function groupByMonth(entries: TimesheetEntry[]): Record<string, number> {\n  const map = new Map<string, number>();\n  for (const entry of entries) {\n    const month = dayjs(entry.work_date).format(\"YYYY-MM\");\n    const current = map.get(month) ?? 0;\n    map.set(month, current + entry.worked_minutes);\n  }\n  return Object.fromEntries(map);\n}\n\n/**\n * Agrupa entradas por semana (ISO Week)\n */\nexport function groupByWeek(entries: TimesheetEntry[]): Record<string, number> {\n  const map = new Map<string, number>();\n  for (const entry of entries) {\n    const date = dayjs(entry.work_date);\n    const week = date.isoWeek();\n    const year = date.isoWeekYear();\n    const key = `${year}-W${String(week).padStart(2, \"0\")}`;\n    const current = map.get(key) ?? 0;\n    map.set(key, current + entry.worked_minutes);\n  }\n  return Object.fromEntries(map);\n}\n\n/**\n * Convierte minutos a formato HH:MM\n */\nexport function minutesToTime(minutes: number): string {\n  const hours = Math.floor(minutes / 60);\n  const mins = minutes % 60;\n  return `${hours}:${String(mins).padStart(2, \"0\")}`;\n}\n\n/**\n * Prepara datos para gráfico (formato Recharts)\n */\nexport function prepareChartData(data: EmployeeWorkData, granularity: ReportGranularity) {\n  const breakdownMap = {\n    day: data.dailyBreakdown,\n    month: data.monthlyBreakdown,\n    week: data.weeklyBreakdown,\n  };\n  const breakdown = breakdownMap[granularity];\n\n  return Object.entries(breakdown).map(([period, minutes]) => ({\n    [data.fullName]: Number.parseFloat((minutes / 60).toFixed(2)), // Convertir a horas\n\n    minutes,\n    period,\n  }));\n}\n\n/**\n * Prepara datos comparativos\n */\nexport function prepareComparisonData(employees: EmployeeWorkData[], granularity: ReportGranularity) {\n  if (employees.length === 0) return [];\n\n  const breakdownKeyMap = {\n    day: \"dailyBreakdown\",\n    month: \"monthlyBreakdown\",\n    week: \"weeklyBreakdown\",\n  } as const;\n  const breakdown = breakdownKeyMap[granularity];\n\n  // Obtener todas las fechas/semanas/meses\n  const allPeriods = new Set<string>();\n  for (const emp of employees) {\n    for (const period of Object.keys(emp[breakdown])) allPeriods.add(period);\n  }\n\n  const periods = [...allPeriods].toSorted((a, b) => a.localeCompare(b));\n\n  return periods.map((period) => {\n    const dataPoint: Record<string, number | string> = { period };\n    for (const emp of employees) {\n      const minutes = emp[breakdown][period] || 0;\n\n      dataPoint[emp.fullName] = Number.parseFloat((minutes / 60).toFixed(2));\n    }\n    return dataPoint;\n  });\n}\n\n/**\n * Convierte entradas a estructura de datos para reportes\n */\nexport function processEmployeeData(\n  employeeId: number,\n  fullName: string,\n  role: string,\n  entries: TimesheetEntry[]\n): EmployeeWorkData {\n  const totalMinutes = entries.reduce((sum, e) => sum + e.worked_minutes, 0);\n  const totalOvertimeMinutes = entries.reduce((sum, e) => sum + e.overtime_minutes, 0);\n\n  // Calculate distinct days worked (entries might be multiple per day, though typically 1 per day/emp in this system, but let's be safe)\n  const uniqueDays = new Set(entries.map((e) => e.work_date));\n  const totalDays = uniqueDays.size;\n\n  const avgDailyMinutes = totalDays > 0 ? Math.round(totalMinutes / totalDays) : 0;\n  const overtimePercentage =\n    totalMinutes > 0 ? Number.parseFloat(((totalOvertimeMinutes / totalMinutes) * 100).toFixed(1)) : 0;\n\n  return {\n    avgDailyMinutes,\n    dailyBreakdown: groupByDay(entries),\n    employeeId,\n    fullName,\n    monthlyBreakdown: groupByMonth(entries),\n    overtimePercentage,\n    role,\n    totalDays,\n    totalMinutes,\n    totalOvertimeMinutes,\n    weeklyBreakdown: groupByWeek(entries),\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/reports/utils/chart-colors.ts","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always falsy.","line":17,"column":36,"nodeType":"UnaryExpression","messageId":"alwaysFalsy","endLine":17,"endColumn":56}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Chart color palette with theme support\n */\nexport function getChartColors(): string[] {\n  const defaultColors = [\n    \"hsl(220 70% 50%)\", // Blue\n    \"hsl(160 70% 40%)\", // Emerald\n    \"hsl(30 80% 55%)\", // Orange\n    \"hsl(340 75% 55%)\", // Pink\n    \"hsl(270 70% 60%)\", // Purple\n    \"hsl(190 80% 40%)\", // Cyan\n    \"hsl(10 80% 55%)\", // Red\n    \"hsl(290 70% 55%)\", // Magenta\n  ];\n\n  // Check for DOM environment\n  if (!(\"window\" in globalThis) || !globalThis.document) return defaultColors;\n\n  try {\n    const styles = globalThis.window.getComputedStyle(document.documentElement);\n    const getVar = (name: string) => {\n      const val = styles.getPropertyValue(name).trim();\n      return val ? `hsl(${val})` : null;\n    };\n\n    const themeColors = [\n      getVar(\"--p\"),\n      getVar(\"--s\"),\n      getVar(\"--a\"),\n      getVar(\"--n\"),\n      getVar(\"--in\"),\n      getVar(\"--su\"),\n      getVar(\"--wa\"),\n      getVar(\"--er\"),\n    ].filter(Boolean) as string[];\n\n    return themeColors.length > 0 ? themeColors : defaultColors;\n  } catch {\n    return defaultColors;\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/timesheets-audit/api.ts","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":32,"column":10,"nodeType":"MemberExpression","messageId":"alwaysTruthy","endLine":32,"endColumn":26}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * API client for timesheet audit features\n */\n\nimport { apiClient } from \"@/lib/api-client\";\n\nimport type { TimesheetEntryWithEmployee } from \"./types\";\n\n/**\n * Fetch timesheet entries for multiple employees in a date range\n * Only returns entries with start_time and end_time (excludes entries without time tracking)\n */\nexport async function fetchMultiEmployeeTimesheets(\n  employeeIds: number[],\n  from: string,\n  to: string\n): Promise<TimesheetEntryWithEmployee[]> {\n  if (employeeIds.length === 0) {\n    return [];\n  }\n\n  const params = new URLSearchParams({\n    employeeIds: employeeIds.join(\",\"),\n    from,\n    to,\n  });\n\n  const response = await apiClient.get<{ entries: TimesheetEntryWithEmployee[] }>(\n    `/api/timesheets/multi-detail?${params.toString()}`\n  );\n\n  return response.entries || [];\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/timesheets-audit/components/EmployeeAuditSelector.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":21,"column":47,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":26,"endColumn":30,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[572,598],"text":"Readonly<EmployeeAuditSelectorProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Employee multi-select component for audit calendar\n * Limits selection to 5 employees with visual feedback\n */\n\nimport { useState } from \"react\";\n\nimport type { Employee } from \"@/features/hr/employees/types\";\n\nimport Checkbox from \"@/components/ui/Checkbox\";\n\ninterface EmployeeAuditSelectorProps {\n  employees: Employee[];\n  loading?: boolean;\n  onSelectionChange: (ids: number[]) => void;\n  selectedIds: number[];\n}\n\nconst MAX_EMPLOYEES = 5;\n\nexport default function EmployeeAuditSelector({\n  employees,\n  loading = false,\n  onSelectionChange,\n  selectedIds,\n}: EmployeeAuditSelectorProps) {\n  const [isOpen, setIsOpen] = useState(false);\n\n  const activeEmployees = employees.filter((emp) => emp.status === \"ACTIVE\");\n  const selectedNames = selectedIds.map((id) => activeEmployees.find((e) => e.id === id)?.full_name).filter(Boolean);\n\n  const isMaxed = selectedIds.length >= MAX_EMPLOYEES;\n\n  const handleToggle = (employeeId: number) => {\n    if (selectedIds.includes(employeeId)) {\n      onSelectionChange(selectedIds.filter((id) => id !== employeeId));\n    } else if (!isMaxed) {\n      onSelectionChange([...selectedIds, employeeId]);\n    }\n  };\n\n  const displayText = (() => {\n    if (selectedIds.length === 0) return \"Seleccionar empleados...\";\n    if (selectedIds.length <= 2) return selectedNames.join(\", \");\n    return `${selectedNames.slice(0, 2).join(\", \")} +${selectedIds.length - 2}`;\n  })();\n\n  return (\n    <div className=\"relative flex flex-col gap-2\">\n      <label className=\"text-base-content/80 text-xs font-semibold tracking-wide uppercase\">\n        Empleados a auditar{\" \"}\n        <span className=\"text-primary\">\n          ({selectedIds.length}/{MAX_EMPLOYEES})\n        </span>\n      </label>\n\n      {/* Main button */}\n      <button\n        className=\"input input-bordered text-base-content flex h-12 w-full cursor-pointer items-center justify-between gap-3 text-sm select-none disabled:opacity-50\"\n        disabled={loading}\n        onClick={() => {\n          setIsOpen(!isOpen);\n        }}\n        type=\"button\"\n      >\n        <span className=\"truncate font-medium\">{displayText}</span>\n        <svg\n          className={`text-base-content/50 h-4 w-4 shrink-0 transition-transform ${isOpen ? \"rotate-180\" : \"\"}`}\n          fill=\"none\"\n          stroke=\"currentColor\"\n          viewBox=\"0 0 24 24\"\n        >\n          <path d=\"M19 14l-7 7m0 0l-7-7m7 7V3\" strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} />\n        </svg>\n      </button>\n\n      {/* Dropdown */}\n      {isOpen && (\n        <div className=\"surface-recessed absolute top-full right-0 left-0 z-50 mt-2 shadow-lg\">\n          <div className=\"max-h-80 space-y-2 overflow-y-auto p-3\">\n            {activeEmployees.length === 0 ? (\n              <p className=\"text-base-content/50 p-2 text-xs\">Sin empleados disponibles</p>\n            ) : (\n              activeEmployees.map((emp) => {\n                const isSelected = selectedIds.includes(emp.id);\n                const isDisabled = isMaxed && !isSelected;\n\n                return (\n                  <Checkbox\n                    checked={isSelected}\n                    className={`rounded p-2 text-sm transition-colors ${\n                      isDisabled ? \"cursor-not-allowed opacity-50\" : \"hover:bg-base-100/60\"\n                    }`}\n                    disabled={isDisabled}\n                    key={emp.id}\n                    label={emp.full_name}\n                    onChange={() => {\n                      handleToggle(emp.id);\n                    }}\n                  />\n                );\n              })\n            )}\n          </div>\n\n          {isMaxed && (\n            <div className=\"border-base-300 bg-warning/10 border-t px-3 py-2\">\n              <p className=\"text-warning text-xs\">\n                Máximo {MAX_EMPLOYEES} empleados pueden ser auditados simultáneamente\n              </p>\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* Selected badges */}\n      {selectedIds.length > 0 && (\n        <div className=\"flex flex-wrap gap-2\">\n          {selectedIds.map((id) => {\n            const emp = activeEmployees.find((e) => e.id === id);\n            if (!emp) return null;\n\n            return (\n              <div className=\"badge badge-primary gap-2 text-xs\" key={id}>\n                {emp.full_name}\n                <button\n                  aria-label={`Remove ${emp.full_name}`}\n                  className=\"hover:text-error text-xs transition-colors\"\n                  onClick={() => {\n                    handleToggle(id);\n                  }}\n                  type=\"button\"\n                >\n                  ✕\n                </button>\n              </div>\n            );\n          })}\n        </div>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/timesheets-audit/components/TimesheetAuditCalendar.tsx","messages":[{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":54,"column":81,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":54,"endColumn":83,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1829,1831],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":172,"column":48,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":177,"endColumn":31,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[5669,5696],"text":"Readonly<TimesheetAuditCalendarProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * TimesheetAuditCalendar Component\n * Displays employee work schedules with overlap detection\n * Optimized for production with proper type safety and performance\n */\n\nimport type { CalendarApi } from \"@fullcalendar/core\";\nimport esLocale from \"@fullcalendar/core/locales/es\";\nimport dayGridPlugin from \"@fullcalendar/daygrid\";\nimport FullCalendar from \"@fullcalendar/react\";\nimport timeGridPlugin from \"@fullcalendar/timegrid\";\nimport { useEffect, useRef } from \"react\";\n\nimport { LOADING_SPINNER_MD } from \"@/lib/styles\";\n\nimport type { CalendarEventData, TimesheetEntryWithEmployee } from \"../types\";\n\nimport { calculateDurationHours, formatDuration, getOverlappingEmployeesForDate } from \"../utils/overlap-detection\";\n\nimport \"./TimesheetAuditCalendar.css\";\n\ninterface TimesheetAuditCalendarProps {\n  entries: TimesheetEntryWithEmployee[];\n  focusDate?: null | string;\n  loading?: boolean;\n  selectedEmployeeIds: number[];\n  visibleDateRanges?: null | { end: string; start: string }[];\n}\n\nconst SECONDS_IN_DAY = 24 * 60 * 60 - 1; // 23:59:59\nconst SLOT_BUFFER_SECONDS = 60 * 30;\n\nfunction buildDateTime(date: string, time: null | string) {\n  if (!time) return null;\n  return `${date}T${time}`;\n}\n\nfunction clampSeconds(value: number) {\n  if (!Number.isFinite(value)) return 0;\n  return Math.min(SECONDS_IN_DAY, Math.max(0, Math.floor(value)));\n}\n\n/**\n * Convert timesheet entries to FullCalendar events\n */\nfunction convertToCalendarEvents(\n  entries: TimesheetEntryWithEmployee[],\n  overlappingEmployeesByDate: Map<string, Set<number>>\n): CalendarEventData[] {\n  return entries\n    .filter((entry) => entry.start_time && entry.end_time)\n    .map((entry) => {\n      const duration = calculateDurationHours(entry.start_time, entry.end_time);\n      const overlappingOnDate = overlappingEmployeesByDate.get(entry.work_date) || new Set();\n      const hasOverlap = overlappingOnDate.has(entry.employee_id);\n\n      return {\n        duration_hours: duration,\n        employee_name: entry.employee_name,\n        employee_role: entry.employee_role,\n        employeeId: entry.employee_id,\n        end_time: entry.end_time,\n        has_overlap: hasOverlap,\n        id: `${entry.id}`,\n        start_time: entry.start_time,\n        work_date: entry.work_date,\n      };\n    });\n}\n\nfunction normalizeTimeComponent(time: null | string | undefined) {\n  if (!time) return null;\n  const trimmed = time.trim();\n  if (!trimmed) return null;\n  if (/^\\d{2}:\\d{2}$/.test(trimmed)) {\n    return `${trimmed}:00`;\n  }\n  if (/^\\d{2}:\\d{2}:\\d{2}$/.test(trimmed)) {\n    return trimmed;\n  }\n  // fallback: attempt to slice first 8 chars (HH:mm:ss)\n  return trimmed.slice(0, 8);\n}\n\nfunction secondsToTime(value: number) {\n  const clamped = clampSeconds(value);\n  const hours = Math.floor(clamped / 3600);\n  const minutes = Math.floor((clamped % 3600) / 60);\n  const seconds = clamped % 60;\n  return `${String(hours).padStart(2, \"0\")}:${String(minutes).padStart(2, \"0\")}:${String(seconds).padStart(2, \"0\")}`;\n}\n\nfunction timeStringToSeconds(value: string) {\n  const [hoursRaw = \"0\", minutesRaw = \"0\", secondsRaw = \"0\"] = value.split(\":\");\n  const hours = Number.parseInt(hoursRaw, 10) || 0;\n  const minutes = Number.parseInt(minutesRaw, 10) || 0;\n  const seconds = Number.parseInt(secondsRaw, 10) || 0;\n  return hours * 3600 + minutes * 60 + seconds;\n}\n\n/**\n * Convert to FullCalendar event format\n */\nfunction toFullCalendarEvents(calendarEvents: CalendarEventData[]): {\n  allDay: boolean;\n  backgroundColor?: string;\n  borderColor?: string;\n  classNames: string[];\n  end: string;\n  extendedProps: {\n    duration_hours: number;\n    employee_name: string;\n    employee_role: null | string;\n    has_overlap: boolean;\n  };\n  id: string;\n  start: string;\n  title: string;\n}[] {\n  return calendarEvents\n    .map((event) => {\n      const normalizedStart = normalizeTimeComponent(event.start_time);\n      const normalizedEnd = normalizeTimeComponent(event.end_time);\n      const startIso = normalizedStart ? buildDateTime(event.work_date, normalizedStart) : null;\n      const endIso = normalizedEnd ? buildDateTime(event.work_date, normalizedEnd) : null;\n      if (!startIso || !endIso) {\n        return null;\n      }\n\n      return {\n        allDay: false,\n        backgroundColor: event.has_overlap ? \"var(--color-error)\" : \"var(--color-accent)\",\n        borderColor: event.has_overlap ? \"var(--color-error)\" : \"var(--color-accent)\",\n        classNames: [\"timesheet-audit-event\", event.has_overlap ? \"has-overlap\" : \"\"].filter(Boolean),\n        end: endIso,\n        extendedProps: {\n          duration_hours: event.duration_hours,\n          employee_name: event.employee_name,\n          employee_role: event.employee_role,\n          has_overlap: event.has_overlap,\n        },\n        id: event.id,\n        start: startIso,\n        title: event.employee_name,\n      };\n    })\n    .filter((value): value is NonNullable<typeof value> => value != null);\n}\n\nconst handleEventDidMount = (info: {\n  el: HTMLElement;\n  event: {\n    extendedProps: {\n      duration_hours: number;\n      employee_name: string;\n      employee_role: null | string;\n      has_overlap: boolean;\n    };\n  };\n}) => {\n  const props = info.event.extendedProps;\n  const roleLabel = props.employee_role ? ` · ${props.employee_role}` : \"\";\n  const tooltipText = `${props.employee_name}${roleLabel} · ${formatDuration(props.duration_hours)}${\n    props.has_overlap ? \" · ⚠️ Solapamiento\" : \"\"\n  }`;\n  info.el.setAttribute(\"title\", tooltipText);\n  if (props.has_overlap) {\n    info.el.classList.add(\"has-overlap\");\n  }\n};\n\nexport default function TimesheetAuditCalendar({\n  entries,\n  focusDate,\n  loading = false,\n  visibleDateRanges,\n}: TimesheetAuditCalendarProps) {\n  const calendarApiRef = useRef<CalendarApi | null>(null);\n\n  // Navigate to focus date when it changes\n  useEffect(() => {\n    if (!focusDate) return;\n    calendarApiRef.current?.gotoDate(focusDate);\n  }, [focusDate]);\n\n  // Cleanup: destroy calendar API on unmount to prevent memory leaks\n  useEffect(() => {\n    return () => {\n      if (calendarApiRef.current) {\n        calendarApiRef.current = null;\n      }\n    };\n  }, []);\n\n  const rangeFilteredEntries = (() => {\n    if (!visibleDateRanges || visibleDateRanges.length === 0) {\n      return entries;\n    }\n    return entries.filter((entry) =>\n      visibleDateRanges.some((range) => entry.work_date >= range.start && entry.work_date <= range.end)\n    );\n  })();\n\n  // Memoize overlap detection to avoid recalculation\n  const overlappingEmployeesByDate = (() => {\n    const map = new Map<string, Set<number>>();\n    const dates = new Set(rangeFilteredEntries.map((e) => e.work_date));\n\n    for (const date of dates) {\n      const overlapping = getOverlappingEmployeesForDate(rangeFilteredEntries, date);\n      map.set(date, new Set(overlapping));\n    }\n\n    return map;\n  })();\n\n  // Convert entries to calendar format\n  const calendarEvents = convertToCalendarEvents(rangeFilteredEntries, overlappingEmployeesByDate);\n\n  // Convert to FullCalendar format\n  const fullCalendarEvents = toFullCalendarEvents(calendarEvents);\n\n  // Calculate time bounds based on entries\n  const timeBounds = (() => {\n    if (rangeFilteredEntries.length === 0) {\n      return {\n        slotMaxTime: \"20:00:00\",\n        slotMinTime: \"06:00:00\",\n      };\n    }\n\n    let minSeconds = 23 * 3600 + 59 * 60; // 23:59:00\n    let maxSeconds = 0;\n\n    for (const entry of rangeFilteredEntries) {\n      const normalizedStart = normalizeTimeComponent(entry.start_time);\n      const normalizedEnd = normalizeTimeComponent(entry.end_time);\n      if (normalizedStart) {\n        minSeconds = Math.min(minSeconds, timeStringToSeconds(normalizedStart) - SLOT_BUFFER_SECONDS);\n      }\n      if (normalizedEnd) {\n        maxSeconds = Math.max(maxSeconds, timeStringToSeconds(normalizedEnd) + SLOT_BUFFER_SECONDS);\n      }\n    }\n\n    minSeconds = clampSeconds(minSeconds);\n    maxSeconds = clampSeconds(maxSeconds);\n\n    const minReadableWindow = minSeconds + SLOT_BUFFER_SECONDS;\n    if (maxSeconds < minReadableWindow) {\n      maxSeconds = Math.min(SECONDS_IN_DAY, minReadableWindow);\n    }\n\n    return {\n      slotMaxTime: secondsToTime(maxSeconds),\n      slotMinTime: secondsToTime(minSeconds),\n    };\n  })();\n\n  return (\n    <div className=\"bg-base-200/30 border-base-200 w-full overflow-hidden rounded-xl border p-6\">\n      <div className=\"timesheet-audit-calendar-wrapper\">\n        {loading && (\n          <div className=\"bg-base-100/80 absolute inset-0 z-50 flex items-center justify-center\">\n            <span className={LOADING_SPINNER_MD}></span>\n          </div>\n        )}\n        <FullCalendar\n          contentHeight=\"auto\"\n          dayMaxEvents={false}\n          editable={false}\n          eventDidMount={handleEventDidMount}\n          eventDisplay=\"block\"\n          events={fullCalendarEvents}\n          eventTimeFormat={{\n            hour: \"2-digit\",\n            hour12: false,\n            meridiem: false,\n            minute: \"2-digit\",\n          }}\n          headerToolbar={{\n            center: \"title\",\n            left: \"prev,next today\",\n            right: \"dayGridMonth,timeGridWeek,timeGridDay\",\n          }}\n          height=\"auto\"\n          hiddenDays={[0]}\n          initialDate={focusDate ?? undefined}\n          initialView=\"timeGridWeek\"\n          locale={esLocale}\n          locales={[esLocale]}\n          nowIndicator\n          plugins={[dayGridPlugin, timeGridPlugin]}\n          ref={(instance: unknown) => {\n            calendarApiRef.current =\n              instance && typeof (instance as { getApi?: unknown }).getApi === \"function\"\n                ? (instance as { getApi: () => CalendarApi }).getApi()\n                : null;\n          }}\n          selectable={false}\n          slotDuration=\"00:30:00\"\n          slotLabelFormat={{\n            hour: \"2-digit\",\n            hour12: false,\n            meridiem: false,\n            minute: \"2-digit\",\n          }}\n          slotLabelInterval=\"00:30:00\"\n          slotMaxTime={timeBounds.slotMaxTime}\n          slotMinTime={timeBounds.slotMinTime}\n        />\n      </div>\n\n      {/* Legend */}\n      <div className=\"text-base-content/70 mt-6 flex flex-col gap-3 text-sm\">\n        <div className=\"flex items-center gap-3\">\n          <div className=\"bg-accent h-4 w-4 rounded\"></div>\n          <span>Sin solapamiento</span>\n        </div>\n        <div className=\"flex items-center gap-3\">\n          <div className=\"bg-error h-4 w-4 rounded\"></div>\n          <span>Con solapamiento detectado</span>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/timesheets-audit/components/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/timesheets-audit/hooks/use-timesheet-audit.ts","messages":[{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":35,"column":68,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":35,"endColumn":77},{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":35,"column":79,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":35,"endColumn":87}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Hook for managing timesheet audit state and data fetching\n */\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useMemo } from \"react\";\n\nimport type { TimesheetEntryWithEmployee } from \"../types\";\n\nimport { fetchMultiEmployeeTimesheets } from \"../api\";\n\nexport interface AuditDateRange {\n  end: string;\n  start: string;\n}\n\ninterface UseTimesheetAuditOptions {\n  employeeIds: number[];\n  ranges: AuditDateRange[];\n}\n\nexport function useTimesheetAudit({ employeeIds, ranges }: UseTimesheetAuditOptions) {\n  const sortedRanges = useMemo(() => ranges.toSorted((a, b) => a.start.localeCompare(b.start)), [ranges]);\n  const firstDay = sortedRanges[0]?.start;\n  const lastDay = sortedRanges.at(-1)?.end;\n\n  const shouldFetch = employeeIds.length > 0 && ranges.length > 0 && !!firstDay && !!lastDay;\n\n  const {\n    data: entries = [],\n    error,\n    isLoading,\n  } = useQuery({\n    enabled: shouldFetch,\n    queryFn: async () => {\n      const data = await fetchMultiEmployeeTimesheets(employeeIds, firstDay!, lastDay!);\n      return filterAuditEntries(data, sortedRanges);\n    },\n    queryKey: [\"timesheet-audit\", employeeIds, firstDay, lastDay, sortedRanges],\n  });\n\n  return { entries: entries, error, isLoading };\n}\n\nfunction filterAuditEntries(data: TimesheetEntryWithEmployee[], ranges: AuditDateRange[]) {\n  return data.filter((entry) => ranges.some((range) => isWithinRange(entry.work_date, range)));\n}\n\nfunction isWithinRange(date: string, range: AuditDateRange) {\n  return date >= range.start && date <= range.end;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/timesheets-audit/pages/TimesheetAuditPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/timesheets-audit/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/timesheets-audit/utils/overlap-detection.ts","messages":[{"ruleId":"security/detect-object-injection","severity":1,"message":"Variable Assigned to Object Injection Sink","line":61,"column":16,"nodeType":"MemberExpression","endLine":61,"endColumn":30},{"ruleId":"security/detect-object-injection","severity":1,"message":"Variable Assigned to Object Injection Sink","line":65,"column":18,"nodeType":"MemberExpression","endLine":65,"endColumn":32},{"ruleId":"security/detect-object-injection","severity":1,"message":"Variable Assigned to Object Injection Sink","line":101,"column":16,"nodeType":"MemberExpression","endLine":101,"endColumn":30},{"ruleId":"security/detect-object-injection","severity":1,"message":"Variable Assigned to Object Injection Sink","line":105,"column":18,"nodeType":"MemberExpression","endLine":105,"endColumn":32},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":177,"column":26,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":177,"endColumn":28,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[5323,5325],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":178,"column":28,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":178,"endColumn":30,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[5356,5358],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Overlap detection utilities for timesheet audit\n * Optimized for production use with memoization and efficient algorithms\n */\n\nimport type { OverlapInfo, TimesheetEntryWithEmployee } from \"../types\";\n\n/**\n * Calculate duration in hours from time range\n */\nexport function calculateDurationHours(start: string, end: string): number {\n  const startMins = timeToMinutes(start);\n  const endMins = timeToMinutes(end);\n  return (endMins - startMins) / 60;\n}\n\n/**\n * Detect all overlaps in a set of entries\n * Returns summary info grouped by date\n */\nexport function detectAllOverlaps(entries: TimesheetEntryWithEmployee[]): Map<string, OverlapInfo> {\n  const overlapsByDate = new Map<string, OverlapInfo>();\n  const uniqueDates = new Set(entries.map((e) => e.work_date));\n\n  for (const workDate of uniqueDates) {\n    const overlaps = detectOverlapsForDate(entries, workDate);\n    if (overlaps.length > 0) {\n      const dateEntries = entries.filter((e) => e.work_date === workDate);\n      const employeeIds = new Set(dateEntries.map((e) => e.employee_id));\n\n      overlapsByDate.set(workDate, {\n        employee_count: employeeIds.size,\n        employee_ids: [...employeeIds],\n        total_overlapping_pairs: overlaps.length,\n        work_date: workDate,\n      });\n    }\n  }\n\n  return overlapsByDate;\n}\n\n/**\n * Detect overlaps for a given date and list of entries\n * Returns array of employee pairs that overlap on that date\n */\nexport function detectOverlapsForDate(\n  entries: TimesheetEntryWithEmployee[],\n  workDate: string\n): {\n  names: [string, string];\n  pair: [number, number];\n}[] {\n  const dateEntries = entries.filter((e) => e.work_date === workDate);\n  const overlaps: {\n    names: [string, string];\n    pair: [number, number];\n  }[] = [];\n\n  for (let i = 0; i < dateEntries.length; i += 1) {\n    const e1 = dateEntries[i];\n    if (!e1) continue;\n\n    for (let j = i + 1; j < dateEntries.length; j += 1) {\n      const e2 = dateEntries[j];\n      if (!e2) continue;\n\n      if (\n        isTimeRangeOverlapping(e1.start_time, e1.end_time, e2.start_time, e2.end_time) &&\n        !rolesAreCompatibleForOverlap(e1.employee_role, e2.employee_role)\n      ) {\n        overlaps.push({\n          names: [e1.employee_name, e2.employee_name],\n          pair: [e1.employee_id, e2.employee_id],\n        });\n      }\n    }\n  }\n\n  return overlaps;\n}\n\n/**\n * Format duration hours to readable string (e.g., \"8h 30m\")\n */\nexport function formatDuration(hours: number): string {\n  const h = Math.floor(hours);\n  const m = Math.round((hours - h) * 60);\n  if (m === 0) return `${h}h`;\n  return `${h}h ${m}m`;\n}\n\n/**\n * Get employees that have overlaps on a specific date\n */\nexport function getOverlappingEmployeesForDate(entries: TimesheetEntryWithEmployee[], workDate: string): number[] {\n  const dateEntries = entries.filter((e) => e.work_date === workDate);\n  const overlappingIds = new Set<number>();\n\n  for (let i = 0; i < dateEntries.length; i += 1) {\n    const e1 = dateEntries[i];\n    if (!e1) continue;\n\n    for (let j = i + 1; j < dateEntries.length; j += 1) {\n      const e2 = dateEntries[j];\n      if (!e2) continue;\n\n      if (\n        isTimeRangeOverlapping(e1.start_time, e1.end_time, e2.start_time, e2.end_time) &&\n        !rolesAreCompatibleForOverlap(e1.employee_role, e2.employee_role)\n      ) {\n        overlappingIds.add(e1.employee_id);\n        overlappingIds.add(e2.employee_id);\n      }\n    }\n  }\n\n  return [...overlappingIds];\n}\n\n/**\n * Check if two time ranges overlap\n * @param start1 Start time in HH:MM format\n * @param end1 End time in HH:MM format\n * @param start2 Start time in HH:MM format\n * @param end2 End time in HH:MM format\n */\nexport function isTimeRangeOverlapping(start1: string, end1: string, start2: string, end2: string): boolean {\n  const s1 = timeToMinutes(start1);\n  const e1 = timeToMinutes(end1);\n  const s2 = timeToMinutes(start2);\n  const e2 = timeToMinutes(end2);\n\n  return s1 < e2 && s2 < e1;\n}\n\nfunction isNurseRole(role: null | string | undefined): boolean {\n  const normalized = normalizeRole(role);\n  if (!normalized) return false;\n  return normalized.includes(\"enfermer\") && normalized.includes(\"universitar\");\n}\n\nfunction isTensRole(role: null | string | undefined): boolean {\n  const normalized = normalizeRole(role);\n  if (!normalized) return false;\n  if (normalized.includes(\"tens\")) return true;\n  if (normalized.includes(\"tecnico\") && normalized.includes(\"enfermer\")) return true;\n  if (normalized.includes(\"tecnica\") && normalized.includes(\"enfermer\")) return true;\n  return false;\n}\n\nfunction normalizeRole(role: null | string | undefined): string {\n  return role\n    ? role\n        .normalize(\"NFD\")\n        .replaceAll(/[\\u0300-\\u036F]/g, \"\")\n        .toLowerCase()\n        .replaceAll(/[^a-z0-9\\s]/g, \" \")\n        .replaceAll(/\\s+/g, \" \")\n        .trim()\n    : \"\";\n}\n\nfunction rolesAreCompatibleForOverlap(roleA: null | string | undefined, roleB: null | string | undefined): boolean {\n  const nurseA = isNurseRole(roleA);\n  const nurseB = isNurseRole(roleB);\n  const tensA = isTensRole(roleA);\n  const tensB = isTensRole(roleB);\n  return (nurseA && tensB) || (nurseB && tensA);\n}\n\n/**\n * Convert time string (HH:MM) to minutes since midnight\n */\nfunction timeToMinutes(time: string): number {\n  const parts = time.split(\":\").map(Number);\n  const hours = parts[0] || 0;\n  const minutes = parts[1] || 0;\n  return hours * 60 + minutes;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/timesheets/api.ts","messages":[{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":20,"column":34,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":20,"endColumn":36,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[627,629],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":29,"column":34,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":29,"endColumn":36,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[902,904],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":47,"column":34,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":47,"endColumn":36,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1415,1417],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":61,"column":29,"nodeType":"MemberExpression","messageId":"alwaysTruthy","endLine":61,"endColumn":48},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":75,"column":34,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":75,"endColumn":36,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2252,2254],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":105,"column":34,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":105,"endColumn":36,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2972,2974],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":118,"column":34,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":118,"endColumn":36,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[3324,3326],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":130,"column":34,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":130,"endColumn":36,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[3657,3659],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { apiClient } from \"@/lib/api-client\";\n\nimport type { TimesheetEntry, TimesheetPayload, TimesheetSummaryResponse, TimesheetUpsertEntry } from \"./types\";\n\nexport async function bulkUpsertTimesheets(\n  employeeId: number,\n  entries: TimesheetUpsertEntry[] = [],\n  removeIds: number[] = []\n) {\n  const data = await apiClient.post<{ inserted: number; message?: string; removed: number; status: string }>(\n    \"/api/timesheets/bulk\",\n    {\n      employee_id: employeeId,\n      entries,\n      remove_ids: removeIds.length > 0 ? removeIds : undefined,\n    }\n  );\n\n  if (data.status !== \"ok\") {\n    throw new Error(data.message || \"Error al procesar registros\");\n  }\n  return data;\n}\n\nexport async function deleteTimesheet(id: number) {\n  const data = await apiClient.delete<{ message?: string; status: string }>(`/api/timesheets/${id}`);\n\n  if (data.status !== \"ok\") {\n    throw new Error(data.message || \"Error al eliminar registro\");\n  }\n}\n\nexport async function fetchImageBlob(url: string) {\n  return apiClient.get<Blob>(url, { responseType: \"blob\" });\n}\n\nexport async function fetchTimesheetDetail(employeeId: number, month: string) {\n  const data = await apiClient.get<{\n    entries: TimesheetEntry[];\n    from: string;\n    message?: string;\n    status: string;\n    to: string;\n  }>(`/api/timesheets/${employeeId}/detail`, { query: { month } });\n\n  if (data.status !== \"ok\") {\n    throw new Error(data.message || \"Error al cargar detalle\");\n  }\n  return data;\n}\n\nexport async function fetchTimesheetMonths() {\n  const data = await apiClient.get<{ months: string[]; monthsWithData: string[]; status: string }>(\n    \"/api/timesheets/months\"\n  );\n  if (data.status !== \"ok\") {\n    throw new Error(\"No se pudieron cargar los meses\");\n  }\n  return {\n    months: data.months,\n    monthsWithData: new Set(data.monthsWithData || []),\n  };\n}\n\nexport async function fetchTimesheetSummary(month: string, employeeId?: null | number) {\n  const query: Record<string, string> = { month };\n  if (employeeId) query.employeeId = String(employeeId);\n\n  const data = await apiClient.get<TimesheetSummaryResponse & { message?: string; status: string }>(\n    \"/api/timesheets/summary\",\n    { query }\n  );\n\n  if (data.status !== \"ok\") {\n    throw new Error(data.message || \"Error al cargar resumen\");\n  }\n  return data;\n}\n\nexport async function prepareTimesheetEmail(payload: {\n  employeeEmail: string;\n  employeeId: number;\n  employeeName: string;\n  month: string;\n  monthLabel: string;\n  pdfBase64: string;\n  summary: {\n    net: number;\n    overtimeMinutes: number;\n    payDate: string;\n    retention: number;\n    retention_rate?: null | number;\n    retentionRate?: null | number;\n    role: string;\n    subtotal: number;\n    workedMinutes: number;\n  };\n}) {\n  const data = await apiClient.post<{ emlBase64: string; filename: string; message?: string; status: string }>(\n    \"/api/timesheets/prepare-email\",\n    payload\n  );\n\n  if (data.status !== \"ok\") {\n    throw new Error(data.message || \"Error al preparar el email\");\n  }\n\n  return data;\n}\n\nexport async function updateTimesheet(id: number, payload: Partial<TimesheetPayload>) {\n  const data = await apiClient.put<{ entry: TimesheetEntry; message?: string; status: string }>(\n    `/api/timesheets/${id}`,\n    payload\n  );\n\n  if (data.status !== \"ok\") {\n    throw new Error(data.message || \"Error al actualizar registro\");\n  }\n  return data.entry;\n}\n\nexport async function upsertTimesheet(payload: TimesheetPayload) {\n  const data = await apiClient.post<{ entry: TimesheetEntry; message?: string; status: string }>(\n    \"/api/timesheets\",\n    payload\n  );\n\n  if (data.status !== \"ok\") {\n    throw new Error(data.message || \"Error al guardar registro\");\n  }\n  return data.entry;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/timesheets/components/EmailPreviewModal.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":25,"column":43,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":34,"endColumn":26,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[852,874],"text":"Readonly<EmailPreviewModalProps>"},"desc":"Mark the props as read-only"}]},{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":61,"column":47,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":61,"endColumn":67},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":65,"column":50,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":65,"endColumn":52,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2328,2419],"text":"(summaryData.retentionRate as null | number) ?? (summaryData.retention_rate as null | number)"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":65,"column":99,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":65,"endColumn":101,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2421,2423],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { formatRetentionPercent, getEffectiveRetentionRate } from \"@shared/retention\";\nimport dayjs from \"dayjs\";\n\nimport type { Employee } from \"@/features/hr/employees/types\";\n\nimport Button from \"@/components/ui/Button\";\nimport { fmtCLP } from \"@/lib/format\";\nimport { LOADING_SPINNER_SM } from \"@/lib/styles\";\n\nimport type { TimesheetSummaryRow } from \"../types\";\n\nimport \"dayjs/locale/es\";\n\ninterface EmailPreviewModalProps {\n  employee: Employee | null;\n  isOpen: boolean;\n  month: string; // YYYY-MM format\n  monthLabel: string;\n  onClose: () => void;\n  onPrepare: () => void;\n  prepareStatus: null | string; // null | 'generating-pdf' | 'preparing' | 'done'\n  summary: null | TimesheetSummaryRow;\n}\n\nexport default function EmailPreviewModal({\n  employee,\n  isOpen,\n  month,\n  monthLabel,\n  onClose,\n  onPrepare,\n  prepareStatus,\n  summary,\n}: EmailPreviewModalProps) {\n  const isPreparing = prepareStatus !== null && prepareStatus !== \"done\";\n  if (!isOpen || !employee || !summary) return null;\n\n  const employeeEmail = employee.person?.email;\n\n  // Convertir mes a español\n  dayjs.locale(\"es\");\n  let monthLabelEs = monthLabel;\n  const monthRegex = /^(\\d{4})-(\\d{2})$/;\n  const monthMatch = monthRegex.exec(monthLabel);\n  if (monthMatch) {\n    monthLabelEs = dayjs(`${monthMatch[1]}-${monthMatch[2]}-01`).locale(\"es\").format(\"MMMM YYYY\");\n  } else if (dayjs(monthLabel, \"MMMM YYYY\", \"en\").isValid()) {\n    monthLabelEs = dayjs(monthLabel, \"MMMM YYYY\", \"en\").locale(\"es\").format(\"MMMM YYYY\");\n  }\n  monthLabelEs = monthLabelEs.charAt(0).toUpperCase() + monthLabelEs.slice(1);\n\n  // Usar datos ya calculados del backend - no recalcular\n  const totalMinutes = (summary.workedMinutes || 0) + (summary.overtimeMinutes || 0);\n  const totalHrs = Math.floor(totalMinutes / 60);\n  const totalMins = totalMinutes % 60;\n  const totalHoursFormatted = `${String(totalHrs).padStart(2, \"0\")}:${String(totalMins).padStart(2, \"0\")}`;\n\n  const boletaDescription = `SERVICIOS DE ${summary.role.toUpperCase()} ${totalHoursFormatted} HORAS`;\n\n  // Get year from month in YYYY-MM format\n  const summaryYear = month ? Number.parseInt(month.split(\"-\")[0]!, 10) : new Date().getFullYear();\n  // Handle both camelCase and snake_case from backend\n  const summaryData = summary as unknown as Record<string, unknown>;\n  const employeeRate =\n    (summaryData.retentionRate as null | number) || (summaryData.retention_rate as null | number) || null;\n  const effectiveRate = getEffectiveRetentionRate(employeeRate, summaryYear);\n  const retentionPercent = formatRetentionPercent(effectiveRate);\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4\">\n      <div className=\"bg-base-100 w-full max-w-2xl rounded-2xl shadow-2xl\">\n        {/* Header */}\n        <div className=\"from-primary to-primary/80 text-primary-content rounded-t-2xl bg-linear-to-r px-6 py-5\">\n          <h2 className=\"text-xl font-bold\">Vista previa del correo</h2>\n          <p className=\"mt-1 text-sm opacity-90\">\n            Servicios de {summary.role} - {monthLabelEs}\n          </p>\n        </div>\n\n        {/* Content */}\n        <div className=\"max-h-[60vh] overflow-y-auto p-6\">\n          {/* Destinatario */}\n          <div className=\"bg-base-200/50 mb-4 rounded-xl p-4\">\n            <p className=\"text-base-content/70 text-sm\">\n              <strong>Para:</strong>{\" \"}\n              {employeeEmail ? (\n                <span className=\"text-base-content font-medium\">{employeeEmail}</span>\n              ) : (\n                <span className=\"text-error\">⚠️ Sin email registrado</span>\n              )}\n            </p>\n            <p className=\"text-base-content/70 mt-1 text-sm\">\n              <strong>Asunto:</strong>{\" \"}\n              <span className=\"text-base-content font-medium\">\n                Boleta de Honorarios - {monthLabelEs} - {employee.full_name}\n              </span>\n            </p>\n          </div>\n\n          {/* Preview del email - simula cómo se verá en el cliente de correo */}\n          <div className=\"border-base-300 bg-base-100 rounded-xl border p-5\">\n            <p className=\"text-base-content mb-4\">\n              Estimado/a <strong>{employee.full_name}</strong>,\n            </p>\n            <p className=\"text-base-content mb-4 text-sm\">\n              A continuación encontrarás el resumen de los servicios prestados durante el periodo{\" \"}\n              <strong>{monthLabelEs}</strong>, favor corroborar y emitir boleta de honorarios.\n            </p>\n\n            {/* Caja verde para la boleta */}\n            <div className=\"mb-4 rounded-lg border-2 border-green-500 bg-green-100 p-4\">\n              <p className=\"mb-3 text-xs font-semibold tracking-wider text-green-800 uppercase\">\n                📝 Para la boleta de honorarios\n              </p>\n              <div className=\"space-y-2\">\n                <div>\n                  <p className=\"mb-1 text-xs text-green-800\">Descripción:</p>\n                  <p className=\"font-mono text-sm font-bold text-green-800\">{boletaDescription}</p>\n                </div>\n                <div>\n                  <p className=\"mb-1 text-xs text-green-800\">Monto Bruto:</p>\n                  <p className=\"font-mono text-xl font-bold text-green-800\">{fmtCLP(summary.subtotal)}</p>\n                </div>\n              </div>\n            </div>\n\n            {/* Tabla resumen (Grid Layout) */}\n            <div className=\"mb-4 w-full text-sm\">\n              <div className=\"bg-base-200 grid grid-cols-[1fr_auto] gap-x-3 px-3 py-2 text-xs font-semibold uppercase\">\n                <div className=\"text-base-content/70\">Concepto</div>\n                <div className=\"text-base-content/70 text-right\">Detalle</div>\n              </div>\n\n              <div className=\"divide-base-300 border-base-300 divide-y border-x border-b\">\n                <div className=\"grid grid-cols-[1fr_auto] gap-x-3 px-3 py-3\">\n                  <div className=\"text-base-content\">Horas totales</div>\n                  <div className=\"text-base-content text-right font-mono\">{totalHoursFormatted}</div>\n                </div>\n                <div className=\"grid grid-cols-[1fr_auto] gap-x-3 px-3 py-3\">\n                  <div className=\"text-base-content\">Monto Bruto</div>\n                  <div className=\"text-base-content text-right font-mono\">{fmtCLP(summary.subtotal)}</div>\n                </div>\n                <div className=\"grid grid-cols-[1fr_auto] gap-x-3 px-3 py-3\">\n                  <div className=\"text-base-content\">Retención ({retentionPercent})</div>\n                  <div className=\"text-base-content text-right font-mono\">-{fmtCLP(summary.retention)}</div>\n                </div>\n                <div className=\"grid grid-cols-[1fr_auto] gap-x-3 bg-blue-700 px-3 py-3\">\n                  <div className=\"font-bold text-white\">Total Líquido</div>\n                  <div className=\"text-right font-mono font-bold text-white\">{fmtCLP(summary.net)}</div>\n                </div>\n              </div>\n            </div>\n\n            {/* Fecha de pago */}\n            <div className=\"rounded-lg border border-amber-500 bg-amber-100 p-3 text-center text-sm\">\n              <strong className=\"text-amber-800\">📅 Fecha de pago estimada: {summary.payDate}</strong>\n            </div>\n\n            {/* Nota de adjunto */}\n            <div className=\"mt-3 rounded-lg border border-sky-500 bg-sky-100 p-3 text-sm text-sky-700\">\n              <strong>📎 Adjunto:</strong> Se incluye el documento PDF con el detalle completo de horas trabajadas.\n            </div>\n          </div>\n        </div>\n\n        {/* Footer */}\n        <div className=\"border-base-300 flex items-center justify-between border-t px-6 py-4\">\n          <p className=\"text-base-content/50 text-xs\">\n            {prepareStatus === \"generating-pdf\" && \"Generando documento PDF...\"}\n            {prepareStatus === \"preparing\" && \"Preparando archivo de email...\"}\n            {prepareStatus === \"done\" && \"✅ Archivo descargado - Ábrelo con doble click y presiona Enviar\"}\n            {!prepareStatus && \"Se descargará un archivo .eml que puedes abrir con Outlook.\"}\n          </p>\n          <div className=\"flex gap-3\">\n            <Button disabled={isPreparing} onClick={onClose} variant=\"secondary\">\n              {prepareStatus === \"done\" ? \"Cerrar\" : \"Cancelar\"}\n            </Button>\n            <Button\n              className=\"min-w-44\"\n              disabled={isPreparing || !employeeEmail || prepareStatus === \"done\"}\n              onClick={onPrepare}\n              variant=\"primary\"\n            >\n              {(() => {\n                if (prepareStatus === \"generating-pdf\") {\n                  return (\n                    <span className=\"flex items-center gap-2\">\n                      <span className={LOADING_SPINNER_SM}></span>\n                      Generando PDF...\n                    </span>\n                  );\n                }\n                if (prepareStatus === \"preparing\") {\n                  return (\n                    <span className=\"flex items-center gap-2\">\n                      <span className={LOADING_SPINNER_SM}></span>\n                      Preparando...\n                    </span>\n                  );\n                }\n                if (prepareStatus === \"done\") {\n                  return (\n                    <span className=\"flex items-center gap-2\">\n                      <span>📧</span>\n                      Descargado\n                    </span>\n                  );\n                }\n                return <>Preparar Email</>;\n              })()}\n            </Button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/timesheets/components/TimesheetDetailColumns.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Move your component(s) to a separate file.","line":27,"column":7,"nodeType":"Identifier","messageId":"localComponents","endLine":27,"endColumn":15},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":41,"column":10,"nodeType":"MemberExpression","endLine":41,"endColumn":24},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Move your component(s) to a separate file.","line":47,"column":7,"nodeType":"Identifier","messageId":"localComponents","endLine":47,"endColumn":16},{"ruleId":"@typescript-eslint/no-confusing-void-expression","severity":2,"message":"Returning a void expression from an arrow function shorthand is forbidden. Please add braces to the arrow function.","line":67,"column":45,"nodeType":"CallExpression","messageId":"invalidVoidExprArrow","endLine":67,"endColumn":69},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":72,"column":16,"nodeType":"MemberExpression","endLine":72,"endColumn":26},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Move your component(s) to a separate file.","line":78,"column":7,"nodeType":"Identifier","messageId":"localComponents","endLine":78,"endColumn":17},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Move your component(s) to a separate file.","line":86,"column":7,"nodeType":"Identifier","messageId":"localComponents","endLine":86,"endColumn":19},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":94,"column":20,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":94,"endColumn":22,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[3337,3339],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Move your component(s) to a separate file.","line":131,"column":7,"nodeType":"Identifier","messageId":"localComponents","endLine":131,"endColumn":17},{"ruleId":"security/detect-object-injection","severity":1,"message":"Variable Assigned to Object Injection Sink","line":132,"column":19,"nodeType":"MemberExpression","endLine":132,"endColumn":42},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":151,"column":41,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":151,"endColumn":43,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[4992,4994],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Move your component(s) to a separate file.","line":187,"column":7,"nodeType":"Identifier","messageId":"localComponents","endLine":187,"endColumn":18},{"ruleId":"security/detect-object-injection","severity":1,"message":"Variable Assigned to Object Injection Sink","line":190,"column":19,"nodeType":"MemberExpression","endLine":190,"endColumn":42}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createColumnHelper } from \"@tanstack/react-table\";\nimport dayjs from \"dayjs\";\n\nimport Button from \"@/components/ui/Button\";\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from \"@/components/ui/DropdownMenu\";\nimport TimeInput from \"@/components/ui/TimeInput\";\n\nimport type { BulkRow } from \"../types\";\n\nimport { calculateWorkedMinutes, computeStatus, formatDateLabel, isRowDirty, minutesToDuration } from \"../utils\";\n\nexport interface TimesheetTableMeta {\n  canEdit: boolean;\n  initialRows: BulkRow[];\n  notWorkedDays: Set<string>;\n  onCloseOvertime: (date: string) => void;\n  onOpenOvertime: (date: string) => void;\n  onRemoveEntry: (row: BulkRow) => void;\n  onResetRow: (index: number) => void;\n  onRowChange: (index: number, field: keyof Omit<BulkRow, \"date\" | \"entryId\">, value: string) => void;\n  onSalidaBlur: (index: number) => void;\n  openOvertimeEditors: Set<string>;\n  setCommentPreview: (data: null | { date: string; text: string }) => void;\n  setNotWorkedDays: (cb: (prev: Set<string>) => Set<string>) => void;\n}\n\nconst DateCell = ({ meta, row }: { meta: TimesheetTableMeta; row: BulkRow }) => {\n  const dayIdx = dayjs(row.date).day();\n  const labels = [\"Dom\", \"Lun\", \"Mar\", \"Mié\", \"Jue\", \"Vie\", \"Sáb\"];\n  const isSun = dayIdx === 0;\n  const isMarkedNotWorked = meta.notWorkedDays.has(row.date);\n\n  return (\n    <div className={`flex items-center gap-2 ${isMarkedNotWorked ? \"opacity-60\" : \"\"}`}>\n      <span className=\"text-base-content/70 whitespace-nowrap\">{formatDateLabel(row.date)}</span>\n      <span\n        className={`rounded px-1.5 py-0.5 text-xs font-semibold uppercase ${\n          isSun ? \"bg-base-300 text-base-content/50\" : \"bg-base-200 text-base-content/60\"\n        }`}\n      >\n        {labels[dayIdx]}\n      </span>\n    </div>\n  );\n};\n\nconst InputCell = ({\n  field,\n  index,\n  meta,\n  row,\n}: {\n  field: \"entrada\" | \"salida\";\n  index: number;\n  meta: TimesheetTableMeta;\n  row: BulkRow;\n}) => {\n  const isSunday = dayjs(row.date).day() === 0;\n  const canEditRow = meta.canEdit && !isSunday;\n  const isMarkedNotWorked = meta.notWorkedDays.has(row.date);\n\n  return (\n    <div className={isMarkedNotWorked ? \"pointer-events-none opacity-60\" : \"\"}>\n      <TimeInput\n        className=\"w-28\"\n        disabled={!canEditRow}\n        onBlur={() => field === \"salida\" && meta.onSalidaBlur(index)}\n        onChange={(value) => {\n          meta.onRowChange(index, field, value);\n        }}\n        placeholder=\"HH:MM\"\n        value={row[field]}\n      />\n    </div>\n  );\n};\n\nconst WorkedCell = ({ meta, row }: { meta: TimesheetTableMeta; row: BulkRow }) => {\n  const mins = calculateWorkedMinutes(row.entrada, row.salida);\n  const duration = minutesToDuration(mins);\n  const isMarkedNotWorked = meta.notWorkedDays.has(row.date);\n\n  return <div className={`text-base-content tabular-nums ${isMarkedNotWorked ? \"opacity-60\" : \"\"}`}>{duration}</div>;\n};\n\nconst OvertimeCell = ({ index, meta, row }: { index: number; meta: TimesheetTableMeta; row: BulkRow }) => {\n  const isSunday = dayjs(row.date).day() === 0;\n  const canEditRow = meta.canEdit && !isSunday;\n  const isMarkedNotWorked = meta.notWorkedDays.has(row.date);\n  const isOvertimeOpen = meta.openOvertimeEditors.has(row.date);\n\n  if (isMarkedNotWorked) return <span className=\"opacity-60\">—</span>;\n\n  if (!row.overtime?.trim() && !isOvertimeOpen) {\n    if (canEditRow) {\n      return (\n        <Button\n          aria-label=\"Agregar horas extra\"\n          className=\"border-base-300 bg-base-200 text-primary hover:bg-base-200 inline-flex h-8 w-8 items-center justify-center rounded-full border shadow\"\n          onClick={() => {\n            meta.onOpenOvertime(row.date);\n          }}\n          size=\"sm\"\n          title=\"Agregar horas extra\"\n          type=\"button\"\n          variant=\"secondary\"\n        >\n          +\n        </Button>\n      );\n    }\n    return <span className=\"text-base-content/50\">—</span>;\n  }\n\n  return (\n    <TimeInput\n      className=\"w-28\"\n      disabled={!canEditRow}\n      onChange={(value) => {\n        meta.onRowChange(index, \"overtime\", value);\n        if (!value.trim()) {\n          meta.onCloseOvertime(row.date);\n        }\n      }}\n      placeholder=\"HH:MM\"\n      value={row.overtime}\n    />\n  );\n};\n\nconst StatusCell = ({ index, meta, row }: { index: number; meta: TimesheetTableMeta; row: BulkRow }) => {\n  const initial = meta.initialRows[index];\n  const dirty = isRowDirty(row, initial);\n  const status = computeStatus(row, dirty);\n  const isMarkedNotWorked = meta.notWorkedDays.has(row.date);\n\n  // Warning Logic\n  const mins = calculateWorkedMinutes(row.entrada, row.salida);\n  const hours = mins / 60;\n  let showWarning = false;\n  let warningText = \"\";\n  if (row.entrada && row.salida) {\n    if (hours < 3) {\n      showWarning = true;\n      warningText = \"Turno muy corto (< 3h)\";\n    } else if (hours > 10) {\n      showWarning = true;\n      warningText = \"Turno muy largo (> 10h)\";\n    }\n  }\n  const hasComment = Boolean(row.comment?.trim());\n\n  const showBang = showWarning || hasComment;\n  const bangColor = showWarning ? \"text-error hover:text-error/80\" : \"text-primary hover:text-primary/80\";\n  const tooltipParts: string[] = [];\n  if (showWarning && warningText) tooltipParts.push(warningText);\n  if (hasComment) tooltipParts.push(`Comentario: ${row.comment.trim()}`);\n\n  const statusColor = (() => {\n    if (status === \"Registrado\") return \"text-success\";\n    if (status === \"Sin guardar\") return \"text-warning\";\n    return \"text-base-content/50\";\n  })();\n\n  return (\n    <div\n      className={`flex items-center gap-1 text-xs font-semibold tracking-wide uppercase ${statusColor} ${isMarkedNotWorked ? \"opacity-60\" : \"\"}`}\n    >\n      {status}\n      {showBang && (\n        <div className=\"group relative\">\n          <span className={`cursor-help font-bold ${bangColor}`}>!</span>\n          <div className=\"bg-neutral text-neutral-content invisible absolute bottom-full left-1/2 z-50 mb-2 max-w-xs -translate-x-1/2 rounded-lg px-3 py-2 text-xs font-normal tracking-normal whitespace-nowrap normal-case shadow-lg group-hover:visible\">\n            {tooltipParts.map((part, i) => (\n              <span className=\"block\" key={i}>\n                {part}\n              </span>\n            ))}\n            <span className=\"border-t-neutral absolute top-full left-1/2 h-0 w-0 -translate-x-1/2 border-t-4 border-r-4 border-l-4 border-transparent\"></span>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\nconst ActionsCell = ({ index, meta, row }: { index: number; meta: TimesheetTableMeta; row: BulkRow }) => {\n  const isSunday = dayjs(row.date).day() === 0;\n  const canEditRow = meta.canEdit && !isSunday;\n  const initial = meta.initialRows[index];\n  const dirty = isRowDirty(row, initial);\n  const isMarkedNotWorked = meta.notWorkedDays.has(row.date);\n\n  if (!canEditRow) return <span className=\"text-base-content/50 text-xs\">—</span>;\n\n  return (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button className=\"h-8 w-8 p-0\" size=\"sm\" variant=\"secondary\">\n          ⋯\n        </Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent align=\"end\">\n        <DropdownMenuItem\n          onClick={() => {\n            meta.setCommentPreview({ date: row.date, text: row.comment || \"(Sin comentario)\" });\n          }}\n        >\n          Ver comentario\n        </DropdownMenuItem>\n\n        {dirty && (\n          <DropdownMenuItem\n            onClick={() => {\n              meta.onResetRow(index);\n            }}\n          >\n            Deshacer cambios\n          </DropdownMenuItem>\n        )}\n\n        <DropdownMenuItem\n          onClick={() => {\n            meta.setNotWorkedDays((prev) => {\n              const next = new Set(prev);\n              if (next.has(row.date)) next.delete(row.date);\n              else next.add(row.date);\n              return next;\n            });\n          }}\n        >\n          {isMarkedNotWorked ? \"Marcar como trabajado\" : \"Día no trabajado\"}\n        </DropdownMenuItem>\n\n        {row.entryId && (\n          <DropdownMenuItem\n            className=\"text-error focus:text-error\"\n            onClick={() => {\n              meta.onRemoveEntry(row);\n            }}\n          >\n            Eliminar registro\n          </DropdownMenuItem>\n        )}\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n};\n\nconst columnHelper = createColumnHelper<BulkRow>();\n\nexport const getTimesheetDetailColumns = () => [\n  columnHelper.accessor(\"date\", {\n    cell: ({ row, table }) => <DateCell meta={table.options.meta as TimesheetTableMeta} row={row.original} />,\n    header: \"Fecha\",\n  }),\n  columnHelper.accessor(\"entrada\", {\n    cell: ({ row, table }) => (\n      <InputCell field=\"entrada\" index={row.index} meta={table.options.meta as TimesheetTableMeta} row={row.original} />\n    ),\n    header: \"Entrada\",\n  }),\n  columnHelper.accessor(\"salida\", {\n    cell: ({ row, table }) => (\n      <InputCell field=\"salida\" index={row.index} meta={table.options.meta as TimesheetTableMeta} row={row.original} />\n    ),\n    header: \"Salida\",\n  }),\n  columnHelper.display({\n    cell: ({ row, table }) => <WorkedCell meta={table.options.meta as TimesheetTableMeta} row={row.original} />,\n    header: \"Trabajadas\",\n    id: \"trabajadas\",\n  }),\n  columnHelper.accessor(\"overtime\", {\n    cell: ({ row, table }) => (\n      <OvertimeCell index={row.index} meta={table.options.meta as TimesheetTableMeta} row={row.original} />\n    ),\n    header: \"Extras\",\n  }),\n  columnHelper.display({\n    cell: ({ row, table }) => (\n      <StatusCell index={row.index} meta={table.options.meta as TimesheetTableMeta} row={row.original} />\n    ),\n    header: \"Estado\",\n    id: \"status\",\n  }),\n  columnHelper.display({\n    cell: ({ row, table }) => (\n      <ActionsCell index={row.index} meta={table.options.meta as TimesheetTableMeta} row={row.original} />\n    ),\n    header: \"Acciones\",\n    id: \"actions\",\n  }),\n];\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/timesheets/components/TimesheetDetailTable.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":32,"column":46,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":47,"endColumn":29,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[1267,1292],"text":"Readonly<TimesheetDetailTableProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\n\nimport type { Employee } from \"@/features/hr/employees/types\";\n\nimport { DataTable } from \"@/components/data-table/DataTable\";\nimport Button from \"@/components/ui/Button\";\nimport Modal from \"@/components/ui/Modal\";\nimport { useAuth } from \"@/context/AuthContext\";\n\nimport type { BulkRow } from \"../types\";\n\nimport { formatDateLabel } from \"../utils\";\nimport { getTimesheetDetailColumns, TimesheetTableMeta } from \"./TimesheetDetailColumns\";\n\ninterface TimesheetDetailTableProps {\n  bulkRows: BulkRow[];\n  employeeOptions: Employee[];\n  initialRows: BulkRow[];\n  loadingDetail: boolean;\n  modifiedCount: number;\n  monthLabel: string;\n  onBulkSave: () => void;\n  onRemoveEntry: (row: BulkRow) => void;\n  onResetRow: (index: number) => void;\n  onRowChange: (index: number, field: keyof Omit<BulkRow, \"date\" | \"entryId\">, value: string) => void;\n  onSalidaBlur: (index: number) => void;\n  pendingCount: number;\n  saving: boolean;\n  selectedEmployee: Employee | null;\n}\n\nexport default function TimesheetDetailTable({\n  bulkRows,\n  employeeOptions,\n  initialRows,\n  loadingDetail,\n  modifiedCount,\n  monthLabel,\n  onBulkSave,\n  onRemoveEntry,\n  onResetRow,\n  onRowChange,\n  onSalidaBlur,\n  pendingCount,\n  saving,\n  selectedEmployee,\n}: TimesheetDetailTableProps) {\n  const { can } = useAuth();\n  const canEdit = can(\"update\", \"Timesheet\");\n\n  const [openOvertimeEditors, setOpenOvertimeEditors] = useState<Set<string>>(new Set());\n  const [commentPreview, setCommentPreview] = useState<null | { date: string; text: string }>(null);\n  const [notWorkedDays, setNotWorkedDays] = useState<Set<string>>(new Set());\n\n  const columns = getTimesheetDetailColumns();\n\n  const meta: TimesheetTableMeta = {\n    canEdit,\n    initialRows,\n    notWorkedDays,\n    onCloseOvertime: (date) => {\n      setOpenOvertimeEditors((prev) => {\n        const next = new Set(prev);\n        next.delete(date);\n        return next;\n      });\n    },\n    onOpenOvertime: (date) => {\n      setOpenOvertimeEditors((prev) => {\n        const next = new Set(prev);\n        next.add(date);\n        return next;\n      });\n    },\n    onRemoveEntry,\n    onResetRow,\n    onRowChange,\n    onSalidaBlur,\n    openOvertimeEditors,\n    setCommentPreview,\n    setNotWorkedDays,\n  };\n\n  return (\n    <div className=\"bg-base-100 space-y-4 p-6\">\n      <div className=\"flex flex-wrap items-center justify-between gap-3\">\n        <div className=\"text-base-content/70 text-sm\">\n          <span className=\"font-semibold\">{monthLabel}</span>\n          {selectedEmployee && <span className=\"text-base-content/60 ml-2\">· {selectedEmployee.full_name}</span>}\n        </div>\n        {canEdit && (\n          <div className=\"flex items-center gap-2\">\n            <Button\n              disabled={saving || (pendingCount === 0 && modifiedCount === 0)}\n              onClick={onBulkSave}\n              variant=\"primary\"\n            >\n              Guardar cambios\n            </Button>\n            <div className=\"text-base-content/60 text-xs\">\n              {pendingCount > 0 && <span className=\"mr-2\">Pendientes: {pendingCount}</span>}\n              {modifiedCount > 0 && <span>Modificados: {modifiedCount}</span>}\n            </div>\n          </div>\n        )}\n      </div>\n\n      <div className=\"muted-scrollbar border-base-200 transform-gpu overflow-x-auto rounded-lg border\">\n        <DataTable\n          columns={columns}\n          data={bulkRows}\n          enableToolbar={false}\n          enableVirtualization={false}\n          isLoading={loadingDetail}\n          meta={meta}\n          noDataMessage={\n            employeeOptions.length > 0\n              ? \"Selecciona un trabajador para ver o editar sus horas.\"\n              : \"Registra a trabajadores activos para comenzar a cargar horas.\"\n          }\n        />\n      </div>\n\n      {/* Modal para ver comentario */}\n      <Modal\n        isOpen={Boolean(commentPreview)}\n        onClose={() => {\n          setCommentPreview(null);\n        }}\n        title={`Comentario · ${commentPreview ? formatDateLabel(commentPreview.date) : \"\"}`}\n      >\n        <p className=\"text-base-content whitespace-pre-wrap\">{commentPreview?.text}</p>\n      </Modal>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/timesheets/components/TimesheetEditor.tsx","messages":[{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":147,"column":62,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":147,"endColumn":64,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[5196,5198],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Variable Assigned to Object Injection Sink","line":175,"column":26,"nodeType":"MemberExpression","endLine":175,"endColumn":37},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":176,"column":26,"nodeType":"MemberExpression","endLine":176,"endColumn":43},{"ruleId":"security/detect-object-injection","severity":1,"message":"Variable Assigned to Object Injection Sink","line":184,"column":26,"nodeType":"MemberExpression","endLine":184,"endColumn":44},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":185,"column":23,"nodeType":"MemberExpression","endLine":185,"endColumn":34},{"ruleId":"security/detect-object-injection","severity":1,"message":"Variable Assigned to Object Injection Sink","line":194,"column":17,"nodeType":"MemberExpression","endLine":194,"endColumn":32},{"ruleId":"security/detect-object-injection","severity":1,"message":"Variable Assigned to Object Injection Sink","line":195,"column":21,"nodeType":"MemberExpression","endLine":195,"endColumn":39},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":198,"column":43,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":198,"endColumn":45,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[6908,6910],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":198,"column":74,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":198,"endColumn":76,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[6939,6941],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Variable Assigned to Object Injection Sink","line":289,"column":23,"nodeType":"MemberExpression","endLine":289,"endColumn":41},{"ruleId":"security/detect-object-injection","severity":1,"message":"Function Call Object Injection Sink","line":318,"column":73,"nodeType":"MemberExpression","endLine":318,"endColumn":91},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":355,"column":33,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":355,"endColumn":35,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[11568,11570],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMutation, useQueryClient, useSuspenseQuery } from \"@tanstack/react-query\";\nimport dayjs from \"dayjs\";\nimport { lazy, Suspense, useEffect, useState } from \"react\";\n\nimport type { BulkRow, TimesheetSummaryRow, TimesheetUpsertEntry } from \"@/features/hr/timesheets/types\";\n\nimport Alert from \"@/components/ui/Alert\";\nimport Button from \"@/components/ui/Button\";\nimport { useToast } from \"@/context/ToastContext\";\nimport {\n  bulkUpsertTimesheets,\n  deleteTimesheet,\n  fetchTimesheetDetail,\n  prepareTimesheetEmail,\n} from \"@/features/hr/timesheets/api\";\nimport EmailPreviewModal from \"@/features/hr/timesheets/components/EmailPreviewModal\";\nimport TimesheetDetailTable from \"@/features/hr/timesheets/components/TimesheetDetailTable\";\nimport { generateTimesheetPdfBase64 } from \"@/features/hr/timesheets/pdf-utils\";\nimport { buildBulkRows, formatDateLabel, hasRowData, isRowDirty, parseDuration } from \"@/features/hr/timesheets/utils\";\n\nimport type { Employee } from \"../../employees/types\";\n\nconst TimesheetExportPDF = lazy(() => import(\"@/features/hr/timesheets/components/TimesheetExportPDF\"));\n\ninterface TimesheetEditorProps {\n  readonly activeEmployees: Employee[];\n  readonly employeeId: number;\n  readonly month: string; // YYYY-MM\n  readonly monthLabel: string;\n  readonly selectedEmployee: Employee;\n  readonly summaryRow: null | TimesheetSummaryRow;\n}\n\nexport default function TimesheetEditor({\n  activeEmployees,\n  employeeId,\n  month,\n  monthLabel,\n  selectedEmployee,\n  summaryRow,\n}: TimesheetEditorProps) {\n  const queryClient = useQueryClient();\n  const { success: toastSuccess } = useToast();\n\n  const [bulkRows, setBulkRows] = useState<BulkRow[]>([]);\n  const [initialRows, setInitialRows] = useState<BulkRow[]>([]);\n  const [errorLocal, setErrorLocal] = useState<null | string>(null);\n\n  const [emailModalOpen, setEmailModalOpen] = useState(false);\n  const [emailPrepareStatus, setEmailPrepareStatus] = useState<null | string>(null);\n\n  // --- Query ---\n  const { data: detailData } = useSuspenseQuery({\n    queryFn: () => fetchTimesheetDetail(employeeId, formatMonthString(month)),\n    queryKey: [\"timesheet-detail\", employeeId, month],\n  });\n\n  // --- Sync State ---\n  useEffect(() => {\n    const rows = buildBulkRows(formatMonthString(month), detailData.entries);\n    setBulkRows(rows);\n    setInitialRows(rows);\n    setErrorLocal(null);\n  }, [detailData, month]);\n\n  // --- Mutations ---\n\n  const upsertMutation = useMutation({\n    mutationFn: async (args: { employeeId: number; entries: TimesheetUpsertEntry[]; removeIds: number[] }) => {\n      return bulkUpsertTimesheets(args.employeeId, args.entries, args.removeIds);\n    },\n    onError: (err) => {\n      const message = err instanceof Error ? err.message : \"Error al guardar\";\n      setErrorLocal(message);\n    },\n    onSuccess: () => {\n      void queryClient.invalidateQueries({ queryKey: [\"timesheet-detail\"] });\n      void queryClient.invalidateQueries({ queryKey: [\"timesheet-summary\"] });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (entryId: number) => {\n      return deleteTimesheet(entryId);\n    },\n    onError: (err) => {\n      setErrorLocal(err instanceof Error ? err.message : \"Error al eliminar\");\n    },\n    onSuccess: () => {\n      void queryClient.invalidateQueries({ queryKey: [\"timesheet-detail\"] });\n      void queryClient.invalidateQueries({ queryKey: [\"timesheet-summary\"] });\n      toastSuccess(\"Registro eliminado\");\n    },\n  });\n\n  // Email Mutation\n  const emailMutation = useMutation({\n    mutationFn: prepareTimesheetEmail,\n    onError: (err) => {\n      const message = err instanceof Error ? err.message : \"Error al preparar el email\";\n      setErrorLocal(message);\n      setEmailPrepareStatus(null);\n    },\n  });\n\n  // --- Handlers ---\n\n  const generatePdfBase64 = async (): Promise<null | string> => {\n    if (!summaryRow) return null;\n    return generateTimesheetPdfBase64(selectedEmployee, summaryRow, bulkRows, monthLabel);\n  };\n\n  async function handlePrepareEmail() {\n    if (!summaryRow || !month) return;\n    setEmailPrepareStatus(\"generating-pdf\");\n    setErrorLocal(null);\n\n    try {\n      const pdfBase64 = await generatePdfBase64();\n      if (!pdfBase64) throw new Error(\"No se pudo generar el PDF\");\n\n      setEmailPrepareStatus(\"preparing\");\n\n      const data = await emailMutation.mutateAsync({\n        employeeEmail: selectedEmployee.person?.email ?? \"\",\n        employeeId: selectedEmployee.id,\n        employeeName: selectedEmployee.full_name,\n        month,\n        monthLabel,\n        pdfBase64,\n        summary: {\n          net: summaryRow.net,\n          overtimeMinutes: summaryRow.overtimeMinutes,\n          payDate: summaryRow.payDate,\n          retention: summaryRow.retention,\n          retention_rate: (summaryRow as unknown as Record<string, unknown>).retention_rate as\n            | null\n            | number\n            | undefined, // Legacy support workaround\n          retentionRate: summaryRow.retentionRate,\n          role: summaryRow.role,\n          subtotal: summaryRow.subtotal,\n          workedMinutes: summaryRow.workedMinutes,\n        },\n      });\n\n      if (data.status !== \"ok\") throw new Error(data.message || \"Error al preparar el email\");\n\n      // Download .eml\n      const emlBlob = new Blob([Uint8Array.from(atob(data.emlBase64), (c) => c.codePointAt(0) ?? 0)], {\n        type: \"message/rfc822\",\n      });\n      const url = URL.createObjectURL(emlBlob);\n      const link = document.createElement(\"a\");\n      link.href = url;\n      link.download = data.filename;\n      document.body.append(link);\n      link.click();\n      link.remove();\n      URL.revokeObjectURL(url);\n\n      setEmailPrepareStatus(\"done\");\n      toastSuccess(`Archivo descargado: ${data.filename}`);\n    } catch (error_) {\n      if (!emailMutation.isError) {\n        const message = error_ instanceof Error ? error_.message : \"Error al preparar el email\";\n        setErrorLocal(message);\n        setEmailPrepareStatus(null);\n      }\n    }\n  }\n\n  const handleRowChange = (index: number, field: keyof Omit<BulkRow, \"date\" | \"entryId\">, value: string) => {\n    setBulkRows((prev) => {\n      const currentRow = prev[index];\n      if (!currentRow || currentRow[field] === value) return prev;\n      return prev.map((row, i) => (i === index ? { ...row, [field]: value } : row));\n    });\n  };\n\n  const handleResetRow = (index: number) => {\n    setBulkRows((prev) => {\n      const next = [...prev];\n      const initialRow = initialRows[index];\n      if (initialRow) next[index] = { ...initialRow };\n      return next;\n    });\n  };\n\n  const { isPending: isUpsertPending, mutateAsync: upsertMutate } = upsertMutation;\n\n  const saveRowImmediately = async (index: number) => {\n    if (isUpsertPending) return;\n    const row = bulkRows[index];\n    const initial = initialRows[index];\n    if (!row || !initial) return;\n\n    const isComplete = Boolean(row.entrada?.trim()) && Boolean(row.salida?.trim());\n    if (!isComplete || !isRowDirty(row, initial)) return;\n\n    if (row.entrada && !/^\\d{1,2}:\\d{2}$/.test(row.entrada)) return;\n    if (row.salida && !/^\\d{1,2}:\\d{2}$/.test(row.salida)) return;\n\n    const overtime = parseDuration(row.overtime);\n    if (overtime === null) return;\n\n    const comment = row.comment.trim() || null;\n    const entry = {\n      comment,\n      end_time: row.salida || null,\n      extra_amount: 0,\n      overtime_minutes: overtime,\n      start_time: row.entrada || null,\n      work_date: row.date,\n    };\n\n    try {\n      await upsertMutate({\n        employeeId,\n        entries: [entry],\n        removeIds: [],\n      });\n      toastSuccess(`Guardado: ${formatDateLabel(row.date)}`);\n    } catch {\n      // Handled in mutation\n    }\n  };\n\n  const handleSalidaBlur = (index: number) => {\n    setTimeout(() => {\n      void saveRowImmediately(index);\n    }, 100);\n  };\n\n  const { mutate: deleteMutate } = deleteMutation;\n\n  const handleRemoveEntry = (row: BulkRow) => {\n    if (!row.entryId) return;\n    if (!confirm(\"¿Eliminar el registro de este día?\")) return;\n    deleteMutate(row.entryId);\n  };\n\n  const processBulkRow = (\n    row: BulkRow,\n    initial: BulkRow\n  ): { entry?: TimesheetUpsertEntry; error?: string; removeId?: number } => {\n    if (!isRowDirty(row, initial)) return {};\n\n    if (row.entrada && !/^\\d{1,2}:\\d{2}$/.test(row.entrada)) {\n      return { error: `Hora de entrada inválida en ${formatDateLabel(row.date)}` };\n    }\n    if (row.salida && !/^\\d{1,2}:\\d{2}$/.test(row.salida)) {\n      return { error: `Hora de salida inválida en ${formatDateLabel(row.date)}` };\n    }\n\n    const overtime = parseDuration(row.overtime);\n    if (overtime === null) {\n      return { error: `Horas extra inválidas en ${formatDateLabel(row.date)}` };\n    }\n\n    const comment = row.comment.trim() || null;\n    const hasContent = Boolean(row.entrada) || Boolean(row.salida) || overtime > 0 || Boolean(comment);\n\n    if (!hasContent && row.entryId) {\n      return { removeId: row.entryId };\n    }\n\n    if (!hasContent) return {};\n\n    return {\n      entry: {\n        comment,\n        end_time: row.salida ? dayjs(`${row.date} ${row.salida}`).toISOString() : null,\n        extra_amount: 0,\n        overtime_minutes: overtime,\n        start_time: row.entrada ? dayjs(`${row.date} ${row.entrada}`).toISOString() : null,\n        work_date: row.date,\n      },\n    };\n  };\n\n  const handleBulkSave = async () => {\n    setErrorLocal(null);\n\n    const entries: TimesheetUpsertEntry[] = [];\n    const removeIds: number[] = [];\n\n    for (const [index, row] of bulkRows.entries()) {\n      const initial = initialRows[index];\n      if (!initial) continue;\n      const result = processBulkRow(row, initial);\n      if (result.error) {\n        setErrorLocal(result.error);\n        return;\n      }\n      if (result.entry) entries.push(result.entry);\n      if (result.removeId) removeIds.push(result.removeId);\n    }\n\n    if (entries.length === 0 && removeIds.length === 0) {\n      toastSuccess(\"No hay cambios para guardar\");\n      return;\n    }\n\n    try {\n      await upsertMutate({\n        employeeId,\n        entries,\n        removeIds,\n      });\n      toastSuccess(\"Cambios guardados correctamente\");\n    } catch {\n      // Handled in mutation\n    }\n  };\n\n  const pendingCount = bulkRows.filter((row) => !row.entryId && hasRowData(row)).length;\n  const modifiedCount = bulkRows.filter((row, index) => isRowDirty(row, initialRows[index])).length;\n\n  return (\n    <>\n      <div className=\"mb-4 flex justify-end gap-2\">\n        <Button\n          className=\"gap-2\"\n          disabled={!summaryRow || !selectedEmployee.person?.email}\n          onClick={() => {\n            setEmailModalOpen(true);\n            setEmailPrepareStatus(null);\n          }}\n          title={\n            selectedEmployee.person?.email\n              ? \"Preparar boleta para enviar por email\"\n              : \"El empleado no tiene email registrado\"\n          }\n          type=\"button\"\n          variant=\"secondary\"\n        >\n          ✉️ Preparar email\n        </Button>\n        <Suspense\n          fallback={\n            <div className=\"flex items-center gap-2\">\n              <Button className=\"bg-primary/70 cursor-wait\" disabled variant=\"primary\">\n                Cargando exportador...\n              </Button>\n            </div>\n          }\n        >\n          <TimesheetExportPDF\n            bulkRows={bulkRows}\n            columns={[\"date\", \"entrada\", \"salida\", \"worked\", \"overtime\"]}\n            employee={selectedEmployee}\n            logoUrl={\"/logo.png\"}\n            monthLabel={monthLabel}\n            summary={summaryRow || null}\n          />\n        </Suspense>\n      </div>\n\n      {errorLocal && <Alert variant=\"error\">{errorLocal}</Alert>}\n\n      <TimesheetDetailTable\n        bulkRows={bulkRows}\n        employeeOptions={activeEmployees}\n        initialRows={initialRows}\n        loadingDetail={false}\n        modifiedCount={modifiedCount}\n        monthLabel={monthLabel}\n        onBulkSave={handleBulkSave}\n        onRemoveEntry={handleRemoveEntry}\n        onResetRow={handleResetRow}\n        onRowChange={handleRowChange}\n        onSalidaBlur={handleSalidaBlur}\n        pendingCount={pendingCount}\n        saving={upsertMutation.isPending}\n        selectedEmployee={selectedEmployee}\n      />\n\n      <EmailPreviewModal\n        employee={selectedEmployee}\n        isOpen={emailModalOpen}\n        month={month}\n        monthLabel={monthLabel}\n        onClose={() => {\n          setEmailModalOpen(false);\n          setEmailPrepareStatus(null);\n        }}\n        onPrepare={handlePrepareEmail}\n        prepareStatus={emailPrepareStatus}\n        summary={summaryRow ?? null}\n      />\n    </>\n  );\n}\n\n// Utility to ensure month is always YYYY-MM\nfunction formatMonthString(m: string): string {\n  if (/^\\d{4}-\\d{2}$/.test(m)) return m;\n  const d = dayjs(m, [\"YYYY-MM\", \"YYYY/MM\", \"MM/YYYY\", \"YYYY-MM-DD\", \"DD/MM/YYYY\"]);\n  if (d.isValid()) return d.format(\"YYYY-MM\");\n  return dayjs().format(\"YYYY-MM\");\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/timesheets/components/TimesheetExportPDF.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":65,"column":44,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":72,"endColumn":27,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[1870,1893],"text":"Readonly<TimesheetExportPDFProps>"},"desc":"Mark the props as read-only"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":86,"column":25,"nodeType":"MemberExpression","messageId":"neverNullish","endLine":86,"endColumn":48},{"ruleId":"sonarjs/cognitive-complexity","severity":2,"message":"Refactor this function to reduce its Cognitive Complexity from 20 to the 15 allowed.","line":102,"column":18,"nodeType":null,"messageId":"refactorFunction","endLine":102,"endColumn":30},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??=`) instead of an assignment expression, as it is simpler to read.","line":117,"column":7,"nodeType":"IfStatement","messageId":"preferNullishOverAssignment","endLine":117,"endColumn":72,"suggestions":[{"messageId":"suggestNullish","data":{"equals":"="},"fix":{"range":[3599,3664],"text":"logoDataUrl ??= await loadLogoAsPng(\"/logo.png\");"},"desc":"Fix to nullish coalescing operator (`??=`)."}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":164,"column":38,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":164,"endColumn":40,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[5938,5940],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":165,"column":32,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":165,"endColumn":34,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[6012,6014],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":165,"column":46,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":165,"endColumn":48,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[6026,6028],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":256,"column":18,"nodeType":"MemberExpression","endLine":256,"endColumn":36},{"ruleId":"@typescript-eslint/no-unnecessary-type-conversion","severity":2,"message":"Calling a string's .toString() method does not change the type or value of the string.","line":317,"column":6,"nodeType":null,"messageId":"unnecessaryTypeConversion","endLine":317,"endColumn":16,"suggestions":[{"messageId":"suggestRemove","fix":{"range":[11417,11462],"text":"String(Math.floor(diff / 60))"},"desc":"Remove the type conversion."},{"messageId":"suggestSatisfies","data":{"type":"string"},"fix":{"range":[11417,11462],"text":"(String(Math.floor(diff / 60)) satisfies string)"},"desc":"Instead, assert that the value satisfies the string type."}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":380,"column":31,"nodeType":"MemberExpression","messageId":"neverNullish","endLine":380,"endColumn":40},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":380,"column":31,"nodeType":"MemberExpression","endLine":380,"endColumn":40},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":390,"column":25,"nodeType":"MemberExpression","endLine":390,"endColumn":45},{"ruleId":"@typescript-eslint/return-await","severity":2,"message":"Returning an awaited promise is required in this context.","line":508,"column":14,"nodeType":"CallExpression","messageId":"requiredPromiseAwait","endLine":508,"endColumn":33,"suggestions":[{"messageId":"requiredPromiseAwaitSuggestion","fix":{"range":[17232,17232],"text":"await "},"desc":"Add `await` before the expression. Use caution as this may impact control flow."}]}],"suppressedMessages":[],"errorCount":10,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { formatRetentionPercent } from \"@shared/retention\";\nimport dayjs from \"dayjs\";\nimport type { CellHookData } from \"jspdf-autotable\";\nimport React from \"react\";\n\nimport type { Employee } from \"@/features/hr/employees/types\";\n\nimport Button from \"@/components/ui/Button\";\nimport Checkbox from \"@/components/ui/Checkbox\";\nimport { useSettings } from \"@/context/SettingsContext\";\nimport { apiClient } from \"@/lib/api-client\";\nimport { fmtCLP } from \"@/lib/format\";\n\nimport type { BulkRow, TimesheetSummaryRow } from \"../types\";\n\nimport \"dayjs/locale/es\";\n\ntype TimesheetColumnKey = \"date\" | \"entrada\" | \"overtime\" | \"salida\" | \"worked\";\n\nconst assertUnreachable = (value: never): never => {\n  throw new Error(`Unhandled column key: ${String(value)}`);\n};\n\ninterface TimesheetExportPDFProps {\n  bulkRows: BulkRow[];\n  columns: TimesheetColumnKey[];\n  employee: Employee;\n  logoUrl: string;\n  monthLabel: string;\n  summary: null | TimesheetSummaryRow;\n}\n\nconst COLUMN_LABELS: Record<TimesheetColumnKey, string> = {\n  date: \"Fecha\",\n  entrada: \"Entrada\",\n  overtime: \"Extras\",\n  salida: \"Salida\",\n  worked: \"Trabajadas\",\n};\n\ntype AutoTableFactory = typeof import(\"jspdf-autotable\");\ninterface DetailTableProps {\n  autoTable: AutoTableFactory[\"default\"];\n  bulkRows: BulkRow[];\n  defaultCols: readonly TimesheetColumnKey[];\n  doc: import(\"jspdf\").default;\n  labels: Record<TimesheetColumnKey, string>;\n  margin: number;\n  pageWidth: number;\n  selectedCols: TimesheetColumnKey[];\n  startY: number;\n}\n\ntype JsPdfFactory = typeof import(\"jspdf\");\n\ninterface SummaryTableProps {\n  autoTable: AutoTableFactory[\"default\"];\n  doc: import(\"jspdf\").default;\n  infoStartY: number;\n  margin: number;\n  pageWidth: number;\n  summary: null | TimesheetSummaryRow;\n}\n\nexport default function TimesheetExportPDF({\n  bulkRows,\n  columns,\n  employee,\n  logoUrl,\n  monthLabel,\n  summary,\n}: TimesheetExportPDFProps) {\n  const { settings } = useSettings();\n  const defaultCols: readonly TimesheetColumnKey[] = [\"date\", \"entrada\", \"salida\", \"worked\", \"overtime\"];\n  const [selectedCols, setSelectedCols] = React.useState<TimesheetColumnKey[]>(\n    columns.length > 0 ? columns : [...defaultCols]\n  );\n  const [showOptions, setShowOptions] = React.useState(false);\n  const pdfLibsRef = React.useRef<null | { autoTable: AutoTableFactory[\"default\"]; jsPDF: JsPdfFactory[\"default\"] }>(\n    null\n  );\n\n  async function loadPdfLibs() {\n    if (!pdfLibsRef.current) {\n      const [{ default: jsPDF }, autoTableModule] = await Promise.all([import(\"jspdf\"), import(\"jspdf-autotable\")]);\n      const autoTable = autoTableModule.default ?? autoTableModule;\n      pdfLibsRef.current = { autoTable, jsPDF };\n    }\n    return pdfLibsRef.current;\n  }\n\n  interface JsPdfPageSize {\n    getWidth?: () => number;\n    width?: number;\n  }\n\n  interface JsPdfInternal {\n    getPageSize?: () => JsPdfPageSize;\n    pageSize?: JsPdfPageSize;\n  }\n\n  async function handleExport(preview = true) {\n    try {\n      const libs = await loadPdfLibs();\n      const { autoTable, jsPDF } = libs;\n      const doc = new jsPDF();\n      const internal = (doc as unknown as { internal?: JsPdfInternal }).internal ?? {};\n      const pageSize = internal.pageSize ?? internal.getPageSize?.();\n      const pageWidth: number =\n        typeof pageSize?.getWidth === \"function\" ? pageSize.getWidth() : (pageSize?.width ?? 210);\n      const margin = 10;\n\n      // Logo (mantener proporción)\n      const resolvedLogo = settings.logoUrl || logoUrl;\n      let logoDataUrl: null | string = null;\n      if (resolvedLogo) logoDataUrl = await loadLogoAsPng(resolvedLogo);\n      if (!logoDataUrl) logoDataUrl = await loadLogoAsPng(\"/logo.png\");\n\n      const headerTopY = margin + 2;\n      let logoBottomY = headerTopY;\n      const dims = await getLogoDimensions(logoDataUrl);\n      if (dims && logoDataUrl) {\n        doc.addImage(logoDataUrl, \"PNG\", margin, headerTopY, dims.w, dims.h);\n        logoBottomY = headerTopY + dims.h;\n      }\n\n      // Encabezado a la derecha (título + datos organización)\n      const orgName = settings.orgName || \"Bioalergia\";\n      const orgAddress = settings.orgAddress || \"\";\n      const orgPhone = settings.orgPhone || \"\";\n      doc.setFontSize(11);\n      doc.setFont(\"helvetica\", \"bold\");\n      doc.text(\"Honorarios por servicios prestados\", pageWidth - margin, headerTopY + 2, { align: \"right\" });\n      doc.setFont(\"helvetica\", \"normal\");\n      doc.setFontSize(9);\n      const rightLines = [orgName, orgAddress, orgPhone ? `Tel: ${orgPhone}` : null].filter(Boolean) as string[];\n      let rightY = headerTopY + 8;\n      for (const line of rightLines) {\n        doc.text(line, pageWidth - margin, rightY, { align: \"right\" });\n        rightY += 5;\n      }\n\n      // Info de trabajador y periodo - forzar español\n      dayjs.locale(\"es\");\n      // monthLabel puede venir como \"November 2025\" o \"2025-11\", convertir a español\n      let periodEs = monthLabel;\n      const monthMatch = /^(\\d{4})-(\\d{2})$/.exec(monthLabel);\n      if (monthMatch) {\n        // Formato YYYY-MM\n        periodEs = dayjs(`${monthMatch[1]}-${monthMatch[2]}-01`).locale(\"es\").format(\"MMMM YYYY\");\n      } else if (dayjs(monthLabel, \"MMMM YYYY\", \"en\").isValid()) {\n        // Formato inglés \"November 2025\"\n        periodEs = dayjs(monthLabel, \"MMMM YYYY\", \"en\").locale(\"es\").format(\"MMMM YYYY\");\n      } else if (dayjs(monthLabel, \"MMMM YYYY\", \"es\").isValid()) {\n        // Ya está en español\n        periodEs = dayjs(monthLabel, \"MMMM YYYY\", \"es\").locale(\"es\").format(\"MMMM YYYY\");\n      }\n      // Capitalizar primera letra\n      periodEs = periodEs.charAt(0).toUpperCase() + periodEs.slice(1);\n      // Usar payDate del summary (ya calculado en el backend) en lugar de recalcular\n      const payDateFormatted = summary?.payDate ? dayjs(summary.payDate).format(\"DD-MM-YYYY\") : null;\n      const infoStartY = Math.max(logoBottomY, rightY) + 6;\n      doc.setFontSize(10);\n      doc.text(`Prestador: ${employee?.full_name || \"-\"}`, margin, infoStartY);\n      doc.text(`RUT: ${employee?.person?.rut || \"-\"}`, margin, infoStartY + 6);\n      doc.text(`Periodo: ${periodEs}`, pageWidth - margin, infoStartY, { align: \"right\" });\n      if (payDateFormatted) {\n        doc.text(`Fecha de pago: ${payDateFormatted}`, pageWidth - margin, infoStartY + 6, {\n          align: \"right\",\n        });\n      }\n      const net = typeof summary?.net === \"number\" ? summary.net : 0;\n      doc.setFont(\"helvetica\", \"bold\");\n      doc.text(`Total líquido: ${fmtCLP(net)}`, margin, infoStartY + 14);\n      doc.setFont(\"helvetica\", \"normal\");\n\n      // Tabla de RESUMEN\n      drawSummaryTable({ autoTable, doc, infoStartY, margin, pageWidth, summary });\n\n      // Tabla de DETALLE\n      const lastTableReference = doc as unknown as { lastAutoTable?: { finalY: number } };\n      const lastAutoTable = lastTableReference.lastAutoTable;\n      const nextY = lastAutoTable ? lastAutoTable.finalY + 8 : infoStartY + 30;\n\n      drawDetailTable({\n        autoTable,\n        bulkRows,\n        defaultCols,\n        doc,\n        labels: COLUMN_LABELS,\n        margin,\n        pageWidth,\n        selectedCols,\n        startY: nextY,\n      });\n\n      // Guardar / previsualizar\n      const safeName = (employee.full_name || \"Trabajador\").replaceAll(/[^a-zA-Z0-9_\\- ]/g, \"\");\n      if (preview) {\n        const pdfDataUri = doc.output(\"dataurlstring\");\n        const previewWindow = window.open(\"\", \"_blank\", \"noopener,noreferrer\");\n        if (previewWindow) {\n          previewWindow.opener = null;\n          previewWindow.location.href = pdfDataUri;\n        } else {\n          alert(\"No se pudo abrir la vista previa. Revisa si el navegador bloqueó las ventanas emergentes.\");\n        }\n      } else {\n        doc.save(`Honorarios_${safeName}_${monthLabel}.pdf`);\n      }\n    } catch (error: unknown) {\n      console.error(\"Export PDF error:\", error);\n      alert(\"No se pudo generar el PDF. Revisa la consola para más detalles.\");\n    }\n  }\n\n  return (\n    <div className=\"flex items-center gap-2\">\n      <div className=\"relative inline-block\">\n        <Button\n          className=\"text-primary-content bg-primary hover:bg-primary/85 focus-visible:outline-primary/35 rounded-xl px-4 py-2 text-sm font-semibold shadow-md focus-visible:outline-2 focus-visible:outline-offset-2\"\n          onClick={() => handleExport(true)}\n          type=\"button\"\n          variant=\"primary\"\n        >\n          Exportar PDF\n        </Button>\n        <Button\n          className=\"border-base-300 bg-base-100 text-primary hover:bg-base-100/90 ml-1 inline-flex h-9 w-9 items-center justify-center rounded-xl border shadow\"\n          onClick={() => {\n            setShowOptions((v) => !v);\n          }}\n          size=\"sm\"\n          title=\"Opciones\"\n          type=\"button\"\n          variant=\"secondary\"\n        >\n          ⋯\n        </Button>\n        {showOptions && (\n          <div className=\"bg-base-100 absolute right-0 z-20 mt-2 w-56 rounded-xl p-3 shadow-xl ring-1 ring-black/5\">\n            <p className=\"text-base-content/80 mb-2 text-xs font-semibold\">Columnas del detalle</p>\n            {[...defaultCols].map((key) => (\n              <label className=\"text-base-content mb-1 flex items-center gap-2 text-sm\" key={key}>\n                <Checkbox\n                  checked={selectedCols.includes(key)}\n                  onChange={(e) => {\n                    setSelectedCols((prev) => {\n                      const set = new Set<TimesheetColumnKey>(prev);\n                      if (e.target.checked) set.add(key);\n                      else set.delete(key);\n                      return [...set];\n                    });\n                  }}\n                />\n                {COLUMN_LABELS[key] || key}\n              </label>\n            ))}\n            <div className=\"mt-3 flex justify-end gap-2\">\n              <Button\n                className=\"text-base-content/60 hover:text-base-content text-xs\"\n                onClick={() => {\n                  setShowOptions(false);\n                }}\n                size=\"sm\"\n                variant=\"secondary\"\n              >\n                Cerrar\n              </Button>\n              <Button\n                className=\"text-primary text-xs hover:underline\"\n                onClick={() => handleExport(true)}\n                size=\"sm\"\n                variant=\"secondary\"\n              >\n                Vista previa\n              </Button>\n              <Button\n                className=\"text-primary text-xs hover:underline\"\n                onClick={() => handleExport(false)}\n                size=\"sm\"\n                variant=\"secondary\"\n              >\n                Descargar\n              </Button>\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\n// Helper: Cargar logo y normalizarlo a PNG (evitar \"wrong PNG signature\")\nfunction blobToDataUrl(blob: Blob): Promise<null | string> {\n  return new Promise((resolve) => {\n    const reader = new FileReader();\n    reader.addEventListener(\"load\", () => {\n      resolve(reader.result as string);\n    });\n    reader.addEventListener(\"error\", () => {\n      resolve(null);\n    });\n    reader.readAsDataURL(blob);\n  });\n}\n\n// === NEW EXTRACTED HELPERS ===\n\nfunction computeWorked(entrada?: string, salida?: string): string {\n  const s = timeToMinutes(entrada);\n  const e = timeToMinutes(salida);\n  if (s == null || e == null) return \"\";\n  let diff = e - s;\n  if (diff < 0) diff += 24 * 60;\n  const hh = String(Math.floor(diff / 60))\n    .toString()\n    .padStart(2, \"0\");\n  const mm = String(diff % 60).padStart(2, \"0\");\n  return `${hh}:${mm}`;\n}\n\nfunction drawDetailTable({\n  autoTable,\n  bulkRows,\n  defaultCols,\n  doc,\n  labels,\n  margin,\n  pageWidth,\n  selectedCols,\n  startY,\n}: DetailTableProps) {\n  const hasAnyOvertime = bulkRows.some((row) => row.overtime && row.overtime !== \"0:00\" && row.overtime !== \"00:00\");\n  const baseColKeys: TimesheetColumnKey[] = selectedCols.length > 0 ? selectedCols : [...defaultCols];\n  const colKeys: TimesheetColumnKey[] = hasAnyOvertime ? baseColKeys : baseColKeys.filter((k) => k !== \"overtime\");\n\n  const workedRows = bulkRows.filter((row) => row.entrada || row.salida);\n\n  const body = workedRows.map((row) =>\n    colKeys.map((key): string => {\n      switch (key) {\n        case \"date\": {\n          return dayjs(row.date).isValid() ? dayjs(row.date).format(\"DD-MM-YYYY\") : row.date;\n        }\n        case \"entrada\": {\n          return row.entrada || \"-\";\n        }\n        case \"overtime\": {\n          return row.overtime || \"-\";\n        }\n        case \"salida\": {\n          return row.salida || \"-\";\n        }\n        case \"worked\": {\n          return computeWorked(row.entrada, row.salida) || \"-\";\n        }\n        default: {\n          return assertUnreachable(key);\n        }\n      }\n    })\n  );\n\n  if (body.length === 0) {\n    doc.setFontSize(11);\n    doc.text(\"Sin registros para este periodo.\", margin, startY);\n    return;\n  }\n\n  autoTable(doc, {\n    body,\n    columnStyles: {\n      0: { halign: \"center\" },\n      1: { halign: \"center\" },\n      2: { halign: \"center\" },\n      3: { halign: \"center\" },\n      4: { halign: \"center\" },\n    },\n    head: [colKeys.map((k) => labels[k] ?? k.toUpperCase())],\n    headStyles: { fillColor: [241, 167, 34], fontSize: 9, fontStyle: \"bold\", textColor: [255, 255, 255] },\n    margin: { left: margin, right: margin },\n    startY,\n    styles: { cellPadding: 1, fontSize: 8, overflow: \"linebreak\" },\n    tableWidth: pageWidth - margin * 2,\n    theme: \"grid\",\n    willDrawCell: (data: CellHookData) => {\n      if (data.section === \"body\") {\n        const rowIndex = data.row.index;\n        const rawDate = workedRows[rowIndex]?.date;\n        const isSunday = rawDate && dayjs(rawDate).day() === 0;\n        if (isSunday) {\n          data.cell.styles.fillColor = [245, 245, 245];\n        }\n      }\n    },\n  });\n}\n\nfunction drawSummaryTable({ autoTable, doc, infoStartY, margin, pageWidth, summary }: SummaryTableProps) {\n  const summaryHead = [[\"Concepto\", \"Valor\"]];\n  const hasOvertime = summary && (summary.overtimeMinutes > 0 || (summary.extraAmount || 0) > 0);\n\n  const summaryBody: string[][] = [];\n  if (summary) {\n    const retentionPercent = formatRetentionPercent(summary.retentionRate || 0);\n\n    summaryBody.push(\n      [\"Horas trabajadas\", summary.hoursFormatted || \"0:00\"],\n      ...(hasOvertime ? [[\"Horas extras\", summary.overtimeFormatted || \"0:00\"]] : []),\n      [\"Tarifa por hora\", fmtCLP(summary.hourlyRate || 0)],\n      [\"Subtotal\", fmtCLP(summary.subtotal || 0)],\n      [`Retención (${retentionPercent})`, `-${fmtCLP(summary.retention || 0)}`],\n      [\"Total Líquido\", fmtCLP(summary.net || 0)]\n    );\n  }\n\n  const summaryColumnStyles: Record<string, { halign: \"center\" | \"left\" | \"right\" }> = {\n    0: { halign: \"left\" },\n    1: { halign: \"right\" },\n  };\n\n  autoTable(doc, {\n    body: summaryBody,\n    columnStyles: summaryColumnStyles,\n    head: summaryHead,\n    headStyles: { fillColor: [14, 100, 183], fontStyle: \"bold\", textColor: [255, 255, 255] },\n    margin: { left: margin, right: margin },\n    startY: infoStartY + 20,\n    styles: { cellPadding: 2, fontSize: 9, overflow: \"linebreak\" },\n    tableWidth: pageWidth - margin * 2,\n    theme: \"grid\",\n  });\n}\n\nfunction getLogoDimensions(logoDataUrl: null | string): Promise<null | { h: number; w: number }> {\n  if (!logoDataUrl) return Promise.resolve(null);\n  return new Promise((resolve) => {\n    const img = new Image();\n    img.addEventListener(\"load\", () => {\n      const maxW = 45;\n      const maxH = 22;\n      const iw0 = img.width || maxW;\n      const ih0 = img.height || maxH;\n      const scale = Math.min(maxW / iw0, maxH / ih0);\n      resolve({ h: Math.max(1, ih0 * scale), w: Math.max(1, iw0 * scale) });\n    });\n    img.addEventListener(\"error\", () => {\n      resolve(null);\n    });\n    img.src = logoDataUrl;\n  });\n}\n\nfunction imageToPngDataUrl(objectUrl: string): Promise<null | string> {\n  return new Promise((resolve) => {\n    const img = new Image();\n    const onLoad = () => {\n      try {\n        const canvas = document.createElement(\"canvas\");\n        canvas.width = img.width || 240;\n        canvas.height = img.height || 120;\n        const ctx = canvas.getContext(\"2d\");\n        if (!ctx) {\n          resolve(null);\n          return;\n        }\n        ctx.drawImage(img, 0, 0);\n        resolve(canvas.toDataURL(\"image/png\"));\n      } catch {\n        resolve(null);\n      }\n    };\n    img.addEventListener(\"load\", onLoad);\n    img.addEventListener(\"error\", () => {\n      resolve(null);\n    });\n    img.src = objectUrl;\n  });\n}\n\n// Helper: Cargar logo y normalizarlo a PNG (evitar \"wrong PNG signature\")\nasync function loadLogoAsPng(url: string): Promise<null | string> {\n  try {\n    let blob: Blob | null = null;\n    const isUrl = /^https?:\\/\\//i.test(url);\n\n    if (isUrl) {\n      try {\n        const proxyUrl = `/api/assets/proxy-image?url=${encodeURIComponent(url)}`;\n        blob = await apiClient.get<Blob>(proxyUrl, { responseType: \"blob\" });\n      } catch {\n        blob = null;\n      }\n    }\n\n    if (!blob) {\n      try {\n        blob = await apiClient.get<Blob>(url, { responseType: \"blob\" });\n      } catch {\n        blob = null;\n      }\n    }\n\n    if (!blob) return null;\n\n    if (blob.type === \"image/png\") {\n      return blobToDataUrl(blob);\n    }\n\n    const objectUrl = URL.createObjectURL(blob);\n    try {\n      return await imageToPngDataUrl(objectUrl);\n    } finally {\n      URL.revokeObjectURL(objectUrl);\n    }\n  } catch {\n    return null;\n  }\n}\n\n// === MAIN COMPONENT ===\n\nfunction timeToMinutes(t?: string): null | number {\n  if (!t || !/^\\d{1,2}:\\d{2}$/.test(t)) return null;\n  const parts = t.split(\":\").map(Number);\n  const [h, m] = parts;\n  if (h === undefined || m === undefined) return null;\n  if (h < 0 || h > 23 || m < 0 || m >= 60) return null;\n  return h * 60 + m;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/timesheets/components/TimesheetSummaryColumns.tsx","messages":[{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":89,"column":82,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":89,"endColumn":84,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2395,2397],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { ColumnDef } from \"@tanstack/react-table\";\nimport dayjs from \"dayjs\";\n\nimport { fmtCLP } from \"@/lib/format\";\n\nimport type { TimesheetSummaryRow } from \"../types\";\n\nexport interface SummaryTotals {\n  extraAmount: number;\n  hours: string;\n  net: number;\n  overtime: string;\n  retention: number;\n  subtotal: number;\n}\n\n// Define the shape of our meta to include totals\ninterface TableMeta {\n  totals?: SummaryTotals;\n}\n\nexport const getTimesheetSummaryColumns = (): ColumnDef<TimesheetSummaryRow>[] => [\n  {\n    accessorKey: \"fullName\",\n    footer: \"TOTAL\", // Appears in the first column\n    header: \"Trabajador\",\n    meta: {\n      className: \"font-medium\",\n    },\n  },\n  {\n    accessorKey: \"role\",\n    cell: ({ getValue }) => <span className=\"text-base-content/60\">{getValue() as string}</span>,\n    header: \"Función\",\n  },\n  {\n    accessorKey: \"hoursFormatted\",\n    footer: ({ table }) => {\n      const meta = table.options.meta as TableMeta;\n      return meta.totals?.hours;\n    },\n    header: \"Horas trabajadas\",\n  },\n  {\n    accessorKey: \"hourlyRate\",\n    cell: ({ getValue }) => fmtCLP(getValue() as number),\n    header: \"Tarifa\",\n  },\n  {\n    accessorKey: \"overtimeFormatted\",\n    cell: ({ getValue }) => getValue() as string,\n    footer: ({ table }) => {\n      const meta = table.options.meta as TableMeta;\n      return meta.totals?.overtime;\n    },\n    header: \"Extras\",\n  },\n  {\n    accessorKey: \"subtotal\",\n    cell: ({ getValue }) => fmtCLP(getValue() as number),\n    footer: ({ table }) => {\n      const meta = table.options.meta as TableMeta;\n      return meta.totals ? fmtCLP(meta.totals.subtotal) : null;\n    },\n    header: \"Subtotal\",\n  },\n  {\n    accessorKey: \"retention\",\n    cell: ({ getValue }) => fmtCLP(getValue() as number),\n    footer: ({ table }) => {\n      const meta = table.options.meta as TableMeta;\n      return meta.totals ? fmtCLP(meta.totals.retention) : null;\n    },\n    header: \"Retención\",\n  },\n  {\n    accessorKey: \"net\",\n    cell: ({ getValue }) => fmtCLP(getValue() as number),\n    footer: ({ table }) => {\n      const meta = table.options.meta as TableMeta;\n      return meta.totals ? fmtCLP(meta.totals.net) : null;\n    },\n    header: \"Líquido\",\n  },\n  {\n    accessorKey: \"payDate\",\n    cell: ({ getValue }) => {\n      const val = getValue() as null | string;\n      return val && dayjs(val).isValid() ? dayjs(val).format(\"DD-MM-YYYY\") : val || \"—\";\n    },\n    header: \"Fecha pago\",\n  },\n];\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/timesheets/components/TimesheetSummaryTable.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":14,"column":47,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":19,"endColumn":30,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[548,574],"text":"Readonly<TimesheetSummaryTableProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { DataTable } from \"@/components/data-table/DataTable\";\n\nimport type { TimesheetSummaryRow } from \"../types\";\n\nimport { getTimesheetSummaryColumns, SummaryTotals } from \"./TimesheetSummaryColumns\";\n\ninterface TimesheetSummaryTableProps {\n  loading: boolean;\n  onSelectEmployee: (id: null | number) => void;\n  selectedEmployeeId: null | number;\n  summary: null | { employees: TimesheetSummaryRow[]; totals: SummaryTotals };\n}\n\nexport default function TimesheetSummaryTable({\n  loading,\n  onSelectEmployee,\n  selectedEmployeeId,\n  summary,\n}: TimesheetSummaryTableProps) {\n  const columns = getTimesheetSummaryColumns();\n\n  const rowSelection = (() => {\n    if (!selectedEmployeeId) return {};\n    return { [selectedEmployeeId]: true };\n  })();\n\n  return (\n    <div className=\"border-primary/15 bg-base-100 overflow-hidden rounded-2xl border shadow-sm\">\n      <DataTable\n        columns={columns}\n        data={summary?.employees ?? []}\n        enableToolbar={false}\n        enableVirtualization={false}\n        isLoading={loading}\n        meta={{\n          totals: summary?.totals,\n        }}\n        noDataMessage=\"Aún no registras horas en este periodo.\"\n        onRowClick={(row) => {\n          onSelectEmployee(row.employeeId === selectedEmployeeId ? null : row.employeeId);\n        }}\n        rowSelection={rowSelection}\n      />\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/timesheets/hooks/use-months.ts","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":13,"column":18,"nodeType":"ChainExpression","messageId":"alwaysTruthy","endLine":13,"endColumn":30},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":13,"column":22,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":13,"endColumn":24,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[392,394],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":14,"column":26,"nodeType":"ChainExpression","messageId":"alwaysTruthy","endLine":14,"endColumn":46},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":14,"column":30,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":14,"endColumn":32,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[437,439],"text":"."},"desc":"Remove unnecessary optional chain"}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useSuspenseQuery } from \"@tanstack/react-query\";\n\nimport { fetchTimesheetMonths } from \"../api\";\n\nexport function useMonths() {\n  const { data } = useSuspenseQuery({\n    queryFn: fetchTimesheetMonths,\n    queryKey: [\"timesheet-months\"],\n    staleTime: 1000 * 60 * 5, // 5 minutes\n  });\n\n  // Fallback constant (though Suspense ensures data exists if successful)\n  const months = data?.months || [];\n  const monthsWithData = data?.monthsWithData || new Set<string>();\n\n  return { months, monthsWithData };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/timesheets/pages/TimesheetsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always falsy.","line":43,"column":9,"nodeType":"UnaryExpression","messageId":"alwaysFalsy","endLine":43,"endColumn":21},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":57,"column":65,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":57,"endColumn":67,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2330,2332],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":121,"column":18,"nodeType":"Identifier","messageId":"alwaysTruthy","endLine":121,"endColumn":29}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useSuspenseQuery } from \"@tanstack/react-query\";\nimport dayjs from \"dayjs\";\nimport { type ChangeEvent, Suspense, useState } from \"react\";\n\nimport Input from \"@/components/ui/Input\";\nimport { useAuth } from \"@/context/AuthContext\";\nimport { employeeKeys } from \"@/features/hr/employees/queries\";\nimport { fetchTimesheetSummary } from \"@/features/hr/timesheets/api\";\nimport TimesheetEditor from \"@/features/hr/timesheets/components/TimesheetEditor\";\nimport TimesheetSummaryTable from \"@/features/hr/timesheets/components/TimesheetSummaryTable\";\nimport { useMonths } from \"@/features/hr/timesheets/hooks/use-months\";\nimport { useWakeLock } from \"@/hooks/use-wake-lock\";\nimport { PAGE_CONTAINER, TITLE_LG } from \"@/lib/styles\";\n\nexport default function TimesheetsPage() {\n  useWakeLock();\n  useAuth();\n\n  // --- State ---\n  const { months, monthsWithData } = useMonths();\n  // Init month synchronously to previous month\n  const [month, setMonth] = useState<string>(() => dayjs().subtract(1, \"month\").format(\"YYYY-MM\"));\n  const [selectedEmployeeId, setSelectedEmployeeId] = useState<null | number>(null);\n\n  // --- Queries ---\n\n  // 1. Employees\n  const { data: employees } = useSuspenseQuery({\n    ...employeeKeys.list({ includeInactive: false }),\n    staleTime: 5 * 60 * 1000,\n  });\n\n  const activeEmployees = employees.filter((e) => e.status === \"ACTIVE\");\n  const selectedEmployee = selectedEmployeeId ? (employees.find((e) => e.id === selectedEmployeeId) ?? null) : null;\n\n  // 2. Summary (Depends on Month + potentially SelectedEmployee)\n  const { data: summaryData } = useSuspenseQuery({\n    queryFn: () => fetchTimesheetSummary(formatMonthString(month), selectedEmployeeId),\n    queryKey: [\"timesheet-summary\", month, selectedEmployeeId],\n  });\n\n  const employeeSummaryRow = (() => {\n    if (!summaryData || !selectedEmployee) return null;\n    return summaryData.employees.find((e) => e.employeeId === selectedEmployee.id) ?? null;\n  })();\n\n  const monthLabel = (() => {\n    if (!month) return \"\";\n    const [year, monthStr] = month.split(\"-\");\n    const d = dayjs(`${year}-${monthStr}-01`);\n    return d.isValid() ? d.format(\"MMMM YYYY\") : month;\n  })();\n\n  // Group months\n  const groupedMonths = groupedMonthsMemo();\n  function groupedMonthsMemo() {\n    const years = [...new Set(months.map((m) => m.split(\"-\")[0] || \"\"))];\n    return years.map((year) => ({\n      months: months.filter((m) => m.startsWith(year)),\n      year,\n    }));\n  }\n\n  return (\n    <section className={PAGE_CONTAINER}>\n      <div className=\"flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between\">\n        <h1 className={TITLE_LG}>Registro de horas y pagos</h1>\n        <div className=\"flex flex-col gap-3 sm:flex-row\">\n          <div className=\"min-w-52\">\n            <Input\n              as=\"select\"\n              className=\"bg-base-100\"\n              disabled={activeEmployees.length === 0}\n              label=\"Trabajador\"\n              onChange={(event: ChangeEvent<HTMLSelectElement>) => {\n                const value = event.target.value;\n                setSelectedEmployeeId(value ? Number(value) : null);\n              }}\n              value={selectedEmployeeId ?? \"\"}\n            >\n              <option value=\"\">Seleccionar...</option>\n              {activeEmployees.map((emp) => (\n                <option key={emp.id} value={emp.id}>\n                  {emp.full_name}\n                </option>\n              ))}\n            </Input>\n          </div>\n          <div className=\"min-w-44\">\n            <Input\n              as=\"select\"\n              className=\"bg-base-100\"\n              label=\"Periodo\"\n              onChange={(event: ChangeEvent<HTMLSelectElement>) => {\n                setMonth(event.target.value);\n              }}\n              value={month}\n            >\n              {groupedMonths.map((group) => (\n                <optgroup key={group.year} label={group.year}>\n                  {group.months.map((m) => {\n                    const hasData = monthsWithData.has(m);\n                    const label = dayjs(m + \"-01\").format(\"MMMM\");\n                    return (\n                      <option key={m} value={m}>\n                        {label} {hasData ? \"✓\" : \"\"}\n                      </option>\n                    );\n                  })}\n                </optgroup>\n              ))}\n            </Input>\n          </div>\n        </div>\n      </div>\n\n      <TimesheetSummaryTable\n        loading={false}\n        onSelectEmployee={setSelectedEmployeeId}\n        selectedEmployeeId={selectedEmployeeId}\n        summary={summaryData ? { employees: summaryData.employees, totals: summaryData.totals } : null}\n      />\n\n      {selectedEmployee && month && (\n        <Suspense fallback={<div className=\"p-4 text-center\">Cargando detalles...</div>}>\n          <TimesheetEditor\n            activeEmployees={activeEmployees}\n            employeeId={selectedEmployee.id}\n            month={month}\n            monthLabel={monthLabel}\n            selectedEmployee={selectedEmployee}\n            summaryRow={employeeSummaryRow}\n          />\n        </Suspense>\n      )}\n    </section>\n  );\n}\n\n// Utility to ensure month is always YYYY-MM\nfunction formatMonthString(m: string): string {\n  if (/^\\d{4}-\\d{2}$/.test(m)) return m;\n  const d = dayjs(m, [\"YYYY-MM\", \"YYYY/MM\", \"MM/YYYY\", \"YYYY-MM-DD\", \"DD/MM/YYYY\"]);\n  if (d.isValid()) return d.format(\"YYYY-MM\");\n  return dayjs().format(\"YYYY-MM\");\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/timesheets/pdf-utils.ts","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":21,"column":23,"nodeType":"MemberExpression","messageId":"neverNullish","endLine":21,"endColumn":46},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":52,"column":43,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":52,"endColumn":45,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1733,1735],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/return-await","severity":2,"message":"Returning an awaited promise is required in this context.","line":101,"column":12,"nodeType":"NewExpression","messageId":"requiredPromiseAwait","endLine":116,"endColumn":7,"suggestions":[{"messageId":"requiredPromiseAwaitSuggestion","fix":{"range":[3593,3593],"text":"await "},"desc":"Add `await` before the expression. Use caution as this may impact control flow."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":105,"column":46,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":105,"endColumn":48,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[3799,3801],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { formatRetentionPercent } from \"@shared/retention\";\nimport dayjs from \"dayjs\";\nimport ky from \"ky\";\n\nimport type { Employee } from \"@/features/hr/employees/types\";\n\nimport type { BulkRow, TimesheetSummaryRow } from \"./types\";\n\n/**\n * Generates a PDF document as base64 string for a timesheet\n * Uses jspdf and jspdf-autotable dynamically imported for code-splitting\n */\nexport async function generateTimesheetPdfBase64(\n  employee: Employee,\n  summaryRow: TimesheetSummaryRow,\n  bulkRows: BulkRow[],\n  monthLabel: string\n): Promise<null | string> {\n  try {\n    const [{ default: jsPDF }, autoTableModule] = await Promise.all([import(\"jspdf\"), import(\"jspdf-autotable\")]);\n    const autoTable = autoTableModule.default ?? autoTableModule;\n    const doc = new jsPDF();\n\n    const margin = 10;\n\n    // Try to load and add logo\n    try {\n      const logoBlob = await ky.get(\"/logo_sin_eslogan.png\").blob();\n      const logoBase64 = await new Promise<string>((resolve) => {\n        const reader = new FileReader();\n        reader.addEventListener(\"load\", () => {\n          resolve(reader.result as string);\n        });\n        reader.readAsDataURL(logoBlob);\n      });\n      doc.addImage(logoBase64, \"PNG\", margin, 5, 40, 12);\n    } catch {\n      console.warn(\"Could not load logo for PDF\");\n    }\n\n    // Header\n    doc.setFontSize(14);\n    doc.setFont(\"helvetica\", \"bold\");\n    doc.text(\"Boleta de Honorarios\", margin, 30);\n    doc.setFont(\"helvetica\", \"normal\");\n    doc.setFontSize(10);\n    doc.text(`Servicios de ${summaryRow.role}`, margin, 38);\n    doc.text(`Periodo: ${monthLabel}`, margin, 45);\n\n    // Employee info\n    doc.text(`Prestador: ${employee.full_name}`, margin, 58);\n    doc.text(`RUT: ${employee.person?.rut || \"-\"}`, margin, 65);\n\n    // Summary table\n    const fmtCLP = (n: number) =>\n      n.toLocaleString(\"es-CL\", { currency: \"CLP\", minimumFractionDigits: 0, style: \"currency\" });\n\n    // Use retention rate from backend summary (already calculated with correct year)\n    const retentionPercent = formatRetentionPercent(summaryRow.retentionRate || 0);\n\n    autoTable(doc, {\n      body: [\n        [\"Horas trabajadas\", summaryRow.hoursFormatted],\n        [\"Horas extras\", summaryRow.overtimeFormatted],\n        [\"Tarifa por hora\", fmtCLP(summaryRow.hourlyRate)],\n        [\"Subtotal\", fmtCLP(summaryRow.subtotal)],\n        [`Retención (${retentionPercent})`, `-${fmtCLP(summaryRow.retention)}`],\n        [\"Total líquido\", fmtCLP(summaryRow.net)],\n      ],\n      columnStyles: { 1: { halign: \"right\" } },\n      head: [[\"Concepto\", \"Valor\"]],\n      headStyles: { fillColor: [14, 100, 183] },\n      margin: { left: margin, right: margin },\n      startY: 75,\n      styles: { fontSize: 10 },\n      theme: \"grid\",\n    });\n\n    // Detail table\n    const lastTableRef = doc as unknown as { lastAutoTable?: { finalY: number } };\n    const nextY = lastTableRef.lastAutoTable ? lastTableRef.lastAutoTable.finalY + 10 : 120;\n\n    const detailBody = bulkRows\n      .filter((row) => row.entrada || row.salida)\n      .map((row) => [dayjs(row.date).format(\"DD-MM-YYYY\"), row.entrada || \"-\", row.salida || \"-\", row.overtime || \"-\"]);\n\n    if (detailBody.length > 0) {\n      autoTable(doc, {\n        body: detailBody,\n        head: [[\"Fecha\", \"Entrada\", \"Salida\", \"Extras\"]],\n        headStyles: { fillColor: [241, 167, 34], halign: \"center\" },\n        margin: { left: margin, right: margin },\n        startY: nextY,\n        styles: { fontSize: 9, halign: \"center\" },\n        theme: \"grid\",\n      });\n    }\n\n    // Convert to base64\n    const pdfBlob = doc.output(\"blob\");\n    return new Promise((resolve) => {\n      const reader = new FileReader();\n      reader.addEventListener(\"load\", () => {\n        const dataUrl = reader.result as string;\n        const base64 = dataUrl.split(\",\")[1] || \"\";\n        resolve(base64);\n      });\n      reader.addEventListener(\n        \"error\",\n        () => {\n          resolve(null);\n        },\n        { once: true }\n      );\n      reader.readAsDataURL(pdfBlob);\n    });\n  } catch (error) {\n    console.error(\"Error generating PDF:\", error);\n    return null;\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/timesheets/queries.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/timesheets/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/hr/timesheets/utils.ts","messages":[{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":13,"column":50,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":13,"endColumn":52,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[557,559],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":102,"column":41,"nodeType":"MemberExpression","endLine":102,"endColumn":51},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":102,"column":56,"nodeType":"MemberExpression","endLine":102,"endColumn":70}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import dayjs from \"dayjs\";\n\nimport type { BulkRow, TimesheetEntry, TimesheetSummaryRow } from \"./types\";\n\nexport function buildBulkRows(month: string, entries: TimesheetEntry[]): BulkRow[] {\n  const base = dayjs(`${month}-01`);\n  const days = base.daysInMonth();\n  const entryMap = new Map(entries.map((entry) => [entry.work_date, entry]));\n  const rows: BulkRow[] = [];\n  for (let day = 1; day <= days; day += 1) {\n    const date = base.date(day).format(\"YYYY-MM-DD\");\n    const entry = entryMap.get(date);\n    const extraMinutes = entry?.overtime_minutes || 0;\n    rows.push({\n      comment: entry?.comment ?? \"\",\n      date,\n      entrada: entry?.start_time ?? \"\",\n      entryId: entry?.id ?? null,\n      overtime: extraMinutes ? minutesToDuration(extraMinutes) : \"\",\n      salida: entry?.end_time ?? \"\",\n    });\n  }\n  return rows;\n}\n\nexport function hasRowData(row: BulkRow): boolean {\n  return Boolean(row.entrada.trim() || row.salida.trim() || row.overtime.trim() || row.comment.trim());\n}\n\nconst editableFields: (keyof Pick<BulkRow, \"comment\" | \"entrada\" | \"overtime\" | \"salida\">)[] = [\n  \"entrada\",\n  \"salida\",\n  \"overtime\",\n  \"comment\",\n];\n\nexport function calculateWorkedMinutes(startTime: string, endTime: string): number {\n  if (!startTime || !endTime || startTime === \"00:00\" || endTime === \"00:00\") return 0;\n\n  const start = timeToMinutes(startTime);\n  const end = timeToMinutes(endTime);\n\n  if (start === null || end === null) return 0;\n\n  let totalMinutes = end - start;\n\n  // Si end < start, asumimos que cruza medianoche (ej: 22:00 a 06:00)\n  if (totalMinutes < 0) {\n    totalMinutes = 24 * 60 + totalMinutes;\n  }\n\n  return totalMinutes;\n}\n\nexport function computeExtraAmount(extraMinutes: number, hourlyRate: number): number {\n  if (!hourlyRate || extraMinutes <= 0) return 0;\n  return Math.round((extraMinutes / 60) * hourlyRate * 100) / 100;\n}\n\nexport function computeStatus(row: BulkRow, dirty: boolean): string {\n  if (row.entryId && !dirty) return \"Registrado\";\n  if (row.entryId && dirty) return \"Sin guardar\";\n  if (!row.entryId && hasRowData(row)) return \"Sin guardar\";\n  return \"No trabajado\";\n}\n\nexport function formatDateLabel(value: string): string {\n  const date = dayjs(value);\n  return date.isValid() ? date.format(\"DD-MM-YYYY\") : value || \"—\";\n}\n\nexport function formatExtraHours(row: TimesheetSummaryRow): string {\n  // Si no hay extraAmount, retornar 00:00\n  if (!row.extraAmount) return \"00:00\";\n\n  // Si hay overtimeRate definido, calcular horas basado en extraAmount / overtimeRate\n  if (row.overtimeRate > 0) {\n    const minutes = Math.round((row.extraAmount / row.overtimeRate) * 60);\n    return minutesToDuration(minutes);\n  }\n\n  // Si overtimeRate es 0 pero hay extraAmount, mostrar las horas extra reales del timesheet\n  // En este caso, las horas extra no se pagan pero sí se registran\n  return minutesToDuration(row.overtimeMinutes || 0);\n}\n\nexport function formatTotalExtraHours(rows: TimesheetSummaryRow[]): string {\n  let totalMinutes = 0;\n  for (const row of rows) {\n    // Si no hay extraAmount, continuar\n    if (!row.extraAmount) continue;\n\n    // Si hay overtimeRate definido, calcular horas basado en extraAmount / overtimeRate\n    totalMinutes +=\n      row.overtimeRate > 0 ? Math.round((row.extraAmount / row.overtimeRate) * 60) : row.overtimeMinutes || 0;\n  }\n  return minutesToDuration(totalMinutes);\n}\n\nexport function isRowDirty(row: BulkRow, initial?: BulkRow): boolean {\n  if (!initial) return hasRowData(row);\n  return editableFields.some((field) => row[field] !== initial[field]);\n}\n\nexport function minutesToDuration(totalMinutes: number): string {\n  if (totalMinutes < 0) {\n    return \"-\" + minutesToDuration(-totalMinutes);\n  }\n  const hours = Math.floor(totalMinutes / 60);\n  const minutes = totalMinutes % 60;\n  return `${String(hours).padStart(2, \"0\")}:${String(minutes).padStart(2, \"0\")}`;\n}\n\nexport function parseDuration(value: string): null | number {\n  const trimmed = value.trim();\n  if (!trimmed) return 0;\n  if (!/^\\d{1,2}:\\d{2}$/.test(trimmed)) return null;\n  const parts = trimmed.split(\":\").map(Number);\n  const [hours, minutes] = parts;\n  if (hours === undefined || minutes === undefined) return null;\n  if (minutes >= 60) return null;\n  return hours * 60 + minutes;\n}\n\nfunction timeToMinutes(time: string): null | number {\n  if (!/^\\d{1,2}:\\d{2}$/.test(time)) return null;\n  const parts = time.split(\":\").map(Number);\n  const [hours, minutes] = parts;\n  if (hours === undefined || minutes === undefined) return null;\n  if (hours < 0 || hours > 23 || minutes < 0 || minutes >= 60) return null;\n  return hours * 60 + minutes;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/inventory/api.ts","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":35,"column":10,"nodeType":"MemberExpression","messageId":"neverNullish","endLine":35,"endColumn":22}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { apiClient } from \"@/lib/api-client\";\n\nimport type { AllergyInventoryOverview, InventoryCategory, InventoryItem, InventoryMovement } from \"./types\";\n\ninterface ApiResponse<T> {\n  data: T;\n  message?: string;\n  status?: string;\n}\n\nexport async function createInventoryCategory(name: string): Promise<InventoryCategory> {\n  const res = await apiClient.post<ApiResponse<InventoryCategory>>(\"/api/inventory/categories\", { name });\n  return res.data;\n}\n\nexport async function createInventoryItem(item: Omit<InventoryItem, \"id\">): Promise<InventoryItem> {\n  const res = await apiClient.post<ApiResponse<InventoryItem>>(\"/api/inventory/items\", item);\n  return res.data;\n}\n\nexport async function createInventoryMovement(movement: InventoryMovement): Promise<void> {\n  await apiClient.post(\"/api/inventory/movements\", movement);\n}\n\nexport async function deleteInventoryCategory(id: number): Promise<void> {\n  await apiClient.delete(`/api/inventory/categories/${id}`);\n}\n\nexport async function deleteInventoryItem(id: number): Promise<void> {\n  await apiClient.delete(`/api/inventory/items/${id}`);\n}\n\nexport async function fetchAllergyOverview(): Promise<AllergyInventoryOverview[]> {\n  const payload = await apiClient.get<ApiResponse<AllergyInventoryOverview[]>>(\"/api/inventory/allergy-overview\");\n  return payload.data ?? [];\n}\n\nexport async function getInventoryCategories(): Promise<InventoryCategory[]> {\n  const res = await apiClient.get<ApiResponse<InventoryCategory[]>>(\"/api/inventory/categories\");\n  return res.data;\n}\n\nexport async function getInventoryItems(): Promise<InventoryItem[]> {\n  const res = await apiClient.get<ApiResponse<InventoryItem[]>>(\"/api/inventory/items\");\n  return res.data;\n}\n\nexport async function updateInventoryItem(\n  id: number,\n  item: Partial<Omit<InventoryItem, \"id\">>\n): Promise<InventoryItem> {\n  const res = await apiClient.put<ApiResponse<InventoryItem>>(`/api/inventory/items/${id}`, item);\n  return res.data;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/inventory/components/AdjustStockForm.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":15,"column":41,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":15,"endColumn":97,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[420,440],"text":"Readonly<AdjustStockFormProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from \"react\";\n\nimport Button from \"@/components/ui/Button\";\nimport Input from \"@/components/ui/Input\";\n\nimport { InventoryItem, InventoryMovement } from \"../types\";\n\ninterface AdjustStockFormProps {\n  item: InventoryItem;\n  onCancel: () => void;\n  onSave: (movement: InventoryMovement) => void;\n  saving: boolean;\n}\n\nexport default function AdjustStockForm({ item, onCancel, onSave, saving }: AdjustStockFormProps) {\n  const [quantityChange, setQuantityChange] = useState(\"\");\n  const [reason, setReason] = useState(\"\");\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    onSave({\n      item_id: item.id,\n      quantity_change: Number(quantityChange),\n      reason,\n    });\n  };\n\n  return (\n    <form className=\"space-y-4 text-sm\" onSubmit={handleSubmit}>\n      <div>\n        <h3 className=\"text-lg font-bold\">{item.name}</h3>\n        <p className=\"text-base-content/60\">Stock actual: {item.current_stock}</p>\n      </div>\n      <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2\">\n        <Input\n          label=\"Cantidad a agregar/quitar\"\n          onChange={(event: React.ChangeEvent<HTMLInputElement>) => {\n            setQuantityChange(event.target.value);\n          }}\n          placeholder=\"Ej: 20 (agrega) o -15 (quita)\"\n          required\n          type=\"number\"\n          value={quantityChange}\n        />\n        <Input\n          label=\"Razón del ajuste\"\n          onChange={(event: React.ChangeEvent<HTMLInputElement>) => {\n            setReason(event.target.value);\n          }}\n          placeholder=\"Ej: Compra inicial, uso en procedimiento\"\n          required\n          type=\"text\"\n          value={reason}\n        />\n      </div>\n      <div className=\"flex items-center justify-end gap-3 pt-4\">\n        <Button onClick={onCancel} type=\"button\" variant=\"secondary\">\n          Cancelar\n        </Button>\n        <Button disabled={saving} type=\"submit\" variant=\"primary\">\n          {saving ? \"Guardando...\" : \"Ajustar Stock\"}\n        </Button>\n      </div>\n    </form>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/inventory/components/AllergyInventoryView.tsx","messages":[{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":29,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":29,"endColumn":69},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":2,"message":"Unsafe call of an `any` typed value.","line":30,"column":7,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":30,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .push on an `any` value.","line":30,"column":21,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":30,"endColumn":25},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always falsy.","line":52,"column":8,"nodeType":"Identifier","messageId":"alwaysFalsy","endLine":52,"endColumn":13},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always falsy.","line":53,"column":8,"nodeType":"Identifier","messageId":"alwaysFalsy","endLine":53,"endColumn":15},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":54,"column":8,"nodeType":"UnaryExpression","messageId":"alwaysTruthy","endLine":54,"endColumn":16},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":84,"column":19,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":84,"endColumn":63,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[3477,3511],"text":"Readonly<{ item: AllergyInventoryOverview }>"},"desc":"Mark the props as read-only"}]},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":103,"column":23,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":103,"endColumn":96,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[4308,4367],"text":"Readonly<{ provider: AllergyInventoryOverview[\"providers\"][number] }>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useSuspenseQuery } from \"@tanstack/react-query\";\n\nimport Alert from \"@/components/ui/Alert\";\nimport Button from \"@/components/ui/Button\";\nimport { fmtCLP, formatDate } from \"@/lib/format\";\n\nimport type { AllergyInventoryOverview } from \"../types\";\n\nimport { inventoryKeys } from \"../queries\";\n\nfunction AllergyInventoryView() {\n  const { data, isFetching, isLoading: loading, refetch } = useSuspenseQuery(inventoryKeys.allergyOverview());\n\n  const error = null;\n\n  const grouped = (() => {\n    const map = new Map<\n      string,\n      {\n        categories: Map<string, AllergyInventoryOverview[]>;\n        typeName: string;\n      }\n    >();\n\n    for (const item of data) {\n      const typeName = item.allergy_type.type?.name ?? \"Otros\";\n      const categoryName = item.allergy_type.category?.name ?? \"Sin categoría\";\n      const entry = map.get(typeName) ?? { categories: new Map(), typeName };\n      const categoryItems = entry.categories.get(categoryName) ?? [];\n      categoryItems.push(item);\n      entry.categories.set(categoryName, categoryItems);\n      map.set(typeName, entry);\n    }\n\n    return map;\n  })();\n\n  return (\n    <section className=\"surface-recessed space-y-4 rounded-3xl p-6 shadow-inner\">\n      <div className=\"flex flex-wrap items-center justify-between gap-3\">\n        <div>\n          <p className=\"text-base-content/60 text-xs tracking-[0.3em] uppercase\">Insumos de alergia</p>\n          <h3 className=\"text-base-content text-xl font-semibold\">Reactivos y haptenos con proveedores</h3>\n          <p className=\"text-base-content/70 text-xs\">\n            Agrupados por tipo/categoría. Revisa stock, precio y cuentas disponibles.\n          </p>\n        </div>\n        <Button disabled={isFetching} onClick={() => void refetch()} size=\"sm\" variant=\"ghost\">\n          {isFetching ? \"Actualizando…\" : \"Refrescar\"}\n        </Button>\n      </div>\n      {error && <Alert variant=\"error\">{error}</Alert>}\n      {loading && data.length === 0 && <p className=\"text-base-content/60 text-xs\">Cargando datos…</p>}\n      {!loading && data.length === 0 && <p className=\"text-base-content/60 text-xs\">No hay insumos registrados aún.</p>}\n      <div className=\"space-y-6\">\n        {[...grouped.values()].map((group) => (\n          <div className=\"space-y-4\" key={group.typeName}>\n            <div className=\"flex items-center justify-between\">\n              <h4 className=\"text-base-content text-lg font-semibold\">{group.typeName}</h4>\n              <span className=\"text-base-content/70 text-xs\">{group.categories.size} categorías</span>\n            </div>\n            <div className=\"space-y-4\">\n              {[...group.categories.entries()].map(([categoryName, items]) => (\n                <div className=\"border-base-300/60 bg-base-100/80 rounded-2xl border p-4 shadow-sm\" key={categoryName}>\n                  <div className=\"flex items-center justify-between\">\n                    <p className=\"text-base-content text-sm font-semibold\">{categoryName}</p>\n                    <span className=\"text-base-content/60 text-xs\">{items.length} insumos</span>\n                  </div>\n                  <div className=\"mt-4 grid gap-4 sm:grid-cols-2\">\n                    {items.map((item) => (\n                      <ItemCard item={item} key={item.item_id} />\n                    ))}\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n        ))}\n      </div>\n    </section>\n  );\n}\n\nfunction ItemCard({ item }: { item: AllergyInventoryOverview }) {\n  return (\n    <div className=\"border-base-300 bg-base-100 text-base-content rounded-2xl border p-3 text-sm shadow-inner\">\n      <div className=\"flex items-center justify-between\">\n        <p className=\"font-semibold\">{item.name}</p>\n        <span className=\"text-base-content/60 text-xs\">Stock {item.current_stock}</span>\n      </div>\n      {item.description && <p className=\"text-base-content/70 mt-1 text-xs\">{item.description}</p>}\n      <div className=\"mt-3 space-y-2 text-xs\">\n        {item.providers.length > 0 ? (\n          item.providers.map((p) => <ProviderCard key={p.provider_id} provider={p} />)\n        ) : (\n          <p className=\"text-base-content/50 text-xs italic\">Sin proveedores asignados</p>\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction ProviderCard({ provider }: { provider: AllergyInventoryOverview[\"providers\"][number] }) {\n  return (\n    <div className=\"border-base-200 bg-base-200/80 space-y-1 rounded-xl border px-3 py-2\">\n      <div className=\"flex items-center justify-between\">\n        <span className=\"font-semibold\">{provider.provider_name}</span>\n        <span className=\"text-base-content/50 text-xs tracking-wide uppercase\">{provider.provider_rut}</span>\n      </div>\n      <p className=\"text-base-content/70 text-xs\">\n        Precio: {provider.current_price == null ? \"Sin precio\" : fmtCLP(provider.current_price)}\n      </p>\n      <p className=\"text-base-content/60 text-[11px]\">\n        Último stock: {provider.last_stock_check ? formatDate(provider.last_stock_check) : \"Nunca\"}\n      </p>\n      <p className=\"text-base-content/60 text-[11px]\">\n        Último precio: {provider.last_price_check ? formatDate(provider.last_price_check) : \"Nunca\"}\n      </p>\n      <p className=\"text-base-content/60 text-[11px]\">Cuentas: {provider.accounts.join(\", \") || \"Sin cuentas\"}</p>\n    </div>\n  );\n}\n\nexport default AllergyInventoryView;\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/inventory/components/InventoryCategoryManager.tsx","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":22,"column":23,"nodeType":"TSAsExpression","messageId":"neverNullish","endLine":22,"endColumn":46},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":22,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[662,665],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[662,665],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useCreateInventoryCategory, useFindManyInventoryCategory } from \"@finanzas/db/hooks\";\nimport { PlusCircle } from \"lucide-react\";\nimport { useState } from \"react\";\n\nimport Button from \"@/components/ui/Button\";\nimport Input from \"@/components/ui/Input\";\n\nimport type { InventoryCategory } from \"../types\";\n\nexport default function InventoryCategoryManager() {\n  const [newCategoryName, setNewCategoryName] = useState(\"\");\n\n  // ZenStack hooks for categories\n  const {\n    data: categoriesData,\n    error: queryError,\n    isLoading: loading,\n  } = useFindManyInventoryCategory({\n    orderBy: { name: \"asc\" },\n  });\n\n  const categories = (categoriesData as any[]) ?? [];\n\n  // ZenStack mutation for creating category\n  const createMutation = useCreateInventoryCategory();\n\n  const error = (() => {\n    if (queryError instanceof Error) return queryError.message;\n    if (createMutation.error instanceof Error) return createMutation.error.message;\n    return null;\n  })();\n\n  function handleAddCategory(e: React.FormEvent) {\n    e.preventDefault();\n    if (!newCategoryName.trim()) return;\n    createMutation.mutate(\n      { data: { name: newCategoryName.trim() } },\n      {\n        onSuccess: () => {\n          setNewCategoryName(\"\");\n        },\n      }\n    );\n  }\n\n  return (\n    <section className=\"bg-base-100 space-y-5 p-6\">\n      <div className=\"space-y-1\">\n        <h2 className=\"text-secondary text-lg font-semibold drop-shadow-sm\">Categorías de Inventario</h2>\n        <p className=\"text-base-content/70 text-sm\">\n          Administra las categorías para organizar los items del inventario.\n        </p>\n      </div>\n\n      <form className=\"flex flex-col gap-3 sm:flex-row sm:items-end\" onSubmit={handleAddCategory}>\n        <label className=\"flex-1\" htmlFor=\"new-category-name\">\n          <span className=\"text-base-content/60 text-xs font-semibold tracking-wide uppercase\">Nueva Categoría</span>\n          <Input\n            className=\"w-full\"\n            disabled={createMutation.isPending}\n            enterKeyHint=\"done\"\n            id=\"new-category-name\"\n            onChange={(e) => {\n              setNewCategoryName(e.target.value);\n            }}\n            placeholder=\"Ej: Insumos Médicos\"\n            type=\"text\"\n            value={newCategoryName}\n          />\n        </label>\n        <Button\n          className=\"inline-flex items-center gap-2\"\n          disabled={createMutation.isPending || !newCategoryName.trim()}\n          size=\"sm\"\n          type=\"submit\"\n          variant=\"primary\"\n        >\n          <PlusCircle size={16} />\n          {createMutation.isPending ? \"Agregando...\" : \"Agregar\"}\n        </Button>\n      </form>\n\n      {error && <p className=\"text-error text-sm\">{error}</p>}\n\n      <div className=\"border-base-300 bg-base-100 max-h-60 overflow-y-auto border p-3\">\n        {loading && <p className=\"text-base-content text-sm\">Cargando categorías...</p>}\n        {!loading && categories.length === 0 && (\n          <p className=\"text-base-content text-sm\">No hay categorías definidas.</p>\n        )}\n        <ul className=\"space-y-2\">\n          {categories.map((cat: InventoryCategory) => (\n            <li\n              className=\"border-base-300 bg-base-200 text-base-content rounded-xl border px-3 py-2 text-sm font-medium shadow-sm\"\n              key={cat.id}\n            >\n              {cat.name}\n            </li>\n          ))}\n        </ul>\n      </div>\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/inventory/components/InventoryItemForm.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":16,"column":43,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":16,"endColumn":101,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[496,518],"text":"Readonly<InventoryItemFormProps>"},"desc":"Mark the props as read-only"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":69,"column":16,"nodeType":"MemberExpression","messageId":"neverNullish","endLine":69,"endColumn":32},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":79,"column":16,"nodeType":"MemberExpression","messageId":"neverNullish","endLine":79,"endColumn":34}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from \"react\";\n\nimport Button from \"@/components/ui/Button\";\nimport Input from \"@/components/ui/Input\";\n\nimport { getInventoryCategories } from \"../api\";\nimport { InventoryCategory, InventoryItem } from \"../types\";\n\ninterface InventoryItemFormProps {\n  item?: InventoryItem | null;\n  onCancel: () => void;\n  onSave: (item: Omit<InventoryItem, \"id\">) => void;\n  saving: boolean;\n}\n\nexport default function InventoryItemForm({ item, onCancel, onSave, saving }: InventoryItemFormProps) {\n  const [form, setForm] = useState({\n    ...item,\n    category_id: item?.category_id ?? null,\n    current_stock: item?.current_stock ?? 0,\n    description: item?.description ?? \"\",\n  });\n  const [categories, setCategories] = useState<InventoryCategory[]>([]);\n\n  useEffect(() => {\n    getInventoryCategories().then(setCategories).catch(console.error);\n  }, []);\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    onSave(form as Omit<InventoryItem, \"id\">);\n  };\n\n  return (\n    <form className=\"space-y-4 text-sm\" onSubmit={handleSubmit}>\n      <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2\">\n        <Input\n          label=\"Nombre del item\"\n          onChange={(event: React.ChangeEvent<HTMLInputElement>) => {\n            setForm({ ...form, name: event.target.value });\n          }}\n          required\n          type=\"text\"\n          value={form.name ?? \"\"}\n        />\n        <Input\n          as=\"select\"\n          label=\"Categoría\"\n          onChange={(event: React.ChangeEvent<HTMLSelectElement>) => {\n            setForm({ ...form, category_id: event.target.value ? Number(event.target.value) : null });\n          }}\n          value={form.category_id == null ? \"\" : String(form.category_id)}\n        >\n          <option value=\"\">Sin categoría</option>\n          {categories.map((cat) => (\n            <option key={cat.id} value={cat.id}>\n              {cat.name}\n            </option>\n          ))}\n        </Input>\n      </div>\n      <Input\n        as=\"textarea\"\n        label=\"Descripción\"\n        onChange={(event: React.ChangeEvent<HTMLTextAreaElement>) => {\n          setForm({ ...form, description: event.target.value });\n        }}\n        rows={3}\n        value={form.description ?? \"\"}\n      />\n      <Input\n        disabled={!!item} // Disable if editing\n        label=\"Stock inicial\"\n        onChange={(event: React.ChangeEvent<HTMLInputElement>) => {\n          setForm({ ...form, current_stock: Number(event.target.value) });\n        }}\n        required\n        type=\"number\"\n        value={form.current_stock ?? 0}\n      />\n      <div className=\"flex items-center justify-end gap-3 pt-4\">\n        <Button onClick={onCancel} type=\"button\" variant=\"secondary\">\n          Cancelar\n        </Button>\n        <Button disabled={saving} type=\"submit\" variant=\"primary\">\n          {saving ? \"Guardando...\" : \"Guardar Item\"}\n        </Button>\n      </div>\n    </form>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/inventory/components/columns.tsx","messages":[{"ruleId":"check-file/filename-naming-convention","severity":2,"message":"The filename \"columns.tsx\" does not match the \"PASCAL_CASE\" pattern","line":1,"column":1,"nodeType":"Program","messageId":"noMatch","endLine":75,"endColumn":1}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ColumnDef } from \"@tanstack/react-table\";\nimport { Lock } from \"lucide-react\";\n\nimport Button from \"@/components/ui/Button\";\n\nimport { InventoryItem } from \"../types\";\n\nexport interface InventoryTableMeta {\n  canAdjust: boolean;\n  canUpdate: boolean;\n  openAdjustStockModal: (item: InventoryItem) => void;\n  openEditModal: (item: InventoryItem) => void;\n}\n\nexport const columns: ColumnDef<InventoryItem>[] = [\n  {\n    accessorKey: \"name\",\n    cell: ({ row }) => <span className=\"text-base-content font-medium\">{row.original.name}</span>,\n    header: \"Nombre\",\n  },\n  {\n    accessorKey: \"category_name\",\n    cell: ({ row }) => <span className=\"text-base-content\">{row.original.category_name ?? \"Sin categoría\"}</span>,\n    header: \"Categoría\",\n  },\n  {\n    accessorKey: \"description\",\n    cell: ({ row }) => <span className=\"text-base-content/60\">{row.original.description ?? \"—\"}</span>,\n    header: \"Descripción\",\n  },\n  {\n    accessorKey: \"current_stock\",\n    cell: ({ row }) => <span className=\"text-base-content\">{row.original.current_stock}</span>,\n    header: \"Stock actual\",\n  },\n  {\n    cell: ({ row, table }) => {\n      const meta = table.options.meta as InventoryTableMeta;\n      const { canAdjust, canUpdate, openAdjustStockModal, openEditModal } = meta;\n      const item = row.original;\n\n      return (\n        <div className=\"flex justify-end gap-3 px-4 py-3 text-right text-xs font-semibold tracking-wide uppercase\">\n          <Button\n            disabled={!canAdjust}\n            onClick={() => {\n              openAdjustStockModal(item);\n            }}\n            size=\"sm\"\n            title={canAdjust ? undefined : \"Sin permiso\"}\n            variant=\"secondary\"\n          >\n            {!canAdjust && <Lock className=\"mr-1\" size={12} />}\n            Ajustar stock\n          </Button>\n          <Button\n            disabled={!canUpdate}\n            onClick={() => {\n              openEditModal(item);\n            }}\n            size=\"sm\"\n            title={canUpdate ? undefined : \"Sin permiso\"}\n            variant=\"secondary\"\n          >\n            {!canUpdate && <Lock className=\"mr-1\" size={12} />}\n            Editar\n          </Button>\n        </div>\n      );\n    },\n    header: () => <div className=\"text-right\">Acciones</div>,\n    id: \"actions\",\n  },\n];\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/inventory/queries.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/inventory/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/notifications/api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/operations/inventory/pages/InventoryPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/operations/supplies/pages/SuppliesPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-empty-function","severity":2,"message":"Unexpected empty arrow function.","line":17,"column":83,"nodeType":"ArrowFunctionExpression","messageId":"unexpected","endLine":17,"endColumn":85,"suggestions":[{"messageId":"suggestComment","data":{"name":"arrow function"},"fix":{"range":[808,808],"text":" /* empty */ "},"desc":"Add comment inside empty arrow function."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useAuth } from \"@/context/AuthContext\";\nimport SupplyRequestForm from \"@/features/supplies/components/SupplyRequestForm\";\nimport SupplyRequestsTable from \"@/features/supplies/components/SupplyRequestsTable\";\nimport { useSupplyManagement } from \"@/features/supplies/hooks/use-supply-management\";\n\nexport default function Supplies() {\n  const { can } = useAuth();\n  const { commonSupplies, handleStatusChange, refresh, requests } = useSupplyManagement();\n\n  const canCreate = can(\"create\", \"SupplyRequest\");\n  const canUpdate = can(\"update\", \"SupplyRequest\");\n\n  return (\n    <div className=\"mx-auto max-w-7xl space-y-6\">\n      {canCreate && <SupplyRequestForm commonSupplies={commonSupplies} onSuccess={refresh} />}\n\n      <SupplyRequestsTable onStatusChange={canUpdate ? handleStatusChange : () => {}} requests={requests} />\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/participants/api.ts","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, comparison is always false, since `\"ok\" !== \"ok\"` is false.","line":14,"column":7,"nodeType":"BinaryExpression","messageId":"comparisonBetweenLiteralTypes","endLine":14,"endColumn":27},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":15,"column":34,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":15,"endColumn":36,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[563,565],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, comparison is always false, since `\"ok\" !== \"ok\"` is false.","line":31,"column":7,"nodeType":"BinaryExpression","messageId":"comparisonBetweenLiteralTypes","endLine":31,"endColumn":27},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":32,"column":34,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":32,"endColumn":36,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1083,1085],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { apiClient } from \"@/lib/api-client\";\n\nimport type { ParticipantInsightResponse, ParticipantLeaderboardResponse } from \"./types\";\n\nexport async function fetchParticipantInsight(\n  participantId: string,\n  params?: { from?: string; to?: string }\n): Promise<ParticipantInsightResponse> {\n  const data = await apiClient.get<ParticipantInsightResponse & { message?: string; status: string }>(\n    `/api/transactions/participants/${encodeURIComponent(participantId)}`,\n    { query: params }\n  );\n\n  if (data.status !== \"ok\") {\n    throw new Error(data.message || \"No se pudo obtener la información del participante\");\n  }\n  return data;\n}\n\nexport async function fetchParticipantLeaderboard(params?: {\n  from?: string;\n  limit?: number;\n  mode?: \"combined\" | \"incoming\" | \"outgoing\";\n  to?: string;\n}): Promise<ParticipantLeaderboardResponse> {\n  const data = await apiClient.get<ParticipantLeaderboardResponse & { message?: string; status: string }>(\n    \"/api/transactions/participants\",\n    { query: params }\n  );\n\n  if (data.status !== \"ok\") {\n    throw new Error(data.message || \"No se pudo obtener la información del participante\");\n  }\n  return data;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/participants/components/ParticipantColumns.tsx","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":45,"column":79,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":45,"endColumn":81,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[1244,1246],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-confusing-void-expression","severity":2,"message":"Returning a void expression from an arrow function shorthand is forbidden. Please add braces to the arrow function.","line":51,"column":44,"nodeType":"CallExpression","messageId":"invalidVoidExprArrow","endLine":51,"endColumn":73},{"ruleId":"@typescript-eslint/no-unnecessary-type-conversion","severity":2,"message":"Passing a string to String() does not change the type or value of the string.","line":91,"column":61,"nodeType":"Identifier","messageId":"unnecessaryTypeConversion","endLine":91,"endColumn":67,"suggestions":[{"messageId":"suggestRemove","fix":{"range":[2444,2472],"text":"identificationNumber"},"desc":"Remove the type conversion."},{"messageId":"suggestSatisfies","data":{"type":"string"},"fix":{"range":[2444,2472],"text":"identificationNumber satisfies string"},"desc":"Instead, assert that the value satisfies the string type."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":95,"column":67,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":95,"endColumn":69,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2558,2590],"text":"(bankAccountHolder ?? counterpart)"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/no-unnecessary-type-conversion","severity":2,"message":"Passing a string to String() does not change the type or value of the string.","line":131,"column":28,"nodeType":"Identifier","messageId":"unnecessaryTypeConversion","endLine":131,"endColumn":34,"suggestions":[{"messageId":"suggestRemove","fix":{"range":[3742,3770],"text":"identificationNumber"},"desc":"Remove the type conversion."},{"messageId":"suggestSatisfies","data":{"type":"string"},"fix":{"range":[3742,3770],"text":"identificationNumber satisfies string"},"desc":"Instead, assert that the value satisfies the string type."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { ColumnDef } from \"@tanstack/react-table\";\nimport dayjs from \"dayjs\";\n\nimport Button from \"@/components/ui/Button\";\nimport { fmtCLP } from \"@/lib/format\";\nimport { formatRut } from \"@/lib/rut\";\n\nimport type { LeaderboardDisplayRow, ParticipantCounterpartRow, ParticipantMonthlyRow } from \"../types\";\n\n// --- Leaderboard Columns ---\n\nexport interface LeaderboardMeta {\n  detailLoading: boolean;\n  onSelect: (key: string) => void;\n  participantId: string;\n}\n\nexport const getLeaderboardColumns = (): ColumnDef<LeaderboardDisplayRow>[] => [\n  {\n    accessorKey: \"displayName\",\n    cell: ({ row }) => <div className=\"font-medium\">{row.getValue(\"displayName\")}</div>,\n    header: \"Titular\",\n  },\n  {\n    accessorKey: \"rut\",\n    header: \"RUT\",\n  },\n  {\n    accessorKey: \"account\",\n    header: \"Cuenta\",\n  },\n  {\n    accessorKey: \"outgoingCount\",\n    header: \"Egresos (#)\",\n  },\n  {\n    accessorKey: \"outgoingAmount\",\n    cell: ({ row }) => fmtCLP(row.getValue(\"outgoingAmount\")),\n    header: \"Egresos ($)\",\n  },\n  {\n    cell: ({ row, table }) => {\n      const meta = table.options.meta as LeaderboardMeta;\n      const participantKey = row.original.selectKey;\n      const isActive = participantKey && participantKey === meta.participantId?.trim();\n\n      return (\n        <Button\n          className=\"h-8\"\n          disabled={meta.detailLoading || !participantKey}\n          onClick={() => participantKey && meta.onSelect(participantKey)}\n          size=\"sm\"\n          variant=\"ghost\"\n        >\n          {meta.detailLoading && isActive ? \"Cargando...\" : \"Ver detalle\"}\n        </Button>\n      );\n    },\n    header: \"Acción\",\n    id: \"action\",\n  },\n];\n\n// --- Monthly Columns ---\n\nexport const getMonthlyColumns = (): ColumnDef<ParticipantMonthlyRow>[] => [\n  {\n    accessorKey: \"month\",\n    cell: ({ getValue }) => (\n      <div className=\"font-medium capitalize\">{dayjs(getValue<string>()).format(\"MMMM YYYY\")}</div>\n    ),\n    header: \"Mes\",\n  },\n  {\n    accessorKey: \"outgoingCount\",\n    header: \"Cant.\",\n  },\n  {\n    accessorKey: \"outgoingAmount\",\n    cell: ({ row }) => fmtCLP(row.getValue(\"outgoingAmount\")),\n    header: \"Monto\",\n  },\n];\n\n// --- Counterparts Columns ---\n\nexport const getCounterpartsColumns = (): ColumnDef<ParticipantCounterpartRow>[] => [\n  {\n    cell: ({ row }) => {\n      const { bankAccountHolder, counterpart, identificationNumber } = row.original;\n      const formattedRut = identificationNumber ? formatRut(String(identificationNumber)) : \"\";\n\n      return (\n        <div>\n          <div className=\"text-sm font-medium\">{bankAccountHolder || counterpart || \"(desconocido)\"}</div>\n          <div className=\"text-base-content/60 mt-0.5 text-xs\">{formattedRut || \"-\"}</div>\n        </div>\n      );\n    },\n    header: \"Titular\",\n    id: \"holder\",\n  },\n  {\n    cell: ({ row }) => {\n      const {\n        bankAccountNumber,\n        bankAccountType,\n        bankBranch,\n        bankName,\n        identificationNumber,\n        identificationType,\n        withdrawId,\n      } = row.original;\n\n      // Format bank info\n      const bankParts: string[] = [];\n      if (bankName) bankParts.push(bankName);\n      if (bankAccountNumber) {\n        const accountLabel = bankAccountType ? `${bankAccountType} · ${bankAccountNumber}` : bankAccountNumber;\n        bankParts.push(accountLabel);\n      }\n      if (bankBranch) bankParts.push(bankBranch);\n      const bankSummary = bankParts.join(\" · \");\n\n      // Format metadata\n      const metadataParts: string[] = [];\n      if (withdrawId) metadataParts.push(withdrawId);\n      if (identificationType && identificationNumber) {\n        metadataParts.push(`${identificationType} ${identificationNumber}`);\n      } else if (identificationNumber) {\n        metadataParts.push(String(identificationNumber));\n      }\n\n      const metadata = metadataParts.join(\" · \");\n\n      return (\n        <div>\n          {bankSummary && <div className=\"text-xs\">{bankSummary}</div>}\n          {metadata && <div className=\"text-xs opacity-70\">{metadata}</div>}\n        </div>\n      );\n    },\n    header: \"Info\",\n    id: \"info\",\n  },\n  {\n    cell: ({ row }) => (\n      <div className=\"whitespace-nowrap\">\n        <div className=\"text-sm font-medium\">{fmtCLP(row.original.outgoingAmount)}</div>\n        <div className=\"text-base-content/60 text-xs\">{row.original.outgoingCount} txs</div>\n      </div>\n    ),\n    header: \"Monto\",\n    id: \"amount\",\n  },\n];\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/participants/hooks.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/participants/hooks/use-participant-insights-data.ts","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":40,"column":23,"nodeType":"MemberExpression","messageId":"alwaysTruthy","endLine":40,"endColumn":51},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":54,"column":39,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":54,"endColumn":41,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1624,1626],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":55,"column":49,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":55,"endColumn":51,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1679,1681],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":57,"column":35,"nodeType":"UnaryExpression","messageId":"alwaysTruthy","endLine":57,"endColumn":49},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":63,"column":64,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":63,"endColumn":66,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2068,2107],"text":"(row.bankAccountNumber ?? row.withdrawId)"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":63,"column":82,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":63,"endColumn":84,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2049,2135],"text":"(row.participant || row.bankAccountNumber || row.withdrawId ?? row.identificationNumber)"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":63,"column":110,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":63,"endColumn":112,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2136,2138],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":64,"column":47,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":64,"endColumn":49,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2167,2207],"text":"(row.bankAccountHolder ?? row.displayName)"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/no-unnecessary-type-conversion","severity":2,"message":"Passing a string to String() does not change the type or value of the string.","line":67,"column":21,"nodeType":"Identifier","messageId":"unnecessaryTypeConversion","endLine":67,"endColumn":27,"suggestions":[{"messageId":"suggestRemove","fix":{"range":[2371,2403],"text":"row.identificationNumber"},"desc":"Remove the type conversion."},{"messageId":"suggestSatisfies","data":{"type":"string"},"fix":{"range":[2371,2403],"text":"row.identificationNumber satisfies string"},"desc":"Instead, assert that the value satisfies the string type."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":70,"column":43,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":70,"endColumn":45,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2472,2511],"text":"(row.bankAccountNumber ?? row.withdrawId)"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":70,"column":61,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":70,"endColumn":63,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2497,2530],"text":"(row.withdrawId ?? row.participant)"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"sonarjs/cognitive-complexity","severity":2,"message":"Refactor this function to reduce its Cognitive Complexity from 17 to the 15 allowed.","line":83,"column":23,"nodeType":null,"messageId":"refactorFunction","endLine":83,"endColumn":25},{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":108,"column":21,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":108,"endColumn":34}],"suppressedMessages":[],"errorCount":13,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useQuery, useSuspenseQuery } from \"@tanstack/react-query\";\nimport dayjs from \"dayjs\";\nimport { useState } from \"react\";\n\nimport { formatRut } from \"@/lib/rut\";\n\nimport type { LeaderboardDisplayRow } from \"../types\";\n\nimport { type LeaderboardParams, participantQueries } from \"../queries\";\n\nconst MAX_MONTHS = 12;\n\ninterface RangeParams {\n  from?: string;\n  to?: string;\n}\n\nexport function useParticipantInsightsData() {\n  // Filters\n  const [participantId, setParticipantId] = useState(\"\");\n  const [from, setFrom] = useState(\"\");\n  const [to, setTo] = useState(\"\");\n  const [quickMonth, setQuickMonth] = useState(\"current\");\n  const [leaderboardLimit, setLeaderboardLimit] = useState(10);\n  const [leaderboardGrouping, setLeaderboardGrouping] = useState<\"account\" | \"rut\">(\"account\");\n  const [selectedRange, setSelectedRange] = useState<RangeParams>(() => resolveRange(\"current\", \"\", \"\"));\n\n  // Derived\n  const activeParticipantId = (participantId || \"\").trim();\n\n  // Queries\n  const leaderboardParams: LeaderboardParams = {\n    ...selectedRange,\n    limit: leaderboardLimit,\n    mode: \"outgoing\",\n  };\n\n  // 1. Leaderboard (Suspense-enabled)\n  const { data: leaderboardData } = useSuspenseQuery(participantQueries.leaderboard(leaderboardParams));\n  const leaderboard = leaderboardData.participants || [];\n\n  // 2. Details (Click-to-fetch, keeps useQuery)\n  const {\n    data: detailData,\n    error: detailErrorObj,\n    isLoading: detailLoading,\n  } = useQuery(\n    participantQueries.detail({\n      participantId: activeParticipantId,\n      ...selectedRange,\n    })\n  );\n\n  const monthly = detailData?.monthly || [];\n  const counterparts = detailData?.counterparts || [];\n  const detailError = detailErrorObj instanceof Error ? detailErrorObj.message : null;\n  const visible = !!detailData && !detailLoading && !detailError;\n\n  // Transformations (Memoization via React 19 Compiler, logic moved inline or simplifed)\n\n  // Account Grouping\n  const accountRows: LeaderboardDisplayRow[] = leaderboard.map((row) => {\n    const selectKey = row.participant || row.bankAccountNumber || row.withdrawId || row.identificationNumber || \"\";\n    const displayName = row.bankAccountHolder || row.displayName || row.participant || \"(sin información)\";\n    const rutValue =\n      row.identificationNumber && typeof row.identificationNumber === \"string\"\n        ? formatRut(String(row.identificationNumber))\n        : \"\";\n    const rut = rutValue || \"-\";\n    const account = row.bankAccountNumber || row.withdrawId || row.participant || \"-\";\n    return {\n      account,\n      displayName,\n      key: selectKey || `${displayName}-${account}`,\n      outgoingAmount: row.outgoingAmount,\n      outgoingCount: row.outgoingCount,\n      rut,\n      selectKey,\n    };\n  });\n\n  // RUT Grouping\n  const rutRows = (() => {\n    const map = new Map<\n      string,\n      {\n        accounts: Set<string>;\n        displayName: string;\n        outgoingAmount: number;\n        outgoingCount: number;\n        rut: string;\n        selectKey: string;\n      }\n    >();\n\n    for (const row of accountRows) {\n      const key = row.rut === \"-\" ? row.displayName : row.rut;\n      if (!map.has(key)) {\n        map.set(key, {\n          accounts: new Set<string>(),\n          displayName: row.displayName,\n          outgoingAmount: 0,\n          outgoingCount: 0,\n          rut: row.rut === \"-\" ? \"-\" : row.rut,\n          selectKey: row.selectKey,\n        });\n      }\n      const entry = map.get(key)!;\n      entry.outgoingCount += row.outgoingCount;\n      entry.outgoingAmount += row.outgoingAmount;\n      if (row.account && row.account !== \"-\") {\n        entry.accounts.add(row.account);\n      }\n      if ((!entry.displayName || entry.displayName === \"(sin información)\") && row.displayName) {\n        entry.displayName = row.displayName;\n      }\n      if (!entry.selectKey && row.selectKey) {\n        entry.selectKey = row.selectKey;\n      }\n    }\n\n    return [...map.entries()]\n      .map(([key, entry]) => ({\n        account: entry.accounts.size > 0 ? [...entry.accounts].slice(0, 4).join(\", \") : \"-\",\n        displayName: entry.displayName,\n        key,\n        outgoingAmount: entry.outgoingAmount,\n        outgoingCount: entry.outgoingCount,\n        rut: entry.rut,\n        selectKey: entry.selectKey,\n      }))\n      .toSorted((a, b) => {\n        if (b.outgoingAmount !== a.outgoingAmount) return b.outgoingAmount - a.outgoingAmount;\n        return b.outgoingCount - a.outgoingCount;\n      });\n  })();\n\n  const displayedLeaderboard: LeaderboardDisplayRow[] = leaderboardGrouping === \"account\" ? accountRows : rutRows;\n\n  // Options\n  const quickMonthOptions = (() => {\n    const options = [{ label: \"Mes actual\", value: \"current\" }];\n    for (let i = 1; i < MAX_MONTHS; i += 1) {\n      const date = dayjs().subtract(i, \"month\");\n      options.push({ label: date.format(\"MMMM YYYY\"), value: date.format(\"YYYY-MM\") });\n    }\n    options.push({ label: \"Personalizado\", value: \"custom\" });\n    return options;\n  })();\n\n  // Handlers\n  const handleSubmit = (event: React.FormEvent<HTMLFormElement>) => {\n    event.preventDefault();\n    const rangeParams = resolveRange(quickMonth, from, to);\n    setSelectedRange(rangeParams);\n    // Query auto-refetches due to key change\n  };\n\n  const handleSelectParticipant = (participant: string) => {\n    setParticipantId(participant);\n    // Query auto-refetches when id changes\n  };\n\n  return {\n    counterparts,\n    detailError,\n    detailLoading,\n    displayedLeaderboard,\n    from,\n    handleSelectParticipant,\n    // Handlers\n    handleSubmit,\n    // Data (Leaderboard)\n    leaderboard,\n    leaderboardError: null, // ErrorBoundary handles this\n    leaderboardGrouping,\n    leaderboardLimit,\n    leaderboardLoading: false, // Suspense handles initial, mutation handles updates? No, query handles all.\n    // Data (Details)\n    monthly,\n\n    // Filters & State\n    participantId,\n    quickMonth,\n    quickMonthOptions,\n    setFrom,\n\n    setLeaderboardGrouping,\n    setLeaderboardLimit,\n    setParticipantId,\n    setQuickMonth,\n    setTo,\n\n    to,\n    visible,\n  };\n}\n\nfunction resolveRange(quickValue: string, fromValue: string, toValue: string): RangeParams {\n  if (quickValue === \"custom\") {\n    const range: RangeParams = {};\n    if (fromValue) range.from = fromValue;\n    if (toValue) range.to = toValue;\n    return range;\n  }\n\n  const value = quickValue === \"current\" ? dayjs().format(\"YYYY-MM\") : quickValue;\n  const [yearStr, monthStr] = value.split(\"-\");\n  const year = Number(yearStr);\n  const monthIndex = Number(monthStr) - 1;\n\n  if (!Number.isFinite(year) || !Number.isFinite(monthIndex)) {\n    return {};\n  }\n\n  const start = dayjs(new Date(year, monthIndex, 1));\n  const end = start.endOf(\"month\");\n\n  return {\n    from: start.format(\"YYYY-MM-DD\"),\n    to: end.format(\"YYYY-MM-DD\"),\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/participants/queries.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/participants/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/participants/utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/payouts/PayoutsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/payouts/api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/payouts/components/columns.tsx","messages":[{"ruleId":"check-file/filename-naming-convention","severity":2,"message":"The filename \"columns.tsx\" does not match the \"PASCAL_CASE\" pattern","line":1,"column":1,"nodeType":"Program","messageId":"noMatch","endLine":84,"endColumn":1},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":21,"column":96,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":21,"endColumn":98,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[694,696],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":79,"column":102,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":79,"endColumn":104,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2462,2464],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ReleaseTransaction } from \"@finanzas/db/models\";\nimport { ColumnDef } from \"@tanstack/react-table\";\nimport dayjs from \"dayjs\";\nimport { ArrowDownLeft, ArrowUpRight } from \"lucide-react\";\n\nimport { fmtCLP } from \"@/lib/format\";\n\nexport const columns: ColumnDef<ReleaseTransaction>[] = [\n  {\n    accessorKey: \"date\",\n    cell: ({ row }) => (\n      <span className=\"text-base-content font-medium whitespace-nowrap\">\n        {dayjs(row.original.date).format(\"DD MMM YYYY HH:mm\")}\n      </span>\n    ),\n    header: \"Fecha\",\n  },\n  {\n    accessorKey: \"externalReference\",\n    cell: ({ row }) => (\n      <span className=\"text-base-content/70 font-mono text-xs\">{row.original.externalReference || \"-\"}</span>\n    ),\n    header: \"Referencia\",\n  },\n  {\n    accessorKey: \"description\",\n    cell: ({ row }) => (\n      <div className=\"flex items-center gap-2\">\n        <span className=\"badge badge-sm badge-ghost\">{row.original.description}</span>\n      </div>\n    ),\n    header: \"Descripción\",\n  },\n  {\n    accessorKey: \"grossAmount\",\n    cell: ({ row }) => <div className=\"text-right font-medium\">{fmtCLP(String(row.original.grossAmount))}</div>,\n    header: \"Monto Bruto\",\n  },\n  {\n    accessorKey: \"netDebitAmount\",\n    cell: ({ row }) => {\n      const amount = row.original.netDebitAmount;\n      if (!amount) return <div className=\"text-right\">-</div>;\n      return (\n        <div className=\"text-error flex items-center justify-end gap-1 font-medium\">\n          {fmtCLP(String(amount))}\n          <ArrowDownLeft className=\"h-3 w-3\" />\n        </div>\n      );\n    },\n    header: \"Débito Neto\",\n  },\n  {\n    accessorKey: \"netCreditAmount\",\n    cell: ({ row }) => {\n      const amount = row.original.netCreditAmount;\n      if (!amount) return <div className=\"text-right\">-</div>;\n      return (\n        <div className=\"text-success flex items-center justify-end gap-1 font-medium\">\n          {fmtCLP(String(amount))}\n          <ArrowUpRight className=\"h-3 w-3\" />\n        </div>\n      );\n    },\n    header: \"Crédito Neto\",\n  },\n  {\n    accessorKey: \"balanceAmount\",\n    cell: ({ row }) => (\n      <div className=\"text-base-content text-right font-bold\">\n        {row.original.balanceAmount ? fmtCLP(String(row.original.balanceAmount)) : \"-\"}\n      </div>\n    ),\n    header: \"Balance\",\n  },\n  {\n    accessorKey: \"payoutBankAccountNumber\",\n    cell: ({ row }) => (\n      <span className=\"text-base-content/70 font-mono text-xs\">{row.original.payoutBankAccountNumber || \"-\"}</span>\n    ),\n    header: \"Cuenta Destino\",\n  },\n];\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/payouts/hooks/use-payouts.ts","messages":[{"ruleId":"@typescript-eslint/no-empty-function","severity":2,"message":"Unexpected empty async method 'refresh'.","line":11,"column":26,"nodeType":"ArrowFunctionExpression","messageId":"unexpected","endLine":11,"endColumn":28,"suggestions":[{"messageId":"suggestComment","data":{"name":"async method 'refresh'"},"fix":{"range":[271,271],"text":" /* empty */ "},"desc":"Add comment inside empty async method 'refresh'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useSuspenseQuery } from \"@tanstack/react-query\";\n\nimport { payoutKeys } from \"../queries\";\n\nexport function usePayouts() {\n  const { data } = useSuspenseQuery(payoutKeys.list());\n\n  return {\n    page: data.page,\n    payouts: data.data,\n    refresh: async () => {}, // Handled by standard query invalidation if needed\n    total: data.total,\n    totalPages: data.totalPages,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/payouts/queries.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/people/api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/people/queries.ts","messages":[{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":9,"column":34,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":9,"endColumn":37}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { queryOptions } from \"@tanstack/react-query\";\n\nimport { fetchPerson } from \"./api\";\n\nexport const personKeys = {\n  all: [\"people\"] as const,\n  detail: (id: string | undefined) =>\n    queryOptions({\n      queryFn: () => fetchPerson(id!),\n      queryKey: [\"person\", id],\n    }),\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/personal-finance/api.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-return","severity":2,"message":"Unsafe return of a value of type `Promise<any>`.","line":35,"column":5,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":38,"endColumn":8},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1068,1071],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1068,1071],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { apiClient } from \"@/lib/api-client\";\n\nimport type { CreateCreditInput, PayInstallmentInput, PersonalCredit } from \"./types\";\n\nexport const personalFinanceApi = {\n  // Create\n  createCredit: async (data: CreateCreditInput) => {\n    return apiClient.post<PersonalCredit>(\"/api/personal-finance/credits\", {\n      ...data,\n      installments: data.installments?.map((i) => ({\n        ...i,\n        dueDate: i.dueDate.toISOString(),\n      })),\n      startDate: data.startDate.toISOString(),\n    });\n  },\n\n  // Delete\n  deleteCredit: async (id: number) => {\n    return apiClient.delete<{ success: boolean }>(`/api/personal-finance/credits/${id}`);\n  },\n\n  // Get Detail\n  getCredit: async (id: number) => {\n    return apiClient.get<PersonalCredit>(`/api/personal-finance/credits/${id}`);\n  },\n\n  // List\n  listCredits: async () => {\n    return apiClient.get<PersonalCredit[]>(\"/api/personal-finance/credits\");\n  },\n\n  // Pay Installment\n  payInstallment: async (creditId: number, installmentNumber: number, data: PayInstallmentInput) => {\n    return apiClient.post<any>(`/api/personal-finance/credits/${creditId}/installments/${installmentNumber}/pay`, {\n      ...data,\n      paymentDate: data.paymentDate.toISOString(),\n    });\n  },\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/personal-finance/components/CreateCreditForm.tsx","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":201,"column":28,"nodeType":"MemberExpression","messageId":"alwaysTruthy","endLine":201,"endColumn":45}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useForm } from \"@tanstack/react-form\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { PlusIcon } from \"lucide-react\";\nimport { useState } from \"react\";\nimport { toast } from \"sonner\";\n\nimport Button from \"@/components/ui/Button\";\nimport Input from \"@/components/ui/Input\";\nimport Modal from \"@/components/ui/Modal\";\n\nimport { personalFinanceApi } from \"../api\";\nimport { personalFinanceKeys } from \"../queries\";\nimport { type CreateCreditInput, createCreditSchema } from \"../types\";\n\nexport function CreateCreditForm() {\n  const [open, setOpen] = useState(false);\n  const queryClient = useQueryClient();\n\n  const mutation = useMutation({\n    mutationFn: personalFinanceApi.createCredit,\n    onError: (error) => {\n      toast.error(\"Error al crear crédito\");\n      console.error(error);\n    },\n    onSuccess: () => {\n      void queryClient.invalidateQueries({ queryKey: personalFinanceKeys.all });\n      toast.success(\"Crédito creado exitosamente\");\n      setOpen(false);\n      form.reset();\n    },\n  });\n\n  const form = useForm({\n    defaultValues: {\n      bankName: \"\",\n      creditNumber: \"\",\n      currency: \"CLP\" as const,\n      description: \"\",\n      startDate: new Date(),\n      totalAmount: 0,\n      totalInstallments: 1,\n    } as CreateCreditInput,\n    onSubmit: ({ value }) => {\n      // Validate with Zod schema before submitting\n      const result = createCreditSchema.safeParse(value);\n      if (!result.success) {\n        toast.error(result.error.issues[0]?.message ?? \"Error de validación\");\n        return;\n      }\n      mutation.mutate(value);\n    },\n  });\n\n  return (\n    <>\n      <Button\n        onClick={() => {\n          setOpen(true);\n        }}\n      >\n        <PlusIcon className=\"mr-2 size-4\" />\n        Nuevo Crédito\n      </Button>\n\n      <Modal\n        className=\"max-w-xl\"\n        isOpen={open}\n        onClose={() => {\n          setOpen(false);\n        }}\n        title=\"Crear Nuevo Crédito\"\n      >\n        <form\n          className=\"space-y-4\"\n          onSubmit={(e) => {\n            e.preventDefault();\n            e.stopPropagation();\n            void form.handleSubmit();\n          }}\n        >\n          <form.Field name=\"bankName\">\n            {(field) => (\n              <div>\n                <Input\n                  error={field.state.meta.errors.join(\", \")}\n                  label=\"Banco / Institución\"\n                  onBlur={field.handleBlur}\n                  onChange={(e) => {\n                    field.handleChange(e.target.value);\n                  }}\n                  placeholder=\"Ej: BCI\"\n                  value={field.state.value}\n                />\n              </div>\n            )}\n          </form.Field>\n\n          <form.Field name=\"creditNumber\">\n            {(field) => (\n              <div>\n                <Input\n                  error={field.state.meta.errors.join(\", \")}\n                  label=\"Número / Identificador\"\n                  onBlur={field.handleBlur}\n                  onChange={(e) => {\n                    field.handleChange(e.target.value);\n                  }}\n                  placeholder=\"Ej: 123456\"\n                  value={field.state.value}\n                />\n              </div>\n            )}\n          </form.Field>\n\n          <form.Field name=\"description\">\n            {(field) => (\n              <div>\n                <Input\n                  error={field.state.meta.errors.join(\", \")}\n                  label=\"Descripción\"\n                  onBlur={field.handleBlur}\n                  onChange={(e) => {\n                    field.handleChange(e.target.value);\n                  }}\n                  placeholder=\"Ej: Crédito Hipotecario\"\n                  value={field.state.value}\n                />\n              </div>\n            )}\n          </form.Field>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <form.Field name=\"totalAmount\">\n              {(field) => (\n                <div>\n                  <Input\n                    error={field.state.meta.errors.join(\", \")}\n                    label=\"Monto Total\"\n                    onBlur={field.handleBlur}\n                    onChange={(e) => {\n                      field.handleChange(Number.parseFloat(e.target.value) || 0);\n                    }}\n                    type=\"number\"\n                    value={field.state.value}\n                  />\n                </div>\n              )}\n            </form.Field>\n\n            <form.Field name=\"currency\">\n              {(field) => (\n                <div>\n                  <Input\n                    as=\"select\"\n                    error={field.state.meta.errors.join(\", \")}\n                    label=\"Moneda\"\n                    onBlur={field.handleBlur}\n                    onChange={(e) => {\n                      field.handleChange(e.target.value as \"CLP\" | \"UF\" | \"USD\");\n                    }}\n                    value={field.state.value}\n                  >\n                    <option value=\"CLP\">CLP</option>\n                    <option value=\"UF\">UF</option>\n                    <option value=\"USD\">USD</option>\n                  </Input>\n                </div>\n              )}\n            </form.Field>\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <form.Field name=\"totalInstallments\">\n              {(field) => (\n                <div>\n                  <Input\n                    error={field.state.meta.errors.join(\", \")}\n                    label=\"Cuotas\"\n                    onBlur={field.handleBlur}\n                    onChange={(e) => {\n                      field.handleChange(Number.parseInt(e.target.value) || 1);\n                    }}\n                    type=\"number\"\n                    value={field.state.value}\n                  />\n                </div>\n              )}\n            </form.Field>\n\n            <form.Field name=\"startDate\">\n              {(field) => (\n                <div>\n                  <Input\n                    error={field.state.meta.errors.join(\", \")}\n                    label=\"Fecha Inicio\"\n                    onBlur={field.handleBlur}\n                    onChange={(e) => {\n                      field.handleChange(new Date(e.target.value));\n                    }}\n                    type=\"date\"\n                    value={field.state.value ? new Date(field.state.value).toISOString().split(\"T\")[0] : \"\"}\n                  />\n                </div>\n              )}\n            </form.Field>\n          </div>\n\n          <div className=\"mt-6 flex justify-end gap-3\">\n            <Button\n              disabled={mutation.isPending}\n              onClick={() => {\n                setOpen(false);\n              }}\n              variant=\"ghost\"\n            >\n              Cancelar\n            </Button>\n            <Button isLoading={mutation.isPending} type=\"submit\">\n              Guardar\n            </Button>\n          </div>\n        </form>\n      </Modal>\n    </>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/personal-finance/components/PayInstallmentModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-type-conversion","severity":2,"message":"Passing a number to Number() does not change the type or value of the number.","line":39,"column":15,"nodeType":"Identifier","messageId":"unnecessaryTypeConversion","endLine":39,"endColumn":21,"suggestions":[{"messageId":"suggestRemove","fix":{"range":[1349,1375],"text":"installment.amount"},"desc":"Remove the type conversion."},{"messageId":"suggestSatisfies","data":{"type":"number"},"fix":{"range":[1349,1375],"text":"installment.amount satisfies number"},"desc":"Instead, assert that the value satisfies the number type."}]},{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"Using `join()` for field.state.meta.errors may use Object's default stringification format ('[object Object]') when stringified.","line":96,"column":59,"nodeType":"MemberExpression","messageId":"baseArrayJoin","endLine":96,"endColumn":82},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":113,"column":26,"nodeType":"MemberExpression","messageId":"alwaysTruthy","endLine":113,"endColumn":43},{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"Using `join()` for field.state.meta.errors may use Object's default stringification format ('[object Object]') when stringified.","line":116,"column":59,"nodeType":"MemberExpression","messageId":"baseArrayJoin","endLine":116,"endColumn":82}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useForm } from \"@tanstack/react-form\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useState } from \"react\";\nimport { toast } from \"sonner\";\n\nimport Button from \"@/components/ui/Button\";\nimport Input from \"@/components/ui/Input\";\nimport Modal from \"@/components/ui/Modal\";\n\nimport { personalFinanceApi } from \"../api\";\nimport { personalFinanceKeys } from \"../queries\";\nimport { type PayInstallmentInput, payInstallmentSchema, type PersonalCreditInstallment } from \"../types\";\n\ninterface PayInstallmentModalProps {\n  readonly creditId: number;\n  readonly installment: PersonalCreditInstallment;\n}\n\nexport function PayInstallmentModal({ creditId, installment }: PayInstallmentModalProps) {\n  const [open, setOpen] = useState(false);\n  const queryClient = useQueryClient();\n\n  const mutation = useMutation({\n    mutationFn: (data: PayInstallmentInput) =>\n      personalFinanceApi.payInstallment(creditId, installment.installmentNumber, data),\n    onError: (error) => {\n      toast.error(\"Error al pagar cuota\");\n      console.error(error);\n    },\n    onSuccess: () => {\n      void queryClient.invalidateQueries({ queryKey: personalFinanceKeys.credit(creditId) });\n      toast.success(\"Cuota pagada exitosamente\");\n      setOpen(false);\n    },\n  });\n\n  const form = useForm({\n    defaultValues: {\n      amount: Number(installment.amount),\n      paymentDate: new Date(),\n    } as PayInstallmentInput,\n    onSubmit: ({ value }) => {\n      mutation.mutate(value);\n    },\n    validators: {\n      onChange: payInstallmentSchema,\n    },\n  });\n\n  return (\n    <>\n      <Button\n        onClick={() => {\n          setOpen(true);\n        }}\n        size=\"sm\"\n        variant=\"outline\"\n      >\n        Pagar\n      </Button>\n\n      <Modal\n        className=\"max-w-md\"\n        isOpen={open}\n        onClose={() => {\n          setOpen(false);\n        }}\n        title={`Pagar Cuota #${installment.installmentNumber}`}\n      >\n        <div className=\"mb-4 text-sm text-gray-500\">\n          Registrar pago de la cuota vencida el {new Date(installment.dueDate).toLocaleDateString()}.\n        </div>\n\n        <form\n          className=\"space-y-4\"\n          onSubmit={(e) => {\n            e.preventDefault();\n            e.stopPropagation();\n            void form.handleSubmit();\n          }}\n        >\n          <form.Field name=\"amount\">\n            {(field) => (\n              <div>\n                <Input\n                  label=\"Monto Pagado\"\n                  onBlur={field.handleBlur}\n                  onChange={(e) => {\n                    field.handleChange(Number.parseFloat(e.target.value));\n                  }}\n                  required\n                  type=\"number\"\n                  value={field.state.value}\n                />\n                {field.state.meta.errors.length > 0 && (\n                  <p className=\"text-error mt-1 text-xs\">{field.state.meta.errors.join(\", \")}</p>\n                )}\n              </div>\n            )}\n          </form.Field>\n\n          <form.Field name=\"paymentDate\">\n            {(field) => (\n              <div>\n                <Input\n                  label=\"Fecha de Pago\"\n                  onBlur={field.handleBlur}\n                  onChange={(e) => {\n                    field.handleChange(new Date(e.target.value));\n                  }}\n                  required\n                  type=\"date\"\n                  value={field.state.value ? field.state.value.toISOString().split(\"T\")[0] : \"\"}\n                />\n                {field.state.meta.errors.length > 0 && (\n                  <p className=\"text-error mt-1 text-xs\">{field.state.meta.errors.join(\", \")}</p>\n                )}\n              </div>\n            )}\n          </form.Field>\n\n          <div className=\"mt-6 flex justify-end gap-3\">\n            <Button\n              disabled={mutation.isPending}\n              onClick={() => {\n                setOpen(false);\n              }}\n              variant=\"ghost\"\n            >\n              Cancelar\n            </Button>\n            <Button isLoading={mutation.isPending} type=\"submit\">\n              {mutation.isPending ? \"Pagando...\" : \"Confirmar Pago\"}\n            </Button>\n          </div>\n        </form>\n      </Modal>\n    </>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/personal-finance/pages/PersonalCreditDetailsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-type-conversion","severity":2,"message":"Passing a number to Number() does not change the type or value of the number.","line":29,"column":68,"nodeType":"Identifier","messageId":"unnecessaryTypeConversion","endLine":29,"endColumn":74,"suggestions":[{"messageId":"suggestRemove","fix":{"range":[1172,1199],"text":"row.original.amount"},"desc":"Remove the type conversion."},{"messageId":"suggestSatisfies","data":{"type":"number"},"fix":{"range":[1172,1199],"text":"row.original.amount satisfies number"},"desc":"Instead, assert that the value satisfies the number type."}]},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":52,"column":43,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":52,"endColumn":77,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[1927,1947],"text":"Readonly<{ creditId: number }>"},"desc":"Mark the props as read-only"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always falsy.","line":55,"column":7,"nodeType":"UnaryExpression","messageId":"alwaysFalsy","endLine":55,"endColumn":14},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":69,"column":51,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":69,"endColumn":53,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2632,2634],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/no-unnecessary-type-conversion","severity":2,"message":"Passing a number to Number() does not change the type or value of the number.","line":80,"column":65,"nodeType":"Identifier","messageId":"unnecessaryTypeConversion","endLine":80,"endColumn":71,"suggestions":[{"messageId":"suggestRemove","fix":{"range":[3167,3193],"text":"credit.totalAmount"},"desc":"Remove the type conversion."},{"messageId":"suggestSatisfies","data":{"type":"number"},"fix":{"range":[3167,3193],"text":"credit.totalAmount satisfies number"},"desc":"Instead, assert that the value satisfies the number type."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":103,"column":39,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":103,"endColumn":41,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[3989,3991],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useSuspenseQuery } from \"@tanstack/react-query\";\nimport { Link, useParams } from \"@tanstack/react-router\";\nimport { ColumnDef } from \"@tanstack/react-table\";\nimport { ArrowLeftIcon } from \"lucide-react\";\nimport { Suspense } from \"react\";\n\nimport { DataTable } from \"@/components/data-table/DataTable\";\nimport { Badge } from \"@/components/ui/Badge\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/Card\";\nimport { formatCurrency } from \"@/lib/utils\";\n\nimport { PayInstallmentModal } from \"../components/PayInstallmentModal\";\nimport { personalFinanceQueries } from \"../queries\";\nimport { PersonalCreditInstallment } from \"../types\";\n\nconst installmentColumns = (currency: string, creditId: number): ColumnDef<PersonalCreditInstallment>[] => [\n  {\n    accessorKey: \"installmentNumber\",\n    cell: ({ row }) => <span className=\"font-medium\">{row.original.installmentNumber}</span>,\n    header: \"#\",\n  },\n  {\n    accessorKey: \"dueDate\",\n    cell: ({ row }) => new Date(row.original.dueDate).toLocaleDateString(),\n    header: \"Vencimiento\",\n  },\n  {\n    accessorKey: \"amount\",\n    cell: ({ row }) => <div className=\"text-right\">{formatCurrency(Number(row.original.amount), currency)}</div>,\n    header: ({ column: _column }) => <div className=\"text-right\">Monto</div>,\n  },\n  {\n    accessorKey: \"status\",\n    cell: ({ row }) => (\n      <div className=\"flex justify-center\">\n        <Badge variant={row.original.status === \"PAID\" ? \"success\" : \"outline\"}>{row.original.status}</Badge>\n      </div>\n    ),\n    header: \"Estado\",\n  },\n  {\n    cell: ({ row }) => (\n      <div className=\"flex justify-end\">\n        {row.original.status !== \"PAID\" && <PayInstallmentModal creditId={creditId} installment={row.original} />}\n      </div>\n    ),\n    header: ({ column: _column }) => <div className=\"text-right\">Acción</div>,\n    id: \"actions\",\n  },\n];\n\nexport function PersonalCreditDetailsPage({ creditId }: { creditId: number }) {\n  const { data: credit } = useSuspenseQuery(personalFinanceQueries.detail(creditId));\n\n  if (!credit) return null;\n\n  const columns = installmentColumns(credit.currency, credit.id);\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center gap-4\">\n        <Link\n          className=\"btn btn-ghost btn-sm no-animation ease-apple size-8 p-0 transition-all duration-200 hover:-translate-y-px active:translate-y-0 active:scale-[0.98]\"\n          to=\"/finanzas/personal-credits\"\n        >\n          <ArrowLeftIcon className=\"size-4\" />\n        </Link>\n        <h1 className=\"text-3xl font-bold tracking-tight\">\n          {credit.bankName} - {credit.description || credit.creditNumber}\n        </h1>\n        <div className={`badge ${credit.status === \"ACTIVE\" ? \"badge-primary\" : \"badge-ghost\"}`}>{credit.status}</div>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Monto Total</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{formatCurrency(Number(credit.totalAmount), credit.currency)}</div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Cuotas</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">\n              {credit.installments?.filter((i: PersonalCreditInstallment) => i.status === \"PAID\").length} /{\" \"}\n              {credit.totalInstallments}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Tabla de Amortización</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <DataTable\n            columns={columns}\n            data={credit.installments || []}\n            enableToolbar={false}\n            enableVirtualization={false}\n            pageCount={-1}\n          />\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nexport default function PersonalCreditDetailsPageWrapper() {\n  const params = useParams({ from: \"/_authed/finanzas/personal-credits/$creditId\" });\n\n  return (\n    <Suspense fallback={<div>Cargando detalle...</div>}>\n      <PersonalCreditDetailsPage creditId={Number(params.creditId)} />\n    </Suspense>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/personal-finance/pages/PersonalCreditsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-type-conversion","severity":2,"message":"Passing a number to Number() does not change the type or value of the number.","line":26,"column":39,"nodeType":"Identifier","messageId":"unnecessaryTypeConversion","endLine":26,"endColumn":45,"suggestions":[{"messageId":"suggestRemove","fix":{"range":[804,836],"text":"row.original.totalAmount"},"desc":"Remove the type conversion."},{"messageId":"suggestSatisfies","data":{"type":"number"},"fix":{"range":[804,836],"text":"row.original.totalAmount satisfies number"},"desc":"Instead, assert that the value satisfies the number type."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":33,"column":89,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":33,"endColumn":91,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1090,1092],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useSuspenseQuery } from \"@tanstack/react-query\";\nimport { Link } from \"@tanstack/react-router\";\nimport { ColumnDef } from \"@tanstack/react-table\";\nimport { Suspense } from \"react\";\n\nimport { DataTable } from \"@/components/data-table/DataTable\";\nimport { formatCurrency } from \"@/lib/utils\";\n\nimport type { PersonalCredit } from \"../types\";\n\nimport { CreateCreditForm } from \"../components/CreateCreditForm\";\nimport { personalFinanceQueries } from \"../queries\";\n\nconst columns: ColumnDef<PersonalCredit>[] = [\n  {\n    accessorKey: \"bankName\",\n    cell: ({ row }) => <span className=\"font-medium\">{row.original.bankName}</span>,\n    header: \"Banco\",\n  },\n  {\n    accessorKey: \"description\",\n    header: \"Descripción\",\n  },\n  {\n    accessorKey: \"totalAmount\",\n    cell: ({ row }) => formatCurrency(Number(row.original.totalAmount), row.original.currency),\n    header: \"Monto Total\",\n  },\n  {\n    accessorKey: \"progress\",\n    cell: ({ row }) => {\n      // Simple static bar for verification phase\n      const paid = row.original.installments?.filter((i) => i.status === \"PAID\").length || 0;\n      const total = row.original.totalInstallments || 1;\n      const percent = Math.min(100, Math.round((paid / total) * 100));\n\n      return (\n        <div className=\"bg-base-200 dark:bg-base-700 h-2.5 w-full rounded-full\">\n          <div className=\"bg-primary h-2.5 rounded-full transition-all\" style={{ width: `${percent}%` }}></div>\n        </div>\n      );\n    },\n    header: \"Progreso\",\n  },\n  {\n    accessorKey: \"status\",\n    cell: ({ row }) => {\n      const status = row.original.status;\n      const badgeClass = status === \"ACTIVE\" ? \"badge-primary\" : \"badge-ghost\";\n      return <div className={`badge ${badgeClass}`}>{status}</div>;\n    },\n    header: \"Estado\",\n  },\n  {\n    cell: ({ row }) => (\n      <Link\n        className=\"btn btn-ghost btn-sm no-animation ease-apple transition-all duration-200 hover:-translate-y-px active:translate-y-0 active:scale-[0.98]\"\n        params={{ creditId: row.original.id.toString() }}\n        to=\"/finanzas/personal-credits/$creditId\"\n      >\n        Ver Detalle\n      </Link>\n    ),\n    id: \"actions\",\n  },\n];\n\nexport function PersonalCreditsPage() {\n  const { data: credits } = useSuspenseQuery(personalFinanceQueries.list());\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <h1 className=\"text-3xl font-bold tracking-tight\">Créditos Personales</h1>\n        <CreateCreditForm />\n      </div>\n      <DataTable columns={columns} data={credits} />\n    </div>\n  );\n}\n\nexport default function PersonalCreditsPageWrapper() {\n  return (\n    <Suspense fallback={<div>Cargando créditos...</div>}>\n      <PersonalCreditsPage />\n    </Suspense>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/personal-finance/queries.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/personal-finance/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/production-balances/DailyBalancePage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always falsy.","line":79,"column":12,"nodeType":"Identifier","messageId":"alwaysFalsy","endLine":79,"endColumn":21}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Daily Balance - Main Page Component\n *\n * Redesigned with:\n * - Sticky TopBar with date and actions\n * - WeekStrip navigation\n * - Two-column layout: EntryForm + CierrePanel\n * - Keyboard shortcuts (⌘S)\n * - Autosave\n */\n\nimport Alert from \"@/components/ui/Alert\";\nimport { useAuth } from \"@/context/AuthContext\";\n\nimport { CierrePanel } from \"./components/CierrePanel\";\nimport { EntryForm } from \"./components/EntryForm\";\nimport { TopBar } from \"./components/TopBar\";\nimport { WeekStrip } from \"./components/WeekStrip\";\nimport { useDailyBalanceForm } from \"./hooks/use-daily-balance-form\";\n\nexport default function DailyBalancePage() {\n  const { can } = useAuth();\n  const canView = can(\"read\", \"DailyBalance\");\n\n  const {\n    finalize,\n    formData,\n    goToNextWeek,\n    goToPrevWeek,\n    goToToday,\n    isLoading,\n    isSaving,\n    lastSaved,\n    save,\n    selectDate,\n    selectedDate,\n    status,\n    summary,\n    updateField,\n    weekData,\n  } = useDailyBalanceForm();\n\n  if (!canView) {\n    return (\n      <div className=\"p-6\">\n        <Alert variant=\"error\">No tienes permisos para ver los balances diarios.</Alert>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex h-full flex-col\">\n      {/* Sticky TopBar */}\n      <TopBar\n        canFinalize={summary.cuadra && summary.totalMetodos > 0}\n        date={selectedDate}\n        isSaving={isSaving}\n        onFinalize={finalize}\n        onNextWeek={goToNextWeek}\n        onPrevWeek={goToPrevWeek}\n        onSave={save}\n        status={status}\n      />\n\n      {/* Week Navigation */}\n      <WeekStrip\n        currentDate={selectedDate}\n        onGoToToday={goToToday}\n        onNextWeek={goToNextWeek}\n        onPrevWeek={goToPrevWeek}\n        onSelectDate={selectDate}\n        weekData={weekData}\n      />\n\n      {/* Main Content: 2-column layout */}\n      <div className=\"grid flex-1 gap-4 lg:grid-cols-12\">\n        {/* Entry Form - main column */}\n        <div className=\"lg:col-span-8\">\n          {isLoading ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <span className=\"loading loading-spinner loading-lg\" />\n            </div>\n          ) : (\n            <EntryForm disabled={isSaving} onChange={updateField} values={formData} />\n          )}\n        </div>\n\n        {/* CierrePanel - sticky sidebar */}\n        <div className=\"lg:col-span-4\">\n          <CierrePanel\n            isSaving={isSaving}\n            lastSaved={lastSaved}\n            onFinalize={finalize}\n            onSaveDraft={save}\n            status={status}\n            summary={summary}\n          />\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/production-balances/api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/production-balances/components/CierrePanel.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":21,"column":29,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":29,"endColumn":20,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[567,583],"text":"Readonly<CierrePanelProps>"},"desc":"Mark the props as read-only"}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Function Call Object Injection Sink","line":56,"column":75,"nodeType":"MemberExpression","endLine":56,"endColumn":95},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":57,"column":12,"nodeType":"MemberExpression","endLine":57,"endColumn":32},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":116,"column":21,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":116,"endColumn":103,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[3555,3604],"text":"Readonly<{ label: string; muted?: boolean; value: number }>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { fmtCLP } from \"@/lib/format\";\nimport { cn } from \"@/lib/utils\";\n\nimport type { BalanceSummary, DayStatus } from \"../types\";\n\nimport { formatSaveTime } from \"../utils\";\n\ninterface CierrePanelProps {\n  className?: string;\n  isSaving: boolean;\n  lastSaved: Date | null;\n  onFinalize: () => void;\n  onSaveDraft: () => void;\n  status: DayStatus;\n  summary: BalanceSummary;\n}\n\n/**\n * Sticky sidebar showing live summary and action buttons\n */\nexport function CierrePanel({\n  className,\n  isSaving,\n  lastSaved,\n  onFinalize,\n  onSaveDraft,\n  status,\n  summary,\n}: CierrePanelProps) {\n  const statusLabels: Record<DayStatus, string> = {\n    balanced: \"Cuadra\",\n    draft: \"Borrador\",\n    empty: \"Vacío\",\n    unbalanced: \"Pendiente\",\n  };\n\n  const statusColors: Record<DayStatus, string> = {\n    balanced: \"bg-success/20 text-success\",\n    draft: \"bg-warning/20 text-warning\",\n    empty: \"bg-base-content/10 text-base-content/60\",\n    unbalanced: \"bg-error/20 text-error\",\n  };\n\n  const canFinalize = summary.cuadra && summary.totalMetodos > 0;\n\n  return (\n    <aside\n      className={cn(\n        \"bg-base-200/50 border-base-content/10 sticky top-4 rounded-2xl border p-4 backdrop-blur-sm\",\n        className\n      )}\n    >\n      {/* Header */}\n      <div className=\"mb-4 flex items-center justify-between\">\n        <h2 className=\"text-lg font-semibold\">Cierre</h2>\n        <span className={cn(\"rounded-full px-3 py-1 text-xs font-medium\", statusColors[status])}>\n          {statusLabels[status]}\n        </span>\n      </div>\n\n      {/* Summary rows */}\n      <div className=\"bg-base-300/30 border-base-content/5 space-y-1 rounded-xl border p-3\">\n        <SummaryRow label=\"Métodos\" value={summary.totalMetodos} />\n        <SummaryRow label=\"Servicios\" value={summary.totalServicios} />\n        <SummaryRow label=\"Gastos\" muted value={summary.gastos} />\n\n        {/* Diferencia - highlighted */}\n        <div className=\"border-base-content/10 mt-2 border-t pt-2\">\n          <div className=\"flex items-baseline justify-between\">\n            <span className={cn(\"text-sm font-medium\", summary.cuadra ? \"text-success\" : \"text-warning\")}>\n              Diferencia\n            </span>\n            <span className={cn(\"text-xl font-bold tabular-nums\", summary.cuadra ? \"text-success\" : \"text-warning\")}>\n              {fmtCLP(summary.diferencia)}\n            </span>\n          </div>\n\n          {!summary.cuadra && summary.totalMetodos > 0 && (\n            <p className=\"text-base-content/50 mt-1 text-xs\">\n              {summary.diferencia > 0 ? \"Asigna más a servicios\" : \"Reduce servicios o aumenta métodos\"}\n            </p>\n          )}\n        </div>\n      </div>\n\n      {/* Last saved indicator */}\n      {lastSaved && (\n        <div className=\"text-base-content/40 mt-3 text-center text-xs\">\n          {isSaving ? \"Guardando...\" : `Guardado hace ${formatSaveTime(lastSaved)}`}\n        </div>\n      )}\n\n      {/* Action buttons */}\n      <div className=\"mt-4 flex gap-2\">\n        <button\n          className={cn(\"btn btn-outline flex-1 rounded-xl\", isSaving && \"loading\")}\n          disabled={isSaving}\n          onClick={onSaveDraft}\n          type=\"button\"\n        >\n          Guardar\n        </button>\n        <button\n          className={cn(\"btn flex-1 rounded-xl\", canFinalize ? \"btn-success\" : \"btn-disabled\")}\n          disabled={!canFinalize || isSaving}\n          onClick={onFinalize}\n          type=\"button\"\n        >\n          Finalizar\n        </button>\n      </div>\n    </aside>\n  );\n}\n\nfunction SummaryRow({ label, muted = false, value }: { label: string; muted?: boolean; value: number }) {\n  return (\n    <div className=\"flex items-center justify-between py-1\">\n      <span className={cn(\"text-sm\", muted ? \"text-base-content/40\" : \"text-base-content/60\")}>{label}</span>\n      <span className={cn(\"font-medium tabular-nums\", muted ? \"text-base-content/40\" : \"text-base-content\")}>\n        {fmtCLP(value)}\n      </span>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/production-balances/components/EntryForm.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":21,"column":27,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":21,"endColumn":81,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[696,710],"text":"Readonly<EntryFormProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { CreditCard, Receipt } from \"lucide-react\";\n\nimport { MoneyInput } from \"@/components/ui/MoneyInput\";\n\nimport type { DailyBalanceFormData } from \"../types\";\n\ninterface EntryFormProps {\n  disabled?: boolean;\n  onChange: <K extends keyof DailyBalanceFormData>(field: K, value: DailyBalanceFormData[K]) => void;\n  values: DailyBalanceFormData;\n}\n\n/**\n * Main entry form with Ingresos por método and Gastos sections\n * Uses existing MoneyInput component\n */\n// Helper to convert number to string for MoneyInput\nconst toStr = (n: number) => (n === 0 ? \"\" : String(n));\nconst toNum = (s: string) => (s === \"\" ? 0 : Number(s));\n\nexport function EntryForm({ disabled = false, onChange, values }: EntryFormProps) {\n  return (\n    <div className=\"space-y-4\">\n      {/* Ingresos por método */}\n      <section className=\"bg-base-200/30 border-base-content/5 rounded-2xl border p-4\">\n        <div className=\"mb-4 flex items-center gap-2\">\n          <CreditCard className=\"text-base-content/60 size-5\" />\n          <h3 className=\"text-base font-semibold\">Ingresos por método</h3>\n        </div>\n        <div className=\"grid gap-3 sm:grid-cols-3\">\n          <MoneyInput\n            disabled={disabled}\n            icon={<span className=\"text-xs\">💳</span>}\n            label=\"Tarjetas\"\n            onChange={(v) => {\n              onChange(\"tarjeta\", toNum(v));\n            }}\n            value={toStr(values.tarjeta)}\n          />\n          <MoneyInput\n            disabled={disabled}\n            icon={<span className=\"text-xs\">📲</span>}\n            label=\"Transferencia\"\n            onChange={(v) => {\n              onChange(\"transferencia\", toNum(v));\n            }}\n            value={toStr(values.transferencia)}\n          />\n          <MoneyInput\n            disabled={disabled}\n            icon={<span className=\"text-xs\">💵</span>}\n            label=\"Efectivo\"\n            onChange={(v) => {\n              onChange(\"efectivo\", toNum(v));\n            }}\n            value={toStr(values.efectivo)}\n          />\n        </div>\n      </section>\n\n      {/* Gastos */}\n      <section className=\"bg-base-200/30 border-base-content/5 rounded-2xl border p-4\">\n        <div className=\"mb-4 flex items-center gap-2\">\n          <Receipt className=\"text-base-content/60 size-5\" />\n          <h3 className=\"text-base font-semibold\">Gastos</h3>\n        </div>\n        <div className=\"grid gap-3 sm:grid-cols-2\">\n          <MoneyInput\n            disabled={disabled}\n            label=\"Gastos del día\"\n            onChange={(v) => {\n              onChange(\"gastos\", toNum(v));\n            }}\n            value={toStr(values.gastos)}\n          />\n          <div className=\"form-control\">\n            <label className=\"label py-1\" htmlFor=\"input-nota\">\n              <span className=\"label-text text-xs font-medium sm:text-sm\">Nota (opcional)</span>\n            </label>\n            <textarea\n              className=\"textarea textarea-bordered textarea-sm w-full resize-none\"\n              disabled={disabled}\n              id=\"input-nota\"\n              onChange={(e) => {\n                onChange(\"nota\", e.target.value);\n              }}\n              placeholder=\"Detalles o comentarios...\"\n              rows={2}\n              value={values.nota}\n            />\n          </div>\n        </div>\n      </section>\n\n      {/* Ingresos por servicio (desglose) */}\n      <section className=\"bg-base-200/30 border-base-content/5 mt-4 rounded-2xl border p-4\">\n        <h3 className=\"mb-4 text-base font-semibold\">Desglose por servicio</h3>\n        <div className=\"grid gap-3 sm:grid-cols-3 lg:grid-cols-4\">\n          <MoneyInput\n            disabled={disabled}\n            label=\"Consultas\"\n            onChange={(v) => {\n              onChange(\"consultas\", toNum(v));\n            }}\n            value={toStr(values.consultas)}\n          />\n          <MoneyInput\n            disabled={disabled}\n            label=\"Controles\"\n            onChange={(v) => {\n              onChange(\"controles\", toNum(v));\n            }}\n            value={toStr(values.controles)}\n          />\n          <MoneyInput\n            disabled={disabled}\n            label=\"Tests\"\n            onChange={(v) => {\n              onChange(\"tests\", toNum(v));\n            }}\n            value={toStr(values.tests)}\n          />\n          <MoneyInput\n            disabled={disabled}\n            label=\"Vacunas\"\n            onChange={(v) => {\n              onChange(\"vacunas\", toNum(v));\n            }}\n            value={toStr(values.vacunas)}\n          />\n          <MoneyInput\n            disabled={disabled}\n            label=\"Licencias\"\n            onChange={(v) => {\n              onChange(\"licencias\", toNum(v));\n            }}\n            value={toStr(values.licencias)}\n          />\n          <MoneyInput\n            disabled={disabled}\n            label=\"Roxair\"\n            onChange={(v) => {\n              onChange(\"roxair\", toNum(v));\n            }}\n            value={toStr(values.roxair)}\n          />\n          <MoneyInput\n            disabled={disabled}\n            label=\"Otros\"\n            onChange={(v) => {\n              onChange(\"otros\", toNum(v));\n            }}\n            value={toStr(values.otros)}\n          />\n        </div>\n      </section>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/production-balances/components/MoneySection.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":15,"column":30,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":15,"endColumn":85,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[308,325],"text":"Readonly<MoneySectionProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { ReactNode } from \"react\";\n\nimport { cn } from \"@/lib/utils\";\n\ninterface MoneySectionProps {\n  children: ReactNode;\n  className?: string;\n  icon?: ReactNode;\n  title: string;\n}\n\n/**\n * Section wrapper for money input groups\n */\nexport function MoneySection({ children, className, icon, title }: MoneySectionProps) {\n  return (\n    <section className={cn(\"bg-base-200/30 border-base-content/5 rounded-2xl border p-4\", className)}>\n      <div className=\"mb-4 flex items-center gap-2\">\n        {icon && <span className=\"text-base-content/60\">{icon}</span>}\n        <h3 className=\"text-base font-semibold\">{title}</h3>\n      </div>\n      {children}\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/production-balances/components/TopBar.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":24,"column":24,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":33,"endColumn":15,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[617,628],"text":"Readonly<TopBarProps>"},"desc":"Mark the props as read-only"}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Function Call Object Injection Sink","line":71,"column":79,"nodeType":"MemberExpression","endLine":71,"endColumn":99},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":72,"column":14,"nodeType":"MemberExpression","endLine":72,"endColumn":34}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ChevronDown, Save } from \"lucide-react\";\nimport { useEffect, useState } from \"react\";\n\nimport { cn } from \"@/lib/utils\";\n\nimport type { DayStatus } from \"../types\";\n\nimport { formatDateFull } from \"../utils\";\n\ninterface TopBarProps {\n  canFinalize: boolean;\n  date: string;\n  isSaving: boolean;\n  onFinalize: () => void;\n  onNextWeek: () => void;\n  onPrevWeek: () => void;\n  onSave: () => void;\n  status: DayStatus;\n}\n\n/**\n * Sticky top bar with date, status, and action buttons\n */\nexport function TopBar({\n  canFinalize,\n  date,\n  isSaving,\n  onFinalize,\n  onNextWeek,\n  onPrevWeek,\n  onSave,\n  status,\n}: TopBarProps) {\n  const [showShortcut, setShowShortcut] = useState(false);\n\n  // Keyboard shortcut: ⌘S to save\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      if ((e.metaKey || e.ctrlKey) && e.key === \"s\") {\n        e.preventDefault();\n        onSave();\n      }\n    };\n    globalThis.addEventListener(\"keydown\", handleKeyDown);\n    return () => {\n      globalThis.removeEventListener(\"keydown\", handleKeyDown);\n    };\n  }, [onSave]);\n\n  const statusLabels: Record<DayStatus, string> = {\n    balanced: \"Cuadra\",\n    draft: \"Borrador\",\n    empty: \"Vacío\",\n    unbalanced: \"Pendiente\",\n  };\n\n  const statusColors: Record<DayStatus, string> = {\n    balanced: \"bg-success/20 text-success\",\n    draft: \"bg-warning/20 text-warning\",\n    empty: \"bg-base-content/10 text-base-content/60\",\n    unbalanced: \"bg-amber-500/20 text-amber-400\",\n  };\n\n  return (\n    <header className=\"bg-base-100/80 border-base-content/5 sticky top-0 z-10 mb-4 flex items-center justify-between rounded-2xl border px-6 py-4 backdrop-blur-md\">\n      {/* Left: Title and date */}\n      <div>\n        <h1 className=\"text-xl font-bold\">Balance diario</h1>\n        <div className=\"mt-1 flex items-center gap-2\">\n          <span className=\"text-base-content/80 text-lg font-medium capitalize\">{formatDateFull(date)}</span>\n          <span className={cn(\"rounded-full px-2 py-0.5 text-xs font-medium\", statusColors[status])}>\n            {statusLabels[status]}\n          </span>\n        </div>\n      </div>\n\n      {/* Right: Actions */}\n      <div className=\"flex items-center gap-3\">\n        {/* Save button with shortcut hint */}\n        <button\n          className={cn(\"btn btn-ghost btn-sm gap-2 rounded-xl\", isSaving && \"loading\")}\n          disabled={isSaving}\n          onClick={onSave}\n          onMouseEnter={() => {\n            setShowShortcut(true);\n          }}\n          onMouseLeave={() => {\n            setShowShortcut(false);\n          }}\n          type=\"button\"\n        >\n          {!isSaving && <Save className=\"size-4\" />}\n          <span className=\"hidden sm:inline\">Guardar</span>\n          {showShortcut && (\n            <kbd className=\"bg-base-content/10 ml-1 hidden rounded px-1.5 py-0.5 text-xs sm:inline\">⌘S</kbd>\n          )}\n        </button>\n\n        {/* Finalizar button */}\n        <button\n          className={cn(\"btn rounded-xl px-6\", canFinalize ? \"btn-success\" : \"btn-disabled\")}\n          disabled={!canFinalize || isSaving}\n          onClick={onFinalize}\n          type=\"button\"\n        >\n          Finalizar\n        </button>\n\n        {/* More options dropdown */}\n        <div className=\"dropdown dropdown-end\">\n          <button className=\"btn btn-ghost btn-sm btn-square rounded-xl\" type=\"button\">\n            <ChevronDown className=\"size-4\" />\n          </button>\n          <ul className=\"dropdown-content bg-base-200 border-base-content/10 menu z-10 w-52 rounded-xl border p-2 shadow-lg\">\n            <li>\n              <button className=\"text-sm\" onClick={onPrevWeek} type=\"button\">\n                Ver anterior semana\n              </button>\n            </li>\n            <li>\n              <button className=\"text-sm\" onClick={onNextWeek} type=\"button\">\n                Ver siguiente semana\n              </button>\n            </li>\n            <li>\n              <button className=\"text-sm\" type=\"button\">\n                Exportar día\n              </button>\n            </li>\n          </ul>\n        </div>\n      </div>\n    </header>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/production-balances/components/WeekStrip.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":22,"column":27,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":30,"endColumn":18,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[658,672],"text":"Readonly<WeekStripProps>"},"desc":"Mark the props as read-only"}]},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":95,"column":24,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":105,"endColumn":2,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[3046,3131],"text":"Readonly<{\n  day: DayCell;\n  isSelected: boolean;\n  isToday: boolean;\n  onClick: () => void;\n}>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ChevronLeft, ChevronRight } from \"lucide-react\";\nimport { useMemo } from \"react\";\n\nimport { fmtCLP } from \"@/lib/format\";\nimport { cn } from \"@/lib/utils\";\n\nimport type { DayCell, WeekData } from \"../types\";\n\ninterface WeekStripProps {\n  currentDate: string;\n  isCollapsed?: boolean;\n  onGoToToday: () => void;\n  onNextWeek: () => void;\n  onPrevWeek: () => void;\n  onSelectDate: (date: string) => void;\n  weekData: null | WeekData;\n}\n\n/**\n * Week navigation strip showing L-D with amounts and status dots\n */\nexport function WeekStrip({\n  currentDate,\n  isCollapsed = false,\n  onGoToToday,\n  onNextWeek,\n  onPrevWeek,\n  onSelectDate,\n  weekData,\n}: WeekStripProps) {\n  const today = useMemo(() => {\n    const d = new Date();\n    return d.toISOString().split(\"T\")[0];\n  }, []);\n\n  if (isCollapsed) {\n    return (\n      <div className=\"bg-base-200/30 border-base-content/5 mb-4 flex items-center justify-between rounded-2xl border px-4 py-2\">\n        <span className=\"text-base-content/60 text-sm\">{weekData?.weekLabel ?? \"Cargando...\"}</span>\n        <div className=\"flex items-center gap-2\">\n          <button className=\"btn btn-ghost btn-xs btn-square\" onClick={onPrevWeek} type=\"button\">\n            <ChevronLeft className=\"size-4\" />\n          </button>\n          <button className=\"btn btn-ghost btn-xs btn-square\" onClick={onNextWeek} type=\"button\">\n            <ChevronRight className=\"size-4\" />\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-base-200/30 border-base-content/5 mb-4 rounded-2xl border p-4\">\n      {/* Week header */}\n      <div className=\"mb-3 flex items-center justify-between\">\n        <div className=\"flex items-center gap-2\">\n          <button className=\"btn btn-ghost btn-xs btn-square\" onClick={onPrevWeek} type=\"button\">\n            <ChevronLeft className=\"size-4\" />\n          </button>\n          <span className=\"text-base-content/80 text-sm font-medium\">SEM {weekData?.weekLabel ?? \"...\"}</span>\n          <button className=\"btn btn-ghost btn-xs btn-square\" onClick={onNextWeek} type=\"button\">\n            <ChevronRight className=\"size-4\" />\n          </button>\n        </div>\n\n        <div className=\"flex items-center gap-2\">\n          <button className=\"btn btn-outline btn-xs\" onClick={onGoToToday} type=\"button\">\n            Hoy\n          </button>\n        </div>\n      </div>\n\n      {/* Days grid */}\n      <div className=\"grid grid-cols-7 gap-2\">\n        {weekData?.days.map((day) => (\n          <DayCellButton\n            day={day}\n            isSelected={day.date === currentDate}\n            isToday={day.date === today}\n            key={day.date}\n            onClick={() => {\n              onSelectDate(day.date);\n            }}\n          />\n        )) ??\n          // Skeleton\n          Array.from({ length: 7 }).map((_, i) => (\n            <div className=\"bg-base-300/30 h-16 animate-pulse rounded-xl\" key={`skeleton-${i}`} />\n          ))}\n      </div>\n    </div>\n  );\n}\n\nfunction DayCellButton({\n  day,\n  isSelected,\n  isToday,\n  onClick,\n}: {\n  day: DayCell;\n  isSelected: boolean;\n  isToday: boolean;\n  onClick: () => void;\n}) {\n  const statusColors = {\n    balanced: \"bg-success\",\n    draft: \"bg-warning\",\n    empty: \"bg-base-content/20\",\n    unbalanced: \"bg-error\",\n  };\n\n  return (\n    <button\n      className={cn(\n        \"relative flex flex-col items-center justify-center rounded-xl p-2 transition-all\",\n        \"hover:bg-base-content/5 focus:ring-primary/20 focus:ring-2 focus:outline-none\",\n        isSelected && \"bg-base-content/10 ring-primary ring-2\",\n        isToday && !isSelected && \"ring-primary/30 ring-1\"\n      )}\n      onClick={onClick}\n      type=\"button\"\n    >\n      {/* Status dot */}\n      <div className={cn(\"absolute top-2 right-2 size-2 rounded-full\", statusColors[day.status])} />\n\n      {/* Day name */}\n      <span className=\"text-base-content/60 text-xs font-medium\">{day.dayName}</span>\n\n      {/* Amount */}\n      <span\n        className={cn(\n          \"mt-1 text-sm font-semibold tabular-nums\",\n          day.total === 0 ? \"text-base-content/40\" : \"text-base-content\"\n        )}\n      >\n        {day.total === 0 ? \"$0\" : fmtCLP(day.total)}\n      </span>\n    </button>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/production-balances/hooks/use-daily-balance-form.ts","messages":[{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":55,"column":100,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":55,"endColumn":102,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1818,1820],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":65,"column":37,"nodeType":"UnaryExpression","messageId":"alwaysTruthy","endLine":65,"endColumn":53},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":74,"column":9,"nodeType":"MemberExpression","messageId":"alwaysTruthy","endLine":74,"endColumn":23},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":88,"column":11,"nodeType":"MemberExpression","endLine":88,"endColumn":27},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":240,"column":28,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":240,"endColumn":30,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[7611,7613],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMutation, useQueryClient, useSuspenseQuery } from \"@tanstack/react-query\";\nimport dayjs from \"dayjs\";\nimport { useCallback, useEffect, useRef } from \"react\";\n\nimport { useAuth } from \"@/context/AuthContext\";\nimport { useToast } from \"@/context/ToastContext\";\n\nimport type { DailyBalanceFormData } from \"../types\";\n\nimport { dailyBalanceApi, type ProductionBalanceApiItem } from \"../api\";\nimport { productionBalanceKeys } from \"../queries\";\nimport { generateWeekData, useDailyBalanceStore } from \"./use-daily-balance-store\";\n\nconst AUTOSAVE_DELAY_MS = 2000;\n\nconst DATE_FORMAT = \"YYYY-MM-DD\";\n\n/**\n * Hook for Daily Balance form logic with autosave\n */\nexport function useDailyBalanceForm() {\n  const { error: showError, success } = useToast();\n  const queryClient = useQueryClient();\n  const autosaveTimeout = useRef<null | ReturnType<typeof setTimeout>>(null);\n\n  const {\n    currentEntryId,\n    formData,\n    isDirty,\n    isSaving,\n    lastSaved,\n    markSaved,\n    resetForm,\n    selectedDate,\n    setIsSaving,\n    setOriginalData,\n    setSelectedDate,\n    setWeekData,\n    status,\n    summary,\n    updateField,\n    weekData,\n  } = useDailyBalanceStore();\n\n  // Fetch entry for selected date (and week context)\n  // We fetch a 7-day range to populate the week strip logic\n  const startOfWeek = dayjs(selectedDate).startOf(\"week\").format(DATE_FORMAT);\n  const endOfWeek = dayjs(selectedDate).endOf(\"week\").format(DATE_FORMAT);\n\n  const weekQuery = useSuspenseQuery(productionBalanceKeys.week(startOfWeek, endOfWeek));\n\n  // Find item by balanceDate (formatted as YYYY-MM-DD or comparison)\n  // ZenStack likely returns full ISO string \"2024-01-01T00:00:00.000Z\"\n  // So we must compare prefix or use dayjs\n  const selectedDayItem = weekQuery.data.find((item) => item.balanceDate.startsWith(selectedDate)) || null;\n\n  // Load data when query succeeds (if day changes or we just loaded data)\n  useEffect(() => {\n    // If we have data for this day, map it and set it\n    if (selectedDayItem) {\n      const formValues = mapApiToForm(selectedDayItem);\n      setOriginalData(formValues, selectedDayItem.id);\n    }\n    // If query succeeded but no data for this day, reset form\n    else if (weekQuery.isSuccess && !selectedDayItem) {\n      // Only reset if we are not currently saving (to avoid race conditions)\n      resetForm();\n    }\n  }, [selectedDayItem, weekQuery.isSuccess, setOriginalData, resetForm, selectedDate]);\n\n  // Generate week data with real status\n  useEffect(() => {\n    const entries: Record<string, number> = {};\n    if (weekQuery.data) {\n      for (const item of weekQuery.data) {\n        // total? We might need to calculate it if backend doesn't send 'total'\n        // But for now, let's assume 'total' might be calculated?\n        // Wait, schema does NOT have 'total'. I need to calculate it?\n        // Or assume the hook logic elsewhere handles totals.\n        // For 'weekData' (header dots), we typically just need existence or status?\n        // The 'total' property was in the old interface.\n        // Let's compute a simple total or 0 if missing.\n        // Actually, we can sum the fields.\n        const calculatedTotal =\n          item.ingresoTarjetas + item.ingresoTransferencias + item.ingresoEfectivo + item.otrosAbonos;\n        const dateKey = item.balanceDate.split(\"T\")[0];\n        if (dateKey) {\n          entries[dateKey] = calculatedTotal;\n        }\n      }\n    }\n    const week = generateWeekData(selectedDate, entries);\n    setWeekData(week);\n  }, [selectedDate, weekQuery.data, setWeekData]);\n\n  const { user } = useAuth();\n\n  // Save mutation\n  const saveMutation = useMutation({\n    mutationFn: async (data: DailyBalanceFormData) => {\n      // transform to schema format\n      const payload = {\n        balanceDate: new Date(selectedDate).toISOString(),\n        comentarios: data.nota,\n        consultasMonto: data.consultas,\n        controlesMonto: data.controles,\n        createdBy: user?.id, // Ensure user is connected\n        gastosDiarios: data.gastos,\n        ingresoEfectivo: data.efectivo,\n        ingresoTarjetas: data.tarjeta,\n        ingresoTransferencias: data.transferencia,\n        licenciasMonto: data.licencias,\n        otrosAbonos: data.otros,\n        roxairMonto: data.roxair,\n        testsMonto: data.tests,\n        vacunasMonto: data.vacunas,\n      };\n\n      if (currentEntryId) {\n        // Update existing (we don't strictly need Date/User on update if they don't change, but safer to send)\n        // Check if update API allows changing Date/User? Usually ID is enough.\n        // But let's send mapped fields.\n        return dailyBalanceApi.updateBalance(currentEntryId, payload);\n      }\n      // Create new\n      if (!user?.id) throw new Error(\"No authenticated user found\");\n      return dailyBalanceApi.createBalance(payload);\n    },\n    onMutate: () => {\n      setIsSaving(true);\n    },\n    onError: (err) => {\n      setIsSaving(false);\n      showError(err instanceof Error ? err.message : \"Error al guardar\");\n    },\n    onSettled: () => {\n      setIsSaving(false);\n    },\n    onSuccess: (response) => {\n      markSaved(response.item.id);\n      success(\"Balance guardado\");\n      // Invalidate the week query so dots update\n      void queryClient.invalidateQueries({ queryKey: productionBalanceKeys.all });\n    },\n  });\n\n  // Save function\n  const { mutate: saveMutate } = saveMutation;\n  const save = useCallback(() => {\n    if (!isDirty) return;\n    saveMutate(formData);\n  }, [isDirty, formData, saveMutate]);\n\n  // Autosave: trigger save after delay when dirty\n  useEffect(() => {\n    if (!isDirty) return;\n\n    if (autosaveTimeout.current) {\n      clearTimeout(autosaveTimeout.current);\n    }\n\n    autosaveTimeout.current = setTimeout(() => {\n      save();\n    }, AUTOSAVE_DELAY_MS);\n\n    return () => {\n      if (autosaveTimeout.current) {\n        clearTimeout(autosaveTimeout.current);\n      }\n    };\n  }, [isDirty, formData, save]);\n\n  // Finalize day\n  const finalize = useCallback(() => {\n    if (!summary.cuadra) {\n      showError(\"El balance no cuadra\");\n      return;\n    }\n    // For now, finalizing just means ensuring it's saved.\n    // In the future, this might trigger a status update to \"CLOSED\" if the API supports it.\n    if (isDirty) {\n      save();\n    }\n    success(\"Día finalizado\");\n  }, [summary, success, showError, isDirty, save]);\n\n  // Navigation\n  const goToPrevWeek = useCallback(() => {\n    const prev = dayjs(selectedDate).subtract(7, \"day\").format(DATE_FORMAT);\n    setSelectedDate(prev);\n  }, [selectedDate, setSelectedDate]);\n\n  const goToNextWeek = useCallback(() => {\n    const next = dayjs(selectedDate).add(7, \"day\").format(DATE_FORMAT);\n    setSelectedDate(next);\n  }, [selectedDate, setSelectedDate]);\n\n  const goToToday = useCallback(() => {\n    setSelectedDate(dayjs().format(DATE_FORMAT));\n  }, [setSelectedDate]);\n\n  const selectDate = useCallback(\n    (date: string) => {\n      setSelectedDate(date);\n    },\n    [setSelectedDate]\n  );\n\n  return {\n    finalize,\n    formData,\n    goToNextWeek,\n    goToPrevWeek,\n    goToToday,\n    isDirty,\n    isLoading: weekQuery.isLoading,\n    isSaving,\n    lastSaved,\n\n    save,\n    selectDate,\n    // State\n    selectedDate,\n    status,\n    summary,\n    // Actions\n    updateField,\n    weekData,\n  };\n}\n\n// Helper to map API item to Form Data\nfunction mapApiToForm(item: ProductionBalanceApiItem): DailyBalanceFormData {\n  return {\n    consultas: item.consultasMonto,\n    controles: item.controlesMonto,\n    efectivo: item.ingresoEfectivo,\n    gastos: item.gastosDiarios,\n    licencias: item.licenciasMonto,\n    nota: item.comentarios || \"\",\n    otros: item.otrosAbonos || 0,\n    roxair: item.roxairMonto,\n    tarjeta: item.ingresoTarjetas,\n    tests: item.testsMonto,\n    transferencia: item.ingresoTransferencias,\n    vacunas: item.vacunasMonto,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/production-balances/hooks/use-daily-balance-store.ts","messages":[{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":70,"column":19,"nodeType":"MemberExpression","endLine":70,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useStore } from \"@tanstack/react-store\";\nimport { Store } from \"@tanstack/store\";\nimport dayjs from \"dayjs\";\nimport { useMemo } from \"react\";\n\nimport type { BalanceSummary, DailyBalanceFormData, DayCell, DayStatus, WeekData } from \"../types\";\n\nimport { calculateSummary, getDayAbbrev } from \"../utils\";\n\n// Default empty form values\nconst defaultFormData: DailyBalanceFormData = {\n  consultas: 0,\n  controles: 0,\n  efectivo: 0,\n  gastos: 0,\n  licencias: 0,\n  nota: \"\",\n  otros: 0,\n  roxair: 0,\n  tarjeta: 0,\n  tests: 0,\n  transferencia: 0,\n  vacunas: 0,\n};\n\nexport interface DailyBalanceState {\n  // Current Entry ID (if exists in DB)\n  currentEntryId: null | number;\n\n  // Form data for current day\n  formData: DailyBalanceFormData;\n\n  // State flags\n  isLoading: boolean;\n\n  isSaving: boolean;\n\n  lastSaved: Date | null;\n\n  // Original data (to detect changes)\n  originalData: DailyBalanceFormData;\n  // Current selected date\n  selectedDate: string;\n  // Week data for navigation\n  weekData: null | WeekData;\n}\n\n// 1. Base Store\nexport const dailyBalanceStore = new Store<DailyBalanceState>({\n  currentEntryId: null,\n  formData: { ...defaultFormData },\n  isLoading: false,\n  isSaving: false,\n  lastSaved: null,\n  originalData: { ...defaultFormData },\n  selectedDate: dayjs().format(\"YYYY-MM-DD\"),\n  weekData: null,\n});\n\nexport function generateWeekData(centerDate: string, entries: Record<string, number>): WeekData {\n  const center = dayjs(centerDate);\n  const startOfWeek = center.startOf(\"week\"); // Sunday\n  const endOfWeek = center.endOf(\"week\");\n\n  const days: DayCell[] = [];\n\n  for (let i = 0; i < 7; i++) {\n    const d = startOfWeek.add(i, \"day\");\n    const dateStr = d.format(\"YYYY-MM-DD\");\n    const total = entries[dateStr] ?? 0;\n\n    days.push({\n      date: dateStr,\n      dayName: getDayAbbrev(dateStr),\n      dayNumber: d.date(),\n      isSelected: dateStr === centerDate,\n      isToday: dateStr === dayjs().format(\"YYYY-MM-DD\"),\n      status: total > 0 ? \"balanced\" : \"empty\",\n      total,\n    });\n  }\n\n  return {\n    days,\n    weekLabel: `${startOfWeek.format(\"D\")} – ${endOfWeek.format(\"D MMM YYYY\")}`,\n  };\n}\n\n// 2. Helper Logic\nfunction computeStatus(data: DailyBalanceFormData, summary: BalanceSummary): DayStatus {\n  const hasData = data.tarjeta > 0 || data.transferencia > 0 || data.efectivo > 0;\n  if (!hasData) return \"empty\";\n  if (summary.cuadra) return \"balanced\";\n  return \"unbalanced\";\n}\n\n// 3. Standalone Actions\nexport const setSelectedDate = (date: string) => {\n  dailyBalanceStore.setState((s) => ({ ...s, selectedDate: date }));\n};\n\nexport const updateField = <K extends keyof DailyBalanceFormData>(field: K, value: DailyBalanceFormData[K]) => {\n  dailyBalanceStore.setState((s) => ({\n    ...s,\n    formData: { ...s.formData, [field]: value },\n  }));\n};\n\nexport const setFormData = (data: DailyBalanceFormData) => {\n  dailyBalanceStore.setState((s) => ({ ...s, formData: data }));\n};\n\nexport const setOriginalData = (data: DailyBalanceFormData, id?: number) => {\n  dailyBalanceStore.setState((s) => ({\n    ...s,\n    currentEntryId: id ?? null,\n    formData: data,\n    originalData: data,\n  }));\n};\n\nexport const setWeekData = (data: WeekData) => {\n  dailyBalanceStore.setState((s) => ({ ...s, weekData: data }));\n};\n\nexport const setIsLoading = (loading: boolean) => {\n  dailyBalanceStore.setState((s) => ({ ...s, isLoading: loading }));\n};\n\nexport const setIsSaving = (saving: boolean) => {\n  dailyBalanceStore.setState((s) => ({ ...s, isSaving: saving }));\n};\n\nexport const markSaved = (newId?: number) => {\n  dailyBalanceStore.setState((s) => ({\n    ...s,\n    currentEntryId: newId ?? s.currentEntryId,\n    lastSaved: new Date(),\n    originalData: { ...s.formData },\n  }));\n};\n\nexport const resetForm = () => {\n  dailyBalanceStore.setState((s) => ({\n    ...s,\n    currentEntryId: null,\n    formData: { ...defaultFormData },\n    isDirty: false,\n    originalData: { ...defaultFormData },\n    summary: { ...calculateSummary(defaultFormData) }, // Initial summary logic if needed in store? No, store is clean.\n  }));\n};\n\n// 4. Adapter Hook (Backward Compatibility)\nexport function useDailyBalanceStore() {\n  const state = useStore(dailyBalanceStore);\n\n  const summary = useMemo(() => calculateSummary(state.formData), [state.formData]);\n\n  const status = useMemo(() => computeStatus(state.formData, summary), [state.formData, summary]);\n  const isDirty = useMemo(\n    () => JSON.stringify(state.formData) !== JSON.stringify(state.originalData),\n    [state.formData, state.originalData]\n  );\n\n  return {\n    ...state,\n    isDirty,\n    markSaved,\n    resetForm,\n    setFormData,\n    setIsLoading,\n    setIsSaving,\n    setOriginalData,\n    // Actions\n    setSelectedDate,\n    setWeekData,\n    status,\n    summary,\n    updateField,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/production-balances/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/production-balances/queries.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/production-balances/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/production-balances/utils.ts","messages":[{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":75,"column":10,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":75,"endColumn":51},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":75,"column":10,"nodeType":"MemberExpression","endLine":75,"endColumn":50}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Daily Balance V2 utilities\n * Reuses existing format utilities from @/lib/format\n */\n\n// Re-export existing formatters\nexport { coerceAmount, fmtCLP, formatRelativeDate, numberFormatter } from \"@/lib/format\";\n\n/**\n * Calculate summary from form data\n */\nexport function calculateSummary(data: {\n  consultas: number;\n  controles: number;\n  efectivo: number;\n  gastos: number;\n  licencias: number;\n  otros: number;\n  roxair: number;\n  tarjeta: number;\n  tests: number;\n  transferencia: number;\n  vacunas: number;\n}) {\n  const totalMetodos = data.tarjeta + data.transferencia + data.efectivo;\n  const totalServicios =\n    data.consultas + data.controles + data.tests + data.vacunas + data.licencias + data.roxair + data.otros;\n  const diferencia = totalMetodos - totalServicios;\n  const cuadra = diferencia === 0;\n\n  return {\n    cuadra,\n    diferencia,\n    gastos: data.gastos,\n    totalMetodos,\n    totalServicios,\n  };\n}\n\n/**\n * Format date for large display\n * E.g. \"2026-01-10\" → \"Sáb 10 Ene 2026\"\n */\nexport function formatDateFull(dateStr: string): string {\n  const date = new Date(dateStr + \"T12:00:00\"); // Avoid timezone issues\n  return date.toLocaleDateString(\"es-CL\", {\n    day: \"numeric\",\n    month: \"short\",\n    weekday: \"short\",\n    year: \"numeric\",\n  });\n}\n\n/**\n * Format relative time for \"Guardado hace X\" (shorter version)\n */\nexport function formatSaveTime(date: Date): string {\n  const now = new Date();\n  const diffMs = now.getTime() - date.getTime();\n  const diffSec = Math.floor(diffMs / 1000);\n\n  if (diffSec < 5) return \"ahora\";\n  if (diffSec < 60) return `${diffSec}s`;\n  if (diffSec < 3600) return `${Math.floor(diffSec / 60)}m`;\n  return `${Math.floor(diffSec / 3600)}h`;\n}\n\n/**\n * Get day abbreviation for week strip\n */\nexport function getDayAbbrev(dateStr: string): string {\n  const date = new Date(dateStr + \"T12:00:00\");\n  const day = date.getDay();\n  // getDay() always returns 0-6, so this is safe\n  return [\"D\", \"L\", \"M\", \"X\", \"J\", \"V\", \"S\"][day]!;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/reports/hooks/use-report-upload.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/reports/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/reports/utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/roles/api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/roles/components/BulkToggleCell.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":5,"column":32,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":18,"endColumn":2,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[199,410],"text":"Readonly<{\n  className?: string;\n  isUpdating: boolean;\n  onToggle: (role: Role, ids: number[]) => void;\n  permissionIds: number[];\n  role: Role;\n  variant?: \"page\" | \"section\"; // Deprecated but kept for compatibility\n}>"},"desc":"Mark the props as read-only"}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":50,"column":83,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":50,"endColumn":85,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1798,1800],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { CheckCheck, Loader2, Minus } from \"lucide-react\";\n\nimport { Role } from \"@/types/roles\";\n\nexport function BulkToggleCell({\n  className,\n  isUpdating,\n  onToggle,\n  permissionIds,\n  role,\n}: {\n  className?: string;\n  isUpdating: boolean;\n  onToggle: (role: Role, ids: number[]) => void;\n  permissionIds: number[];\n  role: Role;\n  variant?: \"page\" | \"section\"; // Deprecated but kept for compatibility\n}) {\n  const currentPermissionIds = new Set(role.permissions.map((p) => p.permissionId));\n  const presentCount = permissionIds.filter((id) => currentPermissionIds.has(id)).length;\n  const allPresent = permissionIds.length > 0 && presentCount === permissionIds.length;\n  const somePresent = presentCount > 0 && presentCount < permissionIds.length;\n\n  const renderIcon = () => {\n    if (isUpdating) {\n      return <Loader2 className=\"text-base-content/40 h-4 w-4 animate-spin\" />;\n    }\n    if (allPresent) {\n      return (\n        <div className=\"bg-primary hover:bg-primary-focus flex h-5 w-5 items-center justify-center rounded-md shadow-sm transition-transform active:scale-95\">\n          <CheckCheck className=\"text-primary-content\" size={12} />\n        </div>\n      );\n    }\n    if (somePresent) {\n      return (\n        <div className=\"bg-primary/70 hover:bg-primary flex h-5 w-5 items-center justify-center rounded-md shadow-sm transition-transform active:scale-95\">\n          <Minus className=\"text-primary-content\" size={12} />\n        </div>\n      );\n    }\n    return (\n      <div className=\"border-base-300 hover:border-primary/50 hover:bg-primary/5 h-5 w-5 rounded-md border-2 transition-colors\" />\n    );\n  };\n\n  if (permissionIds.length === 0) return <div className={className} />;\n\n  return (\n    <div className={`flex items-center justify-center p-0 text-center ${className || \"\"}`}>\n      <button\n        className=\"mx-auto flex h-8 w-full items-center justify-center rounded-md transition-colors\"\n        disabled={isUpdating}\n        onClick={() => {\n          onToggle(role, permissionIds);\n        }}\n        title={allPresent ? \"Desmarcar todos\" : \"Marcar todos\"}\n      >\n        {renderIcon()}\n      </button>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/roles/components/DeleteRoleModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/roles/components/PermissionsMatrixTable.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":43,"column":40,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":54,"endColumn":31,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[1316,1343],"text":"Readonly<PermissionsMatrixTableProps>"},"desc":"Mark the props as read-only"}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":61,"column":17,"nodeType":"MemberExpression","endLine":61,"endColumn":28},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":68,"column":15,"nodeType":"MemberExpression","endLine":68,"endColumn":24},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":92,"column":101,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":92,"endColumn":103,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2883,2885],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":93,"column":35,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":93,"endColumn":37,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2925,2927],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":178,"column":36,"nodeType":"MemberExpression","endLine":178,"endColumn":54},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":240,"column":62,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":240,"endColumn":64,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[9316,9318],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":276,"column":25,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":288,"endColumn":2,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[10815,10943],"text":"Readonly<{\n  className?: string;\n  isUpdating: boolean;\n  onToggle: (r: Role, i: number) => void;\n  permissionId: number;\n  role: Role;\n}>"},"desc":"Mark the props as read-only"}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":292,"column":67,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":292,"endColumn":69,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[11110,11112],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":312,"column":24,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":324,"endColumn":2,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[11914,12057],"text":"Readonly<{\n  displayRoles: Role[];\n  isUpdating: boolean;\n  onToggle: (role: Role, id: number) => void;\n  perm: Permission;\n  updatingRoleId?: number;\n}>"},"desc":"Mark the props as read-only"}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":331,"column":46,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":331,"endColumn":48,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[12241,12243],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Check, ChevronDown, ChevronRight, Eye, Pencil, Trash2 } from \"lucide-react\";\nimport { Fragment, useState } from \"react\";\n\nimport type { Permission, Role } from \"@/types/roles\";\n\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/DropdownMenu\";\n\nimport { BulkToggleCell } from \"./BulkToggleCell\";\n\nexport interface MatrixItem {\n  icon: React.ElementType;\n  label: string;\n  permissionIds: number[];\n  relatedPermissions: Permission[];\n}\n\n// Types corresponding to the processed nav sections\nexport interface MatrixSection {\n  items: MatrixItem[];\n  permissionIds: number[];\n  title: string;\n}\n\ninterface PermissionsMatrixTableProps {\n  isUpdatingPermissions: boolean;\n  onBulkToggle: (role: Role, permissionIds: number[]) => void;\n  onDeleteRole: (role: Role) => void;\n  onEditRole: (role: Role) => void;\n  onImpersonate: (role: Role) => void;\n  onPermissionToggle: (role: Role, permissionId: number) => void;\n  roles: Role[];\n  sections: MatrixSection[];\n  updatingRoleId?: number;\n  viewModeRole: string;\n}\n\nexport function PermissionsMatrixTable({\n  isUpdatingPermissions,\n  onBulkToggle,\n  onDeleteRole,\n  onEditRole,\n  onImpersonate,\n  onPermissionToggle,\n  roles,\n  sections,\n  updatingRoleId,\n  viewModeRole,\n}: PermissionsMatrixTableProps) {\n  const [openSections, setOpenSections] = useState<Record<string, boolean>>({});\n  const [openItems, setOpenItems] = useState<Record<string, boolean>>({});\n\n  const toggleSection = (title: string) => {\n    setOpenSections((prev) => ({\n      ...prev,\n      [title]: !prev[title],\n    }));\n  };\n\n  const toggleItem = (key: string) => {\n    setOpenItems((prev) => ({\n      ...prev,\n      [key]: !prev[key],\n    }));\n  };\n\n  const displayRoles = viewModeRole === \"all\" ? roles : roles.filter((r) => r.id.toString() === viewModeRole);\n\n  const gridTemplateColumns = `320px repeat(${displayRoles.length}, minmax(140px, 1fr))`;\n\n  return (\n    <div className=\"border-base-300 w-full overflow-x-auto border-t\">\n      <div className=\"min-w-fit\" style={{ display: \"grid\", gridTemplateColumns }}>\n        {/* Header Row */}\n        <div className=\"bg-base-100 border-base-300 sticky top-0 left-0 z-20 border-r border-b px-6 py-4 text-left font-bold\">\n          Permiso / acción\n        </div>\n        {displayRoles.map((role) => (\n          <div\n            className=\"group hover:bg-base-200/50 border-base-300 relative flex flex-col items-center justify-start border-b p-4 text-center align-top\"\n            key={role.id}\n          >\n            <div className=\"flex flex-col items-center gap-1\">\n              <span className=\"line-clamp-2 text-base leading-tight font-bold\" title={role.name}>\n                {role.name}\n              </span>\n              <span className=\"line-clamp-2 text-xs font-normal opacity-70\" title={role.description || \"\"}>\n                {role.description || \"Sin descripción\"}\n              </span>\n\n              <div className=\"mt-2 flex justify-center\">\n                <DropdownMenu>\n                  <DropdownMenuTrigger className=\"btn btn-ghost btn-xs h-6 w-full gap-1 font-normal opacity-50 hover:opacity-100\">\n                    Opciones\n                    <ChevronDown className=\"h-3 w-3\" />\n                  </DropdownMenuTrigger>\n                  <DropdownMenuContent align=\"end\" sideOffset={4}>\n                    <DropdownMenuItem\n                      onClick={() => {\n                        onImpersonate(role);\n                      }}\n                    >\n                      <Eye className=\"h-4 w-4\" />\n                      Previsualizar\n                    </DropdownMenuItem>\n                    <DropdownMenuItem\n                      onClick={() => {\n                        onEditRole(role);\n                      }}\n                    >\n                      <Pencil className=\"h-4 w-4\" />\n                      Editar\n                    </DropdownMenuItem>\n                    <DropdownMenuSeparator />\n                    <DropdownMenuItem\n                      className=\"text-error focus:text-error\"\n                      onClick={() => {\n                        onDeleteRole(role);\n                      }}\n                    >\n                      <Trash2 className=\"h-4 w-4\" />\n                      Eliminar\n                    </DropdownMenuItem>\n                  </DropdownMenuContent>\n                </DropdownMenu>\n              </div>\n            </div>\n          </div>\n        ))}\n\n        {/* Sections */}\n        {sections.map((section) => (\n          <Fragment key={section.title}>\n            {/* Section Title & Bulk Toggle */}\n            {/* Section Title & Bulk Toggle */}\n            <div className=\"border-base-300 sticky left-0 z-10 flex border-r border-b\">\n              <button\n                className=\"bg-base-200/50 hover:bg-base-200/70 flex flex-1 cursor-pointer items-center gap-2 py-3 pl-4 text-xs font-bold tracking-widest uppercase transition-colors\"\n                onClick={() => {\n                  toggleSection(section.title);\n                }}\n                type=\"button\"\n              >\n                {openSections[section.title] ? (\n                  <ChevronDown className=\"h-4 w-4\" />\n                ) : (\n                  <ChevronRight className=\"h-4 w-4\" />\n                )}\n                {section.title}\n              </button>\n            </div>\n            {displayRoles.map((role) => (\n              <div\n                className=\"bg-base-200/50 hover:bg-base-200/70 border-base-300 flex items-center justify-center border-b p-0 transition-colors\"\n                key={role.id}\n              >\n                <BulkToggleCell\n                  className=\"w-full\"\n                  isUpdating={isUpdatingPermissions && updatingRoleId === role.id}\n                  onToggle={onBulkToggle}\n                  permissionIds={section.permissionIds}\n                  role={role}\n                  variant=\"section\"\n                />\n              </div>\n            ))}\n\n            {/* Collapsible Content */}\n            {openSections[section.title] && (\n              <div className=\"contents\">\n                {section.items.map((item) => {\n                  const itemKey = `${section.title}-${item.label}`;\n                  const isOpen = !!openItems[itemKey];\n                  const hasMultiple = item.relatedPermissions.length > 1;\n\n                  if (hasMultiple) {\n                    return (\n                      <Fragment key={item.label}>\n                        <div className=\"border-base-300 sticky left-0 z-10 flex border-r border-b\">\n                          <button\n                            className=\"bg-base-100/50 hover:bg-base-200/20 flex flex-1 cursor-pointer items-center gap-2 py-3 pl-8 text-sm font-semibold transition-colors\"\n                            onClick={() => {\n                              toggleItem(itemKey);\n                            }}\n                            type=\"button\"\n                          >\n                            <div className=\"text-base-content/40 flex h-4 w-4 items-center justify-center\">\n                              {isOpen ? <ChevronDown size={14} /> : <ChevronRight size={14} />}\n                            </div>\n                            <item.icon className=\"h-4 w-4 opacity-70\" />\n                            {item.label}\n                          </button>\n                        </div>\n                        {displayRoles.map((role) => (\n                          <div\n                            className=\"bg-base-100/50 hover:bg-base-200/20 border-base-300 flex items-center justify-center border-b p-0 transition-colors\"\n                            key={role.id}\n                          >\n                            <BulkToggleCell\n                              className=\"w-full py-3\"\n                              isUpdating={isUpdatingPermissions && updatingRoleId === role.id}\n                              onToggle={onBulkToggle}\n                              permissionIds={item.permissionIds}\n                              role={role}\n                              variant=\"page\"\n                            />\n                          </div>\n                        ))}\n\n                        {/* Nested Permissions */}\n                        {isOpen &&\n                          item.relatedPermissions.map((perm) => (\n                            <PermissionRow\n                              displayRoles={displayRoles}\n                              isUpdating={isUpdatingPermissions}\n                              key={perm.id}\n                              onToggle={onPermissionToggle}\n                              perm={perm}\n                              updatingRoleId={updatingRoleId}\n                            />\n                          ))}\n                      </Fragment>\n                    );\n                  }\n\n                  const perm = item.relatedPermissions[0];\n                  if (!perm) return null;\n\n                  const actionMap: Record<string, string> = {\n                    create: \"Crear\",\n                    delete: \"Eliminar\",\n                    read: \"Ver\",\n                    update: \"Editar\",\n                  };\n                  const actionLabel = actionMap[perm.action] || perm.action;\n                  const displayLabel = `${item.label} (${actionLabel})`;\n\n                  return (\n                    <Fragment key={perm.id}>\n                      <div className=\"bg-base-100 border-base-300 sticky left-0 z-10 flex flex-col justify-center border-r border-b py-3 pl-8\">\n                        <span className=\"flex items-center gap-2 text-sm font-medium\">\n                          <item.icon className=\"h-4 w-4 opacity-70\" />\n                          {displayLabel}\n                        </span>\n                        <span className=\"text-base-content/60 pl-6 font-mono text-[10px]\">\n                          {perm.action} • {perm.subject}\n                        </span>\n                      </div>\n                      {displayRoles.map((role) => (\n                        <PermissionCell\n                          className=\"border-base-300 border-b p-0\"\n                          isUpdating={isUpdatingPermissions && updatingRoleId === role.id}\n                          key={role.id}\n                          onToggle={onPermissionToggle}\n                          permissionId={perm.id}\n                          role={role}\n                        />\n                      ))}\n                    </Fragment>\n                  );\n                })}\n              </div>\n            )}\n          </Fragment>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nfunction PermissionCell({\n  className,\n  isUpdating,\n  onToggle,\n  permissionId,\n  role,\n}: {\n  className?: string;\n  isUpdating: boolean;\n  onToggle: (r: Role, i: number) => void;\n  permissionId: number;\n  role: Role;\n}) {\n  const hasAccess = role.permissions.some((rp) => rp.permissionId === permissionId);\n\n  return (\n    <div className={`flex items-center justify-center ${className || \"\"}`}>\n      <button\n        className=\"group flex h-8 w-8 items-center justify-center transition-colors\"\n        disabled={isUpdating}\n        onClick={() => {\n          onToggle(role, permissionId);\n        }}\n      >\n        {hasAccess ? (\n          <div className=\"bg-primary hover:bg-primary-focus flex h-5 w-5 items-center justify-center rounded-md shadow-sm transition-transform active:scale-95\">\n            <Check className=\"text-primary-content\" size={12} />\n          </div>\n        ) : (\n          <div className=\"border-base-300 bg-base-100 group-hover:border-primary/50 group-hover:bg-primary/5 h-5 w-5 rounded-md border-2 transition-colors\" />\n        )}\n      </button>\n    </div>\n  );\n}\n\nfunction PermissionRow({\n  displayRoles,\n  isUpdating,\n  onToggle,\n  perm,\n  updatingRoleId,\n}: {\n  displayRoles: Role[];\n  isUpdating: boolean;\n  onToggle: (role: Role, id: number) => void;\n  perm: Permission;\n  updatingRoleId?: number;\n}) {\n  const actionMap: Record<string, string> = {\n    create: \"Crear\",\n    delete: \"Eliminar\",\n    read: \"Ver\",\n    update: \"Editar\",\n  };\n  const actionLabel = actionMap[perm.action] || perm.action;\n\n  return (\n    <div className=\"contents\">\n      <div className=\"bg-base-100 border-base-300 sticky left-0 z-10 flex flex-col justify-center border-r border-b py-2 pl-16 text-sm\">\n        <span className=\"flex items-center gap-2 font-medium\">{actionLabel}</span>\n        <span className=\"text-base-content/60 font-mono text-[10px]\">\n          {perm.action} • {perm.subject}\n        </span>\n      </div>\n      {displayRoles.map((role) => (\n        <PermissionCell\n          className=\"border-base-300 border-b\"\n          isUpdating={isUpdating && updatingRoleId === role.id}\n          key={role.id}\n          onToggle={onToggle}\n          permissionId={perm.id}\n          role={role}\n        />\n      ))}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/roles/components/RoleFormModal.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":31,"column":31,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":31,"endColumn":76,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[1093,1111],"text":"Readonly<RoleFormModalProps>"},"desc":"Mark the props as read-only"}]},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":62,"column":23,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":62,"endColumn":75,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[2023,2040],"text":"Readonly<RoleBaseFormProps>"},"desc":"Mark the props as read-only"}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":69,"column":39,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":69,"endColumn":41,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2256,2258],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/require-await","severity":2,"message":"Async method 'onSubmit' has no 'await' expression.","line":97,"column":5,"nodeType":"ArrowFunctionExpression","messageId":"missingAwait","endLine":97,"endColumn":21,"suggestions":[{"messageId":"removeAsync","fix":{"range":[3335,3341],"text":""},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"Using `join()` for field.state.meta.errors may use Object's default stringification format ('[object Object]') when stringified.","line":148,"column":58,"nodeType":"MemberExpression","messageId":"baseArrayJoin","endLine":148,"endColumn":81},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":203,"column":23,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":203,"endColumn":89,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[6935,6976],"text":"Readonly<{ onClose: () => void; roleEntity: Role }>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useForm } from \"@tanstack/react-form\";\nimport { useMutation, useQueryClient, useSuspenseQuery } from \"@tanstack/react-query\";\nimport { AlertCircle, User as UserIcon } from \"lucide-react\";\nimport { Suspense } from \"react\";\nimport { z } from \"zod\";\n\nimport { useToast } from \"@/context/ToastContext\";\nimport { createRole, type RoleUser, updateRole } from \"@/features/roles/api\";\nimport { roleKeys, roleQueries } from \"@/features/roles/api\";\nimport { Role } from \"@/types/roles\";\n\ninterface RoleFormModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  role?: null | Role; // If present, Edit mode. If null, Create mode.\n}\n\nconst formSchema = z.object({\n  description: z.string().max(255, \"La descripción no puede exceder los 255 caracteres\").optional(),\n  name: z.string().min(1, \"El nombre es obligatorio\").max(50, \"El nombre no puede exceder los 50 caracteres\"),\n});\n\ninterface RoleBaseFormProps {\n  onClose: () => void;\n  roleEntity: null | Role;\n  userData: RoleUser[];\n}\n\ntype RoleFormData = z.infer<typeof formSchema>;\n\nexport function RoleFormModal({ isOpen, onClose, role }: RoleFormModalProps) {\n  if (!isOpen) return null;\n\n  return (\n    <dialog className=\"modal modal-bottom sm:modal-middle\" open>\n      <div className=\"modal-box\">\n        <h3 className=\"text-lg font-bold\">{role ? \"Editar Rol\" : \"Nuevo Rol\"}</h3>\n\n        {role ? (\n          <Suspense\n            fallback={\n              <div className=\"flex h-64 items-center justify-center\">\n                <span className=\"loading loading-spinner text-primary\" />\n              </div>\n            }\n          >\n            <RoleEditForm onClose={onClose} roleEntity={role} />\n          </Suspense>\n        ) : (\n          <RoleBaseForm onClose={onClose} roleEntity={null} userData={[]} />\n        )}\n      </div>\n\n      {/* Backdrop to close */}\n      <form className=\"modal-backdrop\" method=\"dialog\">\n        <button onClick={onClose}>close</button>\n      </form>\n    </dialog>\n  );\n}\n\nfunction RoleBaseForm({ onClose, roleEntity, userData }: RoleBaseFormProps) {\n  const toast = useToast();\n  const queryClient = useQueryClient();\n\n  const mutation = useMutation({\n    mutationFn: async (data: RoleFormData) => {\n      const payload = {\n        description: data.description || \"\",\n        name: data.name,\n      };\n      await (roleEntity ? updateRole(roleEntity.id, payload) : createRole(payload));\n    },\n    onError: (err: Error) => {\n      let message = err.message || \"Ocurrió un error al guardar el rol.\";\n      const errorWithDetails = err as Error & { details?: unknown };\n      if (\"details\" in errorWithDetails && Array.isArray(errorWithDetails.details)) {\n        const issues = errorWithDetails.details\n          .map((i: { message: string; path: (number | string)[] }) => `${i.path.join(\".\")}: ${i.message}`)\n          .join(\"\\n\");\n        message = `Datos inválidos:\\n${issues}`;\n      }\n      toast.error(message, \"Error\");\n    },\n    onSuccess: () => {\n      toast.success(\"Los cambios se han guardado correctamente.\", roleEntity ? \"Rol actualizado\" : \"Rol creado\");\n      void queryClient.invalidateQueries({ queryKey: roleKeys.all });\n      onClose();\n    },\n  });\n\n  const form = useForm({\n    defaultValues: {\n      description: roleEntity?.description ?? \"\",\n      name: roleEntity?.name ?? \"\",\n    } as RoleFormData,\n    onSubmit: async ({ value }) => {\n      mutation.mutate(value);\n    },\n    validators: {\n      onChange: formSchema,\n    },\n  });\n\n  const renderUsersList = () => {\n    if (userData.length > 0) {\n      return (\n        <div className=\"max-h-32 space-y-1 overflow-y-auto\">\n          {userData.map((u) => (\n            <div className=\"hover:bg-base-100 flex items-center justify-between rounded p-1 text-xs\" key={u.id}>\n              <span>{u.person ? `${u.person.names} ${u.person.fatherName}` : \"Sin nombre\"}</span>\n              <span className=\"opacity-50\">{u.email}</span>\n            </div>\n          ))}\n        </div>\n      );\n    }\n\n    return <p className=\"text-xs italic opacity-50\">No hay usuarios con este rol.</p>;\n  };\n\n  return (\n    <form\n      className=\"space-y-4 py-4\"\n      onSubmit={(e) => {\n        e.preventDefault();\n        void form.handleSubmit();\n      }}\n    >\n      <form.Field name=\"name\">\n        {(field) => (\n          <div className=\"form-control w-full\">\n            <label className=\"label\" htmlFor=\"role-name\">\n              <span className=\"label-text\">Nombre del Rol</span>\n            </label>\n            <input\n              className={`input input-bordered w-full ${field.state.meta.errors.length > 0 ? \"input-error\" : \"\"}`}\n              id=\"role-name\"\n              onBlur={field.handleBlur}\n              onChange={(e) => {\n                field.handleChange(e.target.value);\n              }}\n              placeholder=\"Ej. Supervisor de Finanzas\"\n              type=\"text\"\n              value={field.state.value}\n            />\n            {field.state.meta.errors.length > 0 && (\n              <span className=\"text-error mt-1 text-xs\">{field.state.meta.errors.join(\", \")}</span>\n            )}\n          </div>\n        )}\n      </form.Field>\n\n      <form.Field name=\"description\">\n        {(field) => (\n          <div className=\"form-control w-full\">\n            <label className=\"label\" htmlFor=\"role-description\">\n              <span className=\"label-text\">Descripción</span>\n            </label>\n            <input\n              className=\"input input-bordered w-full\"\n              id=\"role-description\"\n              onBlur={field.handleBlur}\n              onChange={(e) => {\n                field.handleChange(e.target.value);\n              }}\n              placeholder=\"Descripción breve de las responsabilidades\"\n              type=\"text\"\n              value={field.state.value ?? \"\"}\n            />\n          </div>\n        )}\n      </form.Field>\n\n      {/* Show affected users even if empty list, to confirm zero users */}\n      {roleEntity && (\n        <div className=\"bg-base-200 rounded-lg p-3 text-sm\">\n          <div className=\"mb-2 flex items-center gap-2 font-medium opacity-70\">\n            <UserIcon className=\"h-4 w-4\" />\n            Usuarios afectados ({userData.length})\n          </div>\n          {renderUsersList()}\n          <div className=\"text-warning mt-2 flex gap-1 text-xs\">\n            <AlertCircle className=\"h-3 w-3\" />\n            <span>Cualquier cambio en los permisos afectará inmediatamente a estos usuarios.</span>\n          </div>\n        </div>\n      )}\n\n      <div className=\"modal-action\">\n        <button className=\"btn\" onClick={onClose} type=\"button\">\n          Cancelar\n        </button>\n        <button className=\"btn btn-primary\" disabled={mutation.isPending} type=\"submit\">\n          {mutation.isPending && <span className=\"loading loading-spinner\"></span>}\n          {roleEntity ? \"Guardar Cambios\" : \"Crear Rol\"}\n        </button>\n      </div>\n    </form>\n  );\n}\n\nfunction RoleEditForm({ onClose, roleEntity }: { onClose: () => void; roleEntity: Role }) {\n  const { data: users } = useSuspenseQuery(roleQueries.users(roleEntity.id));\n\n  return <RoleBaseForm onClose={onClose} roleEntity={roleEntity} userData={users} />;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/roles/components/RoleMappingColumns.tsx","messages":[{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":34,"column":59,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":34,"endColumn":61,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1036,1038],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ColumnDef } from \"@tanstack/react-table\";\n\nimport type { Role as AvailableRole } from \"@/types/roles\";\n\nimport type { RoleMapping } from \"../api\";\n\nexport type ExtendedRoleMapping = RoleMapping & {\n  isModified?: boolean;\n  isNew?: boolean;\n};\n\nexport const getColumns = (\n  availableRoles: AvailableRole[],\n  onRoleChange: (employeeRole: string, newAppRole: string) => void\n): ColumnDef<ExtendedRoleMapping>[] => [\n  {\n    accessorKey: \"employee_role\",\n    cell: ({ row }) => <span className=\"font-medium\">{row.original.employee_role}</span>,\n    header: \"Cargo en Ficha\",\n  },\n  {\n    accessorKey: \"app_role\",\n    cell: ({ row }) => {\n      const mapping = row.original;\n      return (\n        <select\n          className=\"select select-bordered select-sm w-full max-w-xs\"\n          onChange={(e) => {\n            onRoleChange(mapping.employee_role, e.target.value);\n          }}\n          value={mapping.app_role}\n        >\n          {availableRoles.map((role) => (\n            <option key={role.id} title={role.description || \"\"} value={role.name}>\n              {role.name}\n            </option>\n          ))}\n        </select>\n      );\n    },\n    header: \"Rol en Aplicación\",\n  },\n];\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/roles/components/RoleMappingManager.tsx","messages":[{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":64,"column":87,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":64,"endColumn":89,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2298,2375],"text":"(roles.find((r: AvailableRole) => r.name === \"VIEWER\")?.name ?? roles[0]?.name)"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":64,"column":105,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":64,"endColumn":107,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2376,2378],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/require-await","severity":2,"message":"Async arrow function 'handleSave' has no 'await' expression.","line":84,"column":31,"nodeType":"ArrowFunctionExpression","messageId":"missingAwait","endLine":84,"endColumn":33,"suggestions":[{"messageId":"removeAsync","fix":{"range":[2922,2928],"text":""},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":85,"column":60,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":85,"endColumn":62,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2995,2997],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMutation, useQueryClient, useSuspenseQuery } from \"@tanstack/react-query\";\nimport { useEffect, useMemo, useState } from \"react\";\n\nimport type { Role as AvailableRole } from \"@/types/roles\";\n\nimport { DataTable } from \"@/components/data-table/DataTable\";\nimport Button from \"@/components/ui/Button\";\nimport { type Employee } from \"@/features/hr/employees/api\";\n\nimport type { RoleMapping } from \"../api\";\nimport type { ExtendedRoleMapping } from \"./RoleMappingColumns\";\n\nimport { roleQueries, saveRoleMapping } from \"../api\";\nimport { getColumns } from \"./RoleMappingColumns\";\n\nexport default function RoleMappingManager() {\n  const queryClient = useQueryClient();\n  const [mappings, setMappings] = useState<ExtendedRoleMapping[]>([]);\n  const [availableRoles, setAvailableRoles] = useState<AvailableRole[]>([]);\n\n  const { data } = useSuspenseQuery(roleQueries.mappings());\n\n  const saveMutation = useMutation({\n    mutationFn: async (changedMappings: ExtendedRoleMapping[]) => {\n      await Promise.all(\n        changedMappings.map((m) =>\n          saveRoleMapping({\n            app_role: m.app_role,\n            employee_role: m.employee_role,\n          })\n        )\n      );\n      // Invalidate the mapping query\n      return queryClient.invalidateQueries({ queryKey: roleQueries.mappings().queryKey });\n    },\n    onError: () => {\n      // handled in component error state if needed, but we use mutation.error\n    },\n    onSuccess: () => {\n      // Success means invalidation is triggerd\n    },\n  });\n\n  // Sync data to local state\n  useEffect(() => {\n    // data is guaranteed by Suspense\n    const { dbMappings, employees, roles } = data;\n    setAvailableRoles(roles);\n\n    const dbMappingsMap = new Map(dbMappings.map((m: RoleMapping) => [m.employee_role, m]));\n    const uniqueRoles = [...new Set(employees.map((e: Employee) => e.position))].toSorted((a, b) => a.localeCompare(b));\n\n    const allRoles = uniqueRoles.map((resultRole: string) => {\n      const existing = dbMappingsMap.get(resultRole);\n      if (existing) {\n        // Explicitly construct object to satisfy TS\n        return {\n          app_role: existing.app_role,\n          employee_role: existing.employee_role,\n          isModified: false,\n          isNew: false,\n        };\n      }\n      const defaultRole = roles.find((r: AvailableRole) => r.name === \"VIEWER\")?.name || roles[0]?.name || \"\";\n      return {\n        app_role: defaultRole,\n        employee_role: resultRole,\n        isModified: false,\n        isNew: true,\n      };\n    });\n\n    setMappings(allRoles);\n  }, [data]);\n\n  const handleRoleChange = (employeeRole: string, newAppRole: string) => {\n    setMappings((prev) =>\n      prev.map((m) => (m.employee_role === employeeRole ? { ...m, app_role: newAppRole, isModified: !m.isNew } : m))\n    );\n  };\n\n  const columns = useMemo(() => getColumns(availableRoles, handleRoleChange), [availableRoles]);\n\n  const handleSave = async () => {\n    const changedMappings = mappings.filter((m) => m.isNew || m.isModified);\n    if (changedMappings.length === 0) return;\n    saveMutation.mutate(changedMappings);\n  };\n\n  const saveErrorMessage = (() => {\n    if (saveMutation.error instanceof Error) return saveMutation.error.message;\n    return null;\n  })();\n\n  const isSaving = saveMutation.isPending;\n\n  return (\n    <div className=\"bg-base-100 space-y-4 rounded-xl p-6 shadow-sm\">\n      <div className=\"flex items-center justify-between\">\n        <h3 className=\"text-base-content text-lg font-bold\">Mapeo de Roles (Cargo → Rol App)</h3>\n        {saveErrorMessage && <span className=\"text-error text-sm\">{saveErrorMessage}</span>}\n      </div>\n\n      <p className=\"text-base-content/70 text-sm\">\n        Asigna qué rol de aplicación tendrán los empleados automáticamente según su cargo en la ficha.\n      </p>\n\n      <DataTable columns={columns} data={mappings} enableToolbar={false} pagination={{ pageIndex: 0, pageSize: 100 }} />\n\n      <div className=\"flex justify-end pt-2\">\n        <Button\n          disabled={isSaving || mappings.every((m) => !m.isNew && !m.isModified)}\n          isLoading={isSaving}\n          onClick={handleSave}\n        >\n          Guardar Cambios\n        </Button>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/roles/queries.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/api.ts","messages":[{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"'error' will use Object's default stringification format ('[object Object]') when stringified.","line":18,"column":58,"nodeType":"Identifier","messageId":"baseToString","endLine":18,"endColumn":63}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { apiClient } from \"@/lib/api-client\";\n\nimport type {\n  CreateServicePayload,\n  RegenerateServicePayload,\n  ServiceDetailResponse,\n  ServiceListResponse,\n  ServicePaymentPayload,\n  ServiceSchedule,\n} from \"./types\";\n\nexport async function createService(payload: CreateServicePayload): Promise<ServiceDetailResponse> {\n  return apiClient.post<ServiceDetailResponse>(\"/api/services\", payload);\n}\n\nexport function extractErrorMessage(error: unknown): null | string {\n  if (!error) return null;\n  return error instanceof Error ? error.message : String(error);\n}\n\nexport async function fetchServiceDetail(publicId: string): Promise<ServiceDetailResponse> {\n  return apiClient.get<ServiceDetailResponse>(`/api/services/${publicId}`);\n}\n\nexport async function fetchServices(): Promise<ServiceListResponse> {\n  return apiClient.get<ServiceListResponse>(\"/api/services\");\n}\n\nexport async function regenerateServiceSchedules(\n  publicId: string,\n  payload: RegenerateServicePayload\n): Promise<ServiceDetailResponse> {\n  return apiClient.post<ServiceDetailResponse>(`/api/services/${publicId}/schedules`, payload);\n}\n\nexport async function registerServicePayment(\n  scheduleId: number,\n  payload: ServicePaymentPayload\n): Promise<{ schedule: ServiceSchedule; status: \"ok\" }> {\n  return apiClient.post<{ schedule: ServiceSchedule; status: \"ok\" }>(\n    `/api/services/schedules/${scheduleId}/pay`,\n    payload\n  );\n}\n\nexport async function unlinkServicePayment(scheduleId: number): Promise<{ schedule: ServiceSchedule; status: \"ok\" }> {\n  return apiClient.post<{ schedule: ServiceSchedule; status: \"ok\" }>(\n    `/api/services/schedules/${scheduleId}/unlink`,\n    {}\n  );\n}\n\nexport async function updateService(publicId: string, payload: CreateServicePayload): Promise<ServiceDetailResponse> {\n  return apiClient.put<ServiceDetailResponse>(`/api/services/${publicId}`, payload);\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/components/ServiceDetail.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":35,"column":31,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":43,"endColumn":22,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[1110,1128],"text":"Readonly<ServiceDetailProps>"},"desc":"Mark the props as read-only"}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":181,"column":29,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":181,"endColumn":31,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[5716,5718],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/no-unnecessary-type-conversion","severity":2,"message":"Passing a number to Number() does not change the type or value of the number.","line":235,"column":15,"nodeType":"Identifier","messageId":"unnecessaryTypeConversion","endLine":235,"endColumn":21,"suggestions":[{"messageId":"suggestRemove","fix":{"range":[8036,8067],"text":"(service.total_paid ?? 0)"},"desc":"Remove the type conversion."},{"messageId":"suggestSatisfies","data":{"type":"number"},"fix":{"range":[8036,8067],"text":"((service.total_paid ?? 0) satisfies number)"},"desc":"Instead, assert that the value satisfies the number type."}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":235,"column":22,"nodeType":"MemberExpression","messageId":"neverNullish","endLine":235,"endColumn":40}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useNavigate } from \"@tanstack/react-router\";\nimport dayjs from \"dayjs\";\nimport type { ChangeEvent } from \"react\";\nimport { useState } from \"react\";\n\nimport Button from \"@/components/ui/Button\";\nimport Input from \"@/components/ui/Input\";\nimport Modal from \"@/components/ui/Modal\";\n\nimport type {\n  RegenerateServicePayload,\n  ServiceFrequency,\n  ServiceLateFeeMode,\n  ServiceObligationType,\n  ServiceOwnership,\n  ServiceRecurrenceType,\n  ServiceSchedule,\n  ServiceSummary,\n  ServiceType,\n} from \"../types\";\n\nimport ServiceScheduleAccordion from \"./ServiceScheduleAccordion\";\nimport ServiceScheduleTable from \"./ServiceScheduleTable\";\n\ninterface ServiceDetailProps {\n  canManage: boolean;\n  loading: boolean;\n  onRegenerate: (overrides: RegenerateServicePayload) => Promise<void>;\n  onRegisterPayment: (schedule: ServiceSchedule) => void;\n  onUnlinkPayment: (schedule: ServiceSchedule) => void;\n  schedules: ServiceSchedule[];\n  service: null | ServiceSummary;\n}\n\nexport function ServiceDetail({\n  canManage,\n  loading,\n  onRegenerate,\n  onRegisterPayment,\n  onUnlinkPayment,\n  schedules,\n  service,\n}: ServiceDetailProps) {\n  const [regenerateOpen, setRegenerateOpen] = useState(false);\n  const [regenerateForm, setRegenerateForm] = useState<RegenerateServicePayload>({});\n  const [regenerating, setRegenerating] = useState(false);\n  const [regenerateError, setRegenerateError] = useState<null | string>(null);\n  const navigate = useNavigate();\n\n  const statusBadge = (() => {\n    if (!service) return { className: \"\", label: \"\" };\n    switch (service.status) {\n      case \"ARCHIVED\": {\n        return { className: \"bg-base-200 text-base-content\", label: \"Archivado\" };\n      }\n      case \"INACTIVE\": {\n        return { className: \"bg-emerald-100 text-emerald-700\", label: \"Sin pendientes\" };\n      }\n      default: {\n        return service.overdue_count > 0\n          ? { className: \"bg-rose-100 text-rose-700\", label: \"Vencidos\" }\n          : { className: \"bg-amber-100 text-amber-700\", label: \"Activo\" };\n      }\n    }\n  })();\n\n  const frequencyLabel = (() => {\n    if (!service) return \"\";\n    const labels: Record<ServiceFrequency, string> = {\n      ANNUAL: \"Anual\",\n      BIMONTHLY: \"Bimensual\",\n      BIWEEKLY: \"Quincenal\",\n      MONTHLY: \"Mensual\",\n      ONCE: \"Única vez\",\n      QUARTERLY: \"Trimestral\",\n      SEMIANNUAL: \"Semestral\",\n      WEEKLY: \"Semanal\",\n    };\n    return labels[service.frequency];\n  })();\n\n  const serviceTypeLabel = (() => {\n    if (!service) return \"\";\n    const labels: Record<ServiceType, string> = {\n      BUSINESS: \"Operación general\",\n      LEASE: \"Arriendo / leasing\",\n      OTHER: \"Otro\",\n      PERSONAL: \"Personal\",\n      SOFTWARE: \"Software / suscripciones\",\n      SUPPLIER: \"Proveedor\",\n      TAX: \"Impuestos / contribuciones\",\n      UTILITY: \"Servicios básicos\",\n    };\n    return labels[service.service_type];\n  })();\n\n  const ownershipLabel = (() => {\n    if (!service) return \"\";\n    const labels: Record<ServiceOwnership, string> = {\n      COMPANY: \"Empresa\",\n      MIXED: \"Compartido\",\n      OWNER: \"Personal del dueño\",\n      THIRD_PARTY: \"Terceros\",\n    };\n    return labels[service.ownership];\n  })();\n\n  const obligationLabel = (() => {\n    if (!service) return \"\";\n    const labels: Record<ServiceObligationType, string> = {\n      DEBT: \"Deuda\",\n      LOAN: \"Préstamo\",\n      OTHER: \"Otro\",\n      SERVICE: \"Servicio / gasto\",\n    };\n    return labels[service.obligation_type];\n  })();\n\n  const recurrenceLabel = (() => {\n    if (!service) return \"\";\n    const labels: Record<ServiceRecurrenceType, string> = {\n      ONE_OFF: \"Puntual\",\n      RECURRING: \"Recurrente\",\n    };\n    return labels[service.recurrence_type];\n  })();\n\n  const amountModeLabel = (() => {\n    if (!service) return \"\";\n    return service.amount_indexation === \"UF\" ? \"UF\" : \"Monto fijo\";\n  })();\n\n  const lateFeeLabel = (() => {\n    if (!service) return \"Sin recargo\";\n    const labels: Record<ServiceLateFeeMode, string> = {\n      FIXED: service.late_fee_value ? `$${service.late_fee_value.toLocaleString(\"es-CL\")}` : \"Monto fijo\",\n      NONE: \"Sin recargo\",\n      PERCENTAGE: service.late_fee_value == null ? \"% del monto\" : `${service.late_fee_value}%`,\n    };\n    return labels[service.late_fee_mode];\n  })();\n\n  const counterpartSummary = (() => {\n    if (!service) return \"Sin contraparte\";\n    if (service.counterpart_name) return service.counterpart_name;\n    if (service.counterpart_id) return `Contraparte #${service.counterpart_id}`;\n    return \"Sin contraparte\";\n  })();\n\n  const handleRegenerate = async (event: React.FormEvent<HTMLFormElement>) => {\n    event.preventDefault();\n    if (!service) return;\n    setRegenerating(true);\n    setRegenerateError(null);\n    try {\n      await onRegenerate(regenerateForm);\n      setRegenerateOpen(false);\n      setRegenerateForm({});\n    } catch (error) {\n      const message = error instanceof Error ? error.message : \"No se pudo regenerar el cronograma\";\n      setRegenerateError(message);\n    } finally {\n      setRegenerating(false);\n    }\n  };\n\n  if (!service) {\n    return (\n      <section className=\"text-base-content/60 bg-base-100 flex h-full flex-col items-center justify-center rounded-3xl p-10 text-sm\">\n        <p>Selecciona un servicio para ver el detalle.</p>\n      </section>\n    );\n  }\n\n  return (\n    <section className=\"bg-base-100 relative flex h-full min-w-0 flex-col gap-6 rounded-3xl p-6\">\n      <header className=\"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between\">\n        <div className=\"space-y-1\">\n          <h1 className=\"text-primary text-2xl font-bold break-all drop-shadow-sm\">{service.name}</h1>\n          <p className=\"text-base-content text-sm\">\n            {service.detail || \"Gasto\"} · {serviceTypeLabel} · {ownershipLabel}\n          </p>\n          <div className=\"text-base-content/60 flex flex-wrap items-center gap-3 text-xs\">\n            <span>Inicio {dayjs(service.start_date).format(\"DD MMM YYYY\")}</span>\n            <span>Frecuencia {frequencyLabel.toLowerCase()}</span>\n            {service.due_day && <span>Vence día {service.due_day}</span>}\n            <span>{recurrenceLabel}</span>\n          </div>\n        </div>\n        <div className=\"flex flex-wrap items-center justify-end gap-2 sm:gap-3\">\n          <span\n            className={`rounded-full px-3 py-1 text-xs font-semibold tracking-wide uppercase ${statusBadge.className}`}\n          >\n            {statusBadge.label}\n          </span>\n          {canManage && (\n            <Button\n              onClick={() => {\n                setRegenerateOpen(true);\n              }}\n              type=\"button\"\n              variant=\"secondary\"\n            >\n              Regenerar cronograma\n            </Button>\n          )}\n          {canManage && (\n            <Button\n              onClick={() => navigate({ to: `/services/${service.public_id}/edit` })}\n              type=\"button\"\n              variant=\"secondary\"\n            >\n              Editar servicio\n            </Button>\n          )}\n        </div>\n      </header>\n\n      <section className=\"border-base-300 bg-base-200 text-base-content grid gap-4 rounded-2xl border p-4 text-sm sm:grid-cols-3 lg:grid-cols-5\">\n        <div>\n          <p className=\"text-base-content/50 text-xs tracking-wide uppercase\">Monto base</p>\n          <p className=\"text-base-content text-lg font-semibold\">${service.default_amount.toLocaleString(\"es-CL\")}</p>\n        </div>\n        <div>\n          <p className=\"text-base-content/50 text-xs tracking-wide uppercase\">Pendientes</p>\n          <p className=\"text-base-content text-lg font-semibold\">{service.pending_count}</p>\n        </div>\n        <div>\n          <p className=\"text-base-content/50 text-xs tracking-wide uppercase\">Vencidos</p>\n          <p className=\"text-lg font-semibold text-rose-600\">{service.overdue_count}</p>\n        </div>\n        <div>\n          <p className=\"text-base-content/50 text-xs tracking-wide uppercase\">Total pagado</p>\n          <p className=\"text-lg font-semibold text-emerald-600\">\n            ${Number(service.total_paid ?? 0).toLocaleString(\"es-CL\")}\n          </p>\n        </div>\n        <div>\n          <p className=\"text-base-content/50 text-xs tracking-wide uppercase\">Modo de cálculo</p>\n          <p className=\"text-base-content text-sm font-semibold\">{amountModeLabel}</p>\n        </div>\n        <div>\n          <p className=\"text-base-content/50 text-xs tracking-wide uppercase\">Recargo</p>\n          <p className=\"text-base-content text-sm font-semibold\">{lateFeeLabel}</p>\n          {service.late_fee_grace_days != null && service.late_fee_mode !== \"NONE\" && (\n            <p className=\"text-base-content/50 text-xs\">Tras {service.late_fee_grace_days} días</p>\n          )}\n        </div>\n      </section>\n\n      <section className=\"border-base-300 bg-base-200 text-base-content grid gap-4 rounded-2xl border p-4 text-sm md:grid-cols-3\">\n        <div>\n          <p className=\"text-base-content/50 text-xs tracking-wide uppercase\">Contraparte</p>\n          <p className=\"text-base-content font-semibold\">{counterpartSummary}</p>\n          {service.counterpart_account_identifier && (\n            <p className=\"text-base-content/60 text-xs\">\n              Cuenta {service.counterpart_account_identifier}\n              {service.counterpart_account_bank_name ? ` · ${service.counterpart_account_bank_name}` : \"\"}\n            </p>\n          )}\n          {service.account_reference && (\n            <p className=\"text-base-content/60 text-xs\">Referencia: {service.account_reference}</p>\n          )}\n        </div>\n        <div>\n          <p className=\"text-base-content/50 text-xs tracking-wide uppercase\">Emisión</p>\n          <p className=\"text-base-content font-semibold\">\n            {(() => {\n              if (service.emission_mode === \"FIXED_DAY\" && service.emission_day) {\n                return `Día ${service.emission_day}`;\n              }\n              if (service.emission_mode === \"DATE_RANGE\" && service.emission_start_day && service.emission_end_day) {\n                return `Entre día ${service.emission_start_day} y ${service.emission_end_day}`;\n              }\n              if (service.emission_mode === \"SPECIFIC_DATE\" && service.emission_exact_date) {\n                return `Fecha ${dayjs(service.emission_exact_date).format(\"DD MMM YYYY\")}`;\n              }\n              return \"Sin especificar\";\n            })()}\n          </p>\n        </div>\n        <div>\n          <p className=\"text-base-content/50 text-xs tracking-wide uppercase\">Clasificación</p>\n          <p className=\"text-base-content font-semibold\">{obligationLabel}</p>\n          <p className=\"text-base-content/60 text-xs\">{recurrenceLabel}</p>\n        </div>\n      </section>\n\n      <ServiceScheduleAccordion\n        canManage={canManage}\n        onRegisterPayment={onRegisterPayment}\n        onUnlinkPayment={onUnlinkPayment}\n        schedules={schedules}\n        service={service}\n      />\n\n      <ServiceScheduleTable\n        canManage={canManage}\n        onRegisterPayment={onRegisterPayment}\n        onUnlinkPayment={onUnlinkPayment}\n        schedules={schedules}\n      />\n\n      {service.notes && (\n        <div className=\"border-base-300 bg-base-200 text-base-content rounded-2xl border p-4 text-sm\">\n          <p className=\"text-base-content/50 text-xs tracking-wide uppercase\">Notas</p>\n          <p>{service.notes}</p>\n        </div>\n      )}\n\n      <Modal\n        isOpen={regenerateOpen}\n        onClose={() => {\n          setRegenerateOpen(false);\n        }}\n        title=\"Regenerar cronograma\"\n      >\n        <form className=\"space-y-4\" onSubmit={handleRegenerate}>\n          <Input\n            label=\"Meses a generar\"\n            max={60}\n            min={1}\n            onChange={(event: ChangeEvent<HTMLInputElement>) => {\n              setRegenerateForm((prev) => ({ ...prev, months: Number(event.target.value) }));\n            }}\n            type=\"number\"\n            value={regenerateForm.months ?? service.next_generation_months}\n          />\n          <Input\n            label=\"Nueva fecha de inicio\"\n            onChange={(event: ChangeEvent<HTMLInputElement>) => {\n              setRegenerateForm((prev) => ({ ...prev, startDate: event.target.value }));\n            }}\n            type=\"date\"\n            value={regenerateForm.startDate ?? service.start_date}\n          />\n          <Input\n            label=\"Monto base\"\n            min={0}\n            onChange={(event: ChangeEvent<HTMLInputElement>) => {\n              setRegenerateForm((prev) => ({ ...prev, defaultAmount: Number(event.target.value) }));\n            }}\n            step=\"0.01\"\n            type=\"number\"\n            value={regenerateForm.defaultAmount ?? service.default_amount}\n          />\n          <Input\n            label=\"Día de vencimiento\"\n            max={31}\n            min={1}\n            onChange={(event: ChangeEvent<HTMLInputElement>) => {\n              setRegenerateForm((prev) => ({\n                ...prev,\n                dueDay: event.target.value ? Number(event.target.value) : null,\n              }));\n            }}\n            type=\"number\"\n            value={regenerateForm.dueDay ?? service.due_day ?? \"\"}\n          />\n          <Input\n            as=\"select\"\n            label=\"Frecuencia\"\n            onChange={(event: ChangeEvent<HTMLSelectElement>) => {\n              setRegenerateForm((prev) => ({\n                ...prev,\n                frequency: event.target.value as RegenerateServicePayload[\"frequency\"],\n              }));\n            }}\n            value={regenerateForm.frequency ?? service.frequency}\n          >\n            <option value=\"WEEKLY\">Semanal</option>\n            <option value=\"BIWEEKLY\">Quincenal</option>\n            <option value=\"MONTHLY\">Mensual</option>\n            <option value=\"BIMONTHLY\">Bimensual</option>\n            <option value=\"QUARTERLY\">Trimestral</option>\n            <option value=\"SEMIANNUAL\">Semestral</option>\n            <option value=\"ANNUAL\">Anual</option>\n            <option value=\"ONCE\">Única vez</option>\n          </Input>\n          {service.emission_mode === \"FIXED_DAY\" && (\n            <Input\n              helper=\"Aplica a servicios con día fijo de emisión\"\n              label=\"Día de emisión\"\n              max={31}\n              min={1}\n              onChange={(event: ChangeEvent<HTMLInputElement>) => {\n                setRegenerateForm((prev) => ({\n                  ...prev,\n                  emissionDay: event.target.value ? Number(event.target.value) : null,\n                }));\n              }}\n              type=\"number\"\n              value={regenerateForm.emissionDay ?? service.emission_day ?? \"\"}\n            />\n          )}\n          {regenerateError && (\n            <p className=\"rounded-lg bg-rose-100 px-4 py-2 text-sm text-rose-700\">{regenerateError}</p>\n          )}\n          <div className=\"flex justify-end gap-3\">\n            <Button\n              disabled={regenerating}\n              onClick={() => {\n                setRegenerateOpen(false);\n              }}\n              type=\"button\"\n              variant=\"secondary\"\n            >\n              Cancelar\n            </Button>\n            <Button disabled={regenerating} type=\"submit\">\n              {regenerating ? \"Actualizando...\" : \"Regenerar\"}\n            </Button>\n          </div>\n        </form>\n      </Modal>\n\n      {loading && (\n        <div className=\"bg-base-100/40 absolute inset-0 z-30 flex items-center justify-center backdrop-blur-sm\">\n          <p className=\"bg-base-100 text-primary rounded-full px-4 py-2 text-sm font-semibold shadow\">\n            Cargando servicio...\n          </p>\n        </div>\n      )}\n    </section>\n  );\n}\n\nexport default ServiceDetail;\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/components/ServiceForm.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":59,"column":29,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":59,"endColumn":97,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[1540,1556],"text":"Readonly<ServiceFormProps>"},"desc":"Mark the props as read-only"}]},{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":108,"column":45,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":108,"endColumn":64},{"ruleId":"@typescript-eslint/no-unnecessary-type-conversion","severity":2,"message":"Passing a number to Number() does not change the type or value of the number.","line":195,"column":24,"nodeType":"Identifier","messageId":"unnecessaryTypeConversion","endLine":195,"endColumn":30,"suggestions":[{"messageId":"suggestRemove","fix":{"range":[6133,6159],"text":"form.defaultAmount"},"desc":"Remove the type conversion."},{"messageId":"suggestSatisfies","data":{"type":"number"},"fix":{"range":[6133,6159],"text":"(form.defaultAmount satisfies number)"},"desc":"Instead, assert that the value satisfies the number type."}]},{"ruleId":"@typescript-eslint/no-unnecessary-type-conversion","severity":2,"message":"Passing a number to Number() does not change the type or value of the number.","line":209,"column":18,"nodeType":"Identifier","messageId":"unnecessaryTypeConversion","endLine":209,"endColumn":24,"suggestions":[{"messageId":"suggestRemove","fix":{"range":[7018,7043],"text":"form.lateFeeValue"},"desc":"Remove the type conversion."},{"messageId":"suggestSatisfies","data":{"type":"number"},"fix":{"range":[7018,7043],"text":"form.lateFeeValue satisfies number"},"desc":"Instead, assert that the value satisfies the number type."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useQuery } from \"@tanstack/react-query\";\nimport { useEffect, useState } from \"react\";\n\nimport Button from \"@/components/ui/Button\";\nimport { today } from \"@/lib/dates\";\n\nimport type { CounterpartAccount } from \"../../counterparts/types\";\nimport type { CreateServicePayload } from \"../types\";\n\nimport { fetchCounterpart, fetchCounterparts } from \"../../counterparts/api\";\nimport {\n  BasicInfoSection,\n  CounterpartSection,\n  EmissionSection,\n  FinancialSection,\n  SchedulingSection,\n  ServiceClassificationSection,\n} from \"./ServiceForm/index\";\n\nexport type ServiceFormState = CreateServicePayload & {\n  emissionExactDate?: null | string;\n};\n\ninterface ServiceFormProps {\n  initialValues?: Partial<CreateServicePayload>;\n  onCancel: () => void;\n  onSubmit: (payload: CreateServicePayload) => Promise<void>;\n  submitLabel?: string;\n}\n\nconst INITIAL_STATE: ServiceFormState = {\n  accountReference: \"\",\n  amountIndexation: \"NONE\",\n  category: \"\",\n  counterpartAccountId: null,\n  counterpartId: null,\n  defaultAmount: 0,\n  detail: \"\",\n  dueDay: null,\n  emissionDay: 1,\n  emissionEndDay: null,\n  emissionExactDate: null,\n  emissionMode: \"FIXED_DAY\",\n  emissionStartDay: null,\n  frequency: \"MONTHLY\",\n  lateFeeGraceDays: null,\n  lateFeeMode: \"NONE\",\n  lateFeeValue: null,\n  monthsToGenerate: 12,\n  name: \"\",\n  notes: \"\",\n  obligationType: \"SERVICE\",\n  ownership: \"COMPANY\",\n  recurrenceType: \"RECURRING\",\n  serviceType: \"BUSINESS\",\n  startDate: today(),\n};\n\nexport function ServiceForm({ initialValues, onCancel, onSubmit, submitLabel }: ServiceFormProps) {\n  const [form, setForm] = useState<ServiceFormState>({\n    ...INITIAL_STATE,\n    ...initialValues,\n  });\n  const [submitting, setSubmitting] = useState(false);\n  const [error, setError] = useState<null | string>(null);\n\n  const effectiveSubmitLabel = submitLabel ?? \"Crear servicio\";\n  const submittingLabel = submitLabel ? \"Guardando...\" : \"Creando...\";\n\n  useEffect(() => {\n    if (initialValues) {\n      setForm({\n        ...INITIAL_STATE,\n        ...initialValues,\n        monthsToGenerate: initialValues.monthsToGenerate ?? INITIAL_STATE.monthsToGenerate,\n        startDate: initialValues.startDate ?? INITIAL_STATE.startDate,\n      });\n    } else {\n      setForm(INITIAL_STATE);\n    }\n  }, [initialValues]);\n\n  // Extract mode values to prevent unnecessary effect runs\n  const lateFeeMode = form.lateFeeMode ?? \"NONE\";\n  const emissionMode = form.emissionMode ?? \"FIXED_DAY\";\n\n  // Clear late fee fields when mode is NONE\n  useEffect(() => {\n    if (lateFeeMode === \"NONE\") {\n      setForm((prev) => {\n        if (prev.lateFeeValue != null || prev.lateFeeGraceDays != null) {\n          return { ...prev, lateFeeGraceDays: null, lateFeeValue: null };\n        }\n        return prev;\n      });\n    }\n  }, [lateFeeMode]);\n\n  const { data: counterparts = [] } = useQuery({\n    queryFn: fetchCounterparts,\n    queryKey: [\"counterparts\"],\n  });\n\n  const { data: accounts = [] } = useQuery<CounterpartAccount[]>({\n    enabled: !!form.counterpartId,\n    queryFn: async () => {\n      // safe assurance due to enabled check\n      const detail = await fetchCounterpart(form.counterpartId!);\n      return detail.accounts;\n    },\n    queryKey: [\"counterpart-accounts\", form.counterpartId],\n  });\n\n  const counterpartsError = null; // Suspense handles errors\n\n  // Sync error handling roughly to previous (though React Query handles this better naturally)\n\n  // Adjust emission fields based on emission mode\n  useEffect(() => {\n    setForm((prev) => {\n      if (emissionMode === \"FIXED_DAY\") {\n        if (prev.emissionStartDay !== null || prev.emissionEndDay !== null || prev.emissionExactDate) {\n          return {\n            ...prev,\n            emissionDay: prev.emissionDay ?? 1,\n            emissionEndDay: null,\n            emissionExactDate: null,\n            emissionStartDay: null,\n          };\n        }\n        if (prev.emissionDay == null) {\n          return { ...prev, emissionDay: 1 };\n        }\n        return prev;\n      }\n      if (prev.emissionMode === \"DATE_RANGE\") {\n        const nextStart = prev.emissionStartDay ?? 1;\n        const nextEnd = prev.emissionEndDay ?? Math.max(5, nextStart);\n        if (\n          prev.emissionDay !== null ||\n          prev.emissionExactDate ||\n          prev.emissionStartDay !== nextStart ||\n          prev.emissionEndDay !== nextEnd\n        ) {\n          return {\n            ...prev,\n            emissionDay: null,\n            emissionEndDay: nextEnd,\n            emissionExactDate: null,\n            emissionStartDay: nextStart,\n          };\n        }\n        return prev;\n      }\n      if (prev.emissionMode === \"SPECIFIC_DATE\") {\n        if (prev.emissionDay !== null || prev.emissionStartDay !== null || prev.emissionEndDay !== null) {\n          return {\n            ...prev,\n            emissionDay: null,\n            emissionEndDay: null,\n            emissionStartDay: null,\n          };\n        }\n        return prev;\n      }\n      return prev;\n    });\n  }, [emissionMode]);\n\n  const handleChange = <K extends keyof ServiceFormState>(key: K, value: ServiceFormState[K]) => {\n    setForm((prev) => ({ ...prev, [key]: value }));\n  };\n\n  const handleCounterpartSelect = (value: string) => {\n    const id = value ? Number(value) : null;\n    handleChange(\"counterpartId\", id);\n    handleChange(\"counterpartAccountId\", null);\n    // Accounts will reload automatically via useQuery dependency on form.counterpartId\n  };\n\n  const effectiveMonths =\n    form.recurrenceType === \"ONE_OFF\" || form.frequency === \"ONCE\" ? 1 : (form.monthsToGenerate ?? 12);\n\n  const handleSubmit = async (event: React.FormEvent<HTMLFormElement>) => {\n    event.preventDefault();\n    setSubmitting(true);\n    setError(null);\n    try {\n      const payload: CreateServicePayload = {\n        accountReference: form.accountReference?.trim() ? form.accountReference.trim() : undefined,\n        amountIndexation: form.amountIndexation,\n        category: form.category?.trim() ? form.category.trim() : undefined,\n        counterpartAccountId: form.counterpartAccountId ?? null,\n        counterpartId: form.counterpartId ?? null,\n        defaultAmount: Number(form.defaultAmount) || 0,\n        detail: form.detail?.trim() ? form.detail.trim() : undefined,\n        dueDay: form.dueDay ?? null,\n        emissionDay: emissionMode === \"FIXED_DAY\" ? (form.emissionDay ?? null) : null,\n        emissionEndDay: emissionMode === \"DATE_RANGE\" ? (form.emissionEndDay ?? null) : null,\n        emissionExactDate: emissionMode === \"SPECIFIC_DATE\" ? (form.emissionExactDate ?? undefined) : null,\n        emissionMode,\n        emissionStartDay: emissionMode === \"DATE_RANGE\" ? (form.emissionStartDay ?? null) : null,\n        frequency: form.frequency,\n        lateFeeGraceDays: lateFeeMode === \"NONE\" ? null : (form.lateFeeGraceDays ?? null),\n        lateFeeMode,\n        lateFeeValue: (() => {\n          if (lateFeeMode === \"NONE\") return null;\n          if (form.lateFeeValue === null || form.lateFeeValue === undefined) return null;\n          return Number(form.lateFeeValue);\n        })(),\n        monthsToGenerate: form.recurrenceType === \"ONE_OFF\" || form.frequency === \"ONCE\" ? 1 : form.monthsToGenerate,\n        name: form.name.trim(),\n        notes: form.notes?.trim() ? form.notes.trim() : undefined,\n        obligationType: form.obligationType,\n        ownership: form.ownership,\n        recurrenceType: form.recurrenceType,\n        serviceType: form.serviceType,\n        startDate: form.startDate,\n      };\n\n      await onSubmit(payload);\n      if (!initialValues) {\n        setForm(INITIAL_STATE);\n        // setAccounts([]); // Handled by useQuery dependency\n      }\n    } catch (error_) {\n      const message = error_ instanceof Error ? error_.message : \"No se pudo crear el servicio\";\n      setError(message);\n      throw error_;\n    } finally {\n      setSubmitting(false);\n    }\n  };\n\n  return (\n    <form className=\"space-y-6\" onSubmit={handleSubmit}>\n      <BasicInfoSection\n        category={form.category}\n        detail={form.detail}\n        name={form.name}\n        notes={form.notes}\n        onChange={handleChange}\n      />\n\n      <ServiceClassificationSection\n        obligationType={form.obligationType}\n        onChange={handleChange}\n        ownership={form.ownership}\n        recurrenceType={form.recurrenceType}\n        serviceType={form.serviceType}\n      />\n\n      <CounterpartSection\n        accountReference={form.accountReference}\n        accounts={accounts}\n        accountsLoading={false}\n        counterpartAccountId={form.counterpartAccountId}\n        counterpartId={form.counterpartId}\n        counterparts={counterparts}\n        counterpartsError={counterpartsError}\n        counterpartsLoading={false}\n        onChange={handleChange}\n        onCounterpartSelect={handleCounterpartSelect}\n      />\n\n      <SchedulingSection\n        dueDay={form.dueDay}\n        effectiveMonths={effectiveMonths}\n        frequency={form.frequency}\n        monthsToGenerate={form.monthsToGenerate}\n        onChange={handleChange}\n        recurrenceType={form.recurrenceType}\n        startDate={form.startDate}\n      />\n\n      <EmissionSection\n        emissionDay={form.emissionDay}\n        emissionEndDay={form.emissionEndDay}\n        emissionExactDate={form.emissionExactDate}\n        emissionMode={form.emissionMode}\n        emissionStartDay={form.emissionStartDay}\n        onChange={handleChange}\n      />\n\n      <FinancialSection\n        amountIndexation={form.amountIndexation}\n        defaultAmount={form.defaultAmount}\n        lateFeeGraceDays={form.lateFeeGraceDays}\n        lateFeeMode={form.lateFeeMode}\n        lateFeeValue={form.lateFeeValue}\n        onChange={handleChange}\n      />\n\n      {error && <p className=\"rounded-lg bg-rose-100 px-4 py-2 text-sm text-rose-700\">{error}</p>}\n      <div className=\"flex justify-end gap-3\">\n        <Button disabled={submitting} onClick={onCancel} type=\"button\" variant=\"secondary\">\n          Cancelar\n        </Button>\n        <Button disabled={submitting} type=\"submit\">\n          {submitting ? submittingLabel : effectiveSubmitLabel}\n        </Button>\n      </div>\n    </form>\n  );\n}\n\nexport default ServiceForm;\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/components/ServiceForm/BasicInfoSection.tsx","messages":[{"ruleId":"check-file/folder-naming-convention","severity":2,"message":"The folder \"ServiceForm\" does not match the \"KEBAB_CASE\" pattern","line":1,"column":1,"nodeType":"Program","messageId":"noMatch","endLine":57,"endColumn":1},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":16,"column":34,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":16,"endColumn":100,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[492,513],"text":"Readonly<BasicInfoSectionProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { ChangeEvent } from \"react\";\n\nimport Input from \"@/components/ui/Input\";\nimport { GRID_2_COL_MD } from \"@/lib/styles\";\n\nimport type { ServiceFormState } from \"../ServiceForm\";\n\ninterface BasicInfoSectionProps {\n  category?: null | string;\n  detail?: null | string;\n  name: string;\n  notes?: null | string;\n  onChange: <K extends keyof ServiceFormState>(key: K, value: ServiceFormState[K]) => void;\n}\n\nexport function BasicInfoSection({ category, detail, name, notes, onChange }: BasicInfoSectionProps) {\n  return (\n    <section className={GRID_2_COL_MD}>\n      <Input\n        label=\"Nombre\"\n        onChange={(event: ChangeEvent<HTMLInputElement>) => {\n          onChange(\"name\", event.target.value);\n        }}\n        required\n        value={name}\n      />\n      <Input\n        helper=\"Ej: Servicios básicos, Marketing, Arriendo\"\n        label=\"Categoría\"\n        onChange={(event: ChangeEvent<HTMLInputElement>) => {\n          onChange(\"category\", event.target.value);\n        }}\n        value={category ?? \"\"}\n      />\n      <Input\n        as=\"textarea\"\n        helper=\"Describe qué cubre el servicio o condiciones especiales\"\n        label=\"Detalle\"\n        onChange={(event: ChangeEvent<HTMLTextAreaElement>) => {\n          onChange(\"detail\", event.target.value);\n        }}\n        rows={3}\n        value={detail ?? \"\"}\n      />\n      <Input\n        as=\"textarea\"\n        label=\"Notas\"\n        onChange={(event: ChangeEvent<HTMLTextAreaElement>) => {\n          onChange(\"notes\", event.target.value);\n        }}\n        rows={3}\n        value={notes ?? \"\"}\n      />\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/components/ServiceForm/CounterpartSection.tsx","messages":[{"ruleId":"check-file/folder-naming-convention","severity":2,"message":"The folder \"ServiceForm\" does not match the \"KEBAB_CASE\" pattern","line":1,"column":1,"nodeType":"Program","messageId":"noMatch","endLine":91,"endColumn":1},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":22,"column":36,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":33,"endColumn":27,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[950,973],"text":"Readonly<CounterpartSectionProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { ChangeEvent } from \"react\";\n\nimport Input from \"@/components/ui/Input\";\nimport { GRID_2_COL_MD } from \"@/lib/styles\";\n\nimport type { Counterpart, CounterpartAccount } from \"../../../counterparts/types\";\nimport type { ServiceFormState } from \"../ServiceForm\";\n\ninterface CounterpartSectionProps {\n  accountReference?: null | string;\n  accounts: CounterpartAccount[];\n  accountsLoading: boolean;\n  counterpartAccountId?: null | number;\n  counterpartId?: null | number;\n  counterparts: Counterpart[];\n  counterpartsError: null | string;\n  counterpartsLoading: boolean;\n  onChange: <K extends keyof ServiceFormState>(key: K, value: ServiceFormState[K]) => void;\n  onCounterpartSelect: (value: string) => void;\n}\n\nexport function CounterpartSection({\n  accountReference,\n  accounts,\n  accountsLoading,\n  counterpartAccountId,\n  counterpartId,\n  counterparts,\n  counterpartsError,\n  counterpartsLoading,\n  onChange,\n  onCounterpartSelect,\n}: CounterpartSectionProps) {\n  let accountsHelper: string | undefined;\n  if (counterpartsError) {\n    accountsHelper = \"No se pudo cargar las cuentas\";\n  } else if (counterpartsLoading) {\n    accountsHelper = \"Cargando opciones...\";\n  } else if (counterpartId && accounts.length === 0) {\n    accountsHelper = \"Esta contraparte aún no tiene cuentas agregadas\";\n  }\n\n  return (\n    <section className={GRID_2_COL_MD}>\n      <Input\n        as=\"select\"\n        disabled={counterpartsLoading}\n        helper={counterpartsError ?? (counterpartsLoading ? \"Cargando contrapartes...\" : undefined)}\n        label=\"Empresa / contraparte\"\n        onChange={(event: ChangeEvent<HTMLSelectElement>) => {\n          onCounterpartSelect(event.target.value);\n        }}\n        value={counterpartId ? String(counterpartId) : \"\"}\n      >\n        <option value=\"\">Sin contraparte</option>\n        {counterparts.map((counterpart) => (\n          <option key={counterpart.id} value={counterpart.id}>\n            {counterpart.name}\n          </option>\n        ))}\n      </Input>\n      <Input\n        as=\"select\"\n        disabled={!counterpartId || accountsLoading}\n        helper={accountsHelper}\n        label=\"Cuenta asociada\"\n        onChange={(event: ChangeEvent<HTMLSelectElement>) => {\n          onChange(\"counterpartAccountId\", event.target.value ? Number(event.target.value) : null);\n        }}\n        value={counterpartAccountId ? String(counterpartAccountId) : \"\"}\n      >\n        <option value=\"\">Sin cuenta específica</option>\n        {accounts.map((account) => (\n          <option key={account.id} value={account.id}>\n            {account.account_identifier}\n            {account.bank_name ? ` · ${account.bank_name}` : \"\"}\n          </option>\n        ))}\n      </Input>\n      <Input\n        helper=\"Usa este campo si necesitas un alias o número distinto a las cuentas registradas\"\n        label=\"Referencia de cuenta\"\n        onChange={(event: ChangeEvent<HTMLInputElement>) => {\n          onChange(\"accountReference\", event.target.value);\n        }}\n        value={accountReference ?? \"\"}\n      />\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/components/ServiceForm/EmissionSection.tsx","messages":[{"ruleId":"check-file/folder-naming-convention","severity":2,"message":"The folder \"ServiceForm\" does not match the \"KEBAB_CASE\" pattern","line":1,"column":1,"nodeType":"Program","messageId":"noMatch","endLine":96,"endColumn":1},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":23,"column":33,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":30,"endColumn":24,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[883,903],"text":"Readonly<EmissionSectionProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { ChangeEvent } from \"react\";\n\nimport Input from \"@/components/ui/Input\";\n\nimport type { ServiceEmissionMode } from \"../../types\";\nimport type { ServiceFormState } from \"../ServiceForm\";\n\ninterface EmissionSectionProps {\n  emissionDay?: null | number;\n  emissionEndDay?: null | number;\n  emissionExactDate?: null | string;\n  emissionMode?: ServiceEmissionMode;\n  emissionStartDay?: null | number;\n  onChange: <K extends keyof ServiceFormState>(key: K, value: ServiceFormState[K]) => void;\n}\n\nconst EMISSION_MODE_OPTIONS: { label: string; value: ServiceEmissionMode }[] = [\n  { label: \"Día específico\", value: \"FIXED_DAY\" },\n  { label: \"Rango de días\", value: \"DATE_RANGE\" },\n  { label: \"Fecha exacta\", value: \"SPECIFIC_DATE\" },\n];\n\nexport function EmissionSection({\n  emissionDay,\n  emissionEndDay,\n  emissionExactDate,\n  emissionMode,\n  emissionStartDay,\n  onChange,\n}: EmissionSectionProps) {\n  return (\n    <section className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n      <Input\n        as=\"select\"\n        label=\"Modo de emisión\"\n        onChange={(event: ChangeEvent<HTMLSelectElement>) => {\n          onChange(\"emissionMode\", event.target.value as ServiceEmissionMode);\n        }}\n        value={emissionMode ?? \"FIXED_DAY\"}\n      >\n        {EMISSION_MODE_OPTIONS.map((option) => (\n          <option key={option.value} value={option.value}>\n            {option.label}\n          </option>\n        ))}\n      </Input>\n      {(emissionMode ?? \"FIXED_DAY\") === \"FIXED_DAY\" && (\n        <Input\n          label=\"Día emisión\"\n          max={31}\n          min={1}\n          onChange={(event: ChangeEvent<HTMLInputElement>) => {\n            onChange(\"emissionDay\", event.target.value ? Number(event.target.value) : null);\n          }}\n          type=\"number\"\n          value={emissionDay ?? \"\"}\n        />\n      )}\n      {(emissionMode ?? \"FIXED_DAY\") === \"DATE_RANGE\" && (\n        <>\n          <Input\n            label=\"Día inicio emisión\"\n            max={31}\n            min={1}\n            onChange={(event: ChangeEvent<HTMLInputElement>) => {\n              onChange(\"emissionStartDay\", event.target.value ? Number(event.target.value) : null);\n            }}\n            type=\"number\"\n            value={emissionStartDay ?? \"\"}\n          />\n          <Input\n            label=\"Día término emisión\"\n            max={31}\n            min={1}\n            onChange={(event: ChangeEvent<HTMLInputElement>) => {\n              onChange(\"emissionEndDay\", event.target.value ? Number(event.target.value) : null);\n            }}\n            type=\"number\"\n            value={emissionEndDay ?? \"\"}\n          />\n        </>\n      )}\n      {(emissionMode ?? \"FIXED_DAY\") === \"SPECIFIC_DATE\" && (\n        <Input\n          label=\"Fecha emisión\"\n          onChange={(event: ChangeEvent<HTMLInputElement>) => {\n            onChange(\"emissionExactDate\", event.target.value || null);\n          }}\n          type=\"date\"\n          value={emissionExactDate ?? \"\"}\n        />\n      )}\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/components/ServiceForm/FinancialSection.tsx","messages":[{"ruleId":"check-file/folder-naming-convention","severity":2,"message":"The folder \"ServiceForm\" does not match the \"KEBAB_CASE\" pattern","line":1,"column":1,"nodeType":"Program","messageId":"noMatch","endLine":104,"endColumn":1},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":28,"column":34,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":35,"endColumn":25,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[985,1006],"text":"Readonly<FinancialSectionProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { ChangeEvent } from \"react\";\n\nimport Input from \"@/components/ui/Input\";\n\nimport type { ServiceAmountIndexation, ServiceLateFeeMode } from \"../../types\";\nimport type { ServiceFormState } from \"../ServiceForm\";\n\ninterface FinancialSectionProps {\n  amountIndexation?: string;\n  defaultAmount?: number;\n  lateFeeGraceDays?: null | number;\n  lateFeeMode?: ServiceLateFeeMode;\n  lateFeeValue?: null | number;\n  onChange: <K extends keyof ServiceFormState>(key: K, value: ServiceFormState[K]) => void;\n}\n\nconst INDEXATION_OPTIONS = [\n  { label: \"Monto fijo\", value: \"NONE\" },\n  { label: \"Actualiza por UF\", value: \"UF\" },\n];\n\nconst LATE_FEE_OPTIONS: { label: string; value: ServiceLateFeeMode }[] = [\n  { label: \"Sin recargo\", value: \"NONE\" },\n  { label: \"Monto fijo\", value: \"FIXED\" },\n  { label: \"% del monto\", value: \"PERCENTAGE\" },\n];\n\nexport function FinancialSection({\n  amountIndexation,\n  defaultAmount,\n  lateFeeGraceDays,\n  lateFeeMode,\n  lateFeeValue,\n  onChange,\n}: FinancialSectionProps) {\n  return (\n    <section className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n      <Input\n        label=\"Monto base\"\n        min={0}\n        onChange={(event: ChangeEvent<HTMLInputElement>) => {\n          onChange(\"defaultAmount\", Number(event.target.value));\n        }}\n        required\n        step=\"0.01\"\n        type=\"number\"\n        value={defaultAmount ?? 0}\n      />\n      <Input\n        as=\"select\"\n        label=\"Modo de monto\"\n        onChange={(event: ChangeEvent<HTMLSelectElement>) => {\n          onChange(\"amountIndexation\", event.target.value as ServiceAmountIndexation);\n        }}\n        value={amountIndexation ?? \"NONE\"}\n      >\n        {INDEXATION_OPTIONS.map((option) => (\n          <option key={option.value} value={option.value}>\n            {option.label}\n          </option>\n        ))}\n      </Input>\n      <Input\n        as=\"select\"\n        label=\"Recargo por atraso\"\n        onChange={(event: ChangeEvent<HTMLSelectElement>) => {\n          onChange(\"lateFeeMode\", event.target.value as ServiceLateFeeMode);\n        }}\n        value={lateFeeMode ?? \"NONE\"}\n      >\n        {LATE_FEE_OPTIONS.map((option) => (\n          <option key={option.value} value={option.value}>\n            {option.label}\n          </option>\n        ))}\n      </Input>\n      {(lateFeeMode ?? \"NONE\") !== \"NONE\" && (\n        <>\n          <Input\n            label={(lateFeeMode ?? \"NONE\") === \"PERCENTAGE\" ? \"% recargo\" : \"Monto recargo\"}\n            min={0}\n            onChange={(event: ChangeEvent<HTMLInputElement>) => {\n              onChange(\"lateFeeValue\", Number(event.target.value));\n            }}\n            step=\"0.01\"\n            type=\"number\"\n            value={lateFeeValue ?? \"\"}\n          />\n          <Input\n            label=\"Días de gracia\"\n            max={31}\n            min={0}\n            onChange={(event: ChangeEvent<HTMLInputElement>) => {\n              onChange(\"lateFeeGraceDays\", event.target.value ? Number(event.target.value) : null);\n            }}\n            type=\"number\"\n            value={lateFeeGraceDays ?? \"\"}\n          />\n        </>\n      )}\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/components/ServiceForm/SchedulingSection.tsx","messages":[{"ruleId":"check-file/folder-naming-convention","severity":2,"message":"The folder \"ServiceForm\" does not match the \"KEBAB_CASE\" pattern","line":1,"column":1,"nodeType":"Program","messageId":"noMatch","endLine":92,"endColumn":1},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":30,"column":35,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":37,"endColumn":26,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[1124,1146],"text":"Readonly<SchedulingSectionProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { ChangeEvent } from \"react\";\n\nimport Input from \"@/components/ui/Input\";\nimport { GRID_2_COL_MD } from \"@/lib/styles\";\n\nimport type { ServiceFrequency, ServiceRecurrenceType } from \"../../types\";\nimport type { ServiceFormState } from \"../ServiceForm\";\n\ninterface SchedulingSectionProps {\n  dueDay?: null | number;\n  effectiveMonths: number;\n  frequency?: ServiceFrequency;\n  monthsToGenerate?: number;\n  onChange: <K extends keyof ServiceFormState>(key: K, value: ServiceFormState[K]) => void;\n  recurrenceType?: ServiceRecurrenceType;\n  startDate?: string;\n}\n\nconst FREQUENCY_OPTIONS: { label: string; value: ServiceFrequency }[] = [\n  { label: \"Semanal\", value: \"WEEKLY\" },\n  { label: \"Quincenal\", value: \"BIWEEKLY\" },\n  { label: \"Mensual\", value: \"MONTHLY\" },\n  { label: \"Bimensual\", value: \"BIMONTHLY\" },\n  { label: \"Trimestral\", value: \"QUARTERLY\" },\n  { label: \"Semestral\", value: \"SEMIANNUAL\" },\n  { label: \"Anual\", value: \"ANNUAL\" },\n  { label: \"Única vez\", value: \"ONCE\" },\n];\n\nexport function SchedulingSection({\n  dueDay,\n  effectiveMonths,\n  frequency,\n  onChange,\n  recurrenceType,\n  startDate,\n}: SchedulingSectionProps) {\n  return (\n    <section className={GRID_2_COL_MD}>\n      <Input\n        as=\"select\"\n        label=\"Frecuencia\"\n        onChange={(event: ChangeEvent<HTMLSelectElement>) => {\n          onChange(\"frequency\", event.target.value as ServiceFrequency);\n        }}\n        value={frequency ?? \"MONTHLY\"}\n      >\n        {FREQUENCY_OPTIONS.map((option) => (\n          <option key={option.value} value={option.value}>\n            {option.label}\n          </option>\n        ))}\n      </Input>\n      <Input\n        label=\"Fecha de inicio\"\n        onChange={(event: ChangeEvent<HTMLInputElement>) => {\n          onChange(\"startDate\", event.target.value);\n        }}\n        required\n        type=\"date\"\n        value={startDate ?? \"\"}\n      />\n      <Input\n        disabled={recurrenceType === \"ONE_OFF\" || frequency === \"ONCE\"}\n        helper={\n          recurrenceType === \"ONE_OFF\" || frequency === \"ONCE\"\n            ? \"Para servicios puntuales se genera un único periodo\"\n            : undefined\n        }\n        label=\"Meses a generar\"\n        max={60}\n        min={1}\n        onChange={(event: ChangeEvent<HTMLInputElement>) => {\n          onChange(\"monthsToGenerate\", Number(event.target.value));\n        }}\n        type=\"number\"\n        value={effectiveMonths}\n      />\n      <Input\n        label=\"Día de vencimiento\"\n        max={31}\n        min={1}\n        onChange={(event: ChangeEvent<HTMLInputElement>) => {\n          onChange(\"dueDay\", event.target.value ? Number(event.target.value) : null);\n        }}\n        type=\"number\"\n        value={dueDay ?? \"\"}\n      />\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/components/ServiceForm/ServiceClassificationSection.tsx","messages":[{"ruleId":"check-file/folder-naming-convention","severity":2,"message":"The folder \"ServiceForm\" does not match the \"KEBAB_CASE\" pattern","line":1,"column":1,"nodeType":"Program","messageId":"noMatch","endLine":115,"endColumn":1},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":47,"column":46,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":53,"endColumn":37,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[1872,1905],"text":"Readonly<ServiceClassificationSectionProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { ChangeEvent } from \"react\";\n\nimport Input from \"@/components/ui/Input\";\nimport { GRID_2_COL_MD } from \"@/lib/styles\";\n\nimport type { ServiceObligationType, ServiceOwnership, ServiceRecurrenceType, ServiceType } from \"../../types\";\nimport type { ServiceFormState } from \"../ServiceForm\";\n\ninterface ServiceClassificationSectionProps {\n  obligationType?: ServiceObligationType;\n  onChange: <K extends keyof ServiceFormState>(key: K, value: ServiceFormState[K]) => void;\n  ownership?: ServiceOwnership;\n  recurrenceType?: ServiceRecurrenceType;\n  serviceType?: ServiceType;\n}\n\nconst SERVICE_TYPE_OPTIONS: { label: string; value: ServiceType }[] = [\n  { label: \"Operación general\", value: \"BUSINESS\" },\n  { label: \"Proveedor\", value: \"SUPPLIER\" },\n  { label: \"Servicios básicos\", value: \"UTILITY\" },\n  { label: \"Arriendo / leasing\", value: \"LEASE\" },\n  { label: \"Software / suscripciones\", value: \"SOFTWARE\" },\n  { label: \"Impuestos / contribuciones\", value: \"TAX\" },\n  { label: \"Personal\", value: \"PERSONAL\" },\n  { label: \"Otro\", value: \"OTHER\" },\n];\n\nconst OWNERSHIP_OPTIONS: { label: string; value: ServiceOwnership }[] = [\n  { label: \"Empresa\", value: \"COMPANY\" },\n  { label: \"Personal del dueño\", value: \"OWNER\" },\n  { label: \"Compartido\", value: \"MIXED\" },\n  { label: \"Terceros\", value: \"THIRD_PARTY\" },\n];\n\nconst OBLIGATION_OPTIONS: { label: string; value: ServiceObligationType }[] = [\n  { label: \"Servicio / gasto\", value: \"SERVICE\" },\n  { label: \"Deuda\", value: \"DEBT\" },\n  { label: \"Préstamo\", value: \"LOAN\" },\n  { label: \"Otro\", value: \"OTHER\" },\n];\n\nconst RECURRENCE_OPTIONS: { label: string; value: ServiceRecurrenceType }[] = [\n  { label: \"Recurrente\", value: \"RECURRING\" },\n  { label: \"Puntual\", value: \"ONE_OFF\" },\n];\n\nexport function ServiceClassificationSection({\n  obligationType,\n  onChange,\n  ownership,\n  recurrenceType,\n  serviceType,\n}: ServiceClassificationSectionProps) {\n  return (\n    <section className={GRID_2_COL_MD}>\n      <Input\n        as=\"select\"\n        label=\"Tipo\"\n        onChange={(event: ChangeEvent<HTMLSelectElement>) => {\n          onChange(\"serviceType\", event.target.value as ServiceType);\n        }}\n        value={serviceType ?? \"BUSINESS\"}\n      >\n        {SERVICE_TYPE_OPTIONS.map((option) => (\n          <option key={option.value} value={option.value}>\n            {option.label}\n          </option>\n        ))}\n      </Input>\n      <Input\n        as=\"select\"\n        label=\"Propiedad\"\n        onChange={(event: ChangeEvent<HTMLSelectElement>) => {\n          onChange(\"ownership\", event.target.value as ServiceOwnership);\n        }}\n        value={ownership ?? \"COMPANY\"}\n      >\n        {OWNERSHIP_OPTIONS.map((option) => (\n          <option key={option.value} value={option.value}>\n            {option.label}\n          </option>\n        ))}\n      </Input>\n      <Input\n        as=\"select\"\n        label=\"Naturaleza\"\n        onChange={(event: ChangeEvent<HTMLSelectElement>) => {\n          onChange(\"obligationType\", event.target.value as ServiceObligationType);\n        }}\n        value={obligationType ?? \"SERVICE\"}\n      >\n        {OBLIGATION_OPTIONS.map((option) => (\n          <option key={option.value} value={option.value}>\n            {option.label}\n          </option>\n        ))}\n      </Input>\n      <Input\n        as=\"select\"\n        label=\"Recurrencia\"\n        onChange={(event: ChangeEvent<HTMLSelectElement>) => {\n          onChange(\"recurrenceType\", event.target.value as ServiceRecurrenceType);\n        }}\n        value={recurrenceType ?? \"RECURRING\"}\n      >\n        {RECURRENCE_OPTIONS.map((option) => (\n          <option key={option.value} value={option.value}>\n            {option.label}\n          </option>\n        ))}\n      </Input>\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/components/ServiceForm/index.ts","messages":[{"ruleId":"check-file/folder-naming-convention","severity":2,"message":"The folder \"ServiceForm\" does not match the \"KEBAB_CASE\" pattern","line":1,"column":1,"nodeType":"Program","messageId":"noMatch","endLine":7,"endColumn":1}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export { BasicInfoSection } from \"./BasicInfoSection\";\nexport { CounterpartSection } from \"./CounterpartSection\";\nexport { EmissionSection } from \"./EmissionSection\";\nexport { FinancialSection } from \"./FinancialSection\";\nexport { SchedulingSection } from \"./SchedulingSection\";\nexport { ServiceClassificationSection } from \"./ServiceClassificationSection\";\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/components/ServiceList.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":16,"column":29,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":23,"endColumn":20,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[481,497],"text":"Readonly<ServiceListProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import dayjs from \"dayjs\";\n\nimport Button from \"@/components/ui/Button\";\n\nimport type { ServiceFrequency, ServiceSummary, ServiceType } from \"../types\";\n\ninterface ServiceListProps {\n  canManage: boolean;\n  loading?: boolean;\n  onCreateRequest: () => void;\n  onSelect: (publicId: string) => void;\n  selectedId: null | string;\n  services: ServiceSummary[];\n}\n\nexport function ServiceList({\n  canManage,\n  loading = false,\n  onCreateRequest,\n  onSelect,\n  selectedId,\n  services,\n}: ServiceListProps) {\n  const skeletons = Array.from({ length: 5 }, (_, index) => index);\n\n  return (\n    <aside className=\"border-base-300/60 bg-base-100/80 text-base-content flex h-full min-h-80 flex-col gap-4 rounded-2xl border p-5 text-sm shadow-inner\">\n      <header className=\"flex flex-wrap items-center justify-between gap-3\">\n        <div>\n          <h2 className=\"text-base-content/60 text-xs font-semibold tracking-wide uppercase\">Servicios</h2>\n          <p className=\"text-base-content/60 text-xs\">Suscripciones y gastos recurrentes.</p>\n        </div>\n        {canManage && (\n          <Button onClick={onCreateRequest} size=\"sm\" type=\"button\" variant=\"primary\">\n            Nuevo servicio\n          </Button>\n        )}\n      </header>\n      <div className=\"muted-scrollbar flex-1 space-y-3 overflow-y-auto pr-2\">\n        {loading &&\n          services.length === 0 &&\n          skeletons.map((value) => (\n            <div className=\"border-base-300/60 bg-base-200/60 rounded-2xl border p-4 shadow-sm\" key={value}>\n              <div className=\"skeleton-line mb-3 w-3/4\" />\n              <div className=\"text-base-content/50 flex gap-2 text-xs\">\n                <span className=\"skeleton-line w-20\" />\n                <span className=\"skeleton-line w-16\" />\n              </div>\n            </div>\n          ))}\n        {services.map((service) => {\n          const isActive = service.public_id === selectedId;\n          const overdue = service.overdue_count > 0;\n          const indicatorColor = (() => {\n            if (overdue) return \"bg-rose-400\";\n            if (service.pending_count === 0) return \"bg-emerald-400\";\n            return \"bg-amber-400\";\n          })();\n\n          const frequencyLabels: Record<ServiceFrequency, string> = {\n            ANNUAL: \"Anual\",\n            BIMONTHLY: \"Bimensual\",\n            BIWEEKLY: \"Quincenal\",\n            MONTHLY: \"Mensual\",\n            ONCE: \"Única vez\",\n            QUARTERLY: \"Trimestral\",\n            SEMIANNUAL: \"Semestral\",\n            WEEKLY: \"Semanal\",\n          };\n\n          const typeLabels: Record<ServiceType, string> = {\n            BUSINESS: \"Operación\",\n            LEASE: \"Arriendo\",\n            OTHER: \"Otro\",\n            PERSONAL: \"Personal\",\n            SOFTWARE: \"Software\",\n            SUPPLIER: \"Proveedor\",\n            TAX: \"Impuestos\",\n            UTILITY: \"Servicios básicos\",\n          };\n\n          return (\n            <button\n              className={`w-full cursor-pointer rounded-2xl border px-4 py-3 text-left transition-all ${\n                isActive\n                  ? \"border-base-300 bg-primary/20 text-primary\"\n                  : \"bg-base-100/45 text-base-content hover:border-base-300 hover:bg-base-100/65 border-transparent\"\n              }`}\n              key={service.public_id}\n              onClick={() => {\n                onSelect(service.public_id);\n              }}\n              type=\"button\"\n            >\n              <div className=\"flex items-center justify-between gap-3\">\n                <div>\n                  <p className=\"text-sm font-semibold tracking-tight\">{service.name}</p>\n                  {service.detail && (\n                    <p className=\"text-base-content/50 text-xs tracking-wide uppercase\">{service.detail}</p>\n                  )}\n                </div>\n                <span aria-hidden=\"true\" className={`h-2.5 w-2.5 rounded-full ${indicatorColor} shadow-inner`} />\n              </div>\n              <div className=\"mt-2 flex flex-wrap items-center gap-4 text-xs\">\n                <span className=\"text-base-content font-semibold\">\n                  ${service.default_amount.toLocaleString(\"es-CL\")}\n                </span>\n                <span className=\"text-base-content/60\">{frequencyLabels[service.frequency]}</span>\n                <span className=\"text-base-content/60\">{typeLabels[service.service_type]}</span>\n              </div>\n              <div className=\"text-base-content/50 mt-1 flex flex-wrap items-center gap-3 text-xs\">\n                <span>Inicio {dayjs(service.start_date).format(\"DD MMM YYYY\")}</span>\n                {service.counterpart_name && <span>{service.counterpart_name}</span>}\n              </div>\n              <div className=\"text-base-content/50 mt-2 text-xs\">\n                Pendientes {service.pending_count} · Vencidos {service.overdue_count}\n              </div>\n            </button>\n          );\n        })}\n        {services.length === 0 && (\n          <p className=\"border-base-300 bg-base-100/40 text-base-content/60 rounded-2xl border border-dashed p-4 text-xs\">\n            Aún no registras servicios recurrentes. Crea el primero para controlar gastos mensuales.\n          </p>\n        )}\n      </div>\n    </aside>\n  );\n}\n\nexport default ServiceList;\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/components/ServiceScheduleAccordion.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":43,"column":35,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":49,"endColumn":33,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[1177,1206],"text":"Readonly<ServiceScheduleAccordionProps>"},"desc":"Mark the props as read-only"}]},{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":87,"column":7,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":87,"endColumn":20,"suggestions":[{"messageId":"suggestOptionalChain","fix":{"range":[2358,2359],"text":"?"},"desc":"Consider using the optional chain operator `?.` instead. This operator includes runtime checks, so it is safer than the compile-only non-null assertion operator."}]},{"ruleId":"unicorn/no-array-reduce","severity":2,"message":"`Array#reduce()` is not allowed. Prefer other types of loop for readability.","line":95,"column":19,"nodeType":"Identifier","messageId":"reduce","endLine":95,"endColumn":25},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":113,"column":47,"nodeType":"MemberExpression","endLine":113,"endColumn":56}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import dayjs from \"dayjs\";\nimport { useEffect, useState } from \"react\";\n\nimport Button from \"@/components/ui/Button\";\nimport { today } from \"@/lib/dates\";\nimport { currencyFormatter } from \"@/lib/format\";\n\nimport type { ServiceSchedule, ServiceSummary } from \"../types\";\n\ninterface ScheduleGroup {\n  dateKey: string;\n  items: ServiceSchedule[];\n  label: string;\n}\n\ninterface ServiceScheduleAccordionProps {\n  canManage: boolean;\n  onRegisterPayment: (schedule: ServiceSchedule) => void;\n  onUnlinkPayment: (schedule: ServiceSchedule) => void;\n  schedules: ServiceSchedule[];\n  service: ServiceSummary;\n}\n\nconst dateFormatter = new Intl.DateTimeFormat(\"es-CL\", {\n  day: \"numeric\",\n  month: \"short\",\n  weekday: \"long\",\n});\n\nfunction canUnlink(schedule: ServiceSchedule) {\n  if (!schedule.transaction_id) return false;\n  if (schedule.status !== \"PAID\") return false;\n  return true;\n}\n\nexport default ServiceScheduleAccordion;\n\nfunction capitalize(value: string) {\n  if (value.length === 0) return value;\n  return value.charAt(0).toUpperCase() + value.slice(1);\n}\n\nfunction ServiceScheduleAccordion({\n  canManage,\n  onRegisterPayment,\n  onUnlinkPayment,\n  schedules,\n  service,\n}: ServiceScheduleAccordionProps) {\n  const groups = (() => {\n    if (schedules.length === 0) return [];\n\n    const sorted = [...schedules].toSorted((a, b) => dayjs(a.due_date).valueOf() - dayjs(b.due_date).valueOf());\n\n    const today = dayjs().startOf(\"day\");\n    const map = new Map<string, ScheduleGroup>();\n\n    for (const schedule of sorted) {\n      const dueDate = dayjs(schedule.due_date).startOf(\"day\");\n      const key = dueDate.format(\"YYYY-MM-DD\");\n      if (!map.has(key)) {\n        const diff = dueDate.diff(today, \"day\");\n        let label: string;\n\n        switch (diff) {\n          case -1: {\n            label = \"Ayer\";\n            break;\n          }\n          case 0: {\n            label = \"Hoy\";\n            break;\n          }\n          case 1: {\n            label = \"Mañana\";\n            break;\n          }\n          default: {\n            if (diff > 1 && diff <= 5) label = `En ${diff} días`;\n            else if (diff < -1 && diff >= -5) label = `Hace ${Math.abs(diff)} días`;\n            else label = capitalize(dateFormatter.format(dueDate.toDate()));\n          }\n        }\n\n        map.set(key, { dateKey: key, items: [], label });\n      }\n      map.get(key)!.items.push(schedule);\n    }\n\n    return [...map.values()].toSorted((a, b) => (a.dateKey > b.dateKey ? 1 : -1));\n  })();\n\n  const [expanded, setExpanded] = useState<Record<string, boolean>>(() => {\n    const todayKey = today();\n    return groups.reduce<Record<string, boolean>>((acc, group) => {\n      acc[group.dateKey] = group.dateKey === todayKey;\n      return acc;\n    }, {});\n  });\n\n  useEffect(() => {\n    const todayKey = today();\n    setExpanded((prev) => {\n      const next: Record<string, boolean> = {};\n      for (const group of groups) {\n        next[group.dateKey] = prev[group.dateKey] ?? group.dateKey === todayKey;\n      }\n      return next;\n    });\n  }, [groups]);\n\n  const toggleGroup = (key: string) => {\n    setExpanded((prev) => ({ ...prev, [key]: !prev[key] }));\n  };\n\n  if (groups.length === 0) {\n    return (\n      <section className=\"border-base-300 bg-base-200 text-base-content space-y-3 rounded-2xl border p-4 text-sm\">\n        <header className=\"flex items-center justify-between\">\n          <h2 className=\"text-base-content/60 text-sm font-semibold tracking-wide uppercase\">Agenda de vencimientos</h2>\n        </header>\n        <p className=\"text-base-content/60 text-xs\">No hay cuotas generadas para este servicio.</p>\n      </section>\n    );\n  }\n\n  return (\n    <section className=\"border-base-300 bg-base-200 text-base-content space-y-3 rounded-2xl border p-4 text-sm\">\n      <header className=\"flex items-center justify-between\">\n        <h2 className=\"text-base-content/60 text-sm font-semibold tracking-wide uppercase\">Agenda de vencimientos</h2>\n        <span className=\"text-base-content/50 text-xs\">\n          {service.pending_count + service.overdue_count} pendientes totales\n        </span>\n      </header>\n      <div className=\"muted-scrollbar max-h-80 space-y-2 overflow-y-auto pr-1\">\n        {groups.map((group) => {\n          const isExpanded = expanded[group.dateKey] ?? false;\n          return (\n            <article className=\"border-base-300 bg-base-200 rounded-xl border shadow-sm\" key={group.dateKey}>\n              <button\n                className=\"hover:bg-base-200 flex w-full items-center justify-between gap-4 px-4 py-3 text-left transition-colors\"\n                onClick={() => {\n                  toggleGroup(group.dateKey);\n                }}\n                type=\"button\"\n              >\n                <div>\n                  <p className=\"text-base-content text-sm font-semibold capitalize\">{group.label}</p>\n                  <p className=\"text-base-content/50 text-xs\">\n                    {group.items.length} {group.items.length === 1 ? \"cuota\" : \"cuotas\"}\n                  </p>\n                </div>\n                <span\n                  className={`border-base-300 bg-base-200 text-base-content/60 inline-flex h-7 w-7 items-center justify-center rounded-full border text-xs font-semibold transition-transform ${\n                    isExpanded ? \"rotate-180\" : \"\"\n                  }`}\n                >\n                  ⌃\n                </span>\n              </button>\n              <div className={isExpanded ? \"border-base-300 space-y-2 border-t px-4 py-3\" : \"hidden\"}>\n                {group.items.map((item) => {\n                  const dueDate = dayjs(item.due_date);\n                  const diffDays = dueDate.startOf(\"day\").diff(dayjs().startOf(\"day\"), \"day\");\n                  const isOverdue = item.status === \"PENDING\" && diffDays < 0;\n                  const statusClasses = {\n                    PAID: \"bg-success/20 text-success\",\n                    PARTIAL: \"bg-warning/20 text-warning\",\n                    PENDING: \"bg-warning/20 text-warning\",\n                    SKIPPED: \"bg-base-200 text-base-content/60\",\n                  } as const;\n\n                  return (\n                    <div\n                      className=\"border-base-300 bg-base-200 hover:border-primary/40 rounded-xl border p-3 shadow-inner transition\"\n                      key={item.id}\n                    >\n                      <div className=\"flex flex-wrap items-center justify-between gap-3\">\n                        <div>\n                          <p className=\"text-base-content text-sm font-semibold\">\n                            {currencyFormatter.format(item.expected_amount)}\n                          </p>\n                          <p className=\"text-base-content/50 text-xs\">\n                            Vence el {dateFormatter.format(dueDate.toDate())}\n                          </p>\n                        </div>\n                        <span\n                          className={`rounded-full px-3 py-1 text-xs font-semibold tracking-wide uppercase ${\n                            statusClasses[item.status]\n                          }`}\n                        >\n                          {item.status === \"PENDING\" && isOverdue ? \"Pendiente · Vencido\" : item.status}\n                        </span>\n                      </div>\n                      <div className=\"text-base-content/60 mt-2 flex flex-wrap items-center gap-4 text-xs\">\n                        <span>\n                          Periodo {dayjs(item.period_start).format(\"DD MMM\")} –{\" \"}\n                          {dayjs(item.period_end).format(\"DD MMM YYYY\")}\n                        </span>\n                        {item.transaction && (\n                          <span className=\"text-success\">\n                            Pago {currencyFormatter.format(item.transaction.amount ?? 0)} ·{\" \"}\n                            {dayjs(item.transaction.timestamp).format(\"DD MMM\")}\n                          </span>\n                        )}\n                      </div>\n                      {canManage && (\n                        <div className=\"mt-3 flex flex-wrap items-center gap-3\">\n                          {(item.status === \"PENDING\" || item.status === \"PARTIAL\") && (\n                            <Button\n                              onClick={() => {\n                                onRegisterPayment(item);\n                              }}\n                              size=\"sm\"\n                            >\n                              Registrar pago\n                            </Button>\n                          )}\n                          {item.transaction_id && item.status === \"PAID\" && canUnlink(item) && (\n                            <Button\n                              onClick={() => {\n                                onUnlinkPayment(item);\n                              }}\n                              size=\"sm\"\n                              variant=\"secondary\"\n                            >\n                              Desvincular pago\n                            </Button>\n                          )}\n                        </div>\n                      )}\n                    </div>\n                  );\n                })}\n              </div>\n            </article>\n          );\n        })}\n      </div>\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/components/ServiceScheduleColumns.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/components/ServiceScheduleTable.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":16,"column":38,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":21,"endColumn":29,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[521,546],"text":"Readonly<ServiceScheduleTableProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMemo } from \"react\";\n\nimport { DataTable } from \"@/components/data-table/DataTable\";\n\nimport type { ServiceSchedule } from \"../types\";\n\nimport { getColumns } from \"./ServiceScheduleColumns\";\n\ninterface ServiceScheduleTableProps {\n  canManage: boolean;\n  onRegisterPayment: (schedule: ServiceSchedule) => void;\n  onUnlinkPayment: (schedule: ServiceSchedule) => void;\n  schedules: ServiceSchedule[];\n}\n\nexport function ServiceScheduleTable({\n  canManage,\n  onRegisterPayment,\n  onUnlinkPayment,\n  schedules,\n}: ServiceScheduleTableProps) {\n  const actions = useMemo(\n    () => ({\n      onRegisterPayment,\n      onUnlinkPayment,\n    }),\n    [onRegisterPayment, onUnlinkPayment]\n  );\n\n  const columns = useMemo(() => getColumns(actions, canManage), [actions, canManage]);\n\n  return (\n    <div className=\"bg-base-100 overflow-hidden\">\n      <DataTable\n        columns={columns}\n        data={schedules}\n        enableToolbar={false} // Small sub-table usually doesn't need search/filter toolbar\n        pagination={{ pageIndex: 0, pageSize: 100 }} // Show all rows by default for schedules\n      />\n    </div>\n  );\n}\n\nexport default ServiceScheduleTable;\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/components/ServiceTemplateGallery.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":20,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":20,"endColumn":50},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":100,"column":48,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":100,"endColumn":88,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[2600,2627],"text":"Readonly<ServiceTemplateGalleryProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Button from \"@/components/ui/Button\";\nimport { today } from \"@/lib/dates\";\n\nimport type { CreateServicePayload } from \"../types\";\n\nexport interface ServiceTemplate {\n  category?: string;\n  description: string;\n  id: string;\n  name: string;\n  payload: Partial<CreateServicePayload>;\n}\n\ninterface ServiceTemplateGalleryProps {\n  onApply: (template: ServiceTemplate) => void;\n}\n\nconst TODAY = today();\n\nexport const SERVICE_TEMPLATES: ServiceTemplate[] = [\n  {\n    category: \"Utilidades\",\n    description: \"Ideal para cuentas de luz, agua, internet y telefonía\",\n    id: \"utilities\",\n    name: \"Servicios básicos\",\n    payload: {\n      defaultAmount: 0,\n      dueDay: 15,\n      emissionDay: 1,\n      emissionMode: \"FIXED_DAY\",\n      frequency: \"MONTHLY\",\n      monthsToGenerate: 12,\n      obligationType: \"SERVICE\",\n      ownership: \"COMPANY\",\n      serviceType: \"UTILITY\",\n      startDate: TODAY,\n    },\n  },\n  {\n    category: \"Software\",\n    description: \"Suscripciones mensuales de software o herramientas en la nube\",\n    id: \"software_subscription\",\n    name: \"Suscripción SaaS\",\n    payload: {\n      defaultAmount: 0,\n      dueDay: null,\n      emissionExactDate: TODAY,\n      emissionMode: \"SPECIFIC_DATE\",\n      frequency: \"MONTHLY\",\n      monthsToGenerate: 12,\n      notes: \"Renovación automática; revisar vencimiento de tarjeta asociada\",\n      obligationType: \"SERVICE\",\n      ownership: \"COMPANY\",\n      serviceType: \"SOFTWARE\",\n      startDate: TODAY,\n    },\n  },\n  {\n    category: \"Financiamiento\",\n    description: \"Cuotas fijas para préstamos bancarios o renegociaciones\",\n    id: \"loan_quota\",\n    name: \"Cuota de préstamo\",\n    payload: {\n      defaultAmount: 0,\n      dueDay: 10,\n      emissionDay: 5,\n      emissionMode: \"FIXED_DAY\",\n      frequency: \"MONTHLY\",\n      lateFeeGraceDays: 3,\n      lateFeeMode: \"FIXED\",\n      lateFeeValue: 10_000,\n      monthsToGenerate: 24,\n      obligationType: \"DEBT\",\n      ownership: \"COMPANY\",\n      serviceType: \"OTHER\",\n      startDate: TODAY,\n    },\n  },\n  {\n    category: \"Personal\",\n    description: \"Remuneraciones mensuales para colaboradores\",\n    id: \"employee_salary\",\n    name: \"Pago de sueldo\",\n    payload: {\n      defaultAmount: 0,\n      dueDay: null,\n      emissionDay: 25,\n      emissionMode: \"FIXED_DAY\",\n      frequency: \"MONTHLY\",\n      monthsToGenerate: 12,\n      notes: \"Considerar descuentos de AFP/Salud cuando corresponda\",\n      obligationType: \"SERVICE\",\n      ownership: \"COMPANY\",\n      serviceType: \"PERSONAL\",\n      startDate: TODAY,\n    },\n  },\n];\n\nexport default function ServiceTemplateGallery({ onApply }: ServiceTemplateGalleryProps) {\n  return (\n    <section className=\"border-base-300 text-base-content bg-base-100 space-y-4 border p-4 text-sm\">\n      <div className=\"flex flex-col gap-1\">\n        <h2 className=\"text-base-content/60 text-sm font-semibold tracking-wide uppercase\">Plantillas rápidas</h2>\n        <p className=\"text-base-content/50 text-xs\">\n          Usa plantillas predefinidas para acelerar la creación de servicios.\n        </p>\n      </div>\n      <div className=\"grid gap-3 md:grid-cols-2 xl:grid-cols-4\">\n        {SERVICE_TEMPLATES.map((template) => (\n          <article\n            className=\"border-base-300 bg-base-200 hover:border-primary/45 flex h-full flex-col justify-between rounded-2xl border p-4 shadow-sm transition hover:shadow-md\"\n            key={template.id}\n          >\n            <div className=\"space-y-2\">\n              <p className=\"text-base-content text-sm font-semibold\">{template.name}</p>\n              <p className=\"text-base-content/60 text-xs\">{template.description}</p>\n              {template.category && (\n                <span className=\"border-base-300 bg-base-200 text-base-content/60 inline-flex items-center rounded-full border px-2 py-1 text-xs font-semibold tracking-wide uppercase\">\n                  {template.category}\n                </span>\n              )}\n            </div>\n            <Button\n              onClick={() => {\n                onApply(template);\n              }}\n              size=\"sm\"\n            >\n              Usar plantilla\n            </Button>\n          </article>\n        ))}\n      </div>\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/components/ServicesAgendaContent.tsx","messages":[{"ruleId":"unicorn/no-array-reduce","severity":2,"message":"`Array#reduce()` is not allowed. Prefer other types of loop for readability.","line":22,"column":37,"nodeType":"Identifier","messageId":"reduce","endLine":22,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Link } from \"@tanstack/react-router\";\nimport dayjs from \"dayjs\";\n\nimport Button from \"@/components/ui/Button\";\nimport { StatCard } from \"@/components/ui/StatCard\";\nimport { ServicesHero, ServicesSurface } from \"@/features/services/components/ServicesShell\";\nimport ServicesUnifiedAgenda from \"@/features/services/components/ServicesUnifiedAgenda\";\nimport { useServicesOverview } from \"@/features/services/hooks/use-services-overview\";\nimport { currencyFormatter } from \"@/lib/format\";\nimport { LOADING_SPINNER_MD } from \"@/lib/styles\";\n\nexport default function ServicesAgendaContent() {\n  const {\n    aggregatedError,\n    aggregatedLoading,\n    canManage,\n    handleAgendaRegisterPayment,\n    handleAgendaUnlinkPayment,\n    unifiedAgendaItems,\n  } = useServicesOverview();\n\n  const totals = unifiedAgendaItems.reduce(\n    (acc, item) => {\n      const dueDate = dayjs(item.schedule.due_date);\n      if (dueDate.isSame(dayjs(), \"day\")) acc.day += item.schedule.expected_amount;\n      if (dueDate.isSame(dayjs(), \"week\")) acc.week += item.schedule.expected_amount;\n      if (dueDate.isSame(dayjs(), \"month\")) acc.month += item.schedule.expected_amount;\n      return acc;\n    },\n    { day: 0, month: 0, week: 0 }\n  );\n\n  if (aggregatedLoading && unifiedAgendaItems.length === 0) {\n    return (\n      <section className=\"space-y-8\">\n        <ServicesHero\n          actions={\n            <Link to=\"/services\">\n              <Button variant=\"ghost\">Volver al panel</Button>\n            </Link>\n          }\n          breadcrumbs={[{ label: \"Servicios\", to: \"/services\" }, { label: \"Agenda\" }]}\n          description=\"Visualiza los pagos programados, sus estados y registra conciliaciones rápidamente.\"\n          title=\"Agenda de servicios\"\n        />\n\n        <ServicesSurface className=\"flex min-h-64 items-center justify-center\">\n          <div className=\"text-base-content/70 flex items-center gap-3 text-sm\">\n            <span aria-hidden=\"true\" className={LOADING_SPINNER_MD} />\n            <span>Cargando agenda consolidada...</span>\n          </div>\n        </ServicesSurface>\n      </section>\n    );\n  }\n\n  return (\n    <section className=\"space-y-8\">\n      <ServicesHero\n        actions={\n          <Link to=\"/services\">\n            <Button variant=\"ghost\">Volver al panel</Button>\n          </Link>\n        }\n        breadcrumbs={[{ label: \"Servicios\", to: \"/services\" }, { label: \"Agenda\" }]}\n        description=\"Visualiza los pagos programados, sus estados y registra conciliaciones rápidamente.\"\n        title=\"Agenda de servicios\"\n      />\n\n      <ServicesSurface>\n        <div className=\"grid gap-4 sm:grid-cols-3\">\n          <StatCard title=\"Pagos hoy\" value={currencyFormatter.format(totals.day)} />\n          <StatCard title=\"Semana en curso\" value={currencyFormatter.format(totals.week)} />\n          <StatCard title=\"Mes en curso\" value={currencyFormatter.format(totals.month)} />\n        </div>\n\n        <ServicesUnifiedAgenda\n          canManage={canManage}\n          error={aggregatedError}\n          items={unifiedAgendaItems}\n          loading={aggregatedLoading}\n          onRegisterPayment={handleAgendaRegisterPayment}\n          onUnlinkPayment={handleAgendaUnlinkPayment}\n        />\n      </ServicesSurface>\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/components/ServicesCreateContent.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/components/ServicesFilterPanel.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":28,"column":45,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":28,"endColumn":102,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[783,807],"text":"Readonly<ServicesFilterPanelProps>"},"desc":"Mark the props as read-only"}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":113,"column":18,"nodeType":"MemberExpression","endLine":113,"endColumn":39}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { type ChangeEvent } from \"react\";\n\nimport Button from \"@/components/ui/Button\";\nimport Input from \"@/components/ui/Input\";\n\nimport type { ServiceSummary, ServiceType } from \"../types\";\n\nexport interface ServicesFilterState {\n  search: string;\n  statuses: Set<ServiceSummary[\"status\"]>;\n  types: Set<ServiceType>;\n}\n\ninterface ServicesFilterPanelProps {\n  filters: ServicesFilterState;\n  onChange: (next: ServicesFilterState) => void;\n  services: ServiceSummary[];\n}\n\nconst STATUS_LABELS: Record<ServiceSummary[\"status\"], string> = {\n  ACTIVE: \"Activo\",\n  ARCHIVED: \"Archivado\",\n  INACTIVE: \"Sin pendientes\",\n};\n\nconst STATUS_ORDER: ServiceSummary[\"status\"][] = [\"ACTIVE\", \"INACTIVE\", \"ARCHIVED\"];\n\nexport default function ServicesFilterPanel({ filters, onChange, services }: ServicesFilterPanelProps) {\n  const typeOptions = (() => {\n    const counts = new Map<ServiceType, number>();\n    for (const service of services) {\n      counts.set(service.service_type, (counts.get(service.service_type) ?? 0) + 1);\n    }\n    return [...counts.entries()].toSorted((a, b) => b[1] - a[1]);\n  })();\n\n  const handleStatusToggle = (status: ServiceSummary[\"status\"]) => {\n    const next = new Set(filters.statuses);\n    if (next.has(status)) {\n      next.delete(status);\n    } else {\n      next.add(status);\n    }\n    onChange({ ...filters, statuses: next });\n  };\n\n  const handleTypeToggle = (type: ServiceType) => {\n    const next = new Set(filters.types);\n    if (next.has(type)) {\n      next.delete(type);\n    } else {\n      next.add(type);\n    }\n    onChange({ ...filters, types: next });\n  };\n\n  const handleSearchChange = (value: string) => {\n    onChange({ ...filters, search: value });\n  };\n\n  const resetFilters = () => {\n    onChange({ search: \"\", statuses: new Set(), types: new Set() });\n  };\n\n  return (\n    <section className=\"border-base-300 text-base-content bg-base-100 flex flex-col gap-4 border p-4 text-sm\">\n      <div className=\"flex flex-wrap items-center justify-between gap-3\">\n        <div>\n          <p className=\"text-base-content text-sm font-semibold\">Filtros rápidos</p>\n          <p className=\"text-base-content/50 text-xs\">Filtra por estado, tipo o busca por nombre/detalle.</p>\n        </div>\n        <Button\n          className=\"text-primary text-xs font-semibold tracking-wide uppercase hover:underline\"\n          onClick={resetFilters}\n          size=\"sm\"\n          type=\"button\"\n          variant=\"secondary\"\n        >\n          Limpiar filtros\n        </Button>\n      </div>\n\n      <div className=\"grid gap-4 md:grid-cols-3\">\n        <div className=\"md:col-span-1\">\n          <Input\n            label=\"Buscar\"\n            onChange={(event: ChangeEvent<HTMLInputElement>) => {\n              handleSearchChange(event.target.value);\n            }}\n            placeholder=\"Nombre, detalle, contraparte...\"\n            value={filters.search}\n          />\n        </div>\n\n        <div>\n          <p className=\"text-base-content/60 text-xs font-semibold tracking-wide uppercase\">Estado</p>\n          <div className=\"mt-2 flex flex-wrap gap-2\">\n            {STATUS_ORDER.map((status) => (\n              <Button\n                className={`rounded-full border px-3 py-1 text-xs font-semibold transition-all ${\n                  filters.statuses.size === 0 || filters.statuses.has(status)\n                    ? \"border-primary/40 bg-primary/10 text-primary\"\n                    : \"border-base-300 bg-base-200 text-base-content/60 hover:border-primary/35 hover:text-primary\"\n                }`}\n                key={status}\n                onClick={() => {\n                  handleStatusToggle(status);\n                }}\n                size=\"sm\"\n                type=\"button\"\n                variant=\"secondary\"\n              >\n                {STATUS_LABELS[status]}\n              </Button>\n            ))}\n          </div>\n        </div>\n\n        <div>\n          <p className=\"text-base-content/60 text-xs font-semibold tracking-wide uppercase\">Tipo de servicio</p>\n          <div className=\"mt-2 flex flex-wrap gap-2\">\n            {typeOptions.map(([type, count]) => {\n              const isActive = filters.types.size === 0 || filters.types.has(type);\n              return (\n                <Button\n                  className={`rounded-full border px-3 py-1 text-xs font-semibold transition-all ${\n                    isActive\n                      ? \"border-secondary/40 bg-secondary/10 text-secondary\"\n                      : \"border-base-300 bg-base-200 text-base-content/60 hover:border-secondary/35 hover:text-secondary\"\n                  }`}\n                  key={type}\n                  onClick={() => {\n                    handleTypeToggle(type);\n                  }}\n                  size=\"sm\"\n                  type=\"button\"\n                  variant=\"secondary\"\n                >\n                  {type.toLowerCase()} ({count})\n                </Button>\n              );\n            })}\n          </div>\n        </div>\n      </div>\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/components/ServicesOverviewContent.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/components/ServicesShell.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":16,"column":30,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":16,"endColumn":67,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[315,338],"text":"Readonly<{ children: ReactNode }>"},"desc":"Mark the props as read-only"}]},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":22,"column":30,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":22,"endColumn":93,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[554,571],"text":"Readonly<ServicesHeroProps>"},"desc":"Mark the props as read-only"}]},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":55,"column":33,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":55,"endColumn":106,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[1973,2016],"text":"Readonly<{ children: ReactNode; className?: string }>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Link } from \"@tanstack/react-router\";\nimport type { ReactNode } from \"react\";\n\ninterface Breadcrumb {\n  label: string;\n  to?: string;\n}\n\ninterface ServicesHeroProps {\n  actions?: ReactNode;\n  breadcrumbs?: Breadcrumb[];\n  description: string;\n  title: string;\n}\n\nexport function ServicesGrid({ children }: { children: ReactNode }) {\n  return (\n    <div className=\"grid min-h-0 items-start gap-6 xl:grid-cols-[minmax(0,0.95fr)_minmax(0,1.05fr)]\">{children}</div>\n  );\n}\n\nexport function ServicesHero({ actions, breadcrumbs, description, title }: ServicesHeroProps) {\n  return (\n    <header className=\"surface-elevated flex flex-col gap-4 rounded-[28px] p-6 shadow-xl lg:flex-row lg:items-center lg:justify-between\">\n      <div className=\"space-y-3\">\n        {breadcrumbs && breadcrumbs.length > 0 && (\n          <nav\n            aria-label=\"Ruta de navegación\"\n            className=\"text-base-content/60 flex flex-wrap items-center gap-1 text-xs\"\n          >\n            {breadcrumbs.map((crumb, index) => (\n              <span className=\"flex items-center gap-1\" key={crumb.label}>\n                {crumb.to ? (\n                  <Link className=\"text-primary font-semibold\" to={crumb.to}>\n                    {crumb.label}\n                  </Link>\n                ) : (\n                  <span className=\"text-base-content/80 font-semibold\">{crumb.label}</span>\n                )}\n                {index < breadcrumbs.length - 1 && <span className=\"text-base-content/40\">/</span>}\n              </span>\n            ))}\n          </nav>\n        )}\n        <div className=\"space-y-1.5\">\n          <h1 className=\"text-base-content text-2xl font-semibold drop-shadow-sm lg:text-3xl\">{title}</h1>\n          <p className=\"text-base-content/70 text-sm\">{description}</p>\n        </div>\n      </div>\n      {actions && <div className=\"flex flex-wrap justify-end gap-2\">{actions}</div>}\n    </header>\n  );\n}\n\nexport function ServicesSurface({ children, className = \"\" }: { children: ReactNode; className?: string }) {\n  return (\n    <section className={`surface-recessed rounded-[28px] p-6 shadow-inner ${className}`}>\n      <div className=\"space-y-6\">{children}</div>\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/components/ServicesTemplatesContent.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/components/ServicesUnifiedAgenda.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":51,"column":47,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":58,"endColumn":30,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[1711,1737],"text":"Readonly<ServicesUnifiedAgendaProps>"},"desc":"Mark the props as read-only"}]},{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":74,"column":21,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":74,"endColumn":34},{"ruleId":"unicorn/no-array-reduce","severity":2,"message":"`Array#reduce()` is not allowed. Prefer other types of loop for readability.","line":107,"column":19,"nodeType":"Identifier","messageId":"reduce","endLine":107,"endColumn":25},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":114,"column":47,"nodeType":"MemberExpression","endLine":114,"endColumn":56}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import dayjs from \"dayjs\";\nimport { useState } from \"react\";\n\nimport Button from \"@/components/ui/Button\";\nimport { today } from \"@/lib/dates\";\nimport { currencyFormatter } from \"@/lib/format\";\nimport { LOADING_SPINNER_XS } from \"@/lib/styles\";\n\nimport type { ServiceSchedule, ServiceSummary } from \"../types\";\n\ninterface AgendaGroup {\n  dateKey: string;\n  entries: { schedule: ServiceSchedule; service: ServiceSummary }[];\n  label: string;\n  total: number;\n}\n\ninterface ServicesUnifiedAgendaProps {\n  canManage: boolean;\n  error?: null | string;\n  items: { schedule: ServiceSchedule; service: ServiceSummary }[];\n  loading?: boolean;\n  onRegisterPayment: (serviceId: string, schedule: ServiceSchedule) => void;\n  onUnlinkPayment: (serviceId: string, schedule: ServiceSchedule) => void;\n}\n\nconst dateFormatter = new Intl.DateTimeFormat(\"es-CL\", {\n  day: \"numeric\",\n  month: \"short\",\n  weekday: \"long\",\n});\n\nfunction computeLabel(dueDate: dayjs.Dayjs) {\n  const today = dayjs().startOf(\"day\");\n  const diff = dueDate.startOf(\"day\").diff(today, \"day\");\n  if (diff === 0) return \"Hoy\";\n  if (diff === 1) return \"Mañana\";\n  if (diff === -1) return \"Ayer\";\n  if (diff > 1 && diff <= 7) return `En ${diff} días`;\n  if (diff < -1 && diff >= -7) return `Hace ${Math.abs(diff)} días`;\n  return capitalize(dateFormatter.format(dueDate.toDate()));\n}\n\nconst statusClasses: Record<ServiceSchedule[\"status\"], string> = {\n  PAID: \"bg-success/20 text-success\",\n  PARTIAL: \"bg-warning/20 text-warning\",\n  PENDING: \"bg-warning/20 text-warning\",\n  SKIPPED: \"bg-base-200 text-base-content/60\",\n};\n\nexport default function ServicesUnifiedAgenda({\n  canManage,\n  error,\n  items,\n  loading,\n  onRegisterPayment,\n  onUnlinkPayment,\n}: ServicesUnifiedAgendaProps) {\n  const skeletons = Array.from({ length: 4 }, (_, index) => index);\n  const groups = (() => {\n    if (items.length === 0) return [];\n    const map = new Map<string, AgendaGroup>();\n    for (const { schedule, service } of items) {\n      const dueDate = dayjs(schedule.due_date).startOf(\"day\");\n      const key = dueDate.format(\"YYYY-MM-DD\");\n      if (!map.has(key)) {\n        map.set(key, {\n          dateKey: key,\n          entries: [],\n          label: computeLabel(dueDate),\n          total: 0,\n        });\n      }\n      const group = map.get(key)!;\n      group.total += schedule.expected_amount;\n      group.entries.push({ schedule, service });\n    }\n    return [...map.values()].toSorted((a, b) => (a.dateKey > b.dateKey ? 1 : -1));\n  })();\n\n  const totals = (() => {\n    const today = dayjs().startOf(\"day\");\n    let daySum = 0;\n    let weekSum = 0;\n    let monthSum = 0;\n    for (const { schedule } of items) {\n      const dueDate = dayjs(schedule.due_date).startOf(\"day\");\n      if (dueDate.isSame(today, \"day\")) {\n        daySum += schedule.expected_amount;\n      }\n      if (dueDate.isSame(today, \"week\")) {\n        weekSum += schedule.expected_amount;\n      }\n      if (dueDate.isSame(today, \"month\")) {\n        monthSum += schedule.expected_amount;\n      }\n    }\n    return {\n      day: daySum,\n      month: monthSum,\n      week: weekSum,\n    };\n  })();\n\n  const [expanded, setExpanded] = useState<Record<string, boolean>>(() => {\n    const todayKey = today();\n    return groups.reduce<Record<string, boolean>>((acc, group) => {\n      acc[group.dateKey] = group.dateKey === todayKey;\n      return acc;\n    }, {});\n  });\n\n  const toggle = (key: string) => {\n    setExpanded((prev) => ({ ...prev, [key]: !prev[key] }));\n  };\n\n  return (\n    <section className=\"space-y-4\">\n      <header className=\"surface-muted text-base-content/70 grid gap-4 p-4 text-sm sm:grid-cols-3\">\n        <div>\n          <p className=\"text-base-content/50 text-xs tracking-wide uppercase\">Pagos hoy</p>\n          <p className=\"text-base-content text-xl font-semibold\">{currencyFormatter.format(totals.day)}</p>\n        </div>\n        <div>\n          <p className=\"text-base-content/50 text-xs tracking-wide uppercase\">Semana en curso</p>\n          <p className=\"text-base-content text-xl font-semibold\">{currencyFormatter.format(totals.week)}</p>\n        </div>\n        <div>\n          <p className=\"text-base-content/50 text-xs tracking-wide uppercase\">Mes en curso</p>\n          <p className=\"text-base-content text-xl font-semibold\">{currencyFormatter.format(totals.month)}</p>\n        </div>\n      </header>\n\n      <div className=\"surface-recessed text-base-content/70 space-y-3 p-4 text-sm\">\n        <div className=\"flex flex-wrap items-center justify-between gap-2\">\n          <div>\n            <h2 className=\"text-base-content/50 text-sm font-semibold tracking-wide uppercase\">Agenda unificada</h2>\n            <p className=\"text-base-content/40 text-xs\">\n              Visualiza todos los pagos programados por fecha de vencimiento.\n            </p>\n          </div>\n          {loading && (\n            <div className=\"text-base-content/40 flex items-center gap-2 text-xs\">\n              <span aria-hidden=\"true\" className={LOADING_SPINNER_XS} />\n              <span>Actualizando agenda…</span>\n            </div>\n          )}\n        </div>\n        {error && <p className=\"text-error text-xs\">{error}</p>}\n        {groups.length === 0 && !loading && !error && (\n          <p className=\"text-base-content/40 text-xs\">No hay cuotas programadas en el periodo consultado.</p>\n        )}\n        {loading && groups.length === 0 && (\n          <div className=\"space-y-2\">\n            {skeletons.map((value) => (\n              <div className=\"border-base-300/60 bg-base-200/60 rounded-2xl border p-4 shadow-inner\" key={value}>\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"skeleton-line w-24\" />\n                  <span className=\"skeleton-line w-16\" />\n                </div>\n                <div className=\"mt-3 space-y-2\">\n                  <span className=\"skeleton-line block w-full\" />\n                  <span className=\"skeleton-line block w-4/5\" />\n                </div>\n              </div>\n            ))}\n          </div>\n        )}\n        <div className=\"muted-scrollbar max-h-128 space-y-2 overflow-y-auto pr-1\">\n          {groups.map((group) => {\n            const isExpanded = expanded[group.dateKey] ?? false;\n            return (\n              <article className=\"surface-muted hover:border-primary/35 transition hover:shadow-lg\" key={group.dateKey}>\n                <Button\n                  className=\"flex w-full items-center justify-between gap-4 px-4 py-3 text-left\"\n                  onClick={() => {\n                    toggle(group.dateKey);\n                  }}\n                  type=\"button\"\n                  variant=\"secondary\"\n                >\n                  <div>\n                    <p className=\"text-base-content text-sm font-semibold capitalize\">{group.label}</p>\n                    <p className=\"text-base-content/40 text-xs\">\n                      {group.entries.length} {group.entries.length === 1 ? \"servicio\" : \"servicios\"}\n                    </p>\n                  </div>\n                  <div className=\"flex items-center gap-3\">\n                    <span className=\"text-base-content text-sm font-semibold\">\n                      {currencyFormatter.format(group.total)}\n                    </span>\n                    <span\n                      className={`border-base-300 bg-base-100/70 text-base-content/50 inline-flex h-7 w-7 items-center justify-center rounded-full border text-xs font-semibold transition-transform ${\n                        isExpanded ? \"rotate-180\" : \"\"\n                      }`}\n                    >\n                      ⌃\n                    </span>\n                  </div>\n                </Button>\n                {isExpanded && (\n                  <div className=\"border-base-300/70 space-y-2 border-t px-4 py-3\">\n                    {group.entries.map(({ schedule, service }) => {\n                      const dueDate = dayjs(schedule.due_date);\n                      const diffDays = dueDate.startOf(\"day\").diff(dayjs().startOf(\"day\"), \"day\");\n                      const isOverdue = schedule.status === \"PENDING\" && diffDays < 0;\n                      return (\n                        <div\n                          className=\"surface-recessed hover:border-primary/40 p-3 transition\"\n                          key={`${service.public_id}-${schedule.id}`}\n                        >\n                          <div className=\"flex flex-wrap items-center justify-between gap-3\">\n                            <div>\n                              <p className=\"text-base-content text-sm font-semibold\">{service.name}</p>\n                              {service.detail && <p className=\"text-base-content/40 text-xs\">{service.detail}</p>}\n                              <p className=\"text-base-content/40 mt-1 text-xs\">\n                                {currencyFormatter.format(schedule.expected_amount)} · Vence el{\" \"}\n                                {dateFormatter.format(dueDate.toDate())}\n                              </p>\n                            </div>\n                            <span\n                              className={`rounded-full px-3 py-1 text-xs font-semibold tracking-wide uppercase ${\n                                statusClasses[schedule.status]\n                              }`}\n                            >\n                              {schedule.status === \"PENDING\" && isOverdue ? \"Pendiente · Vencido\" : schedule.status}\n                            </span>\n                          </div>\n                          {canManage && (\n                            <div className=\"mt-3 flex flex-wrap items-center gap-3\">\n                              {(schedule.status === \"PENDING\" || schedule.status === \"PARTIAL\") && (\n                                <Button\n                                  onClick={() => {\n                                    onRegisterPayment(service.public_id, schedule);\n                                  }}\n                                  size=\"sm\"\n                                >\n                                  Registrar pago\n                                </Button>\n                              )}\n                              {schedule.transaction_id && schedule.status === \"PAID\" && (\n                                <Button\n                                  onClick={() => {\n                                    onUnlinkPayment(service.public_id, schedule);\n                                  }}\n                                  size=\"sm\"\n                                  variant=\"secondary\"\n                                >\n                                  Desvincular pago\n                                </Button>\n                              )}\n                            </div>\n                          )}\n                        </div>\n                      );\n                    })}\n                  </div>\n                )}\n              </article>\n            );\n          })}\n        </div>\n      </div>\n    </section>\n  );\n}\n\nfunction capitalize(value: string) {\n  if (value.length === 0) return value;\n  return value.charAt(0).toUpperCase() + value.slice(1);\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/hooks/use-service-details.ts","messages":[{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":38,"column":29,"nodeType":"MemberExpression","endLine":38,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":40,"column":57,"nodeType":"Property","messageId":"anyAssignment","endLine":40,"endColumn":77},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":53,"column":32,"nodeType":"MemberExpression","endLine":53,"endColumn":54},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":53,"column":57,"nodeType":"MemberExpression","endLine":53,"endColumn":79},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":79,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3082,3085],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3082,3085],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":80,"column":46,"nodeType":"Property","messageId":"anyAssignment","endLine":80,"endColumn":65}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useSuspenseQuery } from \"@tanstack/react-query\";\nimport { useStore } from \"@tanstack/react-store\";\nimport { useEffect } from \"react\";\n\nimport { useAuth } from \"@/context/AuthContext\";\nimport { logger } from \"@/lib/logger\";\n\nimport type { ServiceDetailResponse, ServiceListResponse } from \"../types\";\n\nimport { fetchServiceDetail } from \"../api\";\nimport { serviceKeys } from \"../queries\";\nimport { servicesActions, servicesStore } from \"../store\";\n\nexport function useServiceDetails(services: ServiceListResponse[\"services\"]) {\n  const { can } = useAuth();\n  const canView = can(\"read\", \"Service\");\n\n  // Store\n  const selectedId = useStore(servicesStore, (state) => state.selectedId);\n  const selectedTemplate = useStore(servicesStore, (state) => state.selectedTemplate);\n  const createOpen = useStore(servicesStore, (state) => state.createOpen);\n\n  const serviceIds = services.map((s) => s.public_id).join(\",\");\n\n  // Fetch All Details (Aggregated)\n  const { data: allDetails } = useSuspenseQuery({\n    queryFn: async () => {\n      if (services.length === 0 || !canView) return {};\n      const results = await Promise.allSettled(services.map((service) => fetchServiceDetail(service.public_id)));\n\n      const detailsMap: Record<string, ServiceDetailResponse> = {};\n      const failures: { id: string; reason: unknown }[] = [];\n\n      for (const [index, result] of results.entries()) {\n        if (result.status === \"fulfilled\") {\n          detailsMap[result.value.service.public_id] = result.value;\n        } else {\n          const serviceId = services[index]?.public_id ?? \"unknown\";\n          failures.push({ id: serviceId, reason: result.reason });\n          logger.error(\"[services] aggregated:error\", { error: result.reason, serviceId });\n        }\n      }\n\n      if (failures.length > 0) {\n        console.warn(`Failed to load details for ${failures.length} services`);\n      }\n      return detailsMap;\n    },\n    queryKey: [...serviceKeys.detailsAggregated(serviceIds), services.length, canView],\n    staleTime: 5 * 60 * 1000,\n  });\n\n  const detail = selectedId && allDetails[selectedId] ? allDetails[selectedId] : null;\n\n  // Sync selectedId (if needed, though store usually drives this)\n  useEffect(() => {\n    // Legacy behavior synced ref here, but component should be reactive to store\n  }, [selectedId]);\n\n  const unifiedAgendaItems = Object.values(allDetails).flatMap((item) =>\n    item.schedules.map((schedule) => ({ schedule, service: item.service }))\n  );\n\n  return {\n    aggregatedError: null, // Errors are handled by Suspense boundary or internally logged\n    aggregatedLoading: false, // Suspense guarantees data is ready\n    allDetails,\n    applyTemplate: servicesActions.openCreateModal,\n    closeCreateModal: servicesActions.closeCreateModal,\n    createOpen,\n\n    openCreateModal: servicesActions.openCreateModal,\n    schedules: detail?.schedules ?? [],\n    // Selection / Modal State\n    selectedId,\n    selectedService: detail?.service ?? null,\n    selectedTemplate,\n    setSelectedId: servicesActions.setSelectedId,\n    setSelectedTemplate: (t: any) => {\n      servicesStore.setState((s) => ({ ...s, selectedTemplate: t }));\n    },\n    unifiedAgendaItems,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/hooks/use-service-mutations.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/hooks/use-service-payment.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/hooks/use-services-list.ts","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":21,"column":20,"nodeType":"ChainExpression","messageId":"neverNullish","endLine":21,"endColumn":34},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":21,"column":24,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":21,"endColumn":26,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[655,657],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":31,"column":12,"nodeType":"MemberExpression","messageId":"neverNullish","endLine":31,"endColumn":24},{"ruleId":"unicorn/no-array-reduce","severity":2,"message":"`Array#reduce()` is not allowed. Prefer other types of loop for readability.","line":43,"column":29,"nodeType":"Identifier","messageId":"reduce","endLine":43,"endColumn":35}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useSuspenseQuery } from \"@tanstack/react-query\";\nimport { useStore } from \"@tanstack/react-store\";\n\nimport { useAuth } from \"@/context/AuthContext\";\n\nimport type { SummaryTotals } from \"../types\";\n\nimport { extractErrorMessage } from \"../api\";\nimport { serviceQueries } from \"../queries\";\nimport { servicesActions, servicesStore } from \"../store\";\n\nexport function useServicesList() {\n  const { can } = useAuth();\n  const canView = can(\"read\", \"Service\");\n\n  // Store\n  const filters = useStore(servicesStore, (state) => state.filters);\n\n  // Fetch\n  const { data, error } = useSuspenseQuery(serviceQueries.list(canView));\n  const services = data?.services ?? [];\n\n  // Filter Logic\n  const filteredServices = (() => {\n    const searchTerm = filters.search.trim().toLowerCase();\n    return services.filter((service) => {\n      const matchesStatus = filters.statuses.size === 0 || filters.statuses.has(service.status);\n      const matchesType = filters.types.size === 0 || filters.types.has(service.service_type);\n      const matchesSearch =\n        !searchTerm ||\n        `${service.name ?? \"\"} ${service.detail ?? \"\"} ${service.counterpart_name ?? \"\"}`\n          .toLowerCase()\n          .includes(searchTerm);\n      return matchesStatus && matchesType && matchesSearch;\n    });\n  })();\n\n  // Summaries\n  const summaryTotals: SummaryTotals = (() => {\n    if (filteredServices.length === 0) {\n      return { activeCount: 0, overdueCount: 0, pendingCount: 0, totalExpected: 0, totalPaid: 0 };\n    }\n    return filteredServices.reduce(\n      (acc, service) => {\n        acc.totalExpected += service.total_expected;\n        acc.totalPaid += service.total_paid;\n        acc.pendingCount += service.pending_count;\n        acc.overdueCount += service.overdue_count;\n        if (service.status === \"ACTIVE\") acc.activeCount += 1;\n        return acc;\n      },\n      { activeCount: 0, overdueCount: 0, pendingCount: 0, totalExpected: 0, totalPaid: 0 }\n    );\n  })();\n\n  const collectionRate = summaryTotals.totalExpected > 0 ? summaryTotals.totalPaid / summaryTotals.totalExpected : 0;\n\n  return {\n    canView,\n    collectionRate,\n    filteredServices,\n    filters,\n    handleFilterChange: servicesActions.setFilters,\n    listError: extractErrorMessage(error),\n    services,\n    setFilters: servicesActions.setFilters,\n    summaryTotals,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/hooks/use-services-overview.tsx","messages":[{"ruleId":"check-file/filename-naming-convention","severity":2,"message":"The filename \"use-services-overview.tsx\" does not match the \"PASCAL_CASE\" pattern","line":1,"column":1,"nodeType":"Program","messageId":"noMatch","endLine":75,"endColumn":1},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":10,"column":34,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":10,"endColumn":77,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[499,528],"text":"Readonly<{ children: React.ReactNode }>"},"desc":"Mark the props as read-only"}]},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":14,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":14,"endColumn":36},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":34,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1247,1250],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1247,1250],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":2,"message":"Unsafe argument of type `any` assigned to a parameter of type `CreateServicePayload`.","line":35,"column":35,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":35,"endColumn":42},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":38,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1352,1355],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1352,1355],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":2,"message":"Unsafe argument of type `any` assigned to a parameter of type `RegenerateServicePayload`.","line":40,"column":74,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":40,"endColumn":83}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { ServiceSchedule } from \"../types\";\n\nimport { useServiceDetails } from \"./use-service-details\";\nimport { useServiceMutations } from \"./use-service-mutations\";\nimport { useServicePayment } from \"./use-service-payment\";\nimport { useServicesList } from \"./use-services-list\";\n\n// Deprecated Provider - kept for compatibility but does nothing now\n// Can be removed once all usages are confirmed gone (it's not used in OverviewPage or Content)\nexport function ServicesProvider({ children }: { children: React.ReactNode }) {\n  return <>{children}</>;\n}\n\nexport function useServicesOverview() {\n  const list = useServicesList();\n  const details = useServiceDetails(list.services);\n  const mutations = useServiceMutations();\n  const payment = useServicePayment();\n\n  // Combine States\n  const loadingDetail = details.aggregatedLoading || mutations.regeneratePending;\n\n  // Composite Handlers\n  const handleAgendaRegisterPayment = (id: string, s: ServiceSchedule) => {\n    details.setSelectedId(id);\n    payment.openPaymentModal(s);\n  };\n\n  const handleAgendaUnlinkPayment = async (id: string, s: ServiceSchedule) => {\n    details.setSelectedId(id);\n    await mutations.unlinkPayment(s.id);\n  };\n\n  const handleCreateService = async (payload: any) => {\n    await mutations.createService(payload);\n  };\n\n  const handleRegenerate = async (overrides: any) => {\n    if (!details.selectedService) return;\n    await mutations.regenerateService(details.selectedService.public_id, overrides);\n  };\n\n  const handleUnlink = async (schedule: ServiceSchedule) => {\n    await mutations.unlinkPayment(schedule.id);\n  };\n\n  return {\n    ...list,\n    ...details,\n    ...mutations,\n    ...payment,\n\n    applyTemplate: details.openCreateModal,\n\n    canManage: mutations.canManage, // derived in mutations\n    closeCreateModal: details.closeCreateModal,\n    globalError: list.listError,\n    // Renamed or Composite Handlers for View Compatibility\n    handleAgendaRegisterPayment,\n    handleAgendaUnlinkPayment,\n\n    handleCreateService,\n    handleRegenerate,\n    handleUnlink,\n    // Computed / Combined\n    loadingDetail,\n\n    loadingList: false, // Suspense handles this now, so basic loading is false after boundary\n    // Modal & Action props that might expect specific signatures\n    openCreateModal: details.openCreateModal,\n    // Explicit mappings if names mismatched (checked and they align mostly)\n    processingPayment: payment.paymentPending,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/layout/ServicesLayout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/pages/AgendaPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/pages/CreateServicePage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/pages/EditServicePage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always falsy.","line":53,"column":9,"nodeType":"MemberExpression","messageId":"alwaysFalsy","endLine":53,"endColumn":29},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":121,"column":25,"nodeType":"Identifier","messageId":"alwaysTruthy","endLine":121,"endColumn":31},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":140,"column":22,"nodeType":"Identifier","messageId":"alwaysTruthy","endLine":140,"endColumn":29},{"ruleId":"@typescript-eslint/no-empty-function","severity":2,"message":"Unexpected empty arrow function.","line":192,"column":42,"nodeType":"ArrowFunctionExpression","messageId":"unexpected","endLine":192,"endColumn":44,"suggestions":[{"messageId":"suggestComment","data":{"name":"arrow function"},"fix":{"range":[7593,7593],"text":" /* empty */ "},"desc":"Add comment inside empty arrow function."}]},{"ruleId":"@typescript-eslint/no-empty-function","severity":2,"message":"Unexpected empty arrow function.","line":193,"column":40,"nodeType":"ArrowFunctionExpression","messageId":"unexpected","endLine":193,"endColumn":42,"suggestions":[{"messageId":"suggestComment","data":{"name":"arrow function"},"fix":{"range":[7636,7636],"text":" /* empty */ "},"desc":"Add comment inside empty arrow function."}]},{"ruleId":"@typescript-eslint/no-empty-function","severity":2,"message":"Unexpected empty arrow function.","line":199,"column":42,"nodeType":"ArrowFunctionExpression","messageId":"unexpected","endLine":199,"endColumn":44,"suggestions":[{"messageId":"suggestComment","data":{"name":"arrow function"},"fix":{"range":[7840,7840],"text":" /* empty */ "},"desc":"Add comment inside empty arrow function."}]},{"ruleId":"@typescript-eslint/no-empty-function","severity":2,"message":"Unexpected empty arrow function.","line":200,"column":40,"nodeType":"ArrowFunctionExpression","messageId":"unexpected","endLine":200,"endColumn":42,"suggestions":[{"messageId":"suggestComment","data":{"name":"arrow function"},"fix":{"range":[7883,7883],"text":" /* empty */ "},"desc":"Add comment inside empty arrow function."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMutation, useQueryClient, useSuspenseQuery } from \"@tanstack/react-query\";\nimport { useParams } from \"@tanstack/react-router\";\nimport dayjs from \"dayjs\";\nimport { useMemo, useState } from \"react\";\n\nimport type { CreateServicePayload, ServiceDetailResponse } from \"@/features/services/types\";\n\nimport Alert from \"@/components/ui/Alert\";\nimport Button from \"@/components/ui/Button\";\nimport { fetchServiceDetail, regenerateServiceSchedules, updateService } from \"@/features/services/api\";\nimport ServiceForm from \"@/features/services/components/ServiceForm\";\nimport ServiceScheduleAccordion from \"@/features/services/components/ServiceScheduleAccordion\";\nimport ServiceScheduleTable from \"@/features/services/components/ServiceScheduleTable\";\nimport { ServicesHero, ServicesSurface } from \"@/features/services/components/ServicesShell\";\nimport { fmtCLP } from \"@/lib/format\";\n\nexport default function ServiceEditPage() {\n  const { id } = useParams({ from: \"/_authed/services/$id/edit\" });\n  const queryClient = useQueryClient();\n  const [saveMessage, setSaveMessage] = useState<null | string>(null);\n\n  // Keep fetchServiceDetail as it provides aggregated data with schedules\n  // Keep fetchServiceDetail as it provides aggregated data with schedules\n  const { data: detail } = useSuspenseQuery({\n    queryFn: () => {\n      if (!id) throw new Error(\"ID de servicio no proporcionado\");\n      return fetchServiceDetail(id);\n    },\n    queryKey: [\"service-detail\", id],\n  });\n\n  // Use REST API mutation for service updates (ZenStack has strict Decimal type requirements)\n  const updateMutation = useMutation({\n    mutationFn: (payload: CreateServicePayload) => updateService(id, payload),\n    onSuccess: () => {\n      void queryClient.invalidateQueries({ queryKey: [\"service-detail\", id] });\n      void queryClient.invalidateQueries({ queryKey: [\"services-audit\"] });\n    },\n  });\n\n  const handleRegenerate = async (serviceId: string, payload?: { months?: number; startDate?: string }) => {\n    try {\n      const updated = await regenerateServiceSchedules(serviceId, payload ?? {});\n      queryClient.setQueryData([\"service-detail\", id], updated);\n      setSaveMessage(\"Proyecciones regeneradas correctamente.\");\n    } catch (error_) {\n      console.error(\"Regenerate failed:\", error_);\n    }\n  };\n\n  const updateError = (() => {\n    if (updateMutation.error instanceof Error) return updateMutation.error.message;\n    if (updateMutation.error) return String(updateMutation.error);\n    return null;\n  })();\n\n  const displayError = updateError;\n\n  const handleSubmit = async (payload: CreateServicePayload) => {\n    setSaveMessage(null);\n    if (!id) return;\n\n    try {\n      await updateMutation.mutateAsync(payload);\n      setSaveMessage(\"Servicio actualizado correctamente.\");\n    } catch {\n      // Error handled by mutation state\n    }\n  };\n\n  const summaryCards = useMemo(() => {\n    const { service } = detail;\n    return [\n      {\n        helper: \"Monto base configurado\",\n        label: \"Monto mensual\",\n        value: fmtCLP(service.default_amount),\n      },\n      {\n        helper: \"Cuotas sin pago registrado\",\n        label: \"Pendientes\",\n        value: `${service.pending_count}`,\n      },\n      {\n        helper: \"Total conciliado a la fecha\",\n        label: \"Pagado\",\n        value: fmtCLP(service.total_paid),\n      },\n      {\n        helper: \"Registro en base de datos\",\n        label: \"Última actualización\",\n        value: dayjs(service.updated_at).format(\"DD MMM YYYY HH:mm\"),\n      },\n    ];\n  }, [detail]);\n\n  const historyItems = useMemo(() => {\n    const { service } = detail;\n    const items: { date: string; description?: string; title: string }[] = [\n      {\n        date: dayjs(service.created_at).format(\"DD MMM YYYY HH:mm\"),\n        description: \"Servicio registrado en la plataforma\",\n        title: \"Creación\",\n      },\n      {\n        date: dayjs(service.updated_at).format(\"DD MMM YYYY HH:mm\"),\n        description: \"Datos del servicio actualizados\",\n        title: \"Última modificación\",\n      },\n    ];\n    if (service.overdue_count > 0) {\n      items.push({\n        date: dayjs().format(\"DD MMM YYYY\"),\n        description: `${service.overdue_count} cuotas requieren revisión`,\n        title: \"Cuotas vencidas\",\n      });\n    }\n    return items;\n  }, [detail]);\n\n  const initialValues = detail ? mapServiceToForm(detail.service) : undefined;\n\n  const service = detail.service;\n  const schedules = detail.schedules;\n\n  return (\n    <section className=\"space-y-6\">\n      <ServicesHero\n        actions={\n          <Button\n            onClick={() => {\n              globalThis.history.back();\n            }}\n            variant=\"ghost\"\n          >\n            Volver\n          </Button>\n        }\n        breadcrumbs={[{ label: \"Servicios\", to: \"/services\" }, { label: \"Editar\" }]}\n        description={service ? service.name : \"Ajusta los datos y cronogramas del servicio seleccionado.\"}\n        title=\"Editar servicio\"\n      />\n\n      {displayError && <Alert variant=\"error\">{displayError}</Alert>}\n      {saveMessage && <Alert variant=\"success\">{saveMessage}</Alert>}\n\n      <ServicesSurface className=\"space-y-6\">\n        <div className=\"grid gap-6 lg:grid-cols-[320px,minmax(0,1fr)] lg:items-start\">\n          <aside className=\"border-base-300/60 bg-base-100/80 text-base-content space-y-4 rounded-2xl border p-4 text-sm shadow-inner\">\n            <h2 className=\"text-base-content/80 text-sm font-semibold tracking-wide uppercase\">Resumen</h2>\n            <div className=\"space-y-3\">\n              {summaryCards.map((card) => (\n                <div className=\"border-base-300 bg-base-200 rounded-2xl border p-3\" key={card.label}>\n                  <p className=\"text-base-content/80 text-xs font-semibold tracking-wide uppercase\">{card.label}</p>\n                  <p className=\"text-base-content mt-1 text-lg font-semibold\">{card.value}</p>\n                  {card.helper && <p className=\"text-base-content/50 text-xs\">{card.helper}</p>}\n                </div>\n              ))}\n            </div>\n            <div className=\"space-y-2\">\n              <h3 className=\"text-base-content/80 text-xs font-semibold tracking-wide uppercase\">Historial</h3>\n              <ol className=\"text-base-content/60 space-y-2 text-xs\">\n                {historyItems.map((item) => (\n                  <li className=\"border-base-300 bg-base-200 rounded-xl border p-3\" key={item.title}>\n                    <p className=\"text-base-content font-semibold\">{item.title}</p>\n                    {item.description && <p className=\"text-base-content/50 text-xs\">{item.description}</p>}\n                    <p className=\"text-base-content/40 text-xs tracking-wide uppercase\">{item.date}</p>\n                  </li>\n                ))}\n              </ol>\n            </div>\n          </aside>\n\n          <div className=\"space-y-6\">\n            <section className=\"border-base-300 bg-base-100 rounded-2xl border p-6 shadow-sm\">\n              <h2 className=\"text-base-content/80 text-sm font-semibold tracking-wide uppercase\">Datos generales</h2>\n              {initialValues && (\n                <ServiceForm\n                  initialValues={initialValues}\n                  onCancel={() => {\n                    globalThis.history.back();\n                  }}\n                  onSubmit={handleSubmit}\n                  submitLabel=\"Actualizar servicio\"\n                />\n              )}\n            </section>\n\n            <section className=\"space-y-4\">\n              <ServiceScheduleAccordion\n                canManage={false}\n                onRegisterPayment={() => {}}\n                onUnlinkPayment={() => {}}\n                schedules={schedules}\n                service={service}\n              />\n              <ServiceScheduleTable\n                canManage={false}\n                onRegisterPayment={() => {}}\n                onUnlinkPayment={() => {}}\n                schedules={schedules}\n              />\n              <div className=\"flex justify-end\">\n                <Button\n                  disabled={updateMutation.isPending}\n                  onClick={() => handleRegenerate(String(service.id))}\n                  variant=\"secondary\"\n                >\n                  Regenerar cronograma\n                </Button>\n              </div>\n            </section>\n          </div>\n        </div>\n      </ServicesSurface>\n    </section>\n  );\n}\n\nfunction mapServiceToForm(service: ServiceDetailResponse[\"service\"]): Partial<CreateServicePayload> {\n  return {\n    accountReference: service.account_reference ?? undefined,\n    amountIndexation: service.amount_indexation,\n    category: service.category ?? undefined,\n    counterpartAccountId: service.counterpart_account_id,\n    counterpartId: service.counterpart_id,\n    defaultAmount: service.default_amount,\n    detail: service.detail ?? undefined,\n    dueDay: service.due_day,\n    emissionDay: service.emission_day,\n    emissionEndDay: service.emission_end_day,\n    emissionExactDate: service.emission_exact_date ?? undefined,\n    emissionMode: service.emission_mode,\n    emissionStartDay: service.emission_start_day,\n    frequency: service.frequency,\n    lateFeeGraceDays: service.late_fee_grace_days ?? undefined,\n    lateFeeMode: service.late_fee_mode,\n    lateFeeValue: service.late_fee_value ?? undefined,\n    monthsToGenerate: service.next_generation_months,\n    name: service.name,\n    notes: service.notes ?? undefined,\n    obligationType: service.obligation_type,\n    ownership: service.ownership,\n    recurrenceType: service.recurrence_type,\n    serviceType: service.service_type,\n    startDate: service.start_date,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/pages/OverviewPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/pages/TemplatesPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/queries.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/store.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/services/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/settings/api.ts","messages":[{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":37,"column":34,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":37,"endColumn":36,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1178,1180],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { apiClient } from \"@/lib/api-client\";\n\nexport interface InternalSettings {\n  envUpsertChunkSize?: string;\n  upsertChunkSize?: number | string;\n}\n\nexport interface InternalSettingsResponse {\n  internal: InternalSettings;\n}\n\nexport interface UploadResponse {\n  message?: string;\n  status: string;\n  url?: string;\n}\n\nexport async function fetchInternalSettings() {\n  const res = await apiClient.get<InternalSettingsResponse>(\"/api/settings/internal\");\n  return res;\n}\n\nexport async function updateInternalSettings(data: object) {\n  return apiClient.put<{ message?: string; status: string }>(\"/api/settings/internal\", data);\n}\n\nexport async function uploadBrandingAsset(file: File, endpoint: string): Promise<string> {\n  const formData = new FormData();\n  // Determine field name based on endpoint or just default to something consistent if backend handles it\n  // The original component logic checked endpoint content\n  const fieldName = endpoint.includes(\"logo\") ? \"logo\" : \"favicon\";\n  formData.append(fieldName, file);\n\n  const data = await apiClient.post<UploadResponse>(endpoint, formData);\n\n  if (data.status !== \"ok\" || !data.url) {\n    throw new Error(data.message || \"Error al subir archivo\");\n  }\n  return data.url;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/supplies/api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/supplies/components/SupplyRequestForm.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":29,"column":43,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":29,"endColumn":96,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[1007,1029],"text":"Readonly<SupplyRequestFormProps>"},"desc":"Mark the props as read-only"}]},{"ruleId":"@typescript-eslint/no-invalid-void-type","severity":2,"message":"void is only valid as a return type or generic type argument.","line":33,"column":45,"nodeType":"TSVoidKeyword","messageId":"invalidVoidNotReturnOrGeneric","endLine":33,"endColumn":49},{"ruleId":"@typescript-eslint/no-floating-promises","severity":2,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":36,"column":7,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":36,"endColumn":82,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[1288,1288],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[1288,1288],"text":"await "},"desc":"Add await operator."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":53,"column":30,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":53,"endColumn":32,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1910,1912],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"unicorn/no-array-reduce","severity":2,"message":"`Array#reduce()` is not allowed. Prefer other types of loop for readability.","line":73,"column":45,"nodeType":"Identifier","messageId":"reduce","endLine":73,"endColumn":51},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":79,"column":32,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":79,"endColumn":34,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[2775,2777],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":80,"column":24,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":80,"endColumn":41},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??=`) instead of an assignment expression, as it is simpler to read.","line":81,"column":5,"nodeType":"IfStatement","messageId":"preferNullishOverAssignment","endLine":83,"endColumn":6,"suggestions":[{"messageId":"suggestNullish","data":{"equals":"="},"fix":{"range":[2831,2892],"text":"brandGroup[brand] ??= [];"},"desc":"Fix to nullish coalescing operator (`??=`)."}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":81,"column":10,"nodeType":"MemberExpression","endLine":81,"endColumn":27},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":82,"column":7,"nodeType":"MemberExpression","endLine":82,"endColumn":24},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":85,"column":7,"nodeType":"MemberExpression","endLine":85,"endColumn":24},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":91,"column":56,"nodeType":"MemberExpression","endLine":91,"endColumn":90},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":93,"column":40,"nodeType":"MemberExpression","endLine":93,"endColumn":91},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":93,"column":40,"nodeType":"MemberExpression","endLine":93,"endColumn":74},{"ruleId":"@typescript-eslint/no-floating-promises","severity":2,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":102,"column":11,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":102,"endColumn":31,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[3566,3566],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[3566,3566],"text":"await "},"desc":"Add await operator."}]},{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"Using `join()` for field.state.meta.errors may use Object's default stringification format ('[object Object]') when stringified.","line":129,"column":57,"nodeType":"MemberExpression","messageId":"baseArrayJoin","endLine":129,"endColumn":80},{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"Using `join()` for field.state.meta.errors may use Object's default stringification format ('[object Object]') when stringified.","line":151,"column":57,"nodeType":"MemberExpression","messageId":"baseArrayJoin","endLine":151,"endColumn":80},{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"Using `join()` for field.state.meta.errors may use Object's default stringification format ('[object Object]') when stringified.","line":179,"column":57,"nodeType":"MemberExpression","messageId":"baseArrayJoin","endLine":179,"endColumn":80},{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"Using `join()` for field.state.meta.errors may use Object's default stringification format ('[object Object]') when stringified.","line":206,"column":57,"nodeType":"MemberExpression","messageId":"baseArrayJoin","endLine":206,"endColumn":80},{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"Using `join()` for field.state.meta.errors may use Object's default stringification format ('[object Object]') when stringified.","line":227,"column":57,"nodeType":"MemberExpression","messageId":"baseArrayJoin","endLine":227,"endColumn":80}],"suppressedMessages":[],"errorCount":14,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useForm, useStore } from \"@tanstack/react-form\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { z } from \"zod\";\n\nimport Button from \"@/components/ui/Button\";\nimport Input from \"@/components/ui/Input\";\nimport { useToast } from \"@/context/ToastContext\";\nimport { queryKeys } from \"@/lib/query-keys\";\n\nimport type { CommonSupply, StructuredSupplies } from \"../types\";\n\nimport { createSupplyRequest, type SupplyRequestPayload } from \"../api\";\n\nconst supplyRequestSchema = z.object({\n  notes: z.string().optional(),\n  quantity: z.number().int().min(1, \"La cantidad debe ser mayor a 0\"),\n  selectedBrand: z.string().optional(),\n  selectedModel: z.string().optional(),\n  selectedSupply: z.string().min(1, \"Seleccione un insumo\"),\n});\n\ninterface SupplyRequestFormProps {\n  commonSupplies: CommonSupply[];\n  onSuccess: () => void;\n}\n\ntype SupplyRequestFormValues = z.infer<typeof supplyRequestSchema>;\n\nexport default function SupplyRequestForm({ commonSupplies, onSuccess }: SupplyRequestFormProps) {\n  const queryClient = useQueryClient();\n  const { error: toastError, success: toastSuccess } = useToast();\n\n  const createRequestMutation = useMutation<void, Error, SupplyRequestPayload>({\n    mutationFn: createSupplyRequest,\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: queryKeys.supplies.requests() });\n    },\n  });\n\n  const form = useForm({\n    defaultValues: {\n      notes: \"\",\n      quantity: 1,\n      selectedBrand: \"\",\n      selectedModel: \"\",\n      selectedSupply: \"\",\n    } as SupplyRequestFormValues,\n    onSubmit: async ({ value }) => {\n      try {\n        await createRequestMutation.mutateAsync({\n          brand: value.selectedBrand === \"N/A\" || !value.selectedBrand ? undefined : value.selectedBrand,\n          model: value.selectedModel === \"N/A\" || !value.selectedModel ? undefined : value.selectedModel,\n          notes: value.notes || undefined,\n          quantity: value.quantity,\n          supplyName: value.selectedSupply,\n        });\n        toastSuccess(\"Solicitud de insumo enviada\");\n        form.reset();\n        onSuccess();\n      } catch (error) {\n        const message = error instanceof Error ? error.message : \"Error al enviar la solicitud\";\n        toastError(message);\n      }\n    },\n    validators: {\n      onChange: supplyRequestSchema,\n    },\n  });\n\n  const selectedSupply = useStore(form.store, (state) => state.values.selectedSupply);\n  const selectedBrand = useStore(form.store, (state) => state.values.selectedBrand);\n\n  const structuredSupplies = commonSupplies.reduce<StructuredSupplies>((acc, supply) => {\n    if (!supply.name) return acc;\n    const supplyGroup = acc[supply.name];\n    if (!supplyGroup) {\n      acc[supply.name] = {};\n    }\n    const brand = supply.brand || \"N/A\";\n    const brandGroup = acc[supply.name]!;\n    if (!brandGroup[brand]) {\n      brandGroup[brand] = [];\n    }\n    if (supply.model) {\n      brandGroup[brand].push(supply.model);\n    }\n    return acc;\n  }, {});\n\n  const supplyNames = Object.keys(structuredSupplies);\n  const availableBrands = selectedSupply ? Object.keys(structuredSupplies[selectedSupply] ?? {}) : [];\n  const availableModels =\n    selectedSupply && selectedBrand ? (structuredSupplies[selectedSupply]?.[selectedBrand] ?? []) : [];\n\n  return (\n    <div className=\"card bg-base-100 mb-8 p-6 shadow-lg\">\n      <h2 className=\"mb-4 text-xl font-semibold\">Solicitar nuevo insumo</h2>\n      <form\n        className=\"grid grid-cols-1 gap-4 md:grid-cols-2\"\n        onSubmit={(e) => {\n          e.preventDefault();\n          form.handleSubmit();\n        }}\n      >\n        <form.Field name=\"selectedSupply\">\n          {(field) => (\n            <div>\n              <Input\n                as=\"select\"\n                label=\"Nombre del insumo\"\n                onBlur={field.handleBlur}\n                onChange={(e) => {\n                  field.handleChange(e.target.value);\n                  // Reset dependent fields\n                  form.setFieldValue(\"selectedBrand\", \"\");\n                  form.setFieldValue(\"selectedModel\", \"\");\n                }}\n                required\n                value={field.state.value}\n              >\n                <option value=\"\">Seleccione un insumo</option>\n                {supplyNames.map((name) => (\n                  <option key={name} value={name}>\n                    {name}\n                  </option>\n                ))}\n              </Input>\n              {field.state.meta.errors.length > 0 && (\n                <p className=\"text-error mt-1 text-xs\">{field.state.meta.errors.join(\", \")}</p>\n              )}\n            </div>\n          )}\n        </form.Field>\n\n        <form.Field name=\"quantity\">\n          {(field) => (\n            <div>\n              <Input\n                inputMode=\"numeric\"\n                label=\"Cantidad\"\n                min=\"1\"\n                onBlur={field.handleBlur}\n                onChange={(e) => {\n                  field.handleChange(Number.parseInt(e.target.value, 10) || 1);\n                }}\n                required\n                type=\"number\"\n                value={field.state.value}\n              />\n              {field.state.meta.errors.length > 0 && (\n                <p className=\"text-error mt-1 text-xs\">{field.state.meta.errors.join(\", \")}</p>\n              )}\n            </div>\n          )}\n        </form.Field>\n\n        <form.Field name=\"selectedBrand\">\n          {(field) => (\n            <div>\n              <Input\n                as=\"select\"\n                disabled={!selectedSupply}\n                label=\"Marca\"\n                onBlur={field.handleBlur}\n                onChange={(e) => {\n                  field.handleChange(e.target.value);\n                  form.setFieldValue(\"selectedModel\", \"\");\n                }}\n                value={field.state.value ?? \"\"}\n              >\n                <option value=\"\">Seleccione una marca</option>\n                {availableBrands.map((brand) => (\n                  <option key={brand} value={brand}>\n                    {brand}\n                  </option>\n                ))}\n              </Input>\n              {field.state.meta.errors.length > 0 && (\n                <p className=\"text-error mt-1 text-xs\">{field.state.meta.errors.join(\", \")}</p>\n              )}\n            </div>\n          )}\n        </form.Field>\n\n        <form.Field name=\"selectedModel\">\n          {(field) => (\n            <div>\n              <Input\n                as=\"select\"\n                disabled={!selectedBrand || availableModels.length === 0}\n                label=\"Modelo\"\n                onBlur={field.handleBlur}\n                onChange={(e) => {\n                  field.handleChange(e.target.value);\n                }}\n                value={field.state.value ?? \"\"}\n              >\n                <option value=\"\">Seleccione un modelo</option>\n                {availableModels.map((model) => (\n                  <option key={model} value={model}>\n                    {model}\n                  </option>\n                ))}\n              </Input>\n              {field.state.meta.errors.length > 0 && (\n                <p className=\"text-error mt-1 text-xs\">{field.state.meta.errors.join(\", \")}</p>\n              )}\n            </div>\n          )}\n        </form.Field>\n\n        <form.Field name=\"notes\">\n          {(field) => (\n            <div className=\"md:col-span-2\">\n              <Input\n                as=\"textarea\"\n                enterKeyHint=\"done\"\n                label=\"Notas (opcional)\"\n                onBlur={field.handleBlur}\n                onChange={(e) => {\n                  field.handleChange(e.target.value);\n                }}\n                rows={3}\n                value={field.state.value ?? \"\"}\n              />\n              {field.state.meta.errors.length > 0 && (\n                <p className=\"text-error mt-1 text-xs\">{field.state.meta.errors.join(\", \")}</p>\n              )}\n            </div>\n          )}\n        </form.Field>\n\n        <div className=\"flex justify-end md:col-span-2\">\n          <Button disabled={form.state.isSubmitting} type=\"submit\">\n            {form.state.isSubmitting ? \"Enviando...\" : \"Enviar solicitud\"}\n          </Button>\n        </div>\n      </form>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/supplies/components/SupplyRequestsColumns.tsx","messages":[{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":45,"column":40,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":45,"endColumn":42,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1126,1128],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { ColumnDef } from \"@tanstack/react-table\";\nimport type { ChangeEvent } from \"react\";\n\nimport Input from \"@/components/ui/Input\";\n\nimport type { SupplyRequest } from \"../types\";\n\nimport { translateStatus } from \"../utils\";\n\ninterface SupplyRequestsTableMeta {\n  isAdmin: boolean;\n  onStatusChange: (requestId: number, newStatus: SupplyRequest[\"status\"]) => void;\n}\n\nexport const getSupplyRequestsColumns = (): ColumnDef<SupplyRequest>[] => [\n  {\n    accessorKey: \"id\",\n    cell: ({ getValue }) => <span className=\"text-base-content font-medium\">{getValue() as number}</span>,\n    header: \"ID\",\n  },\n  {\n    accessorKey: \"supply_name\",\n    header: \"Insumo\",\n  },\n  {\n    accessorKey: \"quantity\",\n    header: \"Cantidad\",\n  },\n  {\n    cell: ({ row }) => {\n      const { brand, model } = row.original;\n      return (\n        <span>\n          {brand && <span>{brand}</span>}\n          {brand && model && <span>/</span>}\n          {model && <span>{model}</span>}\n        </span>\n      );\n    },\n    header: \"Marca/modelo\",\n    id: \"brand_model\",\n  },\n  {\n    accessorKey: \"notes\",\n    cell: ({ getValue }) => getValue() || \"-\",\n    header: \"Notas\",\n  },\n  {\n    accessorKey: \"user_email\",\n    cell: ({ getValue, table }) => {\n      const meta = table.options.meta as SupplyRequestsTableMeta;\n      return meta.isAdmin ? (getValue() as string) : null;\n    },\n    header: \"Solicitado por\",\n  },\n  {\n    accessorKey: \"status\",\n    cell: ({ getValue }) => translateStatus(getValue() as SupplyRequest[\"status\"]),\n    header: \"Estado\",\n  },\n  {\n    accessorKey: \"admin_notes\",\n    cell: ({ getValue, table }) => {\n      const meta = table.options.meta as SupplyRequestsTableMeta;\n      return meta.isAdmin ? (getValue() as string) || \"-\" : null;\n    },\n    header: \"Notas del admin\",\n  },\n  {\n    accessorKey: \"created_at\",\n    cell: ({ getValue }) => new Date(getValue() as string).toLocaleString(),\n    header: \"Fecha solicitud\",\n  },\n  {\n    cell: ({ row, table }) => {\n      const meta = table.options.meta as SupplyRequestsTableMeta;\n      if (!meta.isAdmin) return null;\n\n      return (\n        <Input\n          as=\"select\"\n          className=\"bg-base-100 border-base-300 mt-1 block w-full rounded-md py-2 pr-10 pl-3 text-base focus:border-indigo-500 focus:ring-indigo-500 focus:outline-none sm:text-sm\"\n          onChange={(event: ChangeEvent<HTMLSelectElement>) => {\n            meta.onStatusChange(row.original.id, event.target.value as SupplyRequest[\"status\"]);\n          }}\n          value={row.original.status}\n        >\n          <option value=\"pending\">Pendiente</option>\n          <option value=\"ordered\">Pedido</option>\n          <option value=\"in_transit\">En tránsito</option>\n          <option value=\"delivered\">Entregado</option>\n          <option value=\"rejected\">Rechazado</option>\n        </Input>\n      );\n    },\n    header: \"Acciones\",\n    id: \"actions\",\n  },\n];\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/supplies/components/SupplyRequestsTable.tsx","messages":[{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":13,"column":45,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":13,"endColumn":99,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[456,480],"text":"Readonly<SupplyRequestsTableProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { DataTable } from \"@/components/data-table/DataTable\";\nimport { useAuth } from \"@/context/AuthContext\";\n\nimport type { SupplyRequest } from \"../types\";\n\nimport { getSupplyRequestsColumns } from \"./SupplyRequestsColumns\";\n\ninterface SupplyRequestsTableProps {\n  onStatusChange: (requestId: number, newStatus: SupplyRequest[\"status\"]) => void;\n  requests: SupplyRequest[];\n}\n\nexport default function SupplyRequestsTable({ onStatusChange, requests }: SupplyRequestsTableProps) {\n  const { can } = useAuth();\n  const isAdmin = can(\"update\", \"SupplyRequest\");\n\n  const columns = getSupplyRequestsColumns();\n\n  const columnVisibility = {\n    actions: isAdmin,\n    admin_notes: isAdmin,\n    user_email: isAdmin,\n  };\n\n  return (\n    <div className=\"bg-base-100 rounded-lg p-6 shadow-md\">\n      <h2 className=\"mb-4 text-xl font-semibold\">{isAdmin ? \"Todas las solicitudes\" : \"Solicitudes activas\"}</h2>\n      <DataTable\n        columns={columns}\n        columnVisibility={columnVisibility}\n        data={requests}\n        enableToolbar={false}\n        enableVirtualization={false}\n        initialPinning={{ right: [\"actions\"] }}\n        meta={{ isAdmin, onStatusChange }}\n        noDataMessage=\"No se encontraron solicitudes de insumos.\"\n      />\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/supplies/hooks/use-supply-management.ts","messages":[{"ruleId":"unicorn/no-array-reduce","severity":2,"message":"`Array#reduce()` is not allowed. Prefer other types of loop for readability.","line":29,"column":65,"nodeType":"Identifier","messageId":"reduce","endLine":29,"endColumn":71},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??=`) instead of an assignment expression, as it is simpler to read.","line":31,"column":5,"nodeType":"IfStatement","messageId":"preferNullishOverAssignment","endLine":33,"endColumn":6,"suggestions":[{"messageId":"suggestNullish","data":{"equals":"="},"fix":{"range":[1251,1310],"text":"acc[supply.name] ??= {};"},"desc":"Fix to nullish coalescing operator (`??=`)."}]},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":34,"column":32,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":34,"endColumn":34,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1342,1344],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":35,"column":10,"nodeType":"MemberExpression","endLine":35,"endColumn":34},{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":35,"column":10,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":35,"endColumn":27,"suggestions":[{"messageId":"suggestOptionalChain","fix":{"range":[1377,1378],"text":"?."},"desc":"Consider using the optional chain operator `?.` instead. This operator includes runtime checks, so it is safer than the compile-only non-null assertion operator."}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":36,"column":7,"nodeType":"MemberExpression","endLine":36,"endColumn":31},{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":36,"column":7,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":36,"endColumn":24},{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":39,"column":7,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":39,"endColumn":32,"suggestions":[{"messageId":"suggestOptionalChain","fix":{"range":[1486,1487],"text":"?"},"desc":"Consider using the optional chain operator `?.` instead. This operator includes runtime checks, so it is safer than the compile-only non-null assertion operator."}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":39,"column":7,"nodeType":"MemberExpression","endLine":39,"endColumn":31},{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":39,"column":7,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":39,"endColumn":24,"suggestions":[{"messageId":"suggestOptionalChain","fix":{"range":[1478,1479],"text":"?."},"desc":"Consider using the optional chain operator `?.` instead. This operator includes runtime checks, so it is safer than the compile-only non-null assertion operator."}]},{"ruleId":"@typescript-eslint/no-floating-promises","severity":2,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":54,"column":7,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":54,"endColumn":74,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[1929,1929],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[1929,1929],"text":"await "},"desc":"Add await operator."}]}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMutation, useQueryClient, useSuspenseQuery } from \"@tanstack/react-query\";\n\nimport { useToast } from \"@/context/ToastContext\";\n\nimport type { CommonSupply, StructuredSupplies, SupplyRequest } from \"../types\";\n\nimport { updateSupplyRequestStatus } from \"../api\";\nimport { supplyKeys, supplyQueries } from \"../queries\";\n\ninterface UseSupplyManagementResult {\n  commonSupplies: CommonSupply[];\n  handleStatusChange: (requestId: number, newStatus: SupplyRequest[\"status\"]) => Promise<void>;\n  refresh: () => Promise<void>;\n  requests: SupplyRequest[];\n  structuredSupplies: StructuredSupplies;\n}\n\nexport function useSupplyManagement(): UseSupplyManagementResult {\n  const { error: toastError, success: toastSuccess } = useToast();\n  const queryClient = useQueryClient();\n\n  // 1. Fetch Requests (Suspense-enabled for Loaders)\n  const { data: requests } = useSuspenseQuery(supplyQueries.requests());\n\n  // 2. Fetch Common Supplies\n  const { data: commonSupplies } = useSuspenseQuery(supplyQueries.common());\n\n  // 3. Process Data (Memoization handled by React 19 Compiler or fast enough for now)\n  const structuredSupplies: StructuredSupplies = commonSupplies.reduce<StructuredSupplies>((acc, supply) => {\n    if (!supply.name) return acc;\n    if (!acc[supply.name]) {\n      acc[supply.name] = {};\n    }\n    const brand = supply.brand || \"N/A\";\n    if (!acc[supply.name]![brand]) {\n      acc[supply.name]![brand] = [];\n    }\n    if (supply.model) {\n      acc[supply.name]![brand]!.push(supply.model);\n    }\n    return acc;\n  }, {});\n\n  // 4. Mutations\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, status }: { id: number; status: SupplyRequest[\"status\"] }) => {\n      return updateSupplyRequestStatus(id, status);\n    },\n    onError: (err) => {\n      const message = err instanceof Error ? err.message : \"Error al actualizar el estado\";\n      toastError(message);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: supplyKeys.requests() });\n      toastSuccess(\"Estado de solicitud actualizado\");\n    },\n  });\n\n  const handleStatusChange = async (requestId: number, newStatus: SupplyRequest[\"status\"]) => {\n    await updateMutation.mutateAsync({ id: requestId, status: newStatus });\n  };\n\n  const refresh = async () => {\n    await Promise.all([\n      queryClient.invalidateQueries({ queryKey: supplyKeys.requests() }),\n      queryClient.invalidateQueries({ queryKey: supplyKeys.common() }),\n    ]);\n  };\n\n  return {\n    commonSupplies,\n    handleStatusChange,\n    refresh,\n    requests,\n    structuredSupplies,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/supplies/queries.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/supplies/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/supplies/utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/system/api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/system/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/users/api.ts","messages":[{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":45,"column":33,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":45,"endColumn":35,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[1517,1519],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { apiClient } from \"@/lib/api-client\";\n\nimport type { User, UserProfile } from \"./types\";\n\nexport interface UsersResponse {\n  users: User[];\n}\n\nexport async function deleteUser(userId: number): Promise<void> {\n  await apiClient.delete(`/api/users/${userId}`);\n}\n\nexport async function deleteUserPasskey(userId: number): Promise<void> {\n  await apiClient.delete(`/api/users/${userId}/passkey`);\n}\n\nexport async function fetchUserProfile(): Promise<UserProfile> {\n  const res = await apiClient.get<{ data: UserProfile }>(\"/api/users/profile\");\n  return res.data;\n}\n\nexport async function fetchUsers(): Promise<User[]> {\n  const res = await apiClient.get<UsersResponse>(\"/api/users\");\n  return res.users;\n}\n\nexport async function inviteUser(payload: Record<string, unknown>): Promise<{ tempPassword?: string; userId: number }> {\n  return apiClient.post(\"/api/users/invite\", payload);\n}\n\nexport async function resetUserPassword(userId: number): Promise<string> {\n  const res = await apiClient.post<{ tempPassword: string }>(`/api/users/${userId}/reset-password`, {});\n  return res.tempPassword;\n}\n\nexport async function setupUser(payload: Record<string, unknown>): Promise<void> {\n  await apiClient.post(\"/api/users/setup\", payload);\n}\n\nexport async function toggleUserMfa(userId: number, enabled: boolean): Promise<void> {\n  const res = await apiClient.post<{ message?: string; status: string }>(`/api/users/${userId}/mfa/toggle`, {\n    enabled,\n  });\n  if (res.status !== \"ok\") {\n    throw new Error(res.message || \"Error al cambiar estado MFA\");\n  }\n}\n\nexport async function updateUserRole(userId: number, role: string): Promise<void> {\n  await apiClient.put(`/api/users/${userId}/role`, { role });\n}\n\nexport async function updateUserStatus(userId: number, status: string): Promise<void> {\n  await apiClient.put(`/api/users/${userId}/status`, { status });\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/users/components/UserAccessCells.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":9,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":9,"endColumn":30},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":16,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":16,"endColumn":30}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Key, Lock, Shield, ShieldCheck } from \"lucide-react\";\n\nimport type { User } from \"@/features/users/types\";\n\nimport { BADGE_SM } from \"@/lib/styles\";\n\n// --- Helpers ---\n\nexport const getSecurityScore = (user: User) => {\n  let score = 0;\n  if (user.mfaEnabled) score += 50;\n  if (user.hasPasskey) score += 50;\n  return score;\n};\n\nexport const getSecurityBadge = (score: number) => {\n  if (score === 100) return { color: \"badge-success\", icon: Shield, label: \"Óptima\" };\n  if (score >= 50) return { color: \"badge-warning\", icon: ShieldCheck, label: \"Buena\" };\n  return { color: \"badge-error\", icon: Lock, label: \"Básica\" };\n};\n\n// --- Cell Components ---\n\nexport const UserCell = ({ email }: { email: null | string }) => {\n  const safeEmail = email ?? \"\";\n  const initials = (safeEmail.split(\"@\")[0] ?? \"\").slice(0, 2).toUpperCase();\n\n  return (\n    <div className=\"flex items-center gap-3\">\n      <div className=\"avatar placeholder\">\n        <div className=\"bg-neutral text-neutral-content flex h-10 w-10 items-center justify-center rounded-full\">\n          <span className=\"text-xs\">{initials}</span>\n        </div>\n      </div>\n      <div>\n        <div className=\"font-medium\">{safeEmail}</div>\n      </div>\n    </div>\n  );\n};\n\nexport const SecurityCell = ({ user }: { user: User }) => {\n  const score = getSecurityScore(user);\n  const badge = getSecurityBadge(score);\n  const BadgeIcon = badge.icon;\n  return (\n    <div className=\"flex items-center justify-center gap-2\">\n      <span className={`${BADGE_SM} ${badge.color} gap-1`}>\n        <BadgeIcon className=\"size-3\" />\n        {badge.label}\n      </span>\n      <span className=\"text-base-content/50 text-xs\">{score}%</span>\n    </div>\n  );\n};\n\nexport const MfaStatusCell = ({ active }: { active: boolean }) => {\n  if (active) {\n    return (\n      <div className=\"flex items-center justify-center gap-1\">\n        <ShieldCheck className=\"text-success size-4\" />\n        <span className=\"text-success text-xs font-medium\">Activo</span>\n      </div>\n    );\n  }\n  return <span className=\"text-base-content/30 flex justify-center text-xs\">Inactivo</span>;\n};\n\nexport const PasskeyStatusCell = ({ hasPasskey }: { hasPasskey: boolean }) => {\n  if (hasPasskey) {\n    return (\n      <div className=\"flex items-center justify-center gap-1\">\n        <Key className=\"text-info size-4\" />\n        <span className=\"text-info text-xs font-medium\">Sí</span>\n      </div>\n    );\n  }\n  return <span className=\"text-base-content/30 flex justify-center text-xs\">No</span>;\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/users/components/UserAccessColumns.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/users/components/columns.tsx","messages":[{"ruleId":"check-file/filename-naming-convention","severity":2,"message":"The filename \"columns.tsx\" does not match the \"PASCAL_CASE\" pattern","line":1,"column":1,"nodeType":"Program","messageId":"noMatch","endLine":216,"endColumn":1},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":63,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":63,"endColumn":41},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":2,"message":"Unsafe call of an `any` typed value.","line":63,"column":22,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":63,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .toLowerCase on an `any` value.","line":63,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":63,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":2,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":64,"column":48,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":64,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":2,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":64,"column":113,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":64,"endColumn":119}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ColumnDef } from \"@tanstack/react-table\";\nimport dayjs from \"dayjs\";\nimport { Fingerprint, Key, Lock, MoreVertical, Shield, ShieldCheck, Trash2, UserCog } from \"lucide-react\";\n\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/DropdownMenu\";\nimport { User } from \"@/features/users/types\";\nimport { getPersonFullName, getPersonInitials } from \"@/lib/person\";\nimport { BADGE_SM } from \"@/lib/styles\";\nimport { cn } from \"@/lib/utils\";\n\n// Helper for status colors\nconst getStatusColor = (s: string) => {\n  switch (s) {\n    case \"ACTIVE\": {\n      return \"badge-success\";\n    }\n    case \"PENDING_SETUP\": {\n      return \"badge-warning\";\n    }\n    case \"SUSPENDED\": {\n      return \"badge-error\";\n    }\n    default: {\n      return \"badge-ghost\";\n    }\n  }\n};\n\nexport const getColumns = (actions: {\n  onDeletePasskey: (id: number) => void;\n  onDeleteUser: (id: number) => void;\n  onEditRole: (user: User) => void;\n  onResetPassword: (id: number) => void;\n  onToggleMfa: (id: number, current: boolean) => void;\n  onToggleStatus: (id: number, status: string) => void;\n}): ColumnDef<User>[] => [\n  {\n    accessorKey: \"user\",\n    cell: ({ row }) => {\n      const user = row.original;\n      return (\n        <div className=\"flex items-center gap-3\">\n          <div className=\"avatar placeholder\">\n            <div className=\"bg-neutral text-neutral-content flex h-10 w-10 items-center justify-center rounded-full\">\n              <span className=\"text-xs font-bold\">{getPersonInitials(user.person)}</span>\n            </div>\n          </div>\n          <div>\n            <div className=\"font-bold\">{getPersonFullName(user.person)}</div>\n            <div className=\"text-xs opacity-50\">{user.email}</div>\n          </div>\n        </div>\n      );\n    },\n    filterFn: (row, _id, value) => {\n      const user = row.original;\n      const search = value.toLowerCase();\n      return user.email.toLowerCase().includes(search) || getPersonFullName(user.person).toLowerCase().includes(search);\n    },\n    header: \"Usuario\",\n  },\n  {\n    accessorKey: \"role\",\n    cell: ({ row }) => (\n      <span className=\"badge badge-ghost badge-sm font-medium whitespace-nowrap\">{row.original.role}</span>\n    ),\n    header: \"Rol\",\n  },\n  {\n    accessorKey: \"status\",\n    cell: ({ row }) => {\n      const status = row.original.status;\n      return (\n        <div className={cn(BADGE_SM, \"w-fit gap-2 whitespace-nowrap\", getStatusColor(status))}>\n          {status === \"ACTIVE\" && <div className=\"size-1.5 rounded-full bg-current\" />}\n          {status}\n        </div>\n      );\n    },\n    header: \"Estado\",\n  },\n  {\n    accessorKey: \"mfaEnabled\",\n    cell: ({ row }) => (\n      <div className=\"flex justify-center\">\n        {row.original.mfaEnabled ? (\n          <div className=\"tooltip\" data-tip=\"MFA activado\">\n            <ShieldCheck className=\"text-success size-5\" />\n          </div>\n        ) : (\n          <div className=\"tooltip\" data-tip=\"MFA inactivo\">\n            <ShieldCheck className=\"text-base-content/20 size-5\" />\n          </div>\n        )}\n      </div>\n    ),\n    header: () => <div className=\"text-center\">MFA</div>,\n    size: 60,\n  },\n  {\n    accessorKey: \"hasPasskey\",\n    cell: ({ row }) => (\n      <div className=\"flex justify-center\">\n        {row.original.hasPasskey ? (\n          <div className=\"tooltip\" data-tip=\"Passkey configurado\">\n            <Fingerprint className=\"text-success size-5\" />\n          </div>\n        ) : (\n          <div className=\"tooltip\" data-tip=\"Sin passkey\">\n            <Fingerprint className=\"text-base-content/20 size-5\" />\n          </div>\n        )}\n      </div>\n    ),\n    header: () => <div className=\"text-center\">Passkey</div>,\n    size: 60,\n  },\n  {\n    accessorKey: \"createdAt\",\n    cell: ({ row }) => (\n      <span className=\"text-base-content/70 text-sm\">{dayjs(row.original.createdAt).format(\"DD MMM YYYY\")}</span>\n    ),\n    header: \"Creado\",\n  },\n  {\n    cell: ({ row }) => {\n      const user = row.original;\n      return (\n        <DropdownMenu>\n          <DropdownMenuTrigger asChild>\n            <button className=\"btn btn-ghost btn-xs\" type=\"button\">\n              <MoreVertical size={16} />\n            </button>\n          </DropdownMenuTrigger>\n          <DropdownMenuContent align=\"end\" className=\"w-56\">\n            <DropdownMenuItem\n              onClick={() => {\n                actions.onEditRole(user);\n              }}\n            >\n              <UserCog className=\"mr-2 h-4 w-4\" />\n              Editar rol\n            </DropdownMenuItem>\n            <DropdownMenuItem\n              onClick={() => {\n                actions.onToggleMfa(user.id, user.mfaEnabled);\n              }}\n            >\n              <ShieldCheck className=\"mr-2 h-4 w-4\" />\n              {user.mfaEnabled ? \"Desactivar\" : \"Activar\"} MFA\n            </DropdownMenuItem>\n            <DropdownMenuItem\n              onClick={() => {\n                actions.onResetPassword(user.id);\n              }}\n            >\n              <Key className=\"mr-2 h-4 w-4\" />\n              Restablecer contraseña\n            </DropdownMenuItem>\n            {user.hasPasskey && (\n              <DropdownMenuItem\n                className=\"text-warning focus:text-warning\"\n                onClick={() => {\n                  actions.onDeletePasskey(user.id);\n                }}\n              >\n                <Trash2 className=\"mr-2 h-4 w-4\" />\n                Eliminar passkey\n              </DropdownMenuItem>\n            )}\n            {user.status === \"SUSPENDED\" ? (\n              <DropdownMenuItem\n                className=\"text-success focus:text-success\"\n                onClick={() => {\n                  actions.onToggleStatus(user.id, user.status);\n                }}\n              >\n                <Shield className=\"mr-2 h-4 w-4\" />\n                Reactivar acceso\n              </DropdownMenuItem>\n            ) : (\n              <DropdownMenuItem\n                className=\"text-warning focus:text-warning\"\n                onClick={() => {\n                  actions.onToggleStatus(user.id, user.status);\n                }}\n              >\n                <Lock className=\"mr-2 h-4 w-4\" />\n                Suspender acceso\n              </DropdownMenuItem>\n            )}\n            <DropdownMenuSeparator />\n            <DropdownMenuItem\n              className=\"text-error focus:text-error\"\n              onClick={() => {\n                actions.onDeleteUser(user.id);\n              }}\n            >\n              <Trash2 className=\"mr-2 h-4 w-4\" />\n              Eliminar usuario\n            </DropdownMenuItem>\n          </DropdownMenuContent>\n        </DropdownMenu>\n      );\n    },\n    id: \"actions\",\n    size: 50,\n  },\n];\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/users/pages/PersonManagementPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":19,"column":13,"nodeType":"ChainExpression","messageId":"neverNullish","endLine":19,"endColumn":35},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":19,"column":20,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":19,"endColumn":22,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[744,746],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":19,"column":78,"nodeType":"MemberExpression","messageId":"neverNullish","endLine":19,"endColumn":83}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useSuspenseQuery } from \"@tanstack/react-query\";\nimport { useNavigate } from \"@tanstack/react-router\";\nimport { Briefcase, Building, Plus, Search, User } from \"lucide-react\";\nimport { useState } from \"react\";\n\nimport Button from \"@/components/ui/Button\";\nimport Input from \"@/components/ui/Input\";\nimport { peopleQueries } from \"@/features/people/api\";\nimport { getPersonFullName, getPersonInitials } from \"@/lib/person\";\nimport { BADGE_SM, PAGE_CONTAINER } from \"@/lib/styles\";\n\nexport default function PersonManagementPage() {\n  const navigate = useNavigate();\n  const [search, setSearch] = useState(\"\");\n\n  const { data: people } = useSuspenseQuery(peopleQueries.list());\n\n  const filteredPeople = people.filter(\n    (p) => (p.names?.toLowerCase() ?? \"\").includes(search.toLowerCase()) || (p.rut ?? \"\").includes(search)\n  );\n\n  return (\n    <div className={PAGE_CONTAINER}>\n      {/* Filters */}\n      <div className=\"bg-base-100 flex items-center gap-4 rounded-2xl p-4 shadow-sm\">\n        <div className=\"relative flex-1\">\n          <Search className=\"text-base-content/40 absolute top-1/2 left-3 h-4 w-4 -translate-y-1/2\" />\n          <Input\n            className=\"w-full pl-9\"\n            onChange={(e) => {\n              setSearch(e.target.value);\n            }}\n            placeholder=\"Buscar por nombre o RUT...\"\n            type=\"text\"\n            value={search}\n          />\n        </div>\n        <Button className=\"gap-2\">\n          <Plus size={18} />\n          Nueva Persona\n        </Button>\n      </div>\n\n      {/* People List */}\n      <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-3\">\n        {filteredPeople.length === 0 ? (\n          <p className=\"text-base-content/40 col-span-full text-center\">No se encontraron personas</p>\n        ) : (\n          filteredPeople.map((person) => (\n            <div\n              className=\"card bg-base-100 border-base-200 border shadow-sm transition-shadow hover:shadow-md\"\n              key={person.id}\n            >\n              <div className=\"card-body p-5\">\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"avatar placeholder\">\n                      <div className=\"bg-base-200 text-base-content/60 flex w-10 items-center justify-center rounded-full\">\n                        <span className=\"text-xs font-bold\">{getPersonInitials(person)}</span>\n                      </div>\n                    </div>\n                    <div>\n                      <h3 className=\"text-base-content font-bold\">{getPersonFullName(person)}</h3>\n                      <p className=\"text-base-content/50 text-xs\">{person.rut}</p>\n                    </div>\n                  </div>\n                </div>\n\n                <div className=\"mt-4 flex flex-wrap gap-2\">\n                  {person.user && (\n                    <span className={`${BADGE_SM} badge-primary gap-1 text-white`}>\n                      <User size={10} /> Usuario\n                    </span>\n                  )}\n                  {person.employee && (\n                    <span className={`${BADGE_SM} badge-secondary gap-1 text-white`}>\n                      <Briefcase size={10} /> Empleado\n                    </span>\n                  )}\n                  {person.counterpart && (\n                    <span className={`${BADGE_SM} badge-accent gap-1 text-white`}>\n                      <Building size={10} /> Contraparte\n                    </span>\n                  )}\n                  {!person.user && !person.employee && !person.counterpart && (\n                    <span className={`${BADGE_SM} badge-ghost`}>Sin roles</span>\n                  )}\n                </div>\n\n                <div className=\"border-base-200 mt-4 flex justify-end border-t pt-4\">\n                  <Button onClick={() => navigate({ to: `/settings/people/${person.id}` })} size=\"xs\" variant=\"ghost\">\n                    Ver Detalles\n                  </Button>\n                </div>\n              </div>\n            </div>\n          ))\n        )}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/users/pages/UserManagementPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":55,"column":30,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":55,"endColumn":32,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[1978,1980],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":55,"column":60,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":55,"endColumn":62,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[2008,2010],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":58,"column":22,"nodeType":"ChainExpression","messageId":"neverNullish","endLine":58,"endColumn":48},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":58,"column":33,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":58,"endColumn":35,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[2106,2108],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":62,"column":23,"nodeType":"MemberExpression","messageId":"neverNullish","endLine":62,"endColumn":35},{"ruleId":"@typescript-eslint/no-floating-promises","severity":2,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":95,"column":13,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":95,"endColumn":67,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[3549,3549],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[3549,3549],"text":"await "},"desc":"Add await operator."}]},{"ruleId":"@typescript-eslint/no-floating-promises","severity":2,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":120,"column":13,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":120,"endColumn":67,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[4459,4459],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[4459,4459],"text":"await "},"desc":"Add await operator."}]},{"ruleId":"@typescript-eslint/no-floating-promises","severity":2,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":132,"column":13,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":132,"endColumn":67,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[4990,4990],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[4990,4990],"text":"await "},"desc":"Add await operator."}]},{"ruleId":"@typescript-eslint/no-floating-promises","severity":2,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":183,"column":7,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":183,"endColumn":61,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[6699,6699],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[6699,6699],"text":"await "},"desc":"Add await operator."}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":200,"column":8,"nodeType":"Identifier","messageId":"alwaysTruthy","endLine":200,"endColumn":13},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":263,"column":21,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":263,"endColumn":23,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[9984,9986],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":308,"column":21,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":308,"endColumn":23,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[11504,11506],"text":"."},"desc":"Remove unnecessary optional chain"}]}],"suppressedMessages":[],"errorCount":12,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\n  useCreateUserRoleAssignment,\n  useDeleteManyUserRoleAssignment,\n  useDeleteUser,\n  useFindManyRole,\n  useFindManyUser,\n  useUpdateUser,\n} from \"@finanzas/db/hooks\";\nimport { useQueryClient } from \"@tanstack/react-query\";\nimport { Link } from \"@tanstack/react-router\";\nimport dayjs from \"dayjs\";\nimport relativeTime from \"dayjs/plugin/relativeTime\";\nimport { Key, Shield, UserCog, UserPlus } from \"lucide-react\";\nimport { useMemo, useState } from \"react\";\n\nimport type { User } from \"@/features/users/types\";\n\nimport { DataTable } from \"@/components/data-table/DataTable\";\nimport Button from \"@/components/ui/Button\";\nimport Modal from \"@/components/ui/Modal\";\nimport { useAuth } from \"@/context/AuthContext\";\nimport { useToast } from \"@/context/ToastContext\";\nimport { deleteUserPasskey, resetUserPassword, toggleUserMfa } from \"@/features/users/api\";\nimport { getColumns } from \"@/features/users/components/columns\";\nimport { getPersonFullName } from \"@/lib/person\";\nimport { PAGE_CONTAINER } from \"@/lib/styles\";\n\nimport \"dayjs/locale/es\";\n\ndayjs.extend(relativeTime);\ndayjs.locale(\"es\");\n\nexport default function UserManagementPage() {\n  useAuth(); // Keep context mounted\n  const { error, success } = useToast();\n  const queryClient = useQueryClient();\n  const [roleFilter, setRoleFilter] = useState<string>(\"ALL\");\n\n  const [editingUser, setEditingUser] = useState<null | User>(null);\n  const [selectedRole, setSelectedRole] = useState(\"\");\n\n  // ZenStack hooks for users\n  const { data: usersData, isLoading } = useFindManyUser({\n    include: { passkeys: true, person: true, roles: { include: { role: true } } },\n    orderBy: { createdAt: \"desc\" },\n  });\n\n  // Use TypeScript inference for raw ZenStack data type\n  type RawUser = NonNullable<typeof usersData>[number];\n\n  // Transform to frontend User view model (with computed properties)\n  const users: User[] = useMemo(() => {\n    if (!usersData) return [];\n    return usersData\n      .filter((u) => !u.email?.includes(\"test\") && !u.email?.includes(\"debug\"))\n      .map(\n        (u: RawUser): User => ({\n          createdAt: u.createdAt?.toISOString() ?? new Date().toISOString(),\n          email: u.email,\n          hasPasskey: ((u as { passkeys?: unknown[] }).passkeys ?? []).length > 0,\n          id: u.id,\n          mfaEnabled: u.mfaEnabled ?? false,\n          passkeysCount: ((u as { passkeys?: unknown[] }).passkeys ?? []).length,\n          person: {\n            fatherName: (u as { person?: { fatherName?: null | string } }).person?.fatherName ?? null,\n            names: (u as { person?: { names?: string } }).person?.names ?? \"\",\n            rut: (u as { person?: { rut?: string } }).person?.rut ?? \"\",\n          },\n          role: (u as { roles?: { role?: { name?: string } }[] }).roles?.[0]?.role?.name ?? \"\",\n          status: u.status as User[\"status\"],\n        })\n      );\n  }, [usersData]);\n\n  // ZenStack hooks for roles (for filter dropdown)\n  const { data: rolesData } = useFindManyRole({\n    orderBy: { name: \"asc\" },\n  });\n  const roles = rolesData ?? [];\n\n  // Mutations\n  const updateUserMutation = useUpdateUser();\n  const deleteUserMutation = useDeleteUser();\n  const createRoleAssignment = useCreateUserRoleAssignment();\n  const deleteRoleAssignments = useDeleteManyUserRoleAssignment();\n\n  // Actions Handlers\n  const actions = useMemo(\n    () => ({\n      onDeletePasskey: async (id: number) => {\n        if (confirm(\"¿Eliminar Passkey?\")) {\n          try {\n            await deleteUserPasskey(id);\n            success(\"Passkey eliminado\");\n            queryClient.invalidateQueries({ queryKey: [\"user\"] });\n          } catch {\n            error(\"Error al eliminar Passkey\");\n          }\n        }\n      },\n      onDeleteUser: async (id: number) => {\n        if (confirm(\"¿Eliminar usuario permanentemente?\")) {\n          try {\n            await deleteUserMutation.mutateAsync({ where: { id } });\n            success(\"Usuario eliminado\");\n          } catch (error_) {\n            error(error_ instanceof Error ? error_.message : \"Error al eliminar\");\n          }\n        }\n      },\n      onEditRole: (user: User) => {\n        setEditingUser(user);\n        setSelectedRole(user.role);\n      },\n      onResetPassword: async (id: number) => {\n        if (confirm(\"¿Restablecer contraseña? Esto generará una clave temporal.\")) {\n          try {\n            const tempPassword = await resetUserPassword(id);\n            success(\"Contraseña restablecida\");\n            queryClient.invalidateQueries({ queryKey: [\"user\"] });\n            alert(`Contraseña temporal: ${tempPassword}`);\n          } catch (error_) {\n            error(error_ instanceof Error ? error_.message : \"Error al restablecer\");\n          }\n        }\n      },\n      onToggleMfa: async (id: number, current: boolean) => {\n        const action = current ? \"desactivar\" : \"activar\";\n        if (confirm(`¿Estás seguro de ${action} MFA para este usuario?`)) {\n          try {\n            await toggleUserMfa(id, !current);\n            queryClient.invalidateQueries({ queryKey: [\"user\"] });\n            success(\"Estado MFA actualizado correctamente\");\n          } catch (error_) {\n            error(error_ instanceof Error ? error_.message : \"Error desconocido\");\n          }\n        }\n      },\n      onToggleStatus: async (id: number, currentStatus: string) => {\n        const newStatus = currentStatus === \"SUSPENDED\" ? \"ACTIVE\" : \"SUSPENDED\";\n        const action = newStatus === \"ACTIVE\" ? \"reactivar\" : \"suspender\";\n        if (confirm(`¿${action} usuario?`)) {\n          try {\n            await updateUserMutation.mutateAsync({\n              data: { status: newStatus },\n              where: { id },\n            });\n            success(`Usuario ${newStatus === \"ACTIVE\" ? \"reactivado\" : \"suspendido\"}`);\n          } catch (error_) {\n            error(error_ instanceof Error ? error_.message : \"Error al actualizar estado\");\n          }\n        }\n      },\n    }),\n    [deleteUserMutation, error, queryClient, success, updateUserMutation]\n  );\n\n  const columns = useMemo(() => getColumns(actions), [actions]);\n\n  const handleSaveRole = async () => {\n    if (!editingUser || !selectedRole) return;\n\n    const selectedRoleObj = roles.find((r) => r.name === selectedRole);\n    if (!selectedRoleObj) {\n      error(\"Rol no encontrado\");\n      return;\n    }\n\n    try {\n      // First, remove all existing role assignments for the user\n      await deleteRoleAssignments.mutateAsync({\n        where: { userId: editingUser.id },\n      });\n\n      // Then, create the new role assignment\n      await createRoleAssignment.mutateAsync({\n        data: {\n          roleId: selectedRoleObj.id,\n          userId: editingUser.id,\n        },\n      });\n\n      queryClient.invalidateQueries({ queryKey: [\"user\"] });\n      success(\"Rol actualizado correctamente\");\n      setEditingUser(null);\n    } catch (error_) {\n      error(error_ instanceof Error ? error_.message : \"Error al actualizar rol\");\n    }\n  };\n\n  // Filter users based on role filter (client side)\n  const filteredUsers = useMemo(() => {\n    if (roleFilter === \"ALL\") return users;\n    return users.filter((u) => u.role === roleFilter || (u.role || \"\").toUpperCase() === roleFilter.toUpperCase());\n  }, [users, roleFilter]);\n\n  return (\n    <div className={PAGE_CONTAINER}>\n      {/* Security Overview Cards */}\n      {users && users.length > 0 && (\n        <div className=\"grid gap-4 md:grid-cols-3\">\n          <div className=\"card bg-base-100 shadow-sm\">\n            <div className=\"card-body\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"bg-primary/10 text-primary flex h-12 w-12 items-center justify-center rounded-full\">\n                  <UserCog size={24} />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{users.length}</p>\n                  <p className=\"text-base-content/60 text-sm\">Usuarios totales</p>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"card bg-base-100 shadow-sm\">\n            <div className=\"card-body\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"bg-success/10 text-success flex h-12 w-12 items-center justify-center rounded-full\">\n                  <Shield size={24} />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{users.filter((u) => u.mfaEnabled).length}</p>\n                  <p className=\"text-base-content/60 text-sm\">Con MFA activo</p>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"card bg-base-100 shadow-sm\">\n            <div className=\"card-body\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"bg-info/10 text-info flex h-12 w-12 items-center justify-center rounded-full\">\n                  <Key size={24} />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{users.filter((u) => u.hasPasskey).length}</p>\n                  <p className=\"text-base-content/60 text-sm\">Con passkey</p>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* User Management Table */}\n      <div className=\"surface-elevated rounded-2xl p-4\">\n        <div className=\"mb-4 flex flex-col items-end justify-between gap-4 sm:flex-row\">\n          {/* Custom Role Filter */}\n          <div className=\"w-full sm:w-48\">\n            <label className=\"label py-0 pb-1\" htmlFor=\"role-filter\">\n              <span className=\"label-text-alt\">Filtrar por rol</span>\n            </label>\n            <select\n              className=\"select select-bordered w-full\"\n              id=\"role-filter\"\n              onChange={(e) => {\n                setRoleFilter(e.target.value);\n              }}\n              value={roleFilter}\n            >\n              <option value=\"ALL\">Todos los roles</option>\n              {roles?.map((role: { name: string }) => (\n                <option key={role.name} value={role.name}>\n                  {role.name}\n                </option>\n              ))}\n            </select>\n          </div>\n\n          <Link className=\"btn btn-primary gap-2\" to=\"/settings/users/add\">\n            <UserPlus size={20} />\n            Agregar usuario\n          </Link>\n        </div>\n\n        <DataTable columns={columns} data={filteredUsers} enableToolbar={true} isLoading={isLoading} />\n      </div>\n\n      <Modal\n        boxClassName=\"max-w-md\"\n        isOpen={!!editingUser}\n        onClose={() => {\n          setEditingUser(null);\n        }}\n        title={`Editar Rol: ${editingUser ? getPersonFullName(editingUser.person) : \"\"}`}\n      >\n        <div className=\"mt-4 flex flex-col gap-4\">\n          <p className=\"text-base-content/70 text-sm\">\n            Selecciona el nuevo rol para el usuario. Esto actualizará sus permisos inmediatamente.\n          </p>\n\n          <div className=\"form-control\">\n            <label className=\"label\" htmlFor=\"role-select\">\n              <span className=\"label-text\">Rol asignado</span>\n            </label>\n            <select\n              className=\"select select-bordered w-full\"\n              id=\"role-select\"\n              onChange={(e) => {\n                setSelectedRole(e.target.value);\n              }}\n              value={selectedRole}\n            >\n              <option disabled value=\"\">\n                Seleccionar rol\n              </option>\n              {roles?.map((role: { name: string }) => (\n                <option key={role.name} value={role.name}>\n                  {role.name}\n                </option>\n              ))}\n            </select>\n          </div>\n\n          <div className=\"modal-action mt-6\">\n            <Button\n              onClick={() => {\n                setEditingUser(null);\n              }}\n              variant=\"ghost\"\n            >\n              Cancelar\n            </Button>\n            <Button\n              disabled={!selectedRole || selectedRole === editingUser?.role}\n              isLoading={updateUserMutation.isPending}\n              onClick={handleSaveRole}\n              variant=\"primary\"\n            >\n              Guardar cambios\n            </Button>\n          </div>\n        </div>\n      </Modal>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/users/queries.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/features/users/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/hooks/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/hooks/use-app-badge.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/hooks/use-async-state.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/hooks/use-can.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/hooks/use-column-visibility.ts","messages":[{"ruleId":"unicorn/no-array-reduce","severity":2,"message":"`Array#reduce()` is not allowed. Prefer other types of loop for readability.","line":12,"column":27,"nodeType":"Identifier","messageId":"reduce","endLine":12,"endColumn":33},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":13,"column":7,"nodeType":"MemberExpression","endLine":13,"endColumn":15},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":21,"column":18,"nodeType":"MemberExpression","endLine":21,"endColumn":30},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":43,"column":9,"nodeType":"MemberExpression","endLine":43,"endColumn":21},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":53,"column":9,"nodeType":"MemberExpression","endLine":53,"endColumn":21},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":60,"column":12,"nodeType":"MemberExpression","endLine":60,"endColumn":34}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\n\nexport type ColumnVisibility = Record<string, boolean>;\n\nexport interface UseColumnVisibilityOptions {\n  defaultVisible?: boolean;\n  initialColumns?: string[];\n}\n\nexport function useColumnVisibility({ defaultVisible = true, initialColumns = [] }: UseColumnVisibilityOptions = {}) {\n  const [visibleColumns, setVisibleColumns] = useState<ColumnVisibility>(() => {\n    return initialColumns.reduce<ColumnVisibility>((acc, col) => {\n      acc[col] = defaultVisible;\n      return acc;\n    }, {});\n  });\n\n  const toggleColumn = (column: string) => {\n    setVisibleColumns((prev) => ({\n      ...prev,\n      [column]: !prev[column],\n    }));\n  };\n\n  const showColumn = (column: string) => {\n    setVisibleColumns((prev) => ({\n      ...prev,\n      [column]: true,\n    }));\n  };\n\n  const hideColumn = (column: string) => {\n    setVisibleColumns((prev) => ({\n      ...prev,\n      [column]: false,\n    }));\n  };\n\n  const showAllColumns = () => {\n    setVisibleColumns((prev) => {\n      const updated = { ...prev };\n      for (const key of Object.keys(updated)) {\n        updated[key] = true;\n      }\n      return updated;\n    });\n  };\n\n  const hideAllColumns = () => {\n    setVisibleColumns((prev) => {\n      const updated = { ...prev };\n      for (const key of Object.keys(updated)) {\n        updated[key] = false;\n      }\n      return updated;\n    });\n  };\n\n  const isColumnVisible = (column: string) => {\n    return visibleColumns[column] ?? true;\n  };\n\n  const getVisibleColumns = (allColumns: string[]) => {\n    return allColumns.filter((col) => isColumnVisible(col));\n  };\n\n  return {\n    getVisibleColumns,\n    hideAllColumns,\n    hideColumn,\n    isColumnVisible,\n    showAllColumns,\n    showColumn,\n    toggleColumn,\n    visibleColumns,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/hooks/use-disclosure.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/hooks/use-file-upload.ts","messages":[{"ruleId":"@typescript-eslint/no-floating-promises","severity":2,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":44,"column":9,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":44,"endColumn":58,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[1394,1394],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[1394,1394],"text":"await "},"desc":"Add await operator."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { type QueryKey, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useState } from \"react\";\n\nimport { uploadFiles, type UploadResult } from \"@/lib/api-client\";\nimport { logger } from \"@/lib/logger\";\n\ntype FileValidator = (file: File) => Promise<{ headersCount: number; missing: string[] }>;\n\ninterface UseFileUploadOptions {\n  confirmOnValidationWarning?: boolean;\n  endpoint: string;\n  invalidateKeys?: QueryKey[];\n  logContext: string;\n  multiple?: boolean;\n  onUploadSuccess?: (results: UploadResult[]) => void;\n  validator?: FileValidator;\n}\n\nexport function useFileUpload({\n  confirmOnValidationWarning = true,\n  endpoint,\n  invalidateKeys = [],\n  logContext,\n  multiple = true,\n  onUploadSuccess,\n  validator,\n}: UseFileUploadOptions) {\n  const [files, setFiles] = useState<File[]>([]);\n  const [error, setError] = useState<null | string>(null);\n  const [results, setResults] = useState<UploadResult[]>([]);\n  const queryClient = useQueryClient();\n\n  const uploadMutation = useMutation<UploadResult[], Error, File[]>({\n    mutationFn: async (selectedFiles) => {\n      return uploadFiles(selectedFiles, endpoint, logContext);\n    },\n    onError: (err) => {\n      setError(err.message || \"Error al subir archivos\");\n    },\n    onSuccess: (uploadResults) => {\n      setResults(uploadResults);\n      setError(null);\n      for (const key of invalidateKeys) {\n        queryClient.invalidateQueries({ queryKey: key });\n      }\n      onUploadSuccess?.(uploadResults);\n    },\n  });\n\n  const handleUpload = async () => {\n    if (files.length === 0) {\n      setError(\"Selecciona uno o más archivos antes de subirlos.\");\n      return;\n    }\n    setError(null);\n    setResults([]);\n\n    try {\n      uploadMutation.reset();\n      await uploadMutation.mutateAsync(files);\n    } catch (error_) {\n      if (error_ instanceof Error) {\n        setError(error_.message);\n      } else {\n        setError(\"Error al subir archivos\");\n      }\n    }\n  };\n\n  const handleFileChange = async (event: React.ChangeEvent<HTMLInputElement>) => {\n    const selected = [...(event.target.files ?? [])];\n    reset();\n\n    if (selected.length === 0) {\n      setFiles([]);\n      return;\n    }\n\n    // Validación opcional de archivos\n    if (validator) {\n      const analyses = await Promise.all(selected.map(async (file) => ({ file, ...(await validator(file)) })));\n\n      const problematic = analyses.filter((item) => item.missing.length);\n      logger.info(\n        `${logContext} archivos seleccionados`,\n        analyses.map(({ file, headersCount, missing }) => ({\n          file: file.name,\n          headersCount,\n          missing,\n        }))\n      );\n\n      if (problematic.length > 0 && confirmOnValidationWarning) {\n        const message = problematic\n          .map(\n            ({ file, headersCount, missing }) =>\n              `${file.name}: faltan ${missing.join(\", \")} · columnas detectadas: ${headersCount}`\n          )\n          .join(\"\\n\");\n\n        const proceed = globalThis.confirm(\n          `Advertencia: algunos archivos no contienen todas las columnas esperadas.\\n\\n${message}\\n\\n¿Deseas continuar igualmente?`\n        );\n\n        if (!proceed) {\n          setFiles([]);\n          event.target.value = \"\";\n          return;\n        }\n      }\n    }\n\n    const firstFile = selected[0];\n    let newFiles: File[] = [];\n\n    if (multiple) {\n      newFiles = selected;\n    } else if (firstFile) {\n      newFiles = [firstFile];\n    }\n\n    setFiles(newFiles);\n  };\n\n  const reset = () => {\n    setFiles([]);\n    setError(null);\n    setResults([]);\n    uploadMutation.reset();\n  };\n\n  return {\n    error,\n    files,\n    handleFileChange,\n    handleUpload,\n    loading: uploadMutation.isPending,\n    reset,\n    results,\n    setFiles,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/hooks/use-job-progress.ts","messages":[{"ruleId":"@typescript-eslint/no-floating-promises","severity":2,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":63,"column":7,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":63,"endColumn":78,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[1898,1898],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[1898,1898],"text":"await "},"desc":"Add await operator."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useQueryClient, useSuspenseQuery } from \"@tanstack/react-query\";\nimport { useEffect, useState } from \"react\";\n\nimport { apiClient } from \"@/lib/api-client\";\n\nexport interface JobState {\n  error: null | string;\n  id: string;\n  message: string;\n  progress: number;\n  result: unknown;\n  status: \"completed\" | \"failed\" | \"pending\" | \"running\";\n  total: number;\n  type: string;\n}\n\ninterface UseJobProgressOptions {\n  onComplete?: (result: unknown) => void;\n  onError?: (error: string) => void;\n  /** Polling interval in ms (default: 500) */\n  pollInterval?: number;\n}\n\n/**\n * Hook to track background job progress via polling.\n * Automatically stops polling when job completes or fails.\n */\nexport function useJobProgress(jobId: null | string, options: UseJobProgressOptions = {}) {\n  const { onComplete, onError, pollInterval = 500 } = options;\n  const queryClient = useQueryClient();\n  const [hasNotified, setHasNotified] = useState(false);\n\n  const query = useSuspenseQuery({\n    queryFn: async () => {\n      if (!jobId) return null;\n      const response = await apiClient.get<{ job: JobState; status: string }>(`/api/calendar/events/job/${jobId}`);\n      if (response.status !== \"ok\") {\n        throw new Error(\"Failed to fetch job status\");\n      }\n      return response.job;\n    },\n    queryKey: [\"job-status\", jobId],\n\n    refetchInterval: (query) => {\n      const data = query.state.data;\n      // Stop polling when job is done\n      if (!data || data.status === \"completed\" || data.status === \"failed\") {\n        return;\n      }\n      return pollInterval;\n    },\n    staleTime: 0, // Always refetch\n  });\n\n  // Handle completion/error callbacks\n  useEffect(() => {\n    if (!query.data || hasNotified) return;\n\n    if (query.data.status === \"completed\") {\n      setHasNotified(true);\n      onComplete?.(query.data.result);\n      // Invalidate calendar queries to refresh the list\n      queryClient.invalidateQueries({ queryKey: [\"calendar-unclassified\"] });\n    } else if (query.data.status === \"failed\" && query.data.error) {\n      setHasNotified(true);\n      onError?.(query.data.error);\n    }\n  }, [query.data, hasNotified, onComplete, onError, queryClient]);\n\n  // Reset notification state when jobId changes\n  useEffect(() => {\n    setHasNotified(false);\n  }, [jobId]);\n\n  const reset = () => {\n    setHasNotified(false);\n  };\n\n  return {\n    isComplete: query.data?.status === \"completed\",\n    isFailed: query.data?.status === \"failed\",\n    isPolling: query.isFetching && query.data?.status === \"running\",\n    job: query.data,\n    progress: query.data ? Math.round((query.data.progress / query.data.total) * 100) : 0,\n    reset,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/hooks/use-pagination.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/hooks/use-performance-mode.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/hooks/use-push-notifications.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":12,"column":7,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":12,"endColumn":63},{"ruleId":"@typescript-eslint/no-floating-promises","severity":2,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":23,"column":7,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":23,"endColumn":27,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[817,817],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[817,817],"text":"await "},"desc":"Add await operator."}]},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":2,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":82,"column":53,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":82,"endColumn":69},{"ruleId":"@typescript-eslint/require-await","severity":2,"message":"Async arrow function 'sendTestNotification' has no 'await' expression.","line":118,"column":41,"nodeType":"ArrowFunctionExpression","messageId":"missingAwait","endLine":118,"endColumn":43,"suggestions":[{"messageId":"removeAsync","fix":{"range":[3561,3567],"text":""},"desc":"Remove 'async'."}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":140,"column":7,"nodeType":"MemberExpression","endLine":140,"endColumn":21}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMutation } from \"@tanstack/react-query\";\nimport { useEffect, useState } from \"react\";\n\nimport { useAuth } from \"@/context/AuthContext\";\nimport { useToast } from \"@/context/ToastContext\";\nimport {\n  sendTestNotification as sendTestNotificationApi,\n  subscribeToNotifications,\n  unsubscribeFromNotifications,\n} from \"@/features/notifications/api\";\n\nconst VAPID_PUBLIC_KEY = import.meta.env.VITE_VAPID_PUBLIC_KEY;\n\nexport function usePushNotifications() {\n  const [isSubscribed, setIsSubscribed] = useState(false);\n  const { error: toastError, success: toastSuccess } = useToast();\n  const [permission, setPermission] = useState<NotificationPermission>(\"default\");\n  const { user } = useAuth();\n\n  useEffect(() => {\n    if (\"Notification\" in globalThis) {\n      setPermission(Notification.permission);\n      checkSubscription();\n    }\n  }, []);\n\n  const checkSubscription = async () => {\n    if (\"serviceWorker\" in navigator) {\n      const registration = await navigator.serviceWorker.ready;\n      const subscription = await registration.pushManager.getSubscription();\n      setIsSubscribed(!!subscription);\n    }\n  };\n\n  const subscribeMutation = useMutation({\n    mutationFn: async (subscription: PushSubscription) => {\n      if (!user) throw new Error(\"No authenticated user\");\n      await subscribeToNotifications({\n        subscription,\n        userId: user.id,\n      });\n    },\n    onError: (error) => {\n      console.error(\"Error subscribing to push:\", error);\n      toastError(\"Error al activar notificaciones. Verifica los permisos del navegador.\");\n    },\n    onSuccess: () => {\n      setIsSubscribed(true);\n      setPermission(\"granted\");\n      toastSuccess(\"¡Notificaciones activadas!\");\n    },\n  });\n\n  const unsubscribeMutation = useMutation({\n    mutationFn: async (endpoint: string) => {\n      await unsubscribeFromNotifications({ endpoint });\n    },\n    onError: (error) => {\n      console.error(\"Error unsubscribing\", error);\n    },\n    onSuccess: () => {\n      setIsSubscribed(false);\n    },\n  });\n\n  const sendTestMutation = useMutation({\n    mutationFn: async () => {\n      if (!user) return;\n      await sendTestNotificationApi({ userId: user.id });\n    },\n    onError: (error) => {\n      console.error(\"Error sending test notification\", error);\n    },\n  });\n\n  const subscribeUser = async () => {\n    if (!user) return;\n\n    try {\n      const registration = await navigator.serviceWorker.ready;\n      const subscription = await registration.pushManager.subscribe({\n        applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),\n        userVisibleOnly: true,\n      });\n\n      subscribeMutation.mutate(subscription);\n    } catch (error) {\n      console.error(\"Error subscribing to push:\", error);\n      toastError(\"Error al activar notificaciones. Verifica los permisos del navegador.\");\n    }\n  };\n\n  const unsubscribeUser = async () => {\n    try {\n      const registration = await navigator.serviceWorker.ready;\n      const subscription = await registration.pushManager.getSubscription();\n      if (subscription) {\n        await subscription.unsubscribe();\n        unsubscribeMutation.mutate(subscription.endpoint);\n      }\n    } catch (error) {\n      console.error(\"Error unsubscribing\", error);\n    }\n  };\n\n  const toggleSubscription = async () => {\n    if (isSubscribed) {\n      await unsubscribeUser();\n    } else {\n      const perm = await Notification.requestPermission();\n      setPermission(perm);\n      if (perm === \"granted\") {\n        await subscribeUser();\n      }\n    }\n  };\n\n  const sendTestNotification = async () => {\n    sendTestMutation.mutate();\n  };\n\n  return {\n    isSubscribed,\n    loading: subscribeMutation.isPending || unsubscribeMutation.isPending || sendTestMutation.isPending,\n    permission,\n    sendTestNotification,\n    toggleSubscription,\n  };\n}\n\nfunction urlBase64ToUint8Array(base64String: string) {\n  try {\n    const padding = \"=\".repeat((4 - (base64String.length % 4)) % 4);\n    const base64 = (base64String + padding).replaceAll(\"-\", \"+\").replaceAll(\"_\", \"/\");\n\n    const rawData = globalThis.atob(base64);\n    const outputArray = new Uint8Array(rawData.length);\n\n    for (let i = 0; i < rawData.length; ++i) {\n      outputArray[i] = rawData.codePointAt(i) ?? 0;\n    }\n    return outputArray;\n  } catch (error) {\n    console.error(\"Error decoding VAPID key:\", error);\n    return new Uint8Array(0);\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/hooks/use-sorting.ts","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, comparison is always true, since `\"desc\" === \"desc\"` is true.","line":30,"column":20,"nodeType":"BinaryExpression","messageId":"comparisonBetweenLiteralTypes","endLine":30,"endColumn":45}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from \"react\";\n\nexport type SortDirection = \"asc\" | \"desc\";\n\nexport interface SortState<T = string> {\n  column: null | T;\n  direction: SortDirection;\n}\n\nexport interface UseSortingOptions<T> {\n  initialColumn?: null | T;\n  initialDirection?: SortDirection;\n}\n\nexport function useSorting<T extends string>({\n  initialColumn = null,\n  initialDirection = \"asc\",\n}: UseSortingOptions<T> = {}) {\n  const [sortState, setSortState] = useState<SortState<T>>({\n    column: initialColumn,\n    direction: initialDirection,\n  });\n\n  const sort = (column: T) => {\n    setSortState((prev) => {\n      if (prev.column === column) {\n        // Cycle: asc -> desc -> none\n        if (prev.direction === \"asc\") {\n          return { column, direction: \"desc\" };\n        } else if (prev.direction === \"desc\") {\n          return { column: null, direction: \"asc\" };\n        }\n      }\n      return { column, direction: \"asc\" };\n    });\n  };\n\n  const getSortIcon = (column: T): null | React.ReactElement => {\n    if (sortState.column !== column) return null;\n    const symbol = sortState.direction === \"asc\" ? \"▲\" : \"▼\";\n    return React.createElement(\"span\", { className: \"ml-1 text-xs opacity-60 align-middle select-none\" }, symbol);\n  };\n\n  const getSortProps = (column: T) => ({\n    onClick: () => {\n      sort(column);\n    },\n    style: { cursor: \"pointer\" },\n    title: `Ordenar por ${column}`,\n  });\n\n  return {\n    getSortIcon,\n    getSortProps,\n    sort,\n    sortState,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/hooks/use-table.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/hooks/use-wake-lock.ts","messages":[{"ruleId":"@typescript-eslint/no-floating-promises","severity":2,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":39,"column":5,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":39,"endColumn":23,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[1303,1303],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[1303,1303],"text":"await "},"desc":"Add await operator."}]},{"ruleId":"@typescript-eslint/no-floating-promises","severity":2,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":44,"column":9,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":44,"endColumn":39,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[1463,1463],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[1463,1463],"text":"await "},"desc":"Add await operator."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useRef, useState } from \"react\";\n\nexport function useWakeLock() {\n  const [isLocked, setIsLocked] = useState(false);\n  const wakeLockRef = useRef<null | WakeLockSentinel>(null);\n\n  useEffect(() => {\n    // Function to request wake lock\n    const requestWakeLock = async () => {\n      if (\"wakeLock\" in navigator) {\n        try {\n          const wakeLock = await navigator.wakeLock.request(\"screen\");\n          wakeLockRef.current = wakeLock;\n          setIsLocked(true);\n\n          // Re-acquire lock if visibility changes (e.g. tab switch)\n          document.addEventListener(\"visibilitychange\", handleVisibilityChange);\n\n          wakeLock.addEventListener(\"release\", () => {\n            setIsLocked(false);\n          });\n        } catch (error) {\n          // Ignore NotAllowedError as it's expected if user denies permission or tab is hidden\n          if ((error as Error).name !== \"NotAllowedError\") {\n            console.error(\n              `[WakeLock] Failed to acquire wake lock: ${(error as Error).name}, ${(error as Error).message}`\n            );\n          }\n        }\n      }\n    };\n\n    const handleVisibilityChange = async () => {\n      if (wakeLockRef.current !== null && document.visibilityState === \"visible\") {\n        await requestWakeLock();\n      }\n    };\n\n    requestWakeLock();\n\n    return () => {\n      document.removeEventListener(\"visibilitychange\", handleVisibilityChange);\n      if (wakeLockRef.current) {\n        wakeLockRef.current.release();\n        wakeLockRef.current = null;\n      }\n    };\n  }, []);\n\n  return { isLocked };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/hooks/usePagination.test.ts","messages":[{"ruleId":"check-file/filename-naming-convention","severity":2,"message":"The filename \"usePagination.test.ts\" does not match the \"KEBAB_CASE\" pattern","line":1,"column":1,"nodeType":"Program","messageId":"noMatch","endLine":91,"endColumn":1}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { act, renderHook } from \"@testing-library/react\";\nimport { describe, expect, it } from \"vitest\";\n\nimport { usePagination } from \"./use-pagination\";\n\ndescribe(\"use-pagination\", () => {\n  it(\"should initialize with default values\", () => {\n    const { result } = renderHook(() => usePagination());\n    expect(result.current.pagination.page).toBe(1);\n    expect(result.current.pagination.pageSize).toBe(25);\n  });\n\n  it(\"should initialize with custom values\", () => {\n    const { result } = renderHook(() => usePagination({ initialPage: 2, initialPageSize: 10 }));\n    expect(result.current.pagination.page).toBe(2);\n    expect(result.current.pagination.pageSize).toBe(10);\n  });\n\n  it(\"should go to next page\", () => {\n    const { result } = renderHook(() => usePagination());\n    act(() => {\n      result.current.nextPage();\n    });\n    expect(result.current.pagination.page).toBe(2);\n  });\n\n  it(\"should go to prev page\", () => {\n    const { result } = renderHook(() => usePagination({ initialPage: 2 }));\n    act(() => {\n      result.current.prevPage();\n    });\n    expect(result.current.pagination.page).toBe(1);\n  });\n\n  it(\"should not go below page 1\", () => {\n    const { result } = renderHook(() => usePagination({ initialPage: 1 }));\n    act(() => {\n      result.current.prevPage();\n    });\n    expect(result.current.pagination.page).toBe(1);\n  });\n\n  it(\"should set page directly\", () => {\n    const { result } = renderHook(() => usePagination());\n    act(() => {\n      result.current.setPage(5);\n    });\n    expect(result.current.pagination.page).toBe(5);\n  });\n\n  it(\"should reset to page 1 when changing page size\", () => {\n    const { result } = renderHook(() => usePagination({ initialPage: 5 }));\n    act(() => {\n      result.current.setPageSize(50);\n    });\n    expect(result.current.pagination.pageSize).toBe(50);\n    expect(result.current.pagination.page).toBe(1);\n  });\n\n  it(\"should calculate page info correctly\", () => {\n    const { result } = renderHook(() => usePagination({ initialPage: 1, initialPageSize: 10 }));\n    const info = result.current.getPageInfo(100);\n    expect(info.start).toBe(1);\n    expect(info.end).toBe(10);\n    expect(info.totalPages).toBe(10);\n    expect(info.total).toBe(100);\n  });\n\n  it(\"should calculate page info correctly for last page\", () => {\n    const { result } = renderHook(() => usePagination({ initialPage: 2, initialPageSize: 10 }));\n    const info = result.current.getPageInfo(15);\n    expect(info.start).toBe(11);\n    expect(info.end).toBe(15);\n    expect(info.totalPages).toBe(2);\n  });\n\n  it(\"should determine if can go next\", () => {\n    const { result } = renderHook(() => usePagination({ initialPage: 1, initialPageSize: 10 }));\n    expect(result.current.canGoNext(15)).toBe(true);\n    expect(result.current.canGoNext(10)).toBe(false);\n  });\n\n  it(\"should determine if can go prev\", () => {\n    const { result } = renderHook(() => usePagination({ initialPage: 2 }));\n    expect(result.current.canGoPrev()).toBe(true);\n\n    const { result: result2 } = renderHook(() => usePagination({ initialPage: 1 }));\n    expect(result2.current.canGoPrev()).toBe(false);\n  });\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/hooks/useSorting.test.ts","messages":[{"ruleId":"check-file/filename-naming-convention","severity":2,"message":"The filename \"useSorting.test.ts\" does not match the \"KEBAB_CASE\" pattern","line":1,"column":1,"nodeType":"Program","messageId":"noMatch","endLine":55,"endColumn":1}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { act, renderHook } from \"@testing-library/react\";\nimport { describe, expect, it } from \"vitest\";\n\nimport { useSorting } from \"./use-sorting\";\n\ndescribe(\"use-sorting\", () => {\n  it(\"should initialize with default values\", () => {\n    const { result } = renderHook(() => useSorting());\n    expect(result.current.sortState.column).toBeNull();\n    expect(result.current.sortState.direction).toBe(\"asc\");\n  });\n\n  it(\"should initialize with custom values\", () => {\n    const { result } = renderHook(() => useSorting({ initialColumn: \"name\", initialDirection: \"desc\" }));\n    expect(result.current.sortState.column).toBe(\"name\");\n    expect(result.current.sortState.direction).toBe(\"desc\");\n  });\n\n  it(\"should sort by a column (asc default)\", () => {\n    const { result } = renderHook(() => useSorting());\n    act(() => {\n      result.current.sort(\"name\");\n    });\n    expect(result.current.sortState.column).toBe(\"name\");\n    expect(result.current.sortState.direction).toBe(\"asc\");\n  });\n\n  it(\"should toggle direction if sorting by same column\", () => {\n    const { result } = renderHook(() => useSorting({ initialColumn: \"name\", initialDirection: \"asc\" }));\n    act(() => {\n      result.current.sort(\"name\");\n    });\n    expect(result.current.sortState.column).toBe(\"name\");\n    expect(result.current.sortState.direction).toBe(\"desc\");\n  });\n\n  it(\"should clear sort if toggling from desc\", () => {\n    const { result } = renderHook(() => useSorting({ initialColumn: \"name\", initialDirection: \"desc\" }));\n    act(() => {\n      result.current.sort(\"name\");\n    });\n    expect(result.current.sortState.column).toBeNull();\n    expect(result.current.sortState.direction).toBe(\"asc\"); // Reset to default\n  });\n\n  it(\"should switch column and reset to asc\", () => {\n    const { result } = renderHook(() => useSorting<string>({ initialColumn: \"name\", initialDirection: \"desc\" }));\n    act(() => {\n      result.current.sort(\"age\");\n    });\n    expect(result.current.sortState.column).toBe(\"age\");\n    expect(result.current.sortState.direction).toBe(\"asc\");\n  });\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/i18n.ts","messages":[{"ruleId":"unicorn/prefer-top-level-await","severity":2,"message":"Prefer top-level await over using a promise chain.","line":18,"column":4,"nodeType":"Identifier","messageId":"promise","endLine":18,"endColumn":9},{"ruleId":"@typescript-eslint/use-unknown-in-catch-callback-variable","severity":2,"message":"Prefer the safe `: unknown` for a `catch` callback variable.","line":18,"column":11,"nodeType":"Identifier","messageId":"useUnknown","endLine":18,"endColumn":16,"suggestions":[{"messageId":"addUnknownTypeAnnotationSuggestion","fix":{"range":[403,403],"text":": unknown"},"desc":"Add an explicit `: unknown` type annotation to the rejection callback variable."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import i18n from \"i18next\";\nimport { initReactI18next } from \"react-i18next\";\n\nimport en from \"./locales/en/translation.json\";\nimport es from \"./locales/es/translation.json\";\n\ni18n\n  .use(initReactI18next)\n  .init({\n    fallbackLng: \"es\",\n    interpolation: { escapeValue: false },\n    lng: \"es\",\n    resources: {\n      en: { translation: en },\n      es: { translation: es },\n    },\n  })\n  .catch((error) => {\n    console.error(\"[i18n] init error\", error);\n  });\n\nexport { default } from \"i18next\";\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/lib/api-client.ts","messages":[{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"'rawValue' will use Object's default stringification format ('[object Object]') when stringified.","line":40,"column":31,"nodeType":"Identifier","messageId":"baseToString","endLine":40,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":61,"column":9,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":61,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":82,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":82,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":2,"message":"Unsafe argument of type `any` assigned to a parameter of type `SuperJSONResult`.","line":84,"column":36,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":84,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":2,"message":"Unsafe return of a value of type `any`.","line":86,"column":5,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":86,"endColumn":21},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":111,"column":82,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":111,"endColumn":84,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[3056,3058],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import ky, { HTTPError, Options } from \"ky\";\nimport superjson from \"superjson\";\nimport { z } from \"zod\";\n\nimport { logger } from \"./logger\";\n\ninterface ErrorData {\n  details?: unknown;\n  error?: string;\n  issues?: unknown;\n  message?: string;\n}\n\nexport class ApiError extends Error {\n  details?: unknown;\n  status: number;\n\n  constructor(message: string, status: number, details?: unknown) {\n    super(message);\n    this.name = \"ApiError\";\n    this.status = status;\n    this.details = details;\n  }\n}\n\n// Helper for building query strings with custom array handling (preserved for safety)\nfunction buildUrlWithQuery(url: string, query?: Record<string, unknown>) {\n  if (!query) return url;\n\n  const params = new URLSearchParams();\n  for (const [key, rawValue] of Object.entries(query)) {\n    if (rawValue === undefined || rawValue === null) continue;\n    if (Array.isArray(rawValue)) {\n      for (const value of rawValue) {\n        if (value === undefined || value === null) continue;\n        params.append(key, String(value));\n      }\n      continue;\n    }\n    params.append(key, String(rawValue));\n  }\n\n  const queryString = params.toString();\n  if (!queryString) return url;\n\n  return url.includes(\"?\") ? `${url}&${queryString}` : `${url}?${queryString}`;\n}\n\n// Custom hook to transform Ky errors into ApiError\nasync function handleKyError(error: HTTPError) {\n  const response = error.response;\n  const status = response.status;\n  let serverMessage = response.statusText;\n  let details: unknown;\n\n  try {\n    const rawBody = await response.text();\n    if (rawBody) {\n      let errorData: ErrorData | null = null;\n      try {\n        errorData = JSON.parse(rawBody);\n      } catch {\n        // If not JSON, treat body as simple message\n        errorData = { message: rawBody };\n      }\n\n      if (errorData) {\n        serverMessage = errorData.message ?? errorData.error ?? serverMessage;\n        details = errorData.details ?? errorData.issues;\n      }\n    }\n  } catch {\n    // Ignore body read errors\n  }\n\n  return new ApiError(serverMessage || \"Ocurrió un error inesperado.\", status, details);\n}\n\n// SuperJSON Parser\nconst superJsonParser = (text: string) => {\n  try {\n    const jsonData = JSON.parse(text);\n    if (jsonData && typeof jsonData === \"object\" && \"json\" in jsonData) {\n      return superjson.deserialize(jsonData);\n    }\n    return jsonData;\n  } catch {\n    return text;\n  }\n};\n\nconst kyInstance = ky.create({\n  credentials: \"include\", // CRITICAL: Send cookies with every request\n  parseJson: superJsonParser,\n  retry: {\n    limit: 2,\n    methods: [\"get\", \"put\", \"head\", \"delete\", \"options\", \"trace\"],\n    statusCodes: [408, 413, 429, 500, 502, 503, 504],\n  },\n  timeout: 30_000,\n});\n\ninterface RequestOptions extends Omit<RequestInit, \"body\"> {\n  body?: object;\n  query?: Record<string, unknown>;\n  responseType?: \"blob\" | \"json\" | \"text\";\n  retry?: number;\n}\n\nasync function request<T>(method: string, url: string, options?: RequestOptions): Promise<T> {\n  const { body, query, responseType = \"json\", retry, ...fetchOptions } = options || {};\n\n  const finalUrl = buildUrlWithQuery(url, query);\n\n  // Ky specific options\n  const kyOptions: Options = {\n    method,\n    retry,\n    ...fetchOptions,\n  };\n\n  if (body) {\n    if (body instanceof FormData) {\n      kyOptions.body = body;\n    } else {\n      kyOptions.json = body;\n    }\n  }\n\n  try {\n    const res = await kyInstance(finalUrl, kyOptions);\n\n    if (responseType === \"blob\") {\n      return (await res.blob()) as unknown as T;\n    }\n\n    if (responseType === \"text\") {\n      return (await res.text()) as unknown as T;\n    }\n\n    // responseType === 'json' (default)\n    // kyInstance already has parseJson configured for superjson\n    return await res.json<T>();\n  } catch (error) {\n    if (error instanceof HTTPError) {\n      throw await handleKyError(error);\n    }\n    throw error;\n  }\n}\n\nexport const apiClient = {\n  delete: <T>(url: string, options?: RequestOptions) => request<T>(\"DELETE\", url, options),\n  get: <T>(url: string, options?: RequestOptions) => request<T>(\"GET\", url, options),\n  post: <T>(url: string, body: object, options?: RequestOptions) => request<T>(\"POST\", url, { ...options, body }),\n  put: <T>(url: string, body: object, options?: RequestOptions) => request<T>(\"PUT\", url, { ...options, body }),\n};\n\n// Upload Files - simplified with Ky\nconst UploadSummarySchema = z.object({\n  inserted: z.number(),\n  skipped: z.number().optional(),\n  status: z.string(),\n  total: z.number(),\n  updated: z.number().optional(),\n});\n\nconst ApiResponseSchema = UploadSummarySchema.extend({\n  message: z.string().optional(),\n});\n\nexport interface UploadResult {\n  error?: string;\n  file: string;\n  summary?: UploadSummary;\n}\nexport type UploadSummary = z.infer<typeof UploadSummarySchema>;\n\nexport async function uploadFiles(files: File[], endpoint: string, logContext: string): Promise<UploadResult[]> {\n  const aggregated: UploadResult[] = [];\n\n  for (const file of files) {\n    const formData = new FormData();\n    formData.append(\"file\", file);\n\n    try {\n      logger.info(`${logContext} envío archivo`, { file: file.name, size: file.size });\n\n      const res = await kyInstance.post(endpoint, {\n        body: formData,\n        timeout: false,\n      });\n\n      const json = await res.json();\n      const payload = ApiResponseSchema.parse(json);\n\n      if (payload.status === \"error\") {\n        throw new Error(payload.message ?? \"Error status returned\");\n      }\n\n      logger.info(`${logContext} archivo procesado`, { file: file.name, ...payload });\n      aggregated.push({ file: file.name, summary: payload });\n    } catch (error) {\n      const message = error instanceof Error ? error.message : \"Error inesperado al subir\";\n      aggregated.push({ error: message, file: file.name });\n      logger.error(`${logContext} archivo falló`, { file: file.name, message });\n    }\n  }\n  return aggregated;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/lib/authz/AbilityProvider.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Move your React context(s) to a separate file.","line":9,"column":14,"nodeType":"Identifier","messageId":"reactContext","endLine":9,"endColumn":28},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":16,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":16,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/lib/authz/AbilityProvider.tsx\n\nimport { MongoAbility } from \"@casl/ability\";\nimport { createContextualCan } from \"@casl/react\";\nimport React, { createContext } from \"react\";\n\nimport { ability } from \"./ability\";\n\nexport const AbilityContext = createContext<MongoAbility>(ability);\nexport const Can = createContextualCan(AbilityContext.Consumer);\n\nexport const AbilityProvider = ({ children }: { children: React.ReactNode }) => {\n  return <AbilityContext.Provider value={ability}>{children}</AbilityContext.Provider>;\n};\n\nexport const useAbility = () => React.useContext(AbilityContext);\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/lib/authz/ability.ts","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":9,"column":7,"nodeType":"Identifier","messageId":"alwaysTruthy","endLine":9,"endColumn":12}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { AbilityBuilder, createMongoAbility, MongoAbility, RawRuleOf } from \"@casl/ability\";\n\nexport type AppAbility = MongoAbility;\n\nexport const ability = createMongoAbility();\n\nexport function updateAbility(rules: RawRuleOf<AppAbility>[]) {\n  const { can, rules: newRules } = new AbilityBuilder(createMongoAbility);\n  if (rules) {\n    for (const rule of rules) {\n      can(rule.action, rule.subject as string, rule.conditions);\n    }\n  }\n  ability.update(newRules);\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/lib/dates.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/lib/format.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/lib/format.ts","messages":[{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"'v' will use Object's default stringification format ('[object Object]') when stringified.","line":38,"column":20,"nodeType":"Identifier","messageId":"baseToString","endLine":38,"endColumn":21},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always falsy.","line":52,"column":7,"nodeType":"UnaryExpression","messageId":"alwaysFalsy","endLine":52,"endColumn":9},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always falsy.","line":74,"column":7,"nodeType":"UnaryExpression","messageId":"alwaysFalsy","endLine":74,"endColumn":9}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Decimal } from \"decimal.js\";\n\n// === CURRENCY FORMATTING ===\n\nexport const fmtCLP = (n?: Decimal | null | number | string) => {\n  // Handle null/undefined\n  if (n == null) return \"$0\";\n\n  // Convert string or Decimal to number\n  let num: number;\n  if (typeof n === \"object\" && Decimal.isDecimal(n)) {\n    num = n.toNumber();\n  } else if (typeof n === \"string\") {\n    num = Number(n);\n  } else {\n    num = n;\n  }\n\n  // Handle NaN or non-finite numbers\n  if (!Number.isFinite(num)) return \"$0\";\n\n  try {\n    return new Intl.NumberFormat(\"es-CL\", {\n      currency: \"CLP\",\n      maximumFractionDigits: 0,\n      style: \"currency\",\n    }).format(num);\n  } catch (error) {\n    // Fallback if formatting fails\n    console.error(\"Error formatting currency:\", error, \"value:\", n);\n    return \"$0\";\n  }\n};\n\nexport const coerceAmount = (v?: unknown): number => {\n  if (v == null) return 0;\n  if (typeof v === \"number\") return v;\n  const s = String(v)\n    .replaceAll(\"$\", \"\")\n    .replaceAll(\".\", \"\")\n    .replaceAll(/\\s/g, \"\")\n    .replaceAll(/CLP/gi, \"\")\n    .replaceAll(\",\", \".\");\n  const n = Number(s);\n  return Number.isFinite(n) ? n : 0;\n};\n\n// === DATE/TIME FORMATTING ===\n\nexport function formatDate(date: Date | string, options?: Intl.DateTimeFormatOptions): string {\n  const d = typeof date === \"string\" ? new Date(date) : date;\n  if (!d || Number.isNaN(d.getTime())) return \"-\";\n\n  return new Intl.DateTimeFormat(\"es-CL\", {\n    day: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n    ...options,\n  }).format(d);\n}\n\nexport function formatDateTime(date: Date | string): string {\n  return formatDate(date, {\n    day: \"2-digit\",\n    hour: \"2-digit\",\n    minute: \"2-digit\",\n    month: \"2-digit\",\n    year: \"numeric\",\n  });\n}\n\nexport function formatRelativeDate(date: Date | string): string {\n  const d = typeof date === \"string\" ? new Date(date) : date;\n  if (!d || Number.isNaN(d.getTime())) return \"-\";\n\n  const now = new Date();\n  const diffMs = now.getTime() - d.getTime();\n  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));\n\n  if (diffDays === 0) return \"Hoy\";\n  if (diffDays === 1) return \"Ayer\";\n  if (diffDays < 7) return `Hace ${diffDays} días`;\n  if (diffDays < 30) return `Hace ${Math.floor(diffDays / 7)} semanas`;\n  if (diffDays < 365) return `Hace ${Math.floor(diffDays / 30)} meses`;\n  return `Hace ${Math.floor(diffDays / 365)} años`;\n}\n\n// === DURATION FORMATTING ===\n\nexport { formatFileSize } from \"../../shared/format\";\n\n// === NUMERIC FORMATTING ===\n\n/** Shared number formatter instance (es-CL locale) */\nexport const numberFormatter = new Intl.NumberFormat(\"es-CL\");\n\n/** Shared currency formatter instance (CLP, no decimals) */\nexport const currencyFormatter = new Intl.NumberFormat(\"es-CL\", {\n  currency: \"CLP\",\n  maximumFractionDigits: 0,\n  style: \"currency\",\n});\n\n/** Safe wrapper for currency formatting that handles null/undefined/invalid values */\nexport function formatCurrency(value?: Decimal | null | number | string): string {\n  if (value == null) return \"$0\";\n\n  let num: number;\n  if (typeof value === \"object\" && Decimal.isDecimal(value)) {\n    num = value.toNumber();\n  } else if (typeof value === \"string\") {\n    num = Number(value);\n  } else {\n    num = value;\n  }\n\n  if (!Number.isFinite(num)) return \"$0\";\n\n  try {\n    return currencyFormatter.format(num);\n  } catch (error) {\n    console.error(\"Error formatting currency:\", error, \"value:\", value);\n    return \"$0\";\n  }\n}\n\nexport function formatNumber(value: number, options?: Intl.NumberFormatOptions): string {\n  if (!Number.isFinite(value)) return \"-\";\n  return new Intl.NumberFormat(\"es-CL\", options).format(value);\n}\n\nexport function formatPercentage(value: number, decimals = 1): string {\n  if (!Number.isFinite(value)) return \"-\";\n  return `${value.toFixed(decimals)}%`;\n}\n\n// === FILE SIZE FORMATTING ===\n\nexport { durationToMinutes, minutesToDuration, minutesToTime, parseTimeToMinutes } from \"~/shared/time\";\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/lib/logger.ts","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-type-conversion","severity":2,"message":"Passing a boolean to Boolean() does not change the type or value of the boolean.","line":9,"column":15,"nodeType":"Identifier","messageId":"unnecessaryTypeConversion","endLine":9,"endColumn":22,"suggestions":[{"messageId":"suggestRemove","fix":{"range":[207,236],"text":"(import.meta.env?.DEV)"},"desc":"Remove the type conversion."},{"messageId":"suggestSatisfies","data":{"type":"boolean"},"fix":{"range":[207,236],"text":"(import.meta.env?.DEV) satisfies boolean"},"desc":"Instead, assert that the value satisfies the boolean type."}]},{"ruleId":"turbo/no-undeclared-env-vars","severity":2,"message":"DEV is not listed as a dependency in turbo.json","line":9,"column":23,"nodeType":"MemberExpression","endLine":9,"endColumn":43},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":9,"column":38,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":9,"endColumn":40,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[230,232],"text":"."},"desc":"Remove unnecessary optional chain"}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Lightweight Logger for Browser\n *\n * Zero-dependency logger with environment-aware levels.\n * In production: only warn and error are shown.\n * In development: all levels are shown.\n */\n\nconst isDev = Boolean(import.meta.env?.DEV);\n\ntype LogMethod = (...args: unknown[]) => void;\n\n/**\n * Create a namespaced logger\n */\nexport function createLogger(namespace?: string) {\n  const prefix = namespace ? `[${namespace}]` : \"\";\n\n  const withPrefix = (fn: LogMethod): LogMethod => {\n    return (...args: unknown[]) => {\n      if (prefix) {\n        fn(prefix, ...args);\n      } else {\n        fn(...args);\n      }\n    };\n  };\n\n  return {\n    debug: createMethod(withPrefix(console.debug)),\n    error: createMethod(withPrefix(console.error), true), // Always show in prod\n    info: createMethod(withPrefix(console.info)),\n    log: createMethod(withPrefix(console.log)),\n    warn: createMethod(withPrefix(console.warn), true), // Always show in prod\n  };\n}\n\nfunction createMethod(fn: LogMethod, showInProd = false): LogMethod {\n  return (...args: unknown[]) => {\n    if (isDev || showInProd) {\n      fn(...args);\n    }\n  };\n}\n\n// Default logger instance\nexport const logger = createLogger();\n\n// Convenience exports\nexport const { debug, error, info, log, warn } = logger;\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/lib/nav-generator.ts","messages":[{"ruleId":"sonarjs/no-misleading-array-reverse","severity":2,"message":"Move this array \"sort\" operation to a separate statement or replace it with \"toSorted\".","line":99,"column":25,"nodeType":"CallExpression","messageId":"moveMethod","endLine":100,"endColumn":41,"suggestions":[{"messageId":"suggestMethod","data":{"suggestedMethod":"toSorted"},"fix":{"range":[2104,2108],"text":"toSorted"},"desc":"Replace with \"toSorted\" method"}]},{"ruleId":"unicorn/no-array-sort","severity":2,"message":"Use `Array#toSorted()` instead of `Array#sort()`.","line":100,"column":8,"nodeType":"Identifier","messageId":"error","endLine":100,"endColumn":12,"suggestions":[{"messageId":"suggestion-apply-replacement","fix":{"range":[2104,2108],"text":"toSorted"},"data":{},"desc":"Switch to `.toSorted()`."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .options on an `any` value.","line":127,"column":13,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":127,"endColumn":20},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .options on an `any` value.","line":128,"column":23,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":128,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .options on an `any` value.","line":129,"column":30,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":129,"endColumn":37},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":135,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":135,"endColumn":51},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .fullPath on an `any` value.","line":135,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":135,"endColumn":30},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":135,"column":31,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":135,"endColumn":33,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[3357,3385],"text":"(route.fullPath ?? route.path)"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .path on an `any` value.","line":135,"column":40,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":135,"endColumn":44},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??`) instead of a logical or (`||`), as it is a safer operator.","line":135,"column":45,"nodeType":"Punctuator","messageId":"preferNullishOverOr","endLine":135,"endColumn":47,"suggestions":[{"messageId":"suggestNullish","data":{"equals":""},"fix":{"range":[3386,3388],"text":"??"},"desc":"Fix to nullish coalescing operator (`??`)."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":138,"column":7,"nodeType":"Property","messageId":"anyAssignment","endLine":138,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .options on an `any` value.","line":138,"column":20,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":138,"endColumn":27},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":144,"column":7,"nodeType":"Property","messageId":"anyAssignment","endLine":144,"endColumn":13},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .children on an `any` value.","line":149,"column":13,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":149,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":2,"message":"Unsafe call of an `any` typed value.","line":151,"column":5,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":151,"endColumn":27},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .children on an `any` value.","line":151,"column":11,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":151,"endColumn":19},{"ruleId":"unicorn/no-array-for-each","severity":2,"message":"Use `for…of` instead of `.forEach(…)`.","line":151,"column":20,"nodeType":"Identifier","messageId":"no-array-for-each/error","endLine":151,"endColumn":27},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??=`) instead of an assignment expression, as it is simpler to read.","line":162,"column":3,"nodeType":"IfStatement","messageId":"preferNullishOverAssignment","endLine":164,"endColumn":4,"suggestions":[{"messageId":"suggestNullish","data":{"equals":"="},"fix":{"range":[3996,4066],"text":"cachedSections ??= generateNavSections();"},"desc":"Fix to nullish coalescing operator (`??=`)."}]}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":122,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":122,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2647,2650],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2647,2650],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":151,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":151,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3801,3804],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3801,3804],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":18,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\n  BarChart3,\n  Box,\n  Briefcase,\n  Calendar,\n  CalendarDays,\n  ClipboardCheck,\n  Clock,\n  CreditCard,\n  Database,\n  FileSpreadsheet,\n  History,\n  Home,\n  LayoutDashboard,\n  ListChecks,\n  PackagePlus,\n  PiggyBank,\n  Settings2,\n  Upload,\n  UserCog,\n  Users,\n  Users2,\n  Wallet,\n} from \"lucide-react\";\nimport type { ComponentType } from \"react\";\n\nimport type { NavConfig, NavSection, RoutePermission } from \"@/types/navigation\";\n\n// Generated file\nimport { routeTree } from \"../routeTree.gen\";\n\n// Reuse NavItem interface from original generator to stay compatible with Sidebar\nexport interface NavItem {\n  exact?: boolean;\n  icon: ComponentType<{ className?: string; strokeWidth?: number }>;\n  label: string;\n  requiredPermission?: RoutePermission;\n  to: string;\n}\n\nexport interface NavSectionData {\n  items: NavItem[];\n  title: string;\n}\n\nconst ICON_MAP: Record<string, ComponentType<{ className?: string; strokeWidth?: number }>> = {\n  Box,\n  Briefcase,\n  BarChart3,\n  Calendar,\n  CalendarDays,\n  ClipboardCheck,\n  Clock,\n  CreditCard,\n  Database,\n  FileSpreadsheet,\n  History,\n  Home,\n  LayoutDashboard,\n  ListChecks,\n  PackagePlus,\n  PiggyBank,\n  Settings2,\n  Upload,\n  UserCog,\n  Users,\n  Users2,\n  Wallet,\n};\n\nconst SECTION_ORDER: NavSection[] = [\"Calendario\", \"Finanzas\", \"Servicios\", \"Operaciones\", \"Sistema\"];\n\ninterface ExtractedNavItem extends Omit<NavItem, \"icon\"> {\n  iconKey: string;\n  order: number;\n  section: NavSection;\n}\n\nexport function generateNavSections(): NavSectionData[] {\n  const extractedItems = extractNavItems(routeTree);\n\n  // Group by section\n  const sectionMap = new Map<NavSection, ExtractedNavItem[]>();\n\n  for (const item of extractedItems) {\n    const existing = sectionMap.get(item.section) ?? [];\n    existing.push(item);\n    sectionMap.set(item.section, existing);\n  }\n\n  // Build sections in defined order\n  const sections: NavSectionData[] = [];\n\n  for (const sectionName of SECTION_ORDER) {\n    const items = sectionMap.get(sectionName);\n    if (!items?.length) continue;\n\n    // Sort by order and convert to NavItem\n    const sortedItems = items\n      .sort((a, b) => a.order - b.order)\n      .map(\n        (item): NavItem => ({\n          exact: item.exact,\n          icon: ICON_MAP[item.iconKey] ?? Box,\n          label: item.label,\n          requiredPermission: item.requiredPermission,\n          to: item.to,\n        })\n      );\n\n    sections.push({\n      items: sortedItems,\n      title: sectionName,\n    });\n  }\n\n  return sections;\n}\n\n// Any type needed because Route type is complex and generic\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction extractNavItems(route: any): ExtractedNavItem[] {\n  const items: ExtractedNavItem[] = [];\n\n  // Check if current route has nav data\n  // TanStack router adds options to the route object\n  if (route.options?.staticData?.nav) {\n    const nav = route.options.staticData.nav as NavConfig;\n    const permission = route.options.staticData.permission as RoutePermission | undefined;\n\n    // Using route.fullPath or route.to for the link\n    // routeTree nodes usually have fullPath available if flattened or built correctly\n    // If not, we might need to rely on the \"path\" and build it up, but generated tree usually has fullPath\n    // Let's assume for now route.fullPath exists on the plain object structure from .gen.ts\n    const to = route.fullPath || route.path || \"/\";\n\n    items.push({\n      exact: route.options.exact, // Assuming exact might be in options\n      iconKey: nav.iconKey,\n      label: nav.label,\n      order: nav.order,\n      requiredPermission: permission,\n      section: nav.section,\n      to: to,\n    });\n  }\n\n  // Process children\n  if (route.children) {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    route.children.forEach((child: any) => {\n      items.push(...extractNavItems(child));\n    });\n  }\n\n  return items;\n}\n\nlet cachedSections: NavSectionData[] | null = null;\n\nexport function getNavSections(): NavSectionData[] {\n  if (!cachedSections) {\n    cachedSections = generateNavSections();\n  }\n  return cachedSections;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/lib/performance.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/lib/person.ts","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":91,"column":25,"nodeType":"ChainExpression","messageId":"neverNullish","endLine":91,"endColumn":62},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":91,"column":47,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":91,"endColumn":49,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[3012,3014],"text":"."},"desc":"Remove unnecessary optional chain"}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Person utility helpers for safe and consistent name handling\n */\n\nexport interface PersonNameData {\n  fatherName?: null | string;\n  motherName?: null | string;\n  names?: null | string;\n}\n\n/**\n * Extract person from API response that wraps it\n * Handles both { person: {...} } and direct person object\n */\nexport function extractPersonFromResponse<T extends Record<string, unknown>>(\n  response: null | T | undefined\n): null | (T extends { person: infer P } ? P : T) {\n  if (!response) return null;\n  if (\"person\" in response && response.person !== undefined && response.person !== null) {\n    return response.person as T extends { person: infer P } ? P : T;\n  }\n  return response as T extends { person: infer P } ? P : T;\n}\n\n/**\n * Safe person name formatter for display\n * Shows full name or components based on availability\n */\nexport function formatPersonDisplay(person?: null | PersonNameData): string {\n  const fullName = getPersonFullName(person);\n  return fullName || \"No identificado\";\n}\n\n/**\n * Get complete person name by combining names + father name + mother name\n * Safe: returns empty string if person is null/undefined\n * Smart: avoids duplicating surnames if they're already in the names field\n */\nexport function getPersonFullName(person?: null | PersonNameData): string {\n  if (!person) return \"\";\n\n  const names = person.names?.trim() ?? \"\";\n  if (!names) return \"\";\n\n  const fatherName = person.fatherName?.trim() ?? \"\";\n  const motherName = person.motherName?.trim() ?? \"\";\n\n  // If both surnames are already in names, just return names (avoids \"Pulgar Escobar Pulgar Escobar\")\n  const namesLower = names.toLowerCase();\n  const hasFatherName = fatherName && namesLower.includes(fatherName.toLowerCase());\n  const hasMotherName = motherName && namesLower.includes(motherName.toLowerCase());\n\n  if (hasFatherName && hasMotherName) {\n    return names;\n  }\n\n  // If only father name is in names, don't add it again\n  if (hasFatherName) {\n    const parts = [names, motherName].filter(Boolean);\n    return parts.join(\" \");\n  }\n\n  // If only mother name is in names, don't add it again\n  if (hasMotherName) {\n    const parts = [names, fatherName].filter(Boolean);\n    return parts.join(\" \");\n  }\n\n  // Otherwise, build full name from all parts\n  const parts = [names, fatherName, motherName].filter(Boolean);\n  return parts.join(\" \");\n}\n\n/**\n * Get initials for avatar placeholder (2 characters max)\n * Safe: returns \"?\" if names is null/undefined\n */\nexport function getPersonInitials(person?: null | PersonNameData): string {\n  if (!person?.names) return \"?\";\n\n  // Try to get first char of first name + first char of last name\n  const firstInitial = person.names.charAt(0).toUpperCase();\n\n  // Prefer father name as \"last name\" for initials\n  if (person.fatherName) {\n    const fatherInitial = person.fatherName.charAt(0).toUpperCase();\n    return `${firstInitial}${fatherInitial}`;\n  }\n\n  // If no father name, use second char of first name\n  const secondInitial = person.names.charAt(1)?.toUpperCase() ?? \"\";\n  return secondInitial ? `${firstInitial}${secondInitial}` : firstInitial;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/lib/query-keys.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/lib/rut.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/lib/rut.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/lib/styles.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/lib/utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/main.tsx","messages":[{"ruleId":"check-file/filename-naming-convention","severity":2,"message":"The filename \"main.tsx\" does not match the \"PASCAL_CASE\" pattern","line":8,"column":1,"nodeType":"Program","messageId":"noMatch","endLine":169,"endColumn":1},{"ruleId":"@typescript-eslint/no-floating-promises","severity":2,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":63,"column":5,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":63,"endColumn":28,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[2398,2398],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[2398,2398],"text":"await "},"desc":"Add await operator."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":2,"message":"Unsafe assignment of an `any` value.","line":68,"column":9,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":68,"endColumn":64},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .message on an `any` value.","line":68,"column":33,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":68,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":2,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":69,"column":106,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":69,"endColumn":113},{"ruleId":"@typescript-eslint/no-floating-promises","severity":2,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":71,"column":5,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":71,"endColumn":28,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[2708,2708],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[2708,2708],"text":"await "},"desc":"Add await operator."}]},{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":100,"column":11,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":100,"endColumn":21},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file has exports. Move your component(s) to a separate file.","line":121,"column":10,"nodeType":"Identifier","messageId":"noExport","endLine":121,"endColumn":18},{"ruleId":"turbo/no-undeclared-env-vars","severity":2,"message":"NODE_ENV is not listed as a dependency in turbo.json","line":129,"column":3,"nodeType":"MemberExpression","endLine":129,"endColumn":23},{"ruleId":"@typescript-eslint/no-non-null-assertion","severity":2,"message":"Forbidden non-null assertion.","line":145,"column":21,"nodeType":"TSNonNullExpression","messageId":"noNonNull","endLine":145,"endColumn":53}],"suppressedMessages":[],"errorCount":9,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Application Entry Point\n *\n * MIGRATION NOTE: This file now uses TanStack Router for routing.\n * The old React Router v7 routes have been migrated to file-based routing in src/routes/.\n */\n\nimport { QueryClient, QueryClientProvider } from \"@tanstack/react-query\";\nimport { createRouter, RouterProvider } from \"@tanstack/react-router\";\nimport { QuerySettingsProvider } from \"@zenstackhq/tanstack-query/react\";\nimport React from \"react\";\nimport ReactDOM from \"react-dom/client\";\n\nimport { ChunkErrorBoundary } from \"./components/ui/ChunkErrorBoundary\";\nimport { GlobalError } from \"./components/ui/GlobalError\";\nimport PageLoader from \"./components/ui/PageLoader\";\nimport { AuthProvider, useAuth } from \"./context/AuthContext\";\nimport { SettingsProvider } from \"./context/SettingsContext\";\nimport { ToastProvider } from \"./context/ToastContext\";\nimport { AbilityProvider } from \"./lib/authz/AbilityProvider\";\nimport { createLogger } from \"./lib/logger\";\nimport { initPerformanceMonitoring } from \"./lib/performance\";\n// Import the generated route tree\nimport { routeTree } from \"./routeTree.gen\";\n\n// Aggressive recovery from chunk load errors\n// Clears all caches, unregisters service workers, then reloads\nimport \"./index.css\";\nimport \"./i18n\";\n\n// Create namespaced logger for chunk errors\nconst log = createLogger(\"ChunkRecovery\");\n\nasync function handleChunkLoadError() {\n  log.warn(\"Chunk load error detected, clearing caches and reloading...\");\n\n  try {\n    // Unregister all service workers\n    if (\"serviceWorker\" in navigator) {\n      const registrations = await navigator.serviceWorker.getRegistrations();\n      await Promise.all(registrations.map((r) => r.unregister()));\n      log.info(\"Service workers unregistered\");\n    }\n\n    // Clear all caches\n    if (\"caches\" in globalThis) {\n      const cacheNames = await caches.keys();\n      await Promise.all(cacheNames.map((name) => caches.delete(name)));\n      log.info(\"All caches cleared:\", cacheNames);\n    }\n  } catch (error) {\n    log.error(\"Error during cache cleanup:\", error);\n  }\n\n  // Force reload to recover\n  globalThis.location.reload();\n}\n\n// Global error handler for chunk load failures (runs before React mounts)\nglobalThis.addEventListener(\"error\", (event) => {\n  const message = event.message;\n  if (/Loading chunk|Failed to fetch dynamically imported module|Importing a module script failed/i.test(message)) {\n    handleChunkLoadError();\n  }\n});\n\nglobalThis.addEventListener(\"unhandledrejection\", (event) => {\n  const message = event.reason?.message ?? String(event.reason);\n  if (/Loading chunk|Failed to fetch dynamically imported module|Importing a module script failed/i.test(message)) {\n    event.preventDefault();\n    handleChunkLoadError();\n  }\n});\n\n// ============================================================================\n// REACT QUERY CLIENT\n// ============================================================================\n\nconst queryClient = new QueryClient({\n  defaultOptions: {\n    mutations: {\n      retry: false,\n    },\n    queries: {\n      refetchOnWindowFocus: false,\n      retry: false,\n      staleTime: 60_000,\n    },\n  },\n});\n\n// ============================================================================\n// TANSTACK ROUTER CONFIGURATION\n// ============================================================================\n\n// Create the router instance with context\nconst router = createRouter({\n  context: {\n    // Auth will be injected at runtime via InnerApp\n    auth: undefined!,\n    queryClient,\n  },\n  defaultPendingComponent: PageLoader,\n  defaultPreload: \"intent\",\n  // Integrate with React Query for cache invalidation on navigation\n  defaultPreloadStaleTime: 0,\n  routeTree,\n});\n\n// Register router for type safety\ndeclare module \"@tanstack/react-router\" {\n  interface Register {\n    router: typeof router;\n  }\n}\n\n// ============================================================================\n// INNER APP (with auth context available)\n// ============================================================================\n\nfunction InnerApp() {\n  const auth = useAuth();\n\n  return <RouterProvider context={{ auth }} router={router} />;\n}\n\n// Lazy load devtools for development only\nconst ReactQueryDevtools =\n  process.env.NODE_ENV === \"production\"\n    ? () => null\n    : React.lazy(() =>\n        import(\"@tanstack/react-query-devtools\").then((res) => ({\n          default: res.ReactQueryDevtools,\n        }))\n      );\n\n// ============================================================================\n// INITIALIZE APP\n// ============================================================================\n\n// Initialize performance monitoring\ninitPerformanceMonitoring();\n\n// Render the app\nReactDOM.createRoot(document.querySelector(\"#root\")!).render(\n  <React.StrictMode>\n    <GlobalError>\n      <ChunkErrorBoundary>\n        <QueryClientProvider client={queryClient}>\n          <QuerySettingsProvider value={{ endpoint: `${import.meta.env.VITE_API_URL}/api/model` }}>\n            <AuthProvider>\n              <SettingsProvider>\n                <ToastProvider>\n                  <AbilityProvider>\n                    <InnerApp />\n                    <React.Suspense fallback={null}>\n                      <ReactQueryDevtools initialIsOpen={false} />\n                    </React.Suspense>\n                  </AbilityProvider>\n                </ToastProvider>\n              </SettingsProvider>\n            </AuthProvider>\n          </QuerySettingsProvider>\n        </QueryClientProvider>\n      </ChunkErrorBoundary>\n    </GlobalError>\n  </React.StrictMode>\n);\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/mp/reports.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/pages/AccountSettingsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":252,"column":58,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":252,"endColumn":60,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[9457,9459],"text":"."},"desc":"Remove unnecessary optional chain"}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { startRegistration } from \"@simplewebauthn/browser\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { Check, Fingerprint, Loader2, Smartphone } from \"lucide-react\";\nimport { useEffect, useState } from \"react\";\n\nimport Button from \"@/components/ui/Button\";\nimport Input from \"@/components/ui/Input\";\nimport { useAuth } from \"@/context/AuthContext\";\nimport { useToast } from \"@/context/ToastContext\";\nimport {\n  disableMfa,\n  enableMfa,\n  fetchPasskeyRegistrationOptions,\n  removePasskey,\n  setupMfa,\n  verifyPasskeyRegistration,\n} from \"@/features/auth/api\";\n\nexport default function AccountSettingsPage() {\n  const { refreshSession, user } = useAuth();\n  const { error, success } = useToast();\n\n  // MFA State\n  const [mfaSecret, setMfaSecret] = useState<null | string>(null);\n  const [qrCodeUrl, setQrCodeUrl] = useState<null | string>(null);\n  const [mfaToken, setMfaToken] = useState(\"\");\n  const [isMfaEnabled, setIsMfaEnabled] = useState(user?.mfaEnabled ?? false);\n\n  useEffect(() => {\n    if (user) setIsMfaEnabled(user.mfaEnabled ?? false);\n  }, [user]);\n\n  // --- MFA Handlers ---\n  // --- MFA Mutations ---\n  const setupMfaMutation = useMutation({\n    mutationFn: () =>\n      setupMfa().then((res) => {\n        if (res.status !== \"ok\") throw new Error(res.message ?? \"Error al iniciar configuración MFA\");\n        return res;\n      }),\n    onError: (err) => {\n      error(err instanceof Error ? err.message : \"Error al iniciar configuración MFA\");\n    },\n    onSuccess: (data) => {\n      setMfaSecret(data.secret);\n      setQrCodeUrl(data.qrCodeUrl);\n    },\n  });\n\n  const enableMfaMutation = useMutation({\n    mutationFn: (token: string) =>\n      enableMfa({ token, userId: user?.id }).then((res) => {\n        if (res.status !== \"ok\") throw new Error(res.message ?? \"Código incorrecto\");\n        return res;\n      }),\n    onError: (err) => {\n      error(err instanceof Error ? err.message : \"Error al activar MFA\");\n    },\n    onSuccess: async () => {\n      success(\"MFA activado correctamente\");\n      setIsMfaEnabled(true);\n      setMfaSecret(null);\n      setQrCodeUrl(null);\n      await refreshSession();\n    },\n  });\n\n  const disableMfaMutation = useMutation({\n    mutationFn: () =>\n      disableMfa().then((res) => {\n        if (res.status !== \"ok\") throw new Error(\"No se pudo desactivar MFA\");\n        return res;\n      }),\n    onError: () => {\n      error(\"Error al desactivar MFA\");\n    },\n    onSuccess: async () => {\n      success(\"MFA desactivado\");\n      setIsMfaEnabled(false);\n      await refreshSession();\n    },\n  });\n\n  const handleDisableMfa = () => {\n    if (!confirm(\"¿Estás seguro de desactivar la autenticación de dos factores? Tu cuenta será menos segura.\")) return;\n    disableMfaMutation.mutate();\n  };\n\n  // --- Passkey Handlers ---\n  // --- Passkey Mutations ---\n  const registerPasskeyMutation = useMutation({\n    mutationFn: async () => {\n      const options = await fetchPasskeyRegistrationOptions();\n      if (options.status === \"error\") throw new Error(options.message);\n\n      const attResp = await startRegistration({ optionsJSON: options });\n\n      const verifyData = await verifyPasskeyRegistration({ body: attResp, challenge: options.challenge });\n      if (verifyData.status !== \"ok\") throw new Error(verifyData.message ?? \"Error al verificar passkey\");\n\n      return verifyData;\n    },\n    onError: (err) => {\n      console.error(err);\n      error(err instanceof Error ? err.message : \"Error al registrar passkey\");\n    },\n    onSuccess: async () => {\n      success(\"Passkey registrado exitosamente\");\n      await refreshSession();\n    },\n  });\n\n  const deletePasskeyMutation = useMutation({\n    mutationFn: () =>\n      removePasskey().then((res) => {\n        if (res.status !== \"ok\") throw new Error(res.message ?? \"Error al eliminar passkey\");\n        return res;\n      }),\n    onError: (err) => {\n      error(err instanceof Error ? err.message : \"Error al eliminar passkey\");\n    },\n    onSuccess: async () => {\n      success(\"Passkey eliminado\");\n      await refreshSession();\n    },\n  });\n\n  const handleDeletePasskey = () => {\n    if (!confirm(\"¿Estás seguro de eliminar tu passkey? Tendrás que usar tu contraseña para iniciar sesión.\")) return;\n    deletePasskeyMutation.mutate();\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"space-y-1 px-6 pt-6\">\n        <h2 className=\"text-primary text-lg font-semibold drop-shadow-sm\">Seguridad de la cuenta</h2>\n        <p className=\"text-base-content/70 text-sm\">Gestiona tus métodos de autenticación para proteger tu cuenta.</p>\n      </div>\n\n      {/* MFA Section */}\n      <section className=\"bg-base-100 p-6\">\n        <div className=\"flex items-start gap-4\">\n          <div className=\"bg-primary/10 text-primary rounded-full p-3\">\n            <Smartphone className=\"size-6\" />\n          </div>\n          <div className=\"flex-1 space-y-4\">\n            <div>\n              <h3 className=\"text-base-content font-semibold\">Autenticación de dos factores (MFA)</h3>\n              <p className=\"text-base-content/70 text-sm\">\n                Añade una capa extra de seguridad usando una app como Google Authenticator o Authy.\n              </p>\n            </div>\n\n            {isMfaEnabled ? (\n              <div className=\"bg-success/10 text-success-content flex items-center gap-2 rounded-lg px-4 py-3 text-sm\">\n                <Check className=\"size-4\" />\n                <span className=\"font-medium\">MFA está activado en tu cuenta.</span>\n                <div className=\"ml-auto\">\n                  <Button\n                    className=\"text-error hover:bg-error/10\"\n                    disabled={disableMfaMutation.isPending}\n                    onClick={handleDisableMfa}\n                    size=\"sm\"\n                    variant=\"ghost\"\n                  >\n                    Desactivar\n                  </Button>\n                </div>\n              </div>\n            ) : (\n              <div className=\"space-y-4\">\n                {qrCodeUrl ? (\n                  <div className=\"border-base-300 bg-base-200/50 rounded-xl border p-4\">\n                    <div className=\"mb-4 text-center\">\n                      <p className=\"mb-2 text-sm font-medium\">1. Escanea este código QR con tu app de autenticación:</p>\n                      <img\n                        alt=\"QR Code\"\n                        className=\"mx-auto rounded-lg bg-white p-2 shadow-sm\"\n                        decoding=\"async\"\n                        loading=\"lazy\"\n                        src={qrCodeUrl}\n                      />\n                      <p className=\"text-base-content/50 mt-2 text-xs\">Secreto: {mfaSecret}</p>\n                    </div>\n\n                    <div className=\"mx-auto max-w-xs space-y-3\">\n                      <p className=\"text-sm font-medium\">2. Ingresa el código de 6 dígitos:</p>\n                      <div className=\"flex gap-2\">\n                        <Input\n                          autoComplete=\"one-time-code\"\n                          className=\"text-center tracking-widest\"\n                          maxLength={6}\n                          onChange={(e) => {\n                            setMfaToken(e.target.value);\n                          }}\n                          placeholder=\"000000\"\n                          value={mfaToken}\n                        />\n                        <Button\n                          disabled={enableMfaMutation.isPending || mfaToken.length !== 6}\n                          onClick={() => {\n                            enableMfaMutation.mutate(mfaToken);\n                          }}\n                        >\n                          {enableMfaMutation.isPending ? <Loader2 className=\"size-4 animate-spin\" /> : \"Activar\"}\n                        </Button>\n                      </div>\n                      <Button\n                        className=\"text-base-content/50 w-full\"\n                        onClick={() => {\n                          setQrCodeUrl(null);\n                          setMfaSecret(null);\n                        }}\n                        size=\"sm\"\n                        variant=\"ghost\"\n                      >\n                        Cancelar\n                      </Button>\n                    </div>\n                  </div>\n                ) : (\n                  <Button\n                    disabled={setupMfaMutation.isPending}\n                    onClick={() => {\n                      setupMfaMutation.mutate();\n                    }}\n                  >\n                    {setupMfaMutation.isPending ? <Loader2 className=\"mr-2 size-4 animate-spin\" /> : null}\n                    Configurar MFA\n                  </Button>\n                )}\n              </div>\n            )}\n          </div>\n        </div>\n      </section>\n\n      {/* Passkey Section */}\n      <section className=\"bg-base-100 p-6\">\n        <div className=\"flex items-start gap-4\">\n          <div className=\"bg-secondary/10 text-secondary rounded-full p-3\">\n            <Fingerprint className=\"size-6\" />\n          </div>\n          <div className=\"flex-1 space-y-4\">\n            <div>\n              <h3 className=\"text-base-content font-semibold\">Passkeys / biometría</h3>\n              <p className=\"text-base-content/70 text-sm\">\n                Inicia sesión sin contraseña usando tu huella dactilar, reconocimiento facial o PIN del dispositivo.\n              </p>\n            </div>\n\n            {(user as unknown as { hasPasskey: boolean })?.hasPasskey ? (\n              <div className=\"bg-success/10 text-success-content flex items-center gap-2 rounded-lg px-4 py-3 text-sm\">\n                <Check className=\"size-4\" />\n                <span className=\"font-medium\">Passkey configurado.</span>\n                <div className=\"ml-auto flex gap-2\">\n                  <Button\n                    className=\"text-error hover:bg-error/10\"\n                    disabled={deletePasskeyMutation.isPending}\n                    onClick={handleDeletePasskey}\n                    size=\"sm\"\n                    variant=\"ghost\"\n                  >\n                    Eliminar\n                  </Button>\n                  <Button\n                    disabled={registerPasskeyMutation.isPending}\n                    onClick={() => {\n                      registerPasskeyMutation.mutate();\n                    }}\n                    size=\"sm\"\n                    variant=\"ghost\"\n                  >\n                    Reemplazar\n                  </Button>\n                </div>\n              </div>\n            ) : (\n              <div className=\"flex items-center gap-4\">\n                <Button\n                  disabled={registerPasskeyMutation.isPending}\n                  onClick={() => {\n                    registerPasskeyMutation.mutate();\n                  }}\n                  variant=\"outline\"\n                >\n                  {registerPasskeyMutation.isPending ? (\n                    <Loader2 className=\"mr-2 size-4 animate-spin\" />\n                  ) : (\n                    <Fingerprint className=\"mr-2 size-4\" />\n                  )}\n                  Registrar nuevo passkey\n                </Button>\n              </div>\n            )}\n\n            <p className=\"text-base-content/50 text-xs\">\n              Nota: Solo puedes tener un passkey activo por usuario. Registrar uno nuevo reemplazará el anterior.\n            </p>\n          </div>\n        </div>\n      </section>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/pages/CalendarClassificationPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":57,"column":27,"nodeType":"ChainExpression","messageId":"neverNullish","endLine":57,"endColumn":50},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":57,"column":38,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":57,"endColumn":40,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[2027,2029],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":58,"column":33,"nodeType":"ChainExpression","messageId":"neverNullish","endLine":58,"endColumn":61},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":58,"column":44,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":58,"endColumn":46,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[2090,2092],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":60,"column":18,"nodeType":"ChainExpression","messageId":"alwaysTruthy","endLine":60,"endColumn":30},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":60,"column":22,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":60,"endColumn":24,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[2137,2139],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":61,"column":26,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":61,"endColumn":28,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[2188,2190],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-floating-promises","severity":2,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":102,"column":7,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":102,"endColumn":78,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[3610,3610],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[3610,3610],"text":"await "},"desc":"Add await operator."}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always falsy.","line":164,"column":9,"nodeType":"Identifier","messageId":"alwaysFalsy","endLine":164,"endColumn":19},{"ruleId":"@typescript-eslint/require-await","severity":2,"message":"Async arrow function 'handleSave' has no 'await' expression.","line":173,"column":78,"nodeType":"ArrowFunctionExpression","messageId":"missingAwait","endLine":173,"endColumn":80,"suggestions":[{"messageId":"removeAsync","fix":{"range":[6048,6054],"text":""},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":177,"column":9,"nodeType":"Identifier","messageId":"alwaysTruthy","endLine":177,"endColumn":14}],"suppressedMessages":[],"errorCount":11,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as Toast from \"@radix-ui/react-toast\";\nimport * as Tooltip from \"@radix-ui/react-tooltip\";\nimport { useForm } from \"@tanstack/react-form\";\nimport { useMutation, useQueryClient, useSuspenseQuery } from \"@tanstack/react-query\";\nimport dayjs from \"dayjs\";\nimport { useEffect, useState } from \"react\";\n\nimport type { CalendarUnclassifiedEvent } from \"@/features/calendar/types\";\n\nimport Alert from \"@/components/ui/Alert\";\nimport Button from \"@/components/ui/Button\";\nimport { StatCard } from \"@/components/ui/StatCard\";\nimport {\n  classifyCalendarEvent,\n  type MissingFieldFilters,\n  reclassifyAllCalendarEvents,\n  reclassifyCalendarEvents,\n} from \"@/features/calendar/api\";\nimport { ClassificationRow } from \"@/features/calendar/components/ClassificationRow\";\nimport { ClassificationTotals } from \"@/features/calendar/components/ClassificationTotals\";\nimport { calendarQueries } from \"@/features/calendar/queries\";\nimport { type ClassificationEntry, type FormValues } from \"@/features/calendar/schemas\";\nimport {\n  buildDefaultEntry,\n  buildPayload,\n  eventKey,\n  type ParsedPayload,\n} from \"@/features/calendar/utils/classification\";\nimport { useJobProgress } from \"@/hooks/use-job-progress\";\n\nimport \"dayjs/locale/es\";\n\ndayjs.locale(\"es\");\n\nconst EMPTY_EVENTS: CalendarUnclassifiedEvent[] = [];\n\nconst ACTIVE_FILTER_CLASS = \"bg-primary text-primary-content shadow-sm\";\nconst INACTIVE_FILTER_CLASS = \"bg-base-300/50 text-base-content/70 hover:bg-base-300\";\n\nfunction CalendarClassificationPage() {\n  const PAGE_SIZE = 50;\n  const queryClient = useQueryClient();\n\n  const [page, setPage] = useState(0);\n  const [filters, setFilters] = useState<MissingFieldFilters>({});\n\n  const {\n    data,\n    error: queryError,\n    isFetching: loading,\n    refetch,\n  } = useSuspenseQuery(calendarQueries.unclassified(page, PAGE_SIZE, filters));\n\n  // Fetch classification options from backend (single source of truth)\n  const { data: optionsData } = useSuspenseQuery(calendarQueries.options());\n\n  const categoryChoices = optionsData?.categories ?? [];\n  const treatmentStageChoices = optionsData?.treatmentStages ?? [];\n\n  const events = data?.events || EMPTY_EVENTS;\n  const totalCount = data?.totalCount || 0;\n\n  const [savingKey, setSavingKey] = useState<null | string>(null);\n  const [toastMessage, setToastMessage] = useState<null | string>(null);\n  const [toastOpen, setToastOpen] = useState(false);\n\n  // TanStack Form for array of classification entries\n  const form = useForm({\n    defaultValues: { entries: [] } as FormValues,\n  });\n\n  // Sync form with data when events change\n  useEffect(() => {\n    if (events.length > 0) {\n      form.reset({ entries: events.map((e) => buildDefaultEntry(e)) });\n    }\n  }, [events, form]);\n\n  const classifyMutation = useMutation({\n    mutationFn: (params: { event: CalendarUnclassifiedEvent; payload: ParsedPayload }) => {\n      return classifyCalendarEvent({\n        amountExpected: params.payload.amountExpected,\n        amountPaid: params.payload.amountPaid,\n        attended: params.payload.attended,\n        calendarId: params.event.calendarId,\n        category: params.payload.category,\n        dosage: params.payload.dosage,\n        eventId: params.event.eventId,\n        treatmentStage: params.payload.treatmentStage,\n      });\n    },\n    onError: (err) => {\n      const message = err instanceof Error ? err.message : \"No se pudo guardar la clasificación\";\n      setToastMessage(message);\n    },\n    onSettled: () => {\n      setSavingKey(null);\n    },\n    onSuccess: () => {\n      setToastMessage(\"Clasificación actualizada\");\n      setToastOpen(true);\n      queryClient.invalidateQueries({ queryKey: [\"calendar-unclassified\"] });\n      setSavingKey(null);\n    },\n  });\n\n  const reclassifyMutation = useMutation({\n    mutationFn: reclassifyCalendarEvents,\n    onError: (err) => {\n      setToastMessage(`Error: ${err instanceof Error ? err.message : \"Error desconocido\"}`);\n      setToastOpen(true);\n    },\n    onSuccess: (response) => {\n      setActiveJobId(response.jobId);\n      setToastMessage(`Iniciando reclasificación de ${response.totalEvents} eventos...`);\n      setToastOpen(true);\n    },\n  });\n\n  const reclassifyAllMutation = useMutation({\n    mutationFn: reclassifyAllCalendarEvents,\n    onError: (err) => {\n      setToastMessage(`Error: ${err instanceof Error ? err.message : \"Error desconocido\"}`);\n      setToastOpen(true);\n    },\n    onSuccess: (response) => {\n      setActiveJobId(response.jobId);\n      setToastMessage(`Iniciando reclasificación de TODOS los ${response.totalEvents} eventos...`);\n      setToastOpen(true);\n    },\n  });\n\n  // Track active job progress\n  const [activeJobId, setActiveJobId] = useState<null | string>(null);\n  const { isComplete, isFailed, job, progress } = useJobProgress(activeJobId, {\n    onComplete: (result) => {\n      const r = result as { fieldCounts?: Record<string, number>; message?: string; reclassified?: number };\n      const details = r.fieldCounts\n        ? Object.entries(r.fieldCounts)\n            .filter(([, v]) => v > 0)\n            .map(([k, v]) => `${k}: ${v}`)\n            .join(\" | \")\n        : \"\";\n      const msg = details\n        ? `✓ ${r.reclassified ?? 0} eventos actualizados. ${details}`\n        : `✓ ${r.message ?? \"Completado\"}`;\n      setToastMessage(msg);\n      setToastOpen(true);\n      setActiveJobId(null);\n    },\n    onError: (error) => {\n      setToastMessage(`Error: ${error}`);\n      setToastOpen(true);\n      setActiveJobId(null);\n    },\n  });\n\n  const isJobRunning = !!activeJobId && !isComplete && !isFailed;\n\n  const { mutate } = classifyMutation;\n\n  const error = (() => {\n    if (queryError instanceof Error) return queryError.message;\n    if (queryError) return String(queryError);\n    if (classifyMutation.error instanceof Error) return classifyMutation.error.message;\n    return null;\n  })();\n\n  const handleResetEntry = (index: number, event: CalendarUnclassifiedEvent) => {\n    form.setFieldValue(`entries[${index}]`, buildDefaultEntry(event) as ClassificationEntry);\n  };\n\n  const handleSave = async (event: CalendarUnclassifiedEvent, index: number) => {\n    const key = eventKey(event);\n    setSavingKey(key);\n    const entry = form.getFieldValue(`entries[${index}]`);\n    if (entry) {\n      const payload = buildPayload(entry, event);\n      mutate({ event, payload });\n    }\n  };\n\n  const totalPages = Math.ceil(totalCount / PAGE_SIZE);\n  const hasActiveFilters = Object.values(filters).some(Boolean);\n\n  return (\n    <Toast.Provider swipeDirection=\"right\">\n      <Tooltip.Provider delayDuration={200}>\n        <div className=\"space-y-8\">\n          {/* Stats Cards */}\n          <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-4\">\n            <StatCard title=\"Pendientes\" tone=\"primary\" value={loading ? \"—\" : totalCount.toLocaleString(\"es-CL\")} />\n            <StatCard title=\"Página actual\" tone=\"success\" value={loading ? \"—\" : events.length} />\n            <ClassificationTotals events={events} form={form} />\n          </div>\n\n          {/* Actions Bar */}\n          <div className=\"bg-base-200/50 flex flex-wrap items-center justify-between gap-4 rounded-2xl p-4 backdrop-blur-sm\">\n            {/* Filters */}\n            <div className=\"flex flex-wrap items-center gap-3\">\n              <span className=\"text-base-content/50 text-xs font-medium tracking-wide uppercase\">Filtrar:</span>\n              <div className=\"flex flex-wrap gap-2\">\n                <button\n                  className={`rounded-full px-3 py-1.5 text-xs font-medium transition-all ${\n                    filters.missingCategory ? ACTIVE_FILTER_CLASS : INACTIVE_FILTER_CLASS\n                  }`}\n                  onClick={() => {\n                    setFilters((prev) => ({ ...prev, missingCategory: !prev.missingCategory || undefined }));\n                    setPage(0);\n                  }}\n                  type=\"button\"\n                >\n                  Sin categoría\n                </button>\n                <button\n                  className={`rounded-full px-3 py-1.5 text-xs font-medium transition-all ${\n                    filters.missingAmount ? ACTIVE_FILTER_CLASS : INACTIVE_FILTER_CLASS\n                  }`}\n                  onClick={() => {\n                    setFilters((prev) => ({ ...prev, missingAmount: !prev.missingAmount || undefined }));\n                    setPage(0);\n                  }}\n                  type=\"button\"\n                >\n                  Sin monto\n                </button>\n                <button\n                  className={`rounded-full px-3 py-1.5 text-xs font-medium transition-all ${\n                    filters.missingAttended\n                      ? \"bg-primary text-primary-content shadow-sm\"\n                      : \"bg-base-300/50 text-base-content/70 hover:bg-base-300\"\n                  }`}\n                  onClick={() => {\n                    setFilters((prev) => ({ ...prev, missingAttended: !prev.missingAttended || undefined }));\n                    setPage(0);\n                  }}\n                  type=\"button\"\n                >\n                  Sin asistencia\n                </button>\n                <button\n                  className={`rounded-full px-3 py-1.5 text-xs font-medium transition-all ${\n                    filters.missingDosage\n                      ? \"bg-primary text-primary-content shadow-sm\"\n                      : \"bg-base-300/50 text-base-content/70 hover:bg-base-300\"\n                  }`}\n                  onClick={() => {\n                    setFilters((prev) => ({ ...prev, missingDosage: !prev.missingDosage || undefined }));\n                    setPage(0);\n                  }}\n                  type=\"button\"\n                >\n                  Sin dosis\n                </button>\n                <button\n                  className={`rounded-full px-3 py-1.5 text-xs font-medium transition-all ${\n                    filters.missingTreatmentStage\n                      ? \"bg-primary text-primary-content shadow-sm\"\n                      : \"bg-base-300/50 text-base-content/70 hover:bg-base-300\"\n                  }`}\n                  onClick={() => {\n                    setFilters((prev) => ({\n                      ...prev,\n                      missingTreatmentStage: !prev.missingTreatmentStage || undefined,\n                    }));\n                    setPage(0);\n                  }}\n                  type=\"button\"\n                >\n                  Sin etapa\n                </button>\n                {hasActiveFilters && (\n                  <>\n                    {/* Filter Mode Toggle */}\n                    <div className=\"border-base-300/50 flex items-center gap-1 border-l pl-3\">\n                      <span className=\"text-base-content/40 mr-1 text-xs\">Coincide:</span>\n                      <button\n                        className={`rounded-full px-2.5 py-1 text-xs font-medium transition-all ${\n                          !filters.filterMode || filters.filterMode === \"OR\"\n                            ? \"bg-secondary text-secondary-content shadow-sm\"\n                            : \"text-base-content/60 hover:text-base-content bg-transparent\"\n                        }`}\n                        onClick={() => {\n                          setFilters((prev) => ({ ...prev, filterMode: undefined }));\n                          setPage(0);\n                        }}\n                        type=\"button\"\n                      >\n                        Cualquiera\n                      </button>\n                      <button\n                        className={`rounded-full px-2.5 py-1 text-xs font-medium transition-all ${\n                          filters.filterMode === \"AND\"\n                            ? \"bg-secondary text-secondary-content shadow-sm\"\n                            : \"text-base-content/60 hover:text-base-content bg-transparent\"\n                        }`}\n                        onClick={() => {\n                          setFilters((prev) => ({ ...prev, filterMode: \"AND\" }));\n                          setPage(0);\n                        }}\n                        type=\"button\"\n                      >\n                        Todos\n                      </button>\n                    </div>\n                    <button\n                      className=\"text-error/80 hover:text-error flex items-center gap-1 px-2 py-1.5 text-xs font-medium transition-colors\"\n                      onClick={() => {\n                        setFilters({});\n                        setPage(0);\n                      }}\n                      type=\"button\"\n                    >\n                      <svg className=\"h-3.5 w-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path d=\"M6 18L18 6M6 6l12 12\" strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} />\n                      </svg>\n                      Limpiar\n                    </button>\n                  </>\n                )}\n              </div>\n            </div>\n\n            {/* Reclassify Actions */}\n            <div className=\"flex items-center gap-3\">\n              {/* Refresh Button - Moved here */}\n              <button\n                className=\"btn btn-ghost btn-sm text-base-content/70 gap-2\"\n                disabled={loading}\n                onClick={() => void refetch()}\n                title=\"Actualizar lista\"\n                type=\"button\"\n              >\n                <svg\n                  className={`h-4 w-4 ${loading ? \"animate-spin\" : \"\"}`}\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  viewBox=\"0 0 24 24\"\n                >\n                  <path\n                    d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\"\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                    strokeWidth={2}\n                  />\n                </svg>\n                <span className=\"hidden sm:inline\">{loading ? \"Cargando...\" : \"Actualizar\"}</span>\n              </button>\n\n              {/* Action Buttons */}\n              <Button\n                className=\"relative gap-2 overflow-hidden\"\n                disabled={reclassifyMutation.isPending || isJobRunning}\n                onClick={() => {\n                  reclassifyMutation.mutate();\n                }}\n                type=\"button\"\n                variant=\"secondary\"\n              >\n                {/* Progress overlay inside button */}\n                {isJobRunning && (\n                  <div\n                    className=\"bg-primary/20 absolute inset-0 transition-all duration-300\"\n                    style={{ width: `${progress}%` }}\n                  />\n                )}\n                <span className=\"relative z-10 flex items-center gap-2\">\n                  {isJobRunning ? (\n                    <>\n                      <svg className=\"h-4 w-4 animate-spin\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path\n                          d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\"\n                          strokeLinecap=\"round\"\n                          strokeLinejoin=\"round\"\n                          strokeWidth={2}\n                        />\n                      </svg>\n                      <span className=\"tabular-nums\">{progress}%</span>\n                    </>\n                  ) : (\n                    <>\n                      <svg className=\"h-4 w-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path\n                          d=\"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2\"\n                          strokeLinecap=\"round\"\n                          strokeLinejoin=\"round\"\n                          strokeWidth={2}\n                        />\n                      </svg>\n                      Reclasificar pendientes\n                    </>\n                  )}\n                </span>\n              </Button>\n\n              {/* Progress info pill - only when running */}\n              {isJobRunning && job && (\n                <div className=\"bg-primary/10 border-primary/20 flex items-center gap-2 rounded-full border px-3 py-1.5\">\n                  <span className=\"text-primary/80 text-xs font-medium\">{job.message}</span>\n                  <span className=\"text-primary text-xs font-bold tabular-nums\">\n                    {job.progress.toLocaleString(\"es-CL\")}/{job.total.toLocaleString(\"es-CL\")}\n                  </span>\n                </div>\n              )}\n\n              <Tooltip.Root>\n                <Tooltip.Trigger asChild>\n                  <button\n                    className=\"text-warning/80 hover:text-warning hover:bg-warning/10 rounded-lg p-2 transition-colors disabled:opacity-50\"\n                    disabled={reclassifyAllMutation.isPending || isJobRunning}\n                    onClick={() => {\n                      if (\n                        globalThis.confirm(\n                          \"¿Reclasificar TODOS los eventos? Esto sobrescribirá las clasificaciones existentes.\"\n                        )\n                      ) {\n                        reclassifyAllMutation.mutate();\n                      }\n                    }}\n                    type=\"button\"\n                  >\n                    <svg\n                      className={`h-5 w-5 ${isJobRunning ? \"animate-spin\" : \"\"}`}\n                      fill=\"none\"\n                      stroke=\"currentColor\"\n                      viewBox=\"0 0 24 24\"\n                    >\n                      <path\n                        d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\"\n                        strokeLinecap=\"round\"\n                        strokeLinejoin=\"round\"\n                        strokeWidth={2}\n                      />\n                    </svg>\n                  </button>\n                </Tooltip.Trigger>\n                <Tooltip.Content className=\"bg-base-300 rounded-lg px-3 py-2 text-xs shadow-xl\" side=\"bottom\">\n                  Reclasificar TODO (sobrescribe existentes)\n                  <Tooltip.Arrow className=\"fill-base-300\" />\n                </Tooltip.Content>\n              </Tooltip.Root>\n            </div>\n          </div>\n\n          {/* Error Alert */}\n          {error && <Alert variant=\"error\">{error}</Alert>}\n\n          {/* Empty State */}\n          {!loading && events.length === 0 && !error && (\n            <div className=\"bg-success/5 ring-success/20 flex flex-col items-center justify-center rounded-2xl py-16 ring-1\">\n              <div className=\"bg-success/10 mb-4 rounded-full p-4\">\n                <svg className=\"text-success h-8 w-8\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path d=\"M5 13l4 4L19 7\" strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} />\n                </svg>\n              </div>\n              <h3 className=\"text-success text-lg font-semibold\">¡Todo clasificado!</h3>\n              <p className=\"text-base-content/60 mt-1 text-sm\">No hay eventos pendientes de clasificar.</p>\n            </div>\n          )}\n\n          {/* Events List */}\n          {events.length > 0 && (\n            <div className=\"space-y-3\">\n              {events.map((event, index) => {\n                const key = eventKey(event);\n\n                return (\n                  <ClassificationRow\n                    categoryChoices={categoryChoices}\n                    event={event}\n                    form={form}\n                    index={index}\n                    isSaving={savingKey === key}\n                    key={key}\n                    onReset={handleResetEntry}\n                    onSave={handleSave}\n                    treatmentStageChoices={treatmentStageChoices}\n                  />\n                );\n              })}\n            </div>\n          )}\n\n          {/* Pagination */}\n          {totalCount > PAGE_SIZE && (\n            <div className=\"flex items-center justify-center gap-2 pt-4\">\n              <button\n                className=\"btn btn-sm btn-ghost disabled:opacity-30\"\n                disabled={page === 0 || loading}\n                onClick={() => {\n                  setPage(0);\n                }}\n                type=\"button\"\n              >\n                <svg className=\"h-4 w-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path\n                    d=\"M11 19l-7-7 7-7m8 14l-7-7 7-7\"\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                    strokeWidth={2}\n                  />\n                </svg>\n              </button>\n              <button\n                className=\"btn btn-sm btn-ghost disabled:opacity-30\"\n                disabled={page === 0 || loading}\n                onClick={() => {\n                  setPage((p) => Math.max(0, p - 1));\n                }}\n                type=\"button\"\n              >\n                <svg className=\"h-4 w-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path d=\"M15 19l-7-7 7-7\" strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} />\n                </svg>\n              </button>\n              <div className=\"bg-base-200 flex items-center gap-2 rounded-lg px-4 py-2 text-sm\">\n                <span className=\"text-base-content/60\">Página</span>\n                <span className=\"text-base-content font-semibold tabular-nums\">{page + 1}</span>\n                <span className=\"text-base-content/60\">de {totalPages}</span>\n              </div>\n              <button\n                className=\"btn btn-sm btn-ghost disabled:opacity-30\"\n                disabled={(page + 1) * PAGE_SIZE >= totalCount || loading}\n                onClick={() => {\n                  setPage((p) => p + 1);\n                }}\n                type=\"button\"\n              >\n                <svg className=\"h-4 w-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path d=\"M9 5l7 7-7 7\" strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} />\n                </svg>\n              </button>\n              <button\n                className=\"btn btn-sm btn-ghost disabled:opacity-30\"\n                disabled={(page + 1) * PAGE_SIZE >= totalCount || loading}\n                onClick={() => {\n                  setPage(totalPages - 1);\n                }}\n                type=\"button\"\n              >\n                <svg className=\"h-4 w-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path d=\"M13 5l7 7-7 7M5 5l7 7-7 7\" strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} />\n                </svg>\n              </button>\n            </div>\n          )}\n        </div>\n      </Tooltip.Provider>\n      <Toast.Root\n        className=\"bg-base-300 text-base-content data-[state=open]:animate-slideIn data-[state=closed]:animate-hide rounded-xl px-4 py-3 text-sm shadow-xl\"\n        onOpenChange={setToastOpen}\n        open={toastOpen && Boolean(toastMessage)}\n      >\n        <Toast.Title className=\"font-semibold\">Operación completada</Toast.Title>\n        <Toast.Description className=\"text-base-content/70 mt-1 text-xs\">{toastMessage}</Toast.Description>\n      </Toast.Root>\n      <Toast.Viewport className=\"fixed right-4 bottom-4 z-50 flex flex-col gap-2\" />\n    </Toast.Provider>\n  );\n}\n\nexport default CalendarClassificationPage;\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/pages/CalendarDailyPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/pages/CalendarHeatmapPage.tsx","messages":[{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":43,"column":52,"nodeType":"MemberExpression","endLine":43,"endColumn":66},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":75,"column":53,"nodeType":"ChainExpression","messageId":"neverNullish","endLine":75,"endColumn":82},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":75,"column":60,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":75,"endColumn":62,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[2903,2905],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"no-unsafe-optional-chaining","severity":2,"message":"Unsafe usage of optional chaining. If it short-circuits with 'undefined' the evaluation will throw TypeError.","line":84,"column":25,"nodeType":"ChainExpression","messageId":"unsafeOptionalChain","endLine":84,"endColumn":51},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":84,"column":32,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":84,"endColumn":34,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[3385,3387],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-unnecessary-type-conversion","severity":2,"message":"Passing a string to String() does not change the type or value of the string.","line":86,"column":19,"nodeType":"Identifier","messageId":"unnecessaryTypeConversion","endLine":86,"endColumn":25,"suggestions":[{"messageId":"suggestRemove","fix":{"range":[3503,3521],"text":"entry.date"},"desc":"Remove the type conversion."},{"messageId":"suggestSatisfies","data":{"type":"string"},"fix":{"range":[3503,3521],"text":"(entry.date satisfies string)"},"desc":"Instead, assert that the value satisfies the string type."}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":88,"column":25,"nodeType":"MemberExpression","messageId":"neverNullish","endLine":88,"endColumn":45},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":89,"column":21,"nodeType":"MemberExpression","messageId":"neverNullish","endLine":89,"endColumn":37},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":94,"column":14,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":94,"endColumn":16,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[3724,3726],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":98,"column":31,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":98,"endColumn":33,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[3884,3886],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":99,"column":29,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":99,"endColumn":31,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[3944,3946],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":121,"column":14,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":121,"endColumn":16,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[4666,4668],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":121,"column":37,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":121,"endColumn":39,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[4689,4691],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always falsy.","line":131,"column":9,"nodeType":"UnaryExpression","messageId":"alwaysFalsy","endLine":131,"endColumn":17},{"ruleId":"@typescript-eslint/no-unnecessary-type-conversion","severity":2,"message":"Passing a string to String() does not change the type or value of the string.","line":135,"column":24,"nodeType":"Identifier","messageId":"unnecessaryTypeConversion","endLine":135,"endColumn":30,"suggestions":[{"messageId":"suggestRemove","fix":{"range":[5215,5233],"text":"entry.date"},"desc":"Remove the type conversion."},{"messageId":"suggestSatisfies","data":{"type":"string"},"fix":{"range":[5215,5233],"text":"(entry.date satisfies string)"},"desc":"Instead, assert that the value satisfies the string type."}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":146,"column":14,"nodeType":"MemberExpression","endLine":146,"endColumn":23},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":146,"column":42,"nodeType":"MemberExpression","endLine":146,"endColumn":51},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":146,"column":91,"nodeType":"MemberExpression","endLine":146,"endColumn":100},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always falsy.","line":246,"column":29,"nodeType":"Identifier","messageId":"alwaysFalsy","endLine":246,"endColumn":33}],"suppressedMessages":[],"errorCount":15,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useSuspenseQuery } from \"@tanstack/react-query\";\nimport clsx from \"clsx\";\nimport dayjs, { type Dayjs } from \"dayjs\";\nimport { ChevronDown, Filter } from \"lucide-react\";\nimport { type ChangeEvent, useMemo, useState } from \"react\";\nimport { useTranslation } from \"react-i18next\";\n\nimport Button from \"@/components/ui/Button\";\nimport { Card } from \"@/components/ui/Card\";\nimport Input from \"@/components/ui/Input\";\nimport { fetchCalendarSummary } from \"@/features/calendar/api\";\nimport HeatmapMonth from \"@/features/calendar/components/HeatmapMonth\";\nimport { MultiSelectFilter, type MultiSelectOption } from \"@/features/calendar/components/MultiSelectFilter\";\nimport { NULL_CATEGORY_VALUE } from \"@/features/calendar/constants\";\nimport { type CalendarFilters } from \"@/features/calendar/types\";\nimport { currencyFormatter, numberFormatter } from \"@/lib/format\";\nimport { PAGE_CONTAINER } from \"@/lib/styles\";\n\nimport \"dayjs/locale/es\";\n\ndayjs.locale(\"es\");\n\ninterface HeatmapFilters {\n  categories: string[];\n  from: string;\n  to: string;\n}\n\nconst createInitialFilters = (): HeatmapFilters => {\n  const start = dayjs().startOf(\"month\").subtract(1, \"month\");\n  const end = dayjs().endOf(\"month\").add(1, \"month\");\n  return {\n    categories: [],\n    from: start.format(\"YYYY-MM-DD\"),\n    to: end.format(\"YYYY-MM-DD\"),\n  };\n};\n\nfunction arraysEqual(a: string[], b: string[]): boolean {\n  if (a.length !== b.length) return false;\n  const sortedA = a.toSorted((x, y) => x.localeCompare(y));\n  const sortedB = b.toSorted((x, y) => x.localeCompare(y));\n  return sortedA.every((value, index) => value === sortedB[index]);\n}\n\nfunction CalendarHeatmapPage() {\n  // React Compiler auto-memoizes function calls in useState initializer\n  const [filters, setFilters] = useState<HeatmapFilters>(() => createInitialFilters());\n  const [appliedFilters, setAppliedFilters] = useState<HeatmapFilters>(() => createInitialFilters());\n\n  const { t } = useTranslation();\n  // React Compiler auto-stabilizes helper functions\n  const tc = (key: string, options?: Record<string, unknown>) => t(`calendar.${key}`, options);\n\n  const { data: summary } = useSuspenseQuery({\n    queryFn: () => {\n      const apiFilters: CalendarFilters = {\n        ...appliedFilters,\n        maxDays: 366,\n      };\n      return fetchCalendarSummary(apiFilters);\n    },\n    queryKey: [\"calendar-heatmap\", appliedFilters],\n    staleTime: 5 * 60 * 1000, // 5 minutes cache\n  });\n\n  // NOTE: We no longer sync server filters back to UI to avoid overwriting user changes.\n  // The user's `filters` state is the source of truth for the form.\n  // `appliedFilters` drives the query, and changes when user clicks \"Apply\".\n\n  // React Compiler auto-memoizes comparison functions\n  const isDirty = !filtersEqual(filters, appliedFilters);\n\n  // React Compiler auto-memoizes array transformations\n  const availableCategories: MultiSelectOption[] = (summary?.available.categories ?? []).map((entry) => {\n    const value = entry.category ?? NULL_CATEGORY_VALUE;\n    const label = entry.category ?? \"Sin clasificación\";\n    return { label: `${label} · ${numberFormatter.format(entry.total)}`, value };\n  });\n\n  // KEEP useMemo: Heavy Map operation iterating over all events\n  const statsByDate = useMemo(() => {\n    const map = new Map<string, { amountExpected: number; amountPaid: number; total: number }>();\n    for (const entry of summary?.aggregates.byDate) {\n      // Server now returns dates as \"YYYY-MM-DD\" strings via TO_CHAR in SQL\n      const key = String(entry.date).slice(0, 10);\n      map.set(key, {\n        amountExpected: entry.amountExpected ?? 0,\n        amountPaid: entry.amountPaid ?? 0,\n        total: entry.total,\n      });\n    }\n    return map;\n  }, [summary?.aggregates.byDate]);\n\n  // KEEP useMemo: Complex date range calculation with while loop\n  const heatmapMonths = useMemo(() => {\n    const sourceFrom = summary?.filters.from || filters.from;\n    const sourceTo = summary?.filters.to || filters.to;\n\n    let start = sourceFrom ? dayjs(sourceFrom).startOf(\"month\") : dayjs().startOf(\"month\").subtract(1, \"month\");\n    let end = sourceTo ? dayjs(sourceTo).startOf(\"month\") : dayjs().startOf(\"month\").add(1, \"month\");\n\n    if (!start.isValid()) {\n      start = dayjs().startOf(\"month\").subtract(1, \"month\");\n    }\n    if (!end.isValid() || end.isBefore(start)) {\n      end = start.add(2, \"month\");\n    }\n\n    const months: Dayjs[] = [];\n    let cursor = start.clone();\n    let guard = 0;\n    while (cursor.isBefore(end) || cursor.isSame(end)) {\n      months.push(cursor);\n      cursor = cursor.add(1, \"month\");\n      guard += 1;\n      if (guard > 18) break;\n    }\n    return months;\n  }, [summary?.filters.from, summary?.filters.to, filters.from, filters.to]);\n\n  // KEEP useMemo: Set creation from mapped array\n  const heatmapMonthKeys = useMemo(\n    () => new Set(heatmapMonths.map((month) => month.format(\"YYYY-MM\"))),\n    [heatmapMonths]\n  );\n\n  // KEEP useMemo: Iterates over all events to find max value\n  const heatmapMaxValue = useMemo(() => {\n    if (!summary) return 0;\n    let max = 0;\n    for (const entry of summary.aggregates.byDate) {\n      // Server now returns \"YYYY-MM-DD\" strings, extract month portion\n      const monthKey = String(entry.date).slice(0, 7);\n      if (heatmapMonthKeys.has(monthKey)) {\n        max = Math.max(max, entry.total);\n      }\n    }\n    return max;\n  }, [summary, heatmapMonthKeys]);\n\n  const handleToggle = (key: \"categories\", value: string) => {\n    setFilters((prev) => ({\n      ...prev,\n      [key]: prev[key].includes(value) ? prev[key].filter((item) => item !== value) : [...prev[key], value],\n    }));\n  };\n\n  const handleApply = () => {\n    setAppliedFilters(filters);\n  };\n\n  const handleReset = () => {\n    const defaults = createInitialFilters();\n    setFilters(defaults);\n    setAppliedFilters(defaults);\n  };\n\n  // With Suspense, we are \"busy\" only if a transition is happening, but here we just suspend.\n  const busy = false;\n  const rangeStartLabel = heatmapMonths[0]?.format(\"MMM YYYY\") ?? \"—\";\n  const rangeEndLabel = heatmapMonths.at(-1)?.format(\"MMM YYYY\") ?? \"—\";\n\n  const [showAdvanced, setShowAdvanced] = useState(false);\n\n  return (\n    <section className={PAGE_CONTAINER}>\n      {/* Collapsible Filter Toolbar */}\n      <Card className=\"overflow-hidden transition-all duration-300\">\n        <button\n          className=\"hover:bg-base-200/50 flex w-full items-center justify-between px-6 py-4 text-left transition-colors\"\n          onClick={() => {\n            setShowAdvanced((prev) => !prev);\n          }}\n          type=\"button\"\n        >\n          <div className=\"flex items-center gap-4\">\n            <div className=\"bg-primary/10 text-primary flex h-10 w-10 items-center justify-center rounded-full\">\n              <Filter className=\"h-5 w-5\" />\n            </div>\n\n            <div>\n              <h3 className=\"text-base-content text-sm font-medium\">Filtros y Visualización</h3>\n              <div className=\"text-base-content/60 mt-0.5 flex flex-wrap gap-2 text-xs\">\n                <span className=\"font-medium\">\n                  {rangeStartLabel} - {rangeEndLabel}\n                </span>\n              </div>\n            </div>\n          </div>\n\n          <ChevronDown\n            className={clsx(\n              \"text-base-content/40 h-5 w-5 transition-transform duration-300\",\n              showAdvanced && \"rotate-180\"\n            )}\n          />\n        </button>\n\n        <div\n          className={clsx(\n            \"grid transition-[grid-template-rows] duration-300 ease-in-out\",\n            showAdvanced ? \"grid-rows-[1fr]\" : \"grid-rows-[0fr]\"\n          )}\n        >\n          <div className=\"overflow-hidden\">\n            <form\n              className=\"border-base-200/50 space-y-6 border-t p-6 pt-2\"\n              onSubmit={(event) => {\n                event.preventDefault();\n                handleApply();\n                setShowAdvanced(false); // Auto-close on apply for cleaner UX\n              }}\n            >\n              <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n                <Input\n                  label={tc(\"filters.from\")}\n                  onChange={(event: ChangeEvent<HTMLInputElement>) => {\n                    setFilters((prev) => ({ ...prev, from: event.target.value }));\n                  }}\n                  type=\"date\"\n                  value={filters.from}\n                />\n                <Input\n                  label={tc(\"filters.to\")}\n                  onChange={(event: ChangeEvent<HTMLInputElement>) => {\n                    setFilters((prev) => ({ ...prev, to: event.target.value }));\n                  }}\n                  type=\"date\"\n                  value={filters.to}\n                />\n                <MultiSelectFilter\n                  label={tc(\"filters.categories\")}\n                  onToggle={(value) => {\n                    handleToggle(\"categories\", value);\n                  }}\n                  options={availableCategories}\n                  placeholder={tc(\"filters.allCategories\")}\n                  selected={filters.categories}\n                />\n              </div>\n\n              <div className=\"flex flex-wrap items-center justify-end gap-2\">\n                <Button\n                  disabled={busy || !isDirty}\n                  onClick={() => {\n                    handleReset();\n                  }}\n                  type=\"button\"\n                  variant=\"ghost\"\n                >\n                  {tc(\"resetFilters\")}\n                </Button>\n                <Button disabled={busy} type=\"submit\">\n                  {tc(\"applyFilters\")}\n                </Button>\n              </div>\n            </form>\n          </div>\n        </div>\n      </Card>\n\n      <section className=\"space-y-3\">\n        <div className=\"flex items-center justify-between\">\n          <h2 className=\"text-base-content/60 text-sm font-semibold tracking-wide uppercase\">{tc(\"heatmapSection\")}</h2>\n          <span className=\"text-base-content/60 text-xs\">\n            {tc(\"heatmapRange\", {\n              end: rangeEndLabel,\n              start: rangeStartLabel,\n            })}\n          </span>\n        </div>\n\n        <div className=\"grid items-start gap-4 lg:grid-cols-3\">\n          {heatmapMonths.map((month) => (\n            <HeatmapMonth\n              key={month.format(\"YYYY-MM\")}\n              maxValue={heatmapMaxValue}\n              month={month}\n              statsByDate={statsByDate}\n            />\n          ))}\n        </div>\n        <p className=\"text-base-content/60 text-xs\">\n          {tc(\"heatmapTotals\", {\n            events: numberFormatter.format(summary.totals.events),\n            expected: currencyFormatter.format(summary.totals.amountExpected),\n            paid: currencyFormatter.format(summary.totals.amountPaid),\n          })}\n        </p>\n      </section>\n    </section>\n  );\n}\n\nfunction filtersEqual(a: HeatmapFilters, b: HeatmapFilters): boolean {\n  return a.from === b.from && a.to === b.to && arraysEqual(a.categories, b.categories);\n}\n\nexport default CalendarHeatmapPage;\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/pages/CalendarSchedulePage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/pages/CalendarSyncHistoryPage.tsx","messages":[],"suppressedMessages":[{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":30,"column":5,"nodeType":"MemberExpression","endLine":30,"endColumn":20,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":32,"column":5,"nodeType":"MemberExpression","endLine":32,"endColumn":20,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Variable Assigned to Object Injection Sink","line":52,"column":26,"nodeType":"MemberExpression","endLine":52,"endColumn":46,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/pages/ChunkLoadErrorPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/pages/Counterparts.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/pages/Home.tsx","messages":[{"ruleId":"@typescript-eslint/no-floating-promises","severity":2,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":24,"column":5,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":24,"endColumn":18,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[979,979],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[979,979],"text":"await "},"desc":"Add await operator."}]},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":151,"column":28,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":151,"endColumn":90,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[4848,4901],"text":"Readonly<{ can: (action: string, subject: string) => boolean }>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Link } from \"@tanstack/react-router\";\nimport { ArrowRightLeft, ArrowUpRight, CalendarDays, Users, Wallet } from \"lucide-react\";\nimport { Suspense, useEffect } from \"react\";\n\nimport Skeleton from \"@/components/ui/Skeleton\";\nimport { useAuth } from \"@/context/AuthContext\";\nimport DashboardParticipantsSection from \"@/features/dashboard/components/DashboardParticipantsSection\";\nimport { DashboardPersonalLiabilities } from \"@/features/dashboard/components/DashboardPersonalLiabilities\";\nimport DashboardTransactionsSection from \"@/features/dashboard/components/DashboardTransactionsSection\";\nimport { daysAgo, today } from \"@/lib/dates\";\nimport { CARD_COMPACT, TITLE_MD } from \"@/lib/styles\";\n\nimport { useAppBadge } from \"../hooks/use-app-badge\";\nimport { useWakeLock } from \"../hooks/use-wake-lock\";\n\nconst RANGE_DAYS = 30;\n\nexport default function Home() {\n  useWakeLock();\n  const { clearBadge } = useAppBadge();\n  const { can } = useAuth();\n\n  useEffect(() => {\n    clearBadge();\n  }, [clearBadge]);\n\n  // Permissions\n  const canReadTransactions = can(\"read\", \"Transaction\");\n  const canReadPersons = can(\"read\", \"Person\");\n  const canReadDashboard = can(\"read\", \"Dashboard\");\n\n  const from = daysAgo(RANGE_DAYS);\n  const to = today();\n\n  const statsParams = { from, to };\n  const leaderboardParams = { from, limit: 5, mode: \"outgoing\" as const, to };\n\n  if (!canReadDashboard) {\n    return <div className=\"text-base-content/60 p-8 text-center\">No tienes permisos para ver el panel principal.</div>;\n  }\n\n  return (\n    <section className=\"space-y-4\">\n      <header className={CARD_COMPACT}>\n        <div className=\"card-body\">\n          <h1 className={TITLE_MD}>Panel</h1>\n          <p className=\"text-base-content/70 text-sm\">Últimos {RANGE_DAYS} días</p>\n        </div>\n      </header>\n\n      {canReadTransactions && (\n        <Suspense fallback={<DashboardSkeleton />}>\n          <DashboardTransactionsSection statsParams={statsParams} />\n        </Suspense>\n      )}\n\n      {!canReadTransactions && (\n        <div className=\"grid gap-4 lg:grid-cols-[1.5fr_1fr]\">\n          <div className=\"space-y-4\">\n            <DashboardPersonalLiabilities />\n            <QuickLinksSection can={can} />\n          </div>\n          <aside className=\"space-y-4\">\n            {/* If can't read transactions, maybe can read participants? */}\n            {canReadPersons && (\n              <Suspense fallback={<Skeleton className=\"h-64 w-full\" />}>\n                <DashboardParticipantsSection params={leaderboardParams} />\n              </Suspense>\n            )}\n          </aside>\n        </div>\n      )}\n\n      {/* If can read transactions, QuickLinks and Participants are inside the layout? \n          Wait, in previous layout:\n          grid lg:grid-cols-[1.5fr_1fr]\n            left: Charts + QuickLinks\n            right: Participants + RecentMovements\n          \n          My wrapper `DashboardTransactionsSection` returns:\n          Metrics (full width)\n          Grid (Charts + RecentMovements)\n          \n          It MISSES QuickLinks and Participants inside the grid structure.\n          \n          I need to compose them better.\n      */}\n    </section>\n  );\n}\n\nfunction DashboardSkeleton() {\n  return (\n    <div className=\"animate-pulse space-y-4\">\n      <div className=\"grid grid-cols-3 gap-3\">\n        <div className=\"bg-base-200 h-24 rounded-xl\" />\n        <div className=\"bg-base-200 h-24 rounded-xl\" />\n        <div className=\"bg-base-200 h-24 rounded-xl\" />\n      </div>\n      <div className=\"grid gap-4 lg:grid-cols-[1.5fr_1fr]\">\n        <div className=\"bg-base-200 h-64 rounded-xl\" />\n        <div className=\"bg-base-200 h-64 rounded-xl\" />\n      </div>\n    </div>\n  );\n}\n\nconst QUICK_LINKS = [\n  {\n    action: \"read\", // Minimum requirement\n    bg: \"bg-emerald-500/10\",\n    color: \"text-emerald-500\",\n    description: \"Actualiza saldos diarios y conciliaciones.\",\n    icon: Wallet,\n    subject: \"DailyBalance\",\n    title: \"Registrar saldo\",\n    to: \"/finanzas/production-balances\" as const,\n  },\n  {\n    action: \"read\",\n    bg: \"bg-blue-500/10\",\n    color: \"text-blue-500\",\n    description: \"Audita los movimientos y flujos de caja.\",\n    icon: ArrowRightLeft,\n    subject: \"Transaction\",\n    title: \"Ver movimientos\",\n    to: \"/finanzas/statistics\" as const,\n  },\n  {\n    action: \"read\",\n    bg: \"bg-violet-500/10\",\n    color: \"text-violet-500\",\n    description: \"Gestiona contrapartes y sus historiales.\",\n    icon: Users,\n    subject: \"Person\",\n    title: \"Participantes\",\n    to: \"/finanzas/participants\" as const,\n  },\n  {\n    action: \"read\",\n    bg: \"bg-amber-500/10\",\n    color: \"text-amber-500\",\n    description: \"Administra servicios recurrentes y agenda.\",\n    icon: CalendarDays,\n    subject: \"Service\",\n    title: \"Servicios\",\n    to: \"/services\" as const,\n  },\n] as const;\n\nfunction QuickLinksSection({ can }: { can: (action: string, subject: string) => boolean }) {\n  const links = QUICK_LINKS.filter((link) => can(link.action, link.subject));\n\n  if (links.length === 0) return null;\n\n  return (\n    <div className=\"card card-compact bg-base-100 shadow-sm\">\n      <div className=\"card-body\">\n        <h3 className=\"text-base-content mb-2 text-sm font-semibold\">Accesos rápidos</h3>\n        <div className=\"grid gap-2 sm:grid-cols-2\">\n          {links.map((link) => (\n            <Link\n              className=\"group border-base-200 bg-base-200/50 hover:bg-base-200 flex items-center gap-3 rounded-lg border p-3 transition-colors\"\n              key={link.to}\n              to={link.to}\n            >\n              <div className={`flex h-9 w-9 shrink-0 items-center justify-center rounded-lg ${link.bg} ${link.color}`}>\n                <link.icon className=\"h-5 w-5\" />\n              </div>\n              <div className=\"min-w-0 flex-1\">\n                <p className=\"text-base-content truncate text-sm font-medium\">{link.title}</p>\n                <p className=\"text-base-content/70 truncate text-xs\">{link.description}</p>\n              </div>\n              <ArrowUpRight className=\"text-base-content/60 h-4 w-4 shrink-0 transition-transform group-hover:translate-x-0.5 group-hover:-translate-y-0.5\" />\n            </Link>\n          ))}\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/pages/NotFoundPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/pages/ParticipantInsights.tsx","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always falsy.","line":145,"column":10,"nodeType":"Identifier","messageId":"alwaysFalsy","endLine":145,"endColumn":26}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { DataTable } from \"@/components/data-table/DataTable\";\nimport Alert from \"@/components/ui/Alert\";\nimport Button from \"@/components/ui/Button\";\nimport { Card, CardContent } from \"@/components/ui/Card\";\nimport Input from \"@/components/ui/Input\";\nimport {\n  getCounterpartsColumns,\n  getLeaderboardColumns,\n  getMonthlyColumns,\n  type LeaderboardMeta,\n} from \"@/features/participants/components/ParticipantColumns\";\nimport { useParticipantInsightsData } from \"@/features/participants/hooks/use-participant-insights-data\";\nimport { PAGE_CONTAINER } from \"@/lib/styles\";\n\nexport default function ParticipantInsightsPage() {\n  const {\n    counterparts,\n    detailError,\n    detailLoading,\n    displayedLeaderboard,\n    from,\n    handleSelectParticipant,\n    handleSubmit,\n    leaderboardError,\n    leaderboardGrouping,\n    leaderboardLimit,\n    leaderboardLoading,\n    monthly,\n    participantId,\n    quickMonth,\n    quickMonthOptions,\n    setFrom,\n    setLeaderboardGrouping,\n    setLeaderboardLimit,\n    setParticipantId,\n    setQuickMonth,\n    setTo,\n    to,\n    visible,\n  } = useParticipantInsightsData();\n\n  const leaderboardColumns = getLeaderboardColumns();\n  const monthlyColumns = getMonthlyColumns();\n  const counterpartsColumns = getCounterpartsColumns();\n\n  return (\n    <section className={PAGE_CONTAINER}>\n      <Card>\n        <CardContent className=\"p-6\">\n          <form className=\"grid items-end gap-6 sm:grid-cols-2 lg:grid-cols-4\" onSubmit={handleSubmit}>\n            <Input\n              enterKeyHint=\"search\"\n              inputMode=\"numeric\"\n              label=\"ID participante\"\n              onChange={(e) => {\n                setParticipantId(e.target.value);\n              }}\n              placeholder=\"123861706983\"\n              type=\"text\"\n              value={participantId}\n            />\n            <Input\n              as=\"select\"\n              label=\"Rango rápido\"\n              onChange={(e) => {\n                setQuickMonth(e.target.value);\n              }}\n              value={quickMonth}\n            >\n              {quickMonthOptions.map((option) => (\n                <option key={option.value} value={option.value}>\n                  {option.label}\n                </option>\n              ))}\n            </Input>\n            <Input\n              disabled={quickMonth !== \"custom\"}\n              label=\"Desde\"\n              onChange={(e) => {\n                setFrom(e.target.value);\n              }}\n              type=\"date\"\n              value={from}\n            />\n            <Input\n              disabled={quickMonth !== \"custom\"}\n              label=\"Hasta\"\n              onChange={(e) => {\n                setTo(e.target.value);\n              }}\n              type=\"date\"\n              value={to}\n            />\n            <div className=\"flex justify-end lg:col-span-4\">\n              <Button disabled={detailLoading} isLoading={detailLoading} type=\"submit\">\n                Consultar\n              </Button>\n            </div>\n          </form>\n        </CardContent>\n      </Card>\n\n      <div className=\"space-y-6\">\n        <div className=\"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between\">\n          <div className=\"space-y-1\">\n            <h2 className=\"text-lg font-semibold\">Ranking de retiros</h2>\n            <p className=\"text-base-content/70 text-sm\">Contrapartes con mayores egresos en el rango seleccionado.</p>\n          </div>\n          <div className=\"flex flex-wrap gap-4\">\n            <div className=\"w-32\">\n              <Input\n                as=\"select\"\n                className=\"select-sm\"\n                label=\"Mostrar top\"\n                onChange={(e) => {\n                  const value = Number(e.target.value);\n                  setLeaderboardLimit(Number.isFinite(value) ? value : 10);\n                }}\n                value={leaderboardLimit}\n              >\n                {[10, 20, 30].map((value) => (\n                  <option key={value} value={value}>\n                    {value}\n                  </option>\n                ))}\n              </Input>\n            </div>\n            <div className=\"w-40\">\n              <Input\n                as=\"select\"\n                className=\"select-sm\"\n                label=\"Agrupar por\"\n                onChange={(e) => {\n                  setLeaderboardGrouping(e.target.value as \"account\" | \"rut\");\n                }}\n                value={leaderboardGrouping}\n              >\n                <option value=\"account\">Cuenta bancaria</option>\n                <option value=\"rut\">RUT</option>\n              </Input>\n            </div>\n          </div>\n        </div>\n\n        {leaderboardError && <Alert variant=\"error\">{leaderboardError}</Alert>}\n\n        <Card>\n          <CardContent className=\"p-0\">\n            <DataTable\n              columns={leaderboardColumns}\n              data={displayedLeaderboard}\n              isLoading={leaderboardLoading}\n              meta={\n                {\n                  detailLoading,\n                  onSelect: handleSelectParticipant,\n                  participantId,\n                } as LeaderboardMeta\n              }\n              noDataMessage={leaderboardLoading ? \"Cargando ranking...\" : \"Sin participantes en el rango seleccionado.\"}\n            />\n          </CardContent>\n        </Card>\n      </div>\n\n      {detailError && <Alert variant=\"error\">{detailError}</Alert>}\n\n      {visible ? (\n        <div className=\"grid gap-6 lg:grid-cols-2\">\n          <section className=\"space-y-4\">\n            <h2 className=\"text-lg font-semibold\">Resumen mensual</h2>\n            <Card>\n              <CardContent className=\"p-0\">\n                <DataTable\n                  columns={monthlyColumns}\n                  data={monthly}\n                  isLoading={detailLoading}\n                  noDataMessage=\"Sin movimientos.\"\n                />\n              </CardContent>\n            </Card>\n          </section>\n\n          <section className=\"space-y-4\">\n            <h2 className=\"text-lg font-semibold\">Contrapartes</h2>\n            <Card>\n              <CardContent className=\"p-0\">\n                <DataTable\n                  columns={counterpartsColumns}\n                  data={counterparts}\n                  isLoading={detailLoading}\n                  noDataMessage=\"No hay contrapartes.\"\n                />\n              </CardContent>\n            </Card>\n          </section>\n        </div>\n      ) : (\n        <div className=\"text-base-content/50 py-12 text-center\">\n          {detailLoading\n            ? \"Buscando información del participante...\"\n            : \"Ingresa un identificador y selecciona el rango para ver su actividad.\"}\n        </div>\n      )}\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/pages/admin/AddUserPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":50,"column":5,"nodeType":"ChainExpression","messageId":"alwaysTruthy","endLine":56,"endColumn":6},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary optional chain on a non-nullish value.","line":50,"column":15,"nodeType":"MemberExpression","messageId":"neverOptionalChain","endLine":50,"endColumn":17,"suggestions":[{"messageId":"suggestRemoveOptionalChain","fix":{"range":[1548,1550],"text":"."},"desc":"Remove unnecessary optional chain"}]},{"ruleId":"@typescript-eslint/no-floating-promises","severity":2,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":65,"column":7,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":65,"endColumn":62,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[1973,1973],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[1973,1973],"text":"await "},"desc":"Add await operator."}]},{"ruleId":"@typescript-eslint/no-floating-promises","severity":2,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":66,"column":7,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":66,"endColumn":63,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[2035,2035],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[2035,2035],"text":"await "},"desc":"Add await operator."}]},{"ruleId":"@typescript-eslint/no-floating-promises","severity":2,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":68,"column":7,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":68,"endColumn":43,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[2144,2144],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[2144,2144],"text":"await "},"desc":"Add await operator."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMutation, useQueryClient, useSuspenseQuery } from \"@tanstack/react-query\";\nimport { useNavigate } from \"@tanstack/react-router\";\nimport { Shield, UserPlus, Users } from \"lucide-react\";\nimport { useState } from \"react\";\n\n// type AvailableRole removed\nimport type { Role } from \"@/types/roles\";\n\nimport Button from \"@/components/ui/Button\";\nimport Checkbox from \"@/components/ui/Checkbox\";\nimport Input from \"@/components/ui/Input\";\nimport { useToast } from \"@/context/ToastContext\";\nimport { fetchPeople } from \"@/features/people/api\";\nimport { fetchRoles } from \"@/features/roles/api\";\nimport { inviteUser } from \"@/features/users/api\";\nimport { getPersonFullName } from \"@/lib/person\";\n\nexport default function AddUserPage() {\n  const navigate = useNavigate();\n  const queryClient = useQueryClient();\n  const { error: toastError, success } = useToast();\n  const [form, setForm] = useState({\n    email: \"\",\n    fatherName: \"\",\n    linkToPerson: false,\n    mfaEnforced: true,\n    motherName: \"\",\n    names: \"\",\n    passkeyOnly: false,\n    personId: undefined as number | undefined,\n    position: \"\",\n    role: \"VIEWER\",\n    rut: \"\",\n  });\n\n  // Fetch available roles\n  const { data: availableRoles } = useSuspenseQuery({\n    queryFn: fetchRoles,\n    queryKey: [\"available-roles\"],\n  });\n\n  // Fetch people without users\n  const { data: peopleData } = useSuspenseQuery({\n    queryFn: fetchPeople,\n    queryKey: [\"people\"],\n  });\n\n  // Filter people who don't have a user yet and exclude test users\n  const availablePeople =\n    peopleData?.filter(\n      (p) =>\n        !p.user &&\n        !p.hasUser &&\n        !p.names.toLowerCase().includes(\"test\") &&\n        !p.names.toLowerCase().includes(\"usuario prueba\")\n    ) || [];\n\n  // Create user mutation\n  const createUserMutation = useMutation({\n    mutationFn: inviteUser,\n    onError: (err) => {\n      toastError(err instanceof Error ? err.message : \"Error al crear usuario\");\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"users\"] });\n      queryClient.invalidateQueries({ queryKey: [\"people\"] });\n      success(\"Usuario creado exitosamente\");\n      navigate({ to: \"/settings/users\" });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    const payload: Record<string, unknown> = {\n      email: form.email,\n      mfaEnforced: form.mfaEnforced,\n      passkeyOnly: form.passkeyOnly,\n      position: form.position,\n      role: form.role,\n    };\n\n    if (form.linkToPerson && form.personId) {\n      payload.personId = form.personId;\n    } else {\n      payload.names = form.names;\n      payload.fatherName = form.fatherName;\n      payload.motherName = form.motherName;\n      payload.rut = form.rut;\n    }\n\n    createUserMutation.mutate(payload);\n  };\n\n  const loading = createUserMutation.isPending;\n\n  return (\n    <div className=\"mx-auto max-w-2xl space-y-8\">\n      <div className=\"space-y-2\">\n        <h1 className=\"text-primary text-3xl font-bold\">Agregar usuario</h1>\n        <p className=\"text-base-content/70\">\n          Crea un nuevo usuario en el sistema. Se generará una contraseña temporal y el usuario deberá completar su\n          configuración de seguridad al iniciar sesión.\n        </p>\n      </div>\n\n      <form className=\"surface-elevated space-y-6 rounded-3xl p-6 shadow-lg\" onSubmit={handleSubmit}>\n        {/* Opción de vincular a persona existente */}\n        {availablePeople.length > 0 && (\n          <div className=\"border-info/20 bg-info/5 rounded-xl border p-4\">\n            <div className=\"flex items-start gap-3\">\n              <Users className=\"text-info mt-0.5 h-5 w-5\" />\n              <div className=\"flex-1 space-y-3\">\n                <div>\n                  <p className=\"text-info font-medium\">Vincular a persona existente</p>\n                  <p className=\"text-base-content/70 text-xs\">\n                    Si esta persona ya existe en el sistema, puedes vincular el usuario directamente.\n                  </p>\n                </div>\n                <div className=\"space-y-2\">\n                  <Input\n                    as=\"select\"\n                    id=\"personId\"\n                    label=\"Vincular con persona (opcional)\"\n                    onChange={(e) => {\n                      const pid = e.target.value ? Number(e.target.value) : undefined;\n                      const person = availablePeople.find((p) => p.id === pid);\n                      setForm({\n                        ...form,\n                        email: person?.email ?? form.email,\n                        fatherName: pid ? \"\" : form.fatherName,\n                        linkToPerson: !!pid,\n                        motherName: pid ? \"\" : form.motherName,\n                        names: pid ? \"\" : form.names,\n                        personId: pid,\n                        position: person?.employee?.position ?? form.position,\n                        rut: pid ? \"\" : form.rut,\n                      });\n                    }}\n                    value={form.personId ?? \"\"}\n                  >\n                    <option value=\"\">No vincular (Crear usuario nuevo)</option>\n                    {availablePeople.map((person) => (\n                      <option key={person.id} value={person.id}>\n                        {getPersonFullName(person)} - {person.rut}\n                      </option>\n                    ))}\n                  </Input>\n                </div>\n              </div>\n            </div>\n          </div>\n        )}\n\n        <div className=\"grid gap-6 md:grid-cols-2\">\n          {!form.personId && (\n            <>\n              <div className=\"md:col-span-2\">\n                <h3 className=\"text-base-content mb-4 font-semibold\">Datos personales</h3>\n              </div>\n              <Input\n                label=\"Nombres\"\n                onChange={(e) => {\n                  setForm({ ...form, names: e.target.value });\n                }}\n                placeholder=\"Ej: Juan Andrés\"\n                required={!form.personId}\n                value={form.names}\n              />\n              <Input\n                label=\"Apellido Paterno\"\n                onChange={(e) => {\n                  setForm({ ...form, fatherName: e.target.value });\n                }}\n                placeholder=\"Ej: Pérez\"\n                required={!form.personId}\n                value={form.fatherName}\n              />\n              <Input\n                label=\"Apellido Materno\"\n                onChange={(e) => {\n                  setForm({ ...form, motherName: e.target.value });\n                }}\n                placeholder=\"Ej: González\"\n                required={!form.personId}\n                value={form.motherName}\n              />\n              <Input\n                label=\"RUT\"\n                onChange={(e) => {\n                  setForm({ ...form, rut: e.target.value });\n                }}\n                placeholder=\"12.345.678-9\"\n                required={!form.personId}\n                value={form.rut}\n              />\n              <div className=\"md:col-span-1\">{/* Spacer */}</div>\n            </>\n          )}\n\n          <div className=\"md:col-span-2\">\n            <h3 className=\"text-base-content mt-2 mb-4 font-semibold\">Datos de cuenta</h3>\n          </div>\n\n          <div className=\"md:col-span-2\">\n            <Input\n              helper={form.personId ? \"Verifica o actualiza el correo asociado\" : undefined}\n              label=\"Correo electrónico\"\n              onChange={(e) => {\n                setForm({ ...form, email: e.target.value });\n              }}\n              placeholder=\"usuario@bioalergia.cl\"\n              required\n              type=\"email\"\n              value={form.email}\n            />\n          </div>\n\n          <Input\n            label=\"Cargo / posición\"\n            onChange={(e) => {\n              setForm({ ...form, position: e.target.value });\n            }}\n            placeholder=\"Ej: Enfermera, Administrativo\"\n            required\n            value={form.position}\n          />\n\n          <div className={form.personId ? \"md:col-span-2\" : \"\"}>\n            <label className=\"label\" htmlFor=\"role\">\n              <span className=\"label-text\">Rol</span>\n            </label>\n            <select\n              className=\"select select-bordered w-full\"\n              id=\"role\"\n              onChange={(e) => {\n                setForm({ ...form, role: e.target.value });\n              }}\n              required\n              value={form.role}\n            >\n              {availableRoles.length === 0 && <option value=\"VIEWER\">VIEWER (Fallback)</option>}\n              {availableRoles.map((role: Role) => (\n                <option key={role.name} value={role.name}>\n                  {role.name} {role.description ? `- ${role.description}` : \"\"}\n                </option>\n              ))}\n            </select>\n          </div>\n        </div>\n\n        <div className=\"border-primary/20 bg-primary/5 rounded-xl border p-4\">\n          <div className=\"flex items-start gap-3\">\n            <Shield className=\"text-primary mt-0.5 h-5 w-5\" />\n            <div className=\"space-y-1\">\n              <p className=\"text-primary font-medium\">Seguridad reforzada</p>\n              <p className=\"text-base-content/70 text-xs\">\n                Si activas esta opción, el usuario estará <strong>obligado</strong> a configurar Passkey o MFA (Google\n                Authenticator) antes de poder usar el sistema.\n              </p>\n            </div>\n          </div>\n          <div className=\"mt-4 space-y-3 pl-8\">\n            <Checkbox\n              checked={form.mfaEnforced}\n              label=\"Forzar passkey o MFA\"\n              onChange={(e) => {\n                setForm({ ...form, mfaEnforced: e.target.checked });\n              }}\n            />\n          </div>\n        </div>\n\n        <div className=\"flex justify-end gap-3 pt-4\">\n          <Button onClick={() => navigate({ to: \"/settings/users\" })} type=\"button\" variant=\"secondary\">\n            Cancelar\n          </Button>\n          <Button className=\"gap-2\" disabled={loading} type=\"submit\">\n            <UserPlus size={18} />\n            {loading ? \"Creando...\" : \"Crear usuario\"}\n          </Button>\n        </div>\n      </form>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/pages/onboarding/OnboardingWizard.tsx","messages":[{"ruleId":"security/detect-non-literal-regexp","severity":1,"message":"Found non-literal argument to RegExp Constructor","line":132,"column":23,"nodeType":"NewExpression","endLine":132,"endColumn":84},{"ruleId":"security/detect-non-literal-regexp","severity":1,"message":"Found non-literal argument to RegExp Constructor","line":136,"column":23,"nodeType":"NewExpression","endLine":136,"endColumn":84},{"ruleId":"security/detect-possible-timing-attacks","severity":1,"message":"Potential timing attack, left side: true","line":187,"column":5,"nodeType":"IfStatement","endLine":190,"endColumn":6}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMutation, useSuspenseQuery } from \"@tanstack/react-query\";\nimport { useNavigate } from \"@tanstack/react-router\";\nimport { ArrowRight, Check, CreditCard, Fingerprint, Key, Loader2, Shield, Smartphone, User } from \"lucide-react\";\nimport { useEffect, useState } from \"react\";\n\nimport Button from \"@/components/ui/Button\";\nimport Input from \"@/components/ui/Input\";\nimport { useAuth } from \"@/context/AuthContext\";\nimport { enableMfa, fetchPasskeyRegistrationOptions, setupMfa, verifyPasskeyRegistration } from \"@/features/auth/api\";\nimport { fetchUserProfile, setupUser } from \"@/features/users/api\";\nimport { formatRut, validateRut } from \"@/lib/rut\";\nimport { cn } from \"@/lib/utils\";\n\nconst STEPS = [\n  { id: \"welcome\", title: \"Bienvenida\" },\n  { id: \"profile\", title: \"Datos personales\" },\n  { id: \"financial\", title: \"Datos bancarios\" },\n  { id: \"password\", title: \"Contraseña\" },\n  { id: \"mfa\", title: \"MFA\" },\n  { id: \"complete\", title: \"Listo\" },\n];\n\ninterface ProfileData {\n  address: string;\n  bankAccountNumber: string;\n  bankAccountType: string;\n  bankName: string;\n  fatherName: string;\n  motherName: string;\n  names: string;\n  phone: string;\n  rut: string;\n}\n\nexport default function OnboardingWizard() {\n  const { refreshSession, user } = useAuth();\n  const navigate = useNavigate();\n  const [currentStep, setCurrentStep] = useState(0);\n  const [error, setError] = useState<null | string>(null);\n\n  // Security: Redirect if user already completed onboarding\n  useEffect(() => {\n    if (user && user.status !== \"PENDING_SETUP\") {\n      void navigate({ replace: true, to: \"/\" });\n    }\n  }, [user, navigate]);\n\n  // Queries\n  const { data: profileData } = useSuspenseQuery({\n    queryFn: fetchUserProfile,\n    queryKey: [\"user-profile\"],\n    refetchOnWindowFocus: false,\n  });\n\n  // Form State\n  const [profile, setProfile] = useState<ProfileData>(() => ({\n    address: profileData.address ?? \"\",\n    bankAccountNumber: profileData.bankAccountNumber ?? \"\",\n    bankAccountType: profileData.bankAccountType ?? \"\",\n    bankName: profileData.bankName ?? \"\",\n    fatherName: profileData.fatherName,\n    motherName: profileData.motherName ?? \"\",\n    names: profileData.names,\n    phone: profileData.phone ?? \"\",\n    rut: profileData.rut,\n  }));\n\n  const [mfaCode, setMfaCode] = useState(\"\");\n  const [mfaSecret, setMfaSecret] = useState<null | { qrCodeUrl: string; secret: string }>(null);\n  const [mfaEnabled, setMfaEnabled] = useState(false);\n\n  // Password state\n  const [password, setPassword] = useState(\"\");\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\n\n  // Mutations\n  const mfaSetupMutation = useMutation({\n    mutationFn: () =>\n      setupMfa().then((res) => {\n        if (res.status !== \"ok\") throw new Error(res.message ?? \"Error al iniciar configuración MFA\");\n        return res;\n      }),\n    onError: () => {\n      setError(\"Error de conexión\");\n    },\n    onSuccess: (data) => {\n      setMfaSecret({ qrCodeUrl: data.qrCodeUrl, secret: data.secret });\n    },\n  });\n\n  const mfaVerifyMutation = useMutation({\n    mutationFn: (token: string) =>\n      enableMfa({ secret: mfaSecret?.secret, token }).then((res) => {\n        if (res.status !== \"ok\") throw new Error(res.message ?? \"Código incorrecto\");\n        return res;\n      }),\n    onError: (err) => {\n      setError(err instanceof Error ? err.message : \"Código incorrecto\");\n    },\n    onSuccess: () => {\n      setMfaEnabled(true);\n      handleNext();\n    },\n  });\n\n  const passkeyRegisterMutation = useMutation({\n    mutationFn: async () => {\n      const options = await fetchPasskeyRegistrationOptions();\n      if (options.status === \"error\") throw new Error(options.message);\n\n      const { startRegistration } = await import(\"@simplewebauthn/browser\");\n      const attResp = await startRegistration({ optionsJSON: options });\n\n      const verifyData = await verifyPasskeyRegistration({ body: attResp, challenge: options.challenge });\n      if (verifyData.status !== \"ok\") throw new Error(verifyData.message ?? \"Error al verificar passkey\");\n    },\n    onError: (err) => {\n      console.error(err);\n      setError(\"No se pudo registrar el Passkey. Intenta nuevamente o usa la App Autenticadora.\");\n    },\n    onSuccess: () => {\n      setMfaEnabled(true);\n      handleNext();\n    },\n  });\n\n  const finalSubmitMutation = useMutation({\n    mutationFn: async () => {\n      // Logic to prevent surname duplication in 'names' field\n      let cleanNames = profile.names.trim();\n      if (profile.motherName) {\n        const regex = new RegExp(String.raw`\\s+${profile.motherName.trim()}$`, \"i\");\n        cleanNames = cleanNames.replace(regex, \"\");\n      }\n      if (profile.fatherName) {\n        const regex = new RegExp(String.raw`\\s+${profile.fatherName.trim()}$`, \"i\");\n        cleanNames = cleanNames.replace(regex, \"\");\n      }\n      cleanNames = cleanNames.trim();\n\n      await setupUser({\n        ...profile,\n        names: cleanNames,\n        password,\n      });\n      await refreshSession();\n    },\n    onError: () => {\n      setError(\"Error al finalizar la configuración. Inténtalo de nuevo.\");\n    },\n    onSuccess: () => {\n      void navigate({ to: \"/\" });\n    },\n  });\n\n  const loading =\n    mfaSetupMutation.isPending ||\n    mfaVerifyMutation.isPending ||\n    passkeyRegisterMutation.isPending ||\n    finalSubmitMutation.isPending;\n\n  const handleNext = () => {\n    setError(null);\n    setCurrentStep((prev) => prev + 1);\n  };\n\n  const handleProfileSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!profile.names || !profile.rut) {\n      setError(\"Nombres y RUT son obligatorios\");\n      return;\n    }\n    if (!validateRut(profile.rut)) {\n      setError(\"El RUT ingresado no es válido\");\n      return;\n    }\n    handleNext();\n  };\n\n  const handleFinancialSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    handleNext();\n  };\n\n  const handlePasswordSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (password !== confirmPassword) {\n      setError(\"Las contraseñas no coinciden\");\n      return;\n    }\n    if (password.length < 8) {\n      setError(\"La contraseña debe tener al menos 8 caracteres\");\n      return;\n    }\n    handleNext();\n  };\n\n  const verifyMfa = () => {\n    mfaVerifyMutation.mutate(mfaCode);\n  };\n  const handlePasskeyRegister = () => {\n    passkeyRegisterMutation.mutate();\n  };\n\n  const { mutate: triggerSetupMfa } = mfaSetupMutation;\n\n  // Initialize MFA generation when entering step\n  useEffect(() => {\n    if (currentStep === 4 && !mfaSecret && !mfaEnabled) {\n      triggerSetupMfa();\n    }\n  }, [currentStep, mfaSecret, mfaEnabled, triggerSetupMfa]);\n\n  const handleFinalSubmit = () => {\n    finalSubmitMutation.mutate();\n  };\n\n  return (\n    <div className=\"bg-base-200 flex min-h-screen items-center justify-center p-4\">\n      <div className=\"bg-base-100 flex max-h-[90vh] w-full max-w-2xl flex-col overflow-hidden rounded-3xl shadow-xl\">\n        {/* Progress Bar */}\n        <div className=\"mb-4 p-4\">\n          <div className=\"relative mx-auto flex max-w-4xl items-center justify-between px-4\">\n            {/* Connecting Line */}\n            <div className=\"bg-base-300 absolute top-1/2 left-0 z-0 h-0.5 w-full -translate-y-1/2\" />\n            <div\n              className=\"bg-primary absolute top-1/2 left-0 z-0 h-0.5 -translate-y-1/2 transition-all duration-500\"\n              style={{ width: `${(currentStep / (STEPS.length - 1)) * 100}%` }}\n            />\n\n            {STEPS.map((step, idx) => (\n              <div className=\"relative z-10 flex flex-col items-center gap-2 px-1\" key={step.id}>\n                <div\n                  className={cn(\n                    \"flex h-8 w-8 items-center justify-center rounded-full border-4 text-xs font-bold transition-all duration-300 sm:h-10 sm:w-10 sm:text-sm\",\n                    idx <= currentStep\n                      ? \"bg-primary text-primary-content border-primary shadow-primary/30 scale-110 shadow-lg\"\n                      : \"bg-base-100 text-base-content/50 border-base-200\"\n                  )}\n                >\n                  {idx < currentStep ? <Check size={14} strokeWidth={3} /> : idx + 1}\n                </div>\n                <span\n                  className={cn(\n                    \"absolute top-full mt-2 text-[10px] font-medium tracking-wider whitespace-nowrap uppercase transition-colors\",\n                    idx <= currentStep ? \"text-primary\" : \"text-base-content/60\",\n                    // Show all labels on sm+ screens, smart hiding on very small screens\n                    \"hidden sm:block\",\n                    // Always show current step label even on mobile\n                    idx === currentStep && \"block\",\n                    // Center the text\n                    \"left-1/2 -translate-x-1/2\"\n                  )}\n                >\n                  {step.title}\n                </span>\n              </div>\n            ))}\n          </div>\n        </div>\n\n        <div className=\"flex-1 overflow-y-auto p-6 sm:p-8\">\n          {error && (\n            <div className=\"alert alert-error mb-6 py-2 text-sm\">\n              <span>{error}</span>\n            </div>\n          )}\n\n          {currentStep === 0 && (\n            <div className=\"animate-in fade-in slide-in-from-bottom-4 space-y-6 py-8 text-center duration-500\">\n              <div className=\"bg-primary/10 text-primary mx-auto flex h-20 w-20 items-center justify-center rounded-full\">\n                <Shield size={40} />\n              </div>\n              <div>\n                <h1 className=\"text-base-content text-2xl font-bold break-all sm:text-3xl\">Hola, {user?.email}</h1>\n                <p className=\"text-base-content/60 mx-auto mt-2 max-w-md\">\n                  Bienvenido a la intranet de Bioalergia. Antes de comenzar, necesitamos completar tu perfil y asegurar\n                  tu cuenta.\n                </p>\n              </div>\n              <Button\n                className=\"shadow-primary/20 w-full max-w-xs gap-2 shadow-lg\"\n                onClick={handleNext}\n                size=\"lg\"\n                variant=\"primary\"\n              >\n                Comenzar <ArrowRight size={20} />\n              </Button>\n            </div>\n          )}\n\n          {currentStep === 1 && (\n            <form\n              className=\"animate-in fade-in slide-in-from-right-4 space-y-6 duration-500\"\n              onSubmit={handleProfileSubmit}\n            >\n              <div className=\"mb-6 text-center\">\n                <div className=\"bg-primary/10 text-primary mx-auto mb-3 flex h-12 w-12 items-center justify-center rounded-full\">\n                  <User size={24} />\n                </div>\n                <h2 className=\"text-2xl font-bold\">Datos personales</h2>\n                <p className=\"text-base-content/60 text-sm\">Información básica para tu perfil.</p>\n              </div>\n\n              <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2\">\n                <div className=\"form-control\">\n                  <Input\n                    label=\"Nombres (sin apellidos)\"\n                    onChange={(e) => {\n                      setProfile({ ...profile, names: e.target.value });\n                    }}\n                    required\n                    value={profile.names}\n                  />\n                </div>\n                <div className=\"form-control\">\n                  <Input\n                    error={error?.includes(\"RUT\") ? \"RUT inválido\" : undefined}\n                    label=\"RUT\"\n                    onBlur={() => {\n                      const formatted = formatRut(profile.rut);\n                      setProfile({ ...profile, rut: formatted });\n                      if (formatted && !validateRut(formatted)) {\n                        setError(\"RUT inválido\");\n                      } else {\n                        setError(null);\n                      }\n                    }}\n                    onChange={(e) => {\n                      const val = e.target.value;\n                      setProfile({ ...profile, rut: val });\n                    }}\n                    placeholder=\"12.345.678-9\"\n                    required\n                    value={profile.rut}\n                  />\n                </div>\n                <div className=\"form-control\">\n                  <Input\n                    label=\"Primer apellido\"\n                    onChange={(e) => {\n                      setProfile({ ...profile, fatherName: e.target.value });\n                    }}\n                    value={profile.fatherName}\n                  />\n                </div>\n                <div className=\"form-control\">\n                  <Input\n                    label=\"Segundo apellido\"\n                    onChange={(e) => {\n                      setProfile({ ...profile, motherName: e.target.value });\n                    }}\n                    value={profile.motherName}\n                  />\n                </div>\n                <div className=\"form-control\">\n                  <Input\n                    label=\"Teléfono\"\n                    onChange={(e) => {\n                      setProfile({ ...profile, phone: e.target.value });\n                    }}\n                    type=\"tel\"\n                    value={profile.phone}\n                  />\n                </div>\n                <div className=\"form-control md:col-span-2\">\n                  <Input\n                    label=\"Dirección\"\n                    onChange={(e) => {\n                      setProfile({ ...profile, address: e.target.value });\n                    }}\n                    value={profile.address}\n                  />\n                </div>\n              </div>\n\n              <div className=\"mt-6 flex justify-end\">\n                <Button className=\"w-full px-8 sm:w-auto\" type=\"submit\" variant=\"primary\">\n                  Siguiente\n                </Button>\n              </div>\n            </form>\n          )}\n\n          {currentStep === 2 && (\n            <form\n              className=\"animate-in fade-in slide-in-from-right-4 space-y-6 duration-500\"\n              onSubmit={handleFinancialSubmit}\n            >\n              <div className=\"mb-6 text-center\">\n                <div className=\"bg-secondary/10 text-secondary mx-auto mb-3 flex h-12 w-12 items-center justify-center rounded-full\">\n                  <CreditCard size={24} />\n                </div>\n                <h2 className=\"text-2xl font-bold\">Datos bancarios</h2>\n                <p className=\"text-base-content/60 text-sm\">Para gestionar tus pagos y remuneraciones.</p>\n              </div>\n\n              <div className=\"space-y-4\">\n                <div className=\"form-control\">\n                  <Input\n                    label=\"Banco\"\n                    onChange={(e) => {\n                      setProfile({ ...profile, bankName: e.target.value });\n                    }}\n                    placeholder=\"Ej: Banco de Chile\"\n                    value={profile.bankName}\n                  />\n                </div>\n                <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2\">\n                  <div className=\"form-control\">\n                    <Input\n                      as=\"select\"\n                      label=\"Tipo de cuenta\"\n                      onChange={(e) => {\n                        setProfile({ ...profile, bankAccountType: e.target.value });\n                      }}\n                      value={profile.bankAccountType}\n                    >\n                      <option value=\"\">Seleccionar...</option>\n                      <option value=\"Corriente\">Cuenta corriente</option>\n                      <option value=\"Vista\">Cuenta vista / RUT</option>\n                      <option value=\"Ahorro\">Cuenta de ahorro</option>\n                    </Input>\n                  </div>\n                  <div className=\"form-control\">\n                    <Input\n                      label=\"Número de cuenta\"\n                      onChange={(e) => {\n                        setProfile({ ...profile, bankAccountNumber: e.target.value });\n                      }}\n                      value={profile.bankAccountNumber}\n                    />\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"mt-6 flex justify-end gap-3\">\n                <Button\n                  onClick={() => {\n                    setCurrentStep((prev) => prev - 1);\n                  }}\n                  type=\"button\"\n                  variant=\"ghost\"\n                >\n                  Atrás\n                </Button>\n                <Button className=\"w-full px-8 sm:w-auto\" type=\"submit\" variant=\"primary\">\n                  Siguiente\n                </Button>\n              </div>\n            </form>\n          )}\n\n          {currentStep === 3 && (\n            <form\n              className=\"animate-in fade-in slide-in-from-right-4 space-y-6 duration-500\"\n              onSubmit={handlePasswordSubmit}\n            >\n              <div className=\"mb-6 text-center\">\n                <div className=\"bg-accent/10 text-accent mx-auto mb-3 flex h-12 w-12 items-center justify-center rounded-full\">\n                  <Key size={24} />\n                </div>\n                <h2 className=\"text-2xl font-bold\">Seguridad</h2>\n                <p className=\"text-base-content/60 text-sm\">Crea una contraseña segura.</p>\n              </div>\n\n              <div className=\"space-y-4\">\n                <div className=\"form-control\">\n                  <Input\n                    label=\"Nueva contraseña\"\n                    minLength={8}\n                    onChange={(e) => {\n                      setPassword(e.target.value);\n                    }}\n                    required\n                    type=\"password\"\n                    value={password}\n                  />\n                </div>\n                <div className=\"form-control\">\n                  <Input\n                    label=\"Confirmar contraseña\"\n                    minLength={8}\n                    onChange={(e) => {\n                      setConfirmPassword(e.target.value);\n                    }}\n                    required\n                    type=\"password\"\n                    value={confirmPassword}\n                  />\n                </div>\n              </div>\n\n              <div className=\"mt-6 flex justify-end gap-3\">\n                <Button\n                  onClick={() => {\n                    setCurrentStep((prev) => prev - 1);\n                  }}\n                  type=\"button\"\n                  variant=\"ghost\"\n                >\n                  Atrás\n                </Button>\n                <Button className=\"w-full px-8 sm:w-auto\" type=\"submit\" variant=\"primary\">\n                  Siguiente\n                </Button>\n              </div>\n            </form>\n          )}\n\n          {currentStep === 4 && (\n            <div className=\"animate-in fade-in slide-in-from-right-4 space-y-6 duration-500\">\n              <div className=\"mb-6 text-center\">\n                <div className=\"bg-warning/10 text-warning mx-auto mb-3 flex h-12 w-12 items-center justify-center rounded-full\">\n                  <Smartphone size={24} />\n                </div>\n                <h2 className=\"text-2xl font-bold\">Configurar MFA</h2>\n                <p className=\"text-base-content/60 text-sm\">\n                  Escanea el código con tu app de autenticación (Google Authenticator, Microsoft Authenticator, Apple\n                  Passwords, etc).\n                </p>\n              </div>\n\n              {(() => {\n                if (loading && !mfaSecret) {\n                  return (\n                    <div className=\"flex justify-center py-8\">\n                      <Loader2 className=\"text-primary animate-spin\" size={40} />\n                    </div>\n                  );\n                }\n\n                if (mfaSecret) {\n                  return (\n                    <div className=\"flex flex-col items-center gap-6\">\n                      <div className=\"rounded-xl bg-white p-4 shadow-sm\">\n                        <img\n                          alt=\"QR Code\"\n                          className=\"h-48 w-48\"\n                          decoding=\"async\"\n                          loading=\"lazy\"\n                          src={mfaSecret.qrCodeUrl}\n                        />\n                      </div>\n\n                      <div className=\"form-control w-full max-w-xs\">\n                        <Input\n                          className=\"text-center text-2xl tracking-widest\"\n                          inputMode=\"numeric\"\n                          label=\"Ingresa el código de 6 dígitos\"\n                          maxLength={6}\n                          onChange={(e) => {\n                            setMfaCode(e.target.value);\n                          }}\n                          pattern=\"[0-9]*\"\n                          placeholder=\"000000\"\n                          type=\"text\"\n                          value={mfaCode}\n                        />\n                      </div>\n\n                      <Button\n                        className=\"w-full max-w-xs\"\n                        disabled={mfaCode.length !== 6 || loading}\n                        onClick={verifyMfa}\n                        variant=\"primary\"\n                      >\n                        {loading ? <Loader2 className=\"animate-spin\" /> : \"Verificar y activar\"}\n                      </Button>\n\n                      <div className=\"divider text-base-content/40 text-xs\">O usa biometría</div>\n\n                      <Button\n                        className=\"w-full max-w-xs gap-2\"\n                        disabled={loading}\n                        onClick={handlePasskeyRegister}\n                        variant=\"outline\"\n                      >\n                        <Fingerprint size={20} />\n                        Registrar passkey (huella/FaceID)\n                      </Button>\n\n                      <Button\n                        className=\"text-base-content/50 hover:text-base-content mt-2\"\n                        disabled={loading}\n                        onClick={handleNext}\n                        size=\"sm\"\n                        variant=\"ghost\"\n                      >\n                        Omitir por ahora\n                      </Button>\n                    </div>\n                  );\n                }\n\n                return <div className=\"text-error text-center\">No se pudo cargar el código QR.</div>;\n              })()}\n            </div>\n          )}\n\n          {currentStep === 5 && (\n            <div className=\"animate-in fade-in zoom-in space-y-6 py-8 text-center duration-500\">\n              <div className=\"bg-success/10 text-success mx-auto flex h-24 w-24 items-center justify-center rounded-full\">\n                <Check size={48} strokeWidth={3} />\n              </div>\n              <div>\n                <h1 className=\"text-base-content text-3xl font-bold\">¡Todo listo!</h1>\n                <p className=\"text-base-content/60 mt-2\">Tu perfil ha sido completado y tu cuenta está segura.</p>\n              </div>\n              <Button\n                className=\"shadow-primary/20 w-full max-w-xs shadow-lg\"\n                disabled={loading}\n                onClick={handleFinalSubmit}\n                size=\"lg\"\n                variant=\"primary\"\n              >\n                {loading ? <Loader2 className=\"animate-spin\" /> : \"Finalizar e ir al dashboard\"}\n              </Button>\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/pages/settings/AccessSettingsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-floating-promises","severity":2,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":26,"column":7,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":26,"endColumn":76,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[1182,1182],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[1182,1182],"text":"await "},"desc":"Add await operator."}]},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":52,"column":8,"nodeType":"Identifier","messageId":"alwaysTruthy","endLine":52,"endColumn":13},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":112,"column":12,"nodeType":"Identifier","messageId":"alwaysTruthy","endLine":112,"endColumn":17}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMutation, useQueryClient, useSuspenseQuery } from \"@tanstack/react-query\";\nimport { Key, Lock, Shield, ShieldCheck, UserCog } from \"lucide-react\";\n\nimport { DataTable } from \"@/components/data-table/DataTable\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/Card\";\nimport { useAuth } from \"@/context/AuthContext\";\nimport { useToast } from \"@/context/ToastContext\";\nimport { toggleUserMfa } from \"@/features/users/api\";\nimport { getUserAccessColumns } from \"@/features/users/components/UserAccessColumns\";\nimport { userKeys } from \"@/features/users/queries\";\n\nexport default function AccessSettingsPage() {\n  const { error: toastError, success } = useToast();\n  const { can } = useAuth();\n  const queryClient = useQueryClient();\n  const isAdmin = can(\"update\", \"User\");\n\n  const { data: users } = useSuspenseQuery(userKeys.adminList());\n\n  const toggleMfaMutation = useMutation({\n    mutationFn: ({ enabled, userId }: { enabled: boolean; userId: number }) => toggleUserMfa(userId, enabled),\n    onError: (err) => {\n      toastError(err instanceof Error ? err.message : \"Error desconocido\");\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"users\", \"admin-list\"] });\n      success(\"Estado MFA actualizado correctamente\");\n    },\n  });\n\n  const columns = getUserAccessColumns((userId, enabled) => {\n    toggleMfaMutation.mutate({ enabled, userId });\n  }, toggleMfaMutation.isPending);\n\n  if (!isAdmin) {\n    return (\n      <Card>\n        <CardContent className=\"p-8 text-center\">\n          <Lock className=\"text-base-content/30 mx-auto size-12\" />\n          <h3 className=\"mt-4 text-lg font-semibold\">Acceso restringido</h3>\n          <p className=\"text-base-content/60 text-sm\">\n            Solo los administradores pueden gestionar la seguridad de usuarios.\n          </p>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <div className=\"space-y-8\">\n      {/* Security Overview Cards */}\n      {users && (\n        <div className=\"grid gap-4 md:grid-cols-3\">\n          <Card>\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"bg-primary/10 text-primary flex h-12 w-12 items-center justify-center rounded-full\">\n                  <UserCog size={24} />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{users.length}</p>\n                  <p className=\"text-base-content/60 text-sm\">Usuarios totales</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"bg-success/10 text-success flex h-12 w-12 items-center justify-center rounded-full\">\n                  <Shield size={24} />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{users.filter((u) => u.mfaEnabled).length}</p>\n                  <p className=\"text-base-content/60 text-sm\">Con MFA activo</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"bg-info/10 text-info flex h-12 w-12 items-center justify-center rounded-full\">\n                  <Key size={24} />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{users.filter((u) => u.hasPasskey).length}</p>\n                  <p className=\"text-base-content/60 text-sm\">Con passkey</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      {/* User Management Section */}\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <CardTitle className=\"text-xl\">Gestión de usuarios</CardTitle>\n              <CardDescription>Administra el nivel de seguridad de cada cuenta de usuario</CardDescription>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <DataTable columns={columns} data={users} noDataMessage=\"No se encontraron usuarios.\" />\n\n          {/* Security Recommendations */}\n          {users && (\n            <div className=\"bg-info/10 mt-6 rounded-lg p-4\">\n              <div className=\"flex items-start gap-3\">\n                <ShieldCheck className=\"text-info mt-0.5 size-5\" />\n                <div className=\"flex-1\">\n                  <h3 className=\"text-info font-semibold\">Recomendaciones de seguridad</h3>\n                  <ul className=\"text-base-content/70 mt-2 space-y-1 text-sm\">\n                    <li>\n                      • <strong>MFA (Autenticación Multifactor):</strong> Añade una capa extra de seguridad solicitando\n                      un código de verificación además de la contraseña.\n                    </li>\n                    <li>\n                      • <strong>Passkey (Biometría):</strong> Permite iniciar sesión de forma segura usando huella\n                      digital, reconocimiento facial o clave de dispositivo.\n                    </li>\n                    <li>• Se recomienda que todos los usuarios activen ambas opciones para máxima seguridad.</li>\n                  </ul>\n                </div>\n              </div>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/pages/settings/BackupSettingsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":2,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":62,"column":33,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":62,"endColumn":43},{"ruleId":"unicorn/no-array-reduce","severity":2,"message":"`Array#reduce()` is not allowed. Prefer other types of loop for readability.","line":133,"column":29,"nodeType":"Identifier","messageId":"reduce","endLine":133,"endColumn":35},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":134,"column":21,"nodeType":"MemberExpression","messageId":"neverNullish","endLine":134,"endColumn":27},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":308,"column":20,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":308,"endColumn":88,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[10811,10856],"text":"Readonly<{ backup: BackupFile; onSuccess: () => void }>"},"desc":"Mark the props as read-only"}]},{"ruleId":"@typescript-eslint/no-invalid-void-type","severity":2,"message":"void is not valid as a constituent in a union type","line":315,"column":78,"nodeType":"TSVoidKeyword","messageId":"invalidVoidUnionConstituent","endLine":315,"endColumn":82},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, expected left-hand side of `??` operator to be possibly null or undefined.","line":316,"column":55,"nodeType":"Identifier","messageId":"neverNullish","endLine":316,"endColumn":61},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":420,"column":27,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":431,"endColumn":2,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[14938,15072],"text":"Readonly<{\n  backupId: string;\n  canRestore: boolean;\n  createdTime: string;\n  isRestoring: boolean;\n  onRestore: (tables: string[]) => void;\n}>"},"desc":"Mark the props as read-only"}]},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":497,"column":19,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":507,"endColumn":2,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[17500,17615],"text":"Readonly<{\n  color: \"info\" | \"primary\" | \"success\" | \"warning\";\n  icon: React.ReactNode;\n  label: string;\n  value: string;\n}>"},"desc":"Mark the props as read-only"}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Function Call Object Injection Sink","line":518,"column":46,"nodeType":"MemberExpression","endLine":518,"endColumn":61}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMutation, useQueryClient, useSuspenseQuery } from \"@tanstack/react-query\";\nimport dayjs from \"dayjs\";\nimport relativeTime from \"dayjs/plugin/relativeTime\";\nimport {\n  AlertTriangle,\n  CheckCircle,\n  ChevronDown,\n  ChevronRight,\n  Clock,\n  Database,\n  Download,\n  FileText,\n  HardDrive,\n  Loader2,\n  Lock,\n  Play,\n  RefreshCw,\n  RotateCcw,\n  Upload,\n} from \"lucide-react\";\nimport { Suspense, useEffect, useState } from \"react\";\n\nimport type { BackupFile, BackupJob, RestoreJob } from \"@/features/backup/types\";\n\nimport GoogleDriveConnect from \"@/components/backup/GoogleDriveConnect\";\nimport Button from \"@/components/ui/Button\";\nimport { useAuth } from \"@/context/AuthContext\";\nimport { useToast } from \"@/context/ToastContext\";\nimport { triggerBackup, triggerRestore } from \"@/features/backup/api\";\nimport { backupKeys } from \"@/features/backup/queries\";\nimport { formatFileSize } from \"@/lib/format\";\nimport { PAGE_CONTAINER } from \"@/lib/styles\";\nimport { cn } from \"@/lib/utils\";\n\nimport \"dayjs/locale/es\";\n\ndayjs.extend(relativeTime);\ndayjs.locale(\"es\");\n\n// ==================== MAIN COMPONENT ====================\n\nexport default function BackupSettingsPage() {\n  const { can } = useAuth();\n  const { error: showError, success } = useToast();\n  const queryClient = useQueryClient();\n\n  // Permissions\n  const canCreate = can(\"create\", \"Backup\");\n\n  // SSE state for live progress only\n  const [liveJobs, setLiveJobs] = useState<{ backup: BackupJob | null; restore: null | RestoreJob }>({\n    backup: null,\n    restore: null,\n  });\n\n  // SSE connection for real-time progress\n  useEffect(() => {\n    const eventSource = new EventSource(\"/api/backups/progress\");\n\n    const handleMessage = (event: MessageEvent) => {\n      try {\n        const data = JSON.parse(event.data) as {\n          job: BackupJob | RestoreJob;\n          jobs: { backup: BackupJob | null; restore: null | RestoreJob };\n          type: \"backup\" | \"init\" | \"restore\";\n        };\n        switch (data.type) {\n          case \"backup\": {\n            setLiveJobs((prev) => ({ ...prev, backup: data.job as BackupJob }));\n            if (data.job.status === \"completed\" || data.job.status === \"failed\") {\n              void queryClient.invalidateQueries({ queryKey: [\"backups\"] });\n            }\n\n            break;\n          }\n          case \"init\": {\n            setLiveJobs(data.jobs);\n\n            break;\n          }\n          case \"restore\": {\n            setLiveJobs((prev) => ({ ...prev, restore: data.job as RestoreJob }));\n            if (data.job.status === \"completed\" || data.job.status === \"failed\") {\n              void queryClient.invalidateQueries({ queryKey: [\"backups\"] });\n            }\n\n            break;\n          }\n          // No default\n        }\n      } catch {\n        // Ignore parse errors\n      }\n    };\n\n    const handleError = () => {\n      eventSource.close();\n    };\n\n    eventSource.addEventListener(\"message\", handleMessage);\n    eventSource.addEventListener(\"error\", handleError);\n\n    return () => {\n      eventSource.removeEventListener(\"message\", handleMessage);\n      eventSource.removeEventListener(\"error\", handleError);\n      eventSource.close();\n    };\n  }, [queryClient]);\n\n  // Queries\n  const { data: backups } = useSuspenseQuery({ ...backupKeys.lists(), refetchInterval: 30_000 });\n\n  // Mutations\n  const backupMutation = useMutation({\n    mutationFn: triggerBackup,\n    onError: (e) => {\n      showError(e.message);\n    },\n    onSuccess: () => {\n      success(\"Backup iniciado\");\n    },\n  });\n\n  // Computed\n  const currentBackup = liveJobs.backup;\n  const currentRestore = liveJobs.restore;\n  const isRunning = currentBackup?.status === \"running\" || currentRestore?.status === \"running\";\n\n  // Separate full backups from audit exports\n  const fullBackups = backups.filter((b) => !b.name.startsWith(\"audit_\"));\n  const auditExports = backups.filter((b) => b.name.startsWith(\"audit_\"));\n\n  const totalSize = backups.reduce((acc, b) => {\n    const sizeStr = b.size ?? \"0\";\n    return acc + Number.parseInt(sizeStr, 10);\n  }, 0);\n\n  const renderBackupListContent = () => {\n    if (fullBackups.length === 0) {\n      return <div className=\"text-base-content/60 py-12 text-center\">No hay backups disponibles</div>;\n    }\n\n    return (\n      <>\n        {fullBackups.map((backup) => (\n          <BackupRow\n            backup={backup}\n            key={backup.id}\n            onSuccess={() => void queryClient.invalidateQueries({ queryKey: [\"backups\"] })}\n          />\n        ))}\n      </>\n    );\n  };\n\n  return (\n    <div className={cn(PAGE_CONTAINER, \"space-y-6\")}>\n      {/* Progress Bar */}\n      {isRunning && (\n        <div className=\"bg-base-200 rounded-xl p-6 shadow-sm\">\n          <div className=\"mb-4 flex items-center justify-between\">\n            <div className=\"flex items-center gap-3\">\n              <Loader2 className=\"text-primary size-5 animate-spin\" />\n              <span className=\"font-medium\">\n                {currentBackup?.status === \"running\" ? \"Backup en progreso\" : \"Restauración en progreso\"}\n              </span>\n            </div>\n            <span className=\"text-base-content/60 font-mono text-sm\">\n              {currentBackup?.currentStep ?? currentRestore?.currentStep}\n            </span>\n          </div>\n          <div className=\"bg-base-300 h-2 overflow-hidden rounded-full\">\n            <div\n              className=\"bg-primary h-full transition-all duration-300\"\n              style={{ width: `${currentBackup?.progress ?? currentRestore?.progress ?? 0}%` }}\n            />\n          </div>\n        </div>\n      )}\n\n      {/* Google Drive Connection */}\n      <GoogleDriveConnect />\n\n      {/* Stats Cards */}\n      <div className=\"grid gap-4 md:grid-cols-4\">\n        <StatCard\n          color=\"primary\"\n          icon={<HardDrive className=\"text-primary size-5\" />}\n          label=\"Backups completos\"\n          value={String(fullBackups.length)}\n        />\n        <StatCard\n          color=\"info\"\n          icon={<FileText className=\"text-info size-5\" />}\n          label=\"Exports incrementales\"\n          value={String(auditExports.length)}\n        />\n        <StatCard\n          color=\"success\"\n          icon={<Database className=\"text-success size-5\" />}\n          label=\"Almacenamiento total\"\n          value={formatFileSize(totalSize)}\n        />\n        <StatCard\n          color=\"warning\"\n          icon={<Clock className=\"text-warning size-5\" />}\n          label=\"Último backup\"\n          value={fullBackups[0] ? dayjs(fullBackups[0].createdTime).fromNow(true) : \"-\"}\n        />\n      </div>\n\n      <div className=\"grid gap-6 lg:grid-cols-2 lg:items-start\">\n        {/* Full Backups List */}\n        <div className=\"bg-base-200/50 rounded-xl\">\n          <div className=\"border-base-content/5 flex items-center justify-between border-b p-4\">\n            <div>\n              <h2 className=\"text-lg font-semibold\">Backups Completos</h2>\n              <p className=\"text-base-content/60 text-sm\">Snapshots completos</p>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <Button\n                className=\"flex h-8 w-8 shrink-0 items-center justify-center rounded-full p-0\"\n                onClick={() => void queryClient.invalidateQueries({ queryKey: [\"backups\"] })}\n                size=\"sm\"\n                title=\"Actualizar lista\"\n                variant=\"outline\"\n              >\n                <RefreshCw className={cn(\"size-5\")} />\n              </Button>\n              <Button\n                className=\"h-8 text-xs font-medium\"\n                disabled={!canCreate || isRunning || backupMutation.isPending}\n                isLoading={backupMutation.isPending}\n                onClick={() => {\n                  backupMutation.mutate();\n                }}\n                size=\"sm\"\n                title={canCreate ? \"Crear nuevo backup\" : \"No tienes permisos para crear backups\"}\n                variant=\"primary\"\n              >\n                {!backupMutation.isPending &&\n                  (canCreate ? <Upload className=\"mr-1.5 size-4\" /> : <Lock className=\"mr-1.5 size-4\" />)}\n                Crear Backup\n              </Button>\n            </div>\n          </div>\n          <div className=\"divide-base-content/5 divide-y\">{renderBackupListContent()}</div>\n        </div>\n\n        {/* Incremental Exports */}\n        <div className=\"bg-base-200/50 rounded-xl\">\n          <div className=\"border-base-content/5 border-b p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h2 className=\"text-lg font-semibold\">Exports Incrementales</h2>\n                <p className=\"text-base-content/60 text-sm\">Cambios por hora</p>\n              </div>\n              <span className=\"bg-base-content/10 rounded-full px-2 py-1 text-xs font-medium\">\n                {auditExports.length}\n              </span>\n            </div>\n          </div>\n          {auditExports.length > 0 ? (\n            <div className=\"divide-base-content/5 max-h-125 divide-y overflow-y-auto\">\n              {auditExports.slice(0, 50).map((backup) => (\n                <div\n                  className=\"hover:bg-base-content/5 flex items-center justify-between px-4 py-3 text-sm transition-colors\"\n                  key={backup.id}\n                >\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"bg-info/10 text-info rounded-lg p-1.5\">\n                      <FileText className=\"size-4\" />\n                    </div>\n                    <div>\n                      <p className=\"font-medium\">{backup.name}</p>\n                      <p className=\"text-base-content/60 text-xs\">{dayjs(backup.createdTime).format(\"DD MMM HH:mm\")}</p>\n                    </div>\n                  </div>\n                  <div className=\"flex items-center gap-3\">\n                    <span className=\"bg-base-100/50 rounded px-1.5 py-0.5 font-mono text-xs opacity-60\">\n                      {formatFileSize(Number(backup.size))}\n                    </span>\n                    {backup.webViewLink && (\n                      <a\n                        className=\"btn btn-ghost btn-xs btn-square\"\n                        href={backup.webViewLink}\n                        rel=\"noopener noreferrer\"\n                        target=\"_blank\"\n                      >\n                        <Download className=\"size-4\" />\n                      </a>\n                    )}\n                  </div>\n                </div>\n              ))}\n            </div>\n          ) : (\n            <div className=\"text-base-content/60 py-12 text-center text-sm\">No hay exports incrementales</div>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// ==================== SUB-COMPONENTS ====================\n\nfunction BackupRow({ backup, onSuccess }: { backup: BackupFile; onSuccess: () => void }) {\n  const { can } = useAuth();\n  const { error: showError, success } = useToast();\n  const queryClient = useQueryClient();\n  const [isExpanded, setIsExpanded] = useState(false);\n  const canRestore = can(\"update\", \"Backup\");\n\n  const restoreMutation = useMutation<{ job: RestoreJob }, Error, string[] | void>({\n    mutationFn: (tables) => triggerRestore(backup.id, tables ?? undefined),\n    onError: (e) => {\n      showError(e.message);\n    },\n    onSuccess: () => {\n      success(\"Restauración iniciada\");\n      void queryClient.invalidateQueries({ queryKey: [\"backups\"] });\n      onSuccess();\n    },\n  });\n\n  return (\n    <div>\n      <button\n        className=\"hover:bg-base-content/5 focus:ring-primary/20 flex w-full cursor-pointer items-center justify-between p-4 px-4 text-left transition-colors focus:ring-2 focus:outline-none focus:ring-inset\"\n        onClick={() => {\n          setIsExpanded(!isExpanded);\n        }}\n        type=\"button\"\n      >\n        <div className=\"flex items-center gap-4\">\n          {isExpanded ? (\n            <ChevronDown className=\"text-base-content/40 size-4\" />\n          ) : (\n            <ChevronRight className=\"text-base-content/40 size-4\" />\n          )}\n          <div>\n            <div className=\"flex items-center gap-2\">\n              <CheckCircle className=\"text-success size-4\" />\n              <p className=\"font-medium\">{backup.name}</p>\n            </div>\n            <p className=\"text-base-content/60 text-sm\">\n              {dayjs(backup.createdTime).format(\"DD MMM YYYY, HH:mm\")} • {formatFileSize(Number(backup.size))}\n            </p>\n          </div>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          {backup.webViewLink && (\n            <a\n              className=\"btn btn-ghost btn-sm\"\n              href={backup.webViewLink}\n              onClick={(e) => {\n                e.stopPropagation();\n              }}\n              rel=\"noopener noreferrer\"\n              target=\"_blank\"\n            >\n              <Download className=\"size-4\" />\n            </a>\n          )}\n        </div>\n      </button>\n\n      {isExpanded && (\n        <div className=\"bg-base-300/30 px-6 py-4\">\n          <div className=\"bg-warning/10 text-warning mb-4 flex items-start gap-2 rounded-lg p-3 text-sm\">\n            <AlertTriangle className=\"mt-0.5 size-4 shrink-0\" />\n            <span>\n              La restauración sobrescribirá datos existentes. Puedes restaurar todo o seleccionar tablas específicas.\n            </span>\n          </div>\n\n          {/* Quick restore all button */}\n          <div className=\"mb-4 flex gap-3\">\n            <Button\n              disabled={!canRestore || restoreMutation.isPending}\n              isLoading={restoreMutation.isPending}\n              onClick={() => {\n                restoreMutation.mutate();\n              }}\n              title={canRestore ? undefined : \"Requiere permiso para restaurar\"}\n              variant=\"primary\"\n            >\n              {!restoreMutation.isPending &&\n                (canRestore ? <RotateCcw className=\"size-4\" /> : <Lock className=\"size-4\" />)}\n              Restaurar Todo\n            </Button>\n            <span className=\"text-base-content/60 self-center text-sm\">o selecciona tablas específicas abajo</span>\n          </div>\n\n          <div className=\"bg-base-200/50 rounded-lg p-4\">\n            <Suspense\n              fallback={\n                <div className=\"flex items-center gap-2 py-4\">\n                  <Loader2 className=\"size-4 animate-spin\" />\n                  <span className=\"text-sm\">Cargando tablas...</span>\n                </div>\n              }\n            >\n              <BackupTablesList\n                backupId={backup.id}\n                canRestore={canRestore}\n                createdTime={backup.createdTime}\n                isRestoring={restoreMutation.isPending}\n                onRestore={restoreMutation.mutate}\n              />\n            </Suspense>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\nfunction BackupTablesList({\n  backupId,\n  canRestore,\n  isRestoring,\n  onRestore,\n}: {\n  backupId: string;\n  canRestore: boolean;\n  createdTime: string;\n  isRestoring: boolean;\n  onRestore: (tables: string[]) => void;\n}) {\n  const [selectedTables, setSelectedTables] = useState<string[]>([]);\n  const { data: tables } = useSuspenseQuery(backupKeys.tables(backupId));\n\n  const toggleTable = (table: string) => {\n    setSelectedTables((prev) => (prev.includes(table) ? prev.filter((t) => t !== table) : [...prev, table]));\n  };\n\n  const selectAll = () => {\n    setSelectedTables(tables.length === selectedTables.length ? [] : [...tables]);\n  };\n\n  return (\n    <>\n      <div className=\"mb-3 flex items-center justify-between\">\n        <h4 className=\"text-sm font-medium\">Seleccionar tablas</h4>\n        <button className=\"text-primary text-xs hover:underline\" onClick={selectAll} type=\"button\">\n          {selectedTables.length === tables.length ? \"Ninguna\" : \"Todas\"}\n        </button>\n      </div>\n\n      <div className=\"mb-3\">\n        {tables.length === 0 && <p className=\"text-base-content/60 text-sm\">No hay tablas en este backup.</p>}\n\n        <div className=\"grid grid-cols-2 gap-2 sm:grid-cols-3 md:grid-cols-4\">\n          {tables.map((table) => (\n            <label\n              className={cn(\n                \"border-base-content/10 hover:bg-base-content/5 flex cursor-pointer items-center gap-2 rounded-lg border p-2 text-sm transition-colors\",\n                selectedTables.includes(table) ? \"border-primary bg-primary/5\" : \"\"\n              )}\n              key={table}\n            >\n              <input\n                checked={selectedTables.includes(table)}\n                className=\"checkbox checkbox-primary checkbox-sm\"\n                onChange={() => {\n                  toggleTable(table);\n                }}\n                type=\"checkbox\"\n              />\n              <span className=\"flex-1 truncate\">{table}</span>\n            </label>\n          ))}\n        </div>\n      </div>\n\n      {selectedTables.length > 0 && (\n        <Button\n          disabled={!canRestore || isRestoring}\n          isLoading={isRestoring}\n          onClick={() => {\n            onRestore(selectedTables);\n          }}\n          size=\"sm\"\n          title={canRestore ? undefined : \"Requiere permiso para restaurar\"}\n          variant=\"outline\"\n        >\n          {!isRestoring && (canRestore ? <Play className=\"size-4\" /> : <Lock className=\"size-4\" />)}\n          Restaurar {selectedTables.length} tabla{selectedTables.length > 1 ? \"s\" : \"\"}\n        </Button>\n      )}\n    </>\n  );\n}\n\nfunction StatCard({\n  color,\n  icon,\n  label,\n  value,\n}: {\n  color: \"info\" | \"primary\" | \"success\" | \"warning\";\n  icon: React.ReactNode;\n  label: string;\n  value: string;\n}) {\n  const bgColors = {\n    info: \"bg-info/10\",\n    primary: \"bg-primary/10\",\n    success: \"bg-success/10\",\n    warning: \"bg-warning/10\",\n  };\n\n  return (\n    <div className=\"bg-base-200/50 rounded-xl p-4\">\n      <div className=\"flex items-center gap-3\">\n        <div className={cn(\"rounded-lg p-2\", bgColors[color])}>{icon}</div>\n        <div>\n          <p className=\"text-base-content/60 text-sm\">{label}</p>\n          <p className=\"text-2xl font-bold\">{value}</p>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/pages/settings/CSVUploadPage.tsx","messages":[{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":331,"column":26,"nodeType":"MemberExpression","endLine":331,"endColumn":40},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":332,"column":11,"nodeType":"MemberExpression","endLine":332,"endColumn":31},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":332,"column":34,"nodeType":"MemberExpression","endLine":332,"endColumn":48},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":415,"column":31,"nodeType":"MemberExpression","endLine":415,"endColumn":57}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMutation } from \"@tanstack/react-query\";\nimport type { ColumnDef } from \"@tanstack/react-table\";\nimport { AlertCircle, ArrowRight, CheckCircle, FileUp, Loader2, Lock, Upload } from \"lucide-react\";\nimport Papa from \"papaparse\";\nimport { useState } from \"react\";\n\nimport { DataTable } from \"@/components/data-table/DataTable\";\nimport Alert from \"@/components/ui/Alert\";\nimport Button from \"@/components/ui/Button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/Card\";\nimport FileInput from \"@/components/ui/FileInput\";\nimport Input from \"@/components/ui/Input\";\nimport { useAuth } from \"@/context/AuthContext\";\nimport { type CsvImportPayload, importCsvData, previewCsvImport } from \"@/features/data-import/api\";\nimport { PAGE_CONTAINER } from \"@/lib/styles\";\nimport { cn } from \"@/lib/utils\";\n\ninterface TableOption {\n  fields: { name: string; required: boolean; type: string }[];\n  label: string;\n  value: string;\n}\n\nconst TABLE_OPTIONS: TableOption[] = [\n  {\n    fields: [\n      { name: \"rut\", required: true, type: \"string\" },\n      { name: \"names\", required: true, type: \"string\" },\n      { name: \"fatherName\", required: false, type: \"string\" },\n      { name: \"motherName\", required: false, type: \"string\" },\n      { name: \"email\", required: false, type: \"string\" },\n      { name: \"phone\", required: false, type: \"string\" },\n      { name: \"address\", required: false, type: \"string\" },\n      { name: \"personType\", required: false, type: \"enum\" },\n    ],\n    label: \"Personas\",\n    value: \"people\",\n  },\n  {\n    fields: [\n      { name: \"rut\", required: true, type: \"string\" },\n      { name: \"position\", required: true, type: \"string\" },\n      { name: \"department\", required: false, type: \"string\" },\n      { name: \"startDate\", required: true, type: \"date\" },\n      { name: \"endDate\", required: false, type: \"date\" },\n      { name: \"status\", required: false, type: \"enum\" },\n      { name: \"salaryType\", required: false, type: \"enum\" },\n      { name: \"baseSalary\", required: false, type: \"number\" },\n      { name: \"hourlyRate\", required: false, type: \"number\" },\n      { name: \"overtimeRate\", required: false, type: \"number\" },\n      { name: \"retentionRate\", required: false, type: \"number\" },\n      { name: \"bankName\", required: false, type: \"string\" },\n      { name: \"bankAccountType\", required: false, type: \"string\" },\n      { name: \"bankAccountNumber\", required: false, type: \"string\" },\n    ],\n    label: \"Trabajadores\",\n    value: \"employees\",\n  },\n  {\n    fields: [\n      { name: \"rut\", required: true, type: \"string\" },\n      { name: \"category\", required: false, type: \"enum\" },\n      { name: \"notes\", required: false, type: \"string\" },\n    ],\n    label: \"Contrapartes\",\n    value: \"counterparts\",\n  },\n  {\n    fields: [\n      { name: \"timestamp\", required: true, type: \"datetime\" },\n      { name: \"description\", required: false, type: \"string\" },\n      { name: \"amount\", required: true, type: \"number\" },\n      { name: \"direction\", required: true, type: \"enum\" },\n      { name: \"rut\", required: false, type: \"string\" },\n      { name: \"origin\", required: false, type: \"string\" },\n      { name: \"destination\", required: false, type: \"string\" },\n      { name: \"category\", required: false, type: \"string\" },\n    ],\n    label: \"Transacciones\",\n    value: \"transactions\",\n  },\n  {\n    fields: [\n      { name: \"date\", required: true, type: \"date\" },\n      { name: \"amount\", required: true, type: \"number\" },\n      { name: \"note\", required: false, type: \"string\" },\n    ],\n    label: \"Saldos diarios\",\n    value: \"daily_balances\",\n  },\n  {\n    fields: [\n      { name: \"balanceDate\", required: true, type: \"date\" },\n      { name: \"ingresoTarjetas\", required: false, type: \"number\" },\n      { name: \"ingresoTransferencias\", required: false, type: \"number\" },\n      { name: \"ingresoEfectivo\", required: false, type: \"number\" },\n      { name: \"gastosDiarios\", required: false, type: \"number\" },\n      { name: \"otrosAbonos\", required: false, type: \"number\" },\n      { name: \"consultasMonto\", required: false, type: \"number\" },\n      { name: \"controlesMonto\", required: false, type: \"number\" },\n      { name: \"testsMonto\", required: false, type: \"number\" },\n      { name: \"vacunasMonto\", required: false, type: \"number\" },\n      { name: \"licenciasMonto\", required: false, type: \"number\" },\n      { name: \"roxairMonto\", required: false, type: \"number\" },\n      { name: \"comentarios\", required: false, type: \"string\" },\n      { name: \"status\", required: false, type: \"enum\" },\n      { name: \"changeReason\", required: false, type: \"string\" },\n    ],\n    label: \"Balances de producción diaria\",\n    value: \"daily_production_balances\",\n  },\n  {\n    fields: [\n      { name: \"name\", required: true, type: \"string\" },\n      { name: \"rut\", required: false, type: \"string\" },\n      { name: \"type\", required: false, type: \"enum\" },\n      { name: \"frequency\", required: false, type: \"enum\" },\n      { name: \"defaultAmount\", required: false, type: \"number\" },\n      { name: \"status\", required: false, type: \"enum\" },\n    ],\n    label: \"Servicios\",\n    value: \"services\",\n  },\n  {\n    fields: [\n      { name: \"categoryId\", required: false, type: \"number\" },\n      { name: \"name\", required: true, type: \"string\" },\n      { name: \"description\", required: false, type: \"string\" },\n      { name: \"currentStock\", required: false, type: \"number\" },\n    ],\n    label: \"Ítems de inventario\",\n    value: \"inventory_items\",\n  },\n  {\n    fields: [\n      { name: \"rut\", required: true, type: \"string\" },\n      { name: \"workDate\", required: true, type: \"date\" },\n      { name: \"startTime\", required: false, type: \"time\" },\n      { name: \"endTime\", required: false, type: \"time\" },\n      { name: \"workedMinutes\", required: true, type: \"number\" },\n      { name: \"overtimeMinutes\", required: false, type: \"number\" },\n      { name: \"comment\", required: false, type: \"string\" },\n    ],\n    label: \"Horas trabajadas\",\n    value: \"employee_timesheets\",\n  },\n];\n\n// Backend now supports all these tables\nconst SUPPORTED_TABLES = new Set([\n  \"counterparts\",\n  \"daily_balances\",\n  \"daily_production_balances\",\n  \"employee_timesheets\",\n  \"employees\",\n  \"inventory_items\",\n  \"people\",\n  \"services\",\n  \"transactions\",\n]);\n\n// Permission mapping\nconst PERMISSION_MAP: Record<string, { action: string; subject: string }> = {\n  counterparts: { action: \"create\", subject: \"Counterpart\" },\n  daily_balances: { action: \"create\", subject: \"DailyBalance\" },\n  daily_production_balances: { action: \"create\", subject: \"ProductionBalance\" },\n  employee_timesheets: { action: \"create\", subject: \"Timesheet\" },\n  employees: { action: \"create\", subject: \"Employee\" },\n  inventory_items: { action: \"create\", subject: \"InventoryItem\" },\n  people: { action: \"create\", subject: \"Person\" },\n  services: { action: \"create\", subject: \"Service\" },\n  transactions: { action: \"create\", subject: \"Transaction\" },\n};\n\ninterface FieldDefinition {\n  name: string;\n  required: boolean;\n  type: string;\n}\n\nexport default function CSVUploadPage() {\n  const { can } = useAuth();\n  const [selectedTable, setSelectedTable] = useState<string>(\"\");\n  const [csvData, setCsvData] = useState<Record<string, string>[]>([]);\n  const [csvHeaders, setCsvHeaders] = useState<string[]>([]);\n  const [columnMapping, setColumnMapping] = useState<Record<string, string>>({});\n\n  // Parsed status\n  const [parseStatus, setParseStatus] = useState<\"error\" | \"idle\" | \"parsing\">(\"idle\");\n  const [errorMessage, setErrorMessage] = useState<string>(\"\");\n\n  const [previewData, setPreviewData] = useState<null | {\n    errors?: string[];\n    inserted?: number;\n    skipped?: number;\n    toInsert?: number;\n    toSkip?: number;\n    toUpdate?: number;\n    updated?: number;\n  }>(null);\n\n  const [showSuccessMessage, setShowSuccessMessage] = useState(false);\n\n  const allowedTableOptions = TABLE_OPTIONS.filter((t) => {\n    // 1. Must be supported by backend\n    if (!SUPPORTED_TABLES.has(t.value)) return false;\n    // 2. Must have permission\n    const perm = PERMISSION_MAP[t.value];\n    if (!perm) return false;\n    return can(perm.action, perm.subject);\n  });\n\n  const currentTable = allowedTableOptions.find((t) => t.value === selectedTable);\n\n  // Mutations\n  const {\n    isError: isPreviewError,\n    isPending: isPreviewPending,\n    mutate: previewMutate,\n  } = useMutation({\n    mutationFn: (payload: CsvImportPayload) => previewCsvImport(payload),\n    onError: (err) => {\n      setErrorMessage(err instanceof Error ? err.message : \"Error al previsualizar datos\");\n    },\n    onSuccess: (data) => {\n      setPreviewData(data);\n    },\n  });\n\n  const {\n    isError: isImportError,\n    isPending: isImportPending,\n    mutate: importMutate,\n  } = useMutation({\n    mutationFn: (payload: CsvImportPayload) => importCsvData(payload),\n    onError: (err) => {\n      setErrorMessage(err instanceof Error ? err.message : \"Error al importar datos\");\n    },\n    onSuccess: (data) => {\n      setPreviewData(data);\n      setShowSuccessMessage(true);\n\n      // Reset after delay\n      setTimeout(() => {\n        setShowSuccessMessage(false);\n        setCsvData([]);\n        setCsvHeaders([]);\n        setColumnMapping({});\n        setPreviewData(null);\n        setParseStatus(\"idle\");\n      }, 3000);\n    },\n  });\n\n  const resetState = () => {\n    setCsvData([]);\n    setCsvHeaders([]);\n    setColumnMapping({});\n    setPreviewData(null);\n    setParseStatus(\"idle\");\n    setErrorMessage(\"\");\n    setShowSuccessMessage(false);\n  };\n\n  const handleTableChange = (e: React.ChangeEvent<HTMLSelectElement>) => {\n    setSelectedTable(e.target.value);\n    resetState();\n  };\n\n  const handleParseComplete = (results: Papa.ParseResult<Record<string, string>>) => {\n    if (results.errors.length > 0) {\n      setParseStatus(\"error\");\n      setErrorMessage(`Error al parsear CSV: ${results.errors[0]?.message ?? \"Error desconocido\"}`);\n      return;\n    }\n\n    const headers = results.meta.fields ?? [];\n    setCsvHeaders(headers);\n    setCsvData(results.data);\n\n    // Auto-mapping heuristics\n    if (currentTable) {\n      const autoMapping: Record<string, string> = {};\n      for (const field of currentTable.fields) {\n        const matchingHeader = headers.find(\n          (h) =>\n            h.toLowerCase() === field.name.toLowerCase() ||\n            h.toLowerCase().replaceAll(\"_\", \"\") === field.name.toLowerCase()\n        );\n        if (matchingHeader) {\n          autoMapping[field.name] = matchingHeader;\n        }\n      }\n      setColumnMapping(autoMapping);\n    }\n\n    setParseStatus(\"idle\");\n  };\n\n  const handleFileChange = (e: File | React.ChangeEvent<HTMLInputElement>) => {\n    const file = e instanceof File ? e : e.target.files?.[0];\n    if (!file) return;\n\n    setParseStatus(\"parsing\");\n    setErrorMessage(\"\");\n    setShowSuccessMessage(false);\n    setPreviewData(null);\n\n    Papa.parse(file, {\n      complete: handleParseComplete,\n      error: (error) => {\n        setParseStatus(\"error\");\n        setErrorMessage(`Error al leer archivo: ${error.message}`);\n      },\n      header: true,\n      skipEmptyLines: true,\n    });\n  };\n\n  const handleColumnMapChange = (dbField: string, csvColumn: string) => {\n    setColumnMapping((prev) => ({\n      ...prev,\n      [dbField]: csvColumn,\n    }));\n  };\n\n  const getTransformedData = () => {\n    return csvData.map((row) => {\n      const transformed: Record<string, number | string> = {};\n      for (const [dbField, csvColumn] of Object.entries(columnMapping)) {\n        if (csvColumn && row[csvColumn] !== undefined) {\n          transformed[dbField] = row[csvColumn];\n        }\n      }\n      return transformed;\n    });\n  };\n\n  const handlePreview = () => {\n    if (!selectedTable || csvData.length === 0) return;\n    setErrorMessage(\"\");\n    previewMutate({\n      data: getTransformedData(),\n      table: selectedTable,\n    });\n  };\n\n  const handleImport = () => {\n    if (!selectedTable || csvData.length === 0) return;\n    setErrorMessage(\"\");\n    importMutate({\n      data: getTransformedData(),\n      table: selectedTable,\n    });\n  };\n\n  const isValidMapping = (() => {\n    if (!currentTable) return false;\n    const requiredFields = currentTable.fields.filter((f) => f.required);\n    return requiredFields.every((field) => columnMapping[field.name] && columnMapping[field.name] !== \"\");\n  })();\n\n  const columns: ColumnDef<FieldDefinition>[] = [\n    {\n      accessorKey: \"name\",\n      cell: ({ row }) => (\n        <div className=\"flex items-center gap-1.5 font-medium\">\n          {row.original.name}\n          {row.original.required && (\n            <span className=\"text-error text-xs\" title=\"Requerido\">\n              *\n            </span>\n          )}\n        </div>\n      ),\n      header: \"Campo BD\",\n    },\n    {\n      accessorKey: \"type\",\n      cell: ({ row }) => <span className=\"badge badge-xs badge-ghost font-mono\">{row.original.type}</span>,\n      header: \"Tipo\",\n    },\n    {\n      cell: ({ row }) => (\n        <Input\n          as=\"select\"\n          className={cn(\n            \"w-full max-w-xs transition-colors\",\n            row.original.required && !columnMapping[row.original.name]\n              ? \"border-error focus:border-error text-error\"\n              : \"\"\n          )}\n          onChange={(e) => {\n            handleColumnMapChange(row.original.name, e.target.value);\n          }}\n          size=\"sm\"\n          value={columnMapping[row.original.name] ?? \"\"}\n        >\n          <option value=\"\">-- Ignorar / Sin mapear --</option>\n          {csvHeaders.map((header) => (\n            <option key={`${row.original.name}-${header}`} value={header}>\n              {header}\n            </option>\n          ))}\n        </Input>\n      ),\n      header: \"Columna CSV\",\n      id: \"mapping\",\n    },\n    {\n      cell: ({ row }) => {\n        const mappedColumn = columnMapping[row.original.name];\n        return (\n          <span className=\"text-base-content/60 max-w-37.5 truncate font-mono text-xs\">\n            {(mappedColumn && csvData[0]?.[mappedColumn]) ?? \"-\"}\n          </span>\n        );\n      },\n      header: \"Ejemplo (Fila 1)\",\n      id: \"preview\",\n    },\n  ];\n\n  return (\n    <div className={PAGE_CONTAINER}>\n      {/* Access Denied State */}\n      {allowedTableOptions.length === 0 ? (\n        <Alert variant=\"warning\">\n          <Lock className=\"h-4 w-4\" />\n          <div className=\"flex flex-col\">\n            <span className=\"font-bold\">Acceso restringido</span>\n            <span>No tienes permisos para importar datos en ninguna tabla disponible.</span>\n          </div>\n        </Alert>\n      ) : (\n        <>\n          {/* Selector de tabla */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <FileUp className=\"text-primary h-5 w-5\" />\n                1. Seleccionar destino\n              </CardTitle>\n              <CardDescription>Elige la tabla donde deseas importar los datos.</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"flex flex-col gap-4 sm:flex-row sm:items-start\">\n                <div className=\"w-full sm:w-1/3\">\n                  <Input as=\"select\" className=\"w-full\" onChange={handleTableChange} value={selectedTable}>\n                    <option value=\"\">-- Seleccionar tabla --</option>\n                    {allowedTableOptions.map((table) => (\n                      <option key={table.value} value={table.value}>\n                        {table.label}\n                      </option>\n                    ))}\n                  </Input>\n                </div>\n\n                {currentTable && (\n                  <div className=\"bg-base-200/50 flex-1 rounded-lg p-4\">\n                    <h3 className=\"mb-2 text-xs font-bold tracking-wide uppercase opacity-70\">Campos requeridos</h3>\n                    <div className=\"flex flex-wrap gap-2\">\n                      {currentTable.fields.map((field) => (\n                        <span\n                          className={cn(\"badge badge-sm\", field.required ? \"badge-primary\" : \"badge-ghost opacity-60\")}\n                          key={field.name}\n                        >\n                          {field.name}\n                          {field.required && \"*\"}\n                        </span>\n                      ))}\n                    </div>\n                  </div>\n                )}\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Subida de archivo */}\n          {selectedTable && (\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-base\">2. Cargar archivo</CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <FileInput\n                  accept=\".csv\"\n                  disabled={parseStatus === \"parsing\" || isPreviewPending || isImportPending}\n                  label=\"Arrastra un archivo CSV aquí o haz clic para seleccionar\"\n                  onChange={handleFileChange}\n                />\n\n                {parseStatus === \"parsing\" && (\n                  <Alert>\n                    <Loader2 className=\"h-4 w-4 animate-spin\" />\n                    <span>Procesando archivo...</span>\n                  </Alert>\n                )}\n\n                {parseStatus === \"error\" && (\n                  <Alert variant=\"error\">\n                    <AlertCircle className=\"h-4 w-4\" />\n                    <span>{errorMessage}</span>\n                  </Alert>\n                )}\n\n                {(isPreviewError || isImportError) && errorMessage && (\n                  <Alert variant=\"error\">\n                    <AlertCircle className=\"h-4 w-4\" />\n                    <span>{errorMessage}</span>\n                  </Alert>\n                )}\n\n                {showSuccessMessage && (\n                  <Alert variant=\"success\">\n                    <CheckCircle className=\"h-4 w-4\" />\n                    <div className=\"flex flex-col gap-1\">\n                      <span className=\"font-medium\">Importación completada</span>\n                      {previewData && (\n                        <span className=\"text-xs opacity-90\">\n                          {previewData.inserted ?? 0} insertados · {previewData.updated ?? 0} actualizados ·{\" \"}\n                          {previewData.skipped ?? 0} omitidos\n                        </span>\n                      )}\n                    </div>\n                  </Alert>\n                )}\n              </CardContent>\n            </Card>\n          )}\n\n          {/* Mapeo de columnas */}\n          {csvHeaders.length > 0 && currentTable && (\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-base\">3. Mapeo de columnas</CardTitle>\n                <CardDescription>\n                  Relaciona las columnas de tu CSV con los campos de la base de datos.\n                  <br />\n                  <span className=\"text-xs opacity-70\">Detectadas {csvData.length} filas.</span>\n                </CardDescription>\n              </CardHeader>\n              <div className=\"border-t\">\n                <DataTable columns={columns} data={currentTable.fields} />\n              </div>\n            </Card>\n          )}\n\n          {/* Vista previa */}\n          {previewData && !showSuccessMessage && (\n            <Card className=\"border-primary/20 bg-primary/5\">\n              <CardContent className=\"p-6\">\n                <h3 className=\"mb-4 text-lg font-semibold\">Resumen de Importación</h3>\n                <div className=\"mb-6 grid grid-cols-2 gap-4 md:grid-cols-4\">\n                  <div className=\"bg-base-100 border-base-200 rounded-lg border p-3 shadow-sm\">\n                    <div className=\"mb-1 text-xs tracking-wider uppercase opacity-70\">Insertar</div>\n                    <div className=\"text-success text-2xl font-bold\">{previewData.toInsert ?? 0}</div>\n                  </div>\n                  <div className=\"bg-base-100 border-base-200 rounded-lg border p-3 shadow-sm\">\n                    <div className=\"mb-1 text-xs tracking-wider uppercase opacity-70\">Actualizar</div>\n                    <div className=\"text-info text-2xl font-bold\">{previewData.toUpdate ?? 0}</div>\n                  </div>\n                  <div className=\"bg-base-100 border-base-200 rounded-lg border p-3 shadow-sm\">\n                    <div className=\"mb-1 text-xs tracking-wider uppercase opacity-70\">Omitir</div>\n                    <div className=\"text-warning text-2xl font-bold\">{previewData.toSkip ?? 0}</div>\n                  </div>\n                </div>\n\n                {previewData.errors && previewData.errors.length > 0 && (\n                  <Alert className=\"mb-0\" variant=\"warning\">\n                    <div className=\"flex w-full flex-col gap-2\">\n                      <div className=\"flex items-center gap-2 font-medium\">\n                        <AlertCircle className=\"h-4 w-4\" />\n                        Errores de validación ({previewData.errors.length})\n                      </div>\n                      <ul className=\"bg-base-100/50 max-h-32 list-inside list-disc overflow-y-auto rounded p-2 text-xs opacity-90\">\n                        {previewData.errors.map((err, i) => (\n                          <li key={i}>{err}</li>\n                        ))}\n                      </ul>\n                    </div>\n                  </Alert>\n                )}\n              </CardContent>\n            </Card>\n          )}\n\n          {/* Acciones */}\n          {csvData.length > 0 && (\n            <div className=\"bg-base-100/80 border-base-200 sticky bottom-0 z-10 -mx-4 flex justify-end gap-3 border-t p-4 shadow-lg backdrop-blur-md sm:mx-0 sm:rounded-xl sm:border\">\n              <Button\n                disabled={!isValidMapping || isPreviewPending || isImportPending}\n                onClick={handlePreview}\n                variant=\"outline\"\n              >\n                {isPreviewPending ? (\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                ) : (\n                  <Upload className=\"mr-2 h-4 w-4\" />\n                )}\n                Visualizar cambios\n              </Button>\n\n              <Button\n                disabled={!isValidMapping || isPreviewPending || isImportPending}\n                onClick={handleImport}\n                variant=\"primary\"\n              >\n                {isImportPending ? (\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                ) : (\n                  <ArrowRight className=\"mr-2 h-4 w-4\" />\n                )}\n                Confirmar Importación\n              </Button>\n            </div>\n          )}\n        </>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/pages/settings/CalendarSettingsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/pages/settings/InventorySettingsPage.tsx","messages":[{"ruleId":"unicorn/no-array-reduce","severity":2,"message":"`Array#reduce()` is not allowed. Prefer other types of loop for readability.","line":46,"column":33,"nodeType":"Identifier","messageId":"reduce","endLine":46,"endColumn":39},{"ruleId":"@typescript-eslint/prefer-nullish-coalescing","severity":2,"message":"Prefer using nullish coalescing operator (`??=`) instead of an assignment expression, as it is simpler to read.","line":48,"column":5,"nodeType":"IfStatement","messageId":"preferNullishOverAssignment","endLine":48,"endColumn":38,"suggestions":[{"messageId":"suggestNullish","data":{"equals":"="},"fix":{"range":[1899,1932],"text":"acc[catId] ??= [];"},"desc":"Fix to nullish coalescing operator (`??=`)."}]},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":48,"column":10,"nodeType":"MemberExpression","endLine":48,"endColumn":20},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":48,"column":22,"nodeType":"MemberExpression","endLine":48,"endColumn":32},{"ruleId":"security/detect-object-injection","severity":1,"message":"Generic Object Injection Sink","line":49,"column":5,"nodeType":"MemberExpression","endLine":49,"endColumn":15},{"ruleId":"sonarjs/prefer-read-only-props","severity":2,"message":"Mark the props of the component as read-only.","line":172,"column":24,"nodeType":"ObjectPattern","messageId":"readOnlyProps","endLine":180,"endColumn":22,"suggestions":[{"messageId":"readOnlyPropsFix","fix":{"range":[6077,6095],"text":"Readonly<InventoryListProps>"},"desc":"Mark the props as read-only"}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMutation, useQueryClient, useSuspenseQuery } from \"@tanstack/react-query\";\nimport { Box, ChevronDown, ChevronRight, Edit2, Loader2, Package, Plus, Trash2 } from \"lucide-react\";\nimport { useState } from \"react\";\n\nimport type { InventoryItem } from \"@/features/inventory/types\";\n\nimport Button from \"@/components/ui/Button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/Card\";\nimport Input from \"@/components/ui/Input\";\nimport { useToast } from \"@/context/ToastContext\";\nimport { createInventoryCategory, deleteInventoryCategory } from \"@/features/inventory/api\";\nimport { inventoryKeys } from \"@/features/inventory/queries\";\n\nconst getStockStatusColor = (stock: number) => {\n  if (stock <= 0) return \"text-error\";\n  if (stock < 10) return \"text-warning\";\n  return \"text-success\";\n};\n\ninterface InventoryListProps {\n  categories: { id: number; name: string }[];\n  expandedCategories: Set<number>;\n  isLoading: boolean;\n  itemsByCategory: Record<number, InventoryItem[]>;\n  onDeleteCategory: (id: number) => void;\n  toggleCategory: (id: number) => void;\n  uncategorizedItems: InventoryItem[];\n}\n\nexport default function InventorySettingsPage() {\n  const [isCreating, setIsCreating] = useState(false);\n  const [newCategoryName, setNewCategoryName] = useState(\"\");\n  const [expandedCategories, setExpandedCategories] = useState<Set<number>>(new Set());\n  const { error: toastError, success } = useToast();\n  const queryClient = useQueryClient();\n\n  // Fetch Categories\n  const { data: categories } = useSuspenseQuery(inventoryKeys.categories());\n\n  // Fetch Items\n  const { data: items } = useSuspenseQuery(inventoryKeys.items());\n\n  const isLoading = false;\n\n  // Group items by category\n  const itemsByCategory = items.reduce<Record<number, InventoryItem[]>>((acc, item) => {\n    const catId = item.category_id ?? 0; // 0 for uncategorized\n    if (!acc[catId]) acc[catId] = [];\n    acc[catId].push(item);\n    return acc;\n  }, {});\n\n  // Create Category Mutation\n  const createMutation = useMutation({\n    mutationFn: (name: string) => createInventoryCategory(name),\n    onError: () => {\n      toastError(\"Error al crear categoría\");\n    },\n    onSuccess: () => {\n      void queryClient.invalidateQueries({ queryKey: [\"inventory-categories\"] });\n      success(\"Categoría creada\");\n      setNewCategoryName(\"\");\n      setIsCreating(false);\n    },\n  });\n\n  // Delete Category Mutation\n  const deleteMutation = useMutation({\n    mutationFn: (id: number) => deleteInventoryCategory(id),\n    onError: (err) => {\n      toastError(err instanceof Error ? err.message : \"Error al eliminar categoría\");\n    },\n    onSuccess: () => {\n      void queryClient.invalidateQueries({ queryKey: [\"inventory-categories\"] });\n      success(\"Categoría eliminada\");\n    },\n  });\n\n  const handleCreate = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!newCategoryName.trim()) return;\n    createMutation.mutate(newCategoryName);\n  };\n\n  const toggleCategory = (categoryId: number) => {\n    setExpandedCategories((prev) => {\n      const next = new Set(prev);\n      if (next.has(categoryId)) {\n        next.delete(categoryId);\n      } else {\n        next.add(categoryId);\n      }\n      return next;\n    });\n  };\n\n  const uncategorizedItems = itemsByCategory[0] ?? [];\n\n  return (\n    <div className=\"space-y-6\">\n      <Card>\n        <CardHeader className=\"flex flex-row items-center justify-between pb-4\">\n          <div className=\"space-y-1\">\n            <CardTitle>Parámetros de inventario</CardTitle>\n            <CardDescription>Gestiona las categorías y productos del inventario.</CardDescription>\n          </div>\n          <Button\n            className=\"gap-2\"\n            onClick={() => {\n              setIsCreating(true);\n            }}\n          >\n            <Plus size={16} />\n            Nueva Categoría\n          </Button>\n        </CardHeader>\n        <CardContent className=\"p-0\">\n          {isCreating && (\n            <div className=\"bg-base-200/30 animate-in fade-in slide-in-from-top-2 border-b p-4\">\n              <form className=\"flex items-end gap-3\" onSubmit={handleCreate}>\n                <div className=\"flex-1\">\n                  <label className=\"label py-1\" htmlFor=\"category-name\">\n                    <span className=\"label-text text-xs\">Nombre de la categoría</span>\n                  </label>\n                  <Input\n                    id=\"category-name\"\n                    onChange={(e) => {\n                      setNewCategoryName(e.target.value);\n                    }}\n                    placeholder=\"Ej: Antibióticos\"\n                    value={newCategoryName}\n                  />\n                </div>\n                <div className=\"flex gap-2\">\n                  <Button\n                    disabled={createMutation.isPending}\n                    onClick={() => {\n                      setIsCreating(false);\n                    }}\n                    type=\"button\"\n                    variant=\"ghost\"\n                  >\n                    Cancelar\n                  </Button>\n                  <Button disabled={createMutation.isPending || !newCategoryName.trim()} type=\"submit\">\n                    {createMutation.isPending ? <Loader2 className=\"animate-spin\" /> : \"Guardar\"}\n                  </Button>\n                </div>\n              </form>\n            </div>\n          )}\n\n          <InventoryList\n            categories={categories}\n            expandedCategories={expandedCategories}\n            isLoading={isLoading}\n            itemsByCategory={itemsByCategory}\n            onDeleteCategory={(id) => {\n              if (confirm(\"¿Estás seguro de eliminar esta categoría?\")) {\n                deleteMutation.mutate(id);\n              }\n            }}\n            toggleCategory={toggleCategory}\n            uncategorizedItems={uncategorizedItems}\n          />\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nfunction InventoryList({\n  categories,\n  expandedCategories,\n  isLoading,\n  itemsByCategory,\n  onDeleteCategory,\n  toggleCategory,\n  uncategorizedItems,\n}: InventoryListProps) {\n  if (isLoading) {\n    return (\n      <div className=\"text-base-content/50 py-12 text-center\">\n        <Loader2 className=\"mx-auto animate-spin\" />\n      </div>\n    );\n  }\n\n  if (categories.length === 0 && uncategorizedItems.length === 0) {\n    return <div className=\"text-base-content/50 py-12 text-center\">No hay categorías ni items registrados.</div>;\n  }\n\n  return (\n    <div className=\"divide-base-200 divide-y border-t\">\n      {categories.map((category) => {\n        const catItems = itemsByCategory[category.id] ?? [];\n        const isExpanded = expandedCategories.has(category.id);\n\n        return (\n          <div key={category.id}>\n            {/* Category Row */}\n            <div className=\"hover:bg-base-200/50 group flex items-center gap-3 p-4 transition-colors\">\n              <button\n                className=\"flex flex-1 items-center gap-3 text-left focus:outline-none\"\n                onClick={() => {\n                  toggleCategory(category.id);\n                }}\n                type=\"button\"\n              >\n                <span\n                  aria-label={isExpanded ? \"Colapsar\" : \"Expandir\"}\n                  className=\"text-base-content/50 flex h-6 w-6 items-center justify-center transition-transform\"\n                >\n                  {isExpanded ? <ChevronDown size={18} /> : <ChevronRight size={18} />}\n                </span>\n                <div className=\"bg-primary/10 text-primary flex h-8 w-8 items-center justify-center rounded-lg\">\n                  <Package size={16} />\n                </div>\n                <div className=\"min-w-0 flex-1\">\n                  <span className=\"font-medium\">{category.name}</span>\n                </div>\n                <span className=\"badge badge-ghost badge-sm\">{catItems.length} items</span>\n              </button>\n              <div className=\"flex gap-1 opacity-0 transition-opacity group-hover:opacity-100\">\n                <Button className=\"btn-square btn-xs\" size=\"sm\" variant=\"ghost\">\n                  <Edit2 size={14} />\n                </Button>\n                <Button\n                  className=\"btn-square btn-xs text-error hover:bg-error/10\"\n                  onClick={() => {\n                    onDeleteCategory(category.id);\n                  }}\n                  size=\"sm\"\n                  variant=\"ghost\"\n                >\n                  <Trash2 size={14} />\n                </Button>\n              </div>\n            </div>\n\n            {/* Items List (Expanded) */}\n            {isExpanded && catItems.length > 0 && (\n              <div className=\"bg-base-200/30 border-base-200 border-t\">\n                {catItems.map((item) => (\n                  <div\n                    className=\"hover:bg-base-200/50 border-base-200/50 flex items-center gap-3 border-b py-3 pr-4 pl-14 last:border-b-0\"\n                    key={item.id}\n                  >\n                    <div className=\"bg-base-300/50 text-base-content/40 flex h-6 w-6 items-center justify-center rounded\">\n                      <Box size={12} />\n                    </div>\n                    <div className=\"min-w-0 flex-1\">\n                      <p className=\"truncate text-sm font-medium\">{item.name}</p>\n                      {item.description && <p className=\"text-base-content/50 truncate text-xs\">{item.description}</p>}\n                    </div>\n                    <span className={`text-xs font-medium ${getStockStatusColor(item.current_stock)}`}>\n                      Stock: {item.current_stock}\n                    </span>\n                  </div>\n                ))}\n              </div>\n            )}\n\n            {isExpanded && catItems.length === 0 && (\n              <div className=\"bg-base-200/30 border-base-200 text-base-content/50 border-t py-4 pl-14 text-sm italic\">\n                Sin items en esta categoría\n              </div>\n            )}\n          </div>\n        );\n      })}\n\n      {/* Uncategorized Items */}\n      {uncategorizedItems.length > 0 && (\n        <div>\n          <div className=\"hover:bg-base-200/50 group flex items-center gap-3 p-4 transition-colors\">\n            <button\n              className=\"flex flex-1 items-center gap-3 text-left focus:outline-none\"\n              onClick={() => {\n                toggleCategory(0);\n              }}\n              type=\"button\"\n            >\n              <span\n                aria-label={expandedCategories.has(0) ? \"Colapsar\" : \"Expandir\"}\n                className=\"text-base-content/50 flex h-6 w-6 items-center justify-center\"\n              >\n                {expandedCategories.has(0) ? <ChevronDown size={18} /> : <ChevronRight size={18} />}\n              </span>\n              <div className=\"bg-base-300 text-base-content/50 flex h-8 w-8 items-center justify-center rounded-lg\">\n                <Package size={16} />\n              </div>\n              <div className=\"min-w-0 flex-1\">\n                <span className=\"text-base-content/70 font-medium\">Sin categoría</span>\n              </div>\n              <span className=\"badge badge-ghost badge-sm\">{uncategorizedItems.length} items</span>\n            </button>\n          </div>\n\n          {expandedCategories.has(0) && (\n            <div className=\"bg-base-200/30 border-base-200 border-t\">\n              {uncategorizedItems.map((item) => (\n                <div\n                  className=\"hover:bg-base-200/50 border-base-200/50 flex items-center gap-3 border-b py-3 pr-4 pl-14 last:border-b-0\"\n                  key={item.id}\n                >\n                  <div className=\"bg-base-300/50 text-base-content/40 flex h-6 w-6 items-center justify-center rounded\">\n                    <Box size={12} />\n                  </div>\n                  <div className=\"min-w-0 flex-1\">\n                    <p className=\"truncate text-sm font-medium\">{item.name}</p>\n                    {item.description && <p className=\"text-base-content/50 truncate text-xs\">{item.description}</p>}\n                  </div>\n                  <span className={`text-xs font-medium ${getStockStatusColor(item.current_stock)}`}>\n                    Stock: {item.current_stock}\n                  </span>\n                </div>\n              ))}\n            </div>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/pages/settings/MercadoPagoSettingsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":310,"column":17,"nodeType":"Identifier","messageId":"alwaysTruthy","endLine":310,"endColumn":24}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMutation, useSuspenseQuery } from \"@tanstack/react-query\";\nimport dayjs from \"dayjs\";\nimport { CheckCircle2, Clock, FileText, Plus, Settings } from \"lucide-react\";\nimport { useState } from \"react\";\n\nimport { DataTable } from \"@/components/data-table/DataTable\";\nimport GenerateReportModal from \"@/components/mercadopago/GenerateReportModal\";\nimport Button from \"@/components/ui/Button\";\nimport {\n  DropdownMenu,\n  DropdownMenuCheckboxItem,\n  DropdownMenuContent,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/DropdownMenu\";\nimport Modal from \"@/components/ui/Modal\";\nimport StatCard from \"@/components/ui/StatCard\";\nimport { useToast } from \"@/context/ToastContext\";\nimport { getMpReportColumns } from \"@/features/finance/mercadopago/components/MpReportColumns\";\nimport { mercadoPagoKeys } from \"@/features/finance/mercadopago/queries\";\nimport { PAGE_CONTAINER } from \"@/lib/styles\";\nimport { cn } from \"@/lib/utils\";\nimport { type ImportStats, type MpReportType, MPService } from \"@/services/mercadopago\";\n\nconst ALL_TABLE_COLUMNS = [\n  { key: \"id\", label: \"ID\" },\n  { key: \"date\", label: \"Creado\" },\n  { key: \"begin_date\", label: \"Desde\" },\n  { key: \"end_date\", label: \"Hasta\" },\n  { key: \"file\", label: \"Archivo\" },\n  { key: \"source\", label: \"Origen\" },\n  { key: \"status\", label: \"Estado\" },\n  { key: \"actions\", label: \"Acciones\" },\n];\n\nexport default function MercadoPagoSettingsPage() {\n  const { error: showError, success: showSuccess } = useToast();\n  const [activeTab, setActiveTab] = useState<MpReportType>(\"release\");\n  const [isGenerateModalOpen, setIsGenerateModalOpen] = useState(false);\n  const [visibleColumns, setVisibleColumns] = useState<Set<string>>(\n    new Set([\"actions\", \"begin_date\", \"date\", \"end_date\", \"file\", \"status\"])\n  );\n  const [lastImportStats, setLastImportStats] = useState<ImportStats | null>(null);\n\n  const toggleColumn = (key: string) => {\n    const newSet = new Set(visibleColumns);\n    if (newSet.has(key)) {\n      newSet.delete(key);\n    } else {\n      newSet.add(key);\n    }\n    setVisibleColumns(newSet);\n  };\n\n  // Queries\n  const { data: reports } = useSuspenseQuery(mercadoPagoKeys.lists(activeTab));\n\n  // Mutations\n\n  const downloadMutation = useMutation({\n    mutationFn: (fileName: string) => MPService.downloadReport(fileName, activeTab),\n    onError: (e: Error) => {\n      showError(`Error al descargar: ${e.message}`);\n    },\n    onSuccess: (blob, fileName) => {\n      const url = globalThis.URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = fileName;\n      document.body.append(a);\n      a.click();\n      globalThis.URL.revokeObjectURL(url);\n      a.remove();\n      showSuccess(`Descargando ${fileName}`);\n    },\n  });\n\n  const handleDownload = (e: React.MouseEvent, fileName: string) => {\n    e.preventDefault();\n    downloadMutation.mutate(fileName);\n  };\n\n  const [processingFile, setProcessingFile] = useState<null | string>(null);\n\n  const processMutation = useMutation({\n    mutationFn: (fileName: string) => MPService.processReport(fileName, activeTab),\n    onError: (e: Error) => {\n      showError(`Error al procesar: ${e.message}`);\n      setProcessingFile(null);\n    },\n    onSuccess: (stats) => {\n      setLastImportStats(stats);\n      showSuccess(`Reporte procesado: ${stats.insertedRows} insertados, ${stats.duplicateRows} duplicados`);\n      setProcessingFile(null);\n    },\n  });\n\n  const handleProcess = (e: React.MouseEvent, fileName: string) => {\n    e.preventDefault();\n    if (\n      confirm(\n        `¿Estás seguro de sincronizar el reporte ${fileName}? Esto podría duplicar datos si no se detecta correctamente.`\n      )\n    ) {\n      setProcessingFile(fileName);\n      setLastImportStats(null);\n      processMutation.mutate(fileName);\n    }\n  };\n\n  const columns = getMpReportColumns(\n    handleDownload,\n    handleProcess,\n    downloadMutation.isPending,\n    processMutation.isPending,\n    processingFile\n  );\n\n  return (\n    <div className={cn(PAGE_CONTAINER, \"space-y-6\")}>\n      {/* Header: Tabs + Actions */}\n      <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\n        {/* Tabs */}\n        <div className=\"tabs tabs-boxed bg-base-200/50 w-full p-1 sm:w-auto\" role=\"tablist\">\n          <button\n            className={cn(\n              \"tab h-9 flex-1 px-3 text-sm sm:flex-none sm:px-4\",\n              activeTab === \"release\" && \"tab-active bg-base-100 text-base-content font-medium shadow-sm transition-all\"\n            )}\n            onClick={() => {\n              setActiveTab(\"release\");\n            }}\n            role=\"tab\"\n          >\n            Liberación\n          </button>\n          <button\n            className={cn(\n              \"tab h-9 flex-1 px-3 text-sm sm:flex-none sm:px-4\",\n              activeTab === \"settlement\" &&\n                \"tab-active bg-base-100 text-base-content font-medium shadow-sm transition-all\"\n            )}\n            onClick={() => {\n              setActiveTab(\"settlement\");\n            }}\n            role=\"tab\"\n          >\n            Conciliación\n          </button>\n        </div>\n\n        {/* Action Button */}\n        <Button\n          className=\"w-full sm:w-auto\"\n          onClick={() => {\n            setIsGenerateModalOpen(true);\n          }}\n          size=\"sm\"\n          variant=\"primary\"\n        >\n          <Plus className=\"mr-2 h-4 w-4\" />\n          Generar Reporte\n        </Button>\n      </div>\n\n      {/* Import Stats Modal */}\n      <Modal\n        isOpen={!!lastImportStats}\n        onClose={() => {\n          setLastImportStats(null);\n        }}\n        title=\"Reporte Procesado\"\n      >\n        {lastImportStats && (\n          <div className=\"space-y-4\">\n            <div className=\"text-success flex items-center gap-2\">\n              <CheckCircle2 className=\"h-5 w-5\" />\n              <span className=\"font-medium\">Procesamiento completado</span>\n            </div>\n\n            <div className=\"bg-base-200/50 grid grid-cols-2 gap-3 rounded-lg p-4 sm:grid-cols-3\">\n              <div className=\"text-center\">\n                <p className=\"text-2xl font-bold\">{lastImportStats.totalRows}</p>\n                <p className=\"text-base-content/60 text-xs\">Total filas</p>\n              </div>\n              <div className=\"text-center\">\n                <p className=\"text-2xl font-bold\">{lastImportStats.validRows}</p>\n                <p className=\"text-base-content/60 text-xs\">Válidas</p>\n              </div>\n              <div className=\"text-center\">\n                <p className=\"text-success text-2xl font-bold\">{lastImportStats.insertedRows}</p>\n                <p className=\"text-success/70 text-xs\">Insertadas</p>\n              </div>\n              <div className=\"text-center\">\n                <p className=\"text-warning text-2xl font-bold\">{lastImportStats.duplicateRows}</p>\n                <p className=\"text-warning/70 text-xs\">Duplicados</p>\n              </div>\n              <div className=\"text-center\">\n                <p className=\"text-2xl font-bold\">{lastImportStats.skippedRows}</p>\n                <p className=\"text-base-content/60 text-xs\">Omitidas</p>\n              </div>\n              {lastImportStats.errors.length > 0 && (\n                <div className=\"text-center\">\n                  <p className=\"text-error text-2xl font-bold\">{lastImportStats.errors.length}</p>\n                  <p className=\"text-error/70 text-xs\">Errores</p>\n                </div>\n              )}\n            </div>\n\n            {lastImportStats.errors.length > 0 && (\n              <div className=\"bg-error/10 rounded-lg p-3 text-sm\">\n                <p className=\"text-error mb-2 font-medium\">Errores encontrados:</p>\n                <ul className=\"text-error/80 list-inside list-disc space-y-1 text-xs\">\n                  {lastImportStats.errors.slice(0, 5).map((err, i) => (\n                    <li key={i}>{err}</li>\n                  ))}\n                  {lastImportStats.errors.length > 5 && <li>...y {lastImportStats.errors.length - 5} más</li>}\n                </ul>\n              </div>\n            )}\n\n            <div className=\"flex justify-end\">\n              <Button\n                onClick={() => {\n                  setLastImportStats(null);\n                }}\n                variant=\"primary\"\n              >\n                Cerrar\n              </Button>\n            </div>\n          </div>\n        )}\n      </Modal>\n\n      <div className=\"grid grid-cols-1 gap-6 md:grid-cols-2\">\n        {/* Last Report Card */}\n        <article className=\"bg-base-100 border-base-300 rounded-2xl border p-6 shadow-sm\">\n          <div className=\"flex items-start justify-between\">\n            <div>\n              <p className=\"text-base-content/60 flex items-center gap-1.5 text-xs font-semibold tracking-wide uppercase\">\n                Último Reporte\n              </p>\n              <h3 className=\"mt-2 line-clamp-1 text-lg font-semibold\">\n                {(() => {\n                  const lastReport = reports[0];\n                  if (!lastReport) return \"N/A\";\n                  const date = lastReport.date_created ?? lastReport.begin_date;\n                  return date ? dayjs(date).format(\"D MMM, HH:mm\") : \"N/A\";\n                })()}\n              </h3>\n            </div>\n            <div className=\"bg-primary/10 text-primary rounded-lg p-2\">\n              <Clock className=\"h-5 w-5\" />\n            </div>\n          </div>\n          <p className=\"text-base-content/50 border-base-300/50 mt-4 truncate border-t pt-4 text-xs\">\n            {reports[0]?.file_name ?? \"Sin reportes recientes\"}\n          </p>\n        </article>\n\n        {/* Total Reports Card */}\n        <StatCard\n          className=\"h-full\"\n          icon={FileText}\n          subtitle={`Tipo: ${activeTab === \"release\" ? \"Liberación\" : \"Conciliación\"}`}\n          title=\"Total Reportes\"\n          tone=\"default\"\n          value={reports.length}\n        />\n      </div>\n\n      {/* Reports List */}\n      <div className=\"space-y-4\">\n        <div className=\"flex items-center justify-between px-1\">\n          <div className=\"flex items-center gap-2\">\n            <FileText className=\"text-primary h-4 w-4\" />\n            <h3 className=\"text-lg font-semibold\">Historial de Reportes</h3>\n          </div>\n\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button className=\"h-8\" size=\"sm\" variant=\"outline\">\n                <Settings className=\"mr-2 h-3.5 w-3.5\" />\n                Columnas\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\" className=\"w-45\">\n              <DropdownMenuLabel>Columnas Visibles</DropdownMenuLabel>\n              <DropdownMenuSeparator />\n              {ALL_TABLE_COLUMNS.filter((c) => c.key !== \"actions\").map((column) => (\n                <DropdownMenuCheckboxItem\n                  checked={visibleColumns.has(column.key)}\n                  key={column.key}\n                  onCheckedChange={() => {\n                    toggleColumn(column.key);\n                  }}\n                >\n                  {column.label}\n                </DropdownMenuCheckboxItem>\n              ))}\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n\n        <DataTable\n          columns={columns}\n          columnVisibility={Object.fromEntries([...visibleColumns].map((key) => [key, true]))}\n          data={reports || []}\n          noDataMessage=\"No se encontraron reportes generados.\"\n        />\n      </div>\n\n      {/* Modals */}\n      <GenerateReportModal\n        onClose={() => {\n          setIsGenerateModalOpen(false);\n        }}\n        open={isGenerateModalOpen}\n        reportType={activeTab}\n      />\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/pages/settings/PersonDetailsPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/pages/settings/RolesSettingsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-floating-promises","severity":2,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":48,"column":7,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":48,"endColumn":68,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[1924,1924],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[1924,1924],"text":"await "},"desc":"Add await operator."}]},{"ruleId":"@typescript-eslint/no-floating-promises","severity":2,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":73,"column":7,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":73,"endColumn":62,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[2777,2777],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[2777,2777],"text":"await "},"desc":"Add await operator."}]},{"ruleId":"prefer-const","severity":2,"message":"'newPermissionIds' is never reassigned. Use 'const' instead.","line":98,"column":5,"nodeType":"Identifier","messageId":"useConst","endLine":98,"endColumn":21},{"ruleId":"@typescript-eslint/no-unnecessary-condition","severity":2,"message":"Unnecessary conditional, value is always truthy.","line":130,"column":72,"nodeType":"Identifier","messageId":"alwaysTruthy","endLine":130,"endColumn":86}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMutation, useQueryClient, useSuspenseQuery } from \"@tanstack/react-query\";\nimport { Plus, RotateCw } from \"lucide-react\";\nimport { useState } from \"react\";\n\nimport { Card, CardContent, CardHeader } from \"@/components/ui/Card\";\nimport { useAuth } from \"@/context/AuthContext\";\nimport { useToast } from \"@/context/ToastContext\";\nimport { syncPermissions, updateRolePermissions } from \"@/features/roles/api\";\nimport { DeleteRoleModal } from \"@/features/roles/components/DeleteRoleModal\";\nimport { PermissionsMatrixTable } from \"@/features/roles/components/PermissionsMatrixTable\";\nimport { RoleFormModal } from \"@/features/roles/components/RoleFormModal\";\nimport { roleKeys } from \"@/features/roles/queries\";\nimport { getNavSections, type NavItem, type NavSectionData } from \"@/lib/nav-generator\";\nimport { cn } from \"@/lib/utils\";\nimport { Permission, Role } from \"@/types/roles\";\n\n// --- Page Component ---\n\nexport default function RolesSettingsPage() {\n  const { impersonate } = useAuth();\n  const queryClient = useQueryClient();\n  const toast = useToast();\n  const [isSyncing, setIsSyncing] = useState(false);\n  const [selectedRole, setSelectedRole] = useState<null | Role>(null);\n  const [isRoleModalOpen, setIsRoleModalOpen] = useState(false);\n  const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);\n  const [viewModeRole, setViewModeRole] = useState<string>(\"all\");\n\n  // Queries\n  const { data: roles } = useSuspenseQuery(roleKeys.lists());\n\n  const { data: allPermissions } = useSuspenseQuery(roleKeys.permissions());\n\n  // Mutations\n  const syncMutation = useMutation({\n    mutationFn: async () => {\n      setIsSyncing(true);\n      await syncPermissions();\n    },\n    onError: () => {\n      toast.error(\"Error al sincronizar permisos\");\n    },\n    onSettled: () => {\n      setIsSyncing(false);\n    },\n    onSuccess: () => {\n      toast.success(\"Permisos sincronizados con el sistema\");\n      queryClient.invalidateQueries({ queryKey: [\"permissions\"] });\n    },\n  });\n\n  const {\n    isPending: isUpdatingPermissions,\n    mutate: updatePermissions,\n    variables: updatingVariables,\n  } = useMutation({\n    mutationFn: updateRolePermissions,\n    onMutate: async ({ roleId, permissionIds }) => {\n      await queryClient.cancelQueries({ queryKey: [\"roles\"] });\n      const previousRoles = queryClient.getQueryData<Role[]>([\"roles\"]);\n\n      queryClient.setQueryData<Role[]>([\"roles\"], (old) => optimisticUpdateRole(old, roleId, permissionIds));\n\n      return { previousRoles };\n    },\n    onError: (_err, _newTodo, context) => {\n      toast.error(\"Error al actualizar permisos. Inténtalo de nuevo.\");\n      if (context?.previousRoles) {\n        queryClient.setQueryData([\"roles\"], context.previousRoles);\n      }\n    },\n    onSettled: () => {\n      queryClient.invalidateQueries({ queryKey: [\"roles\"] });\n    },\n  });\n\n  // Handlers\n  const handleCreateRole = () => {\n    setSelectedRole(null);\n    setIsRoleModalOpen(true);\n  };\n\n  const handleEditRole = (role: Role) => {\n    setSelectedRole(role);\n    setIsRoleModalOpen(true);\n  };\n\n  const handleDeleteRole = (role: Role) => {\n    setSelectedRole(role);\n    setIsDeleteModalOpen(true);\n  };\n\n  const handlePermissionToggle = (role: Role, permissionId: number) => {\n    const currentPermissionIds = role.permissions.map((p) => p.permissionId);\n    const hasPermission = currentPermissionIds.includes(permissionId);\n\n    let newPermissionIds;\n    newPermissionIds = hasPermission\n      ? currentPermissionIds.filter((id) => id !== permissionId)\n      : [...currentPermissionIds, permissionId];\n\n    updatePermissions({ permissionIds: newPermissionIds, roleId: role.id });\n  };\n\n  const handleBulkToggle = (role: Role, permissionIdsToToggle: number[]) => {\n    const currentPermissionIds = role.permissions.map((p) => p.permissionId);\n\n    // Check if ALL provided permissions are already present\n    const allPresent = permissionIdsToToggle.every((id) => currentPermissionIds.includes(id));\n\n    let newPermissionIds;\n    if (allPresent) {\n      // If all are present, remove them (toggle off)\n      newPermissionIds = currentPermissionIds.filter((id) => !permissionIdsToToggle.includes(id));\n    } else {\n      // If not all are present, add the missing ones (toggle on)\n      const missingIds = permissionIdsToToggle.filter((id) => !currentPermissionIds.includes(id));\n      newPermissionIds = [...currentPermissionIds, ...missingIds];\n    }\n\n    updatePermissions({ permissionIds: newPermissionIds, roleId: role.id });\n  };\n\n  // --- Grouping Logic ---\n\n  // Track which permissions are \"used\" by pages so we can show the rest in \"Advanced/System\"\n  const usedPermissionIds = new Set<number>();\n\n  // Pre-process navigation sections with permission data\n  const sectionsWithPermissions = processNavSections(getNavSections(), allPermissions || [], usedPermissionIds);\n\n  return (\n    <div className=\"space-y-6\">\n      <Card>\n        <CardHeader className=\"flex flex-row items-center justify-between gap-4 border-b pb-4\">\n          <div className=\"space-y-1\">\n            <h2 className=\"text-lg font-semibold\">Listado de roles</h2>\n            <p className=\"text-base-content/70 hidden text-sm md:block\">Gestiona los permisos y roles del sistema</p>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            {/* Role Filter Selector */}\n            <div className=\"hidden sm:block\">\n              <select\n                className=\"select select-bordered select-sm w-full max-w-50\"\n                onChange={(e) => {\n                  setViewModeRole(e.target.value);\n                }}\n                value={viewModeRole}\n              >\n                <option value=\"all\">Ver todos los roles</option>\n                {roles.map((r) => (\n                  <option key={r.id} value={r.id}>\n                    {r.name}\n                  </option>\n                ))}\n              </select>\n            </div>\n\n            <div className=\"ml-2 flex items-center gap-2 border-l pl-2\">\n              <button\n                className=\"btn btn-ghost btn-sm btn-square\"\n                disabled={isSyncing}\n                onClick={() => {\n                  syncMutation.mutate();\n                }}\n                title=\"Sincronizar permisos\"\n              >\n                <RotateCw className={cn(\"h-4 w-4\", isSyncing && \"animate-spin\")} />\n              </button>\n\n              <button className=\"btn btn-primary btn-sm gap-2\" onClick={handleCreateRole}>\n                <Plus className=\"h-4 w-4\" />\n                <span className=\"hidden sm:inline\">Nuevo rol</span>\n              </button>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent className=\"overflow-hidden p-0\">\n          <PermissionsMatrixTable\n            isUpdatingPermissions={isUpdatingPermissions}\n            onBulkToggle={handleBulkToggle}\n            onDeleteRole={handleDeleteRole}\n            onEditRole={handleEditRole}\n            onImpersonate={impersonate}\n            onPermissionToggle={handlePermissionToggle}\n            roles={roles}\n            sections={sectionsWithPermissions}\n            updatingRoleId={updatingVariables?.roleId}\n            viewModeRole={viewModeRole}\n          />\n        </CardContent>\n      </Card>\n\n      {isRoleModalOpen && (\n        <RoleFormModal\n          isOpen={isRoleModalOpen}\n          onClose={() => {\n            setIsRoleModalOpen(false);\n          }}\n          role={selectedRole}\n        />\n      )}\n\n      {isDeleteModalOpen && selectedRole && (\n        <DeleteRoleModal\n          allRoles={roles}\n          isOpen={isDeleteModalOpen}\n          onClose={() => {\n            setIsDeleteModalOpen(false);\n          }}\n          role={selectedRole}\n        />\n      )}\n    </div>\n  );\n}\n\n// Helper: Optimistic Update Logic\nfunction optimisticUpdateRole(oldRoles: Role[] | undefined, roleId: number, permissionIds: number[]): Role[] {\n  if (!oldRoles) return [];\n  return oldRoles.map((role) => {\n    if (role.id === roleId) {\n      const newPermissions = permissionIds.map((id) => ({\n        permission: { action: \"\", description: \"\", id, subject: \"\" }, // Placeholder\n        permissionId: id,\n      }));\n      return { ...role, permissions: newPermissions };\n    }\n    return role;\n  });\n}\n\n// Helper: Navigation Processing Logic\n// Updated return type to match PermissionsMatrixTable requirements implicitly\nfunction processNavSections(\n  navSections: NavSectionData[],\n  allPermissions: Permission[],\n  usedPermissionIds: Set<number>\n) {\n  return navSections\n    .map((section: NavSectionData) => {\n      const itemsWithPermissions = section.items\n        .map((item: NavItem) => {\n          const perms: Permission[] = [];\n\n          if (item.requiredPermission) {\n            const subject = item.requiredPermission.subject;\n            const related = allPermissions.filter((p) => p.subject.toLowerCase() === subject.toLowerCase());\n            perms.push(...related);\n          }\n\n          const uniquePermissions = [...new Map(perms.map((p) => [p.id, p])).values()];\n          for (const p of uniquePermissions) usedPermissionIds.add(p.id);\n\n          if (uniquePermissions.length === 0) return null;\n\n          return {\n            icon: item.icon,\n            label: item.label,\n            permissionIds: uniquePermissions.map((p) => p.id),\n            relatedPermissions: uniquePermissions,\n          };\n        })\n        .filter((item): item is NonNullable<typeof item> => item !== null);\n\n      const sectionPermissionIds = itemsWithPermissions.flatMap((item) => item.permissionIds);\n\n      return {\n        items: itemsWithPermissions,\n        permissionIds: sectionPermissionIds,\n        title: section.title,\n      };\n    })\n    .filter((section) => section.items.length > 0);\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/__root.tsx","messages":[{"ruleId":"turbo/no-undeclared-env-vars","severity":2,"message":"NODE_ENV is not listed as a dependency in turbo.json","line":9,"column":3,"nodeType":"MemberExpression","endLine":9,"endColumn":23}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { QueryClient } from \"@tanstack/react-query\";\nimport { createRootRouteWithContext, Outlet } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport type { AuthContextType } from \"@/context/AuthContext\";\n\n// Lazy load devtools for development only\nconst TanStackRouterDevtools =\n  process.env.NODE_ENV === \"production\"\n    ? () => null\n    : lazy(() =>\n        import(\"@tanstack/router-devtools\").then((res) => ({\n          default: res.TanStackRouterDevtools,\n        }))\n      );\n\nimport type { NavConfig, RoutePermission } from \"@/types/navigation\";\n\n// Extend the router's static data interface\ndeclare module \"@tanstack/react-router\" {\n  interface StaticDataRouteOption {\n    nav?: NavConfig;\n    permission?: RoutePermission;\n    title?: string;\n  }\n}\n\n// Router Context - shared across all routes\nexport interface RouterContext {\n  auth: AuthContextType;\n  queryClient: QueryClient;\n}\n\nexport const Route = createRootRouteWithContext<RouterContext>()({\n  component: RootComponent,\n});\n\nfunction RootComponent() {\n  return (\n    <>\n      <Outlet />\n      <Suspense>\n        <TanStackRouterDevtools position=\"bottom-right\" />\n      </Suspense>\n    </>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":28,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":33,"endColumn":9,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":39,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":41,"endColumn":9,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/account.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/calendar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/calendar/classify.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":19,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":19,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\nimport { calendarQueries } from \"@/features/calendar/queries\";\n\nconst CalendarClassificationPage = lazy(() => import(\"@/pages/CalendarClassificationPage\"));\n\nconst routeApi = getRouteApi(\"/_authed/calendar/classify\");\n\nexport const Route = createFileRoute(\"/_authed/calendar/classify\")({\n  staticData: {\n    nav: { iconKey: \"ListChecks\", label: \"Clasificar\", order: 4, section: \"Calendario\" },\n    permission: { action: \"update\", subject: \"CalendarEvent\" },\n    title: \"Clasificar eventos\",\n  },\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"update\", \"CalendarEvent\")) {\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <CalendarClassificationPage />\n    </Suspense>\n  ),\n  loader: async ({ context }) => {\n    await Promise.all([\n      context.queryClient.ensureQueryData(calendarQueries.unclassified(0, 50, {})),\n      context.queryClient.ensureQueryData(calendarQueries.options()),\n    ]);\n  },\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/calendar/daily.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":20,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":20,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\nimport { calendarQueries } from \"@/features/calendar/queries\";\nimport { computeDefaultFilters } from \"@/features/calendar/utils/filters\";\n\nconst CalendarDailyPage = lazy(() => import(\"@/pages/CalendarDailyPage\"));\n\nconst routeApi = getRouteApi(\"/_authed/calendar/daily\");\n\nexport const Route = createFileRoute(\"/_authed/calendar/daily\")({\n  staticData: {\n    nav: { iconKey: \"Calendar\", label: \"Detalle Diario\", order: 2, section: \"Calendario\" },\n    permission: { action: \"read\", subject: \"CalendarDaily\" },\n    title: \"Detalle diario\",\n  },\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"CalendarDaily\")) {\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <CalendarDailyPage />\n    </Suspense>\n  ),\n  loader: async ({ context }) => {\n    const defaults = computeDefaultFilters({});\n    await Promise.all([\n      context.queryClient.ensureQueryData(calendarQueries.summary(defaults)),\n      context.queryClient.ensureQueryData(calendarQueries.daily(defaults)),\n    ]);\n  },\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/calendar/heatmap.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":17,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":17,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst CalendarHeatmapPage = lazy(() => import(\"@/pages/CalendarHeatmapPage\"));\n\nexport const Route = createFileRoute(\"/_authed/calendar/heatmap\")({\n  staticData: {\n    nav: { iconKey: \"LayoutDashboard\", label: \"Mapa de Calor\", order: 3, section: \"Calendario\" },\n    permission: { action: \"read\", subject: \"CalendarHeatmap\" },\n    title: \"Mapa de calor\",\n  },\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"CalendarHeatmap\")) {\n      const routeApi = getRouteApi(\"/_authed/calendar/heatmap\");\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <CalendarHeatmapPage />\n    </Suspense>\n  ),\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/calendar/index.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":7,"column":11,"nodeType":"CallExpression","messageId":"object","endLine":7,"endColumn":58}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\n\n// Index route for calendar - redirects to schedule\nexport const Route = createFileRoute(\"/_authed/calendar/\")({\n  beforeLoad: () => {\n    const routeApi = getRouteApi(\"/_authed/calendar/\");\n    throw routeApi.redirect({ to: \"/calendar/schedule\" });\n  },\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/calendar/schedule.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":20,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":20,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\nimport { calendarQueries } from \"@/features/calendar/queries\";\nimport { computeDefaultFilters } from \"@/features/calendar/utils/filters\";\n\nconst CalendarSchedulePage = lazy(() => import(\"@/pages/CalendarSchedulePage\"));\n\nconst routeApi = getRouteApi(\"/_authed/calendar/schedule\");\n\nexport const Route = createFileRoute(\"/_authed/calendar/schedule\")({\n  staticData: {\n    nav: { iconKey: \"CalendarDays\", label: \"Calendario\", order: 1, section: \"Calendario\" },\n    permission: { action: \"read\", subject: \"CalendarSchedule\" },\n    title: \"Calendario interactivo\",\n  },\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"CalendarSchedule\")) {\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <CalendarSchedulePage />\n    </Suspense>\n  ),\n  loader: async ({ context }) => {\n    const defaults = computeDefaultFilters({});\n    await Promise.all([\n      context.queryClient.ensureQueryData(calendarQueries.summary(defaults)),\n      context.queryClient.ensureQueryData(calendarQueries.daily(defaults)),\n    ]);\n  },\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/calendar/sync-history.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":18,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":18,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\nimport { calendarSyncQueries } from \"@/features/calendar/queries\";\n\nconst CalendarSyncHistoryPage = lazy(() => import(\"@/pages/CalendarSyncHistoryPage\"));\n\nexport const Route = createFileRoute(\"/_authed/calendar/sync-history\")({\n  staticData: {\n    nav: { iconKey: \"Clock\", label: \"Historial Sync\", order: 5, section: \"Calendario\" },\n    permission: { action: \"read\", subject: \"CalendarSyncLog\" },\n    title: \"Historial de sincronización\",\n  },\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"CalendarSyncLog\")) {\n      const routeApi = getRouteApi(\"/_authed/calendar/sync-history\");\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <CalendarSyncHistoryPage />\n    </Suspense>\n  ),\n  loader: ({ context }) => context.queryClient.ensureQueryData(calendarSyncQueries.logs(50)),\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/finanzas.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/finanzas/conciliaciones.tsx","messages":[{"ruleId":"only-throw-error","message":"Definition for rule 'only-throw-error' was not found.","line":17,"column":7,"endLine":17,"endColumn":51,"severity":2,"nodeType":null},{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":18,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":18,"endColumn":43}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst SettlementsPage = lazy(() => import(\"@/features/finance/mercadopago/pages/SettlementTransactionsPage\"));\n\nexport const Route = createFileRoute(\"/_authed/finanzas/conciliaciones\")({\n  staticData: {\n    nav: { iconKey: \"ListChecks\", label: \"Conciliaciones\", order: 2, section: \"Finanzas\" },\n    permission: { action: \"read\", subject: \"Integration\" },\n    title: \"Conciliaciones\",\n  },\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"Integration\")) {\n      const routeApi = getRouteApi(\"/_authed/finanzas/conciliaciones\");\n      // eslint-disable-next-line only-throw-error\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <SettlementsPage />\n    </Suspense>\n  ),\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/finanzas/counterparts.tsx","messages":[{"ruleId":"only-throw-error","message":"Definition for rule 'only-throw-error' was not found.","line":17,"column":7,"endLine":17,"endColumn":51,"severity":2,"nodeType":null},{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":18,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":18,"endColumn":43}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst Counterparts = lazy(() => import(\"@/pages/Counterparts\"));\n\nexport const Route = createFileRoute(\"/_authed/finanzas/counterparts\")({\n  staticData: {\n    nav: { iconKey: \"Users2\", label: \"Contrapartes\", order: 5, section: \"Finanzas\" },\n    permission: { action: \"read\", subject: \"Counterpart\" },\n    title: \"Contrapartes\",\n  },\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"Counterpart\")) {\n      const routeApi = getRouteApi(\"/_authed/finanzas/counterparts\");\n      // eslint-disable-next-line only-throw-error\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  // Note: Skipping loader because this page uses ZenStack useFindManyCounterpart hook\n  // which has its own caching mechanism via TanStack Query\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <Counterparts />\n    </Suspense>\n  ),\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/finanzas/index.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":6,"column":11,"nodeType":"CallExpression","messageId":"object","endLine":6,"endColumn":64}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\n\nexport const Route = createFileRoute(\"/_authed/finanzas/\")({\n  beforeLoad: () => {\n    const routeApi = getRouteApi(\"/_authed/finanzas/\");\n    throw routeApi.redirect({ to: \"/finanzas/conciliaciones\" });\n  },\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/finanzas/liberaciones.tsx","messages":[{"ruleId":"only-throw-error","message":"Definition for rule 'only-throw-error' was not found.","line":17,"column":7,"endLine":17,"endColumn":51,"severity":2,"nodeType":null},{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":18,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":18,"endColumn":43}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst ReleasesPage = lazy(() => import(\"@/features/finance/mercadopago/pages/ReleaseTransactionsPage\"));\n\nexport const Route = createFileRoute(\"/_authed/finanzas/liberaciones\")({\n  staticData: {\n    nav: { iconKey: \"Wallet\", label: \"Liberaciones\", order: 3, section: \"Finanzas\" },\n    permission: { action: \"read\", subject: \"Integration\" },\n    title: \"Liberaciones\",\n  },\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"Integration\")) {\n      const routeApi = getRouteApi(\"/_authed/finanzas/liberaciones\");\n      // eslint-disable-next-line only-throw-error\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <ReleasesPage />\n    </Suspense>\n  ),\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/finanzas/loans.tsx","messages":[{"ruleId":"only-throw-error","message":"Definition for rule 'only-throw-error' was not found.","line":19,"column":7,"endLine":19,"endColumn":51,"severity":2,"nodeType":null},{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":20,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":20,"endColumn":43}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\nimport { fetchLoans } from \"@/features/finance/loans/api\";\nimport { loanKeys } from \"@/features/finance/loans/queries\";\n\nconst LoansPage = lazy(() => import(\"@/features/finance/loans/pages/LoansPage\"));\n\nexport const Route = createFileRoute(\"/_authed/finanzas/loans\")({\n  staticData: {\n    nav: { iconKey: \"PiggyBank\", label: \"Préstamos\", order: 8, section: \"Finanzas\" },\n    permission: { action: \"read\", subject: \"Loan\" },\n    title: \"Gestión de préstamos\",\n  },\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"Loan\")) {\n      const routeApi = getRouteApi(\"/_authed/finanzas/loans\");\n      // eslint-disable-next-line only-throw-error\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <LoansPage />\n    </Suspense>\n  ),\n  loader: async ({ context: { queryClient } }) => {\n    await queryClient.ensureQueryData({\n      queryFn: fetchLoans,\n      queryKey: loanKeys.all,\n    });\n  },\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/finanzas/participants.tsx","messages":[{"ruleId":"only-throw-error","message":"Definition for rule 'only-throw-error' was not found.","line":19,"column":7,"endLine":19,"endColumn":51,"severity":2,"nodeType":null},{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":20,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":20,"endColumn":43}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport dayjs from \"dayjs\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\nimport { participantQueries } from \"@/features/participants/queries\";\n\nconst ParticipantInsights = lazy(() => import(\"@/pages/ParticipantInsights\"));\n\nexport const Route = createFileRoute(\"/_authed/finanzas/participants\")({\n  staticData: {\n    nav: { iconKey: \"Users2\", label: \"Participantes\", order: 6, section: \"Finanzas\" },\n    permission: { action: \"read\", subject: \"Person\" },\n    title: \"Análisis de participantes\",\n  },\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"Person\")) {\n      const routeApi = getRouteApi(\"/_authed/finanzas/participants\");\n      // eslint-disable-next-line only-throw-error\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <ParticipantInsights />\n    </Suspense>\n  ),\n  loader: async ({ context }) => {\n    // Default params matching the hook defaults\n    const now = dayjs();\n    const range = {\n      from: now.startOf(\"month\").format(\"YYYY-MM-DD\"),\n      to: now.endOf(\"month\").format(\"YYYY-MM-DD\"),\n    };\n\n    await context.queryClient.ensureQueryData(\n      participantQueries.leaderboard({\n        ...range,\n        limit: 10,\n        mode: \"outgoing\",\n      })\n    );\n  },\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/finanzas/payouts.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":16,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":16,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst PayoutsPage = lazy(() => import(\"@/features/payouts/PayoutsPage\"));\n\nexport const Route = createFileRoute(\"/_authed/finanzas/payouts\")({\n  beforeLoad: ({ context }) => {\n    // Assuming simple permission check for now using 'read' 'Finance' as a broad category or specific if 'ReleaseTransaction' is mapped in Ability.\n    // Ideally this matches the check inside the component or API.\n    if (!context.auth.can(\"read\", \"ReleaseTransaction\")) {\n      // Fallback or just let the component handle the error message if we want to be less strict here,\n      // but standard is to redirect.\n      const routeApi = getRouteApi(\"/_authed/finanzas/payouts\");\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <PayoutsPage />\n    </Suspense>\n  ),\n  loader: async ({ context: { queryClient } }) => {\n    const { payoutKeys } = await import(\"@/features/payouts/queries\");\n    await queryClient.ensureQueryData(payoutKeys.list());\n  },\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/finanzas/personal-credits.$creditId.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/finanzas/personal-credits.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/finanzas/production-balances.tsx","messages":[{"ruleId":"only-throw-error","message":"Definition for rule 'only-throw-error' was not found.","line":17,"column":7,"endLine":17,"endColumn":51,"severity":2,"nodeType":null},{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":18,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":18,"endColumn":43}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst DailyBalancePage = lazy(() => import(\"@/features/production-balances/DailyBalancePage\"));\n\nexport const Route = createFileRoute(\"/_authed/finanzas/production-balances\")({\n  staticData: {\n    nav: { iconKey: \"FileSpreadsheet\", label: \"Balance Diario\", order: 7, section: \"Finanzas\" },\n    permission: { action: \"read\", subject: \"DailyBalance\" },\n    title: \"Balance diario de producción\",\n  },\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"DailyBalance\")) {\n      const routeApi = getRouteApi(\"/_authed/finanzas/production-balances\");\n      // eslint-disable-next-line only-throw-error\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <DailyBalancePage />\n    </Suspense>\n  ),\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/finanzas/statistics.tsx","messages":[{"ruleId":"only-throw-error","message":"Definition for rule 'only-throw-error' was not found.","line":17,"column":7,"endLine":17,"endColumn":51,"severity":2,"nodeType":null},{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":18,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":18,"endColumn":43}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst FinanzasStatsPage = lazy(() => import(\"@/features/finance/statistics/pages/FinanzasStatsPage\"));\n\nexport const Route = createFileRoute(\"/_authed/finanzas/statistics\")({\n  staticData: {\n    nav: { iconKey: \"BarChart3\", label: \"Estadísticas\", order: 4, section: \"Finanzas\" },\n    permission: { action: \"read\", subject: \"TransactionStats\" },\n    title: \"Estadísticas financieras\",\n  },\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"TransactionStats\")) {\n      const routeApi = getRouteApi(\"/_authed/finanzas/statistics\");\n      // eslint-disable-next-line only-throw-error\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <FinanzasStatsPage />\n    </Suspense>\n  ),\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/hr.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/hr/audit.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":12,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":12,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst TimesheetAuditPage = lazy(() => import(\"@/features/hr/timesheets-audit/pages/TimesheetAuditPage\"));\n\nexport const Route = createFileRoute(\"/_authed/hr/audit\")({\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"TimesheetAudit\")) {\n      const routeApi = getRouteApi(\"/_authed/hr/audit\");\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <TimesheetAuditPage />\n    </Suspense>\n  ),\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/hr/employees.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":13,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":13,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\nimport { employeeKeys } from \"@/features/hr/employees/queries\";\n\nconst EmployeesPage = lazy(() => import(\"@/features/hr/employees/pages/EmployeesPage\"));\n\nexport const Route = createFileRoute(\"/_authed/hr/employees\")({\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"Employee\")) {\n      const routeApi = getRouteApi(\"/_authed/hr/employees\");\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <EmployeesPage />\n    </Suspense>\n  ),\n  loader: ({ context: { queryClient } }) => {\n    return queryClient.ensureQueryData(employeeKeys.list({ includeInactive: false }));\n  },\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/hr/index.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":6,"column":11,"nodeType":"CallExpression","messageId":"object","endLine":6,"endColumn":53}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\n\nexport const Route = createFileRoute(\"/_authed/hr/\")({\n  beforeLoad: () => {\n    const routeApi = getRouteApi(\"/_authed/hr/\");\n    throw routeApi.redirect({ to: \"/hr/employees\" });\n  },\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/hr/reports.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":12,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":12,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst ReportsPage = lazy(() => import(\"@/features/hr/reports/pages/ReportsPage\"));\n\nexport const Route = createFileRoute(\"/_authed/hr/reports\")({\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"Report\")) {\n      const routeApi = getRouteApi(\"/_authed/hr/reports\");\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <ReportsPage />\n    </Suspense>\n  ),\n  loader: async ({ context: { queryClient } }) => {\n    const { employeeKeys } = await import(\"@/features/hr/employees/queries\");\n    const { timesheetQueries } = await import(\"@/features/hr/timesheets/queries\");\n\n    await Promise.all([\n      queryClient.ensureQueryData(employeeKeys.list({ includeInactive: false })),\n      queryClient.ensureQueryData(timesheetQueries.months()),\n    ]);\n  },\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/hr/timesheets.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":14,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":14,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\nimport { employeeKeys } from \"@/features/hr/employees/queries\";\nimport { timesheetQueries } from \"@/features/hr/timesheets/queries\";\n\nconst TimesheetsPage = lazy(() => import(\"@/features/hr/timesheets/pages/TimesheetsPage\"));\n\nexport const Route = createFileRoute(\"/_authed/hr/timesheets\")({\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"TimesheetList\")) {\n      const routeApi = getRouteApi(\"/_authed/hr/timesheets\");\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <TimesheetsPage />\n    </Suspense>\n  ),\n  loader: async ({ context }) => {\n    await Promise.all([\n      context.queryClient.ensureQueryData(timesheetQueries.months()),\n      context.queryClient.ensureQueryData(employeeKeys.list({ includeInactive: false })),\n    ]);\n  },\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/index.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/onboarding.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/operations.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/operations/index.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":6,"column":11,"nodeType":"CallExpression","messageId":"object","endLine":6,"endColumn":61}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\n\nexport const Route = createFileRoute(\"/_authed/operations/\")({\n  beforeLoad: () => {\n    const routeApi = getRouteApi(\"/_authed/operations/\");\n    throw routeApi.redirect({ to: \"/operations/inventory\" });\n  },\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/operations/inventory.tsx","messages":[{"ruleId":"only-throw-error","message":"Definition for rule 'only-throw-error' was not found.","line":18,"column":7,"endLine":18,"endColumn":51,"severity":2,"nodeType":null},{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":19,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":19,"endColumn":43}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\nimport { inventoryKeys } from \"@/features/inventory/queries\";\n\nconst InventoryPage = lazy(() => import(\"@/features/operations/inventory/pages/InventoryPage\"));\n\nexport const Route = createFileRoute(\"/_authed/operations/inventory\")({\n  staticData: {\n    nav: { iconKey: \"Box\", label: \"Inventario\", order: 1, section: \"Operaciones\" },\n    permission: { action: \"read\", subject: \"InventoryItem\" },\n    title: \"Inventario\",\n  },\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"InventoryItem\")) {\n      const routeApi = getRouteApi(\"/_authed/operations/inventory\");\n      // eslint-disable-next-line only-throw-error\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <InventoryPage />\n    </Suspense>\n  ),\n  loader: ({ context: { queryClient } }) => {\n    return queryClient.ensureQueryData(inventoryKeys.items());\n  },\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/operations/supplies.tsx","messages":[{"ruleId":"only-throw-error","message":"Definition for rule 'only-throw-error' was not found.","line":17,"column":7,"endLine":17,"endColumn":51,"severity":2,"nodeType":null},{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":18,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":18,"endColumn":43}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst SuppliesPage = lazy(() => import(\"@/features/operations/supplies/pages/SuppliesPage\"));\n\nexport const Route = createFileRoute(\"/_authed/operations/supplies\")({\n  staticData: {\n    nav: { iconKey: \"PackagePlus\", label: \"Insumos\", order: 2, section: \"Operaciones\" },\n    permission: { action: \"read\", subject: \"SupplyRequest\" },\n    title: \"Solicitudes de insumos\",\n  },\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"SupplyRequest\")) {\n      const routeApi = getRouteApi(\"/_authed/operations/supplies\");\n      // eslint-disable-next-line only-throw-error\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <SuppliesPage />\n    </Suspense>\n  ),\n  loader: async ({ context: { queryClient } }) => {\n    const { supplyQueries } = await import(\"@/features/supplies/queries\");\n    await Promise.all([\n      queryClient.ensureQueryData(supplyQueries.requests()),\n      queryClient.ensureQueryData(supplyQueries.common()),\n    ]);\n  },\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/services.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/services/$id.edit.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":12,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":12,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst EditServicePage = lazy(() => import(\"@/features/services/pages/EditServicePage\"));\n\nexport const Route = createFileRoute(\"/_authed/services/$id/edit\")({\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"update\", \"Service\")) {\n      const routeApi = getRouteApi(\"/_authed/services/$id/edit\");\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <EditServicePage />\n    </Suspense>\n  ),\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/services/agenda.tsx","messages":[{"ruleId":"only-throw-error","message":"Definition for rule 'only-throw-error' was not found.","line":18,"column":7,"endLine":18,"endColumn":51,"severity":2,"nodeType":null},{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":19,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":19,"endColumn":43}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\nimport { serviceQueries } from \"@/features/services/queries\";\n\nconst AgendaPage = lazy(() => import(\"@/features/services/pages/AgendaPage\"));\n\nexport const Route = createFileRoute(\"/_authed/services/agenda\")({\n  staticData: {\n    nav: { iconKey: \"Calendar\", label: \"Agenda\", order: 1, section: \"Servicios\" },\n    permission: { action: \"read\", subject: \"ServiceAgenda\" },\n    title: \"Agenda de servicios\",\n  },\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"ServiceAgenda\")) {\n      const routeApi = getRouteApi(\"/_authed/services/agenda\");\n      // eslint-disable-next-line only-throw-error\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <AgendaPage />\n    </Suspense>\n  ),\n  loader: async ({ context }) => {\n    await context.queryClient.ensureQueryData(serviceQueries.list());\n  },\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/services/create.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":12,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":12,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst CreateServicePage = lazy(() => import(\"@/features/services/pages/CreateServicePage\"));\n\nexport const Route = createFileRoute(\"/_authed/services/create\")({\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"create\", \"Service\")) {\n      const routeApi = getRouteApi(\"/_authed/services/create\");\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <CreateServicePage />\n    </Suspense>\n  ),\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/services/index.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":13,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":13,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst OverviewPage = lazy(() => import(\"@/features/services/pages/OverviewPage\"));\n\n// Services index - shows the overview page\nexport const Route = createFileRoute(\"/_authed/services/\")({\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"ServiceList\")) {\n      const routeApi = getRouteApi(\"/_authed/services/\");\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <OverviewPage />\n    </Suspense>\n  ),\n  loader: async ({ context: { queryClient } }) => {\n    const { serviceQueries } = await import(\"@/features/services/queries\");\n    await queryClient.ensureQueryData(serviceQueries.list(true));\n  },\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/services/templates.tsx","messages":[{"ruleId":"only-throw-error","message":"Definition for rule 'only-throw-error' was not found.","line":17,"column":7,"endLine":17,"endColumn":51,"severity":2,"nodeType":null},{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":18,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":18,"endColumn":43}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst TemplatesPage = lazy(() => import(\"@/features/services/pages/TemplatesPage\"));\n\nexport const Route = createFileRoute(\"/_authed/services/templates\")({\n  staticData: {\n    nav: { iconKey: \"FileSpreadsheet\", label: \"Plantillas\", order: 2, section: \"Servicios\" },\n    permission: { action: \"read\", subject: \"ServiceTemplate\" },\n    title: \"Plantillas de servicios\",\n  },\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"ServiceTemplate\")) {\n      const routeApi = getRouteApi(\"/_authed/services/templates\");\n      // eslint-disable-next-line only-throw-error\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <TemplatesPage />\n    </Suspense>\n  ),\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/settings.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/settings/access.tsx","messages":[{"ruleId":"only-throw-error","message":"Definition for rule 'only-throw-error' was not found.","line":19,"column":7,"endLine":19,"endColumn":51,"severity":2,"nodeType":null},{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":20,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":20,"endColumn":43}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst AccessSettingsPage = lazy(() => import(\"@/pages/settings/AccessSettingsPage\"));\n\nexport const Route = createFileRoute(\"/_authed/settings/access\")({\n  staticData: {\n    nav: { iconKey: \"Settings2\", label: \"Ajustes\", order: 3, section: \"Sistema\" },\n    // Notice permission here is slightly different (update vs read usually), sticking to original route-data logic or best guess if not sure.\n    // Original route-data access.tsx had 'update User'.\n    permission: { action: \"update\", subject: \"User\" },\n    title: \"Ajustes de acceso\",\n  },\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"update\", \"User\")) {\n      const routeApi = getRouteApi(\"/_authed/settings/access\");\n      // eslint-disable-next-line only-throw-error\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <AccessSettingsPage />\n    </Suspense>\n  ),\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/settings/backups.tsx","messages":[{"ruleId":"only-throw-error","message":"Definition for rule 'only-throw-error' was not found.","line":17,"column":7,"endLine":17,"endColumn":51,"severity":2,"nodeType":null},{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":18,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":18,"endColumn":43}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst BackupSettingsPage = lazy(() => import(\"@/pages/settings/BackupSettingsPage\"));\n\nexport const Route = createFileRoute(\"/_authed/settings/backups\")({\n  staticData: {\n    nav: { iconKey: \"Database\", label: \"Backups\", order: 4, section: \"Sistema\" },\n    permission: { action: \"read\", subject: \"Backup\" },\n    title: \"Copias de seguridad\",\n  },\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"Backup\")) {\n      const routeApi = getRouteApi(\"/_authed/settings/backups\");\n      // eslint-disable-next-line only-throw-error\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <BackupSettingsPage />\n    </Suspense>\n  ),\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/settings/calendar.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":12,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":12,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst CalendarSettingsPage = lazy(() => import(\"@/pages/settings/CalendarSettingsPage\"));\n\nexport const Route = createFileRoute(\"/_authed/settings/calendar\")({\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"update\", \"CalendarSetting\")) {\n      const routeApi = getRouteApi(\"/_authed/settings/calendar\");\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <CalendarSettingsPage />\n    </Suspense>\n  ),\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/settings/csv-upload.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":12,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":12,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst CSVUploadPage = lazy(() => import(\"@/pages/settings/CSVUploadPage\"));\n\nexport const Route = createFileRoute(\"/_authed/settings/csv-upload\")({\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"create\", \"BulkData\")) {\n      const routeApi = getRouteApi(\"/_authed/settings/csv-upload\");\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <CSVUploadPage />\n    </Suspense>\n  ),\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/settings/index.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":6,"column":11,"nodeType":"CallExpression","messageId":"object","endLine":6,"endColumn":55}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\n\nexport const Route = createFileRoute(\"/_authed/settings/\")({\n  beforeLoad: () => {\n    const routeApi = getRouteApi(\"/_authed/settings/\");\n    throw routeApi.redirect({ to: \"/settings/roles\" });\n  },\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/settings/inventario.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":12,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":12,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst InventorySettingsPage = lazy(() => import(\"@/pages/settings/InventorySettingsPage\"));\n\nexport const Route = createFileRoute(\"/_authed/settings/inventario\")({\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"update\", \"InventorySetting\")) {\n      const routeApi = getRouteApi(\"/_authed/settings/inventario\");\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <InventorySettingsPage />\n    </Suspense>\n  ),\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/settings/mercadopago.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":12,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":12,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst MercadoPagoSettingsPage = lazy(() => import(\"@/pages/settings/MercadoPagoSettingsPage\"));\n\nexport const Route = createFileRoute(\"/_authed/settings/mercadopago\")({\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"Integration\")) {\n      const routeApi = getRouteApi(\"/_authed/settings/mercadopago\");\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <MercadoPagoSettingsPage />\n    </Suspense>\n  ),\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/settings/people.$id.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":12,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":12,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst PersonDetailsPage = lazy(() => import(\"@/pages/settings/PersonDetailsPage\"));\n\nexport const Route = createFileRoute(\"/_authed/settings/people/$id\")({\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"Person\")) {\n      const routeApi = getRouteApi(\"/_authed/settings/people/$id\");\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <PersonDetailsPage />\n    </Suspense>\n  ),\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/settings/people.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":12,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":12,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst PersonManagementPage = lazy(() => import(\"@/features/users/pages/PersonManagementPage\"));\n\nexport const Route = createFileRoute(\"/_authed/settings/people\")({\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"Person\")) {\n      const routeApi = getRouteApi(\"/_authed/settings/people\");\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <PersonManagementPage />\n    </Suspense>\n  ),\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/settings/roles.tsx","messages":[{"ruleId":"only-throw-error","message":"Definition for rule 'only-throw-error' was not found.","line":17,"column":7,"endLine":17,"endColumn":51,"severity":2,"nodeType":null},{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":18,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":18,"endColumn":43}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst RolesSettingsPage = lazy(() => import(\"@/pages/settings/RolesSettingsPage\"));\n\nexport const Route = createFileRoute(\"/_authed/settings/roles\")({\n  staticData: {\n    nav: { iconKey: \"UserCog\", label: \"Roles\", order: 2, section: \"Sistema\" },\n    permission: { action: \"read\", subject: \"Role\" },\n    title: \"Roles y permisos\",\n  },\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"Role\")) {\n      const routeApi = getRouteApi(\"/_authed/settings/roles\");\n      // eslint-disable-next-line only-throw-error\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <RolesSettingsPage />\n    </Suspense>\n  ),\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/settings/users.add.tsx","messages":[{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":12,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":12,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst AddUserPage = lazy(() => import(\"@/pages/admin/AddUserPage\"));\n\nexport const Route = createFileRoute(\"/_authed/settings/users/add\")({\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"create\", \"User\")) {\n      const routeApi = getRouteApi(\"/_authed/settings/users/add\");\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <AddUserPage />\n    </Suspense>\n  ),\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/_authed/settings/users.tsx","messages":[{"ruleId":"only-throw-error","message":"Definition for rule 'only-throw-error' was not found.","line":17,"column":7,"endLine":17,"endColumn":51,"severity":2,"nodeType":null},{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":18,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":18,"endColumn":43}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { lazy, Suspense } from \"react\";\n\nimport PageLoader from \"@/components/ui/PageLoader\";\n\nconst UserManagementPage = lazy(() => import(\"@/features/users/pages/UserManagementPage\"));\n\nexport const Route = createFileRoute(\"/_authed/settings/users\")({\n  staticData: {\n    nav: { iconKey: \"Users\", label: \"Usuarios\", order: 1, section: \"Sistema\" },\n    permission: { action: \"read\", subject: \"User\" },\n    title: \"Gestión de usuarios\",\n  },\n  beforeLoad: ({ context }) => {\n    if (!context.auth.can(\"read\", \"User\")) {\n      const routeApi = getRouteApi(\"/_authed/settings/users\");\n      // eslint-disable-next-line only-throw-error\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n  component: () => (\n    <Suspense fallback={<PageLoader />}>\n      <UserManagementPage />\n    </Suspense>\n  ),\n});\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/routes/login.tsx","messages":[{"ruleId":"@typescript-eslint/require-await","severity":2,"message":"Async method 'beforeLoad' has no 'await' expression.","line":18,"column":3,"nodeType":"ArrowFunctionExpression","messageId":"missingAwait","endLine":18,"endColumn":21,"suggestions":[{"messageId":"removeAsync","fix":{"range":[517,523],"text":""},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/only-throw-error","severity":2,"message":"Expected an error object to be thrown.","line":21,"column":13,"nodeType":"CallExpression","messageId":"object","endLine":21,"endColumn":43}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createFileRoute, getRouteApi } from \"@tanstack/react-router\";\nimport { z } from \"zod\";\n\nimport LoginPage from \"@/features/auth/pages/LoginPage\";\n\n// Search params schema for redirect handling\nconst loginSearchSchema = z.object({\n  redirect: z.string().optional(),\n});\n\n// Login route - public only (redirects authenticated users away)\n\nconst routeApi = getRouteApi(\"/login\");\n\nexport const Route = createFileRoute(\"/login\")({\n  validateSearch: loginSearchSchema,\n  component: LoginPageWrapper,\n  beforeLoad: async ({ context }) => {\n    // If already authenticated, redirect to home or intended destination\n    if (context.auth.user) {\n      throw routeApi.redirect({ to: \"/\" });\n    }\n  },\n});\n\n// Wrapper to connect TanStack Router with the existing LoginPage\nfunction LoginPageWrapper() {\n  // The existing LoginPage uses React Router hooks internally.\n  // During coexistence phase, we just render it as-is.\n  // Later, we'll refactor LoginPage to use TanStack Router hooks.\n  return <LoginPage />;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/services/mercadopago.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/store/calendarFilters.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/types/fullcalendar.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/types/navigation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/types/navigator.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/types/roles.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/types/schema.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/version.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/src/vite-env.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/notluquis/finanzas-app/apps/web/tailwind.config.cjs","messages":[{"ruleId":"@typescript-eslint/no-unsafe-call","severity":2,"message":"Unsafe call of an `any` typed value.","line":91,"column":5,"nodeType":"Identifier","messageId":"unsafeCall","endLine":91,"endColumn":12},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":2,"message":"Unsafe call of an `any` typed value.","line":92,"column":5,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":92,"endColumn":57},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":2,"message":"Unsafe call of an `any` typed value.","line":92,"column":5,"nodeType":"Identifier","messageId":"unsafeCall","endLine":92,"endColumn":12},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":2,"message":"Unsafe member access .addDynamicIconSelectors on an `any` value.","line":92,"column":34,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":92,"endColumn":57}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":91,"column":5,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":91,"endColumn":23,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":92,"column":5,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":92,"endColumn":33,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"module.exports = {\n  content: [\"./index.html\", \"./src/**/*.{js,ts,jsx,tsx}\"],\n  daisyui: {\n    base: true,\n    /* Include only the daisyUI components we use to keep CSS size small and avoid style clashes. */\n    include:\n      \"button, input, select, modal, card, collapse, dropdown, badge, alert, file-input, table, navbar, drawer, menu, tooltip\",\n    logs: false,\n    styled: true,\n    /* Apple-like Design System:\n       - Neutral backgrounds: pure white (#ffffff) light mode, pure black (#000000) dark mode\n       - Semantic color tokens from DaisyUI (primary, secondary, success, error, warning, info)\n       - Generous spacing and typography for premium feel\n       - Soft, subtle shadows using oklch() for theme-aware rendering\n       - Custom easing curves for smooth animations\n       - NO hard-coded colors or RGBA values (all use CSS variables or oklch())\n       \n       To add new colors: extend the theme object below with semantic tokens only.\n       To add custom shadows: use oklch(var(--bc) / opacity) for theme awareness.\n    */\n    themes: [\n      {\n        /* Branded light theme: bioalergia — with Apple-like neutral aesthetics */\n        bioalergia: {\n          /* brand tokens (available as CSS variables via data-theme) */\n          \"--brand-primary\": \"#0e64b7\",\n          \"--brand-primary-rgb\": \"14 100 183\",\n          \"--brand-secondary\": \"#f1a722\",\n          \"--brand-secondary-rgb\": \"241 167 34\",\n          /* Animation easing curves */\n          \"--ease-apple\": \"cubic-bezier(0.4, 0, 0.2, 1)\",\n          \"--ease-spring\": \"cubic-bezier(0.175, 0.885, 0.32, 1.275)\",\n          \"--shadow-lg\": \"0 10px 24px rgba(0, 0, 0, 0.1)\",\n          \"--shadow-md\": \"0 4px 6px rgba(0, 0, 0, 0.07)\",\n          /* Apple-like shadows: soft and subtle */\n          \"--shadow-sm\": \"0 1px 2px rgba(0, 0, 0, 0.05)\",\n          accent: \"oklch(70% 0.15 180)\" /* Teal */,\n          \"base-100\": \"oklch(100% 0 0)\" /* White */,\n          \"base-200\": \"oklch(97% 0 0)\",\n          \"base-300\": \"oklch(92% 0 0)\",\n          \"base-content\": \"oklch(20% 0.04 260)\",\n          error: \"oklch(60% 0.18 25)\",\n          info: \"oklch(70% 0.14 240)\",\n          neutral: \"oklch(96% 0.01 0)\" /* Neutral Gray */,\n          /* P3 Gamut (OKLCH) - 2026 Standard */\n          primary: \"oklch(52% 0.16 257)\" /* Deep Brand Blue */,\n          \"primary-content\": \"oklch(100% 0 0)\",\n          secondary: \"oklch(78% 0.16 70)\" /* Vibrant Gold */,\n          \"secondary-content\": \"oklch(20% 0.05 260)\",\n          success: \"oklch(65% 0.18 145)\",\n          warning: \"oklch(75% 0.16 55)\",\n        },\n      },\n      {\n        /* Branded dark theme: bioalergia-dark — with Apple-like neutral aesthetics */\n        \"bioalergia-dark\": {\n          /* brand tokens */\n          \"--brand-primary\": \"#7fb6ff\",\n          \"--brand-primary-rgb\": \"127 182 255\",\n          \"--brand-secondary\": \"#ffc782\",\n          \"--brand-secondary-rgb\": \"255 199 130\",\n          /* Animation easing curves */\n          \"--ease-apple\": \"cubic-bezier(0.4, 0, 0.2, 1)\",\n          \"--ease-spring\": \"cubic-bezier(0.175, 0.885, 0.32, 1.275)\",\n          \"--shadow-lg\": \"0 10px 24px rgba(255, 255, 255, 0.08)\",\n          \"--shadow-md\": \"0 4px 6px rgba(255, 255, 255, 0.05)\",\n          /* Apple-like shadows: soft and subtle for dark mode */\n          \"--shadow-sm\": \"0 1px 2px rgba(255, 255, 255, 0.03)\",\n          accent: \"oklch(70% 0.15 180)\",\n          \"base-100\": \"oklch(0% 0 0)\" /* Pure Black */,\n          \"base-200\": \"oklch(12% 0 0)\" /* Deep Gray */,\n          \"base-300\": \"oklch(18% 0 0)\",\n          error: \"oklch(70% 0.18 20)\",\n          info: \"oklch(70% 0.14 240)\",\n          neutral: \"oklch(26% 0 0)\" /* Dark Gray */,\n          /* P3 Gamut (OKLCH) - Dark Mode */\n          primary: \"oklch(70% 0.14 255)\" /* Lighter Blue */,\n          \"primary-content\": \"oklch(100% 0 0)\",\n          secondary: \"oklch(82% 0.14 75)\" /* Lighter Gold */,\n          \"secondary-content\": \"oklch(100% 0 0)\",\n          success: \"oklch(75% 0.16 150)\",\n          warning: \"oklch(80% 0.16 85)\",\n        },\n      },\n    ],\n  },\n  darkMode: \"class\",\n  plugins: [\n    // daisyUI plugin (provides UI components via Tailwind utility classes)\n    /* eslint-disable @typescript-eslint/no-require-imports */\n    require(\"daisyui\"),\n    require(\"@iconify/tailwind\").addDynamicIconSelectors(),\n  ],\n  theme: {\n    extend: {},\n  },\n};\n","usedDeprecatedRules":[]}]
