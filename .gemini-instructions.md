# Gemini Code Assist ‚Äî finanzas-app Development Guide

> **Optimized for Google Gemini Code Assist / Gemini 1.5 Pro+**
> This guide provides structured context for intelligent code completion, generation, and refactoring.

## üéØ Quick Start

```bash
Stack:       React + Vite + TypeScript | Node + Express + Prisma + PostgreSQL
Development: npm run dev:full (full stack)
Build:       npm run build && npm run build:server
Verify:      npm run type-check && npm run lint
Deploy:      git push ‚Üí Railway auto-deploys
```

**Critical Rules:**

1. **NEVER use `bg-white`** ‚Üí use `bg-base-100` (DaisyUI semantic token)
2. **NEVER create mock data** ‚Üí use existing real API endpoints
3. **ALWAYS verify** with `npm run type-check` before committing

---

## üìä Architecture Overview

### Frontend (src/)

- **Framework**: React 18 + TypeScript + Vite
- **Styling**: Tailwind CSS + DaisyUI (theme-aware)
- **State Management**: TanStack Query (server state) + Zustand (client state)
- **Entry Point**: `src/main.tsx`
- **Feature-Based Structure**: `src/features/{domain}/` (api.ts, hooks/, types.ts)

### Backend (server/)

- **Framework**: Node + Express + TypeScript
- **Database**: PostgreSQL via Prisma ORM (**NOT MySQL**)
- **Authentication**: Passkey (WebAuthn) + email/password + MFA (24h sessions)
- **Entry Point**: `server/index.ts`
- **API Routes**: `server/routes/*.ts`

### Database (PostgreSQL)

- **ORM**: Prisma (schema: `prisma/schema.prisma`)
- **Generated Client**: `generated/` (DO NOT EDIT)
- **Critical**: All raw SQL MUST use PostgreSQL syntax (`TO_CHAR`, `EXTRACT`, not `DATE_FORMAT`)
- **Table Names**: Use `@@map` directives (`events` not `google_calendar_events`, `people` not `person`)

### Deployment

- **Platform**: Railway (auto-deploy on git push)
- **Container**: Docker with `node:current-slim` + OpenSSL
- **Binary Target**: `debian-openssl-3.0.x` for Prisma

---

## üöÄ Development Commands

```bash
# Development Mode
npm run dev          # Frontend only (Vite dev server)
npm run server       # Backend only (Express server)
npm run dev:full     # Frontend + Backend concurrently ‚≠ê

# Build
npm run build        # Production frontend build
npm run build:server # Production backend build

# Quality Checks
npm run type-check   # TypeScript validation (REQUIRED before commit)
npm run lint         # ESLint (auto-fixable with --fix)

# Testing
npm run test:withdrawals  # Integration tests (requires RUN_WITHDRAWALS_IT=1)

# Database
npx prisma generate       # Regenerate client after schema changes
npx prisma migrate dev    # Create new migration
npx prisma migrate status # Check migration state
```

---

## üìÅ Directory Structure

```
finanzas-app/
‚îú‚îÄ‚îÄ src/                          # Frontend source
‚îÇ   ‚îú‚îÄ‚îÄ main.tsx                  # App entry + routing
‚îÇ   ‚îú‚îÄ‚îÄ features/                 # Feature modules (domain-driven)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/                 # Authentication
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ calendar/             # Calendar sync + events
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api.ts            # Centralized API calls
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/            # React hooks (useCalendarEvents, etc.)
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ types.ts          # TypeScript types
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ transactions/         # Financial transactions
‚îÇ   ‚îú‚îÄ‚îÄ components/               # Shared components
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ui/                   # UI primitives (Button, Input, etc.)
‚îÇ   ‚îî‚îÄ‚îÄ pages/                    # Route pages
‚îÇ
‚îú‚îÄ‚îÄ server/                       # Backend source
‚îÇ   ‚îú‚îÄ‚îÄ index.ts                  # Express app entry
‚îÇ   ‚îú‚îÄ‚îÄ routes/                   # API endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.ts               # Auth endpoints (login, passkey, MFA)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ calendar-events.ts   # Calendar CRUD + sync
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ transactions.ts      # Transaction preview/import
‚îÇ   ‚îú‚îÄ‚îÄ services/                 # Business logic
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ calendar.ts           # Sync lock (15min timeout)
‚îÇ   ‚îú‚îÄ‚îÄ lib/                      # Utilities + helpers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ google-calendar.ts   # Google Calendar API integration
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ google-calendar-store.ts  # DB upsert logic
‚îÇ   ‚îú‚îÄ‚îÄ modules/                  # Domain modules
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ calendar/parsers.ts  # Event parsing + validation
‚îÇ   ‚îî‚îÄ‚îÄ config.ts                 # App configuration (sessions, JWT, etc.)
‚îÇ
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma             # Database schema (PostgreSQL)
‚îÇ   ‚îî‚îÄ‚îÄ migrations/               # Migration history
‚îÇ
‚îî‚îÄ‚îÄ generated/                    # Prisma client (auto-generated)
```

---

## üî¥ Recent Critical Changes (December 2024)

### 1. Database: PostgreSQL (NOT MySQL)

**Impact**: All raw SQL queries must use PostgreSQL syntax.

```typescript
// ‚úÖ CORRECT
await prisma.$queryRaw`
  SELECT TO_CHAR(created_at, 'YYYY-MM-DD') as date
  FROM events
  WHERE EXTRACT(YEAR FROM created_at) = 2025
`;

// ‚ùå INCORRECT (MySQL syntax)
await prisma.$queryRaw`
  SELECT DATE_FORMAT(created_at, '%Y-%m-%d') as date
  FROM google_calendar_events  -- Wrong table name
`;
```

**Table Mappings** (check `@@map` in schema):

- `events` (not `google_calendar_events` or `calendar_events`)
- `people` (not `person`)
- `external_event_id` (not `event_id`)

### 2. Calendar Sync: 15-Minute Timeout

**Location**: `server/services/calendar.ts`

**Reason**: Large calendar syncs (>20K events) were being marked as ERROR after 5min.

```typescript
const STALE_TIMEOUT_MS = 15 * 60 * 1000; // 15 minutes
```

### 3. Calendar: Exclusion Patterns

**Location**: `server/config.ts` ‚Üí `parseExcludePatterns()`

**Auto-excludes**:

- Events with "cumplea√±os" (birthdays)
- Empty events (`^\s*$`)
- Date-only events (no time information)

**Extensible via**: `GOOGLE_CALENDAR_EXCLUDE_SUMMARIES` environment variable.

### 4. Amount Validation: Int32 Limits (NEW)

**Location**: `server/modules/calendar/parsers.ts`

**Problem**: Calendar events with extremely large numbers in summary/description caused overflow errors.

```typescript
// PostgreSQL INTEGER max: 2,147,483,647 (~2.1 billion)
const MAX_INT32 = 2147483647;
const MAX_REASONABLE_AMOUNT = 100_000_000; // 100M CLP

function normalizeAmountRaw(raw: string) {
  const digits = raw.replace(/[^0-9]/g, "");
  if (!digits) return null;
  const value = Number.parseInt(digits, 10);
  if (Number.isNaN(value) || value <= 0) return null;

  const normalized = value >= 1000 ? value : value * 1000;

  // Validate Int32 range
  if (normalized > MAX_INT32) {
    console.warn(`Amount ${normalized} exceeds Int32 max, skipping`);
    return null;
  }
  if (normalized > MAX_REASONABLE_AMOUNT) {
    console.warn(`Amount ${normalized} exceeds reasonable max, skipping`);
    return null;
  }

  return normalized;
}
```

### 5. Auth: passwordHash Nullable

**Schema**: `prisma/schema.prisma`

```prisma
model User {
  passwordHash String? @map("password_hash")  // Nullable for passkey-only users
}
```

**Impacts**:

- Passkey-only users: `passwordHash = null`
- PENDING_SETUP users: can login with or without password
- ACTIVE users with null passwordHash: MUST use passkey

### 6. Navigation: Tab Highlighting

**All layouts** must have `end: true` for exact route matching:

```typescript
// ‚úÖ CORRECT
const tabs: TabItem[] = [
  { label: "Resumen", path: "/calendar", end: true },
  { label: "Historial", path: "/calendar/history", end: true },
];
```

**Affected files**: `CalendarLayout.tsx`, `HRLayout.tsx`, `ServicesLayout.tsx`, `OperationsLayout.tsx`

---

## üí° Coding Standards

### Frontend Patterns

#### Use DaisyUI Semantic Tokens

```tsx
// ‚úÖ CORRECT - semantic tokens
<div className="bg-base-100 text-base-content card shadow">
  <h2 className="card-title">T√≠tulo</h2>
  <input className="input input-bordered" />
</div>

// ‚ùå INCORRECT - hardcoded colors
<div className="bg-white text-gray-900 rounded-lg shadow">
  <h2 className="text-xl font-bold">T√≠tulo</h2>
  <input className="border rounded px-2 py-1" />
</div>
```

#### Use Shared Button Component

```tsx
// ‚úÖ CORRECT
import Button from "@/components/ui/Button";
<Button variant="primary" size="md" onClick={handleClick}>
  Guardar
</Button>

// ‚ùå INCORRECT
<button className="btn btn-primary" onClick={handleClick}>
  Guardar
</button>
```

#### Feature-Based API Organization

```typescript
// ‚úÖ CORRECT - centralized in src/features/calendar/api.ts
export async function fetchCalendarSummary(params: SummaryParams) {
  const response = await fetch(`/api/calendar/events/summary?${new URLSearchParams(params)}`);
  return response.json();
}

// In component:
import { fetchCalendarSummary } from "@/features/calendar/api";
const data = await fetchCalendarSummary({ from: "2025-01-01", to: "2025-12-31" });

// ‚ùå INCORRECT - inline API calls in component
const response = await fetch("/api/calendar/events/summary?from=2025-01-01&to=2025-12-31");
```

### Backend Patterns

#### PostgreSQL Raw Queries

```typescript
// ‚úÖ CORRECT
const events = await prisma.$queryRaw`
  SELECT 
    TO_CHAR(start_date_time, 'YYYY-MM-DD') as date,
    COUNT(*) as count
  FROM events
  WHERE EXTRACT(MONTH FROM start_date_time) = 12
  GROUP BY date
  ORDER BY date
`;

// ‚ùå INCORRECT
const events = await prisma.$queryRaw`
  SELECT 
    DATE_FORMAT(start_date_time, '%Y-%m-%d') as date,
    COUNT(*) as count
  FROM google_calendar_events  -- Wrong table name
  GROUP BY date
`;
```

#### Error Handling with Context

```typescript
// ‚úÖ CORRECT - detailed error logging
try {
  await syncGoogleCalendar(calendarId);
} catch (error) {
  console.error("[calendar:sync] Sync failed:", {
    calendarId,
    error: error instanceof Error ? error.message : String(error),
    stack: error instanceof Error ? error.stack : undefined,
  });
  throw error;
}

// ‚ùå INCORRECT - generic error logging
try {
  await syncGoogleCalendar(calendarId);
} catch (error) {
  console.error("Error:", error);
  throw error;
}
```

#### Amount Validation

```typescript
// ‚úÖ CORRECT - validate before DB insert
const MAX_INT32 = 2147483647;
const amountExpected = parseAmountFromSummary(event.summary);

if (amountExpected && amountExpected > MAX_INT32) {
  console.warn(`[event:${event.id}] Amount ${amountExpected} exceeds Int32 max, setting to null`);
  amountExpected = null;
}

await prisma.event.create({
  data: { ...eventData, amountExpected },
});
```

---

## ‚ùå Common Errors & Solutions

| Error Message                                                                 | Root Cause                                      | Solution                                          |
| ----------------------------------------------------------------------------- | ----------------------------------------------- | ------------------------------------------------- |
| `function date_format does not exist`                                         | Using MySQL syntax in PostgreSQL                | Replace `DATE_FORMAT()` with `TO_CHAR()`          |
| `Unable to fit value X into a 64-bit signed integer`                          | Amount exceeds Int32 max                        | Validate amounts ‚â§ 2,147,483,647 before DB insert |
| `Value out of range for the type: value "X" is out of range for type integer` | Same as above                                   | Add `normalizeAmountRaw()` validation             |
| Tab not showing as active                                                     | Missing `end: true` on NavLink/TabItem          | Add `end: true` to tab definition                 |
| Sync marked as ERROR after 5min                                               | Timeout too short for large syncs               | Timeout is now 15min (`STALE_TIMEOUT_MS`)         |
| `bg-white` not working in dark mode                                           | Using hardcoded color                           | Replace with `bg-base-100` (DaisyUI token)        |
| Commit rejected by pre-commit hook                                            | Lint/type errors                                | Run `npm run lint --fix` and `npm run type-check` |
| `Cannot find module` after editing server                                     | Build out of sync                               | Run `npm run build:server`                        |
| Table/column not found in SQL query                                           | Using TypeScript name instead of `@@map`/`@map` | Check `schema.prisma` for mapped names            |

---

## üîß MCP Tools Integration

### Available Tools

1. **Sequential Thinking** - Multi-step reasoning for complex problems
2. **Context7** - Up-to-date library documentation
3. **GitHub MCP** - Repository operations (PRs, issues, branches)

### When to Use

```
Sequential Thinking:
  - Complex debugging (multiple interacting systems)
  - Architecture design decisions
  - Multi-step refactoring plans

Context7:
  - Verify latest API changes (Prisma, React Query, Vite, etc.)
  - Check deprecated patterns
  - Library IDs: /prisma/prisma, /tanstack/query, /saadeghi/daisyui

GitHub MCP:
  - Create PRs with detailed context
  - Search existing issues
  - Review branch status
```

---

## üõ°Ô∏è Safety Rules (DO NOT VIOLATE)

### 1. API Compatibility

**DO NOT** remove `/api/transactions/withdrawals/upload` without confirming no external callers.

### 2. Data Integrity

**PRESERVE** upsert response shape: `{ inserted, updated, skipped, total }`.

### 3. Migrations

**NEVER** modify deployed migrations. Create new migrations with:

```bash
npx prisma migrate dev --name descriptive_name
```

### 4. Session Duration

**DO NOT** change `server/config.ts` ‚Üí `sessionCookieOptions.maxAge` (24h) without approval.

### 5. PWA Manifest

**NEVER** create `public/manifest.json` manually (VitePWA auto-generates from `vite.config.ts`).

### 6. Error Boundaries

**DO NOT** remove `ChunkErrorBoundary` wrapper in `src/main.tsx` (handles production chunk 404s).

### 7. Login Aesthetics

**DO NOT** alter minimalist passkey-first login design without explicit request.

### 8. Pre-commit Hooks

**NEVER** use `--no-verify` on production commits. Fix lint/type errors first.

### 9. Amount Validation (NEW)

**ALWAYS** validate amounts ‚â§ Int32 max (2,147,483,647) before database inserts.

---

## ‚úÖ Pre-Commit Checklist

```bash
# 1. Type check
npm run type-check
# ‚úì No TypeScript errors

# 2. Lint
npm run lint
# ‚úì No ESLint errors (use --fix if needed)

# 3. Build
npm run build
npm run build:server
# ‚úì Production build succeeds

# 4. Commit
git add -A
git commit -m "feat(scope): clear description"
# ‚úì Pre-commit hooks pass
```

---

## üìñ Related Documentation

- **Universal**: `AGENTS.md` - Base documentation for all AI agents
- **GitHub Copilot**: `.github/copilot-instructions.md`
- **Claude**: `CLAUDE.md`
- **Cursor**: `.cursorrules`
- **Codex**: `.codex-instructions.md`

---

## üéì Learning Resources

### Key Files by Feature

**Calendar System**:

- `src/features/calendar/api.ts` - Client API
- `src/features/calendar/hooks/useCalendarEvents.ts` - State management
- `server/routes/calendar-events.ts` - Endpoints
- `server/lib/google-calendar.ts` - Google API integration
- `server/modules/calendar/parsers.ts` - Event parsing + **amount validation**

**Authentication**:

- `server/routes/auth.ts` - Login, passkey, MFA
- `server/routes/user-management.ts` - User CRUD
- `src/features/auth/pages/LoginPage.tsx` - Login UI

**Transactions**:

- `server/routes/transactions.ts` - Preview/import
- `server/db.ts` - upsertWithdrawals
- `src/features/transactions/` - Frontend UI

**Configuration**:

- `server/config.ts` - Sessions, JWT, calendar settings
- `tailwind.config.cjs` - Themes
- `vite.config.ts` - PWA + build config

---

_This guide is optimized for Google Gemini Code Assist. For other AI assistants, see respective instruction files in the repository._
