import { describe, it, expect, vi, beforeEach } from "vitest";
import request from "supertest";
import express from "express";
import { PrismaClient } from "@prisma/client";
import userManagementRoutes from "../server/routes/user-management.js";
import { authenticate } from "../server/lib/http.js";

// Mock Prisma
const prisma = {
  user: {
    findUnique: vi.fn(),
    create: vi.fn(),
    update: vi.fn(),
  },
  person: {
    update: vi.fn(),
  },
  employee: {
    upsert: vi.fn(),
  },
  auditLog: {
    create: vi.fn(),
  },
  $transaction: vi.fn((callback) => callback(prisma)),
} as unknown as PrismaClient;

// Mock Auth Middleware
vi.mock("../server/lib/http", async () => {
  const actual = await vi.importActual("../server/lib/http.js");
  return {
    ...actual,
    authenticate: vi.fn((req, res, next) => {
      req.auth = { userId: 1, email: "admin@example.com", role: "ADMIN" };
      next();
    }),
    requireRole: () => (req, res, next) => next(),
  };
});

const app = express();
app.use(express.json());
app.use("/api/users", userManagementRoutes);

describe("User Management Integration", () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it("should invite a user and log audit", async () => {
    vi.mocked(prisma.user.findUnique).mockResolvedValue(null);
    vi.mocked(prisma.user.create).mockResolvedValue({ id: 2 } as any);

    const res = await request(app).post("/api/users/invite").send({
      personId: 10,
      email: "newuser@example.com",
      role: "VIEWER",
    });

    expect(res.status).toBe(200);
    expect(prisma.user.create).toHaveBeenCalled();
    expect(prisma.auditLog.create).toHaveBeenCalledWith(
      expect.objectContaining({
        data: expect.objectContaining({
          action: "USER_INVITE",
          entity: "User",
          entityId: "2",
        }),
      })
    );
  });

  it("should setup user and log audit", async () => {
    vi.mocked(prisma.user.findUnique).mockResolvedValue({ id: 1, personId: 10 } as any);
    vi.mocked(prisma.person.update).mockResolvedValue({} as any);
    vi.mocked(prisma.employee.upsert).mockResolvedValue({} as any);
    vi.mocked(prisma.user.update).mockResolvedValue({} as any);

    const consoleSpy = vi.spyOn(console, "error").mockImplementation(() => {});

    const res = await request(app).post("/api/users/setup").send({
      names: "John",
      rut: "12345678-9",
      password: "password123",
    });

    if (res.status !== 200) {
      console.log("Setup failed with:", res.body);
    }

    expect(res.status).toBe(200);
    expect(prisma.user.update).toHaveBeenCalledWith(
      expect.objectContaining({ where: { id: 1 }, data: expect.objectContaining({ status: "ACTIVE" }) })
    );
    expect(prisma.auditLog.create).toHaveBeenCalledWith(
      expect.objectContaining({
        data: expect.objectContaining({
          action: "USER_SETUP",
          entity: "User",
          entityId: "1",
        }),
      })
    );

    consoleSpy.mockRestore();
  });
});
